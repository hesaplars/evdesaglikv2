<!DOCTYPE html>
<html lang="tr">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Evde SaÄŸlÄ±k">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#4f46e5">
<meta name="format-detection" content="telephone=no">

<!-- Preconnect -->
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<link rel="dns-prefetch" href="https://firebaseio.com">

<title>Evde SaÄŸlÄ±k YÃ¶netimi</title>

<link rel="icon" type="image/svg+xml"
href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%234f46e5'/%3E%3Cpath d='M50 20 L50 80 M20 50 L80 50' stroke='white' stroke-width='12' stroke-linecap='round'/%3E%3C/svg%3E">
<link rel="apple-touch-icon"
href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%234f46e5'/%3E%3Cpath d='M50 20 L50 80 M20 50 L80 50' stroke='white' stroke-width='12' stroke-linecap='round'/%3E%3C/svg%3E">

<link rel="stylesheet" href="css/styles.css">

<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
darkMode: 'class',
}
</script>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script src="https://unpkg.com/lucide@0.469.0" defer></script>

<!--
LAZY LOADING: AÅŸaÄŸÄ±daki aÄŸÄ±r kÃ¼tÃ¼phaneler artÄ±k sayfa yÃ¼klenirken deÄŸil,
ihtiyaÃ§ duyulduÄŸunda (kullanÄ±cÄ± ilgili Ã¶zelliÄŸi kullandÄ±ÄŸÄ±nda) yÃ¼klenecek.
Bu sayede sayfa aÃ§Ä±lÄ±ÅŸ hÄ±zÄ± Ã¶nemli Ã¶lÃ§Ã¼de artar.

- XLSX.js (~350KB) â†’ Excel import/export kullanÄ±ldÄ±ÄŸÄ±nda
- PDFMake (~600KB) â†’ PDF export kullanÄ±ldÄ±ÄŸÄ±nda
- Chart.js (~200KB) â†’ Ä°statistik sekmesi aÃ§Ä±ldÄ±ÄŸÄ±nda
- Marked.js (~30KB) â†’ AI Rapor kullanÄ±ldÄ±ÄŸÄ±nda
-->
<script>
// ============================================
// LAZY LOADING SÄ°STEMÄ° - AÄŸÄ±r kÃ¼tÃ¼phaneler iÃ§in
// ============================================
const LazyLoader = {
loaded: {},
loading: {},

// Script yÃ¼kleme promise'i
loadScript: function (url, globalName) {
// Zaten yÃ¼klÃ¼yse
if (this.loaded[globalName]) {
return Promise.resolve(window[globalName]);
}

// YÃ¼klenme sÃ¼recindeyse bekle
if (this.loading[globalName]) {
return this.loading[globalName];
}

// Yeni yÃ¼kleme baÅŸlat
this.loading[globalName] = new Promise((resolve, reject) => {
const script = document.createElement('script');
script.src = url;
script.onload = () => {
this.loaded[globalName] = true;
delete this.loading[globalName];
resolve(window[globalName]);
};
script.onerror = () => {
delete this.loading[globalName];
reject(new Error('Failed to load ' + globalName));
};
document.head.appendChild(script);
});

return this.loading[globalName];
},

// XLSX KÃ¼tÃ¼phanesi
loadXLSX: async function () {
if (window.XLSX) return window.XLSX;
await this.loadScript('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js', 'XLSX');
return window.XLSX;
},

// PDFMake KÃ¼tÃ¼phanesi (2 dosya)
loadPDFMake: async function () {
if (window.pdfMake) return window.pdfMake;
await this.loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.9/pdfmake.min.js', 'pdfMake');
await this.loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.9/vfs_fonts.js', 'pdfMakeVFS');
return window.pdfMake;
},

// Chart.js KÃ¼tÃ¼phanesi
loadChartJS: async function () {
if (window.Chart) return window.Chart;
await this.loadScript('https://cdn.jsdelivr.net/npm/chart.js@4.4.1', 'Chart');
return window.Chart;
},

// Marked.js KÃ¼tÃ¼phanesi
loadMarked: async function () {
if (window.marked) return window.marked;
await this.loadScript('https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js', 'marked');
return window.marked;
}
};

</script>

<style>
@keyframes searchHighlight {

0%,
100% {
box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.8);
}

50% {
box-shadow: 0 0 0 6px rgba(249, 115, 22, 0.4);
}
}

.search-highlight {
animation: searchHighlight 0.5s ease-in-out 3;
outline: 3px solid #f97316 !important;
outline-offset: 2px;
border-radius: 8px;
position: relative;
z-index: 10;
}

#global-search-results-fixed,
#global-search-results-mobile-fixed {
position: fixed !important;
z-index: 50 !important;
}

/* TABLO STANDARDÄ°ZASYONU - Mobil Uyumlu */
table {
font-size: 0.75rem; /* 12px */
}
@media (min-width: 768px) {
table {
font-size: 0.8125rem; /* 13px */
}
}
table th {
font-size: 0.625rem; /* 10px */
font-weight: 600;
text-transform: uppercase;
letter-spacing: 0.025em;
padding: 0.5rem 0.75rem;
}
@media (min-width: 768px) {
table th {
font-size: 0.6875rem; /* 11px */
padding: 0.75rem 1rem;
}
}
table td {
padding: 0.5rem 0.75rem;
}
@media (min-width: 768px) {
table td {
padding: 0.625rem 1rem;
}
}

/* Tablolar iÃ§in yatay kaydÄ±rma wrapper */
.table-scroll-wrapper {
overflow-x: auto;
-webkit-overflow-scrolling: touch;
scrollbar-width: thin;
}
.table-scroll-wrapper::-webkit-scrollbar {
height: 6px;
}
.table-scroll-wrapper::-webkit-scrollbar-track {
background: #f1f5f9;
border-radius: 3px;
}
.table-scroll-wrapper::-webkit-scrollbar-thumb {
background: #cbd5e1;
border-radius: 3px;
}
.table-scroll-wrapper::-webkit-scrollbar-thumb:hover {
background: #94a3b8;
}

/* Mobil menÃ¼ animasyonu */
#mobile-menu-arrow {
transition: transform 0.2s ease;
}
#mobile-tab-dropdown {
animation: slideDown 0.2s ease;
}
@keyframes slideDown {
from {
opacity: 0;
transform: translateY(-10px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

/* BoÅŸ durum stilleri */
.empty-state {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
padding: 2rem;
color: #9ca3af;
}
.empty-state svg {
width: 3rem;
height: 3rem;
margin-bottom: 0.5rem;
opacity: 0.5;
}
.empty-state p {
font-size: 0.875rem;
font-weight: 500;
}
</style>

<body class="p-4 md:p-6 lg:p-8 text-gray-800">

<div id="auth-container"
class="fixed inset-0 bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 flex items-center justify-center z-[9999] overflow-y-auto py-4">
<div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 my-auto max-h-[95vh] overflow-y-auto">
<div class="text-center mb-8">
<div
class="bg-indigo-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
class="text-white">
<path d="M22 12h-4l-3 9L9 3l-3 9H2" />
</svg>
</div>
<h1 class="text-3xl font-bold text-gray-900 mb-2">Evde SaÄŸlÄ±k YÃ¶netimi</h1>
<p class="text-gray-500 text-sm">GÃ¼venli giriÅŸ yapÄ±n veya hesap oluÅŸturun</p>
</div>

<div class="flex border-b mb-6">
<button id="tab-login-btn" onclick="switchAuthTab('login')"
class="flex-1 py-3 text-sm font-semibold border-b-2 border-indigo-600 text-indigo-600">GiriÅŸ
Yap</button>
<button id="tab-register-btn" onclick="switchAuthTab('register')"
class="flex-1 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500">Hesap
OluÅŸtur</button>
</div>

<div id="login-form" class="space-y-4">
<div>
<label class="block text-sm font-semibold text-gray-700 mb-2">E-posta</label>
<input type="email" id="login-email" placeholder="E-posta"
class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
</div>
<div>
<label class="block text-sm font-semibold text-gray-700 mb-2">Åifre</label>
<input type="password" id="login-password" placeholder="Åife"
class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
</div>
<div class="flex items-center gap-2">
<input type="checkbox" id="remember-me" checked
class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
<label for="remember-me" class="text-sm text-gray-600 cursor-pointer">Beni HatÄ±rla</label>
</div>
<button onclick="loginUser()"
class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition shadow-md">GiriÅŸ
Yap</button>
<div class="text-center pt-2">
<button onclick="showPasswordResetForm()"
class="text-sm text-indigo-600 hover:text-indigo-800 font-medium hover:underline">ğŸ” Åifremi
Unuttum</button>
</div>
</div>

<div id="register-form" class="space-y-4 hidden">
<div>
<label class="block text-sm font-semibold text-gray-700 mb-2">E-posta</label>
<input type="email" id="register-email" placeholder="E-posta"
class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
</div>
<div>
<label class="block text-sm font-semibold text-gray-700 mb-2">Åifre (en az 6 karakter)</label>
<input type="password" id="register-password" placeholder="Åifre"
class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
</div>
<div>
<label class="block text-sm font-semibold text-gray-700 mb-2">Åifre Tekrar</label>
<input type="password" id="register-password-confirm" placeholder="Åifre tekrar"
class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
</div>
<div class="border-t pt-4 mt-4">
<p class="text-xs text-gray-500 mb-3 bg-yellow-50 p-2 rounded border border-yellow-200">âš ï¸ GÃ¼venlik
sorusu, ÅŸifrenizi unuttuÄŸunuzda hesabÄ±nÄ±zÄ± kurtarmanÄ±z iÃ§in kullanÄ±lacaktÄ±r.</p>
<div class="mb-3">
<label class="block text-sm font-semibold text-gray-700 mb-2">GÃ¼venlik Sorusu</label>
<select id="register-security-question"
class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
<option value="">-- Bir soru seÃ§in --</option>
<option value="Ä°lk evcil hayvanÄ±nÄ±zÄ±n adÄ± nedir?">Ä°lk evcil hayvanÄ±nÄ±zÄ±n adÄ± nedir?</option>
<option value="Annenizin kÄ±zlÄ±k soyadÄ± nedir?">Annenizin kÄ±zlÄ±k soyadÄ± nedir?</option>
<option value="Ä°lk okulunuzun adÄ± nedir?">Ä°lk okulunuzun adÄ± nedir?</option>
<option value="DoÄŸduÄŸunuz ÅŸehir neresidir?">DoÄŸduÄŸunuz ÅŸehir neresidir?</option>
<option value="En sevdiÄŸiniz kitap nedir?">En sevdiÄŸiniz kitap nedir?</option>
</select>
</div>
<div>
<label class="block text-sm font-semibold text-gray-700 mb-2">GÃ¼venlik CevabÄ±</label>
<input type="text" id="register-security-answer" placeholder="CevabÄ±nÄ±zÄ± yazÄ±n..."
class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
</div>
</div>
<button onclick="registerUser()"
class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition shadow-md">Hesap
OluÅŸtur</button>
</div>

<div id="password-reset-form" class="space-y-4 hidden">
<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
<h3 class="text-lg font-bold text-blue-800 mb-1">ğŸ” Åifre SÄ±fÄ±rlama</h3>
<p class="text-xs text-blue-600">GÃ¼venlik sorunuzu doÄŸru cevaplayarak ÅŸifre sÄ±fÄ±rlama baÄŸlantÄ±sÄ±
alabilirsiniz.</p>
</div>
<div>
<label class="block text-sm font-semibold text-gray-700 mb-2">E-posta Adresiniz</label>
<input type="email" id="reset-email" placeholder="E-posta"
class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
</div>
<button onclick="fetchSecurityQuestion()" id="btn-fetch-question"
class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow-md">GÃ¼venlik
Sorumu Getir</button>
<div id="security-question-area" class="hidden space-y-4 border-t pt-4 mt-4">
<div class="bg-yellow-50 border border-yellow-300 rounded-lg p-4">
<p class="text-xs text-yellow-700 font-bold uppercase mb-1">GÃ¼venlik Sorunuz:</p>
<p id="display-security-question" class="text-sm font-semibold text-gray-800"></p>
</div>
<div>
<label class="block text-sm font-semibold text-gray-700 mb-2">CevabÄ±nÄ±z</label>
<input type="text" id="reset-security-answer" placeholder="CevabÄ± yazÄ±n..."
class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
</div>
<button onclick="verifyAndSendReset()"
class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition shadow-md">âœ‰ï¸
Åifre SÄ±fÄ±rlama E-postasÄ± GÃ¶nder</button>
</div>
<div class="text-center pt-2 border-t mt-4">
<button onclick="hidePasswordResetForm()"
class="text-sm text-gray-500 hover:text-gray-700 font-medium hover:underline">â† GiriÅŸ EkranÄ±na
DÃ¶n</button>
</div>
</div>

<div id="auth-message" class="mt-4 text-sm text-center hidden"></div>
<div id="auth-loading" class="mt-6 text-center hidden">
<div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
<p class="text-sm text-gray-600 mt-2">YÃ¼kleniyor...</p>
</div>
</div>
</div>
<script>
// Firebase Config
const firebaseConfig = {
apiKey: "AIzaSyDrCHrD7k1egixzle9WbIXPg2ZfSAoJXBM",
authDomain: "evdesaglikv2.firebaseapp.com",
databaseURL: "https://evdesaglikv2-default-rtdb.europe-west1.firebasedatabase.app",
projectId: "evdesaglikv2",
storageBucket: "evdesaglikv2.firebasestorage.app",
messagingSenderId: "400960066062",
appId: "1:400960066062:web:d07109838f3230e7ab625f"
};

// Firebase'i baÅŸlat
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

// Firebase baÄŸlantÄ± durumunu izle
const connectedRef = database.ref('.info/connected');
connectedRef.on('value', (snap) => {
if (snap.val() === true) {
} else {
}
});

let currentUser = null;
let userDataPath = null;
let firebaseListeners = [];
let isInitialLoad = true; // Ä°lk yÃ¼klemeyi tespit etmek iÃ§in flag
window.doctorRequestsList = []; // Doktor talepleri listesi - GLOBAL scope (canlÄ± senkronizasyon iÃ§in)

// ============================================
// HASSAS VERÄ° ÅÄ°FRELEME SÄ°STEMÄ° (AES-256-GCM)
// ============================================
const ENCRYPTION_PREFIX = 'ENC:';
const ENCRYPTION_KEY_NAME = 'evdeSaglik_EncKey_v1';
let encryptionKey = null;

// Åifreleme anahtarÄ± oluÅŸtur veya Firebase'den yÃ¼kle
// âš ï¸ ÅÄ°FRELEME DEVRE DIÅI BIRAKILDI - VERÄ° KAYBI SORUNLARI NEDENÄ°YLE
async function initEncryptionKey() {
return true;
}

// Veriyi ÅŸifrele
// âš ï¸ ÅÄ°FRELEME DEVRE DIÅI - Veriyi olduÄŸu gibi dÃ¶ndÃ¼r
async function encryptField(plainText) {
return plainText;
}

// Åifreyi Ã§Ã¶z
// âš ï¸ ÅÄ°FRELEME DEVRE DIÅI - Veriyi olduÄŸu gibi dÃ¶ndÃ¼r
async function decryptField(encryptedText) {
// ENC: ile baÅŸlayan eski ÅŸifreli veriler iÃ§in uyarÄ± ver
if (typeof encryptedText === 'string' && encryptedText.startsWith(ENCRYPTION_PREFIX)) {
return '[Åifreli Veri - OkunamÄ±yor]';
}
return encryptedText;
}

// Nesne iÃ§indeki belirli alanlarÄ± ÅŸifrele
async function encryptObject(obj, fields) {
if (!obj || typeof obj !== 'object') return obj;
const encrypted = { ...obj };
for (const field of fields) {
if (encrypted[field]) {
encrypted[field] = await encryptField(encrypted[field]);
}
}
return encrypted;
}

// Nesne iÃ§indeki belirli alanlarÄ± ÅŸifresini Ã§Ã¶z
async function decryptObject(obj, fields) {
if (!obj || typeof obj !== 'object') return obj;
const decrypted = { ...obj };
for (const field of fields) {
if (decrypted[field]) {
decrypted[field] = await decryptField(decrypted[field]);
}
}
return decrypted;
}

// Dizi iÃ§indeki tÃ¼m nesnelerin ÅŸifresini Ã§Ã¶z
async function decryptArray(arr, fields) {
if (!Array.isArray(arr)) return arr;
return Promise.all(arr.map(item => decryptObject(item, fields)));
}

// Hassas alan tanÄ±mlarÄ±
const ENCRYPTED_FIELDS = {
patientReminders: ['name', 'note', 'statusNote'],
phonebook: ['name', 'phone', 'address', 'email'],
doctorRequests: ['patient', 'request', 'statusNote']
};

function switchAuthTab(tab) {
const loginBtn = document.getElementById('tab-login-btn');
const registerBtn = document.getElementById('tab-register-btn');
const loginForm = document.getElementById('login-form');
const registerForm = document.getElementById('register-form');
const passwordResetForm = document.getElementById('password-reset-form');

// Åifre sÄ±fÄ±rlama formunu her durumda gizle
if (passwordResetForm) passwordResetForm.classList.add('hidden');

if (tab === 'login') {
loginBtn.classList.add('border-indigo-600', 'text-indigo-600');
loginBtn.classList.remove('border-transparent', 'text-gray-500');
registerBtn.classList.remove('border-indigo-600', 'text-indigo-600');
registerBtn.classList.add('border-transparent', 'text-gray-500');
loginForm.classList.remove('hidden');
registerForm.classList.add('hidden');
} else {
registerBtn.classList.add('border-indigo-600', 'text-indigo-600');
registerBtn.classList.remove('border-transparent', 'text-gray-500');
loginBtn.classList.remove('border-indigo-600', 'text-indigo-600');
loginBtn.classList.add('border-transparent', 'text-gray-500');
registerForm.classList.remove('hidden');
loginForm.classList.add('hidden');
}
document.getElementById('auth-message').classList.add('hidden');
}

function showAuthMessage(message, type = 'error') {
const msgEl = document.getElementById('auth-message');
msgEl.textContent = message;
msgEl.className = `mt-4 text-sm text-center ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
msgEl.classList.remove('hidden');
}

async function registerUser() {
if (!isRegistrationEnabled) {
showAuthMessage('Yeni Ã¼ye alÄ±mÄ± ÅŸu an kapalÄ±dÄ±r.');
return;
}
const email = document.getElementById('register-email').value.trim();
const password = document.getElementById('register-password').value;
const passwordConfirm = document.getElementById('register-password-confirm').value;
const securityQuestion = document.getElementById('register-security-question').value;
const securityAnswer = document.getElementById('register-security-answer').value.trim();

if (!email || !password) {
showAuthMessage('LÃ¼tfen e-posta ve ÅŸifre girin.');
return;
}
if (password.length < 6) {
showAuthMessage('Åifre en az 6 karakter olmalÄ±dÄ±r.');
return;
}
if (password !== passwordConfirm) {
showAuthMessage('Åifreler eÅŸleÅŸmiyor.');
return;
}
if (!securityQuestion || !securityAnswer) {
showAuthMessage('LÃ¼tfen gÃ¼venlik sorusu seÃ§in ve cevabÄ± yazÄ±n!');
return;
}

document.getElementById('auth-loading').classList.remove('hidden');

try {
// Ã–nce hesabÄ± oluÅŸtur
const userCredential = await auth.createUserWithEmailAndPassword(email, password);
const user = userCredential.user;

// GÃ¼venlik sorusunu Firebase'e kaydet
const emailKey = email.replace(/\./g, ',').replace(/@/g, '_at_');
await database.ref(`security_questions/${emailKey}`).set({
question: securityQuestion,
answer: securityAnswer.toLowerCase(),
createdAt: new Date().toISOString()
});

// KullanÄ±cÄ±yÄ± pending_users tablosuna ekle (onay bekliyor)
await database.ref(`pending_users/${emailKey}`).set({
email: email,
uid: user.uid,
registeredAt: new Date().toISOString(),
status: 'pending'
});

// Hemen Ã§Ä±kÄ±ÅŸ yap - onay olmadan giriÅŸ yapmasÄ±n
await auth.signOut();

// UI'Ä± sÄ±fÄ±rla - kayÄ±t formunu gizle, giriÅŸ formunu gÃ¶ster
document.getElementById('auth-loading').classList.add('hidden');
document.getElementById('register-form').classList.add('hidden');
document.getElementById('login-form').classList.remove('hidden');

// Tab butonlarÄ±nÄ± gÃ¼ncelle
document.querySelectorAll('.border-b.mb-6 button').forEach((btn, idx) => {
if (idx === 0) {
btn.classList.add('border-indigo-600', 'text-indigo-600');
btn.classList.remove('text-gray-400');
} else {
btn.classList.remove('border-indigo-600', 'text-indigo-600');
btn.classList.add('text-gray-400');
}
});

// KayÄ±t formundaki inputlarÄ± temizle
document.getElementById('register-email').value = '';
document.getElementById('register-password').value = '';
document.getElementById('register-password-confirm').value = '';
document.getElementById('register-security-answer').value = '';

showAuthMessage('âœ… Hesap oluÅŸturuldu! YÃ¶netici onayÄ± bekleniyor. OnaylandÄ±ÄŸÄ±nÄ±zda giriÅŸ yapabilirsiniz.', 'success');
} catch (error) {
document.getElementById('auth-loading').classList.add('hidden');
let errorMsg = 'KayÄ±t baÅŸarÄ±sÄ±z.';
if (error.code === 'auth/email-already-in-use') errorMsg = 'Bu e-posta zaten kullanÄ±mda.';
else if (error.code === 'auth/invalid-email') errorMsg = 'GeÃ§ersiz e-posta adresi.';
else if (error.code === 'auth/weak-password') errorMsg = 'Åifre Ã§ok zayÄ±f.';
showAuthMessage(errorMsg);
}
}

async function loginUser() {
const email = document.getElementById('login-email').value.trim();
const password = document.getElementById('login-password').value;
const rememberMe = document.getElementById('remember-me').checked;

if (!email || !password) {
showAuthMessage('LÃ¼tfen e-posta ve ÅŸifre girin.');
return;
}

document.getElementById('auth-loading').classList.remove('hidden');

try {
// Beni HatÄ±rla seÃ§eneÄŸine gÃ¶re persistence ayarla
const persistence = rememberMe
? firebase.auth.Auth.Persistence.LOCAL  // TarayÄ±cÄ± kapatÄ±lsa bile oturum kalÄ±r
: firebase.auth.Auth.Persistence.SESSION; // Sadece sekme aÃ§Ä±kken

await auth.setPersistence(persistence);

// Silinen kullanÄ±cÄ± kontrolÃ¼ - kara liste (hata durumunda devam et)
const emailKey = email.replace(/\./g, ',').replace(/@/g, '_at_');
try {
const deletedSnap = await database.ref(`deleted_users/${emailKey}`).once('value');
if (deletedSnap.exists()) {
document.getElementById('auth-loading').classList.add('hidden');
showAuthMessage('ğŸš« Bu hesap yÃ¶netici tarafÄ±ndan kalÄ±cÄ± olarak silinmiÅŸtir. GiriÅŸ yapmanÄ±z mÃ¼mkÃ¼n deÄŸildir.');
return;
}
} catch (checkError) {
// Kara liste kontrolÃ¼ baÅŸarÄ±sÄ±z olursa, logla ama giriÅŸ yapmayÄ± engelleme
}

await auth.signInWithEmailAndPassword(email, password);
showAuthMessage('GiriÅŸ baÅŸarÄ±lÄ±!', 'success');
} catch (error) {
document.getElementById('auth-loading').classList.add('hidden');
let errorMsg = 'GiriÅŸ baÅŸarÄ±sÄ±z.';
if (error.code === 'auth/user-not-found') errorMsg = 'KullanÄ±cÄ± bulunamadÄ±.';
else if (error.code === 'auth/wrong-password') errorMsg = 'HatalÄ± ÅŸifre.';
else if (error.code === 'auth/invalid-email') errorMsg = 'GeÃ§ersiz e-posta.';
else if (error.code === 'auth/invalid-credential') errorMsg = 'GeÃ§ersiz kimlik bilgileri.';
showAuthMessage(errorMsg);
}
}

async function logoutUser() {
if (confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinize emin misiniz?')) {
// Cihaz oturumunu sil (eÄŸer fonksiyon tanÄ±mlÄ±ysa) ve bekle
if (typeof unregisterDeviceSession === 'function') {
await unregisterDeviceSession();
}
auth.signOut();
}
}

// ÅÄ°FRE SIFIRLAMA FONKSÄ°YONLARI
function showPasswordResetForm() {
document.getElementById('login-form').classList.add('hidden');
document.getElementById('register-form').classList.add('hidden');
document.getElementById('password-reset-form').classList.remove('hidden');
document.getElementById('security-question-area').classList.add('hidden');
document.getElementById('reset-email').value = document.getElementById('login-email').value || '';
document.getElementById('auth-message').classList.add('hidden');
}

function hidePasswordResetForm() {
document.getElementById('password-reset-form').classList.add('hidden');
document.getElementById('login-form').classList.remove('hidden');
document.getElementById('btn-fetch-question').classList.remove('hidden');
document.getElementById('auth-message').classList.add('hidden');
}

async function fetchSecurityQuestion() {
const email = document.getElementById('reset-email').value.trim();
if (!email) { showAuthMessage('LÃ¼tfen e-posta adresinizi girin.'); return; }

const emailKey = email.replace(/\./g, ',').replace(/@/g, '_at_');
document.getElementById('auth-loading').classList.remove('hidden');

try {
const snapshot = await database.ref(`security_questions/${emailKey}`).once('value');
const data = snapshot.val();
document.getElementById('auth-loading').classList.add('hidden');

if (data && data.question) {
document.getElementById('display-security-question').textContent = data.question;
document.getElementById('security-question-area').classList.remove('hidden');
document.getElementById('btn-fetch-question').classList.add('hidden');
showAuthMessage('GÃ¼venlik sorunuz bulundu!', 'success');
} else {
showAuthMessage('Bu e-posta iÃ§in gÃ¼venlik sorusu bulunamadÄ±.');
}
} catch (error) {
document.getElementById('auth-loading').classList.add('hidden');
showAuthMessage('Bir hata oluÅŸtu: ' + error.message);
}
}

async function verifyAndSendReset() {
const email = document.getElementById('reset-email').value.trim();
const answer = document.getElementById('reset-security-answer').value.trim().toLowerCase();

if (!answer) { showAuthMessage('LÃ¼tfen cevabÄ± girin.'); return; }

const emailKey = email.replace(/\./g, ',').replace(/@/g, '_at_');
document.getElementById('auth-loading').classList.remove('hidden');

try {
const snapshot = await database.ref(`security_questions/${emailKey}`).once('value');
const data = snapshot.val();

if (data && data.answer && data.answer.toLowerCase() === answer) {
await auth.sendPasswordResetEmail(email);
document.getElementById('auth-loading').classList.add('hidden');
showAuthMessage('âœ… Åifre sÄ±fÄ±rlama linki e-postanÄ±za gÃ¶nderildi!', 'success');
setTimeout(() => hidePasswordResetForm(), 3000);
} else {
document.getElementById('auth-loading').classList.add('hidden');
showAuthMessage('âŒ GÃ¼venlik cevabÄ± yanlÄ±ÅŸ!');
}
} catch (error) {
document.getElementById('auth-loading').classList.add('hidden');
showAuthMessage('Hata: ' + error.message);
}
}
const FirebaseStorage = {
async set(key, value) {
if (!currentUser || !userDataPath) {
return false;
}
try {
await database.ref(`${userDataPath}/${key}`).set(value);
return true;
} catch (error) {
console.error(`âŒ Firebase set hatasÄ± (${key}):`, error);
if (error.code === 'PERMISSION_DENIED') {
alert('âš ï¸ Firebase izin hatasÄ±! VeritabanÄ± kurallarÄ±nÄ±zÄ± kontrol edin.');
}
return false;
}
},

async get(key) {
if (!currentUser || !userDataPath) return null;
try {
const snapshot = await database.ref(`${userDataPath}/${key}`).once('value');
const value = snapshot.val();
return value;
} catch (error) {
console.error(`Firebase get hatasÄ± (${key}):`, error);
return null;
}
},

// localStorage uyumluluÄŸu iÃ§in setItem() metodu
async setItem(key, value) {
// KullanÄ±cÄ± kimlik doÄŸrulamasÄ± kontrolÃ¼
if (!auth.currentUser || !currentUser || !userDataPath) {
// Yedek olarak localStorage'a kaydet
try {
originalLocalStorage.setItem(key, value);
} catch (error) {
console.error(`âŒ localStorage: Kaydetme hatasÄ±: ${error.message}`);
}
return false;
}

try {
// DeÄŸeri iÅŸle (JSON string ise parse et)
let processedValue = value;
if (typeof value === 'string') {
try {
processedValue = JSON.parse(value);
} catch {
processedValue = value; // JSON deÄŸilse string olarak sakla
}
}

// --- DÃœZELTME BURADA YAPILDI ---
// Ã–NCE Cache'i gÃ¼ncelle (BÃ¶ylece listener tetiklendiÄŸinde gÃ¼ncel veriyi okur)
if (!window._firebaseCache) window._firebaseCache = {};
window._firebaseCache[key] = processedValue;

// Sonra Firebase'e gÃ¶nder
await database.ref(`${userDataPath}/${key}`).set(processedValue);

// localStorage'a yedek olarak kaydet
try {
originalLocalStorage.setItem(key, value);
} catch (error) {
}

return true;
} catch (error) {
console.error(`âŒ Firebase: Kaydetme hatasÄ±: ${error.message}`, error);
if (error.code === 'PERMISSION_DENIED') {
alert('âš ï¸ Firebase izin hatasÄ±! VeritabanÄ± kurallarÄ±nÄ±zÄ± kontrol edin.');
}
return false;
}
},

// localStorage uyumluluÄŸu iÃ§in getItem() metodu
async getItem(key) {
// KullanÄ±cÄ± kimlik doÄŸrulamasÄ± kontrolÃ¼
if (!auth.currentUser || !currentUser || !userDataPath) {
// Yedekten oku
try {
return originalLocalStorage.getItem(key);
} catch (error) {
console.error(`âŒ localStorage: Okuma hatasÄ±: ${error.message}`);
return null;
}
}

try {
// Ã–nce cache'den kontrol et
if (window._firebaseCache && window._firebaseCache[key] !== undefined) {
const cachedValue = window._firebaseCache[key];
return typeof cachedValue === 'string' ? cachedValue : JSON.stringify(cachedValue);
}

// Firebase'den oku
const snapshot = await database.ref(`${userDataPath}/${key}`).once('value');
const value = snapshot.val();

if (value !== null && value !== undefined) {
// Cache'e ekle
if (!window._firebaseCache) window._firebaseCache = {};
window._firebaseCache[key] = value;
// localStorage string dÃ¶ndÃ¼rÃ¼r
return typeof value === 'string' ? value : JSON.stringify(value);
} else {
// Firebase'de yok, localStorage'dan dene
const localValue = originalLocalStorage.getItem(key);
if (localValue !== null) {
}
return localValue;
}
} catch (error) {
console.error(`âŒ Firebase: Okuma hatasÄ±: ${error.message}`, error);
// Hata durumunda localStorage'dan oku
try {
const localValue = originalLocalStorage.getItem(key);
if (localValue !== null) {
}
return localValue;
} catch (storageError) {
console.error(`âŒ localStorage: Okuma da baÅŸarÄ±sÄ±z: ${storageError.message}`);
return null;
}
}
},

async remove(key) {
if (!currentUser || !userDataPath) return false;
try {
await database.ref(`${userDataPath}/${key}`).remove();
return true;
} catch (error) {
console.error(`Firebase remove hatasÄ± (${key}):`, error);
return false;
}
},

addListener(key, callback) {
if (!currentUser || !userDataPath) return;
const ref = database.ref(`${userDataPath}/${key}`);
ref.on('value', (snapshot) => {
callback(snapshot.val());
});
firebaseListeners.push({ ref, key });
},

clearListeners() {
firebaseListeners.forEach(({ ref }) => ref.off());
firebaseListeners = [];
}
};

const originalLocalStorage = window.localStorage;
window.localStorage = {
getItem: function (key) {
if (!currentUser) return originalLocalStorage.getItem(key);

// Ã–nce cache'den kontrol et
const cachedValue = window._firebaseCache?.[key];

if (cachedValue !== undefined && cachedValue !== null) {
// localStorage string dÃ¶ndÃ¼rÃ¼r, cache'de obje olabilir
return typeof cachedValue === 'string' ? cachedValue : JSON.stringify(cachedValue);
}

return null;
},

setItem: function (key, value) {
if (!currentUser) {
originalLocalStorage.setItem(key, value);
return;
}

// Cache'i gÃ¼ncelle
if (!window._firebaseCache) window._firebaseCache = {};

// DeÄŸeri parse et (eÄŸer JSON string ise)
let processedValue = value;
try {
// EÄŸer value bir JSON string ise parse et
if (typeof value === 'string') {
try {
processedValue = JSON.parse(value);
} catch {
// JSON deÄŸilse string olarak sakla
processedValue = value;
}
}
} catch (e) {
processedValue = value;
}

window._firebaseCache[key] = processedValue;

// Firebase'e asenkron kaydet
FirebaseStorage.set(key, processedValue).catch(err => {
console.error(`localStorage.setItem Firebase hatasÄ± (${key}):`, err);
});
},

removeItem: function (key) {
if (!currentUser) {
originalLocalStorage.removeItem(key);
return;
}
if (window._firebaseCache) delete window._firebaseCache[key];
FirebaseStorage.remove(key);
},

clear: function () {
if (!currentUser) {
originalLocalStorage.clear();
return;
}
window._firebaseCache = {};
if (userDataPath) {
database.ref(userDataPath).remove()
.then(() => console.log('âœ… Firebase: TÃ¼m veriler temizlendi'))
.catch(err => console.error('âŒ Firebase clear hatasÄ±:', err));
}
}
};
// ================================================================
// GÃœNCELLENMÄ°Å GÄ°RÄ°Å & SENKRONÄ°ZASYON (BEKLEMELÄ° AÃ‡ILIÅ)
// ================================================================

// Kritik Veri AnahtarlarÄ± Listesi
const CRITICAL_KEYS = [
'evdeSaglikShifts_V19', 'evdeSaglikDevices_V1', 'evdeSaglikData_ULTIMATE_V18',
'evdeSaglikStaff_ULTIMATE_V18', 'evdeSaglikNotes_ULTIMATE_V18', 'evdeSaglikApiKey_V18',
'evdeSaglikDoctors_V18', 'evdeSaglikDocData_V18', 'evdeSaglikProcs_V18',
'evdeSaglikAppPW_Enc_V1', 'evdeSaglikSpecList_V18', 'evdeSaglikQuickList_V18',
'evdeSaglikLeaveRec_V18', 'evdeSaglikTeams_V19', 'evdeSaglikRoutines_V19',
'evdeSaglikBudget_V19', 'evdeSaglikEmergency_V19', 'evdeSaglikBags_V19',
'evdeSaglikGenNotesList_V1', 'evdeSaglikPhonebook_V1', 'evdeSaglikReminders_V1',
'evdeSaglikLockedTabsConfig_V1', 'evdeSaglikDoctorRequests_V1',
'evdeSaglik_TelegramToken', 'evdeSaglik_TelegramChatId'
];

auth.onAuthStateChanged(async (user) => {
const authContainer = document.getElementById('auth-container');
const appContainer = document.getElementById('app');
const loadingEl = document.getElementById('auth-loading');

// YÃ¼kleme mesajÄ±nÄ± Ã¶zelleÅŸtir
const updateLoadingMsg = (msg) => {
loadingEl.innerHTML = `
<div class="inline-block animate-spin rounded-full h-10 w-10 border-b-4 border-indigo-600 mb-2"></div>
<p class="text-sm font-bold text-gray-700 animate-pulse">${msg}</p>
`;
};

if (user) {

// ===== HIZLI GÄ°RÄ°Å OPTÄ°MÄ°ZASYONU =====
const emailKey = user.email.replace(/\./g, ',').replace(/@/g, '_at_');
const approvalCacheKey = `evdeSaglik_userApproval_${emailKey}`;
const cachedApproval = window.localStorage.getItem(approvalCacheKey);

let isApproved = false;
let isPending = false;
let isRejected = false;
let isBlocked = false;

// EÄŸer daha Ã¶nce onaylanmÄ±ÅŸ ve cache'lenmiÅŸse, hÄ±zlÄ± geÃ§
if (cachedApproval === 'approved') {
isApproved = true;

// Arka planda engel kontrolÃ¼ yap (ama bekleme)
database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}/blocked`).once('value').then(snap => {
if (snap.val() === true) {
window.localStorage.removeItem(approvalCacheKey);
auth.signOut();
showToast('ğŸš« HesabÄ±nÄ±z engellenmiÅŸtir!', 'error');
}
});
} else {
// Ä°lk giriÅŸ veya cache yok - tam kontrol yap

// approved_users, pending_users ve rejected_users'da kontrol et
const approvedSnap = await database.ref(`approved_users/${emailKey}`).once('value');
const pendingSnap = await database.ref(`pending_users/${emailKey}`).once('value');
const rejectedSnap = await database.ref(`rejected_users/${emailKey}`).once('value');

isApproved = approvedSnap.exists();
isPending = pendingSnap.exists();
isRejected = rejectedSnap.exists();

// Engelli kullanÄ±cÄ± kontrolÃ¼
const userRoleSnap = await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}/blocked`).once('value');
isBlocked = userRoleSnap.val() === true;
}

// Reddedilen kullanÄ±cÄ± giriÅŸ yapamaz
if (isRejected) {
window.localStorage.removeItem(approvalCacheKey);
await auth.signOut();
document.getElementById('auth-loading').classList.add('hidden');
showAuthMessage('âŒ HesabÄ±nÄ±z reddedilmiÅŸtir. YÃ¶netici ile iletiÅŸime geÃ§in.');
return;
}

// Engelli kullanÄ±cÄ± kontrolÃ¼
if (isBlocked) {
window.localStorage.removeItem(approvalCacheKey);
await auth.signOut();
document.getElementById('auth-loading').classList.add('hidden');
showAuthMessage('ğŸš« HesabÄ±nÄ±z engellenmiÅŸtir. YÃ¶netici ile iletiÅŸime geÃ§in.');
return;
}

// Onay bekliyor - giriÅŸ yapmasÄ±n
if (isPending && !isApproved) {
await auth.signOut();
document.getElementById('auth-loading').classList.add('hidden');
showAuthMessage('â³ HesabÄ±nÄ±z yÃ¶netici onayÄ± bekliyor. LÃ¼tfen daha sonra tekrar deneyin.');
return;
}

// EÄŸer ne onaylÄ± ne beklemede ne de reddedilmiÅŸse, eski kullanÄ±cÄ± - otomatik onayla
if (!isApproved && !isPending && !isRejected) {
await database.ref(`approved_users/${emailKey}`).set({
email: user.email,
uid: user.uid,
approvedAt: new Date().toISOString(),
approvedBy: 'system_auto',
note: 'Mevcut kullanÄ±cÄ± - otomatik onay'
});
isApproved = true;
}

// Onay durumunu cache'le (hÄ±zlÄ± giriÅŸ iÃ§in)
if (isApproved) {
window.localStorage.setItem(approvalCacheKey, 'approved');
}

// ===== ONAY KONTROLÃœ BÄ°TTÄ° =====

currentUser = user;
userDataPath = 'evde_saglik_ortak_veri';

// 1. ADIM: Login ekranÄ±nÄ± gizle ama App ekranÄ±nÄ± HENÃœZ AÃ‡MA
// Sadece loading ekranÄ±nÄ± gÃ¶ster.
authContainer.style.display = 'flex'; // Container kalsÄ±n, formlar gizlensin
document.getElementById('login-form').classList.add('hidden');
document.getElementById('register-form').classList.add('hidden');
document.querySelector('.border-b.mb-6')?.classList.add('hidden'); // Tab butonlarÄ±nÄ± gizle
document.querySelector('.text-center.mb-8').style.display = 'none'; // Logoyu gizle veya bÄ±rakabilirsin

loadingEl.classList.remove('hidden');
updateLoadingMsg('Veriler Buluttan Ã‡ekiliyor...<br><span class="text-xs text-gray-500">LÃ¼tfen bekleyin</span>');

try {
// 2. ADIM: TÃœM VERÄ°LERÄ° Ã‡EK VE BEKLE (Await)

const promises = CRITICAL_KEYS.map(key => database.ref(`${userDataPath}/${key}`).once('value'));
const snapshots = await Promise.all(promises);

// 3. ADIM: Ã‡EKÄ°LEN VERÄ°LERÄ° Ã–NBELLEÄE VE LOCALSTORAGE'A YAZ
if (!window._firebaseCache) window._firebaseCache = {};

snapshots.forEach((snap, index) => {
const key = CRITICAL_KEYS[index];
const val = snap.val();

// Cache'e at
window._firebaseCache[key] = val;

// LocalStorage gÃ¼ncelle (Yedeklilik iÃ§in)
if (val !== null) {
const storeVal = (typeof val === 'object') ? JSON.stringify(val) : val;
originalLocalStorage.setItem(key, storeVal);
} else {
originalLocalStorage.removeItem(key);
}
});

// 4. ADIM: REALTIME LISTENER'LARI BAÅLAT (Bundan sonraki deÄŸiÅŸimler iÃ§in)
startRealtimeListeners();

// 5. ADIM: UYGULAMAYI BAÅLAT VE EKRANI AÃ‡
if (typeof loadAll === 'function') loadAll(); // Verileri global deÄŸiÅŸkenlere daÄŸÄ±t

// YÃ¼kleme ekranÄ±nÄ± kapat, Ana ekranÄ± aÃ§
authContainer.style.display = 'none';
loadingEl.classList.add('hidden');
appContainer.style.display = 'block';

// UI Render iÅŸlemleri
renderUI();
if (typeof renderShiftTable === 'function') renderShiftTable();
if (typeof renderDeviceTable === 'function') renderDeviceTable();
if (typeof renderBudgetHeader === 'function') renderBudgetHeader();
if (typeof renderPhonebook === 'function') renderPhonebook();

// Doktor talepleri yÃ¼kle ve dinleyiciyi baÅŸlat
// Ã–NCE kullanÄ±cÄ±nÄ±n son gÃ¶rÃ¼ntÃ¼leme zamanlarÄ±nÄ± yÃ¼kle (badge'ler iÃ§in kritik)
if (typeof loadUserTabViewTimes === 'function') await loadUserTabViewTimes();
if (typeof loadDoctorRequests === 'function') loadDoctorRequests();
if (typeof startDoctorRequestsRealtimeListener === 'function') startDoctorRequestsRealtimeListener();

// Pansuman, Sonda INR NG, Dr NotlarÄ± verileri yÃ¼kle
if (typeof loadPansumanData === 'function') loadPansumanData();
if (typeof renderSondaInrNgTable === 'function') renderSondaInrNgTable();
if (typeof renderNotlarContent === 'function') renderNotlarContent();

// Ã‡Ä±kÄ±ÅŸ butonu eklemesi (Mevcut kodunuzdaki gibi)
addLogoutButtonToHeader();

// --- EKRAN KÄ°LÄ°DÄ° DURUMU KONTROLÃœ ---
// EÄŸer Ã¶nceden kilitliyse kilit ekranÄ±nÄ± gÃ¶ster (native localStorage kullan)
const lockValue = window.localStorage.getItem('isSystemLocked');
const wasLocked = lockValue === 'yes';
if (wasLocked) {
// lockSession fonksiyonunu Ã§aÄŸÄ±r (doÄŸru modalÄ± aÃ§ar)
setTimeout(() => {
if (typeof window.lockSession === 'function') {
window.lockSession();
}
}, 500);
} else {
}

} catch (error) {
console.error('âŒ Kritik Hata:', error);
updateLoadingMsg('BaÄŸlantÄ± HatasÄ±!<br><span class="text-xs text-red-500">Veriler yÃ¼klenemedi. SayfayÄ± yenileyin.</span>');
// Ä°sterseniz burada "Offline Devam Et" butonu Ã§Ä±kartabilirsiniz.
// Ama gÃ¼venlik istiyorsanÄ±z burada durmasÄ± daha iyidir.
}

} else {
// Ã‡Ä±kÄ±ÅŸ YapÄ±lmÄ±ÅŸsa
currentUser = null;
userDataPath = null;

appContainer.style.display = 'none';
authContainer.style.display = 'flex';

// Login formlarÄ±nÄ± geri getir
document.getElementById('login-form').classList.remove('hidden');
document.querySelector('.border-b.mb-6')?.classList.remove('hidden');
document.querySelector('.text-center.mb-8').style.display = 'block';
loadingEl.classList.add('hidden');
}
});

// Realtime ListenerlarÄ± BaÅŸlatan YardÄ±mcÄ± Fonksiyon
function startRealtimeListeners() {
CRITICAL_KEYS.forEach(key => {
// Eski listener'Ä± temizle
database.ref(`${userDataPath}/${key}`).off();

// Yeni listener ekle
FirebaseStorage.addListener(key, (value) => {
// Sadece deÄŸiÅŸiklik olduÄŸunda Ã§alÄ±ÅŸÄ±r, ilk yÃ¼klemeyi zaten yukarÄ±da yaptÄ±k
if (!window._firebaseCache) window._firebaseCache = {};
window._firebaseCache[key] = value;

// DeÄŸiÅŸikliÄŸe gÃ¶re ilgili UI'Ä± gÃ¼ncelle
handleLiveUpdate(key, value);
});
});

// ===== ENGELLÄ° KULLANICI CANLI DÄ°NLEME =====
// KullanÄ±cÄ± engellendiÄŸinde anÄ±nda oturum kapatÄ±lÄ±r
if (currentUser && currentUser.email) {
const emailKey = currentUser.email.replace(/\./g, ',').replace(/@/g, '_at_');
let isFirstCheck = true; // Ä°lk kontrol flag'i

database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}/blocked`).on('value', async (snapshot) => {
const isBlocked = snapshot.val() === true;

// Ä°lk yÃ¼klemede kontrol etme (zaten giriÅŸ kontrolÃ¼nde yapÄ±ldÄ±)
if (isFirstCheck) {
isFirstCheck = false;
return;
}

if (isBlocked) {

// Ã–nce tÃ¼m listener'larÄ± kapat
database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}/blocked`).off();
CRITICAL_KEYS.forEach(key => {
try { database.ref(`${userDataPath}/${key}`).off(); } catch (e) { }
});

// Oturumu kapat
await auth.signOut();

// UI'Ä± hemen giriÅŸ ekranÄ±na dÃ¶ndÃ¼r
const authContainer = document.getElementById('auth-container');
const appContainer = document.getElementById('app');

if (appContainer) appContainer.style.display = 'none';
if (authContainer) authContainer.style.display = 'flex';

// UyarÄ± mesajÄ± gÃ¶ster
showToast('ğŸš« HesabÄ±nÄ±z engellenmiÅŸtir! Oturumunuz kapatÄ±ldÄ±.', 'error');

// GiriÅŸ ekranÄ±nda da mesaj gÃ¶ster
const authMsg = document.getElementById('auth-message');
if (authMsg) {
authMsg.className = 'mt-2 text-sm text-red-600 font-bold bg-red-100 p-3 rounded-lg';
authMsg.innerHTML = 'ğŸš« HesabÄ±nÄ±z engellenmiÅŸtir. YÃ¶netici ile iletiÅŸime geÃ§in.';
authMsg.classList.remove('hidden');
}

// currentUser'Ä± temizle
currentUser = null;
}
});
}
// ===== ENGELLÄ° KULLANICI CANLI DÄ°NLEME BÄ°TTÄ° =====
}

// Manuel Senkronizasyon Fonksiyonu (Senkronize Et butonu iÃ§in)
async function forceSyncData() {
if (!currentUser || !userDataPath) {
showToast('LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!', 'warning');
return;
}

// Senkronizasyon animasyonu
const syncIcon = document.getElementById('sync-icon');
if (syncIcon) syncIcon.classList.add('animate-spin');

showToast('ğŸ”„ Veriler senkronize ediliyor...', 'info');

try {
// TÃ¼m kritik verileri Firebase'den Ã§ek
for (const key of CRITICAL_KEYS) {
try {
const snapshot = await database.ref(`${userDataPath}/${key}`).once('value');
const value = snapshot.val();

// Cache'i gÃ¼ncelle
if (!window._firebaseCache) window._firebaseCache = {};
window._firebaseCache[key] = value;

// UI'Ä± gÃ¼ncelle
handleLiveUpdate(key, value);

} catch (err) {
console.error(`âŒ Senkronizasyon hatasÄ± (${key}):`, err);
}
}

showToast('âœ… TÃ¼m veriler senkronize edildi!', 'success');

} catch (error) {
console.error('âŒ Senkronizasyon hatasÄ±:', error);
showToast('âŒ Senkronizasyon hatasÄ±!', 'error');
} finally {
// Animasyonu durdur
if (syncIcon) syncIcon.classList.remove('animate-spin');
}
}

// CanlÄ± veri geldiÄŸinde yapÄ±lacaklar (Switch-Case yapÄ±nÄ±z buraya taÅŸÄ±ndÄ±)
function handleLiveUpdate(key, value) {
switch (key) {
// --- YENÄ° KÄ°LÄ°T KONTROL KODU ---
case 'evdeSaglikLockedTabsConfig_V1':
// 1. Listeyi GÃ¼ncelle
if (typeof value === 'string') {
try { window.lockedTabsConfig = JSON.parse(value); } catch (e) { window.lockedTabsConfig = []; }
} else {
window.lockedTabsConfig = value || [];
}

// 2. HafÄ±zayÄ± Temizle (Eski izinleri iptal et)
if (window.unlockedSessionTabs) {
if (Array.isArray(window.lockedTabsConfig)) {
window.lockedTabsConfig.forEach(tabId => {
window.unlockedSessionTabs[tabId] = false;
});
}
}

// 3. SUÃ‡ÃœSTÃœ YAP (EÄŸer kullanÄ±cÄ± ÅŸu an o sekmedeyse dÄ±ÅŸarÄ± at!)
const currentTab = document.querySelector('.tab-content:not(.hidden)');
if (currentTab) {
const currentId = currentTab.id.replace('tab-', '');
// EÄŸer baktÄ±ÄŸÄ± sayfa artÄ±k kilitliyse
if (window.lockedTabsConfig.includes(currentId)) {
if (typeof switchTab === 'function') {
switchTab('personel'); // Ana sayfaya fÄ±rlat
showToast("Bu sekme yÃ¶netici tarafÄ±ndan kilitlendi!", "warning");
}
}
}
break;
case 'evdeSaglikShifts_V19':
shiftList = value || [];
if (!document.getElementById('tab-nobet').classList.contains('hidden')) renderShiftTable();
break;
case 'evdeSaglikAppPW_Enc_V1':
if (value) {
try {
appPassword = atob(value);
originalLocalStorage.setItem('evdeSaglikAppPW_Enc_V1', value);
} catch (e) { console.error(e); }
}
break;
// ... DiÄŸer case'leriniz buraya aynen gelecek (Budget, Devices vb.)
// Kod tekrarÄ± olmamasÄ± iÃ§in buraya sadece kritik olanlarÄ± yazdÄ±m,
// mevcut kodunuzdaki switch-case yapÄ±sÄ±nÄ± buraya kopyalayabilirsiniz.
case 'evdeSaglikData_ULTIMATE_V18':
allRecords = value || {};
if (!document.getElementById('tab-personel').classList.contains('hidden')) renderUI();
break;
case 'evdeSaglikBudget_V19':
budgetList = value || [];
if (!document.getElementById('tab-butce').classList.contains('hidden')) {
if (typeof renderBudgetHeader === 'function') renderBudgetHeader(); else renderBudget();
}
break;
case 'evdeSaglikDoctorRequests_V1':
// Global deÄŸiÅŸkeni gÃ¼ncelle (window scope)
if (Array.isArray(value)) {
window.doctorRequestsList = value;
} else if (value && typeof value === 'object') {
window.doctorRequestsList = Object.values(value);
} else {
window.doctorRequestsList = [];
}
// Her zaman listeyi render et (sekme aÃ§Ä±k olsun veya olmasÄ±n veriyi gÃ¼ncelle)
try {
if (typeof renderDoctorRequestsList === 'function') {
renderDoctorRequestsList();
}
} catch (e) {
console.error('renderDoctorRequestsList hatasÄ±:', e);
}
break;
// Ä°htiyaÃ§ duyduÄŸunuz diÄŸer case bloklarÄ±nÄ± buraya ekleyin...
}
}

function addLogoutButtonToHeader() {
// Ã‡Ä±kÄ±ÅŸ butonu artÄ±k menÃ¼de olduÄŸu iÃ§in header'a eklenmez
// Mobil iÃ§in daha temiz gÃ¶rÃ¼nÃ¼m saÄŸlanÄ±yor
}

document.addEventListener('DOMContentLoaded', () => {
['login-email', 'login-password'].forEach(id => {
const el = document.getElementById(id);
if (el) el.addEventListener('keypress', (e) => { if (e.key === 'Enter') loginUser(); });
});

['register-email', 'register-password', 'register-password-confirm'].forEach(id => {
const el = document.getElementById(id);
if (el) el.addEventListener('keypress', (e) => { if (e.key === 'Enter') registerUser(); });
});

// Tarih inputlarÄ±na tÄ±klandÄ±ÄŸÄ±nda takvim otomatik aÃ§Ä±lsÄ±n
document.addEventListener('click', (e) => {
if (e.target.matches('input[type="date"]')) {
try { e.target.showPicker(); } catch (err) { }
}
});
});
</script>

<div id="app" style="display: none;"
class="max-w-[98%] mx-auto bg-white shadow-xl rounded-2xl border border-gray-100 overflow-hidden">
<div id="tomorrow-alert-box"
class="hidden bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 relative" role="alert">
<div class="flex items-center">
<div class="py-1"><i data-lucide="bell-ring" class="w-6 h-6 mr-4 text-orange-600"></i></div>
<div>
<p class="font-bold">YarÄ±n Ä°Ã§in PlanlanmÄ±ÅŸ Ä°ÅŸlemler Var!</p>
<p class="text-sm" id="tomorrow-alert-text">Detaylar yÃ¼kleniyor...</p>
</div>
<button onclick="document.getElementById('tomorrow-alert-box').classList.add('hidden')"
class="absolute top-0 bottom-0 right-0 px-4 py-3 text-orange-600 hover:text-orange-800">
<i data-lucide="x" class="w-5 h-5"></i>
</button>
</div>
</div>
<div class="flex justify-between items-center px-4 md:px-6 py-3 md:py-4 border-b bg-white">
<div class="flex items-center gap-2 md:gap-3">
<div class="bg-indigo-600 p-1.5 md:p-2 rounded-lg text-white flex-shrink-0">
<i data-lucide="activity" class="w-5 h-5 md:w-6 md:h-6"></i>
</div>
<div class="min-w-0">
<h1 class="text-sm md:text-2xl font-bold text-gray-900 tracking-tight leading-tight">
<span class="md:hidden">Evde SaÄŸlÄ±k<br>YÃ¶netimi</span>
<span class="hidden md:inline">Evde SaÄŸlÄ±k YÃ¶netimi</span>
</h1>
<p class="text-xs text-gray-500 hidden md:block">Personel, Uzman ve Doktor Takip Sistemi</p>
</div>
</div>
<div class="flex-1 mx-6 relative hidden md:block max-w-xl z-[50]">
<div class="relative group">
<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
<i data-lucide="search"
class="w-4 h-4 text-gray-400 group-focus-within:text-indigo-500 transition-colors"></i>
</div>
<input type="text" id="global-search-input"
class="block w-full pl-10 pr-3 py-2.5 border border-gray-200 rounded-xl leading-5 bg-gray-50 text-gray-700 placeholder-gray-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-sm font-medium shadow-sm"
placeholder="HÄ±zlÄ± Ara... (Sokak, Pans., Sonda, Ä°nr, Ä°zin, Rehber)" autocomplete="off">

<div id="global-search-results"
class="fixed bg-white border border-gray-200 shadow-2xl rounded-xl hidden max-h-[80vh] overflow-y-auto overscroll-contain w-[450px]"
style="-webkit-overflow-scrolling: touch; z-index: 50;">
</div>
</div>
</div>

<button onclick="promptMessagesPassword()" id="btn-messages"
class="relative flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold bg-blue-100 text-blue-700 hover:bg-blue-200 transition border border-blue-200"
title="MesajlarÄ±m">
<i data-lucide="mail" class="w-4 h-4"></i>
<span class="hidden md:inline">MesajlarÄ±m</span>
<span id="messages-badge"
class="hidden absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold rounded-full min-w-[18px] h-[18px] flex items-center justify-center px-1">0</span>
</button>

<button onclick="toggleNotificationPanel()" id="btn-notifications"
class="relative flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold bg-orange-100 text-orange-700 hover:bg-orange-200 transition border border-orange-200"
title="Bildirimler">
<i data-lucide="bell" class="w-4 h-4"></i>
<span class="hidden md:inline">Bildirimler</span>
<span id="notification-badge"
class="hidden absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold rounded-full min-w-[18px] h-[18px] flex items-center justify-center px-1">0</span>
</button>

<div class="relative">
<button onclick="toggleHeaderMenu()" id="header-menu-btn"
class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold bg-indigo-600 text-white hover:bg-indigo-700 transition shadow-sm">
<i data-lucide="menu" class="w-4 h-4"></i>
MENÃœ
<i data-lucide="chevron-down" class="w-4 h-4"></i>
</button>

<div id="header-menu-dropdown"
class="hidden absolute right-0 top-full mt-2 w-64 bg-white rounded-xl shadow-2xl border border-gray-200 z-[9999] max-h-[80vh] overflow-y-auto"
style="position: fixed; right: 10px; top: 60px;">
<div class="p-2 border-b border-gray-100">
<p class="text-[10px] font-bold text-gray-400 uppercase px-2 mb-1">Hesap</p>
<button onclick="location.reload();"
class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-lg transition">
<i data-lucide="refresh-cw" class="w-4 h-4 text-blue-600"></i> SayfayÄ± Yenile
</button>
<button onclick="openProfileModal(); closeHeaderMenu();"
class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-teal-50 rounded-lg transition">
<i data-lucide="user-circle" class="w-4 h-4 text-teal-600"></i> Profilim
</button>
<button onclick="openUserManagementModal(); closeHeaderMenu();" id="menu-btn-user-management"
data-admin-only
class="hidden w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-yellow-50 rounded-lg transition">
<span class="text-base">ğŸ‘¥</span> KullanÄ±cÄ± YÃ¶netimi
</button>
</div>

<div class="p-2 border-b border-gray-100">
<p class="text-[10px] font-bold text-gray-400 uppercase px-2 mb-1">GÃ¶rÃ¼nÃ¼m & Ayarlar</p>
<button onclick="toggleTheme(); closeHeaderMenu();" id="menu-theme-toggle"
class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg transition">
<i data-lucide="moon" class="w-4 h-4 text-gray-600"></i> KaranlÄ±k Mod
</button>
<button onclick="openTabSortModal(); closeHeaderMenu();"
class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-purple-50 rounded-lg transition">
<i data-lucide="arrow-up-down" class="w-4 h-4 text-purple-600"></i> Sekmeleri SÄ±rala
</button>
<button id="menu-api-settings"
onclick="document.getElementById('btn-open-settings').click(); closeHeaderMenu();"
class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg transition admin-only-menu"
style="display: none;">
<i data-lucide="settings" class="w-4 h-4 text-gray-600"></i> API AyarlarÄ±
</button>
<button onclick="openTabSettingsModal(); closeHeaderMenu();" data-user-allowed
class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-orange-50 rounded-lg transition">
<i data-lucide="shield-alert" class="w-4 h-4 text-orange-600"></i> Sekme Kilit AyarlarÄ±
</button>
<button onclick="openAppearanceModal(); closeHeaderMenu();"
class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-purple-50 rounded-lg transition">
<i data-lucide="palette" class="w-4 h-4 text-purple-600"></i> GÃ¶rÃ¼nÃ¼m AyarlarÄ±
</button>
</div>

<div class="p-2 border-b border-gray-100">
<p class="text-[10px] font-bold text-gray-400 uppercase px-2 mb-1">Veri</p>
<button onclick="forceSyncData(); closeHeaderMenu();"
class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="refresh-cw" class="w-4 h-4 text-indigo-600"></i> Senkronize Et
</button>
<button onclick="generateDailyReport(); closeHeaderMenu();"
class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-red-50 rounded-lg transition">
<i data-lucide="file-text" class="w-4 h-4 text-red-600"></i> GÃ¼n Sonu Raporu
</button>

</div>

<div class="p-2">
<p class="text-[10px] font-bold text-gray-400 uppercase px-2 mb-1">GÃ¼venlik</p>
<button onclick="lockSession(); closeHeaderMenu();"
class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-800 hover:text-white rounded-lg transition">
<i data-lucide="lock" class="w-4 h-4"></i> EkranÄ± Kilitle <span
class="text-[10px] text-gray-400 ml-auto">(Ctrl+L)</span>
</button>
<button onclick="openScreenLockSettingsModal(); closeHeaderMenu();"
class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-yellow-50 rounded-lg transition">
<i data-lucide="shield-check" class="w-4 h-4 text-yellow-600"></i> Ekran Kilidi AyarlarÄ±
</button>
<button onclick="openActiveDevicesModal(); closeHeaderMenu();"
class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-lg transition">
<i data-lucide="smartphone" class="w-4 h-4 text-blue-600"></i> Aktif Cihazlar
</button>
<button onclick="openPendingUsersModal(); closeHeaderMenu();" data-admin-only
class="hidden w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-yellow-50 rounded-lg transition">
<i data-lucide="user-check" class="w-4 h-4 text-yellow-600"></i> Bekleyen KullanÄ±cÄ±lar
<span id="pending-users-badge"
class="hidden ml-auto px-2 py-0.5 text-xs font-bold bg-red-500 text-white rounded-full">0</span>
</button>
<button onclick="document.getElementById('lock-toggle').click(); closeHeaderMenu();"
id="menu-lock-toggle"
class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-green-50 rounded-lg transition">
<i data-lucide="unlock" class="w-4 h-4 text-green-600"></i>
<span>Veri GiriÅŸi: <span id="menu-lock-status"
class="font-bold text-green-600">AÃ§Ä±k</span></span>
</button>
</div>

<div class="p-2 border-t border-gray-100" id="admin-log-clear-section" style="display: none;">
<p class="text-[10px] font-bold text-red-400 uppercase px-2 mb-1">ğŸ” Admin</p>
<button onclick="clearActivityLogs(); closeHeaderMenu();"
class="w-full flex items-center gap-3 px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg transition">
<i data-lucide="trash-2" class="w-4 h-4"></i> Log KayÄ±tlarÄ±nÄ± Temizle
</button>
</div>

<div class="p-2 border-t border-gray-100">
<button onclick="logoutUser(); closeHeaderMenu();"
class="w-full flex items-center gap-3 px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg transition font-bold">
<i data-lucide="log-out" class="w-4 h-4"></i> Ã‡Ä±kÄ±ÅŸ Yap
</button>
</div>
</div>
</div>

<div class="hidden">
<button id="btn-activity-log"></button>
<button id="btn-user-management"></button>
<button id="btn-theme-toggle"></button>
<button id="btn-open-settings"></button>
<button id="btn-change-password"></button>
<button id="lock-toggle"></button>
<span id="lock-status"></span>
<i id="lock-icon"></i>
<i id="theme-icon"></i>
<i id="sync-icon"></i>
</div>
</div>

<div class="md:hidden px-3 py-2 bg-white border-b border-gray-200">
<div class="relative">
<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
<i data-lucide="search" class="w-4 h-4 text-gray-400"></i>
</div>
<input type="text" id="global-search-input-mobile-trigger"
class="block w-full pl-10 pr-3 py-2.5 border border-gray-200 rounded-xl leading-5 bg-gray-50 text-gray-700 placeholder-gray-400 focus:outline-none transition duration-150 ease-in-out text-sm font-medium shadow-sm cursor-pointer"
placeholder="HÄ±zlÄ± Ara... (Sokak, Pans., Sonda, Ä°nr, Ä°zin, Rehber)" readonly onclick="openMobileSearchModal()">
</div>
</div>

<!-- TAM EKRAN MOBÄ°L ARAMA MODAL -->
<div id="mobile-search-modal" class="fixed inset-0 bg-white z-[99999] hidden flex-col">
<div class="sticky top-0 bg-gradient-to-r from-indigo-600 to-indigo-700 px-4 py-3 flex items-center gap-3 shadow-lg">
<button onclick="closeMobileSearchModal()" class="p-2 text-white hover:bg-white/20 rounded-lg transition">
<i data-lucide="arrow-left" class="w-5 h-5"></i>
</button>
<div class="flex-1 relative">
<input type="text" id="mobile-search-modal-input"
class="w-full pl-4 pr-10 py-2.5 rounded-xl text-sm bg-white text-gray-800 placeholder-gray-400 outline-none shadow-inner"
placeholder="Arama yapÄ±n..." autocomplete="off">
<i data-lucide="search" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
</div>
</div>
<div id="mobile-search-modal-results" class="flex-1 overflow-y-auto p-3 space-y-2 bg-gray-50">
<div class="text-center text-gray-400 py-8">
<i data-lucide="search" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i>
<p>Aramak iÃ§in yazÄ±n...</p>
</div>
</div>
</div>

<div class="px-2 py-2 bg-gray-50 border-b flex flex-nowrap items-center gap-2 overflow-x-auto no-scrollbar">

<div class="flex items-center gap-2 flex-shrink-0">
<button id="open-entry-modal-btn"
class="admin-only-btn mobile-icon-only flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow-sm text-sm font-medium whitespace-nowrap">
<i data-lucide="edit-3" class="w-4 h-4"></i> <span>Veri / Hasta GiriÅŸi</span>
</button>
<button id="open-staff-modal-btn"
class="admin-only-btn mobile-icon-only flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition text-sm font-medium whitespace-nowrap">
<i data-lucide="users" class="w-4 h-4"></i> <span>Personel & Doktor</span>
</button>
</div>

<div class="flex items-center gap-2 ml-auto flex-shrink-0">
<button id="btn-ai-report"
class="mobile-icon-only flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 transition shadow-sm text-sm font-bold border border-transparent whitespace-nowrap">
<i data-lucide="sparkles" class="w-4 h-4"></i> <span>AI Rapor</span>
</button>

<div id="header-export-buttons"
class="flex items-center bg-white border border-gray-200 rounded-lg p-1 shadow-sm flex-shrink-0">
<button id="btn-export-excel" onclick="exportData('xlsx')"
class="mobile-icon-only flex items-center gap-1.5 px-3 py-1.5 rounded hover:bg-green-50 text-gray-600 hover:text-green-700 transition text-xs font-semibold border-r border-gray-100 whitespace-nowrap">
<i data-lucide="file-spreadsheet" class="w-3.5 h-3.5"></i> <span>Excel</span>
</button>
<button id="btn-export-pdf" onclick="exportData('pdf')"
class="mobile-icon-only flex items-center gap-1.5 px-3 py-1.5 rounded hover:bg-red-50 text-gray-600 hover:text-red-700 transition text-xs font-semibold whitespace-nowrap">
<i data-lucide="file-text" class="w-3.5 h-3.5"></i> <span>PDF</span>
</button>
</div>

<button id="btn-import-data" onclick="triggerImportWithPassword()"
class="admin-only-btn mobile-icon-only flex items-center gap-2 px-3 py-2 bg-blue-50 text-blue-700 border border-blue-100 rounded-lg hover:bg-blue-100 transition cursor-pointer text-xs font-bold whitespace-nowrap flex-shrink-0">
<i data-lucide="upload-cloud" class="w-4 h-4"></i> <span>YÃ¼kle</span>
</button>

<input type="file" id="import-file" accept=".xlsx, .csv" class="hidden">
</div>
</div>

<!-- MOBÄ°L HAMBURGER MENÃœ -->
<div id="mobile-tab-menu" class="md:hidden border-b bg-gray-50 px-3 py-2">
<button onclick="toggleMobileTabMenu()" class="flex items-center justify-between w-full px-3 py-2 bg-white border border-gray-200 rounded-lg shadow-sm">
<span class="flex items-center gap-2">
<i data-lucide="menu" class="w-5 h-5 text-indigo-600"></i>
<span id="current-tab-name" class="font-semibold text-gray-700 text-sm">Hasta Takip</span>
</span>
<i data-lucide="chevron-down" id="mobile-menu-arrow" class="w-4 h-4 text-gray-500 transition-transform"></i>
</button>
<div id="mobile-tab-dropdown" class="hidden mt-2 bg-white border border-gray-200 rounded-xl shadow-lg max-h-[60vh] overflow-y-auto">
<div class="p-2 grid grid-cols-2 gap-1">
<button onclick="switchTab('hastatakip'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="heart-pulse" class="w-4 h-4 text-indigo-600"></i> Hasta Takip
</button>
<button onclick="switchTab('personel'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="users" class="w-4 h-4 text-blue-600"></i> Personel
</button>
<button onclick="switchTab('uzman'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="user-check" class="w-4 h-4 text-purple-600"></i> Uzman EÅŸleÅŸme
</button>
<button onclick="switchTab('analiz'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="bar-chart-3" class="w-4 h-4 text-emerald-600"></i> GeÃ§miÅŸ Analiz
</button>
<button onclick="switchTab('rutinler'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="repeat" class="w-4 h-4 text-orange-600"></i> Rutinler
</button>
<button onclick="switchTab('acilcanta'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="briefcase-medical" class="w-4 h-4 text-red-600"></i> Acil Ã‡anta
</button>
<button onclick="switchTab('butce'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="wallet" class="w-4 h-4 text-green-600"></i> BÃ¼tÃ§e
</button>
<button onclick="switchTab('notlar'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="sticky-note" class="w-4 h-4 text-yellow-600"></i> Sor. Hem. Not
</button>
<button onclick="switchTab('drnotlar'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="stethoscope" class="w-4 h-4 text-blue-600"></i> Dr NotlarÄ±
</button>
<button onclick="switchTab('nobet'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="moon" class="w-4 h-4 text-indigo-600"></i> NÃ¶bet
</button>
<button onclick="switchTab('cihazlar'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="monitor-smartphone" class="w-4 h-4 text-gray-600"></i> Cihaz/Zimmet
</button>
<button onclick="switchTab('istatistik'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="pie-chart" class="w-4 h-4 text-pink-600"></i> Ä°statistikler
</button>
<button onclick="switchTab('puantaj'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="calculator" class="w-4 h-4 text-cyan-600"></i> Puantaj
</button>
<button onclick="switchTab('rehber'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="phone" class="w-4 h-4 text-green-600"></i> Rehber
</button>
<button onclick="switchTab('takvim'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="calendar" class="w-4 h-4 text-blue-600"></i> Takvim
</button>
<button onclick="switchTab('inrhesaplayici'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="activity" class="w-4 h-4 text-red-600"></i> Ä°NR Hesap
</button>
<button onclick="switchTab('dogumgunu'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="cake" class="w-4 h-4 text-pink-500"></i> DoÄŸum GÃ¼nÃ¼
</button>
<button onclick="switchTab('pansuman'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="bandage" class="w-4 h-4 text-orange-500"></i> Pansuman
</button>
<button onclick="switchTab('sondainr'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="syringe" class="w-4 h-4 text-teal-600"></i> Sonda/Ä°NR/NG
</button>
<button onclick="switchTab('izinrapor'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="calendar-off" class="w-4 h-4 text-orange-600"></i> Ä°zin/Rapor
</button>
<button onclick="switchTab('sokaksorgu'); toggleMobileTabMenu();" class="mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition">
<i data-lucide="map-pin" class="w-4 h-4 text-red-500"></i> Sokak Sorgu
</button>
</div>
</div>
</div>

<!-- MASAÃœSTÃœ SEKME MENÃœSÃœ -->
<div id="ust-menu"
class="hidden md:flex border-b bg-gray-50 px-2 w-full flex-nowrap gap-1 overflow-x-auto no-scrollbar items-center cursor-grab select-none">
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-indigo-600 text-indigo-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('hastatakip')"><i data-lucide="heart-pulse" class="w-3.5 h-3.5"></i> Hasta Takip</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('personel')"><i data-lucide="users" class="w-3.5 h-3.5"></i> Personel</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('uzman')"><i data-lucide="user-check" class="w-3.5 h-3.5"></i> Uzman</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('analiz')"><i data-lucide="bar-chart-3" class="w-3.5 h-3.5"></i> Analiz</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('rutinler')"><i data-lucide="repeat" class="w-3.5 h-3.5"></i> Rutinler</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('acilcanta')"><i data-lucide="briefcase-medical" class="w-3.5 h-3.5"></i> Acil Ã‡anta</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('butce')"><i data-lucide="wallet" class="w-3.5 h-3.5"></i> BÃ¼tÃ§e</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('notlar')"><i data-lucide="sticky-note" class="w-3.5 h-3.5"></i> Sor.Hem.Not</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('drnotlar')"><i data-lucide="stethoscope" class="w-3.5 h-3.5"></i> Dr Not</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('nobet')"><i data-lucide="moon" class="w-3.5 h-3.5"></i> NÃ¶bet</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('cihazlar')"><i data-lucide="monitor-smartphone" class="w-3.5 h-3.5"></i> Cihaz</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('istatistik')"><i data-lucide="pie-chart" class="w-3.5 h-3.5"></i> Ä°statistik</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('puantaj')"><i data-lucide="calculator" class="w-3.5 h-3.5"></i> Puantaj</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('rehber')"><i data-lucide="phone" class="w-3.5 h-3.5"></i> Rehber</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('takvim')"><i data-lucide="calendar" class="w-3.5 h-3.5"></i> Takvim</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('inrhesaplayici')"><i data-lucide="activity" class="w-3.5 h-3.5"></i> Ä°NR</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('dogumgunu')"><i data-lucide="cake" class="w-3.5 h-3.5"></i> D.GÃ¼nÃ¼</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('pansuman')"><i data-lucide="bandage" class="w-3.5 h-3.5"></i> Pansuman</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('sondainr')"><i data-lucide="syringe" class="w-3.5 h-3.5"></i> Sonda/Ä°NR</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('izinrapor')"><i data-lucide="calendar-off" class="w-3.5 h-3.5"></i> Ä°zin/Rapor</button>
<button
class="tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap flex items-center gap-1"
onclick="switchTab('sokaksorgu')"><i data-lucide="map-pin" class="w-3.5 h-3.5"></i> Sokak</button>
</div>

<div class="p-6 min-h-[0px]">

<div id="global-date-nav" class="flex items-center justify-center mb-6 relative z-[1]">
<div class="flex items-center bg-white border rounded-full px-1 py-1 shadow-sm">
<button id="prev-week" class="p-1.5 hover:bg-gray-100 rounded-full transition text-gray-500"><i
data-lucide="chevron-left" class="w-5 h-5"></i></button>
<span id="current-week-display"
class="px-4 text-sm font-semibold text-gray-700 min-w-[200px] text-center select-none"></span>
<button id="next-week" class="p-1.5 hover:bg-gray-100 rounded-full transition text-gray-500"><i
data-lucide="chevron-right" class="w-5 h-5"></i></button>
</div>
</div>

<div id="tab-personel" class="tab-content hidden">
<div
class="flex items-center justify-between mb-4 bg-white rounded-xl border border-gray-200 p-3 shadow-sm">
<h2 class="font-bold text-gray-800 flex items-center gap-2">
<div
class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center">
<i data-lucide="users" class="w-4 h-4 text-white"></i>
</div>
<span class="hidden md:inline">Personel Takip</span>
</h2>
<div class="flex items-center gap-2">
<button onclick="exportPersonelExcel()"
class="flex items-center gap-1 md:gap-2 px-2 md:px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-bold shadow-sm"
title="Excel Ä°ndir">
<i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
<span class="hidden md:inline">Excel</span>
</button>
<button onclick="exportPersonelPDF()"
class="flex items-center gap-1 md:gap-2 px-2 md:px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm font-bold shadow-sm"
title="PDF Ä°ndir">
<i data-lucide="file-text" class="w-4 h-4"></i>
<span class="hidden md:inline">PDF</span>
</button>
</div>
</div>
<div
class="scroll-container rounded-xl border border-gray-200 shadow-sm mb-8 overflow-x-auto touch-pan-x">
<table id="tracking-table" class="w-full text-sm text-left">
<thead class="text-xs text-gray-500 uppercase bg-gray-50/50 border-b">
<tr id="tracking-head">
<th class="px-4 py-3 sticky-col-1 bg-gray-50 font-semibold">Personel</th>
</tr>
</thead>
<tbody id="tracking-body" class="bg-white divide-y divide-gray-100"></tbody>
</table>
</div>

<div id="team-tracking-section" class="mb-8">
<h3 class="text-lg font-bold text-indigo-900 mb-4 flex items-center">
<i data-lucide="users" class="w-5 h-5 mr-2"></i> Ekip / Liste GÃ¶rev DaÄŸÄ±lÄ±mÄ±
</h3>
<div
class="scroll-container rounded-xl border border-gray-200 shadow-sm bg-white overflow-x-auto touch-pan-x">
<table class="w-full text-sm text-left">
<thead class="text-xs text-gray-500 uppercase bg-gray-50/50 border-b">
<tr id="team-table-head">
<th class="px-4 py-3 sticky-col-1 bg-gray-50 font-semibold border-r">Ekip / Liste
</th>
</tr>
</thead>
<tbody id="team-table-body" class="divide-y divide-gray-100"></tbody>
</table>
</div>
</div>

<div class="bg-gray-50 rounded-xl p-4 border border-gray-200 mb-8">
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
<div class="bg-white p-3 rounded border text-center">
<div class="text-[10px] text-gray-400 uppercase font-bold">Hafta Hedef (Mod)</div>
<div id="weekly-mode-target" class="text-xl font-bold text-blue-600">-</div>
</div>
<div class="bg-white p-3 rounded border text-center">
<div class="text-[10px] text-gray-400 uppercase font-bold">Ay Hedef (Mod)</div>
<div id="monthly-mode-target" class="text-xl font-bold text-purple-600">-</div>
</div>
</div>
<div
class="overflow-x-auto rounded border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
<table class="w-full text-xs">
<thead
class="bg-gray-50 dark:bg-gray-700 text-gray-500 dark:text-gray-300 uppercase font-semibold">
<tr>
<th class="px-4 py-2 text-left">Personel</th>
<th
class="px-4 py-2 text-center bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">
Hafta SayÄ±</th>
<th class="px-4 py-2 text-center bg-blue-50 dark:bg-blue-900/30">Durum</th>
<th
class="px-4 py-2 text-center bg-purple-50 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300">
Ay SayÄ±</th>
<th class="px-4 py-2 text-center bg-purple-50 dark:bg-purple-900/30">Durum</th>
</tr>
</thead>
<tbody id="stats-body" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
</table>
</div>
</div>

<div class="border-t-4 border-indigo-100 pt-6 mt-8">
<h3 class="text-lg font-bold text-indigo-900 mb-4 flex items-center">
<i data-lucide="stethoscope" class="w-5 h-5 mr-2"></i> Doktor & TÄ±bbi Ä°ÅŸlem Takibi
</h3>

<div
class="scroll-container rounded-xl border border-gray-200 shadow-sm mb-6 bg-white overflow-x-auto touch-pan-x">
<table class="w-full text-sm text-left">
<thead class="text-xs text-gray-500 uppercase bg-gray-50">
<tr id="doctor-table-head">
<th class="px-4 py-3 sticky-col-1 bg-gray-50 font-semibold border-r">LÄ°STELER</th>
</tr>
</thead>
<tbody id="doctor-table-body" class="bg-white divide-y divide-gray-100"></tbody>
</table>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
<div class="bg-gray-50 px-4 py-2 border-b font-bold text-xs text-gray-500 uppercase">
DÃ¶nemsel Ä°ÅŸlem Ã–zeti</div>
<table class="w-full text-xs">
<thead class="bg-gray-50 text-gray-600">
<tr>
<th class="px-4 py-2 text-left">Ä°ÅŸlem TÃ¼rÃ¼</th>
<th class="px-4 py-2 text-center">Toplam SayÄ±</th>
</tr>
</thead>
<tbody id="procedure-stats-body" class="divide-y divide-gray-100"></tbody>
</table>
</div>
</div>
</div>
</div>

<div id="tab-uzman" class="tab-content hidden">
<div class="flex justify-between items-center mb-4">
<h2 class="text-lg font-bold text-indigo-900">Uzman Birim EÅŸleÅŸme Ã‡izelgesi (AylÄ±k)</h2>
<span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">Bulunulan Ay</span>
</div>
<div
class="scroll-container rounded-xl border border-gray-200 shadow-sm bg-white mb-8 overflow-x-auto touch-pan-x">
<table class="w-full text-sm text-left" id="specialist-table">
<thead class="text-xs text-gray-600 uppercase bg-gray-100 border-b"></thead>
<tbody id="specialist-body" class="divide-y divide-gray-100"></tbody>
</table>
</div>

<div class="flex justify-between items-center mb-4 border-t-4 border-gray-200 pt-6">
<h2 class="text-lg font-bold text-indigo-900 flex items-center">
<i data-lucide="bar-chart-2" class="w-5 h-5 mr-2"></i> HaftalÄ±k Personel - Uzman EÅŸleÅŸme Matrisi
</h2>
<span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">Bulunulan Hafta</span>
</div>
<div class="scroll-container rounded-xl border border-gray-400 shadow-sm overflow-x-auto touch-pan-x">
<table class="w-full text-sm text-left" id="weekly-spec-table">
<thead class="text-xs text-white uppercase bg-gray-800 border-b border-gray-600">
</thead>
<tbody id="weekly-spec-body">
</tbody>
</table>
</div>
</div>

<div id="tab-analiz" class="tab-content hidden">
<div class="bg-indigo-50 p-4 rounded-xl mb-6">
<h3 class="text-sm font-bold text-indigo-900 mb-3">Tarih AralÄ±ÄŸÄ± ve Filtre Analizi</h3>
<div class="flex flex-col md:flex-row items-end gap-4">
<div><label class="text-xs font-bold text-gray-500">BaÅŸlangÄ±Ã§</label><input type="date"
id="analysis-start" class="block w-full p-2 border rounded text-sm"></div>
<div><label class="text-xs font-bold text-gray-500">BitiÅŸ</label><input type="date"
id="analysis-end" class="block w-full p-2 border rounded text-sm"></div>

<div class="flex-1 min-w-[200px]">
<label class="text-xs font-bold text-gray-500">Analiz TÃ¼rÃ¼ / Filtre</label>
<select id="analysis-filter"
class="block w-full p-2 border rounded text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none">
<option value="all">TÃ¼mÃ¼ (Genel Ã–zet)</option>
<option value="leave_report" class="font-bold text-orange-600">Raporlu / Ä°zinli Listesi
</option>
<option value="shift_stats" class="font-bold text-indigo-700">NÃ¶bet Ä°statistikleri
</option>
<option value="all_specialists" class="font-bold text-purple-600">TÃ¼m UzmanlÄ±klar (Ã–zet)
</option>
<option value="daily_notes" class="font-bold text-yellow-600">ğŸ“ Takip NotlarÄ±
</option>
<option value="activity_logs" id="activity-logs-option" class="font-bold text-blue-600">
ğŸ“‹ Aktivite LoglarÄ±
</option>
<option value="km_stats" class="font-bold text-emerald-600">ğŸš— KM Ä°statistiÄŸi
</option>
<optgroup label="Doktor Verileri" id="filter-opt-doc"></optgroup>
<optgroup label="TÄ±bbi Ä°ÅŸlemler" id="filter-opt-proc"></optgroup>
<optgroup label="UzmanlÄ±klar" id="filter-opt-spec"></optgroup>
</select>
</div>

<button id="btn-run-analysis"
class="px-4 py-2 bg-indigo-600 text-white rounded text-sm font-bold shadow hover:bg-indigo-700">Analiz
Et</button>
</div>
</div>
<div id="analysis-results" class="hidden">
<div id="standard-analysis-container">
<div class="mb-6 overflow-x-auto border rounded bg-white">
<table class="w-full text-xs">
<thead class="bg-gray-100 text-gray-600 uppercase">
<tr>
<th class="px-4 py-2 text-left">Personel</th>
<th id="analysis-staff-col-header" class="px-4 py-2 text-center">Toplam SayÄ±
</th>
<th class="px-4 py-2 text-center">Durum</th>
</tr>
</thead>
<tbody id="analysis-stats-body" class="divide-y"></tbody>
</table>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
<div class="border rounded-xl overflow-hidden shadow-sm bg-white">
<div class="bg-blue-50 px-4 py-2 text-xs font-bold text-blue-900 uppercase border-b">
Doktor PerformansÄ±</div>
<table class="w-full text-xs">
<thead class="bg-gray-50 text-gray-600 uppercase">
<tr>
<th class="px-4 py-2 text-left">Doktor</th>
<th id="analysis-doc-col-header" class="px-4 py-2 text-center">SayÄ±</th>
</tr>
</thead>
<tbody id="analysis-doctor-stats-body" class="divide-y"></tbody>
</table>
</div>
<div class="border rounded-xl overflow-hidden shadow-sm bg-white">
<div class="bg-green-50 px-4 py-2 text-xs font-bold text-green-900 uppercase border-b">
Ä°ÅŸlem DaÄŸÄ±lÄ±mÄ± (Genel)</div>
<table class="w-full text-xs">
<tbody id="analysis-proc-stats-body" class="divide-y"></tbody>
</table>
</div>
</div>
<div class="scroll-container border rounded bg-white">
<table class="w-full text-xs text-left">
<thead class="bg-gray-100 uppercase border-b">
<tr id="analysis-table-head">
<th class="px-4 py-2 sticky-col-1 bg-gray-100">Personel</th>
</tr>
</thead>
<tbody id="analysis-table-body" class="divide-y"></tbody>
</table>
</div>
</div>

<div id="leave-analysis-container"
class="hidden mb-6 border rounded-xl bg-white overflow-hidden shadow-sm">
<div class="bg-orange-50 px-4 py-3 border-b font-bold text-orange-800 flex items-center">
<i data-lucide="calendar-off" class="w-5 h-5 mr-2"></i> Personel Ä°zin/Rapor Listesi
</div>
<table class="w-full text-sm text-left">
<thead class="bg-gray-100 text-gray-600 text-xs uppercase">
<tr>
<th class="px-4 py-3">Personel</th>
<th class="px-4 py-3 text-center">Durum</th>
<th class="px-4 py-3 text-center">BaÅŸlangÄ±Ã§</th>
<th class="px-4 py-3 text-center">BitiÅŸ</th>
<th class="px-4 py-3 text-center">GÃ¼n SayÄ±sÄ±</th>
</tr>
</thead>
<tbody id="leave-analysis-body" class="divide-y divide-gray-100"></tbody>
</table>
</div>

<div id="doctor-leave-analysis-container"
class="hidden mb-6 border rounded-xl bg-white overflow-hidden shadow-sm border-blue-200">
<div class="bg-blue-50 px-4 py-3 border-b font-bold text-blue-800 flex items-center">
<i data-lucide="stethoscope" class="w-5 h-5 mr-2"></i> Doktor Ä°zin/Rapor Listesi
</div>
<table class="w-full text-sm text-left">
<thead class="bg-blue-100 text-blue-700 text-xs uppercase">
<tr>
<th class="px-4 py-3">Doktor</th>
<th class="px-4 py-3 text-center">Durum</th>
<th class="px-4 py-3 text-center">BaÅŸlangÄ±Ã§</th>
<th class="px-4 py-3 text-center">BitiÅŸ</th>
<th class="px-4 py-3 text-center">GÃ¼n SayÄ±sÄ±</th>
</tr>
</thead>
<tbody id="doctor-leave-analysis-body" class="divide-y divide-gray-100"></tbody>
</table>
</div>

<div id="specialist-detail-container"
class="hidden mt-6 mb-6 border rounded-xl bg-white overflow-hidden shadow-sm border-purple-100">
<div
class="bg-purple-50 px-4 py-3 border-b border-purple-100 font-bold text-purple-900 flex items-center">
<i data-lucide="stethoscope" class="w-5 h-5 mr-2"></i> UzmanlÄ±k EÅŸleÅŸme DetaylarÄ±
</div>
<div class="overflow-x-auto">
<table class="w-full text-xs text-left">
<thead class="bg-gray-50 text-gray-600 uppercase border-b">
<tr>
<th class="px-4 py-3 border-r">Personel</th>
<th class="px-4 py-3 border-r">UzmanlÄ±k AlanÄ±</th>
<th class="px-4 py-3 border-r text-center w-20">Toplam</th>
<th class="px-4 py-3">Tarihler ve Zamanlar</th>
</tr>
</thead>
<tbody id="specialist-detail-body" class="divide-y divide-gray-100"></tbody>
</table>
</div>
</div>

</div>
</div>

<div id="tab-rutinler" class="tab-content hidden">
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
<div class="md:col-span-1 space-y-4">
<div class="bg-indigo-50 p-6 rounded-xl border border-indigo-100">
<h3 class="text-lg font-bold text-indigo-900 mb-2 flex items-center">
<i data-lucide="list-todo" class="w-5 h-5 mr-2"></i> Yeni Rutin Ekle
</h3>
<div class="space-y-3">
<input type="text" id="new-routine-text"
class="w-full p-3 border border-indigo-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
placeholder="Ã–rn: AtamalarÄ± Ã‡Ä±kar, Acil Ã‡anta KontrolÃ¼...">
<button onclick="addRoutine()"
class="w-full py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition shadow-sm flex justify-center items-center gap-2">
<i data-lucide="plus-circle" class="w-4 h-4"></i> Ekle
</button>
</div>
</div>
<div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
<div class="flex items-center justify-between mb-2">
<span class="text-xs font-bold text-gray-500 uppercase">Tamamlanma OranÄ±</span>
<span id="routine-progress-text" class="text-xs font-bold text-indigo-600">%0</span>
</div>
<div class="w-full bg-gray-100 rounded-full h-2.5">
<div id="routine-progress-bar"
class="bg-indigo-600 h-2.5 rounded-full transition-all duration-500"
style="width: 0%"></div>
</div>
</div>
<button onclick="resetRoutines()"
class="w-full py-2 bg-white border border-gray-300 text-gray-600 rounded-lg text-sm font-bold hover:bg-gray-50 transition flex justify-center items-center gap-2">
<i data-lucide="refresh-cw" class="w-4 h-4"></i> TÃ¼mÃ¼nÃ¼ SÄ±fÄ±rla (Yeni GÃ¼n)
</button>
</div>
<div class="md:col-span-2">
<div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
<div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center">
<h3 class="font-bold text-gray-800">Takip Listesi</h3>
<span id="routine-count-badge"
class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full font-bold">0
GÃ¶rev</span>
</div>
<div id="routine-list-container"
class="divide-y divide-gray-100 max-h-[500px] overflow-y-auto p-2"></div>
</div>
</div>
</div>
</div>

<div id="tab-acilcanta" class="tab-content hidden">
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">

<div class="md:col-span-1 space-y-4">

<div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
<label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Aktif Ã‡anta
SeÃ§imi</label>
<div class="flex gap-2">
<div class="relative flex-grow">
<select id="bag-selector" onchange="switchBag()"
class="w-full p-2.5 bg-red-50 border border-red-200 text-red-900 text-sm rounded-lg font-bold outline-none focus:ring-2 focus:ring-red-500 appearance-none">
</select>
<i data-lucide="chevron-down"
class="absolute right-3 top-3 w-4 h-4 text-red-400 pointer-events-none"></i>
</div>

<button onclick="addNewBag()"
class="bg-gray-100 text-gray-600 hover:bg-gray-200 hover:text-gray-800 p-2.5 rounded-lg transition border border-gray-200 flex-shrink-0"
title="Yeni Ã‡anta OluÅŸtur">
<i data-lucide="plus" class="w-5 h-5"></i>
</button>

<button onclick="renameCurrentBag()"
class="bg-blue-50 text-blue-600 hover:bg-blue-100 hover:text-blue-800 p-2.5 rounded-lg transition border border-blue-200 flex-shrink-0"
title="Ã‡anta Ä°smini DeÄŸiÅŸtir">
<i data-lucide="pencil" class="w-5 h-5"></i>
</button>

<button onclick="deleteCurrentBag()"
class="bg-white text-gray-400 hover:text-red-600 p-2.5 rounded-lg transition border border-gray-200 flex-shrink-0"
title="Åu Anki Ã‡antayÄ± Sil">
<i data-lucide="trash-2" class="w-5 h-5"></i>
</button>
</div>
</div>

<div class="bg-red-50 p-6 rounded-xl border border-red-100 shadow-sm">
<h3 class="text-lg font-bold text-red-900 mb-4 flex items-center">
<i data-lucide="briefcase-medical" class="w-5 h-5 mr-2"></i> Ã‡antaya Malzeme Ekle
</h3>
<div class="space-y-3">
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Malzeme / Ä°laÃ§ AdÄ±</label>
<input type="text" id="em-name"
class="w-full p-2.5 border border-red-200 rounded-lg text-sm focus:ring-2 focus:ring-red-500 outline-none"
placeholder="Ã–rn: Adrenalin, Eldiven...">
</div>

<div class="grid grid-cols-2 gap-2">
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Adet / Stok</label>
<input type="number" id="em-count"
class="w-full p-2.5 border border-red-200 rounded-lg text-sm outline-none"
placeholder="1">
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">UyarÄ± (GÃ¼n
Kala)</label>
<input type="number" id="em-alert-days"
class="w-full p-2.5 border border-red-200 rounded-lg text-sm outline-none"
placeholder="Vars: 30" value="30">
</div>
</div>

<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Son Kullanma
Tarihi</label>
<input type="date" id="em-date"
class="w-full p-2.5 border border-red-200 rounded-lg text-sm outline-none">
</div>

<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Not (Opsiyonel)</label>
<textarea id="em-note"
class="w-full p-2.5 border border-red-200 rounded-lg text-sm outline-none resize-none h-20"
placeholder="Ã–rn: Ampul Ã§atlak olabilir, kontrol et..."
onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();addEmergencyItem()}"></textarea>
</div>

<div class="flex gap-2">
<button id="btn-em-save" onclick="addEmergencyItem()"
class="flex-1 py-2.5 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition shadow-sm flex justify-center items-center gap-2 text-sm">
<i data-lucide="plus-circle" class="w-4 h-4"></i> <span>Listeye Ekle</span>
</button>
<button id="btn-em-cancel" onclick="cancelEmergencyEdit()"
class="hidden px-4 py-2.5 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition text-sm">
Ä°ptal
</button>
</div>
</div>
</div>

<div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
<div class="flex items-center justify-between mb-2">
<span class="text-xs font-bold text-gray-500 uppercase">Kritik Stok / MiadÄ± Dolan</span>
<span id="em-alert-count"
class="text-xs font-bold text-red-600 bg-red-50 px-2 py-1 rounded-full">0</span>
</div>
<p class="text-[10px] text-gray-400">Son kullanma tarihi geÃ§enler kÄ±rmÄ±zÄ± ile iÅŸaretlenir.
</p>
</div>
</div>

<div class="md:col-span-2">
<div
class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col h-[600px]">
<div
class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center flex-wrap gap-2">
<h3 class="font-bold text-gray-800 flex items-center gap-2"><i data-lucide="list"
class="w-4 h-4"></i> Ã‡anta Envanteri</h3>

<div class="flex gap-2 flex-wrap">
<button onclick="openCopyModal()"
class="text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200 px-3 py-1.5 rounded font-bold transition flex items-center gap-1">
<i data-lucide="copy" class="w-3 h-3"></i> Kopyala
</button>

<button onclick="exportEmergencyData()"
class="text-[10px] bg-green-50 text-green-700 hover:bg-green-100 border border-green-200 px-3 py-1.5 rounded font-bold transition flex items-center gap-1">
<i data-lucide="file-spreadsheet" class="w-3 h-3"></i> Excel (Tam Yedek)
</button>

<label
class="text-[10px] bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200 px-3 py-1.5 rounded font-bold transition flex items-center gap-1 cursor-pointer">
<i data-lucide="upload-cloud" class="w-3 h-3"></i> Yedek YÃ¼kle
<input type="file" onchange="importEmergencyData(event)" accept=".xlsx, .csv"
class="hidden">
</label>

<button onclick="downloadEmergencyPDF()"
class="text-[10px] bg-red-50 text-red-700 hover:bg-red-100 border border-red-200 px-3 py-1.5 rounded font-bold transition flex items-center gap-1">
<i data-lucide="file-text" class="w-3 h-3"></i> PDF
</button>
</div>
</div>
<div class="overflow-y-auto flex-grow custom-scrollbar p-0">
<table class="w-full text-sm text-left">
<thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b sticky top-0">
<tr>
<th class="px-4 py-3 w-10 text-center">
<input type="checkbox" id="select-all-em" onchange="toggleAllEm(this)"
class="w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer">
</th>
<th class="px-4 py-3">Malzeme</th>
<th class="px-4 py-3 text-center">SKT</th>
<th class="px-4 py-3 text-center">Adet</th>
<th class="px-4 py-3 text-right">Ä°ÅŸlem</th>
</tr>
</thead>
<tbody id="emergency-list-body" class="divide-y divide-gray-100"></tbody>
</table>
</div>
</div>
</div>
</div>
</div>

<div id="tab-butce" class="tab-content hidden h-full">
<div
class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-6 flex flex-wrap items-center gap-4 justify-between">
<div class="flex items-center gap-2">
<div class="bg-indigo-600 text-white p-2 rounded-lg"><i data-lucide="calendar-clock"
class="w-5 h-5"></i></div>
<div>
<h3 class="text-sm font-bold text-indigo-900">BÃ¼tÃ§e DÃ¶nemi</h3>
<p class="text-xs text-indigo-600">DÃ¶nem: AyÄ±n 15'i - 14'Ã¼</p>
</div>
</div>

<div class="flex items-center bg-white p-1 rounded-lg border border-indigo-200 shadow-sm">
<button onclick="changeBudgetMonth(-1)"
class="p-2 hover:bg-gray-100 rounded-lg text-indigo-600 transition">
<i data-lucide="chevron-left" class="w-5 h-5"></i>
</button>
<span id="budget-period-display"
class="px-4 text-sm font-bold text-indigo-900 min-w-[220px] text-center select-none">
YÃ¼kleniyor...
</span>
<button onclick="changeBudgetMonth(1)"
class="p-2 hover:bg-gray-100 rounded-lg text-indigo-600 transition">
<i data-lucide="chevron-right" class="w-5 h-5"></i>
</button>
</div>

<div class="flex items-center gap-2 flex-wrap">
<button onclick="downloadBudgetExcel()"
class="flex items-center gap-1 md:gap-2 px-2 md:px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-bold shadow-sm"
title="Excel Rapor">
<i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
<span class="hidden md:inline">Excel Rapor</span>
</button>

<button onclick="downloadBudgetPDF()"
class="flex items-center gap-1 md:gap-2 px-2 md:px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm font-bold shadow-sm"
title="PDF Rapor">
<i data-lucide="file-text" class="w-4 h-4"></i>
<span class="hidden md:inline">PDF Rapor</span>
</button>

<label
class="flex items-center gap-1 md:gap-2 px-2 md:px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-bold shadow-sm cursor-pointer"
title="YÃ¼kle">
<i data-lucide="upload-cloud" class="w-4 h-4"></i>
<span class="hidden md:inline">YÃ¼kle</span>
<input type="file" onchange="importData(event)" accept=".xlsx, .csv" class="hidden">
</label>

<button onclick="lockSpecialTab('butce')"
class="flex items-center gap-1 md:gap-2 px-2 md:px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-bold shadow-sm border border-red-200 ml-2"
title="Sekmeyi Kilitle">
<i data-lucide="lock" class="w-4 h-4"></i>
<span class="hidden md:inline">Kilitle</span>
</button>
</div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
<div
class="bg-white p-4 rounded-xl border border-green-200 shadow-sm flex items-center justify-between">
<div>
<p class="text-[10px] font-bold text-green-600 uppercase tracking-wider">DÃ¶nem Gelir</p>
<h3 id="budget-income" class="text-2xl font-bold text-gray-800">0 â‚º</h3>
</div>
<div class="bg-green-100 p-2 rounded-lg text-green-600"><i data-lucide="trending-up"
class="w-6 h-6"></i></div>
</div>
<div
class="bg-white p-4 rounded-xl border border-red-200 shadow-sm flex items-center justify-between">
<div>
<p class="text-[10px] font-bold text-red-600 uppercase tracking-wider">DÃ¶nem Gider</p>
<h3 id="budget-expense" class="text-2xl font-bold text-gray-800">0 â‚º</h3>
</div>
<div class="bg-red-100 p-2 rounded-lg text-red-600"><i data-lucide="trending-down"
class="w-6 h-6"></i></div>
</div>
<div
class="bg-white p-4 rounded-xl border border-blue-200 shadow-sm flex items-center justify-between">
<div>
<p class="text-[10px] font-bold text-blue-600 uppercase tracking-wider">Net Kalan</p>
<h3 id="budget-balance" class="text-2xl font-bold text-gray-800">0 â‚º</h3>
</div>
<div class="bg-blue-100 p-2 rounded-lg text-blue-600"><i data-lucide="wallet"
class="w-6 h-6"></i></div>
</div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
<div class="lg:col-span-1">
<div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm sticky top-4">
<h3 class="text-sm font-bold text-gray-800 mb-4 flex items-center border-b pb-2">
<i data-lucide="plus-circle" class="w-4 h-4 mr-2 text-indigo-600"></i> HÄ±zlÄ± Ä°ÅŸlem Ekle
</h3>
<div class="space-y-3">
<div>
<div class="grid grid-cols-2 gap-2">
<label class="cursor-pointer">
<input type="radio" name="budgetType" value="income" class="peer sr-only"
checked>
<div
class="text-center py-2 border rounded-lg bg-gray-50 peer-checked:bg-green-600 peer-checked:text-white peer-checked:border-green-600 transition text-xs font-bold text-gray-500">
GELÄ°R</div>
</label>
<label class="cursor-pointer">
<input type="radio" name="budgetType" value="expense" class="peer sr-only">
<div
class="text-center py-2 border rounded-lg bg-gray-50 peer-checked:bg-red-600 peer-checked:text-white peer-checked:border-red-600 transition text-xs font-bold text-gray-500">
GÄ°DER</div>
</label>
</div>
</div>
<input type="text" id="budget-desc"
class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-indigo-500 transition"
placeholder="AÃ§Ä±klama (Ã–rn: Ä°LKER, Ã–MER, Ã‡AY, SU...)">
<div class="relative">
<span class="absolute left-3 top-2.5 text-gray-400 text-sm">â‚º</span>
<input type="number" id="budget-amount"
class="w-full p-2.5 pl-7 border rounded-lg text-sm bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-indigo-500 transition"
placeholder="0.00">
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Not (Opsiyonel)</label>
<input type="text" id="budget-note"
class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-indigo-500 transition"
placeholder="Ã–rn: Ã‡ay AlÄ±ndÄ±, Su AlÄ±ndÄ±...">
</div>
<input type="date" id="budget-entry-date"
class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none">
<div class="flex gap-2">
<button id="btn-budget-save" onclick="addBudgetItem()"
class="flex-1 py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition shadow-sm text-sm">Ekle</button>
<button id="btn-budget-cancel" onclick="cancelBudgetEdit()"
class="hidden px-3 py-2.5 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition text-sm">Ä°ptal</button>
</div>
</div>
</div>
</div>

<div class="lg:col-span-2">
<div
class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col h-[400px]">
<div class="bg-gray-50 px-5 py-3 border-b flex justify-between items-center">
<h3 class="font-bold text-gray-700 text-xs uppercase">DÃ¶nem Hareketleri</h3>
<button onclick="clearBudget()"
class="text-[10px] text-red-500 hover:text-red-700 font-bold bg-red-50 px-2 py-1 rounded">TEMÄ°ZLE</button>
</div>
<div class="overflow-y-auto flex-grow custom-scrollbar">
<table class="w-full text-sm text-left">
<thead class="text-[10px] text-gray-400 uppercase bg-white border-b sticky top-0">
<tr>
<th class="px-4 py-2">Tarih</th>
<th class="px-4 py-2">AÃ§Ä±klama</th>
<th class="px-4 py-2 text-right">Tutar</th>
<th class="px-4 py-2 text-center w-10"></th>
</tr>
</thead>
<tbody id="budget-list-body" class="divide-y divide-gray-50"></tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<div id="tab-notlar" class="tab-content hidden h-full">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
<div class="lg:col-span-1">
<div class="bg-indigo-50 p-5 rounded-xl border border-indigo-100 sticky top-4">
<div class="flex justify-between items-start mb-4">
<h3 class="text-lg font-bold text-indigo-900 flex items-center">
<i data-lucide="sticky-note" class="w-5 h-5 mr-2"></i> Yeni Not
</h3>
<button onclick="lockSpecialTab('notlar')"
class="flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 transition text-xs font-bold border border-red-200"
title="Sekmeyi Kilitle">
<i data-lucide="lock" class="w-3 h-3"></i> Kilitle
</button>
</div>
<div class="space-y-3">
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">BaÅŸlÄ±k</label>
<input type="text" id="gen-note-title"
class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white"
placeholder="Not BaÅŸlÄ±ÄŸÄ±...">
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Ä°Ã§erik</label>
<textarea id="gen-note-content"
class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white resize-none h-32"
placeholder="Notunuzu buraya yazÄ±n..."
onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();addGeneralNote()}"></textarea>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Renk SeÃ§imi</label>
<div class="flex gap-2">
<button onclick="selectNoteColor('yellow')"
class="w-8 h-8 rounded-full bg-yellow-200 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-gray-400 note-color-btn"
data-color="yellow"></button>
<button onclick="selectNoteColor('blue')"
class="w-8 h-8 rounded-full bg-blue-200 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-gray-400 note-color-btn"
data-color="blue"></button>
<button onclick="selectNoteColor('green')"
class="w-8 h-8 rounded-full bg-green-200 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-gray-400 note-color-btn"
data-color="green"></button>
<button onclick="selectNoteColor('red')"
class="w-8 h-8 rounded-full bg-red-200 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-gray-400 note-color-btn"
data-color="red"></button>
<button onclick="selectNoteColor('purple')"
class="w-8 h-8 rounded-full bg-purple-200 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-gray-400 note-color-btn"
data-color="purple"></button>
</div>
<input type="hidden" id="selected-note-color" value="yellow">
</div>
<button id="btn-gen-note-save" onclick="addGeneralNote()"
class="w-full py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition shadow-sm flex justify-center items-center gap-2 text-sm mt-2">
<i data-lucide="plus-circle" class="w-4 h-4"></i> Notu Kaydet
</button>
<button id="btn-gen-note-cancel" onclick="cancelGeneralNoteEdit()"
class="hidden w-full py-2.5 bg-gray-500 text-white rounded-lg font-bold hover:bg-gray-600 transition shadow-sm flex justify-center items-center gap-2 text-sm">
<i data-lucide="x" class="w-4 h-4"></i> Ä°ptal
</button>
</div>
</div>
</div>

<div class="lg:col-span-2">
<div class="bg-white rounded-xl border border-gray-200 shadow-sm min-h-[500px] p-4">
<div class="flex justify-between items-center mb-4 pb-2 border-b">
<h3 class="font-bold text-gray-700 flex items-center gap-2"><i data-lucide="grid"
class="w-4 h-4"></i> NotlarÄ±m</h3>
<span id="note-count-badge"
class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full font-bold">0
Not</span>
</div>
<div id="general-notes-grid" class="space-y-2 overflow-y-auto max-h-[600px] pr-1">
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tab-drnotlar" class="tab-content hidden h-full">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
<div class="lg:col-span-1">
<div class="bg-blue-50 p-5 rounded-xl border border-blue-100 sticky top-4">
<div class="flex justify-between items-start mb-4">
<h3 class="text-lg font-bold text-blue-900 flex items-center">
<i data-lucide="stethoscope" class="w-5 h-5 mr-2"></i> Yeni Dr Notu
</h3>
<button onclick="lockSpecialTab('drnotlar')"
class="flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 transition text-xs font-bold border border-red-200"
title="Sekmeyi Kilitle">
<i data-lucide="lock" class="w-3 h-3"></i> Kilitle
</button>
</div>
<div class="space-y-3">
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">BaÅŸlÄ±k</label>
<input type="text" id="dr-note-title"
class="w-full p-2.5 border border-blue-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white"
placeholder="Not BaÅŸlÄ±ÄŸÄ±...">
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Ä°Ã§erik</label>
<textarea id="dr-note-content"
class="w-full p-2.5 border border-blue-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white resize-none h-32"
placeholder="Notunuzu buraya yazÄ±n..."
onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();addDrNote()}"></textarea>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Renk SeÃ§imi</label>
<div class="flex gap-2">
<button onclick="selectDrNoteColor('yellow')"
class="w-8 h-8 rounded-full bg-yellow-200 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-gray-400 dr-note-color-btn"
data-color="yellow"></button>
<button onclick="selectDrNoteColor('blue')"
class="w-8 h-8 rounded-full bg-blue-200 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-gray-400 dr-note-color-btn"
data-color="blue"></button>
<button onclick="selectDrNoteColor('green')"
class="w-8 h-8 rounded-full bg-green-200 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-gray-400 dr-note-color-btn"
data-color="green"></button>
<button onclick="selectDrNoteColor('red')"
class="w-8 h-8 rounded-full bg-red-200 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-gray-400 dr-note-color-btn"
data-color="red"></button>
<button onclick="selectDrNoteColor('purple')"
class="w-8 h-8 rounded-full bg-purple-200 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-gray-400 dr-note-color-btn"
data-color="purple"></button>
</div>
<input type="hidden" id="selected-dr-note-color" value="blue">
</div>
<button onclick="addDrNote()"
class="w-full py-2.5 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition shadow-sm flex justify-center items-center gap-2 text-sm mt-2">
<i data-lucide="plus-circle" class="w-4 h-4"></i> Notu Kaydet
</button>
</div>
</div>
</div>

<div class="lg:col-span-2">
<div class="bg-white rounded-xl border border-gray-200 shadow-sm min-h-[500px] p-4">
<div class="flex justify-between items-center mb-4 pb-2 border-b">
<h3 class="font-bold text-gray-700 flex items-center gap-2"><i data-lucide="grid"
class="w-4 h-4"></i> Dr NotlarÄ±m</h3>
<span id="dr-note-count-badge"
class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full font-bold">0
Not</span>
</div>
<div id="dr-notes-grid" class="space-y-2 overflow-y-auto max-h-[600px] pr-1">
</div>
</div>
</div>
</div>
</div>
<div id="tab-nobet" class="tab-content hidden h-full">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full pt-2">
<div class="lg:col-span-1 admin-only-section" id="shift-add-section">
<div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm sticky top-4">
<h3 class="text-sm font-bold text-gray-800 mb-4 flex items-center border-b pb-2">
<i data-lucide="plus-circle" class="w-4 h-4 mr-2 text-indigo-600"></i> NÃ¶bet Yaz
</h3>
<div class="space-y-3">
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Tarih</label>
<input type="date" id="shift-date"
class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none focus:ring-2 focus:ring-indigo-500">
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Personel</label>
<input type="text" id="shift-staff" list="staff-suggestions"
class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none focus:ring-2 focus:ring-indigo-500"
placeholder="Personel SeÃ§in...">
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">NÃ¶bet TÃ¼rÃ¼ / Saat</label>
<select id="shift-type"
class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none">
<option value="24 Saat">24 Saat</option>
<option value="16 Saat">16 Saat</option>
<option value="Gece">Gece</option>
<option value="GÃ¼ndÃ¼z">GÃ¼ndÃ¼z</option>
<option value="Ä°cap">Ä°cap</option>
</select>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Not (Opsiyonel)</label>
<input type="text" id="shift-note"
class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none"
placeholder="Ã–rn: Acil deÄŸiÅŸti...">
</div>
<button onclick="addShift()"
class="w-full py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition shadow-sm text-sm mt-2">
Listeye Ekle
</button>
</div>
</div>
</div>

<div class="lg:col-span-2 shift-list-wrapper" id="shift-list-wrapper">
<div
class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col min-h-[500px]">

<div class="bg-gray-50 px-4 py-3 border-b flex flex-wrap gap-2 justify-between items-center">
<div class="flex items-center gap-3">
<h3 class="font-bold text-gray-700 text-xs uppercase flex items-center gap-2">
<i data-lucide="list" class="w-4 h-4"></i> NÃ¶bet Listesi
</h3>

<div
class="flex items-center bg-white rounded-lg border border-gray-300 shadow-sm px-1 py-0.5 ml-2">
<button onclick="changeShiftMonth(-1)"
class="p-1 hover:bg-gray-100 text-indigo-600 rounded transition"><i
data-lucide="chevron-left" class="w-4 h-4"></i></button>
<span id="shift-period-display"
class="px-2 text-xs font-bold text-indigo-900 min-w-[120px] text-center select-none uppercase tracking-wide">...</span>
<button onclick="changeShiftMonth(1)"
class="p-1 hover:bg-gray-100 text-indigo-600 rounded transition"><i
data-lucide="chevron-right" class="w-4 h-4"></i></button>
</div>
</div>

<div class="flex items-center gap-2">
<button onclick="openFairnessModal()"
class="flex items-center gap-1 px-2 py-1.5 bg-purple-50 text-purple-600 hover:bg-purple-100 hover:text-purple-700 border border-purple-200 rounded text-[10px] font-bold transition mr-1">
<i data-lucide="scale" class="w-3 h-3"></i> NÃ¶bet Analizi
</button>
<button onclick="downloadShiftExcel()"
class="flex items-center gap-1 px-2 py-1.5 bg-green-50 text-green-600 hover:bg-green-100 hover:text-green-700 border border-green-200 rounded text-[10px] font-bold transition">
<i data-lucide="file-spreadsheet" class="w-3 h-3"></i> Excel
</button>
<button onclick="downloadShiftPDF()"
class="flex items-center gap-1 px-2 py-1.5 bg-red-50 text-red-600 hover:bg-red-100 hover:text-red-700 border border-red-200 rounded text-[10px] font-bold transition">
<i data-lucide="file-text" class="w-3 h-3"></i> PDF
</button>
<span id="shift-count-badge"
class="bg-indigo-100 text-indigo-700 text-[10px] px-2 py-1 rounded-full font-bold">0
KayÄ±t</span>
</div>
</div>

<div class="overflow-y-auto flex-grow custom-scrollbar">
<table class="w-full text-sm text-left">
<thead class="text-[10px] text-gray-400 uppercase bg-white border-b sticky top-0">
<tr>
<th class="px-4 py-3 border-2 border-gray-600">Tarih</th>
<th class="px-4 py-3 border-2 border-gray-600">Personel</th>
<th class="px-4 py-3 text-center border-2 border-gray-600">TÃ¼r</th>
<th class="px-4 py-3 text-right border-2 border-gray-600">Ä°ÅŸlem</th>
</tr>
</thead>
<tbody id="shift-list-body" class="divide-y divide-gray-50"></tbody>
</table>
</div>
</div>

<div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col mt-4">
<div
class="bg-gradient-to-r from-teal-50 to-cyan-50 px-3 py-3 border-b flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
<h3 class="font-bold text-teal-700 text-xs md:text-sm uppercase flex items-center gap-2">
<i data-lucide="calendar-days" class="w-4 h-4"></i> AylÄ±k Ã‡alÄ±ÅŸma Ã‡izelgesi
</h3>
<button onclick="downloadWorkScheduleExcel()"
class="flex items-center gap-1 px-2 py-1.5 bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 rounded text-[10px] md:text-xs font-bold transition">
<i data-lucide="file-spreadsheet" class="w-3 h-3"></i> Excel
</button>
</div>
<div class="overflow-x-auto custom-scrollbar" style="-webkit-overflow-scrolling: touch;">
<table class="w-full border-collapse text-xs md:text-sm" style="min-width: 500px;">
<thead class="bg-gray-100 text-gray-600 uppercase sticky top-0 z-10">
<tr>
<th class="px-2 py-2 md:px-3 md:py-3 border border-gray-200 whitespace-nowrap text-[10px] md:text-xs"
style="width: 80px;">Tarih</th>
<th class="px-2 py-2 md:px-3 md:py-3 border border-gray-200 text-[10px] md:text-xs">
Ã‡alÄ±ÅŸan Personel</th>
<th class="px-2 py-2 md:px-3 md:py-3 border border-gray-200 whitespace-nowrap text-[10px] md:text-xs"
style="width: 120px;">NÃ¶betÃ§i</th>
</tr>
</thead>
<tbody id="work-schedule-body" class="divide-y divide-gray-100"></tbody>
</table>
</div>
</div>

<div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col mt-4">
<div class="bg-gradient-to-r from-amber-50 to-orange-50 px-3 py-3 border-b">
<h3 class="font-bold text-amber-700 text-xs uppercase flex items-center gap-2">
<i data-lucide="clipboard-list" class="w-4 h-4"></i> Ay Ã–zeti (Ä°zin, Rapor, UMKE)
</h3>
</div>
<div class="p-3 max-h-[300px] overflow-y-auto custom-scrollbar" id="monthly-notes-container">
<div class="text-gray-400 text-xs text-center py-4">YÃ¼kleniyor...</div>
</div>
</div>
</div>
</div>
</div>

<div id="shift-swap-modal"
class="fixed inset-0 bg-black/60 z-[85] hidden items-center justify-center p-4 backdrop-blur-sm">
<div class="bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col modal-enter">
<div class="p-4 border-b flex justify-between items-center bg-purple-50 rounded-t-xl">
<h3 class="text-lg font-bold text-purple-800 flex items-center">
<i data-lucide="arrow-left-right" class="w-5 h-5 mr-2"></i> NÃ¶bet DeÄŸiÅŸimi
</h3>
<button onclick="closeShiftSwapModal()" class="text-gray-400 hover:text-red-500">
<i data-lucide="x" class="w-5 h-5"></i>
</button>
</div>
<div class="p-6 space-y-4">
<input type="hidden" id="shift-swap-index">

<div class="bg-gray-50 p-4 rounded-lg border">
<p class="text-xs text-gray-500 mb-1">Mevcut NÃ¶bet</p>
<p class="font-bold text-gray-800" id="shift-swap-current-info"></p>
</div>

<div class="flex items-center justify-center">
<div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
<i data-lucide="arrow-down" class="w-5 h-5 text-purple-600"></i>
</div>
</div>

<div>
<label class="block text-sm font-bold text-gray-700 mb-2">DeÄŸiÅŸim YapÄ±lacak Personel</label>
<select id="shift-swap-new-staff"
class="w-full p-3 border rounded-lg bg-gray-50 outline-none focus:ring-2 focus:ring-purple-500">
<option value="">-- Personel SeÃ§in --</option>
</select>
</div>

<div>
<label class="block text-sm font-bold text-gray-700 mb-2">DeÄŸiÅŸim Nedeni (Opsiyonel)</label>
<input type="text" id="shift-swap-reason"
class="w-full p-3 border rounded-lg bg-gray-50 outline-none focus:ring-2 focus:ring-purple-500"
placeholder="Ã–rn: Ä°zin talebi, hastalÄ±k vb.">
</div>
</div>
<div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end gap-3">
<button onclick="closeShiftSwapModal()"
class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm font-medium">
Ä°ptal
</button>
<button onclick="confirmShiftSwap()"
class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-bold flex items-center gap-1">
<i data-lucide="check" class="w-4 h-4"></i> DeÄŸiÅŸimi Onayla
</button>
</div>
</div>
</div>

</div>
<div id="tab-cihazlar" class="tab-content hidden h-full">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full pt-2">
<div class="lg:col-span-1">
<div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm sticky top-4">
<div class="flex justify-between items-center mb-4 border-b pb-2">
<h3 class="text-sm font-bold text-gray-800 flex items-center">
<i data-lucide="stethoscope" class="w-4 h-4 mr-2 text-teal-600"></i> Cihaz TanÄ±mla
</h3>
<button onclick="lockSpecialTab('cihazlar')"
class="flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 transition text-xs font-bold border border-red-200"
title="Sekmeyi Kilitle">
<i data-lucide="lock" class="w-3 h-3"></i> Kilitle
</button>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">KÃ¼nye NumarasÄ±</label>
<input type="text" id="dev-tag-no"
class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none focus:ring-2 focus:ring-teal-500"
placeholder="Ã–rn: 10452">
</div>
<div class="space-y-3">
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Cihaz AdÄ± / Marka</label>
<input type="text" id="dev-name"
class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none focus:ring-2 focus:ring-teal-500"
placeholder="Ã–rn: Tansiyon Aleti (Omron)">
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Zimmetlenecek KiÅŸi / Konum</label>
<input type="text" id="dev-holder" list="staff-suggestions"
class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none focus:ring-2 focus:ring-teal-500"
placeholder="Personel veya 'Depo' yazÄ±n">
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Sonraki Kalibrasyon/BakÄ±m
Tarihi</label>
<input type="date" id="dev-calib-date"
class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none">
<p class="text-[10px] text-gray-400 mt-1">* Tarih gelince sistem uyaracaktÄ±r.</p>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Cihaz Durumu</label>
<select id="dev-status"
class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none">
<option value="SaÄŸlam">ğŸŸ¢ SaÄŸlam / KullanÄ±mda</option>
<option value="Serviste">ğŸŸ  Serviste / Tamirde</option>
<option value="ArÄ±zalÄ±">ğŸ”´ ArÄ±zalÄ± / KullanÄ±m DÄ±ÅŸÄ±</option>
<option value="Kayboldu">âš« KayÄ±p</option>
</select>
</div>
<div class="flex gap-2 mt-2">
<button id="btn-device-save" onclick="addDevice()"
class="flex-1 py-2.5 bg-teal-600 text-white rounded-lg font-bold hover:bg-teal-700 transition shadow-sm text-sm flex justify-center items-center gap-2">
<span>Envantere Ekle</span>
</button>
<button id="btn-device-cancel" onclick="cancelDeviceEdit()"
class="hidden px-4 py-2.5 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition text-sm">
Ä°ptal
</button>
</div>
</div>
</div>
</div>

<div class="lg:col-span-2">
<div
class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col min-h-[500px]">
<div class="bg-gray-50 px-4 py-3 border-b flex justify-between items-center">
<h3 class="font-bold text-gray-700 text-xs uppercase flex items-center gap-2">
<i data-lucide="table-2" class="w-4 h-4"></i> Envanter Listesi
</h3>
<div class="flex items-center gap-2">
<button onclick="exportDeviceExcel()"
class="flex items-center gap-1 px-2 py-1.5 bg-green-50 text-green-600 hover:bg-green-100 hover:text-green-700 border border-green-200 rounded text-[10px] font-bold transition">
<i data-lucide="file-spreadsheet" class="w-3 h-3"></i> <span
class="hidden md:inline">Excel</span>
</button>
<button onclick="exportDevicePDF()"
class="flex items-center gap-1 px-2 py-1.5 bg-red-50 text-red-600 hover:bg-red-100 hover:text-red-700 border border-red-200 rounded text-[10px] font-bold transition">
<i data-lucide="file-text" class="w-3 h-3"></i> <span
class="hidden md:inline">PDF</span>
</button>
<span id="dev-count-badge"
class="bg-teal-100 text-teal-700 text-[10px] px-2 py-1 rounded-full font-bold">0
Cihaz</span>
</div>
</div>
<div class="overflow-y-auto flex-grow custom-scrollbar">
<table class="w-full text-sm text-left">
<thead class="text-[10px] text-gray-400 uppercase bg-white border-b sticky top-0">
<tr>
<th class="px-4 py-3">KÃ¼nye No</th>
<th class="px-4 py-3">Cihaz</th>
<th class="px-4 py-3">Zimmet</th>
<th class="px-4 py-3">Kalibrasyon</th>
<th class="px-4 py-3">Durum</th>
<th class="px-4 py-3 text-right">Sil</th>
</tr>
</thead>
<tbody id="dev-list-body" class="divide-y divide-gray-50"></tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<div id="tab-hastatakip" class="tab-content">
<div class="flex items-center justify-between mb-4 gap-2">
<div class="flex bg-gray-100 p-1 rounded-xl border border-gray-200 shadow-sm">
<button id="subtab-btn-islem" onclick="switchPatientSubTab('islem')"
class="relative px-2 md:px-4 py-2 text-xs md:text-sm font-bold bg-white text-indigo-700 rounded-lg mr-1 transition shadow-sm border border-indigo-200">
<i data-lucide="calendar-plus" class="w-3 h-3 md:w-4 md:h-4 inline-block mr-0.5 md:mr-1"></i>
TALEPLER
<span id="islem-badge"
class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center font-bold">0</span>
</button>
<button id="subtab-btn-doktor" onclick="switchPatientSubTab('doktor')"
class="relative px-2 md:px-4 py-2 text-xs md:text-sm font-bold bg-transparent text-gray-600 hover:bg-white hover:text-gray-800 rounded-lg mr-1 transition">
<i data-lucide="stethoscope" class="w-3 h-3 md:w-4 md:h-4 inline-block mr-0.5 md:mr-1"></i> Doktor'a
Ä°let
<span id="doktor-badge"
class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center font-bold">0</span>
</button>
<button id="subtab-btn-sekreter" onclick="switchPatientSubTab('sekreter')"
class="relative px-2 md:px-4 py-2 text-xs md:text-sm font-bold bg-transparent text-gray-600 hover:bg-white hover:text-gray-800 rounded-lg transition">
<i data-lucide="clipboard-pen" class="w-3 h-3 md:w-4 md:h-4 inline-block mr-0.5 md:mr-1"></i>
Sekretere Not
<span id="sekreter-badge"
class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center font-bold">0</span>
</button>
</div>
<div id="hasta-takip-export-buttons" class="flex flex-col md:flex-row items-end gap-1 md:gap-2 ml-auto">
<div id="export-btns-talepler" class="flex flex-col md:flex-row items-center gap-1 md:gap-2">
<button onclick="exportTaleplerExcel()"
class="flex items-center gap-1 px-2 py-1.5 md:py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-xs md:text-sm font-bold shadow-sm"
title="Excel Ä°ndir">
<i data-lucide="file-spreadsheet" class="w-3.5 h-3.5 md:w-4 md:h-4"></i>
<span class="hidden md:inline">Excel</span>
</button>
<button onclick="exportTaleplerPDF()"
class="flex items-center gap-1 px-2 py-1.5 md:py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-xs md:text-sm font-bold shadow-sm"
title="PDF Ä°ndir">
<i data-lucide="file-text" class="w-3.5 h-3.5 md:w-4 md:h-4"></i>
<span class="hidden md:inline">PDF</span>
</button>
</div>
<div id="export-btns-doktor" class="hidden flex flex-col md:flex-row items-center gap-1 md:gap-2">
<button onclick="exportDoktorExcel()"
class="flex items-center gap-1 px-2 py-1.5 md:py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-xs md:text-sm font-bold shadow-sm"
title="Excel Ä°ndir">
<i data-lucide="file-spreadsheet" class="w-3.5 h-3.5 md:w-4 md:h-4"></i>
<span class="hidden md:inline">Excel</span>
</button>
<button onclick="exportDoktorPDF()"
class="flex items-center gap-1 px-2 py-1.5 md:py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-xs md:text-sm font-bold shadow-sm"
title="PDF Ä°ndir">
<i data-lucide="file-text" class="w-3.5 h-3.5 md:w-4 md:h-4"></i>
<span class="hidden md:inline">PDF</span>
</button>
</div>
<div id="export-btns-sekreter" class="hidden flex flex-col md:flex-row items-center gap-1 md:gap-2">
<button onclick="exportSekreterExcel()"
class="flex items-center gap-1 px-2 py-1.5 md:py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-xs md:text-sm font-bold shadow-sm"
title="Excel Ä°ndir">
<i data-lucide="file-spreadsheet" class="w-3.5 h-3.5 md:w-4 md:h-4"></i>
<span class="hidden md:inline">Excel</span>
</button>
<button onclick="exportSekreterPDF()"
class="flex items-center gap-1 px-2 py-1.5 md:py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-xs md:text-sm font-bold shadow-sm"
title="PDF Ä°ndir">
<i data-lucide="file-text" class="w-3.5 h-3.5 md:w-4 md:h-4"></i>
<span class="hidden md:inline">PDF</span>
</button>
</div>
</div>
</div>

<div id="subtab-islem" class="subtab-content">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
<div class="lg:col-span-1">
<div class="bg-indigo-50 p-3 md:p-5 rounded-xl border border-indigo-100 sticky top-4">
<h3 class="text-base md:text-lg font-bold text-indigo-900 mb-3 md:mb-4 flex items-center">
<i data-lucide="calendar-plus" class="w-4 h-4 md:w-5 md:h-5 mr-2"></i> TALEPLER
</h3>
<div class="space-y-2 md:space-y-3">
<div class="grid grid-cols-2 gap-2 md:block md:space-y-3">
<div>
<label class="block text-[10px] md:text-xs font-bold text-gray-500 mb-1">Hasta AdÄ±</label>
<input type="text" id="rem-patient"
class="w-full p-2 md:p-2.5 border border-indigo-200 rounded-lg text-xs md:text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white"
placeholder="Ã–rn: AyÅŸe Teyze"
onkeypress="if(event.key==='Enter'){event.preventDefault();addPatientReminder()}">
</div>
<div>
<label class="block text-[10px] md:text-xs font-bold text-gray-500 mb-1">Ä°ÅŸlem</label>
<select id="rem-proc"
class="w-full p-2 md:p-2.5 border border-indigo-200 rounded-lg text-xs md:text-sm bg-white outline-none">
</select>
</div>
</div>
<div>
<label class="block text-[10px] md:text-xs font-bold text-gray-500 mb-1">Tarih</label>
<div class="flex items-center gap-1">
<button type="button" onclick="changeDateInput('rem-date', -1)"
class="p-1.5 md:p-2 bg-indigo-100 hover:bg-indigo-200 rounded-lg border border-indigo-200 transition"
title="Ã–nceki gÃ¼n">
<i data-lucide="chevron-left" class="w-3 h-3 md:w-4 md:h-4 text-indigo-600"></i>
</button>
<input type="date" id="rem-date"
class="flex-1 p-2 md:p-2.5 border border-indigo-200 rounded-lg text-xs md:text-sm bg-white outline-none text-center"
onchange="updateDayName('rem-date', 'rem-date-day')"
onkeypress="if(event.key==='Enter'){event.preventDefault();addPatientReminder()}">
<button type="button" onclick="changeDateInput('rem-date', 1)"
class="p-1.5 md:p-2 bg-indigo-100 hover:bg-indigo-200 rounded-lg border border-indigo-200 transition"
title="Sonraki gÃ¼n">
<i data-lucide="chevron-right" class="w-3 h-3 md:w-4 md:h-4 text-indigo-600"></i>
</button>
</div>
<span id="rem-date-day"
class="block text-center text-[10px] md:text-xs font-bold text-indigo-600 mt-1"></span>
</div>
<div>
<label class="block text-[10px] md:text-xs font-bold text-gray-500 mb-1">Not (Opsiyonel)</label>
<textarea id="rem-note"
class="w-full p-2 md:p-2.5 border border-indigo-200 rounded-lg text-xs md:text-sm bg-white resize-none h-14 md:h-20"
placeholder="Ã–rn: 18 numara silikon sonda gÃ¶tÃ¼r..."
onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();addPatientReminder()}"></textarea>
</div>
<div class="flex gap-2 mt-1 md:mt-2">
<button id="btn-rem-save" onclick="addPatientReminder()"
class="flex-1 py-2 md:py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition shadow-sm flex justify-center items-center gap-1 md:gap-2 text-xs md:text-sm">
<i data-lucide="save" class="w-3 h-3 md:w-4 md:h-4"></i> <span>Kaydet</span>
</button>
<button id="btn-rem-cancel" onclick="cancelReminderEdit()"
class="hidden px-3 md:px-4 py-2 md:py-2.5 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition text-xs md:text-sm">
Ä°ptal
</button>
</div>
</div>
</div>
</div>

<div class="lg:col-span-2">
<div class="bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col min-h-[500px]">
<div class="bg-gray-50 px-5 py-3 border-b flex justify-between items-center">
<h3 class="font-bold text-gray-700 text-xs uppercase flex items-center gap-2">
<i data-lucide="list-checks" class="w-4 h-4"></i> Ä°ÅŸlemler Listesi
</h3>
<span id="rem-count-badge"
class="bg-indigo-100 text-indigo-700 text-[10px] px-2 py-1 rounded-full font-bold">0
KayÄ±t</span>
</div>
<div class="px-4 py-2 border-b bg-gray-50">
<div class="flex gap-2 p-1 bg-gray-100 rounded-lg mb-2">
<button id="rem-tab-active" onclick="switchRemTab('active')"
class="flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-indigo-600 text-white transition">
ğŸ“‹ Aktif Ä°ÅŸlemler
</button>
<button id="rem-tab-history" onclick="switchRemTab('history')"
class="flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition">
ğŸ“ GeÃ§miÅŸ
</button>
</div>
<div class="relative">
<i data-lucide="search"
class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
<input type="text" id="rem-search-input" placeholder="Hasta veya iÅŸlem ara..."
oninput="searchPatientReminders(this.value)"
class="w-full pl-9 pr-8 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition">
</div>
</div>
<div class="overflow-y-auto flex-grow custom-scrollbar">
<table class="w-full text-sm text-left">
<thead
class="text-xs text-gray-800 uppercase bg-indigo-50 border-b-2 border-indigo-200 sticky top-0">
<tr>
<th class="px-4 py-3 border-2 border-gray-600 w-32 text-center font-extrabold">
Tarih</th>
<th class="px-4 py-3 border-2 border-gray-600 w-40 text-center font-extrabold">
Hasta Bilgisi</th>
<th class="px-4 py-3 border-2 border-gray-600 w-32 text-center font-extrabold">
Ä°ÅŸlem</th>
<th class="px-4 py-3 border-2 border-gray-600 w-64 text-center font-extrabold">
Son Durum</th>
<th class="px-4 py-3 border-2 border-gray-600 w-48 text-center font-extrabold">
YÃ¶net</th>
</tr>
</thead>
<tbody id="reminder-list-body" class="divide-y divide-gray-50"></tbody>
</table>
</div>
</div>
</div>
</div>
</div>

<div id="subtab-doktor" class="subtab-content hidden">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
<div class="lg:col-span-1">
<div class="bg-blue-50 p-3 md:p-5 rounded-xl border border-blue-100 sticky top-4">
<h3 class="text-base md:text-lg font-bold text-blue-900 mb-3 md:mb-4 flex items-center">
<i data-lucide="stethoscope" class="w-4 h-4 md:w-5 md:h-5 mr-2"></i> Doktor'a Ä°let
</h3>
<div class="space-y-2 md:space-y-3">
<div>
<label class="block text-[10px] md:text-xs font-bold text-gray-500 mb-1">Hasta AdÄ±</label>
<input type="text" id="dr-patient"
class="w-full p-2 md:p-2.5 border border-blue-200 rounded-lg text-xs md:text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white"
placeholder="Ã–rn: Mehmet Bey"
onkeypress="if(event.key==='Enter'){event.preventDefault();addDoctorRequest()}">
</div>
<div>
<label class="block text-[10px] md:text-xs font-bold text-gray-500 mb-1">Talep / Konu</label>
<textarea id="dr-request"
class="w-full p-2 md:p-2.5 border border-blue-200 rounded-lg text-xs md:text-sm bg-white resize-none h-16 md:h-24 outline-none focus:ring-2 focus:ring-blue-500"
placeholder="Ã–rn: Tansiyon kontrolÃ¼ gerekli..."
onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();addDoctorRequest()}"></textarea>
</div>
<div>
<label class="block text-[10px] md:text-xs font-bold text-gray-500 mb-1">Tarih</label>
<div class="flex items-center gap-1">
<button type="button" onclick="changeDateInput('dr-date', -1)"
class="p-1.5 md:p-2 bg-blue-100 hover:bg-blue-200 rounded-lg border border-blue-200 transition"
title="Ã–nceki gÃ¼n">
<i data-lucide="chevron-left" class="w-3 h-3 md:w-4 md:h-4 text-blue-600"></i>
</button>
<input type="date" id="dr-date"
class="flex-1 p-2 md:p-2.5 border border-blue-200 rounded-lg text-xs md:text-sm bg-white outline-none text-center"
onchange="updateDayName('dr-date', 'dr-date-day')"
onkeypress="if(event.key==='Enter'){event.preventDefault();addDoctorRequest()}">
<button type="button" onclick="changeDateInput('dr-date', 1)"
class="p-1.5 md:p-2 bg-blue-100 hover:bg-blue-200 rounded-lg border border-blue-200 transition"
title="Sonraki gÃ¼n">
<i data-lucide="chevron-right" class="w-3 h-3 md:w-4 md:h-4 text-blue-600"></i>
</button>
</div>
<span id="dr-date-day"
class="block text-center text-[10px] md:text-xs font-bold text-blue-600 mt-1"></span>
</div>
<div class="flex gap-2 mt-1 md:mt-2">
<button id="btn-dr-save" onclick="addDoctorRequest()"
class="flex-1 py-2 md:py-2.5 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition shadow-sm flex justify-center items-center gap-1 md:gap-2 text-xs md:text-sm">
<i data-lucide="send" class="w-3 h-3 md:w-4 md:h-4"></i> <span>Doktora Ä°let</span>
</button>
<button id="btn-dr-cancel" onclick="cancelDoctorRequestEdit()"
class="hidden px-3 md:px-4 py-2 md:py-2.5 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition text-xs md:text-sm">
Ä°ptal
</button>
</div>
</div>
</div>
</div>

<div class="lg:col-span-2">
<div class="bg-white rounded-xl border border-blue-200 shadow-sm flex flex-col min-h-[400px] md:min-h-[500px]">
<div class="bg-blue-50 px-3 md:px-5 py-2 md:py-3 border-b border-blue-100 flex justify-between items-center">
<h3 class="font-bold text-blue-800 text-[10px] md:text-xs uppercase flex items-center gap-1 md:gap-2">
<i data-lucide="clipboard-list" class="w-3 h-3 md:w-4 md:h-4"></i> Doktor Talepleri
</h3>
<span id="dr-count-badge"
class="bg-blue-100 text-blue-700 text-[9px] md:text-[10px] px-1.5 md:px-2 py-0.5 md:py-1 rounded-full font-bold">0
KayÄ±t</span>
</div>
<div id="doctor-requests-list" class="overflow-y-auto flex-grow custom-scrollbar p-2 md:p-3 space-y-2">
</div>
</div>
</div>
</div>
</div>

<div id="subtab-sekreter" class="subtab-content hidden">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
<div class="lg:col-span-1">
<div class="bg-green-50 p-3 md:p-5 rounded-xl border border-green-100 sticky top-4">
<h3 class="text-base md:text-lg font-bold text-green-900 mb-3 md:mb-4 flex items-center">
<i data-lucide="clipboard-pen" class="w-4 h-4 md:w-5 md:h-5 mr-2"></i> Sekretere Not
</h3>
<div class="space-y-2 md:space-y-3">
<div>
<label class="block text-[10px] md:text-xs font-bold text-gray-500 mb-1">Hasta AdÄ±</label>
<input type="text" id="sek-patient"
class="w-full p-2 md:p-2.5 border border-green-200 rounded-lg text-xs md:text-sm focus:ring-2 focus:ring-green-500 outline-none bg-white"
placeholder="Ã–rn: Fatma HanÄ±m"
onkeypress="if(event.key==='Enter'){event.preventDefault();addSecretaryNote()}">
</div>
<div>
<label class="block text-[10px] md:text-xs font-bold text-gray-500 mb-1">Not / Konu</label>
<textarea id="sek-request"
class="w-full p-2 md:p-2.5 border border-green-200 rounded-lg text-xs md:text-sm bg-white resize-none h-16 md:h-24 outline-none focus:ring-2 focus:ring-green-500"
placeholder="Ã–rn: Randevu talep ediyor..."
onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();addSecretaryNote()}"></textarea>
</div>
<div>
<label class="block text-[10px] md:text-xs font-bold text-gray-500 mb-1">Tarih</label>
<div class="flex items-center gap-1">
<button type="button" onclick="changeDateInput('sek-date', -1)"
class="p-1.5 md:p-2 bg-green-100 hover:bg-green-200 rounded-lg border border-green-200 transition"
title="Ã–nceki gÃ¼n">
<i data-lucide="chevron-left" class="w-3 h-3 md:w-4 md:h-4 text-green-600"></i>
</button>
<input type="date" id="sek-date"
class="flex-1 p-2 md:p-2.5 border border-green-200 rounded-lg text-xs md:text-sm bg-white outline-none text-center"
onchange="updateDayName('sek-date', 'sek-date-day')"
onkeypress="if(event.key==='Enter'){event.preventDefault();addSecretaryNote()}">
<button type="button" onclick="changeDateInput('sek-date', 1)"
class="p-1.5 md:p-2 bg-green-100 hover:bg-green-200 rounded-lg border border-green-200 transition"
title="Sonraki gÃ¼n">
<i data-lucide="chevron-right" class="w-3 h-3 md:w-4 md:h-4 text-green-600"></i>
</button>
</div>
<span id="sek-date-day"
class="block text-center text-[10px] md:text-xs font-bold text-green-600 mt-1"></span>
</div>
<div class="flex gap-2 mt-1 md:mt-2">
<button id="btn-sek-save" onclick="addSecretaryNote()"
class="flex-1 py-2 md:py-2.5 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition shadow-sm flex justify-center items-center gap-1 md:gap-2 text-xs md:text-sm">
<i data-lucide="send" class="w-3 h-3 md:w-4 md:h-4"></i> <span>Sekretere Ä°let</span>
</button>
<button id="btn-sek-cancel" onclick="cancelSecretaryNoteEdit()"
class="hidden px-3 md:px-4 py-2 md:py-2.5 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition text-xs md:text-sm">
Ä°ptal
</button>
</div>
</div>
</div>
</div>

<div class="lg:col-span-2">
<div class="bg-white rounded-xl border border-green-200 shadow-sm flex flex-col min-h-[400px] md:min-h-[500px]">
<div class="bg-green-50 px-3 md:px-5 py-2 md:py-3 border-b border-green-100 flex justify-between items-center">
<h3 class="font-bold text-green-800 text-[10px] md:text-xs uppercase flex items-center gap-1 md:gap-2">
<i data-lucide="clipboard-list" class="w-3 h-3 md:w-4 md:h-4"></i> Sekreter NotlarÄ±
</h3>
<span id="sek-count-badge"
class="bg-green-100 text-green-700 text-[9px] md:text-[10px] px-1.5 md:px-2 py-0.5 md:py-1 rounded-full font-bold">0
KayÄ±t</span>
</div>
<div id="secretary-notes-list" class="overflow-y-auto flex-grow custom-scrollbar p-2 md:p-3 space-y-2">
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tab-rehber" class="tab-content hidden h-full">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full pt-2">
<div class="lg:col-span-1">
<div class="bg-indigo-50 p-5 rounded-xl border border-indigo-100 sticky top-4">
<h3 class="text-lg font-bold text-indigo-900 mb-4 flex items-center">
<i data-lucide="user-plus" class="w-5 h-5 mr-2"></i> Yeni KiÅŸi Ekle
</h3>
<div class="space-y-3">
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Ad Soyad</label>
<input type="text" id="ph-name"
class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-indigo-500"
placeholder="Ã–rn: Dr. Ahmet YÄ±lmaz">
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Birim / Ãœnvan</label>
<input type="text" id="ph-role"
class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm bg-white outline-none"
placeholder="Ã–rn: BaÅŸhekimlik, NÃ¶betÃ§i...">
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Telefon NumarasÄ±</label>
<input type="tel" id="ph-num"
class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm bg-white outline-none"
placeholder="0555 123 45 67">
</div>
<div class="flex gap-2 mt-2">
<button id="btn-ph-save" onclick="addContact()"
class="flex-1 py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition shadow-sm flex justify-center items-center gap-2 text-sm">
<i data-lucide="save" class="w-4 h-4"></i> <span>Rehbere Kaydet</span>
</button>
<button id="btn-ph-cancel" onclick="cancelEditContact()"
class="hidden px-4 py-2.5 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition text-sm">
Ä°ptal
</button>
</div>
</div>
</div>
</div>

<div class="lg:col-span-2">
<div class="bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col min-h-[500px]">
<div class="bg-gray-50 px-5 py-3 border-b flex justify-between items-center sticky top-0 z-10">
<h3 class="font-bold text-gray-700 text-xs uppercase flex items-center gap-2">
<i data-lucide="book-user" class="w-4 h-4"></i> Kurum Ä°Ã§i Rehber
</h3>
<div class="relative">
<input type="text" id="ph-search" oninput="renderPhonebook()" placeholder="Rehberde Ara..."
class="pl-8 pr-2 py-1 text-xs border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none w-48">
<i data-lucide="search" class="w-3 h-3 absolute left-2.5 top-2 text-gray-400"></i>
</div>
</div>
<div class="p-4 overflow-y-auto flex-grow custom-scrollbar">
<div id="phonebook-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tab-istatistik" class="tab-content hidden">
<div class="p-6">
<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
<h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 flex items-center">
<i data-lucide="bar-chart-2" class="w-6 h-6 mr-2 text-indigo-600"></i> Performans ve Veri Analizi
</h2>
<div
class="flex items-center gap-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-xl px-3 py-2 shadow-sm">
<button onclick="changeStatsMonth(-1)"
class="p-2 hover:bg-indigo-100 dark:hover:bg-indigo-900 rounded-lg transition"
title="Ã–nceki Ay">
<i data-lucide="chevron-left" class="w-5 h-5 text-indigo-600"></i>
</button>
<div class="text-center min-w-[120px]">
<div id="stats-month-display" class="text-sm font-bold text-gray-800 dark:text-gray-100">AralÄ±k
2024</div>
<div id="stats-year-display" class="text-xs text-gray-500 dark:text-gray-400"></div>
</div>
<button onclick="changeStatsMonth(1)"
class="p-2 hover:bg-indigo-100 dark:hover:bg-indigo-900 rounded-lg transition"
title="Sonraki Ay">
<i data-lucide="chevron-right" class="w-5 h-5 text-indigo-600"></i>
</button>
<button onclick="goToCurrentMonth()"
class="ml-2 px-3 py-1.5 bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 rounded-lg text-xs font-bold hover:bg-indigo-200 dark:hover:bg-indigo-800 transition"
title="Bu Aya Git">
BugÃ¼n
</button>
</div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
<div
class="bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
<div id="stat-total-label" class="text-xs font-bold text-gray-400 uppercase">Toplam Hasta (Bu Ay)
</div>
<div id="stat-total-visit" class="text-3xl font-bold text-indigo-600 mt-2">0</div>
</div>
<div
class="bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
<div class="text-xs font-bold text-gray-400 uppercase">En YoÄŸun Personel</div>
<div id="stat-top-staff" class="text-xl font-bold text-emerald-600 mt-2">-</div>
</div>
</div>
<div
class="col-span-1 lg:col-span-2 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm mb-4 overflow-hidden opacity-80">
<div
class="bg-gray-100 dark:bg-gray-700 px-4 py-2 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center">
<h3 class="text-xs font-bold text-gray-600 dark:text-gray-300 flex items-center">
<i data-lucide="history" class="w-4 h-4 mr-2"></i> GeÃ§en HaftanÄ±n NÃ¶betÃ§ileri
</h3>
<span
class="text-[10px] text-gray-500 bg-white dark:bg-gray-800 px-2 py-1 rounded-full shadow-sm font-bold border border-gray-200">GeÃ§en
Hafta</span>
</div>
<div class="overflow-x-auto">
<table class="w-full text-xs text-left">
<tbody id="stat-prev-week-shifts-body" class="divide-y divide-gray-100 dark:divide-gray-700">
</tbody>
</table>
</div>
</div>

<div
class="col-span-1 lg:col-span-2 bg-white dark:bg-gray-800 rounded-xl border-2 border-indigo-100 dark:border-indigo-900 shadow-md mb-4 overflow-hidden">
<div
class="bg-purple-50 dark:bg-gray-700 px-4 py-3 border-b border-purple-100 dark:border-gray-600 flex justify-between items-center">
<h3 class="text-sm font-bold text-purple-900 dark:text-purple-300 flex items-center">
<i data-lucide="calendar-clock" class="w-4 h-4 mr-2"></i> HaftanÄ±n NÃ¶betÃ§ileri
</h3>
<span
class="text-[10px] text-purple-600 dark:text-purple-400 bg-white dark:bg-gray-800 px-2 py-1 rounded-full shadow-sm font-bold">Mevcut
Hafta</span>
</div>
<div class="overflow-x-auto">
<table class="w-full text-xs text-left">
<tbody id="stat-weekly-shifts-body" class="divide-y divide-gray-100 dark:divide-gray-700">
</tbody>
</table>
</div>
</div>

<div
class="col-span-1 lg:col-span-2 bg-white dark:bg-gray-800 rounded-xl border border-blue-100 dark:border-blue-900 shadow-sm mb-6 overflow-hidden">
<div
class="bg-blue-50 dark:bg-gray-700 px-4 py-2 border-b border-blue-100 dark:border-gray-600 flex justify-between items-center">
<h3 class="text-xs font-bold text-blue-900 dark:text-blue-300 flex items-center">
<i data-lucide="calendar-days" class="w-4 h-4 mr-2"></i> Gelecek HaftanÄ±n NÃ¶betÃ§ileri
</h3>
<span
class="text-[10px] text-blue-600 dark:text-blue-400 bg-white dark:bg-gray-800 px-2 py-1 rounded-full shadow-sm font-bold border border-blue-100">Gelecek
Hafta</span>
</div>
<div class="overflow-x-auto">
<table class="w-full text-xs text-left">
<tbody id="stat-next-week-shifts-body" class="divide-y divide-gray-100 dark:divide-gray-700">
</tbody>
</table>
</div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
<div
class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
<h3 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-4 text-center">Personel Performans
(Ay PuanÄ±)</h3>
<div class="relative h-64 w-full">
<canvas id="chart-staff-performance"></canvas>
</div>
</div>

<div
class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
<h3 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-4 text-center">YapÄ±lan Ä°ÅŸlem
DaÄŸÄ±lÄ±mÄ±</h3>
<div class="relative h-64 w-full flex justify-center">
<canvas id="chart-visit-types"></canvas>
</div>
</div>
</div>

<div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
<h3 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-4 text-center">Doktor BazlÄ± DetaylÄ±
Performans (Sol: Hasta SayÄ±sÄ± | SaÄŸ: Ä°ÅŸlemler)</h3>
<div class="relative h-80 w-full">
<canvas id="chart-doctor-details"></canvas>
</div>
<div id="doc-breakdown-area"
class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 border-t pt-4 dark:border-gray-700">
</div>
</div>
</div>
</div>

<div id="tab-rehber" class="tab-content hidden h-full">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full pt-2">
<div class="lg:col-span-1">
<div class="bg-indigo-50 p-5 rounded-xl border border-indigo-100 sticky top-4">
<h3 class="text-lg font-bold text-indigo-900 mb-4 flex items-center">
<i data-lucide="user-plus" class="w-5 h-5 mr-2"></i> Yeni KiÅŸi Ekle
</h3>
<div class="space-y-3">
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Ad Soyad</label>
<input type="text" id="ph-name"
class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-indigo-500"
placeholder="Ã–rn: Dr. Ahmet YÄ±lmaz">
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Birim / Ãœnvan</label>
<input type="text" id="ph-role"
class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm bg-white outline-none"
placeholder="Ã–rn: BaÅŸhekimlik, NÃ¶betÃ§i...">
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Telefon NumarasÄ±</label>
<input type="tel" id="ph-num"
class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm bg-white outline-none"
placeholder="0555 123 45 67">
</div>
<button onclick="addContact()"
class="w-full py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition shadow-sm text-sm mt-2 flex justify-center items-center gap-2">
<i data-lucide="save" class="w-4 h-4"></i> Rehbere Kaydet
</button>
</div>
</div>
</div>

<div class="lg:col-span-2">
<div class="bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col min-h-[500px]">
<div class="bg-gray-50 px-5 py-3 border-b flex justify-between items-center sticky top-0 z-10">
<h3 class="font-bold text-gray-700 text-xs uppercase flex items-center gap-2">
<i data-lucide="book-user" class="w-4 h-4"></i> Kurum Ä°Ã§i Rehber
</h3>
<div class="relative">
<input type="text" id="ph-search" oninput="renderPhonebook()" placeholder="Rehberde Ara..."
class="pl-8 pr-2 py-1 text-xs border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none w-48">
<i data-lucide="search" class="w-3 h-3 absolute left-2.5 top-2 text-gray-400"></i>
</div>
</div>
<div class="p-4 overflow-y-auto flex-grow custom-scrollbar">
<div id="phonebook-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tab-takvim" class="tab-content hidden h-full">
<div class="bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col h-full min-h-[700px]">

<div
class="p-3 md:p-4 border-b flex flex-col md:flex-row justify-between items-center gap-3 bg-gray-50 rounded-t-xl sticky top-0 z-20">
<h2 class="font-bold text-gray-800 flex items-center gap-2 text-base md:text-lg">
<i data-lucide="calendar-days" class="w-5 h-5 md:w-6 md:h-6 text-indigo-600"></i> GÃ¶rsel Takvim
</h2>

<div class="flex items-center gap-2 md:gap-4 flex-wrap justify-center">
<div class="hidden md:flex items-center gap-2 text-xs font-bold text-gray-500 mr-4">
<span class="flex items-center"><span
class="w-3 h-3 bg-blue-100 border border-blue-300 rounded-full mr-1"></span> Hasta
Ä°ÅŸlemi</span>
<span class="flex items-center"><span
class="w-3 h-3 bg-purple-100 border border-purple-300 rounded-full mr-1"></span>
NÃ¶bet</span>
</div>

<div class="flex items-center bg-white border rounded-lg shadow-sm">
<button onclick="changeCalendarMonth(-1)"
class="p-2 hover:bg-gray-100 rounded-l-lg text-indigo-600 transition"><i
data-lucide="chevron-left" class="w-4 h-4 md:w-5 md:h-5"></i></button>
<span id="calendar-month-display"
class="px-2 md:px-4 font-bold text-indigo-900 w-28 md:w-40 text-center select-none uppercase tracking-wide text-sm md:text-base">...</span>
<button onclick="changeCalendarMonth(1)"
class="p-2 hover:bg-gray-100 rounded-r-lg text-indigo-600 transition"><i
data-lucide="chevron-right" class="w-4 h-4 md:w-5 md:h-5"></i></button>
</div>

<button onclick="renderCalendar()"
class="p-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition"
title="Yenile">
<i data-lucide="refresh-cw" class="w-4 h-4"></i>
</button>
</div>
</div>

<div class="flex-grow flex flex-col p-2 md:p-4 overflow-y-auto bg-gray-100">
<div class="grid grid-cols-7 mb-2">
<div class="text-center font-bold text-gray-500 text-[10px] md:text-xs uppercase py-1 md:py-2">Pzt
</div>
<div class="text-center font-bold text-gray-500 text-[10px] md:text-xs uppercase py-1 md:py-2">Sal
</div>
<div class="text-center font-bold text-gray-500 text-[10px] md:text-xs uppercase py-1 md:py-2">Ã‡ar
</div>
<div class="text-center font-bold text-gray-500 text-[10px] md:text-xs uppercase py-1 md:py-2">Per
</div>
<div class="text-center font-bold text-gray-500 text-[10px] md:text-xs uppercase py-1 md:py-2">Cum
</div>
<div class="text-center font-bold text-red-500 text-[10px] md:text-xs uppercase py-1 md:py-2">Cmt
</div>
<div class="text-center font-bold text-red-500 text-[10px] md:text-xs uppercase py-1 md:py-2">Paz
</div>
</div>

<div id="calendar-grid" class="grid grid-cols-7 gap-1 md:gap-2 flex-grow auto-rows-fr">
</div>
</div>
</div>
</div>

<div id="tab-inrhesaplayici" class="tab-content hidden h-full">
<div class="bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col h-full min-h-[600px]">
<div
class="p-4 border-b flex justify-between items-center bg-gradient-to-r from-cyan-50 to-teal-50 rounded-t-xl sticky top-0 z-20">
<h2 class="font-bold text-gray-800 flex items-center gap-2 text-lg">
<i data-lucide="activity" class="w-6 h-6 text-cyan-600"></i> Uzman TÄ±p: AkÄ±llÄ± INR YÃ¶netim
</h2>
<div class="hidden md:block text-right text-xs text-cyan-600">
<p>Referans Tablet: <strong>5 mg</strong> (Coumadin)</p>
<p>Hedef INR AralÄ±ÄŸÄ±: <strong id="headerINRRange">2.0 - 3.0</strong></p>
</div>
</div>

<div class="p-6 flex-grow overflow-auto">
<div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded mb-6">
<div class="flex">
<i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-500 flex-shrink-0"></i>
<div class="ml-3">
<p class="text-sm text-yellow-700">
<span class="font-bold">Dikkat:</span> Bu sistem <strong>1 Tam Tableti 5 mg</strong>
olarak kabul eder. OndalÄ±klÄ± giriÅŸler (Ã¶rn: 1.5) tablet sayÄ±sÄ± olarak iÅŸlem gÃ¶rÃ¼r (1.5
tablet = 7.5mg).
</p>
</div>
</div>
</div>

<div class="grid md:grid-cols-2 gap-6">
<div class="bg-white rounded-xl p-6 border-2 border-cyan-200 shadow-sm">
<h3 class="text-lg font-semibold text-slate-700 mb-4 flex items-center">
<i data-lucide="calculator" class="w-5 h-5 mr-2 text-cyan-600"></i> AkÄ±llÄ± Hasta Veri GiriÅŸi
</h3>

<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-slate-600 mb-2">Hedef INR AralÄ±ÄŸÄ±</label>
<div class="flex gap-2">
<button type="button" id="targetRange-2-3" onclick="selectINRTargetRange('2-3')"
class="flex-1 px-4 py-3 rounded-lg border-2 border-cyan-500 bg-cyan-50 text-cyan-700 font-bold text-sm transition hover:bg-cyan-100 inr-target-btn active">
<div class="text-lg">2.00 - 3.00</div>
<div class="text-[10px] font-normal text-cyan-600">Standart (AF, DVT, PE)</div>
</button>
<button type="button" id="targetRange-2.5-3.5"
onclick="selectINRTargetRange('2.5-3.5')"
class="flex-1 px-4 py-3 rounded-lg border-2 border-slate-200 bg-slate-50 text-slate-600 font-bold text-sm transition hover:bg-slate-100 inr-target-btn">
<div class="text-lg">2.50 - 3.50</div>
<div class="text-[10px] font-normal text-slate-500">Mekanik Kapak</div>
</button>
</div>
<input type="hidden" id="uzmanTargetRange" value="2-3">
</div>

<div>
<label class="block text-sm font-medium text-slate-600 mb-1">Ã–lÃ§Ã¼len GÃ¼ncel INR
DeÄŸeri</label>
<div class="relative">
<input type="number" id="uzmanCurrentINR" placeholder="Ã–rn: 1.8"
class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50 font-bold text-lg text-slate-700 focus:ring-2 focus:ring-cyan-500 outline-none"
step="0.01">
<span class="absolute right-3 top-3.5 text-slate-400 text-sm font-bold">INR</span>
</div>
</div>

<div class="border-t border-slate-200 my-4"></div>

<div>
<label class="block text-sm font-medium text-slate-700 mb-2">
Mevcut Ä°laÃ§ KullanÄ±mÄ±
<span class="text-xs font-normal text-cyan-600 ml-2">(SayÄ±, buÃ§uk veya kelime
kullanabilirsiniz)</span>
</label>
<div class="relative">
<textarea id="uzmanDoseText" oninput="parsePrescriptionTextUzman()" rows="4"
class="w-full p-4 border border-slate-300 rounded-lg bg-slate-50 text-slate-700 placeholder-slate-400 font-medium focus:ring-2 focus:ring-cyan-500 outline-none"
placeholder="Ã–rnekler:
- 3 gÃ¼n 1.5, 4 gÃ¼n 1
- 2 gÃ¼n 2 buÃ§uk, 5 gÃ¼n yarÄ±m
- 3 gÃ¼n tam, 4 gÃ¼n 0.5"></textarea>
<div
class="absolute right-2 bottom-2 text-xs text-slate-400 bg-white px-2 py-1 rounded border">
<i data-lucide="sparkles" class="w-3 h-3 inline text-cyan-500"></i> AkÄ±llÄ±
AlgÄ±lama
</div>
</div>

<div
class="flex space-x-2 mt-2 text-[10px] text-slate-500 justify-center flex-wrap gap-y-1">
<span class="bg-slate-100 px-2 py-1 rounded border border-slate-200">Tam = 1</span>
<span class="bg-slate-100 px-2 py-1 rounded border border-slate-200">YarÄ±m =
0.5</span>
<span class="bg-slate-100 px-2 py-1 rounded border border-slate-200">BuÃ§uk =
.5</span>
<span class="bg-slate-100 px-2 py-1 rounded border border-slate-200">1.5 =
7.5mg</span>
</div>
</div>

<div id="uzmanParseStatus"
class="hidden bg-slate-100 p-3 rounded text-sm text-slate-600 mb-2 border border-slate-200">
</div>

<div class="bg-cyan-50 p-4 rounded-lg border border-cyan-200 flex justify-between items-center"
id="uzmanTotalBox">
<div>
<p class="text-xs text-cyan-700 font-bold uppercase">Hesaplanan Mevcut Doz</p>
<p class="text-[10px] text-cyan-600">(HaftalÄ±k Toplam)</p>
</div>
<div class="text-right">
<span id="uzmanTotalWeeklyMgDisplay"
class="text-3xl font-extrabold text-cyan-800">0</span>
<span class="text-sm text-cyan-700 font-medium">mg</span>
</div>
<input type="hidden" id="uzmanCurrentWeeklyDose" value="0">
</div>

<button onclick="calculateDoseUzman()"
class="w-full bg-cyan-700 hover:bg-cyan-800 text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center shadow-lg mt-4">
<i data-lucide="pill" class="w-5 h-5 mr-2"></i> ReÃ§eteyi Hesapla
</button>
</div>
</div>

<div class="bg-white rounded-xl p-6 border border-slate-300 shadow-sm" id="uzmanResultCard">
<div class="h-full flex flex-col justify-center items-center text-center text-slate-400"
id="uzmanEmptyState">
<i data-lucide="user-check" class="w-16 h-16 mb-4 opacity-30"></i>
<p class="mt-4 text-sm">SonuÃ§larÄ± gÃ¶rmek iÃ§in INR deÄŸerini ve hastanÄ±n mevcut kullanÄ±mÄ±nÄ±
yazÄ±nÄ±z.</p>
</div>

<div id="uzmanResultsContent" class="hidden space-y-4">
<div class="flex items-center justify-between border-b pb-2">
<h3 class="text-lg font-bold text-slate-700">Uzman Ã–nerisi</h3>
<span id="uzmanStatusBadge"
class="px-3 py-1 rounded-full text-xs font-bold bg-gray-200 text-gray-700">Durum</span>
</div>

<div class="grid grid-cols-2 gap-4 text-center">
<div class="p-3 bg-slate-50 rounded-lg">
<p class="text-xs text-slate-500">Mevcut HaftalÄ±k</p>
<p class="text-xl font-bold text-slate-700" id="uzmanDisplayOldDose">-</p>
</div>
<div class="p-3 bg-cyan-50 rounded-lg border border-cyan-200 shadow-sm">
<p class="text-xs text-cyan-600 font-bold">YENÄ° HaftalÄ±k Hedef</p>
<p class="text-2xl font-extrabold text-cyan-800" id="uzmanDisplayNewDose">-</p>
</div>
</div>

<div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
<h4 class="text-sm font-bold text-yellow-800 mb-2"><i data-lucide="clipboard-list"
class="w-4 h-4 inline mr-1"></i> Klinik Yorum & Aksiyon</h4>
<p id="uzmanActionText" class="text-sm text-yellow-900 leading-relaxed">...</p>
</div>

<div id="uzmanNextTestBox" class="bg-blue-50 p-4 rounded-lg border border-blue-200 hidden">
<h4 class="text-sm font-bold text-blue-800 mb-2"><i data-lucide="calendar-clock"
class="w-4 h-4 inline mr-1"></i> Sonraki Kan KontrolÃ¼ (INR)</h4>
<div class="flex items-center justify-between">
<div>
<p id="uzmanNextTestText" class="text-sm text-blue-900 font-semibold">...</p>
<p id="uzmanNextTestDate" class="text-lg font-bold text-blue-700 mt-1">...</p>
</div>
<div class="text-right">
<span id="uzmanNextTestDays"
class="text-3xl font-extrabold text-blue-800">-</span>
<span class="text-sm text-blue-600 font-medium">gÃ¼n sonra</span>
</div>
</div>
<p id="uzmanNextTestReason" class="text-xs text-blue-600 mt-2 italic"></p>
</div>

<div class="mt-4">
<h4 class="text-sm font-bold text-slate-700 mb-2 border-b border-slate-100 pb-1">
Ã–nerilen GÃ¼nlÃ¼k DaÄŸÄ±lÄ±m</h4>
<div id="uzmanPillSchedule" class="grid grid-cols-7 gap-1 text-center text-xs"></div>

<div id="uzmanScheduleSummary"
class="mt-3 bg-cyan-50 p-3 rounded-lg border border-cyan-100 text-center text-sm font-semibold text-cyan-800">
</div>

<p class="text-[10px] text-slate-400 text-center mt-2 italic">* DaÄŸÄ±lÄ±m 5mg tablet
Ã¼zerinden yapÄ±lmÄ±ÅŸtÄ±r.</p>
</div>
</div>
</div>
</div>

<div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm mt-6">
<h3 class="text-lg font-bold text-slate-700 mb-4 border-b pb-2">HassaslaÅŸtÄ±rÄ±lmÄ±ÅŸ ReÃ§ete AlgoritmasÄ±
</h3>
<div class="overflow-x-auto">
<table class="min-w-full text-sm text-left text-slate-600">
<thead class="text-xs text-slate-700 uppercase bg-slate-100">
<tr>
<th class="px-4 py-3 rounded-l-lg">INR AralÄ±ÄŸÄ±</th>
<th class="px-4 py-3">Risk Durumu</th>
<th class="px-4 py-3 rounded-r-lg">Doz DeÄŸiÅŸimi & Aksiyon</th>
</tr>
</thead>
<tbody>
<tr class="border-b">
<td class="px-4 py-2 font-bold text-red-700">0 - 1.49</td>
<td class="px-4 py-2">Kritik DÃ¼ÅŸÃ¼k</td>
<td class="px-4 py-2 text-red-700 font-bold">%20 ArtÄ±r</td>
</tr>
<tr class="border-b bg-slate-50">
<td class="px-4 py-2 font-bold text-orange-600">1.50 - 1.99</td>
<td class="px-4 py-2">DÃ¼ÅŸÃ¼k</td>
<td class="px-4 py-2 text-orange-600 font-bold">%10 ArtÄ±r</td>
</tr>
<tr class="border-b">
<td class="px-4 py-2 font-bold text-green-600">2.00 - 3.00</td>
<td class="px-4 py-2">HEDEF ARALIK</td>
<td class="px-4 py-2 text-green-700 font-bold">Doz DeÄŸiÅŸmez</td>
</tr>
<tr class="border-b bg-slate-50">
<td class="px-4 py-2 font-bold text-yellow-600">3.01 - 3.60</td>
<td class="px-4 py-2">Hafif YÃ¼ksek</td>
<td class="px-4 py-2 text-yellow-600 font-bold">%10 Azalt</td>
</tr>
<tr class="border-b">
<td class="px-4 py-2 font-bold text-orange-600">3.61 - 4.20</td>
<td class="px-4 py-2">Orta YÃ¼ksek</td>
<td class="px-4 py-2 text-orange-600 font-bold">%15 Azalt + 1 GÃ¼n Atla</td>
</tr>
<tr class="border-b bg-slate-50">
<td class="px-4 py-2 font-bold text-red-600">4.21 - 5.00</td>
<td class="px-4 py-2">Riskli YÃ¼ksek</td>
<td class="px-4 py-2 text-red-600 font-bold">%20-25 Azalt + 2 GÃ¼n Atla</td>
</tr>
<tr>
<td class="px-4 py-2 font-bold text-red-800">&gt; 5.00</td>
<td class="px-4 py-2">TOKSÄ°K</td>
<td class="px-4 py-2 text-red-800 font-bold">Ä°lacÄ± Kes / Doktora Git</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>

<div id="tab-izinrapor" class="tab-content hidden h-full">
<div class="bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col h-full min-h-[600px]">
<div
class="p-4 border-b flex justify-between items-center bg-gradient-to-r from-orange-50 to-amber-50 rounded-t-xl sticky top-0 z-20">
<h2 class="font-bold text-gray-800 flex items-center gap-2 text-lg">
<i data-lucide="calendar-off" class="w-6 h-6 text-orange-600"></i> Ä°zin / Rapor YÃ¶netimi
</h2>
<div class="flex items-center gap-2">
<button onclick="exportIzinRaporExcel()"
class="flex items-center gap-1 md:gap-2 px-2 md:px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-bold shadow-sm"
title="Excel Ä°ndir">
<i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
<span class="hidden md:inline">Excel</span>
</button>
<button onclick="exportIzinRaporPDF()"
class="flex items-center gap-1 md:gap-2 px-2 md:px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm font-bold shadow-sm"
title="PDF Ä°ndir">
<i data-lucide="file-text" class="w-4 h-4"></i>
<span class="hidden md:inline">PDF</span>
</button>
</div>
</div>

<div class="p-4 space-y-6 overflow-y-auto flex-1">
<div id="leave-add-form"
class="bg-gradient-to-br from-orange-50 to-amber-50 p-4 rounded-xl border border-orange-100 admin-only-section">
<h3 class="font-bold text-orange-800 mb-3 flex items-center gap-2">
<i data-lucide="plus-circle" class="w-5 h-5"></i> Yeni KayÄ±t Ekle
</h3>
<div class="flex flex-wrap items-end gap-3">
<div class="flex-1 min-w-[200px]">
<label class="block text-xs font-bold text-gray-600 mb-1">Personel</label>
<input type="text" id="leave-staff-input" list="staff-suggestions"
class="w-full p-2 border border-gray-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-orange-500 outline-none"
placeholder="Ä°sim yazÄ±n veya listeden seÃ§in...">
<datalist id="staff-suggestions"></datalist>
</div>
<div class="w-32">
<label class="block text-xs font-bold text-gray-600 mb-1">Durum</label>
<select id="leave-type-select"
class="w-full p-2 border border-gray-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-orange-500 outline-none">
<option value="Rapor">Raporlu</option>
<option value="Ä°zin">Ä°zinli</option>
</select>
</div>
<div class="w-36">
<label class="block text-xs font-bold text-gray-600 mb-1">BaÅŸlangÄ±Ã§</label>
<input type="date" id="leave-start-date"
class="w-full p-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 outline-none">
</div>
<div class="w-36">
<label class="block text-xs font-bold text-gray-600 mb-1">BitiÅŸ</label>
<input type="date" id="leave-end-date"
class="w-full p-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 outline-none">
</div>
<div>
<button id="add-leave-btn"
class="px-4 py-2 bg-orange-600 text-white rounded-lg font-bold hover:bg-orange-700 text-sm shadow transition flex items-center gap-2">
<i data-lucide="plus" class="w-4 h-4"></i> Ekle
</button>
</div>
</div>
</div>

<div class="bg-white border border-gray-200 rounded-xl overflow-hidden">
<div class="p-3 bg-gray-50 border-b flex items-center justify-between">
<h3 class="font-bold text-gray-700 flex items-center gap-2">
<i data-lucide="list" class="w-5 h-5 text-orange-600"></i> KayÄ±tlÄ± Ä°zin/Raporlar
</h3>
<span id="leave-count"
class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full font-bold">0
kayÄ±t</span>
</div>
<div class="overflow-x-auto max-h-[400px] overflow-y-auto">
<table class="w-full text-sm text-left">
<thead
class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs uppercase sticky top-0">
<tr>
<th class="px-4 py-3 font-semibold">Personel</th>
<th class="px-4 py-3 font-semibold">Durum</th>
<th class="px-4 py-3 font-semibold">Tarih AralÄ±ÄŸÄ±</th>
<th class="px-4 py-3 font-semibold text-center">GÃ¼n</th>
<th class="px-4 py-3 font-semibold text-right">Ä°ÅŸlem</th>
</tr>
</thead>
<tbody id="leave-records-list" class="divide-y divide-gray-100 bg-white"></tbody>
</table>
</div>
</div>

<div class="mt-6 border-t-4 border-blue-200 pt-6">
<div id="doctor-leave-add-form"
class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100 mb-4 admin-only-section">
<h3 class="font-bold text-blue-800 mb-3 flex items-center gap-2">
<i data-lucide="stethoscope" class="w-5 h-5"></i> Doktor Ä°zin/Rapor Ekle
</h3>
<div class="flex flex-wrap items-end gap-3">
<div class="flex-1 min-w-[200px]">
<label class="block text-xs font-bold text-gray-600 mb-1">Doktor</label>
<input type="text" id="doctor-leave-input" list="doctor-suggestions"
class="w-full p-2 border border-gray-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none"
placeholder="Doktor adÄ± yazÄ±n veya listeden seÃ§in...">
<datalist id="doctor-suggestions"></datalist>
</div>
<div class="w-32">
<label class="block text-xs font-bold text-gray-600 mb-1">Durum</label>
<select id="doctor-leave-type-select"
class="w-full p-2 border border-gray-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
<option value="Rapor">Raporlu</option>
<option value="Ä°zin">Ä°zinli</option>
</select>
</div>
<div class="w-36">
<label class="block text-xs font-bold text-gray-600 mb-1">BaÅŸlangÄ±Ã§</label>
<input type="date" id="doctor-leave-start-date"
class="w-full p-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
</div>
<div class="w-36">
<label class="block text-xs font-bold text-gray-600 mb-1">BitiÅŸ</label>
<input type="date" id="doctor-leave-end-date"
class="w-full p-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
</div>
<div>
<button onclick="addDoctorLeaveRecord()"
class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 text-sm shadow transition flex items-center gap-2">
<i data-lucide="plus" class="w-4 h-4"></i> Ekle
</button>
</div>
</div>
</div>

<div class="bg-white border border-blue-200 rounded-xl overflow-hidden">
<div class="p-3 bg-blue-50 border-b flex items-center justify-between">
<h3 class="font-bold text-blue-700 flex items-center gap-2">
<i data-lucide="list" class="w-5 h-5 text-blue-600"></i> Doktor Ä°zin/RaporlarÄ±
</h3>
<span id="doctor-leave-count"
class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-bold">0
kayÄ±t</span>
</div>
<div class="overflow-x-auto max-h-[400px] overflow-y-auto">
<table class="w-full text-sm text-left">
<thead
class="bg-blue-100 dark:bg-gray-700 text-blue-700 dark:text-gray-300 text-xs uppercase sticky top-0">
<tr>
<th class="px-4 py-3 font-semibold">Doktor</th>
<th class="px-4 py-3 font-semibold">Durum</th>
<th class="px-4 py-3 font-semibold">Tarih AralÄ±ÄŸÄ±</th>
<th class="px-4 py-3 font-semibold text-center">GÃ¼n</th>
<th class="px-4 py-3 font-semibold text-right">Ä°ÅŸlem</th>
</tr>
</thead>
<tbody id="doctor-leave-records-list" class="divide-y divide-gray-100 bg-white"></tbody>
</table>
</div>
</div>
</div>

<div class="mt-6 border-t-4 border-cyan-200 pt-6">
<div id="umke-add-form"
class="bg-gradient-to-br from-cyan-50 to-teal-50 p-4 rounded-xl border border-cyan-100 mb-4 admin-only-section">
<h3 class="font-bold text-cyan-800 mb-3 flex items-center gap-2">
<i data-lucide="ambulance" class="w-5 h-5"></i> UMKE GÃ¶revi Ekle
</h3>
<div class="flex flex-wrap items-end gap-3">
<div class="flex-1 min-w-[200px]">
<label class="block text-xs font-bold text-gray-600 mb-1">Personel</label>
<input type="text" id="umke-staff-input" list="staff-suggestions"
class="w-full p-2 border border-gray-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-cyan-500 outline-none"
placeholder="Ä°sim yazÄ±n veya listeden seÃ§in...">
</div>
<div class="w-36">
<label class="block text-xs font-bold text-gray-600 mb-1">BaÅŸlangÄ±Ã§</label>
<input type="date" id="umke-start-date"
class="w-full p-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 outline-none">
</div>
<div class="w-36">
<label class="block text-xs font-bold text-gray-600 mb-1">BitiÅŸ</label>
<input type="date" id="umke-end-date"
class="w-full p-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 outline-none">
</div>
<div class="flex-1 min-w-[150px]">
<label class="block text-xs font-bold text-gray-600 mb-1">GÃ¶rev Yeri (Opsiyonel)</label>
<input type="text" id="umke-location"
class="w-full p-2 border border-gray-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-cyan-500 outline-none"
placeholder="Ã–rn: Ankara, Deprem BÃ¶lgesi...">
</div>
<div>
<button onclick="addUmkeRecord()"
class="px-4 py-2 bg-cyan-600 text-white rounded-lg font-bold hover:bg-cyan-700 text-sm shadow transition flex items-center gap-2">
<i data-lucide="plus" class="w-4 h-4"></i> Ekle
</button>
</div>
</div>
</div>

<div class="bg-white border border-cyan-200 rounded-xl overflow-hidden">
<div class="p-3 bg-cyan-50 border-b flex items-center justify-between">
<h3 class="font-bold text-cyan-700 flex items-center gap-2">
<i data-lucide="list" class="w-5 h-5 text-cyan-600"></i> UMKE GÃ¶revleri
</h3>
<span id="umke-count"
class="text-xs bg-cyan-100 text-cyan-700 px-2 py-1 rounded-full font-bold">0
kayÄ±t</span>
</div>
<div class="overflow-x-auto max-h-[400px] overflow-y-auto">
<table class="w-full text-sm text-left">
<thead
class="bg-cyan-100 dark:bg-gray-700 text-cyan-700 dark:text-gray-300 text-xs uppercase sticky top-0">
<tr>
<th class="px-4 py-3 font-semibold">Personel</th>
<th class="px-4 py-3 font-semibold">Tarih AralÄ±ÄŸÄ±</th>
<th class="px-4 py-3 font-semibold text-center">GÃ¼n</th>
<th class="px-4 py-3 font-semibold">GÃ¶rev Yeri</th>
<th class="px-4 py-3 font-semibold text-right">Ä°ÅŸlem</th>
</tr>
</thead>
<tbody id="umke-records-list" class="divide-y divide-gray-100 bg-white"></tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>

<div id="tab-dogumgunu" class="tab-content hidden h-full">
<div class="bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col h-full min-h-[600px]">
<div
class="p-4 border-b flex justify-between items-center bg-gradient-to-r from-pink-50 to-purple-50 rounded-t-xl sticky top-0 z-20">
<h2 class="font-bold text-gray-800 flex items-center gap-2 text-lg">
<i data-lucide="cake" class="w-6 h-6 text-pink-600"></i> DoÄŸum GÃ¼nÃ¼ Takibi
</h2>
</div>

<div class="p-4 space-y-6 overflow-y-auto flex-1">
<div class="bg-gradient-to-br from-pink-50 to-purple-50 p-4 rounded-xl border border-pink-100">
<h3 class="font-bold text-pink-800 mb-3 flex items-center gap-2">
<i data-lucide="plus-circle" class="w-5 h-5"></i> Yeni KiÅŸi Ekle
</h3>
<div class="grid grid-cols-1 md:grid-cols-4 gap-3">
<div>
<label class="block text-xs font-semibold text-gray-600 mb-1">Ad Soyad</label>
<input type="text" id="birthday-name" placeholder="Ã–rn: Ali YÄ±lmaz"
class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none">
</div>
<div>
<label class="block text-xs font-semibold text-gray-600 mb-1">DoÄŸum Tarihi</label>
<input type="date" id="birthday-date"
class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none">
</div>
<div>
<label class="block text-xs font-semibold text-gray-600 mb-1">Not (Ä°steÄŸe BaÄŸlÄ±)</label>
<input type="text" id="birthday-note" placeholder="Ã–rn: Ã‡ikolata sever"
class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none">
</div>
<div class="flex items-end">
<button onclick="addBirthdayPerson()"
class="w-full px-4 py-2 bg-pink-600 text-white rounded-lg font-bold text-sm hover:bg-pink-700 transition flex items-center justify-center gap-2">
<i data-lucide="plus" class="w-4 h-4"></i> Ekle
</button>
</div>
</div>
</div>

<div class="bg-white border border-gray-200 rounded-xl overflow-hidden">
<div class="p-3 bg-gray-50 border-b flex items-center justify-between">
<h3 class="font-bold text-gray-700 flex items-center gap-2">
<i data-lucide="users" class="w-5 h-5 text-purple-600"></i> KayÄ±tlÄ± KiÅŸiler
</h3>
<span id="birthday-count"
class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full font-bold">0 kiÅŸi</span>
</div>
<div class="overflow-x-auto max-h-[400px] overflow-y-auto">
<table class="w-full text-sm">
<thead class="bg-gray-100 sticky top-0">
<tr>
<th class="text-left p-3 font-semibold text-gray-600">Ad Soyad</th>
<th class="text-left p-3 font-semibold text-gray-600">DoÄŸum Tarihi</th>
<th class="text-left p-3 font-semibold text-gray-600">Kalan GÃ¼n</th>
<th class="text-left p-3 font-semibold text-gray-600">Not</th>
<th class="text-center p-3 font-semibold text-gray-600">Ä°ÅŸlem</th>
</tr>
</thead>
<tbody id="birthday-list" class="divide-y divide-gray-100">
<tr>
<td colspan="5" class="p-8 text-center text-gray-400">
<i data-lucide="cake" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
<p>HenÃ¼z kayÄ±tlÄ± kiÅŸi yok</p>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>

<div id="tab-pansuman" class="tab-content hidden h-full">
<div
class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-lg flex flex-col h-full min-h-[700px]">
<div
class="p-2 md:p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between bg-gradient-to-r from-rose-50 via-pink-50 to-fuchsia-50 dark:from-gray-800 dark:via-gray-800 dark:to-gray-800 rounded-t-2xl sticky top-0 z-20">
<h2 class="font-bold text-gray-800 dark:text-white flex items-center gap-2 md:gap-3 text-sm md:text-xl">
<div
class="w-7 h-7 md:w-10 md:h-10 bg-gradient-to-br from-pink-500 to-rose-600 rounded-lg md:rounded-xl flex items-center justify-center shadow-lg">
<i data-lucide="heart-pulse" class="w-3.5 h-3.5 md:w-5 md:h-5 text-white"></i>
</div>
<span class="hidden md:inline">Pansuman Takip</span>
<span class="md:hidden">Pansuman</span>
</h2>
<div class="flex items-center gap-1 md:gap-2">
<button onclick="exportPansumanExcel()"
class="flex items-center gap-1 px-2 py-1.5 md:py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-xs md:text-sm font-bold shadow-sm"
title="Excel Ä°ndir">
<i data-lucide="file-spreadsheet" class="w-3.5 h-3.5 md:w-4 md:h-4"></i>
<span class="hidden md:inline">Excel</span>
</button>
<button onclick="exportPansumanPDF()"
class="flex items-center gap-1 px-2 py-1.5 md:py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-xs md:text-sm font-bold shadow-sm"
title="PDF Ä°ndir">
<i data-lucide="file-text" class="w-3.5 h-3.5 md:w-4 md:h-4"></i>
<span class="hidden md:inline">PDF</span>
</button>
</div>
</div>

<div class="flex flex-col lg:flex-row flex-1 overflow-hidden">
<div
class="lg:w-96 border-r border-gray-200 dark:border-gray-700 p-2 md:p-5 overflow-y-auto bg-gray-50 dark:bg-gray-900 flex-shrink-0">
<div class="bg-white dark:bg-gray-800 rounded-xl md:rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-3 md:p-5"
id="pansuman-add-form">
<h3
class="font-bold text-gray-800 dark:text-white mb-3 md:mb-4 flex items-center gap-2 text-sm md:text-base">
<div
class="w-7 h-7 md:w-8 md:h-8 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-lg flex items-center justify-center">
<i data-lucide="user-plus" class="w-3.5 h-3.5 md:w-4 md:h-4 text-white"></i>
</div>
Yeni Hasta Ekle
</h3>
<div id="pansuman-admin-lock" class="hidden p-4 md:p-6 text-center">
<div
class="w-12 h-12 md:w-16 md:h-16 mx-auto mb-3 md:mb-4 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center">
<i data-lucide="lock"
class="w-6 h-6 md:w-8 md:h-8 text-gray-400 dark:text-gray-500"></i>
</div>
<p class="text-gray-500 dark:text-gray-400 font-medium text-sm">Sadece yetkililer veri
giriÅŸi
yapabilir</p>
<p class="text-xs text-gray-400 dark:text-gray-500 mt-1 md:mt-2">GÃ¶rÃ¼ntÃ¼leme yetkisi
mevcuttur</p>
</div>
<div class="space-y-2 md:space-y-4" id="pansuman-form-fields">
<div>
<label
class="block text-xs md:text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1 md:mb-2">Hasta
Ad Soyad *</label>
<input type="text" id="pansuman-patient"
class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-lg md:rounded-xl text-sm md:text-base focus:ring-2 focus:ring-pink-500 focus:border-transparent outline-none transition"
placeholder="Ad Soyad">
</div>
<div class="grid grid-cols-2 gap-2 md:gap-3">
<div>
<label
class="block text-xs md:text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1 md:mb-2">Telefon</label>
<input type="tel" id="pansuman-phone"
class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-lg md:rounded-xl text-sm md:text-base focus:ring-2 focus:ring-pink-500 outline-none transition"
placeholder="05XX XXX XX XX">
</div>
<div>
<label
class="block text-xs md:text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1 md:mb-2">Konum
*</label>
<div class="flex gap-1 md:gap-2 h-[38px] md:h-[50px]" id="pansuman-location-btns">
<button type="button" onclick="selectPansumanLocation('merkez')"
data-value="merkez"
class="pansuman-loc-btn flex-1 flex items-center justify-center gap-1 text-xs md:text-sm cursor-pointer px-2 md:px-3 py-1.5 md:py-2 rounded-lg md:rounded-xl border-2 transition font-medium bg-blue-500 border-blue-500 text-white">
<i data-lucide="building-2" class="w-3 h-3 md:w-4 md:h-4"></i> <span
class="hidden md:inline">Merkez</span><span class="md:hidden">M</span>
</button>
<button type="button" onclick="selectPansumanLocation('koy')" data-value="koy"
class="pansuman-loc-btn flex-1 flex items-center justify-center gap-1 text-xs md:text-sm cursor-pointer px-2 md:px-3 py-1.5 md:py-2 rounded-lg md:rounded-xl border-2 transition font-medium bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<i data-lucide="trees" class="w-3 h-3 md:w-4 md:h-4"></i> <span
class="hidden md:inline">KÃ¶y</span><span class="md:hidden">K</span>
</button>
</div>
<input type="hidden" name="pansuman-location" id="pansuman-location-value"
value="merkez">
</div>
</div>
<div>
<label
class="block text-xs md:text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1 md:mb-2">Adres</label>
<input type="text" id="pansuman-address"
class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-lg md:rounded-xl text-sm md:text-base focus:ring-2 focus:ring-pink-500 outline-none transition"
placeholder="Ã–rn: Cumhuriyet Mh. No:5">
</div>
<div>
<label
class="block text-xs md:text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1 md:mb-2">Pansuman
TÃ¼rÃ¼ *</label>
<div class="flex gap-1 md:gap-2" id="pansuman-type-btns">
<button type="button" onclick="selectPansumanType('dekubit')" data-value="dekubit"
class="pansuman-type-btn flex-1 flex items-center justify-center gap-1 text-xs md:text-sm cursor-pointer px-2 md:px-3 py-2 md:py-3 rounded-lg md:rounded-xl border-2 transition font-medium bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<span class="w-2 h-2 md:w-3 md:h-3 bg-red-500 rounded-full"></span> DekÃ¼bit
</button>
<button type="button" onclick="selectPansumanType('sutur')" data-value="sutur"
class="pansuman-type-btn flex-1 flex items-center justify-center gap-1 text-xs md:text-sm cursor-pointer px-2 md:px-3 py-2 md:py-3 rounded-lg md:rounded-xl border-2 transition font-medium bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<span class="w-2 h-2 md:w-3 md:h-3 bg-blue-500 rounded-full"></span> SÃ¼tÃ¼r
</button>
<button type="button" onclick="selectPansumanType('diger')" data-value="diger"
class="pansuman-type-btn flex-1 flex items-center justify-center gap-1 text-xs md:text-sm cursor-pointer px-2 md:px-3 py-2 md:py-3 rounded-lg md:rounded-xl border-2 transition font-medium bg-gray-600 border-gray-600 text-white">
<span class="w-2 h-2 md:w-3 md:h-3 bg-gray-400 rounded-full"></span> DiÄŸer
</button>
</div>
<input type="hidden" name="pansuman-type" id="pansuman-type-value" value="diger">
</div>
<div>
<label
class="block text-xs md:text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1 md:mb-2">GÃ¼nler
*</label>
<div class="grid grid-cols-7 gap-0.5 md:gap-1" id="pansuman-days-btns">
<button type="button" onclick="togglePansumanDay(this, 'pazartesi')"
data-value="pazartesi" data-selected="false"
class="pansuman-day-btn flex flex-col items-center justify-center text-[10px] md:text-xs cursor-pointer p-1 md:p-2 rounded-lg md:rounded-xl border-2 transition bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<span class="font-bold">Pzt</span>
</button>
<button type="button" onclick="togglePansumanDay(this, 'sali')" data-value="sali"
data-selected="false"
class="pansuman-day-btn flex flex-col items-center justify-center text-[10px] md:text-xs cursor-pointer p-1 md:p-2 rounded-lg md:rounded-xl border-2 transition bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<span class="font-bold">Sal</span>
</button>
<button type="button" onclick="togglePansumanDay(this, 'carsamba')"
data-value="carsamba" data-selected="false"
class="pansuman-day-btn flex flex-col items-center justify-center text-[10px] md:text-xs cursor-pointer p-1 md:p-2 rounded-lg md:rounded-xl border-2 transition bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<span class="font-bold">Ã‡ar</span>
</button>
<button type="button" onclick="togglePansumanDay(this, 'persembe')"
data-value="persembe" data-selected="false"
class="pansuman-day-btn flex flex-col items-center justify-center text-[10px] md:text-xs cursor-pointer p-1 md:p-2 rounded-lg md:rounded-xl border-2 transition bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<span class="font-bold">Per</span>
</button>
<button type="button" onclick="togglePansumanDay(this, 'cuma')" data-value="cuma"
data-selected="false"
class="pansuman-day-btn flex flex-col items-center justify-center text-[10px] md:text-xs cursor-pointer p-1 md:p-2 rounded-lg md:rounded-xl border-2 transition bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<span class="font-bold">Cum</span>
</button>
<button type="button" onclick="togglePansumanDay(this, 'cumartesi')"
data-value="cumartesi" data-selected="false"
class="pansuman-day-btn flex flex-col items-center justify-center text-[10px] md:text-xs cursor-pointer p-1 md:p-2 rounded-lg md:rounded-xl border-2 transition bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<span class="font-bold">Cmt</span>
</button>
<button type="button" onclick="togglePansumanDay(this, 'pazar')" data-value="pazar"
data-selected="false"
class="pansuman-day-btn flex flex-col items-center justify-center text-[10px] md:text-xs cursor-pointer p-1 md:p-2 rounded-lg md:rounded-xl border-2 transition bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<span class="font-bold">Paz</span>
</button>
</div>
</div>
<div>
<label
class="block text-xs md:text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1 md:mb-2">Tekrar
SayÄ±sÄ± (Hafta)</label>
<div class="flex gap-0.5 md:gap-1 flex-wrap" id="pansuman-repeat-btns">
<button type="button" onclick="selectPansumanRepeat(0)" data-value="0"
class="pansuman-repeat-btn flex items-center justify-center text-[10px] md:text-xs cursor-pointer px-2 md:px-3 py-1.5 md:py-2 rounded-lg md:rounded-xl border-2 transition font-bold bg-purple-500 border-purple-500 text-white">
âˆ
</button>
<button type="button" onclick="selectPansumanRepeat(1)" data-value="1"
class="pansuman-repeat-btn flex items-center justify-center text-[10px] md:text-xs cursor-pointer px-2 md:px-3 py-1.5 md:py-2 rounded-lg md:rounded-xl border-2 transition font-bold bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
1
</button>
<button type="button" onclick="selectPansumanRepeat(2)" data-value="2"
class="pansuman-repeat-btn flex items-center justify-center text-[10px] md:text-xs cursor-pointer px-2 md:px-3 py-1.5 md:py-2 rounded-lg md:rounded-xl border-2 transition font-bold bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
2
</button>
<button type="button" onclick="selectPansumanRepeat(3)" data-value="3"
class="pansuman-repeat-btn flex items-center justify-center text-[10px] md:text-xs cursor-pointer px-2 md:px-3 py-1.5 md:py-2 rounded-lg md:rounded-xl border-2 transition font-bold bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
3
</button>
<button type="button" onclick="selectPansumanRepeat(4)" data-value="4"
class="pansuman-repeat-btn flex items-center justify-center text-[10px] md:text-xs cursor-pointer px-2 md:px-3 py-1.5 md:py-2 rounded-lg md:rounded-xl border-2 transition font-bold bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
4
</button>
<button type="button" onclick="selectPansumanRepeat(5)" data-value="5"
class="pansuman-repeat-btn flex items-center justify-center text-[10px] md:text-xs cursor-pointer px-2 md:px-3 py-1.5 md:py-2 rounded-lg md:rounded-xl border-2 transition font-bold bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
5
</button>
<button type="button" onclick="selectPansumanRepeat(7)" data-value="7"
class="pansuman-repeat-btn flex items-center justify-center text-[10px] md:text-xs cursor-pointer px-2 md:px-3 py-1.5 md:py-2 rounded-lg md:rounded-xl border-2 transition font-bold bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
7
</button>
<button type="button" onclick="selectPansumanRepeat(10)" data-value="10"
class="pansuman-repeat-btn flex items-center justify-center text-[10px] md:text-xs cursor-pointer px-2 md:px-3 py-1.5 md:py-2 rounded-lg md:rounded-xl border-2 transition font-bold bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
10
</button>
</div>
<input type="hidden" id="pansuman-repeat-value" value="0">
<p class="text-[10px] md:text-xs text-gray-400 dark:text-gray-500 mt-1">âˆ = SÃ¼rekli,
sayÄ±lar = KaÃ§ hafta boyunca listelenecek</p>
</div>
<div>
<label
class="block text-xs md:text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1 md:mb-2">Not</label>
<textarea id="pansuman-note" rows="2"
class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-lg md:rounded-xl text-sm md:text-base focus:ring-2 focus:ring-pink-500 outline-none transition resize-none"
placeholder="Ek bilgi..."></textarea>
</div>
<button onclick="addPansumanPatient()"
class="w-full py-2.5 md:py-3.5 bg-gradient-to-r from-pink-500 to-rose-600 text-white rounded-lg md:rounded-xl font-bold hover:from-pink-600 hover:to-rose-700 transition-all text-sm md:text-base shadow-lg shadow-pink-500/30 flex items-center justify-center gap-2">
<i data-lucide="plus-circle" class="w-4 h-4 md:w-5 md:h-5"></i> Hasta Ekle
</button>
</div>
</div>
</div>

<div class="flex-1 flex flex-col overflow-hidden bg-gray-50 dark:bg-gray-900">
<div class="flex gap-2 p-3 pb-2 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 overflow-x-auto flex-shrink-0"
id="pansuman-subtabs">
<button onclick="switchPansumanSubtab('pazartesi')" id="pansuman-subtab-pazartesi"
class="pansuman-subtab-btn px-4 py-2.5 text-sm font-semibold rounded-xl bg-pink-500 text-white border-2 border-pink-500 whitespace-nowrap transition-all shadow-sm">
Pazartesi
</button>
<button onclick="switchPansumanSubtab('sali')" id="pansuman-subtab-sali"
class="pansuman-subtab-btn px-4 py-2.5 text-sm font-semibold rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 border-2 border-transparent hover:bg-gray-300 dark:hover:bg-gray-600 whitespace-nowrap transition-all">
SalÄ±
</button>
<button onclick="switchPansumanSubtab('carsamba')" id="pansuman-subtab-carsamba"
class="pansuman-subtab-btn px-4 py-2.5 text-sm font-semibold rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 border-2 border-transparent hover:bg-gray-300 dark:hover:bg-gray-600 whitespace-nowrap transition-all">
Ã‡arÅŸamba
</button>
<button onclick="switchPansumanSubtab('persembe')" id="pansuman-subtab-persembe"
class="pansuman-subtab-btn px-4 py-2.5 text-sm font-semibold rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 border-2 border-transparent hover:bg-gray-300 dark:hover:bg-gray-600 whitespace-nowrap transition-all">
PerÅŸembe
</button>
<button onclick="switchPansumanSubtab('cuma')" id="pansuman-subtab-cuma"
class="pansuman-subtab-btn px-4 py-2.5 text-sm font-semibold rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 border-2 border-transparent hover:bg-gray-300 dark:hover:bg-gray-600 whitespace-nowrap transition-all">
Cuma
</button>
<button onclick="switchPansumanSubtab('cumartesi')" id="pansuman-subtab-cumartesi"
class="pansuman-subtab-btn px-4 py-2.5 text-sm font-semibold rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 border-2 border-transparent hover:bg-gray-300 dark:hover:bg-gray-600 whitespace-nowrap transition-all">
Cumartesi
</button>
<button onclick="switchPansumanSubtab('pazar')" id="pansuman-subtab-pazar"
class="pansuman-subtab-btn px-4 py-2.5 text-sm font-semibold rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 border-2 border-transparent hover:bg-gray-300 dark:hover:bg-gray-600 whitespace-nowrap transition-all">
Pazar
</button>
<div class="w-px bg-gray-300 dark:bg-gray-600 mx-1"></div>
<button onclick="switchPansumanSubtab('yatisli')" id="pansuman-subtab-yatisli"
class="pansuman-subtab-btn px-4 py-2.5 text-sm font-semibold rounded-xl bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 border-2 border-transparent hover:bg-blue-200 dark:hover:bg-blue-900 whitespace-nowrap transition-all flex items-center gap-2">
<i data-lucide="bed" class="w-4 h-4"></i> YATIÅLI
</button>
<button onclick="switchPansumanSubtab('biten')" id="pansuman-subtab-biten"
class="pansuman-subtab-btn px-4 py-2.5 text-sm font-semibold rounded-xl bg-emerald-100 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-300 border-2 border-transparent hover:bg-emerald-200 dark:hover:bg-emerald-900 whitespace-nowrap transition-all flex items-center gap-2">
<i data-lucide="check-circle-2" class="w-4 h-4"></i> BÄ°TEN
</button>
<button onclick="switchPansumanSubtab('silindi')" id="pansuman-subtab-silindi"
class="pansuman-subtab-btn px-4 py-2.5 text-sm font-semibold rounded-xl bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 border-2 border-transparent hover:bg-red-200 dark:hover:bg-red-900 whitespace-nowrap transition-all flex items-center gap-2">
<i data-lucide="trash-2" class="w-4 h-4"></i> SÄ°LÄ°NDÄ°
</button>
<button onclick="switchPansumanSubtab('listeOlustur')" id="pansuman-subtab-listeOlustur"
class="pansuman-subtab-btn px-4 py-2.5 text-sm font-semibold rounded-xl bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 border-2 border-transparent hover:bg-indigo-200 dark:hover:bg-indigo-900 whitespace-nowrap transition-all flex items-center gap-2">
<i data-lucide="layout-list" class="w-4 h-4"></i> Liste OluÅŸtur
</button>
</div>

<div class="px-3 py-2 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
<div class="relative max-w-md">
<i data-lucide="search"
class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
<input type="text" id="pansuman-search-input" placeholder="Hasta, adres veya telefon ara..."
class="w-full pl-10 pr-10 py-2.5 text-sm border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl focus:ring-2 focus:ring-pink-500 outline-none transition">
<button onclick="clearPansumanSearch()" id="pansuman-search-clear"
class="hidden absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 p-1 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg transition">
<i data-lucide="x" class="w-4 h-4"></i>
</button>
</div>
</div>

<div class="flex-1 overflow-y-auto p-4" id="pansuman-content-area">
</div>
</div>
</div>
</div>
</div>

<div id="tab-sondainr" class="tab-content hidden h-full">
<div class="flex flex-col lg:flex-row h-full bg-gray-50 dark:bg-gray-900">
<div
class="lg:w-96 border-r border-gray-200 dark:border-gray-700 p-2 md:p-5 overflow-y-auto bg-gray-50 dark:bg-gray-900 flex-shrink-0">
<div class="bg-white dark:bg-gray-800 rounded-xl md:rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-3 md:p-5"
id="sondainr-add-form">
<h3
class="font-bold text-gray-800 dark:text-white mb-3 md:mb-4 flex items-center gap-2 text-sm md:text-base">
<div
class="w-7 h-7 md:w-8 md:h-8 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-lg flex items-center justify-center">
<i data-lucide="plus-circle" class="w-3.5 h-3.5 md:w-4 md:h-4 text-white"></i>
</div>
<span id="sondainr-form-title">Yeni KayÄ±t Ekle</span>
</h3>
<div id="sondainr-admin-lock" class="hidden p-4 md:p-6 text-center">
<div
class="w-12 h-12 md:w-16 md:h-16 mx-auto mb-3 md:mb-4 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center">
<i data-lucide="lock" class="w-6 h-6 md:w-8 md:h-8 text-gray-400 dark:text-gray-500"></i>
</div>
<p class="text-gray-500 dark:text-gray-400 font-medium text-sm">Sadece yetkililer veri giriÅŸi
yapabilir
</p>
</div>
<div class="space-y-2 md:space-y-4" id="sondainr-form-fields">
<div>
<label
class="block text-xs md:text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1 md:mb-2">Hasta
Ad
Soyad *</label>
<input type="text" id="sondainr-patient"
class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-lg md:rounded-xl text-sm md:text-base focus:ring-2 focus:ring-cyan-500 outline-none transition"
placeholder="Hasta adÄ±">
</div>
<div>
<label
class="block text-xs md:text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1 md:mb-2">Mahalle
*</label>
<input type="text" id="sondainr-mahalle"
class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-lg md:rounded-xl text-sm md:text-base focus:ring-2 focus:ring-cyan-500 outline-none transition"
placeholder="Mahalle adÄ±">
</div>
<div id="sondainr-date-fields">
<label
class="block text-xs md:text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1 md:mb-2"
id="sondainr-date-label">DeÄŸiÅŸtirilme/TakÄ±lma Tarihi *</label>
<input type="date" id="sondainr-date"
class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-lg md:rounded-xl text-sm md:text-base focus:ring-2 focus:ring-cyan-500 outline-none transition">
</div>
<div id="sondainr-catheter-type-section">
<label
class="block text-xs md:text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1 md:mb-2">Sonda
TÃ¼rÃ¼
*</label>
<div class="flex gap-1 md:gap-2" id="sondainr-catheter-btns">
<button type="button" onclick="selectSondaCatheterType('lateks')" data-value="lateks"
class="sondainr-catheter-btn flex-1 flex items-center justify-center gap-1 text-xs md:text-sm cursor-pointer px-2 md:px-3 py-2 md:py-3 rounded-lg md:rounded-xl border-2 transition font-medium bg-orange-500 border-orange-500 text-white">
Lateks (1 ay)
</button>
<button type="button" onclick="selectSondaCatheterType('silikon')" data-value="silikon"
class="sondainr-catheter-btn flex-1 flex items-center justify-center gap-1 text-xs md:text-sm cursor-pointer px-2 md:px-3 py-2 md:py-3 rounded-lg md:rounded-xl border-2 transition font-medium bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
Silikon (2 ay)
</button>
</div>
<input type="hidden" id="sondainr-catheter-value" value="lateks">
</div>
<div>
<label
class="block text-xs md:text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1 md:mb-2">Sonraki
Tarih *</label>
<input type="date" id="sondainr-next-date"
class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-lg md:rounded-xl text-sm md:text-base focus:ring-2 focus:ring-cyan-500 outline-none transition">
</div>
<div>
<label
class="block text-xs md:text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1 md:mb-2">Not</label>
<textarea id="sondainr-note" rows="2"
class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-lg md:rounded-xl text-sm md:text-base focus:ring-2 focus:ring-cyan-500 outline-none transition resize-none"
placeholder="Ek bilgi (opsiyonel)..."></textarea>
</div>
<div class="flex gap-2">
<button onclick="addSondaInrPatient()" id="sondainr-add-btn"
class="flex-1 py-2.5 md:py-3.5 bg-gradient-to-r from-cyan-500 to-blue-600 text-white rounded-lg md:rounded-xl font-bold hover:from-cyan-600 hover:to-blue-700 transition-all text-sm md:text-base shadow-lg flex items-center justify-center gap-2">
<i data-lucide="plus-circle" class="w-4 h-4 md:w-5 md:h-5"></i> KayÄ±t Ekle
</button>
<button onclick="cancelSondaInrEdit()" id="sondainr-cancel-btn"
class="hidden py-2.5 md:py-3.5 px-3 md:px-4 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg md:rounded-xl font-bold hover:bg-gray-300 dark:hover:bg-gray-500 transition-all text-sm md:text-base flex items-center justify-center gap-2">
<i data-lucide="x" class="w-4 h-4 md:w-5 md:h-5"></i> Ä°ptal
</button>
</div>
</div>
</div>
</div>

<div class="flex-1 flex flex-col overflow-hidden">
<div class="flex flex-col bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
<div class="flex items-center gap-2 p-4 pb-2 md:pb-4 overflow-x-auto">
<button onclick="switchSondaInrSubtab('erkekSonda')" id="sondainr-subtab-erkekSonda"
class="sondainr-subtab-btn px-4 py-2.5 text-sm font-semibold rounded-xl bg-cyan-500 text-white border-2 border-cyan-500 whitespace-nowrap transition-all flex items-center gap-2">
<i data-lucide="user" class="w-4 h-4"></i> Erkek Sonda
</button>
<button onclick="switchSondaInrSubtab('kadinSonda')" id="sondainr-subtab-kadinSonda"
class="sondainr-subtab-btn px-4 py-2.5 text-sm font-semibold rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 border-2 border-transparent hover:bg-gray-300 dark:hover:bg-gray-600 whitespace-nowrap transition-all flex items-center gap-2">
<i data-lucide="user" class="w-4 h-4"></i> KadÄ±n Sonda
</button>
<button onclick="switchSondaInrSubtab('inr')" id="sondainr-subtab-inr"
class="sondainr-subtab-btn px-4 py-2.5 text-sm font-semibold rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 border-2 border-transparent hover:bg-gray-300 dark:hover:bg-gray-600 whitespace-nowrap transition-all flex items-center gap-2">
<i data-lucide="droplet" class="w-4 h-4"></i> Ä°NR
</button>
<button onclick="switchSondaInrSubtab('ng')" id="sondainr-subtab-ng"
class="sondainr-subtab-btn px-4 py-2.5 text-sm font-semibold rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 border-2 border-transparent hover:bg-gray-300 dark:hover:bg-gray-600 whitespace-nowrap transition-all flex items-center gap-2">
<i data-lucide="tube" class="w-4 h-4"></i> NG
</button>
<div class="hidden md:block flex-1"></div>
<div class="relative hidden md:block">
<input type="text" id="sondainr-search-input-desktop"
class="sondainr-search-input w-48 pl-9 pr-8 py-2 text-sm border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl focus:ring-2 focus:ring-cyan-500 outline-none transition"
placeholder="Hasta ara..." oninput="handleSondaInrSearch(this.value)">
<i data-lucide="search"
class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
<button onclick="clearSondaInrSearch()"
class="sondainr-search-clear hidden absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
<i data-lucide="x" class="w-4 h-4"></i>
</button>
</div>
<button onclick="switchSondaInrSubtab('gecmis')" id="sondainr-subtab-gecmis"
class="sondainr-subtab-btn px-4 py-2.5 text-sm font-semibold rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 border-2 border-transparent hover:bg-gray-300 dark:hover:bg-gray-600 whitespace-nowrap transition-all flex items-center gap-2">
<i data-lucide="history" class="w-4 h-4"></i> GeÃ§miÅŸ
</button>
<div class="flex items-center gap-1 ml-2">
<button onclick="exportSondaInrExcel()"
class="flex items-center gap-1 px-2 md:px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-bold shadow-sm"
title="Excel Ä°ndir">
<i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
<span class="hidden md:inline">Excel</span>
</button>
<button onclick="exportSondaInrPDF()"
class="flex items-center gap-1 px-2 md:px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm font-bold shadow-sm"
title="PDF Ä°ndir">
<i data-lucide="file-text" class="w-4 h-4"></i>
<span class="hidden md:inline">PDF</span>
</button>
</div>
</div>
<div class="md:hidden px-4 pb-3">
<div class="relative">
<input type="text" id="sondainr-search-input"
class="sondainr-search-input w-full pl-9 pr-8 py-2.5 text-sm border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl focus:ring-2 focus:ring-cyan-500 outline-none transition"
placeholder="Hasta ara..." oninput="handleSondaInrSearch(this.value)">
<i data-lucide="search"
class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
<button onclick="clearSondaInrSearch()" id="sondainr-search-clear"
class="sondainr-search-clear hidden absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
<i data-lucide="x" class="w-4 h-4"></i>
</button>
</div>
</div>
</div>

<div class="flex-1 overflow-y-auto p-4" id="sondainr-content-area">
</div>
</div>
</div>
</div>

<div id="pansuman-edit-modal"
class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
<div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
<div
class="p-5 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between bg-gradient-to-r from-pink-50 to-rose-50 dark:from-gray-800 dark:to-gray-800 rounded-t-2xl sticky top-0">
<h3 class="font-bold text-gray-800 dark:text-white text-lg flex items-center gap-2">
<i data-lucide="edit-3" class="w-5 h-5 text-pink-500"></i>
<span id="pansuman-modal-title">Hasta DÃ¼zenle</span>
</h3>
<button onclick="closePansumanModal()"
class="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-xl transition">
<i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
</button>
</div>
<div class="p-5 space-y-4">
<input type="hidden" id="pansuman-edit-id">
<div>
<label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">Hasta Ad
Soyad</label>
<input type="text" id="pansuman-edit-patient"
class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl text-base focus:ring-2 focus:ring-pink-500 outline-none">
</div>
<div class="grid grid-cols-2 gap-3">
<div>
<label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">Telefon</label>
<input type="tel" id="pansuman-edit-phone"
class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl text-base focus:ring-2 focus:ring-pink-500 outline-none">
</div>
<div>
<label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">Konum</label>
<div class="flex gap-2 h-[50px]" id="pansuman-edit-location-btns">
<button type="button" onclick="selectPansumanEditLocation('merkez')" data-value="merkez"
class="pansuman-edit-loc-btn flex-1 flex items-center justify-center gap-1 text-sm cursor-pointer px-2 py-2 rounded-xl border-2 transition font-medium bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
Merkez
</button>
<button type="button" onclick="selectPansumanEditLocation('koy')" data-value="koy"
class="pansuman-edit-loc-btn flex-1 flex items-center justify-center gap-1 text-sm cursor-pointer px-2 py-2 rounded-xl border-2 transition font-medium bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
KÃ¶y
</button>
</div>
<input type="hidden" name="pansuman-edit-location" id="pansuman-edit-location-value"
value="merkez">
</div>
</div>
<div>
<label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">Adres</label>
<input type="text" id="pansuman-edit-address"
class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl text-base focus:ring-2 focus:ring-pink-500 outline-none">
</div>
<div>
<label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">Pansuman
TÃ¼rÃ¼</label>
<div class="flex gap-2" id="pansuman-edit-type-btns">
<button type="button" onclick="selectPansumanEditType('dekubit')" data-value="dekubit"
class="pansuman-edit-type-btn flex-1 flex items-center justify-center gap-2 text-sm cursor-pointer px-3 py-3 rounded-xl border-2 transition font-medium bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<span class="w-3 h-3 bg-red-500 rounded-full"></span> DekÃ¼bit
</button>
<button type="button" onclick="selectPansumanEditType('sutur')" data-value="sutur"
class="pansuman-edit-type-btn flex-1 flex items-center justify-center gap-2 text-sm cursor-pointer px-3 py-3 rounded-xl border-2 transition font-medium bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<span class="w-3 h-3 bg-blue-500 rounded-full"></span> SÃ¼tÃ¼r
</button>
<button type="button" onclick="selectPansumanEditType('diger')" data-value="diger"
class="pansuman-edit-type-btn flex-1 flex items-center justify-center gap-2 text-sm cursor-pointer px-3 py-3 rounded-xl border-2 transition font-medium bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<span class="w-3 h-3 bg-gray-400 rounded-full"></span> DiÄŸer
</button>
</div>
<input type="hidden" name="pansuman-edit-type" id="pansuman-edit-type-value" value="diger">
</div>
<div>
<label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">GÃ¼nler</label>
<div class="grid grid-cols-7 gap-1" id="pansuman-edit-days-btns">
<button type="button" onclick="togglePansumanEditDay(this, 'pazartesi')" data-value="pazartesi"
data-selected="false"
class="pansuman-edit-day-btn flex flex-col items-center justify-center text-xs cursor-pointer p-2 rounded-xl border-2 transition bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<span class="font-bold">Pzt</span>
</button>
<button type="button" onclick="togglePansumanEditDay(this, 'sali')" data-value="sali"
data-selected="false"
class="pansuman-edit-day-btn flex flex-col items-center justify-center text-xs cursor-pointer p-2 rounded-xl border-2 transition bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<span class="font-bold">Sal</span>
</button>
<button type="button" onclick="togglePansumanEditDay(this, 'carsamba')" data-value="carsamba"
data-selected="false"
class="pansuman-edit-day-btn flex flex-col items-center justify-center text-xs cursor-pointer p-2 rounded-xl border-2 transition bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<span class="font-bold">Ã‡ar</span>
</button>
<button type="button" onclick="togglePansumanEditDay(this, 'persembe')" data-value="persembe"
data-selected="false"
class="pansuman-edit-day-btn flex flex-col items-center justify-center text-xs cursor-pointer p-2 rounded-xl border-2 transition bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<span class="font-bold">Per</span>
</button>
<button type="button" onclick="togglePansumanEditDay(this, 'cuma')" data-value="cuma"
data-selected="false"
class="pansuman-edit-day-btn flex flex-col items-center justify-center text-xs cursor-pointer p-2 rounded-xl border-2 transition bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<span class="font-bold">Cum</span>
</button>
<button type="button" onclick="togglePansumanEditDay(this, 'cumartesi')" data-value="cumartesi"
data-selected="false"
class="pansuman-edit-day-btn flex flex-col items-center justify-center text-xs cursor-pointer p-2 rounded-xl border-2 transition bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<span class="font-bold">Cmt</span>
</button>
<button type="button" onclick="togglePansumanEditDay(this, 'pazar')" data-value="pazar"
data-selected="false"
class="pansuman-edit-day-btn flex flex-col items-center justify-center text-xs cursor-pointer p-2 rounded-xl border-2 transition bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
<span class="font-bold">Paz</span>
</button>
</div>
</div>
<div>
<label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">Kalan
Tekrar</label>
<input type="number" id="pansuman-edit-repeat" min="0" max="99"
class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl text-base focus:ring-2 focus:ring-pink-500 outline-none"
placeholder="0 = SÃ¼rekli">
</div>
<div>
<label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">Not</label>
<textarea id="pansuman-edit-note" rows="2"
class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl text-base focus:ring-2 focus:ring-pink-500 outline-none resize-none"></textarea>
</div>
</div>
<div
class="p-5 border-t border-gray-200 dark:border-gray-700 flex gap-3 sticky bottom-0 bg-white dark:bg-gray-800">
<button onclick="closePansumanModal()"
class="flex-1 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition">
Ä°ptal
</button>
<button onclick="savePansumanEdit()"
class="flex-1 py-3 bg-gradient-to-r from-pink-500 to-rose-600 text-white rounded-xl font-semibold hover:from-pink-600 hover:to-rose-700 transition shadow-lg">
Kaydet
</button>
</div>
</div>
</div>

<div id="tab-sokaksorgu" class="tab-content hidden">
<div class="bg-white rounded-xl border border-gray-200 shadow-sm">
<div
class="p-4 border-b flex flex-col md:flex-row justify-between items-center gap-3 bg-gradient-to-r from-emerald-50 to-teal-50 rounded-t-xl">
<h2 class="font-bold text-gray-800 flex items-center gap-2">
<div
class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg">
<i data-lucide="map-pin" class="w-5 h-5 text-white"></i>
</div>
<div>
<span class="text-lg">AltÄ±eylÃ¼l Sokak Sorgulama</span>
<p class="text-xs text-gray-500 font-normal">Eski/Yeni sokak isimlerini sorgulayÄ±n</p>
</div>
</h2>
<div class="flex items-center gap-2">
<button onclick="openStreetAddModal()"
class="flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition text-sm font-bold shadow-sm">
<i data-lucide="plus" class="w-4 h-4"></i>
<span class="hidden md:inline">Sokak Ekle</span>
</button>
<button onclick="exportStreetExcel()"
class="flex items-center gap-1 md:gap-2 px-2 md:px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-bold shadow-sm"
title="Excel Ä°ndir">
<i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
<span class="hidden md:inline">Excel</span>
</button>
<button onclick="document.getElementById('street-import-file').click()"
class="flex items-center gap-1 md:gap-2 px-2 md:px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-bold shadow-sm"
title="Excel'den Ä°Ã§e Aktar">
<i data-lucide="upload" class="w-4 h-4"></i>
<span class="hidden md:inline">Ä°Ã§e Aktar</span>
</button>
<input type="file" id="street-import-file" accept=".xlsx,.xls" class="hidden"
onchange="importStreetExcel(this)">
</div>
</div>

<div class="p-4 md:p-6">
<div class="max-w-2xl mx-auto space-y-6">
<div class="relative">
<input type="text" id="street-search-input"
placeholder="Eski veya yeni sokak adÄ±nÄ± yazÄ±n... (Ã¶rn: ZAMBAK, 5002)"
oninput="searchStreets(this.value)"
class="w-full p-4 pl-12 border-2 border-emerald-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition shadow-sm text-gray-700 text-lg">
<i data-lucide="search"
class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-emerald-400"></i>
<button onclick="clearStreetSearch()" id="street-search-clear"
class="hidden absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-red-500">
<i data-lucide="x" class="w-5 h-5"></i>
</button>
</div>

<div class="flex flex-wrap gap-2 justify-center">
<button onclick="filterByMahalle('')" id="mahalle-filter-all"
class="px-3 py-1.5 text-xs font-bold rounded-full bg-emerald-600 text-white transition">
TÃ¼mÃ¼
</button>
<button onclick="filterByMahalle('GÃœMÃœSÃ‡ESME')"
class="mahalle-filter-btn px-3 py-1.5 text-xs font-bold rounded-full bg-gray-200 text-gray-700 hover:bg-emerald-100 transition">
GÃ¼mÃ¼ÅŸÃ§eÅŸme
</button>
<button onclick="filterByMahalle('HASAN BASRÄ° Ã‡ANTAY')"
class="mahalle-filter-btn px-3 py-1.5 text-xs font-bold rounded-full bg-gray-200 text-gray-700 hover:bg-emerald-100 transition">
H.B. Ã‡antay
</button>
<button onclick="filterByMahalle('SÃœTLÃœCE')"
class="mahalle-filter-btn px-3 py-1.5 text-xs font-bold rounded-full bg-gray-200 text-gray-700 hover:bg-emerald-100 transition">
SÃ¼tlÃ¼ce
</button>
<button onclick="filterByMahalle('YILDIZ')"
class="mahalle-filter-btn px-3 py-1.5 text-xs font-bold rounded-full bg-gray-200 text-gray-700 hover:bg-emerald-100 transition">
YÄ±ldÄ±z
</button>
<button onclick="filterByMahalle('BAHÃ‡ELÄ°EVLER')"
class="mahalle-filter-btn px-3 py-1.5 text-xs font-bold rounded-full bg-gray-200 text-gray-700 hover:bg-emerald-100 transition">
BahÃ§elievler
</button>
<button onclick="filterByMahalle('1.GÃœNDOÄAN')"
class="mahalle-filter-btn px-3 py-1.5 text-xs font-bold rounded-full bg-gray-200 text-gray-700 hover:bg-emerald-100 transition">
1.GÃ¼ndoÄŸan
</button>
<button onclick="filterByMahalle('2.GÃœNDOÄAN')"
class="mahalle-filter-btn px-3 py-1.5 text-xs font-bold rounded-full bg-gray-200 text-gray-700 hover:bg-emerald-100 transition">
2.GÃ¼ndoÄŸan
</button>
<button onclick="filterByMahalle('Ã‡AYIRHÄ°SAR')"
class="mahalle-filter-btn px-3 py-1.5 text-xs font-bold rounded-full bg-gray-200 text-gray-700 hover:bg-emerald-100 transition">
Ã‡ayÄ±rhisar
</button>
<button onclick="filterByMahalle('DÄ°NKÃ‡Ä°LER')"
class="mahalle-filter-btn px-3 py-1.5 text-xs font-bold rounded-full bg-gray-200 text-gray-700 hover:bg-emerald-100 transition">
DinkÃ§iler
</button>
<button onclick="filterByMahalle('GAZÄ°OSMANPAÅA')"
class="mahalle-filter-btn px-3 py-1.5 text-xs font-bold rounded-full bg-gray-200 text-gray-700 hover:bg-emerald-100 transition">
G.O.PaÅŸa
</button>
</div>

<div id="street-result-count" class="text-center text-sm text-gray-500">
<span id="street-count-number">0</span> sokak kaydÄ± bulundu
</div>

<div id="street-results-container"
class="max-h-96 overflow-y-auto border border-gray-200 rounded-xl shadow-inner bg-gray-50 hidden">
</div>

<div id="street-initial-message"
class="text-center text-gray-400 p-8 border-2 border-dashed border-gray-200 rounded-xl bg-gray-50">
<i data-lucide="map" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i>
<p class="font-medium">Sokak aramak iÃ§in yukarÄ±daki kutuya yazÄ±n</p>
<p class="text-sm mt-1">veya mahalle filtresi kullanÄ±n</p>
</div>

<div id="street-selected-info"
class="hidden p-5 bg-gradient-to-r from-emerald-50 to-teal-50 border-2 border-emerald-200 rounded-xl shadow-sm space-y-4">
<div class="flex justify-between items-start">
<h3 class="text-lg font-bold text-emerald-800 flex items-center gap-2">
<i data-lucide="check-circle" class="w-5 h-5"></i>
SeÃ§ilen Sokak
</h3>
<div class="flex gap-2">
<button onclick="editSelectedStreet()"
class="p-2 text-orange-600 hover:bg-orange-100 rounded-lg transition"
title="DÃ¼zenle">
<i data-lucide="pencil" class="w-4 h-4"></i>
</button>
<button onclick="deleteSelectedStreet()"
class="p-2 text-red-600 hover:bg-red-100 rounded-lg transition" title="Sil">
<i data-lucide="trash-2" class="w-4 h-4"></i>
</button>
</div>
</div>
<div class="grid grid-cols-2 gap-4 text-sm">
<div>
<span class="text-gray-500 text-xs uppercase font-bold">Yeni Ad:</span>
<p id="selected-street-new" class="text-emerald-700 font-bold text-lg"></p>
</div>
<div>
<span class="text-gray-500 text-xs uppercase font-bold">Eski Ad:</span>
<p id="selected-street-old" class="text-gray-600 font-medium"></p>
</div>
</div>
<p id="selected-street-mahalle" class="text-sm text-gray-500 italic"></p>

<button onclick="openStreetInMaps()"
class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition shadow-md hover:shadow-lg">
<i data-lucide="navigation" class="w-5 h-5"></i>
<span>Google Haritalar'da AÃ§</span>
</button>
</div>
</div>
</div>
</div>
</div>

<div id="street-add-modal"
class="fixed inset-0 bg-black/60 z-[100] hidden items-center justify-center p-4 backdrop-blur-sm">
<div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
<div class="p-5 border-b flex justify-between items-center bg-emerald-50 rounded-t-xl">
<h3 id="street-modal-title" class="text-lg font-bold text-emerald-800 flex items-center gap-2">
<i data-lucide="map-pin" class="w-5 h-5"></i>
Yeni Sokak Ekle
</h3>
<button onclick="closeStreetAddModal()"
class="text-gray-400 hover:text-red-500 text-xl font-bold">âœ•</button>
</div>
<div class="p-5 space-y-4">
<input type="hidden" id="street-edit-id">

<div>
<label class="block text-sm font-bold text-gray-700 mb-1">Eski Sokak AdÄ± *</label>
<input type="text" id="street-old-name" placeholder="Ã–rn: ZAMBAK SOKAK"
class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none">
</div>

<div>
<label class="block text-sm font-bold text-gray-700 mb-1">Yeni Sokak AdÄ± *</label>
<input type="text" id="street-new-name" placeholder="Ã–rn: 5002"
class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none">
</div>

<div>
<label class="block text-sm font-bold text-gray-700 mb-1">Mahalle *</label>
<select id="street-mahalle"
class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none">
<option value="">Mahalle SeÃ§in...</option>
<option value="GÃœMÃœSÃ‡ESME">GÃ¼mÃ¼ÅŸÃ§eÅŸme</option>
<option value="HASAN BASRÄ° Ã‡ANTAY">Hasan Basri Ã‡antay</option>
<option value="SÃœTLÃœCE">SÃ¼tlÃ¼ce</option>
<option value="YILDIZ">YÄ±ldÄ±z</option>
<option value="BAHÃ‡ELÄ°EVLER">BahÃ§elievler</option>
<option value="1.GÃœNDOÄAN">1.GÃ¼ndoÄŸan</option>
<option value="2.GÃœNDOÄAN">2.GÃ¼ndoÄŸan</option>
<option value="Ã‡AYIRHÄ°SAR">Ã‡ayÄ±rhisar</option>
<option value="DÄ°NKÃ‡Ä°LER">DinkÃ§iler</option>
<option value="GAZÄ°OSMANPAÅA">GaziosmanpaÅŸa</option>
</select>
</div>
</div>
<div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end gap-2">
<button onclick="closeStreetAddModal()"
class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold text-sm hover:bg-gray-300">
Ä°ptal
</button>
<button onclick="saveStreet()"
class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-bold text-sm hover:bg-emerald-700">
Kaydet
</button>
</div>
</div>
</div>

<div id="tab-puantaj" class="tab-content hidden h-full">
<div class="bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col h-full min-h-[700px]">

<div
class="p-2 md:p-4 border-b flex flex-col md:flex-row justify-between items-center gap-2 md:gap-4 bg-gray-50 rounded-t-xl sticky top-0 z-20">
<h2 class="font-bold text-gray-800 flex items-center gap-2 text-sm md:text-lg">
<i data-lucide="calculator" class="w-5 h-5 md:w-6 md:h-6 text-indigo-600"></i> AylÄ±k Personel
PuantajÄ±
</h2>

<div class="flex items-center gap-2 md:gap-4 flex-wrap justify-center">
<div class="hidden lg:flex items-center gap-3 text-xs font-bold text-gray-500 mr-4">
<span class="flex items-center"><span
class="w-3 h-3 bg-green-100 border border-green-300 rounded mr-1"></span> 8 Saat
(Mesai)</span>
<span class="flex items-center"><span
class="w-3 h-3 bg-red-100 border border-red-300 rounded mr-1"></span> Rapor (R)</span>
<span class="flex items-center"><span
class="w-3 h-3 bg-orange-100 border border-orange-300 rounded mr-1"></span> Ä°zin
(Ä°)</span>
<span class="flex items-center"><span
class="w-3 h-3 bg-cyan-100 border border-cyan-300 rounded mr-1"></span> UMKE
(U)</span>
</div>

<div class="flex items-center bg-white border rounded-lg shadow-sm">
<button onclick="changePuantajMonth(-1)"
class="p-1.5 md:p-2 hover:bg-gray-100 rounded-l-lg text-indigo-600 transition"><i
data-lucide="chevron-left" class="w-4 h-4 md:w-5 md:h-5"></i></button>
<span id="puantaj-period-display"
class="px-2 md:px-4 font-bold text-indigo-900 w-24 md:w-40 text-center select-none uppercase tracking-wide text-xs md:text-base">...</span>
<button onclick="changePuantajMonth(1)"
class="p-1.5 md:p-2 hover:bg-gray-100 rounded-r-lg text-indigo-600 transition"><i
data-lucide="chevron-right" class="w-4 h-4 md:w-5 md:h-5"></i></button>
</div>

<button onclick="downloadPuantajExcel()"
class="flex items-center gap-1 md:gap-2 px-2 md:px-3 py-1.5 md:py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-xs md:text-sm font-bold shadow-sm">
<i data-lucide="file-spreadsheet" class="w-4 h-4"></i> <span
class="hidden md:inline">Excel</span>
</button>
</div>
</div>

<div class="flex-grow overflow-auto custom-scrollbar p-0">
<table class="w-full text-sm text-left border-collapse">
<thead class="bg-gray-100 text-gray-600 uppercase text-xs sticky top-0 z-10 shadow-sm"
id="puantaj-head">
</thead>
<tbody id="puantaj-body" class="divide-y divide-gray-100">
</tbody>
</table>
</div>
</div>
</div>

<div id="puantaj-edit-modal"
class="fixed inset-0 bg-black/60 z-[85] hidden items-center justify-center p-4 backdrop-blur-sm">
<div class="bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col modal-enter">
<div class="p-4 border-b flex justify-between items-center bg-indigo-50 rounded-t-xl">
<h3 class="text-lg font-bold text-indigo-800 flex items-center">
<i data-lucide="edit-3" class="w-5 h-5 mr-2"></i> Puantaj DÃ¼zenle
</h3>
<button onclick="closePuantajEditModal()" class="text-gray-400 hover:text-red-500">
<i data-lucide="x" class="w-5 h-5"></i>
</button>
</div>
<div class="p-6 space-y-4">
<input type="hidden" id="puantaj-edit-staff">
<input type="hidden" id="puantaj-edit-date">

<div class="bg-gray-50 p-3 rounded-lg border">
<p class="text-sm text-gray-600">
<span class="font-bold text-gray-800" id="puantaj-edit-staff-display"></span>
<span class="text-gray-400 mx-2">â€¢</span>
<span class="font-medium text-indigo-600" id="puantaj-edit-date-display"></span>
</p>
<p class="text-xs text-gray-500 mt-1" id="puantaj-edit-day-info"></p>
</div>

<div>
<label class="block text-sm font-bold text-gray-700 mb-2">Durum</label>
<div class="grid grid-cols-4 gap-2" id="puantaj-edit-status-group">
<button type="button" onclick="selectPuantajStatus('mesai')"
class="puantaj-status-btn p-2 rounded-lg border-2 text-center transition hover:shadow-md"
data-status="mesai">
<span class="block text-lg">ğŸ’¼</span>
<span class="block text-[10px] font-bold mt-1">Mesai</span>
</button>
<button type="button" onclick="selectPuantajStatus('rapor')"
class="puantaj-status-btn p-2 rounded-lg border-2 text-center transition hover:shadow-md"
data-status="rapor">
<span class="block text-lg">ğŸ¥</span>
<span class="block text-[10px] font-bold mt-1">Rapor</span>
</button>
<button type="button" onclick="selectPuantajStatus('izin')"
class="puantaj-status-btn p-2 rounded-lg border-2 text-center transition hover:shadow-md"
data-status="izin">
<span class="block text-lg">ğŸ–ï¸</span>
<span class="block text-[10px] font-bold mt-1">Ä°zin</span>
</button>
<button type="button" onclick="selectPuantajStatus('umke')"
class="puantaj-status-btn p-2 rounded-lg border-2 text-center transition hover:shadow-md"
data-status="umke">
<span class="block text-lg">ğŸš‘</span>
<span class="block text-[10px] font-bold mt-1">UMKE</span>
</button>
</div>
</div>

<div id="puantaj-hours-section">
<label class="block text-sm font-bold text-gray-700 mb-2">Mesai Saati</label>
<div class="grid grid-cols-4 gap-2" id="puantaj-edit-hours-group">
<button type="button" onclick="selectPuantajHours(0)"
class="puantaj-hours-btn p-3 rounded-lg border-2 text-center transition hover:shadow-md"
data-hours="0">
<span class="block text-lg font-bold">0</span>
<span class="block text-[10px] text-gray-500">Yok</span>
</button>
<button type="button" onclick="selectPuantajHours(4)"
class="puantaj-hours-btn p-3 rounded-lg border-2 text-center transition hover:shadow-md"
data-hours="4">
<span class="block text-lg font-bold">4</span>
<span class="block text-[10px] text-gray-500">YarÄ±m</span>
</button>
<button type="button" onclick="selectPuantajHours(8)"
class="puantaj-hours-btn p-3 rounded-lg border-2 text-center transition hover:shadow-md"
data-hours="8">
<span class="block text-lg font-bold">8</span>
<span class="block text-[10px] text-gray-500">Tam</span>
</button>
<button type="button" onclick="selectPuantajHours(16)"
class="puantaj-hours-btn p-3 rounded-lg border-2 text-center transition hover:shadow-md"
data-hours="16">
<span class="block text-lg font-bold">16</span>
<span class="block text-[10px] text-gray-500">Uzun</span>
</button>
</div>
</div>

<div class="flex items-center gap-3 p-3 bg-purple-50 rounded-lg border border-purple-200">
<input type="checkbox" id="puantaj-edit-nobet"
class="w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
<label for="puantaj-edit-nobet"
class="text-sm font-bold text-purple-700 cursor-pointer flex items-center gap-2">
<span>ğŸŒ™</span> Bu gÃ¼n nÃ¶betÃ§i
</label>
<span class="text-xs text-purple-500 ml-auto" id="puantaj-nobet-info"></span>
</div>

<div class="text-xs text-gray-500 bg-amber-50 p-2 rounded border border-amber-200"
id="puantaj-edit-info">
ğŸ’¡ Resmi tatillerde sadece nÃ¶betÃ§ilere mesai yazÄ±lÄ±r
</div>
</div>
<div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-between gap-3">
<button onclick="resetPuantajOverride()"
class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm font-medium flex items-center gap-1">
<i data-lucide="rotate-ccw" class="w-4 h-4"></i> SÄ±fÄ±rla
</button>
<div class="flex gap-2">
<button onclick="closePuantajEditModal()"
class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm font-medium">
Ä°ptal
</button>
<button onclick="savePuantajEdit()"
class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold flex items-center gap-1">
<i data-lucide="check" class="w-4 h-4"></i> Kaydet
</button>
</div>
</div>
</div>
</div>

<div id="note-read-modal"
class="fixed inset-0 bg-black/60 z-[80] hidden items-center justify-center p-4 backdrop-blur-sm">
<div class="bg-white rounded-xl shadow-2xl w-full max-w-sm flex flex-col modal-enter">
<div class="p-4 border-b flex justify-between items-center bg-yellow-50 rounded-t-xl">
<h3 class="text-lg font-bold text-yellow-800 flex items-center">
<i data-lucide="sticky-note" class="w-5 h-5 mr-2"></i> GÃ¼nÃ¼n Notu
</h3>
<button class="close-note-modal text-gray-400 hover:text-red-500"><i data-lucide="x"
class="w-5 h-5"></i></button>
</div>
<div class="p-6 overflow-y-auto max-h-[60vh]">
<p id="note-read-date" class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider"></p>
<p id="note-read-content" class="text-sm text-gray-700 leading-relaxed whitespace-pre-line"></p>
</div>
<div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end">
<button
class="close-note-modal px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm font-medium">Kapat</button>
</div>
</div>
</div>

<div id="ai-report-modal"
class="fixed inset-0 bg-black/70 z-[90] hidden items-center justify-center p-4 backdrop-blur-sm">
<div
class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl h-[80vh] flex flex-col modal-enter border border-indigo-200">
<div
class="p-4 border-b flex justify-between items-center bg-gradient-to-r from-indigo-600 to-purple-600 rounded-t-2xl">
<h3 class="text-lg font-bold text-white flex items-center">
<i data-lucide="bot" class="w-6 h-6 mr-3"></i> ğŸ¤– AI Asistan
</h3>
<button id="btn-close-ai-header" class="text-white/80 hover:text-white">
<i data-lucide="x" class="w-6 h-6"></i>
</button>
</div>

<div id="ai-chat-area" class="flex-grow overflow-y-auto p-4 bg-gray-50 space-y-3">
<div class="flex justify-start">
<div class="bg-white rounded-2xl p-4 shadow-sm border max-w-[85%]">
<p class="text-sm text-gray-700">ğŸ‘‹ Merhaba! Ben AI asistanÄ±nÄ±zÄ±m.</p>
<p class="text-sm text-gray-600 mt-2">Size sistemdeki tÃ¼m veriler hakkÄ±nda yardÄ±mcÄ± olabilirim:
</p>
<ul class="text-xs text-gray-500 mt-2 space-y-1">
<li>ğŸ“Š Personel ve nÃ¶bet bilgileri</li>
<li>ğŸ’° BÃ¼tÃ§e ve kasa kayÄ±tlarÄ±</li>
<li>ğŸ¥ Hasta takip ve tedavi verileri</li>
<li>ğŸ“‹ Rutin gÃ¶revler ve hatÄ±rlatmalar</li>
<li>ğŸš‘ Acil Ã§anta envanterleri</li>
</ul>
<p class="text-sm text-gray-600 mt-3">Sormak istediÄŸiniz her ÅŸeyi yazabilirsiniz!</p>
</div>
</div>
</div>

<div class="p-4 border-t bg-white rounded-b-2xl">
<div class="flex gap-2 items-center bg-gray-100 rounded-xl px-4 py-3">
<i data-lucide="message-circle" class="w-5 h-5 text-gray-400"></i>
<input type="text" id="ai-user-input"
class="flex-grow bg-transparent outline-none text-sm text-gray-700 placeholder-gray-400"
placeholder="Bir soru sorun... (Ã–rn: Bu ay en Ã§ok kim nÃ¶bet tuttu?)">
<button id="btn-send-ai-query"
class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
<span class="text-sm font-medium">GÃ¶nder</span>
<i data-lucide="send" class="w-4 h-4"></i>
</button>
</div>
<div class="text-[10px] text-center text-gray-400 mt-2">Gemini 2.5 Flash tarafÄ±ndan desteklenmektedir
</div>
</div>
</div>
</div>

<div id="settings-modal"
class="fixed inset-0 bg-black/60 z-[100] hidden items-center justify-center p-4 overflow-y-auto">
<div
class="bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col modal-enter max-h-[90vh] overflow-hidden">
<div class="p-5 border-b flex justify-between items-center bg-gray-50 rounded-t-xl flex-shrink-0">
<h3 class="text-lg font-bold text-gray-800">Ayarlar</h3>
<button id="btn-close-settings" class="text-gray-400 hover:text-red-500"><i data-lucide="x"
class="w-5 h-5"></i></button>
</div>
<div class="p-6 space-y-5 overflow-y-auto flex-1">
<div>
<label class="block text-sm font-bold text-gray-700 mb-2">
<i data-lucide="sparkles" class="w-4 h-4 inline mr-1 text-indigo-600"></i> Google Gemini API
AnahtarÄ±
</label>
<input type="password" id="api-key-input"
class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
placeholder="AI-xxxxxxxxxxxxxxxxxxx">
<p class="text-xs text-gray-500 mt-1">AnahtarÄ±nÄ±z sadece tarayÄ±cÄ±nÄ±zÄ±n yerel hafÄ±zasÄ±nda saklanÄ±r.
</p>
</div>

<div class="border-t pt-4">
<label class="block text-sm font-bold text-gray-700 mb-2">
<i data-lucide="send" class="w-4 h-4 inline mr-1 text-blue-500"></i> Telegram Bot Token
</label>
<input type="password" id="telegram-bot-token"
class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
placeholder="1234567890:ABCdefGHI...">
<p class="text-xs text-gray-500 mt-1">@BotFather'dan aldÄ±ÄŸÄ±nÄ±z token</p>
</div>

<div>
<label class="block text-sm font-bold text-gray-700 mb-2">
<i data-lucide="users" class="w-4 h-4 inline mr-1 text-blue-500"></i> Telegram AlÄ±cÄ± Listesi
</label>
<div class="flex gap-2 mb-2">
<input type="text" id="new-telegram-chat-name"
class="w-24 p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
placeholder="Ä°sim">
<input type="text" id="new-telegram-chat-id"
class="flex-1 p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
placeholder="Chat ID">
<button onclick="addTelegramChatId()"
class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700 transition">
<i data-lucide="plus" class="w-4 h-4"></i>
</button>
</div>
<div id="telegram-chat-id-list" class="space-y-2 max-h-48 overflow-y-auto">
</div>
<p class="text-xs text-gray-500 mt-1">Her alÄ±cÄ±ya hangi bildirimlerin gideceÄŸini seÃ§ebilirsiniz</p>
</div>

<div class="border-t pt-4">
<label class="block text-sm font-bold text-gray-700 mb-3">
<i data-lucide="bell" class="w-4 h-4 inline mr-1 text-green-500"></i> Bildirim Kategorileri
</label>
<div class="grid grid-cols-2 gap-2 text-sm">
<label
class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
<input type="checkbox" id="tg-notify-tomorrow" class="w-4 h-4 text-blue-600 rounded"
checked>
<span>ğŸ“… YarÄ±nki Ä°ÅŸlemler</span>
</label>
<label
class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
<input type="checkbox" id="tg-notify-emergency" class="w-4 h-4 text-blue-600 rounded"
checked>
<span>ğŸ§° Acil Ã‡anta SKT</span>
</label>
<label
class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
<input type="checkbox" id="tg-notify-shift" class="w-4 h-4 text-blue-600 rounded" checked>
<span>ğŸ“‹ NÃ¶bet Bildirimleri</span>
</label>
<label
class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
<input type="checkbox" id="tg-notify-birthday" class="w-4 h-4 text-blue-600 rounded"
checked>
<span>ğŸ‚ DoÄŸum GÃ¼nleri</span>
</label>
<label
class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
<input type="checkbox" id="tg-notify-leave" class="w-4 h-4 text-blue-600 rounded" checked>
<span>ğŸ–ï¸ Ä°zin/Rapor</span>
</label>
<label
class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
<input type="checkbox" id="tg-notify-doctor" class="w-4 h-4 text-blue-600 rounded" checked>
<span>ğŸ‘¨â€âš•ï¸ Doktor Talepleri</span>
</label>
<label
class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
<input type="checkbox" id="tg-notify-islemplanla" class="w-4 h-4 text-blue-600 rounded"
checked>
<span>ğŸ“‹ TALEPLER</span>
</label>
</div>
</div>

<button onclick="testTelegramConnection()"
class="w-full px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-bold hover:bg-blue-200 transition text-sm flex items-center justify-center gap-2">
<i data-lucide="zap" class="w-4 h-4"></i> Telegram BaÄŸlantÄ±sÄ±nÄ± Test Et
</button>

</div>
<div class="p-5 border-t bg-gray-50 rounded-b-xl flex justify-end gap-2">
<button id="btn-save-api-key" onclick="saveAllSettings()"
class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700">TÃ¼mÃ¼nÃ¼
Kaydet</button>
</div>
</div>
</div>
<div id="active-devices-modal"
class="fixed inset-0 bg-black/60 z-[100] hidden items-center justify-center p-4 backdrop-blur-sm">
<div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col modal-enter max-h-[90vh]">
<div
class="flex items-center justify-between p-5 border-b bg-gradient-to-r from-blue-500 to-indigo-600 rounded-t-2xl">
<h2 class="text-lg font-bold text-white flex items-center gap-2">
<i data-lucide="smartphone" class="w-5 h-5"></i> Aktif Cihazlar
</h2>
<button onclick="closeActiveDevicesModal()" class="text-white/70 hover:text-white text-xl">âœ•</button>
</div>
<div class="p-5 overflow-y-auto flex-1">
<p class="text-sm text-gray-600 mb-4">Bu hesaba baÄŸlÄ± tÃ¼m aktif oturumlarÄ± gÃ¶rÃ¼ntÃ¼leyin.</p>

<div id="active-devices-list" class="space-y-3">
<div class="text-center py-8 text-gray-400">
<i data-lucide="loader-2" class="w-8 h-8 mx-auto animate-spin mb-2"></i>
<p>YÃ¼kleniyor...</p>
</div>
</div>
</div>
<div class="p-4 border-t bg-gray-50 rounded-b-2xl flex flex-col gap-2">
<button onclick="logoutAllDevices()"
class="w-full px-4 py-2 bg-red-100 text-red-700 rounded-lg font-bold hover:bg-red-200 transition text-sm flex items-center justify-center gap-2">
<i data-lucide="log-out" class="w-4 h-4"></i> TÃ¼m Cihazlardan Ã‡Ä±kÄ±ÅŸ Yap
</button>
<p class="text-[10px] text-center text-gray-400">Bu iÅŸlem tÃ¼m aktif oturumlarÄ± sonlandÄ±rÄ±r</p>
</div>
</div>
</div>

<div id="pending-users-modal"
class="fixed inset-0 bg-black/60 z-[100] hidden items-center justify-center p-4 backdrop-blur-sm">
<div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col modal-enter max-h-[90vh]">
<div
class="p-5 border-b flex justify-between items-center bg-gradient-to-r from-yellow-50 to-orange-50 rounded-t-2xl">
<h3 class="text-lg font-bold text-gray-800 flex items-center">
<i data-lucide="user-check" class="w-5 h-5 mr-2 text-yellow-600"></i> Bekleyen KullanÄ±cÄ±lar
</h3>
<button onclick="closePendingUsersModal()"
class="text-gray-400 hover:text-red-500 bg-white rounded-full p-1 border">
<i data-lucide="x" class="w-5 h-5"></i>
</button>
</div>

<div class="p-4 overflow-y-auto flex-1">
<div id="pending-users-list" class="space-y-3">
<div class="text-center text-gray-400 text-sm py-8">
<i data-lucide="loader" class="w-8 h-8 mx-auto mb-2 animate-spin"></i>
YÃ¼kleniyor...
</div>
</div>
</div>

<div class="p-4 border-t bg-gray-50 rounded-b-2xl">
<p class="text-[10px] text-center text-gray-400">
Onaylanan kullanÄ±cÄ±lar sisteme giriÅŸ yapabilir
</p>
</div>
</div>
</div>

<div id="appearance-modal"
class="fixed inset-0 bg-black/60 z-[100] hidden items-center justify-center p-4 backdrop-blur-sm">
<div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl flex flex-col modal-enter max-h-[90vh]">
<div
class="p-5 border-b flex justify-between items-center bg-gradient-to-r from-purple-50 to-pink-50 rounded-t-2xl">
<h3 class="text-lg font-bold text-gray-800 flex items-center">
<i data-lucide="palette" class="w-5 h-5 mr-2 text-purple-600"></i> GÃ¶rÃ¼nÃ¼m AyarlarÄ±
</h3>
<button onclick="closeAppearanceModal()"
class="text-gray-400 hover:text-red-500 bg-white rounded-full p-1 border">
<i data-lucide="x" class="w-5 h-5"></i>
</button>
</div>

<div class="p-6 space-y-6 overflow-y-auto">
<div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4 border border-indigo-100">
<h4 class="font-bold text-indigo-800 mb-4 flex items-center">
<i data-lucide="brush" class="w-4 h-4 mr-2"></i> Ã–zel Tema EditÃ¶rÃ¼
</h4>
<div class="grid grid-cols-3 gap-4">
<div>
<label class="block text-xs font-bold text-gray-600 mb-2">Ana Renk</label>
<div class="flex items-center gap-2">
<input type="color" id="theme-primary-color" value="#4f46e5"
class="w-10 h-10 rounded-lg border-2 border-gray-200 cursor-pointer">
<span id="primary-color-hex" class="text-xs text-gray-500">#4f46e5</span>
</div>
</div>
<div>
<label class="block text-xs font-bold text-gray-600 mb-2">Vurgu Rengi</label>
<div class="flex items-center gap-2">
<input type="color" id="theme-accent-color" value="#7c3aed"
class="w-10 h-10 rounded-lg border-2 border-gray-200 cursor-pointer">
<span id="accent-color-hex" class="text-xs text-gray-500">#7c3aed</span>
</div>
</div>
<div>
<label class="block text-xs font-bold text-gray-600 mb-2">Arka Plan</label>
<div class="flex items-center gap-2">
<input type="color" id="theme-bg-color" value="#f8fafc"
class="w-10 h-10 rounded-lg border-2 border-gray-200 cursor-pointer">
<span id="bg-color-hex" class="text-xs text-gray-500">#f8fafc</span>
</div>
</div>
</div>
<div class="mt-4">
<label class="block text-xs font-bold text-gray-600 mb-2">HazÄ±r Temalar</label>
<div class="flex flex-wrap gap-2">
<button onclick="applyPresetTheme('default')"
class="px-3 py-1 bg-indigo-600 text-white rounded-full text-xs font-bold hover:bg-indigo-700">VarsayÄ±lan</button>
<button onclick="applyPresetTheme('ocean')"
class="px-3 py-1 bg-cyan-600 text-white rounded-full text-xs font-bold hover:bg-cyan-700">Okyanus</button>
<button onclick="applyPresetTheme('forest')"
class="px-3 py-1 bg-emerald-600 text-white rounded-full text-xs font-bold hover:bg-emerald-700">Orman</button>
<button onclick="applyPresetTheme('sunset')"
class="px-3 py-1 bg-orange-600 text-white rounded-full text-xs font-bold hover:bg-orange-700">GÃ¼n
BatÄ±mÄ±</button>
<button onclick="applyPresetTheme('rose')"
class="px-3 py-1 bg-pink-600 text-white rounded-full text-xs font-bold hover:bg-pink-700">GÃ¼l</button>
</div>
</div>
</div>

<div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
<div class="flex justify-between items-center">
<div>
<h4 class="font-bold text-gray-800 flex items-center">
<i data-lucide="minimize-2" class="w-4 h-4 mr-2 text-gray-600"></i> Kompakt Mod
</h4>
<p class="text-xs text-gray-500 mt-1">Daha fazla iÃ§erik gÃ¶rmek iÃ§in arayÃ¼zÃ¼ sÄ±kÄ±ÅŸtÄ±rÄ±r</p>
</div>
<label class="relative inline-flex items-center cursor-pointer">
<input type="checkbox" id="compact-mode-toggle" class="sr-only peer"
onchange="toggleCompactMode()">
<div
class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600">
</div>
</label>
</div>
</div>

<div class="bg-blue-50 rounded-xl p-4 border border-blue-100">
<h4 class="font-bold text-blue-800 mb-4 flex items-center">
<i data-lucide="type" class="w-4 h-4 mr-2"></i> YazÄ± Tipi & Boyut
</h4>
<div class="space-y-4">
<div>
<label class="block text-xs font-bold text-gray-600 mb-2">YazÄ± Tipi</label>
<select id="font-family-select" onchange="applyFontFamily()"
class="w-full p-2 border rounded-lg text-sm bg-white">
<option value="Inter, system-ui, sans-serif">Inter (VarsayÄ±lan)</option>
<option value="'Roboto', sans-serif">Roboto</option>
<option value="'Poppins', sans-serif">Poppins</option>
<option value="'Nunito', sans-serif">Nunito</option>
<option value="'Open Sans', sans-serif">Open Sans</option>
<option value="'Montserrat', sans-serif">Montserrat</option>
<option value="system-ui, sans-serif">Sistem Fontu</option>
</select>
</div>
<div>
<label class="block text-xs font-bold text-gray-600 mb-2">
YazÄ± Boyutu: <span id="font-size-value">100%</span>
</label>
<input type="range" id="font-size-slider" min="80" max="120" value="100" step="5"
onchange="applyFontSize()" oninput="updateFontSizeLabel()"
class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
<div class="flex justify-between text-[10px] text-gray-400 mt-1">
<span>KÃ¼Ã§Ã¼k</span>
<span>Normal</span>
<span>BÃ¼yÃ¼k</span>
</div>
</div>
</div>
</div>

<div id="theme-preview" class="rounded-xl p-4 border-2 border-dashed border-gray-300">
<p class="text-xs text-gray-500 mb-2">Ã–nizleme:</p>
<div class="flex items-center gap-3">
<button id="preview-btn" class="px-4 py-2 rounded-lg text-white text-sm font-bold"
style="background: var(--theme-primary, #4f46e5)">
Ã–rnek Buton
</button>
<span id="preview-text" class="text-sm" style="color: var(--theme-accent, #7c3aed)">Ã–rnek
Metin</span>
</div>
</div>
</div>

<div class="p-5 border-t bg-gray-50 rounded-b-2xl flex justify-between">
<button onclick="resetAppearanceSettings()"
class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition">
<i data-lucide="rotate-ccw" class="w-4 h-4 inline mr-1"></i> SÄ±fÄ±rla
</button>
<button onclick="saveAppearanceSettings()"
class="px-6 py-2 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 transition">
<i data-lucide="check" class="w-4 h-4 inline mr-1"></i> Kaydet
</button>
</div>
</div>
</div>
<div id="fairness-modal"
class="fixed inset-0 bg-black/70 z-[90] hidden items-center justify-center p-4 backdrop-blur-sm">
<div
class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col modal-enter border border-indigo-200">
<div
class="p-5 border-b flex justify-between items-center bg-gradient-to-r from-purple-50 to-indigo-50 rounded-t-2xl">
<div>
<h3 class="text-xl font-bold text-indigo-900 flex items-center">
<i data-lucide="scale" class="w-6 h-6 mr-3 text-purple-600"></i> NÃ¶bet Analiz Raporu
</h3>
<p class="text-xs text-gray-500 mt-1">Hafta sonu ve resmi tatil yoÄŸunluk analizi</p>
</div>
<button onclick="closeFairnessModal()"
class="text-gray-400 hover:text-red-500 bg-white rounded-full p-1 border hover:bg-red-50 transition"><i
data-lucide="x" class="w-6 h-6"></i></button>
</div>

<div class="p-5 bg-gray-50 border-b flex flex-wrap gap-4 items-end">
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Analiz BaÅŸlangÄ±Ã§</label>
<input type="date" id="fair-start"
class="p-2 border rounded-lg text-sm shadow-sm focus:ring-2 focus:ring-purple-500 outline-none">
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Analiz BitiÅŸ</label>
<input type="date" id="fair-end"
class="p-2 border rounded-lg text-sm shadow-sm focus:ring-2 focus:ring-purple-500 outline-none">
</div>
<button onclick="calculateFairness()"
class="px-5 py-2 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 transition shadow-md flex items-center gap-2">
<i data-lucide="calculator" class="w-4 h-4"></i> Hesapla
</button>
</div>

<div class="flex-grow overflow-y-auto p-0">
<table class="w-full text-sm text-left">
<thead class="text-xs text-gray-500 uppercase bg-gray-100 sticky top-0 z-10 shadow-sm">
<tr>
<th class="px-6 py-3 font-extrabold border-b">Personel</th>
<th class="px-6 py-3 text-center border-b">Toplam NÃ¶bet</th>
<th class="px-6 py-3 text-center text-orange-600 bg-orange-50 border-b">Hafta Sonu</th>
<th class="px-6 py-3 text-center text-blue-600 bg-blue-50 border-b">Hafta Ä°Ã§i</th>
<th class="px-6 py-3 text-center border-b">Analiz Durumu</th>
</tr>
</thead>
<tbody id="fairness-body" class="divide-y divide-gray-100">
<tr>
<td colspan="5" class="p-10 text-center text-gray-400 italic">Tarih seÃ§ip "Hesapla" butonuna
basÄ±n.</td>
</tr>
</tbody>
</table>
</div>

<div class="p-4 border-t bg-gray-50 text-[10px] text-gray-500 flex justify-end items-center rounded-b-2xl">
<button onclick="printFairnessReport()"
class="text-indigo-600 font-bold hover:underline flex items-center gap-1">
<i data-lucide="printer" class="w-3 h-3"></i> Tabloyu YazdÄ±r
</button>
</div>
</div>
</div>

<div id="change-pw-modal" class="fixed inset-0 bg-black/60 z-[100] hidden items-center justify-center p-4">
<div class="bg-white rounded-xl shadow-2xl w-full max-w-sm flex flex-col modal-enter">
<div class="p-5 border-b flex justify-between items-center bg-blue-50 rounded-t-xl">
<h3 class="text-lg font-bold text-blue-800">Åifre DeÄŸiÅŸtir</h3>
<button id="btn-close-pw" class="text-gray-400 hover:text-red-500"><i data-lucide="x"
class="w-5 h-5"></i></button>
</div>
<div class="p-6 space-y-3">
<input type="password" id="old-pw" class="w-full p-2 border rounded text-sm" placeholder="Eski Åifre">
<input type="password" id="new-pw" class="w-full p-2 border rounded text-sm" placeholder="Yeni Åifre">
<input type="password" id="new-pw-confirm" class="w-full p-2 border rounded text-sm"
placeholder="Yeni Åifre (Tekrar)">
<p id="change-pw-error" class="text-xs text-red-500 hidden font-bold"></p>
</div>
<div class="p-5 border-t bg-gray-50 rounded-b-xl flex justify-end gap-2">
<button id="btn-save-pw"
class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">DeÄŸiÅŸtir</button>
</div>
</div>
</div>

<div id="data-entry-modal"
class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm">
<div class="bg-white rounded-xl shadow-2xl w-full max-w-[95%] max-h-[95vh] flex flex-col modal-enter">
<div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
<h3 class="text-lg font-bold text-gray-800">Veri GiriÅŸi & Ekip Planlama</h3>
<button class="close-modal text-gray-400 hover:text-red-500"><i data-lucide="x"
class="w-5 h-5"></i></button>
</div>

<div class="p-5 overflow-y-auto flex-grow flex flex-col lg:flex-row gap-6">
<div class="flex-grow lg:w-1/2">
<div class="mb-4 flex gap-2 items-end">
<div class="flex-1">
<label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Tarih</label>
<div class="flex items-center gap-2">
<button onclick="changeEntryDate(-1)" type="button"
class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg border border-gray-300 transition"
title="Ã–nceki gÃ¼n">
<i data-lucide="chevron-left" class="w-5 h-5 text-gray-600"></i>
</button>
<div class="flex-1 flex flex-col">
<input type="date" id="entry-date-picker"
class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none text-sm font-bold text-center">
<span id="entry-date-day"
class="block text-center text-xs font-bold text-indigo-600 mt-1"></span>
</div>
<button onclick="changeEntryDate(1)" type="button"
class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg border border-gray-300 transition"
title="Sonraki gÃ¼n">
<i data-lucide="chevron-right" class="w-5 h-5 text-gray-600"></i>
</button>
</div>
</div>
</div>

<div class="bg-gray-50 rounded p-1 border border-gray-200">
<div
class="flex items-center px-2 py-2 text-[10px] font-bold text-gray-500 uppercase tracking-wider bg-gray-100 rounded mb-1">
<span class="w-32">Personel</span>
<div class="flex-1 grid grid-cols-2 gap-1 text-center">
<div class="bg-gray-200 text-gray-600 rounded-l p-1">Ã–ÄŸleden Ã–nce</div>
<div class="bg-gray-300 text-gray-700 rounded-r p-1">Ã–ÄŸleden Sonra</div>
</div>
<span class="w-10 text-center text-red-600">Muay.</span>
<span class="w-16 text-center text-blue-600">Uzman</span>
</div>

<div
class="flex items-center px-2 py-1 text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-2">
<span class="w-32"></span>
<div class="flex-1 grid grid-cols-4 gap-1 text-center">
<span class="bg-gray-50 p-1">Merkez</span><span class="bg-gray-50 p-1">KÃ¶y</span>
<span class="bg-gray-100 p-1">Merkez</span><span class="bg-gray-100 p-1">KÃ¶y</span>
</div>
<span class="w-10"></span>
<span class="w-16"></span>
</div>

<div id="modal-staff-list" class="space-y-2"></div>
</div>
</div>

<div class="lg:w-1/4 flex flex-col gap-4">
<div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100">
<label class="block text-xs font-bold text-yellow-800 mb-2 flex items-center"><i
data-lucide="sticky-note" class="w-4 h-4 mr-1"></i> GÃ¼nÃ¼n Notu</label>
<textarea id="daily-note"
class="w-full h-20 p-2 border border-yellow-200 rounded text-sm focus:ring-2 focus:ring-yellow-500 bg-white resize-none"></textarea>
</div>

<div
class="bg-blue-50 rounded-xl border border-blue-200 p-3 flex-grow overflow-y-auto min-h-[200px]">
<h4 class="text-xs font-bold text-blue-900 uppercase mb-2 flex items-center"><i
data-lucide="stethoscope" class="w-4 h-4 mr-1"></i> Doktor Ä°ÅŸlemleri</h4>
<div id="modal-doctor-list" class="space-y-3"></div>
</div>
</div>

<div class="lg:w-1/4 flex flex-col gap-4">
<div
class="bg-indigo-50 rounded-xl border border-indigo-200 p-3 flex-grow overflow-y-auto min-h-[300px]">
<h4 class="text-xs font-bold text-indigo-900 uppercase mb-2 flex items-center">
<i data-lucide="users" class="w-4 h-4 mr-1"></i> Ekip / Liste EÅŸleÅŸtirme
</h4>
<p class="text-[10px] text-indigo-600 mb-3 leading-tight">AÅŸaÄŸÄ±daki listelere personel atamasÄ±
yapmak iÃ§in isimleri iÅŸaretleyin.</p>

<div id="modal-team-list" class="space-y-3"></div>
</div>
</div>

</div>

<div class="p-4 border-t bg-white rounded-b-xl flex justify-end gap-2">
<button
class="close-modal px-4 py-2 rounded border border-gray-300 text-gray-600 text-sm font-medium hover:bg-gray-100 flex items-center gap-2">
<i data-lucide="x" class="w-4 h-4"></i> Kapat
</button>
<button id="save-entry-btn"
class="px-4 py-2 rounded bg-indigo-600 text-white text-sm font-bold shadow hover:bg-indigo-700 flex items-center gap-2">
<i data-lucide="save" class="w-4 h-4"></i> Kaydet
</button>
</div>
</div>
</div>

<div id="staff-modal"
class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm">
<div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[85vh] flex flex-col modal-enter">
<div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
<h3 class="text-lg font-bold text-gray-800">YÃ¶netim Paneli</h3>
<button class="close-staff-modal text-gray-400 hover:text-red-500"><i data-lucide="x"
class="w-5 h-5"></i></button>
</div>
<div class="p-4 overflow-y-auto flex-grow grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
<div class="border-b md:border-b-0 md:border-r border-gray-200 pb-4 md:pb-0 pr-0 md:pr-4">
<h4 class="font-bold text-sm text-gray-700 mb-2">Personel Listesi</h4>
<div class="flex gap-2 mb-2">
<input type="text" id="new-staff-name" placeholder="Ad Soyad"
class="w-1/2 p-2 border rounded text-xs">
<input type="text" id="new-staff-role" placeholder="Ãœnvan"
class="w-1/2 p-2 border rounded text-xs">
<button id="add-staff-btn"
class="bg-indigo-600 text-white px-3 rounded hover:bg-indigo-700 transition"><i
data-lucide="plus" class="w-4 h-4"></i></button>
</div>
<div id="staff-management-list" class="space-y-1 h-64 overflow-y-auto"></div>
</div>
<div class="border-b md:border-b-0 md:border-r border-gray-200 pb-4 md:pb-0 pr-0 md:pr-4">
<h4 class="font-bold text-sm text-gray-700 mb-2">Doktor ve Ek</h4>
<div class="flex gap-2 mb-2">
<input type="text" id="new-doctor-name" placeholder="Manuel Ä°sim Ekle"
class="flex-1 p-2 border rounded text-xs">
<button id="add-doctor-btn"
class="bg-blue-600 text-white px-3 rounded hover:bg-blue-700 transition"><i
data-lucide="plus" class="w-4 h-4"></i></button>
</div>
<div id="doctor-management-list"
class="space-y-1 max-h-40 overflow-y-auto mb-2 border-b border-gray-100 pb-2"></div>
<h5 class="font-bold text-xs text-gray-500 uppercase mb-1">HÄ±zlÄ± Ekle</h5>
<div class="flex gap-2 mb-1">
<input type="text" id="new-quick-name" placeholder="Ä°sim Ekle"
class="flex-1 p-1 border rounded text-xs">
<button onclick="addQuickItem()"
class="bg-teal-600 text-white px-2 rounded hover:bg-teal-700 transition"><i
data-lucide="plus" class="w-3 h-3"></i></button>
</div>
<div id="doctor-staff-selection-list"
class="space-y-1 h-32 overflow-y-auto bg-gray-50 p-2 rounded border border-gray-100"></div>
</div>
<div class="border-b md:border-b-0 md:border-r border-gray-200 pb-4 md:pb-0 pr-0 md:pr-4">
<h4 class="font-bold text-sm text-gray-700 mb-2">Uzman Listesi</h4>
<div class="flex gap-2 mb-2">
<input type="text" id="new-spec-name" placeholder="UzmanlÄ±k"
class="flex-1 p-2 border rounded text-xs">
<button id="add-spec-btn"
class="bg-purple-600 text-white px-3 rounded hover:bg-purple-700 transition"><i
data-lucide="plus" class="w-4 h-4"></i></button>
</div>
<div id="spec-management-list" class="space-y-1 h-64 overflow-y-auto"></div>
</div>
<div class="border-b md:border-b-0 md:border-r border-gray-200 pb-4 md:pb-0 pr-0 md:pr-4">
<h4 class="font-bold text-sm text-gray-700 mb-2">Ä°ÅŸlem Listesi</h4>
<div class="flex gap-2 mb-2">
<input type="text" id="new-proc-name" placeholder="Ä°ÅŸlem AdÄ±"
class="flex-1 p-2 border rounded text-xs">
<button id="add-proc-btn"
class="bg-green-600 text-white px-3 rounded hover:bg-green-700 transition"><i
data-lucide="plus" class="w-4 h-4"></i></button>
</div>
<div id="proc-management-list" class="space-y-1 h-64 overflow-y-auto"></div>
</div>
<div>
<h4 class="font-bold text-sm text-indigo-700 mb-2">Ekip / Liste TanÄ±mlarÄ±</h4>
<div class="flex gap-2 mb-2">
<input type="text" id="new-team-name" placeholder="Liste AdÄ± (Ã–rn: Mavi Ekip)"
class="flex-1 p-2 border rounded text-xs">
<button id="add-team-btn"
class="bg-indigo-600 text-white px-3 rounded hover:bg-indigo-700 transition"><i
data-lucide="plus" class="w-4 h-4"></i></button>
</div>
<div id="team-management-list" class="space-y-1 h-64 overflow-y-auto"></div>
</div>
</div>
</div>
</div>

<div id="password-modal" class="fixed inset-0 bg-black/80 z-[60] hidden items-center justify-center p-4">
<div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xs text-center">
<h3 class="text-lg font-bold mb-1 text-gray-800">GÃ¼venlik</h3>
<input type="password" id="password-input"
class="w-full p-2 border rounded mb-4 text-center text-xl tracking-widest outline-none"
placeholder="â€¢â€¢â€¢â€¢">
<div class="grid grid-cols-2 gap-2">
<button id="modal-cancel"
class="py-2 bg-gray-100 text-gray-600 rounded text-sm font-medium">Ä°ptal</button>
<button id="modal-submit" class="py-2 bg-indigo-600 text-white rounded text-sm font-bold">GiriÅŸ</button>
</div>
<p id="password-error" class="text-red-500 text-xs mt-2 hidden">HatalÄ± parola!</p>
</div>
</div>

<div id="toast"
class="fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-2 rounded shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-[70] flex items-center text-sm font-medium">
<span id="toast-msg">Ä°ÅŸlem BaÅŸarÄ±lÄ±</span>
</div>

<div id="tab-sort-modal"
class="fixed inset-0 bg-black/60 z-[100] hidden items-center justify-center p-4 backdrop-blur-sm">
<div class="bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col modal-enter">
<div class="p-4 border-b flex justify-between items-center bg-purple-50 rounded-t-xl">
<h3 class="text-lg font-bold text-purple-900 flex items-center">
<i data-lucide="arrow-up-down" class="w-5 h-5 mr-2"></i> Sekmeleri SÄ±rala
</h3>
<button onclick="closeTabSortModal()" class="text-gray-400 hover:text-red-500">
<i data-lucide="x" class="w-5 h-5"></i>
</button>
</div>
<div class="p-4">
<p class="text-sm text-gray-600 mb-3">Sekmeleri sÃ¼rÃ¼kleyerek sÄ±ralayÄ±n:</p>
<div id="tab-sort-list"
class="space-y-2 max-h-[400px] overflow-y-auto border rounded-lg p-2 bg-gray-50">
</div>
</div>
<div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-between gap-2">
<button onclick="resetTabOrder()"
class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold text-sm hover:bg-gray-300 flex items-center gap-2">
<i data-lucide="rotate-ccw" class="w-4 h-4"></i> VarsayÄ±lana DÃ¶n
</button>
<div class="flex gap-2">
<button onclick="closeTabSortModal()"
class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold text-sm hover:bg-gray-300">Ä°ptal</button>
<button onclick="saveTabOrder()"
class="px-4 py-2 bg-purple-600 text-white rounded-lg font-bold text-sm hover:bg-purple-700 shadow-sm flex items-center gap-2">
<i data-lucide="save" class="w-4 h-4"></i> Kaydet
</button>
</div>
</div>
</div>
</div>

<div id="profile-modal"
class="fixed inset-0 bg-black/60 z-[100] hidden items-center justify-center p-4 backdrop-blur-sm">
<div class="bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col modal-enter">
<div class="p-4 border-b flex justify-between items-center bg-teal-50 rounded-t-xl">
<h3 class="text-lg font-bold text-teal-900 flex items-center">
<i data-lucide="user-circle" class="w-5 h-5 mr-2"></i> Profilim
</h3>
<button onclick="closeProfileModal()" class="text-gray-400 hover:text-red-500">
<i data-lucide="x" class="w-5 h-5"></i>
</button>
</div>
<div class="p-5 space-y-4">
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">E-posta Adresi</label>
<div class="flex items-center gap-2 p-3 bg-gray-100 rounded-lg border border-gray-200">
<i data-lucide="mail" class="w-4 h-4 text-gray-400"></i>
<span id="profile-email" class="text-sm font-medium text-gray-700">-</span>
</div>
</div>

<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Takma AdÄ±m</label>
<div class="flex items-center gap-2 p-3 bg-gray-100 rounded-lg border border-gray-200">
<i data-lucide="user" class="w-4 h-4 text-gray-400"></i>
<span id="profile-nickname-display" class="text-sm font-medium text-gray-700">-</span>
</div>
<p class="text-[10px] text-gray-400 mt-1">Takma ad deÄŸiÅŸikliÄŸi iÃ§in yÃ¶neticiye baÅŸvurun.</p>
</div>

<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Hesap RolÃ¼</label>
<div id="profile-role"
class="p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm font-medium text-gray-700 flex items-center gap-2">
-
</div>
</div>

<div class="border-t pt-4 mt-4">
<label class="block text-xs font-bold text-gray-500 mb-2">ğŸ” Åifre DeÄŸiÅŸtir</label>
<div class="space-y-2">
<div>
<input type="password" id="profile-old-password"
class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-teal-500 outline-none"
placeholder="Mevcut ÅŸifre" oninput="clearOldPasswordError()">
<div id="old-password-error"
class="hidden mt-1 text-xs text-red-600 font-medium flex items-center gap-1">
<i data-lucide="alert-circle" class="w-3 h-3"></i>
<span>Mevcut ÅŸifreniz yanlÄ±ÅŸ!</span>
</div>
</div>
<input type="password" id="profile-new-password"
class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-teal-500 outline-none"
placeholder="Yeni ÅŸifre (min 6 karakter)">
<input type="password" id="profile-confirm-password"
class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-teal-500 outline-none"
placeholder="Yeni ÅŸifre tekrar">
<button onclick="changeProfilePassword()"
class="w-full py-3 bg-orange-600 text-white rounded-lg font-bold text-sm hover:bg-orange-700 transition flex items-center justify-center gap-2">
<i data-lucide="key" class="w-4 h-4"></i> Åifreyi DeÄŸiÅŸtir
</button>
</div>
</div>
</div>
<div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end">
<button onclick="closeProfileModal()"
class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold text-sm hover:bg-gray-300">Kapat</button>
</div>
</div>
</div>

<div id="messages-password-modal"
class="fixed inset-0 bg-black/60 z-[100] hidden items-center justify-center p-4 backdrop-blur-sm">
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-xs flex flex-col modal-enter">
<div
class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-blue-50 dark:bg-blue-900 rounded-t-xl">
<h3 class="text-lg font-bold text-blue-900 dark:text-blue-100 flex items-center">
<i data-lucide="lock" class="w-5 h-5 mr-2"></i> MesajlarÄ±m
</h3>
<button onclick="closeMessagesPasswordModal()" class="text-gray-400 hover:text-red-500">
<i data-lucide="x" class="w-5 h-5"></i>
</button>
</div>
<div class="p-5 space-y-4">
<p class="text-sm text-gray-600 dark:text-gray-400 text-center">MesajlarÄ±nÄ±za eriÅŸmek iÃ§in ÅŸifrenizi
girin</p>
<input type="password" id="messages-password-input"
class="w-full p-3 border border-gray-200 dark:border-gray-600 rounded-lg text-center text-xl tracking-widest focus:ring-2 focus:ring-blue-500 outline-none bg-white dark:bg-gray-700 dark:text-white"
placeholder="â€¢ â€¢ â€¢ â€¢" maxlength="10" onkeypress="if(event.key==='Enter') checkMessagesPassword()">
</div>
<div
class="p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800 rounded-b-xl flex justify-end gap-2">
<button onclick="closeMessagesPasswordModal()"
class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-white rounded-lg font-bold text-sm hover:bg-gray-300 dark:hover:bg-gray-500">Ä°ptal</button>
<button onclick="checkMessagesPassword()"
class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm hover:bg-blue-700 flex items-center gap-2">
<i data-lucide="unlock" class="w-4 h-4"></i> GiriÅŸ
</button>
</div>
</div>
</div>

<div id="messages-change-password-modal"
class="fixed inset-0 bg-black/60 z-[101] hidden items-center justify-center p-4 backdrop-blur-sm">
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-xs flex flex-col modal-enter">
<div
class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-orange-50 dark:bg-orange-900 rounded-t-xl">
<h3 class="text-lg font-bold text-orange-900 dark:text-orange-100 flex items-center">
<i data-lucide="key" class="w-5 h-5 mr-2"></i> Åifre DeÄŸiÅŸtir
</h3>
<button onclick="closeChangeMessagesPasswordModal()" class="text-gray-400 hover:text-red-500">
<i data-lucide="x" class="w-5 h-5"></i>
</button>
</div>
<div class="p-5 space-y-4">
<div>
<label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Mevcut Åifre</label>
<input type="password" id="messages-current-password"
class="w-full p-3 border border-gray-200 dark:border-gray-600 rounded-lg text-center text-lg tracking-widest focus:ring-2 focus:ring-orange-500 outline-none bg-white dark:bg-gray-700 dark:text-white"
placeholder="â€¢ â€¢ â€¢ â€¢" maxlength="10">
</div>
<div>
<label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Yeni Åifre</label>
<input type="password" id="messages-new-password"
class="w-full p-3 border border-gray-200 dark:border-gray-600 rounded-lg text-center text-lg tracking-widest focus:ring-2 focus:ring-orange-500 outline-none bg-white dark:bg-gray-700 dark:text-white"
placeholder="â€¢ â€¢ â€¢ â€¢" maxlength="10">
</div>
<div>
<label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Yeni Åifre
(Tekrar)</label>
<input type="password" id="messages-confirm-password"
class="w-full p-3 border border-gray-200 dark:border-gray-600 rounded-lg text-center text-lg tracking-widest focus:ring-2 focus:ring-orange-500 outline-none bg-white dark:bg-gray-700 dark:text-white"
placeholder="â€¢ â€¢ â€¢ â€¢" maxlength="10"
onkeypress="if(event.key==='Enter') changeMessagesPassword()">
</div>
</div>
<div
class="p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800 rounded-b-xl flex justify-end gap-2">
<button onclick="closeChangeMessagesPasswordModal()"
class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-white rounded-lg font-bold text-sm hover:bg-gray-300 dark:hover:bg-gray-500">Ä°ptal</button>
<button onclick="changeMessagesPassword()"
class="px-4 py-2 bg-orange-600 text-white rounded-lg font-bold text-sm hover:bg-orange-700 flex items-center gap-2">
<i data-lucide="save" class="w-4 h-4"></i> Kaydet
</button>
</div>
</div>
</div>

<div id="send-message-modal"
class="fixed inset-0 bg-black/60 z-[102] hidden items-center justify-center p-4 backdrop-blur-sm">
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md flex flex-col modal-enter">
<div
class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-green-50 dark:bg-green-900 rounded-t-xl">
<h3 class="text-lg font-bold text-green-900 dark:text-green-100 flex items-center">
<i data-lucide="send" class="w-5 h-5 mr-2"></i> Mesaj GÃ¶nder
</h3>
<button onclick="closeSendMessageModal()" class="text-gray-400 hover:text-red-500">
<i data-lucide="x" class="w-5 h-5"></i>
</button>
</div>
<div class="p-5 space-y-4">
<div>
<label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">AlÄ±cÄ±</label>
<select id="message-recipient"
class="w-full p-3 border border-gray-200 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none bg-white dark:bg-gray-700 dark:text-white">
<option value="">-- KullanÄ±cÄ± SeÃ§in --</option>
</select>
</div>
<div>
<label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">MesajÄ±nÄ±z</label>
<textarea id="message-content" rows="4"
class="w-full p-3 border border-gray-200 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none resize-none bg-white dark:bg-gray-700 dark:text-white"
placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..."></textarea>
</div>
<div id="reply-info" class="hidden bg-blue-50 dark:bg-blue-900 border-l-4 border-blue-500 p-3 rounded">
<p class="text-xs text-blue-600 dark:text-blue-300 font-bold mb-1">YanÄ±tlanÄ±yor:</p>
<p id="reply-original-message" class="text-xs text-gray-600 dark:text-gray-300 italic truncate"></p>
<button onclick="cancelReply()" class="text-xs text-red-500 hover:underline mt-1">Ä°ptal</button>
</div>
</div>
<div
class="p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800 rounded-b-xl flex justify-end gap-2">
<button onclick="closeSendMessageModal()"
class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-white rounded-lg font-bold text-sm hover:bg-gray-300 dark:hover:bg-gray-500">Ä°ptal</button>
<button onclick="sendUserMessage()"
class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold text-sm hover:bg-green-700 flex items-center gap-2">
<i data-lucide="send" class="w-4 h-4"></i> GÃ¶nder
</button>
</div>
</div>
</div>

<div id="messages-modal"
class="fixed inset-0 bg-black/60 z-[100] hidden items-center justify-center p-4 backdrop-blur-sm">
<div
class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg flex flex-col modal-enter max-h-[85vh]">
<div
class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-blue-50 dark:bg-blue-900 rounded-t-xl">
<h3 class="text-lg font-bold text-blue-900 dark:text-blue-100 flex items-center">
<i data-lucide="mail" class="w-5 h-5 mr-2"></i> MesajlarÄ±m
<span id="messages-count"
class="ml-2 text-xs bg-blue-200 dark:bg-blue-700 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-full">0</span>
</h3>
<button onclick="closeMessagesModal()" class="text-gray-400 hover:text-red-500">
<i data-lucide="x" class="w-5 h-5"></i>
</button>
</div>
<div class="p-4 overflow-y-auto flex-1 custom-scrollbar" id="messages-list">
<div class="text-center text-gray-400 dark:text-gray-500 py-10">
<i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
<p class="text-sm">HenÃ¼z mesajÄ±nÄ±z yok</p>
</div>
</div>
<div
class="p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800 rounded-b-xl flex flex-wrap gap-2 justify-between items-center">
<div class="flex gap-2">
<button onclick="openSendMessageModal()"
class="px-3 py-2 bg-green-100 dark:bg-green-800 text-green-700 dark:text-green-200 rounded-lg font-bold text-xs hover:bg-green-200 dark:hover:bg-green-700 flex items-center gap-1">
<i data-lucide="send" class="w-3 h-3"></i> Yeni Mesaj
</button>
<button onclick="markAllMessagesAsRead()"
class="px-3 py-2 bg-blue-100 dark:bg-blue-800 text-blue-700 dark:text-blue-200 rounded-lg font-bold text-xs hover:bg-blue-200 dark:hover:bg-blue-700 flex items-center gap-1">
<i data-lucide="check-check" class="w-3 h-3"></i> TÃ¼mÃ¼nÃ¼ Okundu
</button>
</div>
<div class="flex gap-2">
<button onclick="openChangeMessagesPasswordModal()"
class="px-3 py-2 bg-orange-100 dark:bg-orange-800 text-orange-700 dark:text-orange-200 rounded-lg font-bold text-xs hover:bg-orange-200 dark:hover:bg-orange-700 flex items-center gap-1">
<i data-lucide="key" class="w-3 h-3"></i> Åifre DeÄŸiÅŸtir
</button>
<button onclick="closeMessagesModal()"
class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-white rounded-lg font-bold text-sm hover:bg-gray-300 dark:hover:bg-gray-500">Kapat</button>
</div>
</div>
</div>
</div>

<div id="lock-screen-modal"
class="fixed inset-0 bg-black/95 z-[9999] hidden items-center justify-center backdrop-blur-md">
<div class="text-center">
<div class="mb-8">
<div
class="w-24 h-24 mx-auto bg-white/10 rounded-full flex items-center justify-center mb-4 border-2 border-white/20">
<i data-lucide="lock" class="w-12 h-12 text-white/80"></i>
</div>
<h2 class="text-2xl font-bold text-white mb-2">Ekran Kilitli</h2>
<p id="lock-screen-user" class="text-white/60 text-sm">KullanÄ±cÄ±</p>
<p class="text-white/40 text-[10px] mt-2">Ctrl+L ile de kilitleyebilirsiniz</p>
</div>

<div class="max-w-xs mx-auto">
<div class="relative mb-4">
<input type="password" id="lock-screen-password"
class="w-full px-4 py-4 bg-white/10 border border-white/20 rounded-xl text-white text-center text-xl tracking-widest placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
placeholder="â€¢ â€¢ â€¢ â€¢" autofocus onkeypress="if(event.key==='Enter') unlockScreen()">
</div>
<button onclick="unlockScreen()"
class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition flex items-center justify-center gap-2">
<i data-lucide="unlock" class="w-5 h-5"></i> Kilidi AÃ§
</button>
<p id="lock-screen-error" class="text-red-400 text-xs mt-3 hidden">HatalÄ± ÅŸifre!</p>
</div>

<div class="mt-10 text-white/30 text-[10px]">
Evde SaÄŸlÄ±k Takip Sistemi
</div>
</div>
</div>

<div id="screen-lock-settings-modal"
class="fixed inset-0 bg-black/60 z-[110] hidden items-center justify-center p-4 backdrop-blur-sm">
<div class="bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col modal-enter">
<div class="p-4 border-b flex justify-between items-center bg-gray-800 rounded-t-xl">
<h3 class="text-lg font-bold text-white flex items-center gap-2">
<i data-lucide="shield-check" class="w-5 h-5"></i> Ekran Kilidi AyarlarÄ±
</h3>
<button onclick="closeScreenLockSettingsModal()" class="text-white/70 hover:text-white">
<i data-lucide="x" class="w-5 h-5"></i>
</button>
</div>
<div class="p-5 space-y-5">
<div class="border border-gray-200 rounded-xl p-4">
<div class="flex items-center gap-2 mb-3">
<i data-lucide="key" class="w-5 h-5 text-indigo-600"></i>
<span class="font-bold text-gray-800">Kilit Åifresini DeÄŸiÅŸtir</span>
</div>
<div class="space-y-3">
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Mevcut Åifre</label>
<input type="password" id="lock-pw-current"
class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
placeholder="Mevcut kilit ÅŸifresi">
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Yeni Åifre</label>
<input type="password" id="lock-pw-new"
class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
placeholder="Yeni kilit ÅŸifresi (min 4 karakter)">
</div>
<div>
<label class="block text-xs font-bold text-gray-500 mb-1">Yeni Åifre Tekrar</label>
<input type="password" id="lock-pw-confirm"
class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
placeholder="Yeni ÅŸifreyi tekrar girin">
</div>
<button onclick="saveLockPassword()"
class="w-full py-3 bg-indigo-600 text-white rounded-lg font-bold text-sm hover:bg-indigo-700 transition flex items-center justify-center gap-2">
<i data-lucide="save" class="w-4 h-4"></i> Åifreyi Kaydet
</button>
</div>
</div>

<p class="text-[10px] text-gray-400 text-center">Ayarlar sadece bu hesap iÃ§in geÃ§erlidir ve tÃ¼m
cihazlarda senkronize edilir.</p>
</div>
</div>
</div>

<div id="copy-bag-modal"
class="fixed inset-0 bg-black/60 z-[100] hidden items-center justify-center p-4 backdrop-blur-sm">
<div class="bg-white rounded-xl shadow-2xl w-full max-w-sm flex flex-col modal-enter">
<div class="p-4 border-b flex justify-between items-center bg-indigo-50 rounded-t-xl">
<h3 class="text-lg font-bold text-indigo-900 flex items-center">
<i data-lucide="copy" class="w-5 h-5 mr-2"></i> Kopyala
</h3>
<button onclick="closeCopyModal()" class="text-gray-400 hover:text-red-500"><i data-lucide="x"
class="w-5 h-5"></i></button>
</div>
<div class="p-5">
<p class="text-sm text-gray-600 mb-3">SeÃ§ilen malzemeler hangi Ã§antalara kopyalansÄ±n?</p>
<div id="copy-target-list" class="space-y-2 max-h-48 overflow-y-auto border rounded-lg p-2 bg-gray-50">
</div>
</div>
<div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end gap-2">
<button onclick="closeCopyModal()"
class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold text-sm hover:bg-gray-300">Ä°ptal</button>
<button onclick="performCopy()"
class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold text-sm hover:bg-indigo-700 shadow-sm">
Kopyala
</button>
</div>
</div>
</div>
<script>
// Ä°NR DOZ HESAPLAMA - DOÄAL DÄ°L AYRIÅTIRMA
let currentWeeklyDose = 35; // VarsayÄ±lan 7*5=35 mg/hafta

// HaftalÄ±k kullanÄ±mÄ± doÄŸal dilden ayrÄ±ÅŸtÄ±r - GLOBAL
window.parseWeeklyUsage = function () {
const tabletMg = parseFloat(document.getElementById('inr-tablet-mg')?.value) || 5;
const usageText = document.getElementById('inr-weekly-usage')?.value?.toLowerCase().trim() || '';

let weeklyTotal = 0;

if (!usageText) {
// BoÅŸsa varsayÄ±lan gÃ¼nde 1 tablet
weeklyTotal = tabletMg * 7;
} else {
// DoÄŸal dil ayrÄ±ÅŸtÄ±rma
weeklyTotal = parseNaturalLanguageDose(usageText, tabletMg);
}

currentWeeklyDose = weeklyTotal;

// SonuÃ§larÄ± gÃ¼ncelle
const totalEl = document.getElementById('inr-total-weekly');
const avgEl = document.getElementById('inr-daily-avg');
if (totalEl) totalEl.textContent = weeklyTotal.toFixed(1);
if (avgEl) avgEl.textContent = (weeklyTotal / 7).toFixed(1);

// Mevcut INR deÄŸerine gÃ¶re yeni doz hesapla
const currentINR = parseFloat(document.getElementById('inr-current-value')?.value) || 2.5;
// tabletMg zaten yukarÄ±da tanÄ±mlandÄ±, aynÄ± deÄŸeri kullanÄ±yoruz

// INR'ye gÃ¶re doz Ã§arpanÄ± belirle
let multiplier = 1.0;
let recommendation = '';
if (currentINR < 1) {
multiplier = 1.5;
recommendation = 'INR Ã§ok dÃ¼ÅŸÃ¼k - %50 doz artÄ±ÅŸÄ± Ã¶neriliyor';
} else if (currentINR < 2) {
multiplier = 1.2;
recommendation = 'INR dÃ¼ÅŸÃ¼k - %20 doz artÄ±ÅŸÄ± Ã¶neriliyor';
} else if (currentINR <= 3) {
multiplier = 1.0;
recommendation = 'INR hedefte - Mevcut dozu koruyun';
} else if (currentINR <= 4) {
multiplier = 0.8;
recommendation = 'INR yÃ¼ksek - %20 doz azaltmasÄ± Ã¶neriliyor';
} else {
multiplier = 0;
recommendation = 'âš ï¸ INR > 4 - Warfarin kesilmeli, doktora baÅŸvurun!';
}

const newWeeklyDose = weeklyTotal * multiplier;

// SonuÃ§ tablosunu doldur
updateResultTable(newWeeklyDose, tabletMg, recommendation);

// INR doz hesaplamalarÄ±nÄ± gÃ¼ncelle
calculateINRDose();

// Toast mesajÄ± kaldÄ±rÄ±ldÄ± - sayfa yÃ¼klendiÄŸinde otomatik Ã§Ä±kmasÄ±n

// Lucide ikonlarÄ±nÄ± gÃ¼ncelle
if (typeof lucide !== 'undefined') lucide.createIcons();
};

// SonuÃ§ tablosunu gÃ¼ncelle
function updateResultTable(weeklyDose, tabletMg, recommendation) {
const tableContainer = document.getElementById('inr-result-table');
const tbody = document.getElementById('inr-result-tbody');
const totalEl = document.getElementById('inr-result-total');

if (!tableContainer || !tbody) return;

// Tabloyu gÃ¶ster
tableContainer.classList.remove('hidden');

// DaÄŸÄ±lÄ±mÄ± hesapla - haftalÄ±k toplam tablet sayÄ±sÄ±
let doseBreakdown = [];

if (weeklyDose <= 0) {
doseBreakdown = [{ days: 7, dose: 0, label: 'KullanmayÄ±n' }];
} else {
// HaftalÄ±k toplam tablet sayÄ±sÄ±nÄ± hesapla (0.25 hassasiyetinde)
const weeklyTablets = weeklyDose / tabletMg;

// MÃ¼mkÃ¼n olan doz seviyeleri (tablet cinsinden)
const doseLevels = [
{ tablets: 2, label: '2 tablet' },
{ tablets: 1.5, label: '1Â½ tablet' },
{ tablets: 1, label: '1 tablet (tam)' },
{ tablets: 0.5, label: 'Â½ tablet (yarÄ±m)' },
{ tablets: 0.25, label: 'Â¼ tablet (Ã§eyrek)' },
{ tablets: 0, label: 'BoÅŸ (kullanmayÄ±n)' }
];

// Greedy algoritma ile en uygun daÄŸÄ±lÄ±mÄ± bul
let remainingTablets = weeklyTablets;
let remainingDays = 7;

for (var i = 0; i < doseLevels.length && remainingDays > 0; i++) {
var level = doseLevels[i];
if (level.tablets === 0) {
// Kalan gÃ¼nleri boÅŸ olarak ekle
if (remainingDays > 0) {
doseBreakdown.push({
days: remainingDays,
dose: 0,
label: level.label
});
remainingDays = 0;
}
} else if (remainingTablets >= level.tablets) {
// Bu seviyede kaÃ§ gÃ¼n kullanÄ±labilir?
var daysAtThisLevel = Math.floor(remainingTablets / level.tablets);
daysAtThisLevel = Math.min(daysAtThisLevel, remainingDays);

if (daysAtThisLevel > 0) {
doseBreakdown.push({
days: daysAtThisLevel,
dose: level.tablets * tabletMg,
label: level.label
});
remainingTablets -= daysAtThisLevel * level.tablets;
remainingDays -= daysAtThisLevel;
}
}
}

// Kalan gÃ¼nler varsa boÅŸ olarak ekle
if (remainingDays > 0) {
doseBreakdown.push({
days: remainingDays,
dose: 0,
label: 'BoÅŸ (kullanmayÄ±n)'
});
}
}

// Tabloyu doldur
var calculatedTotal = 0;
tbody.innerHTML = doseBreakdown.map(function (item) {
var subtotal = item.days * item.dose;
calculatedTotal += subtotal;
return '<tr class="bg-white hover:bg-green-50">' +
'<td class="px-3 py-2 font-bold text-green-800">' + item.days + ' gÃ¼n</td>' +
'<td class="px-3 py-2 text-center">' + item.dose.toFixed(1) + ' mg</td>' +
'<td class="px-3 py-2 text-center font-semibold">' + item.label + '</td>' +
'<td class="px-3 py-2 text-right font-bold">' + subtotal.toFixed(1) + ' mg</td>' +
'</tr>';
}).join('');

// Toplam gÃ¼ncelle
if (totalEl) {
totalEl.textContent = calculatedTotal.toFixed(1) + ' mg';
}

// Ã–neri notu gÃ¼ncelle
const noteP = tableContainer.querySelector('p.italic');
if (noteP) {
noteP.innerHTML = 'ğŸ’Š <strong>' + recommendation + '</strong>';
}
}

// DoÄŸal dil ayrÄ±ÅŸtÄ±rÄ±cÄ±
function parseNaturalLanguageDose(text, tabletMg) {
let total = 0;
let totalDays = 0;

// TÃ¼rkÃ§e sayÄ± kelimeleri
const numberWords = {
'bir': 1, 'iki': 2, 'Ã¼Ã§': 3, 'dÃ¶rt': 4, 'beÅŸ': 5,
'altÄ±': 6, 'yedi': 7, 'sekiz': 8, 'dokuz': 9, 'on': 10
};

// Miktar kelimeleri (tablet cinsinden)
const amountWords = {
'yarÄ±m': 0.5, 'buÃ§uk': 0.5, 'Ã§eyrek': 0.25,
'tam': 1, 'bir': 1, '1': 1, 'tek': 1,
'0.5': 0.5, '0,5': 0.5, '1/2': 0.5,
'1.5': 1.5, '1,5': 1.5, 'birbuÃ§uk': 1.5,
'2': 2, 'iki': 2, 'Ã§ift': 2,
// BoÅŸ/kullanmayan gÃ¼nler
'boÅŸ': 0, 'yok': 0, 'almadÄ±': 0, 'almadi': 0, 'kullanmadÄ±': 0,
'kullanmadi': 0, 'hiÃ§': 0, 'hic': 0, '0': 0, 'sÄ±fÄ±r': 0, 'sifir': 0
};

// HergÃ¼n/gÃ¼nde kalÄ±plarÄ±
if (text.match(/herg[Ã¼u]n|g[Ã¼u]nde|her\s*g[Ã¼u]n/)) {
// "hergÃ¼n yarÄ±m", "gÃ¼nde 1 tablet" vb.
let amount = 1;

for (const [word, val] of Object.entries(amountWords)) {
if (text.includes(word)) {
amount = val;
break;
}
}

// SayÄ± kontrolÃ¼
const numMatch = text.match(/(\d+(?:[.,]\d+)?)\s*(tablet|tb|mg)?/);
if (numMatch) {
const num = parseFloat(numMatch[1].replace(',', '.'));
if (numMatch[2] === 'mg') {
return num * 7; // Direkt mg olarak girilmiÅŸ
}
amount = num;
}

return amount * tabletMg * 7;
}

// GÃ¼n bazlÄ± kalÄ±plar: "4 gÃ¼n yarÄ±m 3 gÃ¼n tam", "2 gÃ¼n boÅŸ 5 gÃ¼n yarÄ±m"
// GeniÅŸletilmiÅŸ regex - boÅŸ/yok/almadÄ± da yakalasÄ±n
let regex = /(\d+)\s*g[Ã¼u]n\s*(yar[Ä±i]m|tam|buÃ§uk|Ã§eyrek|bo[ÅŸs]|yok|almad[Ä±i]|kullanmad[Ä±i]|hi[Ã§c]|s[Ä±i]f[Ä±i]r|[\d.,]+)/gi;
let match;

while ((match = regex.exec(text)) !== null) {
const days = parseInt(match[1]);
let amount = 1;

const amountText = match[2].toLowerCase();

// BoÅŸ/yok kontrolÃ¼
if (amountText.match(/bo[ÅŸs]|yok|almad|kullanmad|hi[Ã§c]|s[Ä±i]f[Ä±i]r/)) {
amount = 0;
} else if (amountText === 'yarÄ±m' || amountText === 'yarim') {
amount = 0.5;
} else if (amountText === 'tam') {
amount = 1;
} else if (amountText === 'buÃ§uk') {
amount = 0.5;
} else if (amountText === 'Ã§eyrek') {
amount = 0.25;
} else {
const parsedNum = parseFloat(amountText.replace(',', '.'));
if (!isNaN(parsedNum)) amount = parsedNum;
}

total += days * amount * tabletMg;
totalDays += days;
}

// EÄŸer pattern bulunduysa ve toplam gÃ¼n 7 ise, hesaplamayÄ± dÃ¶ndÃ¼r
if (totalDays > 0) {
return total;
}

// EÄŸer pattern bulunamadÄ±ysa, basit sayÄ± ara
const simpleMatch = text.match(/(\d+(?:[.,]\d+)?)/);
if (simpleMatch) {
const num = parseFloat(simpleMatch[1].replace(',', '.'));
// EÄŸer bÃ¼yÃ¼k bir sayÄ±ysa (>10) muhtemelen haftalÄ±k mg
if (num > 10) {
return num; // Direkt haftalÄ±k mg olarak kabul et
}
// Aksi halde gÃ¼nlÃ¼k tablet
return num * tabletMg * 7;
}

// VarsayÄ±lan
return tabletMg * 7;
}

// Ä°NR DOZ HESAPLAMA FONKSÄ°YONU
function calculateINRDose() {
const weeklyBase = currentWeeklyDose || 35;

// Her INR aralÄ±ÄŸÄ± iÃ§in Ã§arpanlar (haftalÄ±k toplam iÃ§in)
const multipliers = {
'0-1': 1.5,   // %50 artÄ±ÅŸ (INR Ã§ok dÃ¼ÅŸÃ¼k, doz artÄ±ÅŸÄ± gerekli)
'1-2': 1.2,   // %20 artÄ±ÅŸ (INR dÃ¼ÅŸÃ¼k)
'2-3': 1.0,   // AynÄ± doz (hedef aralÄ±kta)
'3-4': 0.8    // %20 azaltma (INR yÃ¼ksek)
};

// HaftalÄ±k dozlarÄ± hesapla
Object.keys(multipliers).forEach(range => {
const weeklyTotal = (weeklyBase * multipliers[range]).toFixed(1);
const dailyAvg = (weeklyTotal / 7).toFixed(1);

// GÃ¼nlÃ¼k daÄŸÄ±lÄ±mÄ± oluÅŸtur (gerÃ§ekÃ§i daÄŸÄ±lÄ±m)
const distributions = generateDoseDistribution(parseFloat(weeklyTotal));

// DOM gÃ¼ncelle
const container = document.getElementById(`inr-dose-${range.replace('-', '-')}`);
if (container) {
const daySpans = container.querySelectorAll('.inr-day-dose');
daySpans.forEach((span, idx) => {
span.textContent = distributions[idx] + ' mg';
});
}

const weeklySpan = document.getElementById(`inr-weekly-${range.replace('-', '-')}`);
if (weeklySpan) {
weeklySpan.textContent = weeklyTotal;
}
});

// Lucide ikonlarÄ±nÄ± gÃ¼ncelle
if (typeof lucide !== 'undefined') lucide.createIcons();
}

// GerÃ§ekÃ§i gÃ¼nlÃ¼k daÄŸÄ±lÄ±m oluÅŸtur (hafta iÃ§i dalgalanma)
function generateDoseDistribution(weeklyTotal) {
const dailyAvg = weeklyTotal / 7;
const distribution = [];

// Warfarin genellikle 0.5 mg'lÄ±k tabletler halinde
// BazÄ± gÃ¼nler daha yÃ¼ksek, bazÄ± gÃ¼nler daha dÃ¼ÅŸÃ¼k olabilir
let remaining = weeklyTotal;

for (let i = 0; i < 7; i++) {
if (i === 6) {
// Son gÃ¼n kalanÄ± al
distribution.push(Math.round(remaining * 2) / 2);
} else {
// Ortalamaya yakÄ±n ama Â±0.5 veya Â±1 mg deÄŸiÅŸkenlik
let dose = dailyAvg;
if (i % 2 === 0) {
dose = Math.ceil(dailyAvg * 2) / 2; // Yuvarlama yukarÄ±
} else {
dose = Math.floor(dailyAvg * 2) / 2; // Yuvarlama aÅŸaÄŸÄ±
}
dose = Math.max(0, dose); // Negatif olamaz
distribution.push(dose);
remaining -= dose;
}
}

return distribution;
}

// Sayfa yÃ¼klendiÄŸinde hesapla
document.addEventListener('DOMContentLoaded', function () {
setTimeout(parseWeeklyUsage, 500);
});

// ============================================
// UZMAN TIP - Ä°NR HESAPLAYICI FONKSÄ°YONLARI
// ============================================

// Hedef INR aralÄ±ÄŸÄ± seÃ§imi
function selectINRTargetRange(range) {
var hiddenInput = document.getElementById('uzmanTargetRange');
var btn23 = document.getElementById('targetRange-2-3');
var btn2535 = document.getElementById('targetRange-2.5-3.5');
var headerRange = document.getElementById('headerINRRange');

if (hiddenInput) hiddenInput.value = range;

// Buton stillerini gÃ¼ncelle
if (btn23 && btn2535) {
if (range === '2-3') {
btn23.classList.add('border-cyan-500', 'bg-cyan-50', 'text-cyan-700');
btn23.classList.remove('border-slate-200', 'bg-slate-50', 'text-slate-600');
btn2535.classList.remove('border-cyan-500', 'bg-cyan-50', 'text-cyan-700');
btn2535.classList.add('border-slate-200', 'bg-slate-50', 'text-slate-600');
if (headerRange) headerRange.textContent = '2.0 - 3.0';
} else {
btn2535.classList.add('border-cyan-500', 'bg-cyan-50', 'text-cyan-700');
btn2535.classList.remove('border-slate-200', 'bg-slate-50', 'text-slate-600');
btn23.classList.remove('border-cyan-500', 'bg-cyan-50', 'text-cyan-700');
btn23.classList.add('border-slate-200', 'bg-slate-50', 'text-slate-600');
if (headerRange) headerRange.textContent = '2.5 - 3.5';
}
}
}

function parsePrescriptionTextUzman() {
var text = (document.getElementById('uzmanDoseText').value || '').toLocaleLowerCase('tr-TR');
var totalDisplay = document.getElementById('uzmanTotalWeeklyMgDisplay');
var hiddenInput = document.getElementById('uzmanCurrentWeeklyDose');
var statusDiv = document.getElementById('uzmanParseStatus');

// Ã–n iÅŸleme
text = text.replace(/(\d)\s+buÃ§uk/g, "$1.5");
text = text.replace(/(^|\s)buÃ§uk(?=\s|$)/g, "$10.5");
text = text.replace(/(\d),(\d)/g, "$1.$2");

var numberMap = {
'bir': 1, 'iki': 2, 'Ã¼Ã§': 3, 'dÃ¶rt': 4, 'beÅŸ': 5, 'altÄ±': 6, 'yedi': 7,
'tek': 1, 'her': 7, 'bÃ¼tÃ¼n': 7, 'haftanÄ±n': 7
};

var doseKeywordMap = {
'tam': 1.0, 'tÃ¼m': 1.0,
'yarÄ±m': 0.5, 'yarÄ±': 0.5,
'Ã§eyrek': 0.25,
'boÅŸ': 0, 'yok': 0, 'iÃ§miyor': 0, 'almÄ±yor': 0, 'pas': 0
};

var totalMg = 0;
var totalDays = 0;
var parsedHtml = [];

var freqPart = "(?:\\d+(?:\\.\\d+)?|bir|iki|Ã¼Ã§|dÃ¶rt|beÅŸ|altÄ±|yedi|tek|her|bÃ¼tÃ¼n|haftanÄ±n)";
var separator = "\\s*(?:gÃ¼n|tane|kere|defa|kez)?\\s*";
var dosePart = "(?:\\d+(?:\\.\\d+)?|tam|tÃ¼m|yarÄ±m|yarÄ±|Ã§eyrek|boÅŸ|yok|iÃ§miyor|almÄ±yor|pas)";

var regex = new RegExp("(" + freqPart + ")" + separator + "(" + dosePart + ")", 'g');

var match;
while ((match = regex.exec(text)) !== null) {
var freqRaw = match[1];
var doseRaw = match[2];

var days = parseFloat(freqRaw);
if (isNaN(days)) {
days = numberMap[freqRaw] || 0;
}

var tabletCount = parseFloat(doseRaw);
if (isNaN(tabletCount)) {
tabletCount = doseKeywordMap[doseRaw];
if (tabletCount === undefined) tabletCount = 0;
}

var mg = tabletCount * 5;

if (days > 0) {
var subTotal = days * mg;
totalMg += subTotal;
totalDays += days;

var displayDose = isNaN(parseFloat(doseRaw)) ? doseRaw : tabletCount + ' tablet';

parsedHtml.push('<div class="flex justify-between border-b border-slate-200 pb-1 last:border-0"><span><span class="font-bold text-slate-700">' + days + ' gÃ¼n</span> ' + displayDose + '</span><span class="text-slate-500 text-xs">(' + days + ' x ' + mg + 'mg = ' + subTotal + 'mg)</span></div>');
}
}

if (totalDisplay) totalDisplay.innerText = totalMg;
if (hiddenInput) hiddenInput.value = totalMg;

if (parsedHtml.length > 0 && statusDiv) {
statusDiv.classList.remove('hidden');
var dayWarning = "";

if (totalDays > 7) {
dayWarning = '<div class="mt-2 text-red-600 text-xs font-bold border-t border-red-200 pt-1">âš ï¸ UyarÄ±: Toplam ' + totalDays + ' gÃ¼n girildi. Hafta 7 gÃ¼ndÃ¼r.</div>';
} else if (totalDays < 7 && totalDays > 0) {
dayWarning = '<div class="mt-2 text-orange-600 text-xs font-bold border-t border-orange-200 pt-1">â„¹ï¸ UyarÄ±: ' + totalDays + ' gÃ¼n girildi. Kalan gÃ¼nler boÅŸ mu?</div>';
} else if (totalDays === 7) {
dayWarning = '<div class="mt-2 text-green-700 text-xs font-bold border-t border-green-200 pt-1">âœ… Tam hafta (7 gÃ¼n) algÄ±landÄ±.</div>';
}

statusDiv.innerHTML = '<div class="mb-1 text-xs font-bold text-slate-400 uppercase">AlgÄ±lanan ReÃ§ete</div><div class="space-y-1">' + parsedHtml.join('') + '</div>' + dayWarning;
} else if (statusDiv) {
statusDiv.classList.add('hidden');
}
}

function calculateDoseUzman() {
var currentDose = parseFloat(document.getElementById('uzmanCurrentWeeklyDose').value) || 0;
var inr = parseFloat(document.getElementById('uzmanCurrentINR').value);

// Hedef aralÄ±k seÃ§imini al
var targetRange = document.getElementById('uzmanTargetRange').value || '2-3';
var targetLow = 2.0;
var targetHigh = 3.0;
if (targetRange === '2.5-3.5') {
targetLow = 2.5;
targetHigh = 3.5;
}

var emptyState = document.getElementById('uzmanEmptyState');
var resultsContent = document.getElementById('uzmanResultsContent');
var resultCard = document.getElementById('uzmanResultCard');
var displayOld = document.getElementById('uzmanDisplayOldDose');
var displayNew = document.getElementById('uzmanDisplayNewDose');
var statusBadge = document.getElementById('uzmanStatusBadge');
var actionText = document.getElementById('uzmanActionText');

if (isNaN(inr)) {
alert("LÃ¼tfen geÃ§erli bir INR deÄŸeri giriniz.");
return;
}
if (currentDose === 0) {
if (!confirm("AlgÄ±lanan haftalÄ±k doz 0 mg. Hesaplamaya devam etmek istiyor musunuz?")) return;
}

if (emptyState) emptyState.classList.add('hidden');
if (resultsContent) resultsContent.classList.remove('hidden');

var newDose = currentDose;
var status = "";
var action = "";
var badgeColor = "";

// Dinamik eÅŸikler - hedef aralÄ±ÄŸa gÃ¶re hesaplama
var criticalLow = targetLow - 0.5;       // 1.5 veya 2.0
var subTherapeutic = targetLow;          // 2.0 veya 2.5
var therapeutic = targetHigh;            // 3.0 veya 3.5
var mildHigh = targetHigh + 0.6;         // 3.6 veya 4.1
var high = targetHigh + 1.2;             // 4.2 veya 4.7
var veryHigh = targetHigh + 2.0;         // 5.0 veya 5.5

// INR Ã§ok dÃ¼ÅŸÃ¼k (kritik - pÄ±htÄ± riski)
if (inr >= 0 && inr < criticalLow) {
newDose = currentDose * 1.20;
status = "KRÄ°TÄ°K DÃœÅÃœK (<" + criticalLow.toFixed(1) + ")";
badgeColor = "bg-red-100 text-red-800 border-red-200";
if (resultCard) resultCard.className = "bg-white rounded-xl p-6 border-2 border-red-400 shadow-sm";
action = "<strong>INR Ã§ok dÃ¼ÅŸÃ¼k.</strong> Kan yeterince sulanmamÄ±ÅŸ, pÄ±htÄ± riski var. HaftalÄ±k dozu <strong>%20 artÄ±rÄ±yoruz</strong>.";

// INR dÃ¼ÅŸÃ¼k (hedef altÄ±)
} else if (inr >= criticalLow && inr < subTherapeutic) {
newDose = currentDose * 1.10;
status = "DÃœÅÃœK (" + criticalLow.toFixed(1) + "-" + subTherapeutic.toFixed(1) + ")";
badgeColor = "bg-orange-100 text-orange-800 border-orange-200";
if (resultCard) resultCard.className = "bg-white rounded-xl p-6 border-2 border-orange-400 shadow-sm";
action = "<strong>INR hedefin biraz altÄ±nda.</strong> KÃ¼Ã§Ã¼k bir destek gerekiyor. HaftalÄ±k dozu <strong>%10 artÄ±rÄ±yoruz</strong>.";

// INR hedef aralÄ±kta (terapÃ¶tik)
} else if (inr >= subTherapeutic && inr <= therapeutic) {
newDose = currentDose;
status = "HEDEF ARALIK (" + targetLow.toFixed(1) + "-" + targetHigh.toFixed(1) + ")";
badgeColor = "bg-green-100 text-green-800 border-green-200";
if (resultCard) resultCard.className = "bg-white rounded-xl p-6 border-2 border-green-400 shadow-sm";
action = "<strong>MÃ¼kemmel.</strong> Tedavi tam kararÄ±nda iÅŸliyor. Doz deÄŸiÅŸtirmeden aynÄ± ÅŸekilde devam ediniz.";

// INR hafif yÃ¼ksek
} else if (inr > therapeutic && inr <= mildHigh) {
newDose = currentDose * 0.90;
status = "HAFÄ°F YÃœKSEK (" + therapeutic.toFixed(1) + "-" + mildHigh.toFixed(1) + ")";
badgeColor = "bg-yellow-100 text-yellow-800 border-yellow-200";
if (resultCard) resultCard.className = "bg-white rounded-xl p-6 border-2 border-yellow-400 shadow-sm";
action = "<strong>INR hafif yÃ¼ksek.</strong> Tedbir amaÃ§lÄ± hafif bir fren yapÄ±yoruz. HaftalÄ±k dozu <strong>%10 azaltÄ±yoruz</strong>.";

// INR yÃ¼ksek - 1 gÃ¼n pas gerekli
} else if (inr > mildHigh && inr <= high) {
newDose = currentDose * 0.85;
status = "YÃœKSEK + DOZ ATLA";
badgeColor = "bg-orange-100 text-orange-900 border-orange-200";
if (resultCard) resultCard.className = "bg-white rounded-xl p-6 border-2 border-orange-500 shadow-sm";
action = '<div class="mb-2 p-2 bg-red-100 border border-red-300 rounded text-red-800 font-bold">âš ï¸ DÄ°KKAT: Yeni doza baÅŸlamadan Ã¶nce BUGÃœN ilacÄ± ALMAYINIZ (1 GÃ¼n Pas).</div><p><strong>INR yÃ¼ksek seviyede.</strong> Kanama riskini dÃ¼ÅŸÃ¼rmek iÃ§in bugÃ¼n <strong>doz atlÄ±yoruz</strong>. YarÄ±ndan itibaren hesaplanan yeni doza (%15 azaltÄ±lmÄ±ÅŸ) baÅŸlayÄ±nÄ±z.</p>';

// INR Ã§ok yÃ¼ksek - 2 gÃ¼n pas gerekli
} else if (inr > high && inr <= veryHigh) {
newDose = currentDose * 0.75;
status = "RÄ°SKLÄ° + 2 GÃœN ATLA";
badgeColor = "bg-red-50 text-red-900 border-red-200";
if (resultCard) resultCard.className = "bg-white rounded-xl p-6 border-2 border-red-500 shadow-sm";
action = '<div class="mb-2 p-2 bg-red-100 border border-red-300 rounded text-red-800 font-bold">âš ï¸ DÄ°KKAT: Yeni doza baÅŸlamadan Ã¶nce BUGÃœN ve YARIN ilacÄ± ALMAYINIZ (2 GÃ¼n Pas).</div><p><strong>INR tehlikeli seviyeye yakÄ±n.</strong> Ciddi bir fren gerekiyor. 2 gÃ¼n ilaÃ§ almayÄ±p, sonraki gÃ¼n %25 azaltÄ±lmÄ±ÅŸ yeni doza baÅŸlayÄ±nÄ±z. Morluk takibi yapÄ±nÄ±z.</p>';

// INR toksik seviye - ilaÃ§ kesilmeli
} else if (inr > veryHigh) {
newDose = 0;
status = "TOKSÄ°K (>" + veryHigh.toFixed(1) + ")";
badgeColor = "bg-red-100 text-red-800 border-red-200";
if (resultCard) resultCard.className = "bg-white rounded-xl p-6 border-2 border-red-600 shadow-sm";
action = "<strong>INR Ã§ok yÃ¼ksek (>" + veryHigh.toFixed(1) + ").</strong> KANAMA RÄ°SKÄ°! <strong>Ä°lacÄ± derhal kesin</strong> ve doktorunuzla iletiÅŸime geÃ§in. K Vitamini gerekebilir.";
}

// Yuvarlama: 1.25mg'ye yuvarla (Ã‡eyrek tablet)
if (inr <= 5.0) {
newDose = Math.round(newDose / 1.25) * 1.25;
}

if (displayOld) displayOld.innerText = currentDose + " mg";
if (displayNew) displayNew.innerText = inr > 5.0 ? "KESÄ°LDÄ°" : newDose + " mg";
if (statusBadge) {
statusBadge.innerText = status;
statusBadge.className = 'px-3 py-1 rounded-full text-xs font-bold border ' + badgeColor;
}
if (actionText) actionText.innerHTML = action;

// Sonraki Kan KontrolÃ¼ Hesaplama (ACCP/AHA KÄ±lavuzlarÄ±na gÃ¶re)
var nextTestBox = document.getElementById('uzmanNextTestBox');
var nextTestText = document.getElementById('uzmanNextTestText');
var nextTestDate = document.getElementById('uzmanNextTestDate');
var nextTestDays = document.getElementById('uzmanNextTestDays');
var nextTestReason = document.getElementById('uzmanNextTestReason');

var testDays = 7; // VarsayÄ±lan
var testReason = "";

// ACCP (American College of Chest Physicians) KÄ±lavuzuna gÃ¶re INR kontrol sÃ¼releri - dinamik eÅŸikler
if (inr < criticalLow) {
testDays = 3; // Kritik dÃ¼ÅŸÃ¼k - Ã§ok sÄ±k kontrol
testReason = "Kaynak: ACCP 2012 - Sub-terapÃ¶tik INR'de hÄ±zlÄ± yeniden deÄŸerlendirme Ã¶nerilir.";
} else if (inr >= criticalLow && inr < subTherapeutic) {
testDays = 5; // DÃ¼ÅŸÃ¼k - sÄ±k kontrol
testReason = "Kaynak: ACCP 2012 - Hedef altÄ± INR'de 1 hafta iÃ§inde kontrol Ã¶nerilir.";
} else if (inr >= subTherapeutic && inr <= therapeutic) {
// Stabil ve hedef aralÄ±kta
if (currentDose === newDose) {
testDays = 28; // 4 hafta - stabil hasta
testReason = "Kaynak: AHA/ACCP - Stabil INR'de 4 haftaya kadar aralÄ±k uzatÄ±labilir.";
} else {
testDays = 7; // Doz deÄŸiÅŸikliÄŸi yoksa bile ilk kontrol
testReason = "Kaynak: ACCP 2012 - Hedef aralÄ±kta 1-2 hafta iÃ§inde doÄŸrulama Ã¶nerilir.";
}
} else if (inr > therapeutic && inr <= mildHigh) {
testDays = 5; // Hafif yÃ¼ksek - sÄ±k kontrol
testReason = "Kaynak: ACCP 2012 - Hafif yÃ¼ksek INR'de 1 hafta iÃ§inde kontrol Ã¶nerilir.";
} else if (inr > mildHigh && inr <= high) {
testDays = 3; // YÃ¼ksek - Ã§ok sÄ±k kontrol
testReason = "Kaynak: ACCP 2012 - Doz atlama sonrasÄ± 2-3 gÃ¼n iÃ§inde kontrol Ã¶nerilir.";
} else if (inr > high && inr <= veryHigh) {
testDays = 2; // Riskli yÃ¼ksek - gÃ¼nlÃ¼k takip gerekebilir
testReason = "Kaynak: ACCP 2012 - YÃ¼ksek INR'de sÄ±k kontrol, K vitamini deÄŸerlendirilmeli.";
} else if (inr > veryHigh) {
testDays = 1; // Toksik - acil takip
testReason = "Kaynak: ACCP 2012 - Toksik INR'de gÃ¼nlÃ¼k takip, K vitamini ve doktor konsÃ¼ltasyonu gerekli.";
}

// Tarihi hesapla
var today = new Date();
var nextDate = new Date(today.getTime() + testDays * 24 * 60 * 60 * 1000);
var dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
var formattedDate = nextDate.toLocaleDateString('tr-TR', dateOptions);

if (nextTestBox) {
nextTestBox.classList.remove('hidden');
if (nextTestText) nextTestText.innerHTML = 'Ã–nerilen kontrol sÃ¼resi: <strong>' + testDays + ' gÃ¼n</strong>';
if (nextTestDate) nextTestDate.textContent = formattedDate;
if (nextTestDays) nextTestDays.textContent = testDays;
if (nextTestReason) nextTestReason.textContent = testReason;
}

generateScheduleUzman(newDose);

// Lucide ikonlarÄ±nÄ± gÃ¼ncelle
if (typeof lucide !== 'undefined') lucide.createIcons();
}

function generateScheduleUzman(weeklyDose) {
var container = document.getElementById('uzmanPillSchedule');
var summaryContainer = document.getElementById('uzmanScheduleSummary');
if (!container) return;

container.innerHTML = "";
if (summaryContainer) summaryContainer.innerHTML = "";

if (weeklyDose === 0) {
container.innerHTML = "<p class='col-span-7 text-center text-red-600 font-bold p-2 border border-red-200 bg-red-50 rounded'>BugÃ¼n Ä°laÃ§ AlÄ±mÄ±nÄ± Durdurun (PAS)</p>";
if (summaryContainer) {
summaryContainer.innerHTML = "Ä°laÃ§ Kesilmeli";
summaryContainer.className = "mt-3 bg-red-50 p-3 rounded-lg border border-red-100 text-center text-sm font-bold text-red-800";
}
return;
} else if (summaryContainer) {
summaryContainer.className = "mt-3 bg-cyan-50 p-3 rounded-lg border border-cyan-100 text-center text-sm font-semibold text-cyan-800";
}

var dayNames = ["Pzt", "Sal", "Ã‡ar", "Per", "Cum", "Cmt", "Paz"];

var totalQ = Math.round(weeklyDose / 1.25);
var numQuarterDays = totalQ % 2;
var remainingQ = totalQ - numQuarterDays;

var daysAvailableForHalves = 7 - numQuarterDays;
var halvesToDistribute = remainingQ / 2;

var baseHalves = Math.floor(halvesToDistribute / daysAvailableForHalves);
var extraHalves = halvesToDistribute % daysAvailableForHalves;

var schedule = [0, 0, 0, 0, 0, 0, 0];

for (var i = 0; i < numQuarterDays; i++) {
schedule[6 - i] = 1.25;
}

for (var i = 0; i < daysAvailableForHalves; i++) {
var dailyDose = baseHalves * 2.5;
if (i < extraHalves) {
dailyDose += 2.5;
}
schedule[i] = dailyDose;
}

var counts = {};
schedule.forEach(function (dose) {
counts[dose] = (counts[dose] || 0) + 1;
});

var summaryParts = [];
Object.keys(counts).sort(function (a, b) { return parseFloat(b) - parseFloat(a); }).forEach(function (doseVal) {
var count = counts[doseVal];
var dose = parseFloat(doseVal);
var label = "";

if (dose === 0) label = "BoÅŸ";
else if (dose === 1.25) label = "Ã‡eyrek";
else if (dose === 2.5) label = "YarÄ±m";
else if (dose === 5) label = "Tam";
else if (dose === 7.5) label = "1 Tam, 1 YarÄ±m";
else if (dose === 10) label = "2 Tam";
else label = dose + "mg";

if (count > 0) {
summaryParts.push(count + ' gÃ¼n ' + label);
}
});

if (summaryContainer) {
summaryContainer.innerHTML = 'ğŸ“‹ Pratik Tarif: <strong>' + summaryParts.join(" + ") + '</strong>';
}

schedule.forEach(function (dose, index) {
var pillText = "";
var pillIcon = "";
var pillClass = "text-cyan-800";

if (dose === 0) { pillText = "BoÅŸ"; pillIcon = "ban"; pillClass = "text-slate-400"; }
else if (dose === 5) { pillText = "1 Tam"; pillIcon = "circle"; }
else if (dose === 2.5) { pillText = "YarÄ±m"; pillIcon = "circle-dot"; }
else if (dose === 1.25) { pillText = "Ã‡eyrek"; pillIcon = "pie-chart"; }
else if (dose === 7.5) { pillText = "1.5"; pillIcon = "pill"; }
else if (dose === 10) { pillText = "2 Tam"; pillIcon = "pill"; }
else { pillText = dose + " mg"; pillIcon = "pill"; }

var dayDiv = document.createElement('div');
dayDiv.className = "flex flex-col items-center bg-slate-50 p-2 rounded border border-slate-200 transition hover:bg-white hover:shadow-md hover:border-cyan-300";
dayDiv.innerHTML = '<span class="font-bold text-slate-500 mb-1 text-[10px] uppercase tracking-wider">' + dayNames[index] + '</span><i data-lucide="' + pillIcon + '" class="w-5 h-5 ' + pillClass + ' mb-1"></i><span class="font-bold ' + pillClass + ' text-[10px] leading-tight text-center">' + pillText + '</span>';
container.appendChild(dayDiv);
});

// Lucide ikonlarÄ±nÄ± gÃ¼ncelle
if (typeof lucide !== 'undefined') lucide.createIcons();
}

const LS_SHIFTS = 'evdeSaglikShifts_V19';
let shiftList = [];
const LS_DEVICES = 'evdeSaglikDevices_V1';
let deviceList = [];
let editingDeviceIndex = -1; // DÃ¼zenlenen cihazÄ±n sÄ±rasÄ±nÄ± tutacak
let shiftCursorDate = new Date();
const LS_DATA = 'evdeSaglikData_ULTIMATE_V18';
const LS_STAFF = 'evdeSaglikStaff_ULTIMATE_V18';
const LS_NOTES = 'evdeSaglikNotes_ULTIMATE_V18';
const LS_API_KEY = 'evdeSaglikApiKey_V18';
const LS_DOCTORS = 'evdeSaglikDoctors_V18';
const LS_DOC_DATA = 'evdeSaglikDocData_V18';
const LS_PROCS = 'evdeSaglikProcs_V18';
const LS_APP_PASSWORD_ENC = 'evdeSaglikAppPW_Enc_V1';
const LS_SPECIALISTS_LIST = 'evdeSaglikSpecList_V18';
const LS_QUICK_LIST = 'evdeSaglikQuickList_V18';
const LS_LEAVE_RECORDS = 'evdeSaglikLeaveRec_V18';
const LS_TEAMS = 'evdeSaglikTeams_V19';
const LS_ROUTINES = 'evdeSaglikRoutines_V19';
const LS_BUDGET = 'evdeSaglikBudget_V19';
const LS_EMERGENCY = 'evdeSaglikEmergency_V19';
const LS_BAGS = 'evdeSaglikBags_V19';
const LS_GENERAL_NOTES_LIST = 'evdeSaglikGenNotesList_V1';
let generalNotesList = [];
const LS_DR_NOTES_LIST = 'evdeSaglikDrNotesList_V1';
let drNotesList = [];
let selectedDrColor = 'blue';

let appPassword = atob(localStorage.getItem(LS_APP_PASSWORD_ENC) || 'OTMwNjE4MA==');
// --- YENÄ° EKLENENLER: Sekme Kilit AyarlarÄ± ---
const LS_LOCKED_TABS_CONFIG = 'evdeSaglikLockedTabsConfig_V1';
const LS_TAB_LOCK_PASS_CUSTOM = 'evdeSaglikTabLockPassCustom_V1';

// VarsayÄ±lan kilitli sekmeler (ArtÄ±k kullanÄ±cÄ± bazlÄ±, baÅŸlangÄ±Ã§ta boÅŸ)
window.lockedTabsConfig = [];
window.unlockedSessionTabs = {};
// VarsayÄ±lan ÅŸifre (0000)
let customTabPassword = '0000';
// --- YENÄ°: YÃ¶netim Paneli Åifresi ---
// VarsayÄ±lan olarak '1234' olsun, sonra deÄŸiÅŸtirirsin
let adminPanelPassword = '1234';
const LS_ADMIN_PASS = 'evdeSaglikAdminPass_V1';
// --- YENÄ°: AÃ§Ä±lÄ±ÅŸ Kilidi AyarÄ± ---
const LS_STARTUP_LOCK_ENABLED = 'evdeSaglikStartupLock_V1';
let startupLockEnabled = true; // VarsayÄ±lan olarak aÃ§Ä±k olsun

const days = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'];
const monthsTR = ["OCAK", "ÅUBAT", "MART", "NÄ°SAN", "MAYIS", "HAZÄ°RAN", "TEMMUZ", "AÄUSTOS", "EYLÃœL", "EKÄ°M", "KASIM", "ARALIK"];

const defaultStaff = [{ name: "Okan Ay", role: "Evde SaÄŸlÄ±k Teknikeri" }, { name: "Mehmet Akkurt", role: "Evde SaÄŸlÄ±k Teknikeri" }, { name: "Atalay DurmuÅŸ", role: "HemÅŸire" }, { name: "Ã–zgÃ¼r Ã–zpek", role: "HemÅŸire" }, { name: "GÃ¼ndem Yakan Åahin", role: "HemÅŸire" }, { name: "Ä°lkay CoÅŸgun", role: "HemÅŸire" }, { name: "AyÅŸegÃ¼l Arda", role: "HemÅŸire" }, { name: "GÃ¼lin Tetik", role: "HemÅŸire" }];
const defaultDoctors = [{ name: "Dr. AyÃ§a Asma SakallÄ±" }, { name: "Dr. Erdal Elmas" }];
const defaultProcs = ["Pansuman", "Tetkik", "Sonda", "Enjeksiyon", "NG", "SÃ¼tÃ¼r Alma"];
const defaultSpecialists = ["Diyabet HemÅŸiresi", "Beslenme HemÅŸiresi", "Fizyoterapist", "Psikolog", "Sosyal Hizmet UzmanÄ±", "Diyetisyen"];
const defaultTeams = ["Nakil AracÄ±", "Evde SaÄŸlÄ±k 1", "Evde SaÄŸlÄ±k 2"];

let staffList = [], doctorList = [], procList = [], specialistList = [], quickList = [], teamList = [], routineList = [], budgetList = [], emergencyList = [];
let emergencyBags = ["Ana Ã‡anta"];
let currentBag = "Ana Ã‡anta";
let leaveRecords = [], doctorLeaveRecords = [], allRecords = {}, docRecords = {}, allNotes = {};
let umkeRecords = []; // UMKE gÃ¶rev kayÄ±tlarÄ±

let currentWeekStart = new Date();
let isEditing = false;
let apiKey = "";

// GLOBAL ACTIONS
window.deleteLeaveRecord = async (idx) => {
// Admin kontrolÃ¼
if (currentUserRole !== 'admin') {
showToast('Bu iÅŸlem iÃ§in admin yetkisi gereklidir!', 'error');
return;
}

if (!confirm('Bu kaydÄ± silmek istediÄŸinize emin misiniz?')) return;

const leave = leaveRecords[idx];
const deletedItem = leave ? `${leave.staffName} (${leave.type})` : 'Ä°zin/Rapor';

leaveRecords.splice(idx, 1);
await saveAll();
renderMgmtLists();
populateFilters();
renderLeaveRecords();
renderUI();
showToast('KayÄ±t Silindi');
addActivityLog('leave', 'KayÄ±t silindi', deletedItem);
};

// Personel izin/rapor dÃ¼zenleme
window.editLeaveRecord = function(idx) {
if (currentUserRole !== 'admin') {
showToast('Bu iÅŸlem iÃ§in admin yetkisi gereklidir!', 'error');
return;
}
const record = leaveRecords[idx];
if (!record) return;

// Form alanlarÄ±nÄ± doldur
document.getElementById('leave-staff-input').value = record.staffName || '';
document.getElementById('leave-type-select').value = record.type || 'Rapor';
document.getElementById('leave-start-date').value = record.startDate || '';
document.getElementById('leave-end-date').value = record.endDate || '';

// Eski kaydÄ± sil
leaveRecords.splice(idx, 1);
saveAll();
renderLeaveRecords();

// Forma scroll yap ve vurgula
const form = document.getElementById('leave-add-form');
if (form) {
form.scrollIntoView({ behavior: 'smooth', block: 'center' });
form.classList.add('ring-2', 'ring-orange-500');
setTimeout(() => form.classList.remove('ring-2', 'ring-orange-500'), 2000);
}
showToast('KaydÄ± dÃ¼zenleyip tekrar ekleyin', 'info');
};

window.remItem = async (type, idx) => {
if (!confirm('Bu kaydÄ± silmek istediÄŸinize emin misiniz?')) return;

// Silinen Ã¶ÄŸeyi loglama iÃ§in sakla
let deletedItem = '';
let logType = 'general';

if (type === 'staff') { deletedItem = staffList[idx]?.name || 'Personel'; logType = 'staff'; staffList.splice(idx, 1); }
else if (type === 'doc') { deletedItem = doctorList[idx]?.name || 'Doktor'; logType = 'doctor'; doctorList.splice(idx, 1); }
else if (type === 'proc') { deletedItem = procList[idx] || 'Ä°ÅŸlem'; logType = 'procedure'; procList.splice(idx, 1); }
else if (type === 'spec') { deletedItem = specialistList[idx] || 'UzmanlÄ±k'; logType = 'specialist'; specialistList.splice(idx, 1); }
else if (type === 'leave') {
const leave = leaveRecords[idx];
deletedItem = leave ? `${leave.staffName} (${leave.type})` : 'Ä°zin/Rapor';
logType = 'leave';
leaveRecords.splice(idx, 1);
}
else if (type === 'team') { deletedItem = teamList[idx] || 'Ekip'; logType = 'team'; teamList.splice(idx, 1); }

await saveAll(); renderMgmtLists(); populateFilters(); renderLeaveRecords(); renderUI(); showToast('KayÄ±t Silindi');

// Aktivite logu ekle
addActivityLog(logType, 'KayÄ±t silindi', deletedItem);
};

window.moveItem = async (type, idx, dir) => {
let list;
if (type === 'staff') list = staffList;
else if (type === 'doc') list = doctorList;
else if (type === 'proc') list = procList;
else if (type === 'spec') list = specialistList;
else if (type === 'team') list = teamList;
const newIdx = idx + dir;
if (newIdx < 0 || newIdx >= list.length) return;
[list[idx], list[newIdx]] = [list[newIdx], list[idx]];
await saveAll(); renderMgmtLists();
};

window.toggleStaffInDocList = async (staffName, isChecked) => {
if (isChecked) { if (!doctorList.some(d => d.name === staffName)) doctorList.push({ name: staffName }); }
else { const idx = doctorList.findIndex(d => d.name === staffName); if (idx > -1) doctorList.splice(idx, 1); }
await saveAll(); renderMgmtLists();
};

window.addQuickItem = async () => {
const input = document.getElementById('new-quick-name');
const name = input.value.trim();
if (name) {
if (staffList.some(s => s.name === name) || quickList.includes(name)) { showToast('Bu isim zaten listede var', 'error'); return; }
quickList.push(name); input.value = ''; await saveAll(); renderMgmtLists(); showToast('HÄ±zlÄ± listeye eklendi');
}
};

window.remQuickItem = async (idx) => {
if (!confirm('Bu ismi hÄ±zlÄ± listeden silmek istiyor musunuz?')) return;
quickList.splice(idx, 1); await saveAll(); renderMgmtLists();
};

function getLocalDateString(date) {
const y = date.getFullYear(); const m = String(date.getMonth() + 1).padStart(2, '0'); const d = String(date.getDate()).padStart(2, '0'); return `${y}-${m}-${d}`;
}

window.onload = () => {
loadAll();
loadReminders();
setWeekToMonday(new Date());
setupEventListeners();
updateLockUI();
populateFilters();

if (typeof renderRoutines === 'function') renderRoutines();

const t = new Date();
const todayStr = getLocalDateString(t);
const currentDay = t.getDate();
const currentMonth = t.getMonth();
const currentYear = t.getFullYear();

// Hasta Takip varsayÄ±lan sekmeyse global-date-nav'Ä± gizle
const globalNav = document.getElementById('global-date-nav');
if (globalNav) {
globalNav.classList.add('hidden');
}

let budgetStart, budgetEnd;
if (currentDay >= 15) {
budgetStart = new Date(currentYear, currentMonth, 15);
budgetEnd = new Date(currentYear, currentMonth + 1, 14);
} else {
budgetStart = new Date(currentYear, currentMonth - 1, 15);
budgetEnd = new Date(currentYear, currentMonth, 14);
}

const elBStart = document.getElementById('budget-start-date');
const elBEnd = document.getElementById('budget-end-date');
// Bu elemanlar HTML'de yoksa hata vermesin diye kontrol:
if (elBStart) elBStart.value = getLocalDateString(budgetStart);
if (elBEnd) elBEnd.value = getLocalDateString(budgetEnd);

const elBEntry = document.getElementById('budget-entry-date');
if (elBEntry) elBEntry.value = todayStr;

if (typeof renderBudgetHeader === 'function') renderBudgetHeader();
else if (typeof renderBudget === 'function') renderBudget();

const elStart = document.getElementById('analysis-start');
const elEnd = document.getElementById('analysis-end');
if (elStart) elStart.value = getLocalDateString(new Date(currentYear, currentMonth, 1));
if (elEnd) elEnd.value = getLocalDateString(new Date(currentYear, currentMonth + 1, 0));

if (document.getElementById('leave-start-date')) {
document.getElementById('leave-start-date').value = todayStr;
document.getElementById('leave-end-date').value = todayStr;
// --- Ä°zin Tarihleri AyarÄ± ---
if (document.getElementById('leave-start-date')) {
document.getElementById('leave-start-date').value = todayStr;
document.getElementById('leave-end-date').value = todayStr;
} // Eksik parantez dÃ¼zeltildi
// --- GÃœVENLÄ°K VE AÃ‡ILIÅ KÄ°LÄ°DÄ° MANTIÄI ---
// NOT: Kilit kontrolÃ¼ artÄ±k auth baÅŸarÄ±lÄ± olduktan sonra yapÄ±lÄ±yor (satÄ±r ~1660)
// Eski auto-lock-screen sistemi devre dÄ±ÅŸÄ±, yeni lock-screen-modal kullanÄ±lÄ±yor
}; // <-- Bu sÃ¼slÃ¼ parantez muhtemelen DOMContentLoaded veya init fonksiyonunun kapanÄ±ÅŸÄ±, silme.

if (typeof lucide !== 'undefined') lucide.createIcons();
renderReminderProcs();

// ğŸ‚ DOÄUM GÃœNÃœ BÄ°LDÄ°RÄ°MÄ° KONTROLÃœ - Sayfa yÃ¼klendiÄŸinde yarÄ±n doÄŸum gÃ¼nÃ¼ olanlarÄ± bildir
setTimeout(() => {
if (typeof checkBirthdayNotifications === 'function') {
checkBirthdayNotifications();
}
}, 5000); // 5 saniye gecikme - veriler yÃ¼klendikten sonra
};

function loadAll() {
try { deviceList = JSON.parse(localStorage.getItem(LS_DEVICES)) || []; } catch { deviceList = []; }
try { shiftList = JSON.parse(localStorage.getItem(LS_SHIFTS)) || []; } catch { shiftList = []; }
try { generalNotesList = JSON.parse(localStorage.getItem(LS_GENERAL_NOTES_LIST)) || []; } catch { generalNotesList = []; }
try { allRecords = JSON.parse(localStorage.getItem(LS_DATA)) || {}; } catch { allRecords = {}; }
try { docRecords = JSON.parse(localStorage.getItem(LS_DOC_DATA)) || {}; } catch { docRecords = {}; }
try { const s = JSON.parse(localStorage.getItem(LS_STAFF)); staffList = (s && s.length) ? s : [...defaultStaff]; } catch { staffList = [...defaultStaff]; }
try { const d = JSON.parse(localStorage.getItem(LS_DOCTORS)); doctorList = (d && d.length) ? d : [...defaultDoctors]; } catch { doctorList = [...defaultDoctors]; }
try { const p = JSON.parse(localStorage.getItem(LS_PROCS)); procList = (p && p.length) ? p : [...defaultProcs]; } catch { procList = [...defaultProcs]; }
try { const sp = JSON.parse(localStorage.getItem(LS_SPECIALISTS_LIST)); specialistList = (sp && sp.length) ? sp : [...defaultSpecialists]; } catch { specialistList = [...defaultSpecialists]; }
try { const q = JSON.parse(localStorage.getItem(LS_QUICK_LIST)); quickList = (q && q.length) ? q : []; } catch { quickList = []; }
try { const t = JSON.parse(localStorage.getItem(LS_TEAMS)); teamList = (t && t.length) ? t : [...defaultTeams]; } catch { teamList = [...defaultTeams]; }
try { const l = JSON.parse(localStorage.getItem(LS_LEAVE_RECORDS)); leaveRecords = (l && l.length) ? l : []; } catch { leaveRecords = []; }
try { const dl = JSON.parse(localStorage.getItem('evdeSaglikDoctorLeaves_V1')); doctorLeaveRecords = (dl && dl.length) ? dl : []; } catch { doctorLeaveRecords = []; }
try { allNotes = JSON.parse(localStorage.getItem(LS_NOTES)) || {}; } catch { allNotes = {}; }
try { routineList = JSON.parse(localStorage.getItem(LS_ROUTINES)) || []; } catch { routineList = []; }
try { budgetList = JSON.parse(localStorage.getItem(LS_BUDGET)) || []; } catch { budgetList = []; }
try {
emergencyBags = JSON.parse(localStorage.getItem(LS_BAGS));
if (!emergencyBags || emergencyBags.length === 0) emergencyBags = ["Ana Ã‡anta"];
} catch { emergencyBags = ["Ana Ã‡anta"]; }
try { emergencyList = JSON.parse(localStorage.getItem(LS_EMERGENCY)) || []; } catch { emergencyList = []; }

emergencyList.forEach(item => { if (!item.bagName) item.bagName = "Ana Ã‡anta"; });
// Sekme Kilit AyarlarÄ±nÄ± YÃ¼kle
try { lockedTabsConfig = JSON.parse(localStorage.getItem(LS_LOCKED_TABS_CONFIG)) || []; } catch { lockedTabsConfig = []; }
try { customTabPassword = localStorage.getItem(LS_TAB_LOCK_PASS_CUSTOM) || '0000'; } catch { customTabPassword = '0000'; }
// AÃ§Ä±lÄ±ÅŸ Kilidi AyarÄ±nÄ± YÃ¼kle
try {
let val = localStorage.getItem(LS_STARTUP_LOCK_ENABLED);
startupLockEnabled = (val === null) ? true : JSON.parse(val);
} catch { startupLockEnabled = true; }
// YÃ¶netim Åifresini YÃ¼kle
try { adminPanelPassword = localStorage.getItem(LS_ADMIN_PASS) || '1234'; } catch { adminPanelPassword = '1234'; }
loadPhonebook(); //
}

// Firebase key'leri iÃ§in Ã¶zel karakterleri dÃ¶nÃ¼ÅŸtÃ¼r
function sanitizeFirebaseKey(str) {
return str.replace(/\./g, '_DOT_')
.replace(/#/g, '_HASH_')
.replace(/\$/g, '_DOLLAR_')
.replace(/\//g, '_SLASH_')
.replace(/\[/g, '_LBRACKET_')
.replace(/\]/g, '_RBRACKET_');
}

function unsanitizeFirebaseKey(str) {
return str.replace(/_DOT_/g, '.')
.replace(/_HASH_/g, '#')
.replace(/_DOLLAR_/g, '$')
.replace(/_SLASH_/g, '/')
.replace(/_LBRACKET_/g, '[')
.replace(/_RBRACKET_/g, ']');
}

// docRecords'u Firebase iÃ§in gÃ¼venli formata dÃ¶nÃ¼ÅŸtÃ¼r
function sanitizeDocRecordsForFirebase(records) {
const sanitized = {};
Object.keys(records).forEach(date => {
sanitized[date] = {};
Object.keys(records[date]).forEach(docName => {
const safeKey = sanitizeFirebaseKey(docName);
sanitized[date][safeKey] = records[date][docName];
});
});
return sanitized;
}

// Firebase'den gelen docRecords'u orijinal formata dÃ¶nÃ¼ÅŸtÃ¼r
function unsanitizeDocRecordsFromFirebase(records) {
if (!records) return {};
const unsanitized = {};
Object.keys(records).forEach(date => {
unsanitized[date] = {};
Object.keys(records[date]).forEach(safeKey => {
const originalName = unsanitizeFirebaseKey(safeKey);
unsanitized[date][originalName] = records[date][safeKey];
});
});
return unsanitized;
}

async function saveAll() {
// TÃ¼m Firebase kaydetme iÅŸlemlerini paralel olarak Ã§alÄ±ÅŸtÄ±r
// docRecords iÃ§in Ã¶zel karakterleri dÃ¶nÃ¼ÅŸtÃ¼r
const safeDocRecords = sanitizeDocRecordsForFirebase(docRecords);

await Promise.all([
FirebaseStorage.setItem(LS_DEVICES, JSON.stringify(deviceList)),
FirebaseStorage.setItem(LS_SHIFTS, JSON.stringify(shiftList)),
FirebaseStorage.setItem(LS_DATA, JSON.stringify(allRecords)),
FirebaseStorage.setItem(LS_DOC_DATA, JSON.stringify(safeDocRecords)),
FirebaseStorage.setItem(LS_STAFF, JSON.stringify(staffList)),
FirebaseStorage.setItem(LS_DOCTORS, JSON.stringify(doctorList)),
FirebaseStorage.setItem(LS_PROCS, JSON.stringify(procList)),
FirebaseStorage.setItem(LS_SPECIALISTS_LIST, JSON.stringify(specialistList)),
FirebaseStorage.setItem(LS_QUICK_LIST, JSON.stringify(quickList)),
FirebaseStorage.setItem(LS_TEAMS, JSON.stringify(teamList)),
FirebaseStorage.setItem(LS_LEAVE_RECORDS, JSON.stringify(leaveRecords)),
FirebaseStorage.setItem(LS_NOTES, JSON.stringify(allNotes)),
FirebaseStorage.setItem(LS_EMERGENCY, JSON.stringify(emergencyList)),
FirebaseStorage.setItem(LS_BAGS, JSON.stringify(emergencyBags)),
FirebaseStorage.setItem(LS_BUDGET, JSON.stringify(budgetList)),
FirebaseStorage.setItem(LS_GENERAL_NOTES_LIST, JSON.stringify(generalNotesList)),
FirebaseStorage.setItem(LS_PHONEBOOK, JSON.stringify(phonebookList)),
// YENÄ°LER
FirebaseStorage.setItem(LS_LOCKED_TABS_CONFIG, JSON.stringify(lockedTabsConfig)),
FirebaseStorage.setItem(LS_TAB_LOCK_PASS_CUSTOM, customTabPassword),
FirebaseStorage.setItem(LS_STARTUP_LOCK_ENABLED, JSON.stringify(startupLockEnabled)),
FirebaseStorage.setItem(LS_ADMIN_PASS, adminPanelPassword)
]);

renderUI(); populateFilters();
}

// HELPER FUNCTIONS
function safeGet(id) { const el = document.getElementById(id); return el; }
async function openSettingsModal() {
safeGet('settings-modal').classList.remove('hidden');
safeGet('settings-modal').classList.add('flex');
safeGet('api-key-input').value = localStorage.getItem(LS_API_KEY) || '';

// Telegram ayarlarÄ±nÄ± yÃ¼kle
const token = getTelegramToken();
console.log('OpenSettings - Telegram YÃ¼kleme:', {
token: token ? 'VAR (' + token.substring(0, 10) + '...)' : 'YOK',
lsToken: localStorage.getItem('evdeSaglik_TelegramToken') ? 'VAR' : 'YOK',
oldToken: localStorage.getItem('telegram_bot_token') ? 'VAR' : 'YOK'
});

safeGet('telegram-bot-token').value = token || '';

// Bildirim tercihlerini yÃ¼kle
loadTelegramNotifyPrefs();

// Chat ID listesini yÃ¼kle
renderTelegramChatIdList();

if (typeof lucide !== 'undefined') lucide.createIcons();
}
function closeSettingsModal() { safeGet('settings-modal').classList.add('hidden'); safeGet('settings-modal').classList.remove('flex'); }
function saveApiKey() { const key = safeGet('api-key-input').value.trim(); if (key) { FirebaseStorage.setItem(LS_API_KEY, key); showToast('API AnahtarÄ± kaydedildi.'); closeSettingsModal(); } else showToast('LÃ¼tfen geÃ§erli bir anahtar girin.', 'error'); }

// Telegram Bot Entegrasyonu
const TELEGRAM_TOKEN_KEY = 'evdeSaglik_TelegramToken';
const TELEGRAM_CHAT_KEY = 'evdeSaglik_TelegramChatId';

// Eski key'lerden yeni key'lere migration
function getTelegramToken() {
let token = localStorage.getItem(TELEGRAM_TOKEN_KEY);
if (!token) {
// Eski key'den oku ve migrate et
token = localStorage.getItem('telegram_bot_token');
if (token) {
localStorage.setItem(TELEGRAM_TOKEN_KEY, token);
}
}
return token;
}
function getTelegramChatId() {
let chatId = localStorage.getItem(TELEGRAM_CHAT_KEY);
if (!chatId) {
// Eski key'den oku ve migrate et
chatId = localStorage.getItem('telegram_chat_id');
if (chatId) {
localStorage.setItem(TELEGRAM_CHAT_KEY, chatId);
}
}
return chatId;
}

// ===== Ã‡OKLU TELEGRAM CHAT ID SÄ°STEMÄ° (Firebase Senkronize) =====
// Yeni format: [{id, name, categories: [...]}]

// Chat ID listesini Firebase'den al
async function getTelegramChatIds() {
try {
const snapshot = await database.ref('evde_saglik_ortak_veri/settings/telegram_chat_ids').once('value');
const data = snapshot.val() || [];
// Eski format (string array) -> yeni format (object array) migration
if (data.length > 0 && typeof data[0] === 'string') {
const migrated = data.map(id => ({ id, name: '', categories: ['all'] }));
await saveTelegramChatIds(migrated);
return migrated;
}
return data;
} catch (e) {
console.error('Chat ID yÃ¼kleme hatasÄ±:', e);
return [];
}
}

// Chat ID listesini Firebase'e kaydet
async function saveTelegramChatIds(recipients) {
try {
await database.ref('evde_saglik_ortak_veri/settings/telegram_chat_ids').set(recipients);
} catch (e) {
console.error('Chat ID kaydetme hatasÄ±:', e);
}
}

// Yeni Chat ID ekle
async function addTelegramChatId() {
const nameInput = document.getElementById('new-telegram-chat-name');
const idInput = document.getElementById('new-telegram-chat-id');
const newName = nameInput?.value.trim() || '';
const newId = idInput?.value.trim();

if (!newId) {
showToast('Chat ID boÅŸ olamaz!', 'error');
return;
}

const recipients = await getTelegramChatIds();

if (recipients.some(r => r.id === newId)) {
showToast('Bu Chat ID zaten ekli!', 'error');
return;
}

recipients.push({
id: newId,
name: newName || 'KullanÄ±cÄ±',
categories: ['all'] // VarsayÄ±lan: tÃ¼m bildirimler
});

await saveTelegramChatIds(recipients);
if (nameInput) nameInput.value = '';
if (idInput) idInput.value = '';
await renderTelegramChatIdList();
showToast('AlÄ±cÄ± eklendi!', 'success');
}

// Chat ID sil
async function removeTelegramChatId(id) {
let recipients = await getTelegramChatIds();
recipients = recipients.filter(r => r.id !== id);
await saveTelegramChatIds(recipients);
await renderTelegramChatIdList();
showToast('AlÄ±cÄ± silindi!');
}

// Chat ID bilgilerini gÃ¼ncelle
async function updateTelegramRecipient(id, name, categories) {
let recipients = await getTelegramChatIds();
const index = recipients.findIndex(r => r.id === id);
if (index !== -1) {
recipients[index].name = name;
recipients[index].categories = categories;
await saveTelegramChatIds(recipients);
showToast('AlÄ±cÄ± gÃ¼ncellendi!');
}
}

// Kategori deÄŸiÅŸikliÄŸini kaydet
async function toggleRecipientCategory(id, category) {
let recipients = await getTelegramChatIds();
const recipient = recipients.find(r => r.id === id);
if (!recipient) return;

// 'all' Ã¶zel durumu
if (category === 'all') {
recipient.categories = ['all'];
} else {
// 'all' varsa kaldÄ±r ve yeni kategori ekle
if (recipient.categories.includes('all')) {
recipient.categories = [category];
} else if (recipient.categories.includes(category)) {
// Kategori varsa kaldÄ±r
recipient.categories = recipient.categories.filter(c => c !== category);
if (recipient.categories.length === 0) recipient.categories = ['all'];
} else {
// Kategori yoksa ekle
recipient.categories.push(category);
}
}

await saveTelegramChatIds(recipients);
await renderTelegramChatIdList();
}

// Ä°sim dÃ¼zenleme
async function editRecipientName(id) {
const recipients = await getTelegramChatIds();
const recipient = recipients.find(r => r.id === id);
if (!recipient) return;

const newName = prompt('Yeni isim girin:', recipient.name);
if (newName !== null && newName.trim() !== '') {
recipient.name = newName.trim();
await saveTelegramChatIds(recipients);
await renderTelegramChatIdList();
showToast('Ä°sim gÃ¼ncellendi!');
}
}

// Chat ID listesini render et
async function renderTelegramChatIdList() {
const container = document.getElementById('telegram-chat-id-list');
if (!container) return;

const recipients = await getTelegramChatIds();

if (recipients.length === 0) {
container.innerHTML = '<p class="text-xs text-gray-400 text-center py-2">HenÃ¼z alÄ±cÄ± eklenmemiÅŸ</p>';
return;
}

const categoryLabels = {
'all': 'ğŸ”” TÃ¼mÃ¼',
'tomorrow': 'ğŸ“… YarÄ±nki',
'emergency': 'ğŸ§° SKT',
'shift': 'ğŸ“‹ NÃ¶bet',
'birthday': 'ğŸ‚ DoÄŸum',
'leave': 'ğŸ–ï¸ Ä°zin',
'doctor': 'ğŸ‘¨â€âš•ï¸ Doktor',
'islemplanla': 'ğŸ“‹ Talep'
};

container.innerHTML = recipients.map(r => {
const catButtons = Object.entries(categoryLabels).map(([key, label]) => {
const isActive = r.categories && (r.categories.includes('all') || r.categories.includes(key));
const emoji = label.split(' ')[0];
const text = label.split(' ').slice(1).join(' ');
const activeClass = isActive
? 'bg-green-100 text-green-700 border-green-400 font-semibold'
: 'bg-gray-50 text-gray-500 border-gray-200 hover:bg-gray-100';
const checkmark = isActive ? 'âœ“ ' : '';
return `<button onclick="toggleRecipientCategory('${r.id}', '${key}')"
class="text-[10px] px-2 py-1 rounded-lg border-2 ${activeClass} transition-all duration-200 flex items-center gap-0.5"
title="${label}">${checkmark}${emoji}</button>`;
}).join('');

return `
<div class="bg-gray-50 rounded-lg border p-2 mb-2">
<div class="flex items-center justify-between mb-1">
<div class="flex items-center gap-2">
<span class="font-bold text-sm text-gray-800">${r.name || 'KullanÄ±cÄ±'}</span>
<button onclick="editRecipientName('${r.id}')" class="text-blue-500 hover:text-blue-700 p-0.5" title="Ä°smi DÃ¼zenle">
<i data-lucide="edit-2" class="w-3 h-3"></i>
</button>
</div>
<button onclick="removeTelegramChatId('${r.id}')" class="text-red-500 hover:text-red-700 p-1" title="Sil">
<i data-lucide="trash-2" class="w-4 h-4"></i>
</button>
</div>
<div class="text-[10px] text-gray-500 font-mono mb-2">ID: ${r.id}</div>
<div class="text-[10px] text-gray-600 mb-1 font-medium">ğŸ“Œ Bildirim Kategorileri:</div>
<div class="flex flex-wrap gap-1">${catButtons}</div>
</div>
`;
}).join('');

if (typeof lucide !== 'undefined') lucide.createIcons();
}

async function saveAllSettings() {
try {
// API Key kaydet
const apiKey = safeGet('api-key-input').value.trim();
if (apiKey) FirebaseStorage.setItem(LS_API_KEY, apiKey);

// Telegram Bot Token kaydet (Chat ID'ler artÄ±k ayrÄ± olarak Firebase'de saklanÄ±yor)
const botToken = safeGet('telegram-bot-token').value.trim();

// Ã–nce localStorage'a kaydet (garantili Ã§alÄ±ÅŸÄ±r)
localStorage.setItem(TELEGRAM_TOKEN_KEY, botToken);

// Sonra Firebase'e de kaydet (async)
if (botToken) {
await FirebaseStorage.setItem(TELEGRAM_TOKEN_KEY, botToken);
}

// Bildirim tercihlerini kaydet
saveTelegramNotifyPrefs();

showToast('TÃ¼m ayarlar kaydedildi!', 'success');
closeSettingsModal();
} catch (error) {
console.error('Ayar kaydetme hatasÄ±:', error);
showToast('Ayarlar kaydedilirken hata oluÅŸtu!', 'error');
}
}

// Bildirim tercihleri fonksiyonlarÄ±
const TELEGRAM_PREFS_KEY = 'telegram_notify_prefs';
const NOTIFY_CATEGORIES = ['tomorrow', 'emergency', 'shift', 'birthday', 'leave', 'doctor', 'islemplanla'];

function saveTelegramNotifyPrefs() {
const prefs = {};
NOTIFY_CATEGORIES.forEach(cat => {
const checkbox = document.getElementById(`tg-notify-${cat}`);
prefs[cat] = checkbox ? checkbox.checked : true;
});
localStorage.setItem(TELEGRAM_PREFS_KEY, JSON.stringify(prefs));
}

function loadTelegramNotifyPrefs() {
try {
const saved = localStorage.getItem(TELEGRAM_PREFS_KEY);
const prefs = saved ? JSON.parse(saved) : {};
NOTIFY_CATEGORIES.forEach(cat => {
const checkbox = document.getElementById(`tg-notify-${cat}`);
if (checkbox) checkbox.checked = prefs[cat] !== false; // varsayÄ±lan true
});
} catch (e) { console.error('Bildirim tercihleri yÃ¼klenemedi:', e); }
}

function isTelegramNotifyEnabled(category) {
try {
const saved = localStorage.getItem(TELEGRAM_PREFS_KEY);
if (!saved) return true; // varsayÄ±lan aktif
const prefs = JSON.parse(saved);
return prefs[category] !== false;
} catch (e) { return true; }
}

// ğŸ‚ YARIN DOÄUM GÃœNÃœ KONTROLÃœ - Sayfa yÃ¼klendiÄŸinde Ã§aÄŸrÄ±lÄ±r
async function checkBirthdayNotifications() {
if (!isTelegramNotifyEnabled('birthday')) return;

// BugÃ¼n zaten bildirim gÃ¶nderilmiÅŸ mi kontrol et (gÃ¼nde 1 kez)
const today = new Date().toISOString().slice(0, 10);
const lastBirthdayCheck = localStorage.getItem('lastBirthdayCheck');
if (lastBirthdayCheck === today) {
return;
}

const tomorrow = new Date();
tomorrow.setDate(tomorrow.getDate() + 1);
const tomorrowMonth = String(tomorrow.getMonth() + 1).padStart(2, '0');
const tomorrowDay = String(tomorrow.getDate()).padStart(2, '0');

const birthdayPeople = [];

// staffList'te doÄŸum gÃ¼nÃ¼ kontrolÃ¼
if (typeof staffList !== 'undefined' && Array.isArray(staffList)) {
staffList.forEach(s => {
if (s.birthday) {
// birthday formatÄ±: YYYY-MM-DD
const bday = s.birthday.slice(5); // MM-DD formatÄ±
if (bday === `${tomorrowMonth}-${tomorrowDay}`) {
birthdayPeople.push({ name: s.name, type: 'Personel' });
}
}
});
}

if (birthdayPeople.length > 0) {
const names = birthdayPeople.map(p => `ğŸ‚ ${p.name} (${p.type})`).join('\n');
const message = `ğŸ‚ YARIN DOÄUM GÃœNÃœ!\n\n${names}\n\nğŸ‰ HatÄ±rlatma: YarÄ±n kutlamayÄ± unutmayÄ±n!`;
await sendTelegramMessage(message, 'birthday');

// Bu gÃ¼nÃ¼ iÅŸaretle
localStorage.setItem('lastBirthdayCheck', today);
}
}

async function sendTelegramMessage(message, category = 'all') {
const botToken = getTelegramToken();
const recipients = await getTelegramChatIds();

console.log('Telegram Bildirim Debug:', {
token: botToken ? 'MEVCUT (' + botToken.substring(0, 10) + '...)' : 'YOK',
recipientCount: recipients.length,
category: category,
message: message.substring(0, 50) + '...'
});

if (!botToken || recipients.length === 0) {
return false;
}

// Kategori bazÄ±nda alÄ±cÄ±larÄ± filtrele
const filteredRecipients = recipients.filter(r => {
// Debug log

// EÄŸer gÃ¶nderen 'all' kategorisi ile Ã§aÄŸÄ±rdÄ±ysa - herkese gÃ¶nder!
if (category === 'all') {
return true;
}

// Categories array yoksa veya geÃ§ersizse - tÃ¼m bildirimleri alsÄ±n
if (!r.categories || !Array.isArray(r.categories) || r.categories.length === 0) {
return true;
}

// 'all' kategorisi tÃ¼m bildirimleri alÄ±r
if (r.categories.includes('all')) {
return true;
}

// Belirli kategori kontrolÃ¼
if (r.categories.includes(category)) {
return true;
}

return false;
});

if (filteredRecipients.length === 0) {
return false;
}

let successCount = 0;

// FiltrelenmiÅŸ alÄ±cÄ±lara mesaj gÃ¶nder
for (const recipient of filteredRecipients) {
const chatId = recipient.id || recipient; // Eski/yeni format uyumu
try {
const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
const response = await fetch(url, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
chat_id: chatId,
text: message,
parse_mode: 'HTML'
})
});
const data = await response.json();
if (data.ok) successCount++;
} catch (error) {
console.error(`Telegram mesaj hatasÄ± (${recipient.name || chatId}):`, error);
}
}

return successCount > 0;
}

async function testTelegramConnection() {
const botToken = safeGet('telegram-bot-token').value.trim();
const recipients = await getTelegramChatIds();

if (!botToken) {
showToast('LÃ¼tfen Bot Token girin!', 'error');
return;
}

if (recipients.length === 0) {
showToast('LÃ¼tfen en az bir alÄ±cÄ± ekleyin!', 'error');
return;
}

showToast('Test mesajlarÄ± gÃ¶nderiliyor...', 'info');

// Token'Ä± kaydet
localStorage.setItem(TELEGRAM_TOKEN_KEY, botToken);
FirebaseStorage.setItem(TELEGRAM_TOKEN_KEY, botToken);

let successCount = 0;

// TÃ¼m alÄ±cÄ±lara test mesajÄ± gÃ¶nder
for (const recipient of recipients) {
const chatId = recipient.id || recipient; // Nesne veya string uyumu
const recipientName = recipient.name || chatId;
try {
const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
const response = await fetch(url, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
chat_id: chatId,
text: `ğŸ¥ <b>Evde SaÄŸlÄ±k Sistemi</b>\n\nâœ… Telegram baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±!\nğŸ‘¤ AlÄ±cÄ±: ${recipientName}\nKritik uyarÄ±lar bu sohbete gÃ¶nderilecek.`,
parse_mode: 'HTML'
})
});
const data = await response.json();
if (data.ok) {
successCount++;
} else {
console.error(`âŒ Test baÅŸarÄ±sÄ±z (${recipientName}):`, data.description);
}
} catch (error) {
console.error(`âŒ BaÄŸlantÄ± hatasÄ± (${recipientName}):`, error.message);
}
}

if (successCount === recipients.length) {
showToast(`âœ… TÃ¼m alÄ±cÄ±lara (${successCount}) baÅŸarÄ±yla gÃ¶nderildi!`, 'success');
} else if (successCount > 0) {
showToast(`âš ï¸ ${successCount}/${recipients.length} alÄ±cÄ±ya gÃ¶nderildi`, 'warning');
} else {
showToast('âŒ HiÃ§bir alÄ±cÄ±ya gÃ¶nderilemedi!', 'error');
}
}

function closeAiModal() { document.getElementById('ai-report-modal').classList.add('hidden'); document.getElementById('ai-report-modal').classList.remove('flex'); }
function openPwModal() { safeGet('change-pw-modal').classList.remove('hidden'); safeGet('change-pw-modal').classList.add('flex'); }
function closePwModal() { safeGet('change-pw-modal').classList.add('hidden'); safeGet('change-pw-modal').classList.remove('flex'); safeGet('old-pw').value = ''; safeGet('new-pw').value = ''; safeGet('new-pw-confirm').value = ''; safeGet('change-pw-error').classList.add('hidden'); }
// --- GÃœNCELLENMÄ°Å ÅÄ°FRE DEÄÄ°ÅTÄ°RME (MASKELÄ° KAYIT) ---
function saveNewPw() {
const old = safeGet('old-pw').value;
const nw = safeGet('new-pw').value;
const cf = safeGet('new-pw-confirm').value;
const err = safeGet('change-pw-error');

if (old !== appPassword) {
err.textContent = "Eski ÅŸifre hatalÄ±!";
err.classList.remove('hidden');
return;
}
if (nw.length < 4) {
err.textContent = "Yeni ÅŸifre en az 4 karakter olmalÄ±.";
err.classList.remove('hidden');
return;
}
if (nw !== cf) {
err.textContent = "Yeni ÅŸifreler eÅŸleÅŸmiyor!";
err.classList.remove('hidden');
return;
}

// Åifreyi deÄŸiÅŸkene ata
appPassword = nw;

// Åifreyi maskeleyerek (btoa) hafÄ±zaya kaydet
FirebaseStorage.setItem(LS_APP_PASSWORD_ENC, btoa(nw));

showToast('Åifre baÅŸarÄ±yla deÄŸiÅŸtirildi.');
closePwModal();
}

function populateFilters() {
// HTML'deki select gruplarÄ±nÄ± al
const docOpt = document.getElementById('filter-opt-doc');
const procOpt = document.getElementById('filter-opt-proc');
const specOpt = document.getElementById('filter-opt-spec');

// Ä°zin formu iÃ§in kiÅŸi Ã¶neri listesi
const staffDatalist = document.getElementById('staff-suggestions');

// EÄŸer bu elemanlar sayfada yoksa hata vermesin diye durduruyoruz
if (!docOpt || !procOpt || !specOpt) return;

// 1. DOKTOR SEÃ‡ENEKLERÄ°NÄ° SIFIRLA VE YENÄ°LE
// VarsayÄ±lan seÃ§enekleri korumak iÃ§in innerHTML'i Ã¶nce temizleyip sonra statik olanÄ± ekliyoruz
docOpt.innerHTML = '<option value="doc_counts">Sadece Hasta SayÄ±larÄ±</option>';
// Doktor listesindeki her iÅŸlem/prosedÃ¼r aslÄ±nda bir filtre olamaz,
// ama doktor verileri tablosunda filtreleme mantÄ±ÄŸÄ± farklÄ± iÅŸlediÄŸi iÃ§in burayÄ± sade bÄ±raktÄ±k.
// EÄŸer her doktora Ã¶zel filtre istersen buraya doktorList dÃ¶ngÃ¼sÃ¼ eklenebilir.

// 2. Ä°ÅLEM (PROSEDÃœR) SEÃ‡ENEKLERÄ°NÄ° SIFIRLA VE YENÄ°LE
procOpt.innerHTML = '';
procList.forEach(p => {
// Value baÅŸÄ±na 'proc_' ekliyoruz ki analiz yaparken bunun bir iÅŸlem olduÄŸunu anlayalÄ±m
procOpt.innerHTML += `<option value="proc_${p}">${p}</option>`;
});

// 3. UZMANLIK SEÃ‡ENEKLERÄ°NÄ° SIFIRLA VE YENÄ°LE
specOpt.innerHTML = '';
specialistList.forEach(s => {
// Value baÅŸÄ±na 'spec_' ekliyoruz ki analiz yaparken bunun bir uzmanlÄ±k olduÄŸunu anlayalÄ±m
specOpt.innerHTML += `<option value="spec_${s}">${s}</option>`;
});

// 4. Ä°ZÄ°N ALAN PERSONEL Ã–NERÄ° LÄ°STESÄ°NÄ° GÃœNCELLE
if (staffDatalist) {
const options = staffList.map(s => `<option value="${s.name}">`);

// HÄ±zlÄ± listedeki (dÄ±ÅŸarÄ±dan gelen) isimleri ekle
if (quickList && quickList.length > 0) {
quickList.forEach(q => {
// EÄŸer personel listesinde zaten varsa tekrar ekleme
if (!staffList.some(s => s.name === q)) options.push(`<option value="${q}">`);
});
}
staffDatalist.innerHTML = options.join('');
}
}

// --- GÃœNCELLENMÄ°Å IMPORT (GERÄ° YÃœKLEME - TAM KAPSAM) ---
function importData(e) {
if (!isEditing) {
showToast("YÃ¼kleme yapmak iÃ§in kilidi aÃ§malÄ±sÄ±nÄ±z.", "error");
e.target.value = '';
safeGet('lock-toggle')?.click();
return;
}

const file = e.target.files[0]; if (!file) return;
const reader = new FileReader();

reader.onload = function (e) {
const data = new Uint8Array(e.target.result);
const workbook = XLSX.read(data, { type: 'array' });

// 1. AYARLAR
if (workbook.SheetNames.includes("Ayarlar")) {
const configs = XLSX.utils.sheet_to_json(workbook.Sheets["Ayarlar"]);
const newStaff = [], newDocs = [], newProcs = [], newSpecs = [], newQuick = [], newTeams = [];
configs.forEach(c => {
if (c.Tip === 'Personel_Tanim') newStaff.push({ name: c.Deger1, role: c.Deger2 || 'Personel' });
if (c.Tip === 'Doktor_Tanim') newDocs.push({ name: c.Deger1 });
if (c.Tip === 'Islem_Tanim') newProcs.push(c.Deger1);
if (c.Tip === 'Uzman_Tanim') newSpecs.push(c.Deger1);
if (c.Tip === 'Hizli_Tanim') newQuick.push(c.Deger1);
if (c.Tip === 'Ekip_Tanim') newTeams.push(c.Deger1);
});
if (newStaff.length) staffList = newStaff;
if (newDocs.length) doctorList = newDocs;
if (newProcs.length) procList = newProcs;
if (newSpecs.length) specialistList = newSpecs;
if (newQuick.length) quickList = newQuick;
if (newTeams.length) teamList = newTeams;
}

// 2. Ä°ZÄ°NLER
if (workbook.SheetNames.includes("Izinler")) {
const leaves = XLSX.utils.sheet_to_json(workbook.Sheets["Izinler"]);
leaveRecords = leaves.map(l => ({ staffName: l.Personel, type: l.Tur, startDate: l.Baslangic, endDate: l.Bitis }));
}

// 3. PERSONEL VERÄ°LERÄ°
if (workbook.SheetNames.includes("Personel")) {
const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets["Personel"]);
jsonData.forEach(row => {
const date = row['Tarih']; const name = row['Personel'];
if (date && name) {
if (!allRecords[date]) allRecords[date] = {};
let specialists = [];
if (row['Specialists_JSON']) { try { specialists = JSON.parse(row['Specialists_JSON']); } catch (e) { specialists = []; } }
allRecords[date][name] = {
mm: parseInt(row['OOM'] || 0), mk: parseInt(row['OOK'] || 0), am: parseInt(row['OSM'] || 0), ak: parseInt(row['OSK'] || 0), e: parseInt(row['Muayene'] || 0), specialists: specialists
};
if (row['Not']) allNotes[date] = row['Not'];
}
});
}

// 4. DOKTOR VERÄ°LERÄ°
if (workbook.SheetNames.includes("Doktorlar")) {
const docData = XLSX.utils.sheet_to_json(workbook.Sheets["Doktorlar"]);
docData.forEach(row => {
const date = row['Tarih']; const docName = row['Doktor'];
if (date && docName) {
if (!docRecords[date]) docRecords[date] = {};
const procs = {};
procList.forEach(p => { if (row[p]) procs[p] = row[p]; });
docRecords[date][docName] = { pCount: row['Hasta_Sayisi'] || 0, procs: procs };
}
});
}

// 5. EKÄ°PLER
if (workbook.SheetNames.includes("Ekipler")) {
const teamData = XLSX.utils.sheet_to_json(workbook.Sheets["Ekipler"]);
teamData.forEach(row => {
const d = row['Tarih']; const t = row['Ekip']; const pStr = row['Personeller'];
if (d && t && pStr) {
if (!allRecords[d]) allRecords[d] = {};
if (!allRecords[d].teams) allRecords[d].teams = {};
allRecords[d].teams[t] = pStr.split(',').map(s => s.trim());
}
});
}

// 6. BÃœTÃ‡E
if (workbook.SheetNames.includes("Butce")) {
const rawBudget = XLSX.utils.sheet_to_json(workbook.Sheets["Butce"]);
if (rawBudget && rawBudget.length > 0) {
budgetList = rawBudget.map(r => ({
date: r.Tarih,
type: (r.Tur === 'Gelir' || r.Tur === 'income') ? 'income' : 'expense',
desc: r.Aciklama,
amount: r.Tutar,
note: r.Not || ''
}));
}
}

// 7. ACÄ°L Ã‡ANTA
if (workbook.SheetNames.includes("Acil_Canta")) {
const rawEm = XLSX.utils.sheet_to_json(workbook.Sheets["Acil_Canta"]);
if (rawEm && rawEm.length > 0) {
emergencyList = rawEm.map(r => ({
bagName: r.Canta || "Ana Ã‡anta",
name: r.Malzeme,
date: r.SKT,
count: r.Adet,
alertDays: r.Uyari,
note: r.Not || ''
}));
const uniqueBags = [...new Set(emergencyList.map(item => item.bagName))];
emergencyBags = uniqueBags.length > 0 ? uniqueBags : ["Ana Ã‡anta"];
currentBag = emergencyBags[0];
}
}

// 8. GENEL NOTLAR
if (workbook.SheetNames.includes("Genel_Notlar")) {
const rawNotes = XLSX.utils.sheet_to_json(workbook.Sheets["Genel_Notlar"]);
if (rawNotes && rawNotes.length > 0) {
generalNotesList = rawNotes.map(n => ({
date: n.Tarih,
title: n.Baslik,
content: n.Icerik,
color: n.Renk || 'yellow'
}));
}
}

// 9. NÃ–BET LÄ°STESÄ°
if (workbook.SheetNames.includes("Nobet_Listesi")) {
const rawShifts = XLSX.utils.sheet_to_json(workbook.Sheets["Nobet_Listesi"]);
if (rawShifts && rawShifts.length > 0) {
shiftList = rawShifts.map(r => ({
date: r.Tarih,
staff: r.Personel,
type: r.Tur,
note: r.Not || ''
}));
}
}

// 10. CÄ°HAZ LÄ°STESÄ°
if (workbook.SheetNames.includes("Cihaz_Zimmet")) {
const rawDevs = XLSX.utils.sheet_to_json(workbook.Sheets["Cihaz_Zimmet"]);
if (rawDevs && rawDevs.length > 0) deviceList = rawDevs;
}

// --- YENÄ° EKLENEN KISIMLAR (REHBER, HASTA TAKÄ°P, RUTÄ°NLER) ---

// 11. REHBER
if (workbook.SheetNames.includes("Rehber")) {
const rawPh = XLSX.utils.sheet_to_json(workbook.Sheets["Rehber"]);
if (rawPh && rawPh.length > 0) {
phonebookList = rawPh.map(r => ({
id: Date.now() + Math.random(), // Yeni ID ata
name: r.Ad_Soyad,
role: r.Birim,
num: r.Tel
}));
}
}

// 12. HASTA TAKÄ°P
if (workbook.SheetNames.includes("Hasta_Takip")) {
const rawRem = XLSX.utils.sheet_to_json(workbook.Sheets["Hasta_Takip"]);
if (rawRem && rawRem.length > 0) {
patientReminders = rawRem.map(r => ({
id: Date.now() + Math.random(), // Yeni ID ata
name: r.Hasta,
proc: r.Islem,
date: r.Tarih,
note: r.Not || '',
status: r.Durum || 'pending'
}));
}
}

// 13. RUTÄ°NLER
if (workbook.SheetNames.includes("Rutinler")) {
const rawRout = XLSX.utils.sheet_to_json(workbook.Sheets["Rutinler"]);
if (rawRout && rawRout.length > 0) {
routineList = rawRout.map(r => ({
text: r.Gorev,
completed: (r.Tamamlandi === 'Evet' || r.Tamamlandi === true)
}));
}
}

// --- KAYDET VE ARAYÃœZÃœ YENÄ°LE ---
saveAll();
// Ekstra kaydetmeler (Global saveAll hepsini kapsamÄ±yor olabilir diye garanti olsun)
FirebaseStorage.setItem(LS_PHONEBOOK, JSON.stringify(phonebookList));
FirebaseStorage.setItem(LS_PATIENT_REMINDERS, JSON.stringify(patientReminders));
FirebaseStorage.setItem(LS_ROUTINES, JSON.stringify(routineList));

// ArayÃ¼zleri yenile
renderBagSelector(); renderEmergency();
renderGeneralNotes();
renderPhonebook();
renderPatientReminders();
if (typeof renderRoutines === 'function') renderRoutines();

showToast("TÃ¼m veriler (Rehber ve Hasta Takip dahil) baÅŸarÄ±yla yÃ¼klendi.");
safeGet('import-file').value = '';
};
reader.readAsArrayBuffer(file);
}

// --- GÃœNCELLENMÄ°Å EXPORT (YEDEKLEME - TAM KAPSAM) ---
window.exportData = async (type) => {
// Lazy load XLSX ve PDFMake
if (type === 'xlsx' && typeof XLSX === 'undefined') {
showToast('Excel kÃ¼tÃ¼phanesi yÃ¼kleniyor...', 'info');
await LazyLoader.loadXLSX();
}
if (type === 'pdf' && typeof pdfMake === 'undefined') {
showToast('PDF kÃ¼tÃ¼phanesi yÃ¼kleniyor...', 'info');
await LazyLoader.loadPDFMake();
}

// MEVCUT VERÄ° HAZIRLIÄI (DOKTORLAR Ä°Ã‡Ä°N)
const docFlatData = [];
Object.keys(docRecords).sort().forEach(date => {
doctorList.forEach(doc => {
const r = docRecords[date][doc.name];
if (r && (r.pCount > 0 || (r.procs && Object.values(r.procs).some(v => v > 0)))) {
const row = { Tarih: date, Doktor: doc.name, Hasta_Sayisi: r.pCount };
procList.forEach(p => row[p] = (r.procs && r.procs[p]) ? r.procs[p] : 0);
docFlatData.push(row);
}
});
});

if (type === 'xlsx') {
// --- EXCEL YEDEKLEME KISMI ---
const wb = XLSX.utils.book_new();

// 1. Personel
const flatData = [];
Object.keys(allRecords).sort().forEach(date => {
staffList.forEach(s => {
const r = allRecords[date][s.name];
if (r) {
const total = r.mm + r.mk + r.am + r.ak + (r.e * 2) + (r.specialists ? r.specialists.length : 0);
if (total > 0 || (r.specialists && r.specialists.length > 0)) {
flatData.push({
Tarih: date, Personel: s.name,
OOM: r.mm, OOK: r.mk, OSM: r.am, OSK: r.ak, Muayene: r.e,
Toplam: total, Not: allNotes[date] || '',
Specialists_JSON: JSON.stringify(r.specialists || [])
});
}
}
});
});
XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(flatData), "Personel");

// 2. Doktorlar & Ä°zinler & Ekipler & BÃ¼tÃ§e
XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(docFlatData), "Doktorlar");

const leaveData = leaveRecords.map(l => ({ Personel: l.staffName, Tur: l.type, Baslangic: l.startDate, Bitis: l.endDate }));
XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(leaveData), "Izinler");

const teamData = [];
Object.keys(allRecords).sort().forEach(date => {
const r = allRecords[date]; if (r.teams) { Object.keys(r.teams).forEach(tName => { const pList = r.teams[tName]; if (pList && pList.length > 0) { teamData.push({ Tarih: date, Ekip: tName, Personeller: pList.join(', ') }); } }); }
});
XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(teamData), "Ekipler");

const budgetSheetData = budgetList.map(item => ({ Tarih: item.date, Tur: item.type === 'income' ? 'Gelir' : 'Gider', Aciklama: item.desc, Tutar: item.amount, Not: item.note || '' }));
XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(budgetSheetData), "Butce");

// 3. Ayarlar (Listeler)
const configData = [];
staffList.forEach(s => configData.push({ Tip: 'Personel_Tanim', Deger1: s.name, Deger2: s.role }));
doctorList.forEach(d => configData.push({ Tip: 'Doktor_Tanim', Deger1: d.name }));
procList.forEach(p => configData.push({ Tip: 'Islem_Tanim', Deger1: p }));
specialistList.forEach(s => configData.push({ Tip: 'Uzman_Tanim', Deger1: s }));
quickList.forEach(q => configData.push({ Tip: 'Hizli_Tanim', Deger1: q }));
teamList.forEach(t => configData.push({ Tip: 'Ekip_Tanim', Deger1: t }));
XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(configData), "Ayarlar");

// 4. DiÄŸer Mevcut Veriler
if (emergencyList && emergencyList.length > 0) {
const emSheetData = emergencyList.map(i => ({ Canta: i.bagName, Malzeme: i.name, SKT: i.date, Adet: i.count, Uyari: i.alertDays, Not: i.note }));
XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(emSheetData), "Acil_Canta");
}
if (generalNotesList && generalNotesList.length > 0) {
const notesSheetData = generalNotesList.map(n => ({ Tarih: n.date, Baslik: n.title, Icerik: n.content, Renk: n.color }));
XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(notesSheetData), "Genel_Notlar");
}
if (shiftList && shiftList.length > 0) {
const shiftData = shiftList.map(s => ({ Tarih: s.date, Personel: s.staff, Tur: s.type, Not: s.note || '' }));
XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(shiftData), "Nobet_Listesi");
}
if (deviceList && deviceList.length > 0) {
XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(deviceList), "Cihaz_Zimmet");
}

// --- YENÄ° EKLENEN KISIMLAR (BURADA) ---

// A) REHBER YEDEÄÄ°
if (phonebookList && phonebookList.length > 0) {
const phData = phonebookList.map(p => ({ Ad_Soyad: p.name, Birim: p.role, Tel: p.num }));
XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(phData), "Rehber");
}

// B) HASTA TAKÄ°P YEDEÄÄ°
if (patientReminders && patientReminders.length > 0) {
const remData = patientReminders.map(r => ({ Hasta: r.name, Islem: r.proc, Tarih: r.date, Not: r.note, Durum: r.status }));
XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(remData), "Hasta_Takip");
}

// C) RUTÄ°NLER YEDEÄÄ°
if (routineList && routineList.length > 0) {
const routData = routineList.map(r => ({ Gorev: r.text, Tamamlandi: r.completed ? 'Evet' : 'HayÄ±r' }));
XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(routData), "Rutinler");
}

// D) PANSUMAN YEDEÄÄ°
if (typeof pansumanList !== 'undefined' && pansumanList.length > 0) {
const pansumanData = pansumanList.map(p => ({
Hasta: p.patient,
Adres: p.address,
Telefon: p.phone,
Tur: p.type === 'dekubit' ? 'DekÃ¼bit' : p.type === 'sutur' ? 'SÃ¼tÃ¼r' : 'DiÄŸer',
Konum: p.location === 'merkez' ? 'Merkez' : 'KÃ¶y',
Gunler: (p.days || []).join(', '),
Tekrar: p.repeatCount === 'infinite' ? 'SÃ¼resiz' : p.repeatCount,
Durum: p.status === 'completed' ? 'Stop' : p.status === 'yatisli' ? 'YatÄ±ÅŸ' : 'Aktif',
Not: p.note || '',
Ekleyen: p.createdBy || '',
Eklenme_Tarihi: p.createdAt || ''
}));
XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(pansumanData), "Pansuman");
}

// E) SONDA, Ä°NR, NG YEDEÄÄ°
if (typeof sondaInrList !== 'undefined' && sondaInrList.length > 0) {
const sondaData = sondaInrList.map(p => ({
Hasta: p.patient,
Mahalle: p.mahalle || '',
Tur: p.type === 'erkekSonda' ? 'Erkek Sonda' : p.type === 'kadinSonda' ? 'KadÄ±n Sonda' : p.type === 'inr' ? 'Ä°NR' : 'NG',
Sonda_Turu: p.catheterType === 'silikon' ? 'Silikon' : p.catheterType === 'lateks' ? 'Lateks' : '',
Tarih: p.date,
Sonraki_Tarih: p.nextDate,
Durum: p.status === 'completed' ? 'TamamlandÄ±' : 'Aktif',
Not: p.note || '',
Ekleyen: p.createdBy || '',
Eklenme_Tarihi: p.createdAt || '',
Guncelleyen: p.updatedBy || '',
Guncelleme_Tarihi: p.updatedAt || ''
}));
XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sondaData), "Sonda_INR_NG");
}

XLSX.writeFile(wb, `SaglikTakip_TamYedek_${new Date().toISOString().slice(0, 10)}.xlsx`);

} else {
// --- PDF RAPORLAMA KISMI (DEÄÄ°ÅÄ°KLÄ°K YOK) ---
// Bu kÄ±sÄ±m Excel'i etkilemez, aynen korunuyor.

const getRowColor = (index) => (index % 2 === 0) ? '#d1d5db' : '#e5e7eb';
const getPdfDate = (dStr) => { if (!dStr) return '-'; const d = new Date(dStr); return d.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric', weekday: 'short' }); };
const c = (text, index, align = 'left', color = '#000000', fontSize = 12, bold = false) => ({ text: text, fillColor: getRowColor(index), alignment: align, color: color, fontSize: fontSize, bold: bold, margin: [0, 3, 0, 3] });

const staffBody = [[{ text: 'Tarih', style: 'tableHeader' }, { text: 'Personel', style: 'tableHeader' }, { text: 'Sabah', style: 'tableHeader', fillColor: '#c7d2fe', color: '#312e81' }, { text: 'Ã–ÄŸle', style: 'tableHeader', fillColor: '#fed7aa', color: '#7c2d12' }, { text: 'Uzman', style: 'tableHeader', fillColor: '#e9d5ff', color: '#581c87' }, { text: 'Personel Notu', style: 'tableHeader' }]];
const sortedDates = Object.keys(allRecords).sort(); let staffRowIdx = 0;
sortedDates.forEach(date => { staffList.forEach(s => { const r = allRecords[date][s.name]; if (r && (r.mm || r.mk || r.am || r.ak || r.e || (r.specialists && r.specialists.length > 0))) { let sabah = []; if (r.mm) sabah.push("Merkez"); if (r.mk) sabah.push("KÃ¶y"); if (r.e) sabah.push("Muayene"); let ogle = []; if (r.am) ogle.push("Merkez"); if (r.ak) ogle.push("KÃ¶y"); let uzman = []; if (r.specialists) r.specialists.forEach(sp => uzman.push(sp.name)); staffBody.push([c(getPdfDate(date), staffRowIdx), c(s.name, staffRowIdx, 'left', '#000000', 12, true), c(sabah.join(', ') || '-', staffRowIdx, 'center', sabah.length ? '#1e3a8a' : '#9ca3af', 11), c(ogle.join(', ') || '-', staffRowIdx, 'center', ogle.length ? '#9a3412' : '#9ca3af', 11), c(uzman.join(', ') || '-', staffRowIdx, 'center', uzman.length ? '#6b21a8' : '#9ca3af', 10), c(allNotes[date] && allNotes[date].includes(s.name) ? 'Not Var' : '-', staffRowIdx, 'center', '#4b5563', 11, false)]); staffRowIdx++; } }); });

const docBody = [[{ text: 'Tarih', style: 'tableHeader', fillColor: '#1e40af' }, { text: 'Doktor', style: 'tableHeader', fillColor: '#1e40af' }, { text: 'Hasta SayÄ±sÄ±', style: 'tableHeader', fillColor: '#1e40af' }, { text: 'Ä°ÅŸlemler', style: 'tableHeader', fillColor: '#1e40af' }]];
const docDates = Object.keys(docRecords).sort(); let docRowIdx = 0;
docDates.forEach(date => { doctorList.forEach(doc => { const r = docRecords[date][doc.name]; if (r && (parseInt(r.pCount) > 0 || (r.procs && Object.values(r.procs).some(v => v > 0)))) { let procDetails = []; if (r.procs) Object.keys(r.procs).forEach(p => { if (r.procs[p] > 0) procDetails.push(`${p}: ${r.procs[p]}`); }); docBody.push([c(getPdfDate(date), docRowIdx), c(doc.name, docRowIdx, 'left', '#000000', 12, true), c(r.pCount, docRowIdx, 'center'), c(procDetails.join(', '), docRowIdx)]); docRowIdx++; } }); });

const leaveBody = [[{ text: 'Personel', style: 'tableHeader', fillColor: '#c2410c' }, { text: 'Durum', style: 'tableHeader', fillColor: '#c2410c' }, { text: 'BaÅŸlangÄ±Ã§', style: 'tableHeader', fillColor: '#c2410c' }, { text: 'BitiÅŸ', style: 'tableHeader', fillColor: '#c2410c' }, { text: 'SÃ¼re', style: 'tableHeader', fillColor: '#c2410c', alignment: 'center' }]];
leaveRecords.forEach((l, idx) => { const start = new Date(l.startDate), end = new Date(l.endDate), diffTime = Math.abs(end - start), diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; leaveBody.push([c(l.staffName, idx, 'left', '#000000', 12, true), c(l.type, idx), c(getPdfDate(l.startDate), idx), c(getPdfDate(l.endDate), idx), { text: `${diffDays} GÃ¼n`, alignment: 'center', bold: true, fontSize: 12, fillColor: getRowColor(idx), margin: [0, 3, 0, 3] }]); });

const emBody = [[{ text: 'Ã‡anta', style: 'tableHeader', fillColor: '#991b1b' }, { text: 'Malzeme / Not', style: 'tableHeader', fillColor: '#991b1b' }, { text: 'SKT', style: 'tableHeader', fillColor: '#991b1b' }, { text: 'Adet', style: 'tableHeader', fillColor: '#991b1b' }]];
emergencyList.forEach((em, idx) => { emBody.push([c(em.bagName || 'Ana Ã‡anta', idx), { stack: [{ text: em.name, bold: true, color: '#000000', fontSize: 12 }, em.note ? { text: `Not: ${em.note}`, fontSize: 10, italics: true, color: '#374151' } : ''], fillColor: getRowColor(idx), margin: [0, 3, 0, 3] }, c(getPdfDate(em.date), idx), c(em.count, idx, 'center', '#000000', 12, true)]); });

const teamBody = [[{ text: 'Tarih', style: 'tableHeader', fillColor: '#4338ca' }, { text: 'Ekip AdÄ±', style: 'tableHeader', fillColor: '#4338ca' }, { text: 'Personeller', style: 'tableHeader', fillColor: '#4338ca' }]];
let teamRowIdx = 0; sortedDates.forEach(date => { if (allRecords[date] && allRecords[date].teams) { Object.keys(allRecords[date].teams).forEach(tName => { const pList = allRecords[date].teams[tName]; if (pList && pList.length > 0) { teamBody.push([c(getPdfDate(date), teamRowIdx), c(tName, teamRowIdx, 'left', '#000000', 12, true), c(pList.join(', '), teamRowIdx)]); teamRowIdx++; } }); } });

const notesBody = [[{ text: 'Tarih', style: 'tableHeader', fillColor: '#854d0e' }, { text: 'GÃ¼nÃ¼n Notu', style: 'tableHeader', fillColor: '#854d0e' }]];
let noteRowIdx = 0; sortedDates.forEach(date => { if (allNotes[date]) { notesBody.push([c(getPdfDate(date), noteRowIdx, 'left', '#000000', 12, true), c(allNotes[date], noteRowIdx, 'left', '#1f2937', 12, false)]); noteRowIdx++; } });

const genNotesBody = [[{ text: 'Tarih', style: 'tableHeader', fillColor: '#be185d' }, { text: 'BaÅŸlÄ±k', style: 'tableHeader', fillColor: '#be185d' }, { text: 'Ä°Ã§erik', style: 'tableHeader', fillColor: '#be185d' }]];
if (generalNotesList && generalNotesList.length > 0) { generalNotesList.forEach((note, idx) => { genNotesBody.push([c(note.date, idx, 'left', '#000000', 10, true), c(note.title, idx, 'left', '#be185d', 11, true), c(note.content, idx, 'left', '#374151', 10)]); }); }
else { genNotesBody.push([{ text: 'HenÃ¼z eklenmiÅŸ Ã¶nemli not bulunmamaktadÄ±r.', colSpan: 3, alignment: 'center', italics: true, color: '#9ca3af', margin: [0, 10, 0, 10] }, {}, {}]); }

const shiftBody = [[{ text: 'Tarih', style: 'tableHeader', fillColor: '#312e81' }, { text: 'Personel', style: 'tableHeader', fillColor: '#312e81' }, { text: 'NÃ¶bet TÃ¼rÃ¼', style: 'tableHeader', fillColor: '#312e81' }, { text: 'Not', style: 'tableHeader', fillColor: '#312e81' }]];
if (typeof shiftList !== 'undefined' && shiftList.length > 0) {
const sortedShifts = [...shiftList].sort((a, b) => a.date.localeCompare(b.date));
sortedShifts.forEach((s, idx) => {
shiftBody.push([c(getPdfDate(s.date), idx), c(s.staff, idx, 'left', '#000000', 11, true), c(s.type, idx, 'center'), c(s.note || '-', idx, 'left', '#4b5563', 10, !!s.note)]);
});
} else { shiftBody.push([{ text: 'NÃ¶bet kaydÄ± yok.', colSpan: 4, alignment: 'center', italics: true, color: '#9ca3af', margin: [0, 10, 0, 10] }, {}, {}, {}]); }

const docDefinition = {
pageOrientation: 'landscape',
content: [
{ text: 'EVDE SAÄLIK HÄ°ZMETLERÄ° DETAYLI RAPORU', style: 'header', alignment: 'center', margin: [0, 0, 0, 10] },
{ text: `Rapor Tarihi: ${new Date().toLocaleDateString('tr-TR')}`, style: 'subheader', alignment: 'center', margin: [0, 0, 0, 20] },
{ text: '1. Personel GÃ¶rev Takip Listesi', style: 'sectionHeader', margin: [0, 10, 0, 10] },
{ table: { headerRows: 1, widths: ['auto', 'auto', '*', '*', '*', 'auto'], body: staffBody.length > 1 ? staffBody : [[{ text: 'KayÄ±t bulunamadÄ±', colSpan: 6, alignment: 'center' }, {}, {}, {}, {}, {}]] }, layout: 'noBorders' },
{ text: '2. Doktor Performans ve TÄ±bbi Ä°ÅŸlemler', style: 'sectionHeader', margin: [0, 20, 0, 10], pageBreak: 'before' },
{ table: { headerRows: 1, widths: ['auto', '*', 'auto', '*'], body: docBody.length > 1 ? docBody : [[{ text: 'KayÄ±t bulunamadÄ±', colSpan: 4, alignment: 'center' }, {}, {}, {}]] }, layout: 'noBorders' },
{ text: '3. Ekip / Liste DaÄŸÄ±lÄ±mÄ±', style: 'sectionHeader', margin: [0, 20, 0, 10] },
{ table: { headerRows: 1, widths: ['auto', 'auto', '*'], body: teamBody.length > 1 ? teamBody : [[{ text: 'KayÄ±t bulunamadÄ±', colSpan: 3, alignment: 'center' }, {}, {}]] }, layout: 'noBorders' },
{ text: '4. Ä°zin ve Rapor DurumlarÄ±', style: 'sectionHeader', margin: [0, 20, 0, 10] },
{ table: { headerRows: 1, widths: ['*', 'auto', 'auto', 'auto', 'auto'], body: leaveBody.length > 1 ? leaveBody : [[{ text: 'KayÄ±t bulunamadÄ±', colSpan: 5, alignment: 'center' }, {}, {}, {}, {}]] }, layout: 'noBorders' },
{ text: '5. Acil Ã‡anta ve Stok Envanteri', style: 'sectionHeader', margin: [0, 20, 0, 10], pageBreak: 'before' },
{ table: { headerRows: 1, widths: ['auto', '*', 'auto', 'auto'], body: emBody.length > 1 ? emBody : [[{ text: 'KayÄ±t bulunamadÄ±', colSpan: 4, alignment: 'center' }, {}, {}, {}]] }, layout: 'noBorders' },
{ text: '6. GÃ¼nlÃ¼k Genel Notlar', style: 'sectionHeader', margin: [0, 20, 0, 10] },
{ table: { headerRows: 1, widths: ['auto', '*'], body: notesBody.length > 1 ? notesBody : [[{ text: 'Bu tarih aralÄ±ÄŸÄ±nda not bulunamadÄ±.', colSpan: 2, alignment: 'center', italics: true, color: '#4b5563' }, {}]] }, layout: 'noBorders' },
{ text: '7. Ã–nemli Notlar / HatÄ±rlatmalar', style: 'sectionHeader', margin: [0, 20, 0, 10], pageBreak: 'before' },
{ table: { headerRows: 1, widths: ['auto', 'auto', '*'], body: genNotesBody }, layout: 'noBorders' },
{ text: '8. Personel NÃ¶bet Ã‡izelgesi', style: 'sectionHeader', margin: [0, 20, 0, 10], pageBreak: 'before' },
{ table: { headerRows: 1, widths: ['auto', '*', 'auto', '*'], body: shiftBody }, layout: 'noBorders' }
],
styles: {
header: { fontSize: 22, bold: true, color: '#3730a3' },
subheader: { fontSize: 12, italics: true, color: '#6b7280' },
sectionHeader: { fontSize: 16, bold: true, color: '#111827', decoration: 'underline' },
tableHeader: { bold: true, fontSize: 13, color: 'white', fillColor: '#3730a3', alignment: 'center', margin: [0, 6, 0, 6] }
},
defaultStyle: { fontSize: 12 }
};

pdfMake.createPdf(docDefinition).download(`ESB_Genel_Rapor_${new Date().toISOString().slice(0, 10)}.pdf`);
}
};

function calculateMode(n) { if (n.length === 0) return 0; const f = {}; let max = 0, mode = n[0]; n.forEach(x => { f[x] = (f[x] || 0) + 1; if (f[x] > max) { max = f[x]; mode = x; } }); if (max === 1 && n.length > 1) return Math.round(n.reduce((a, b) => a + b, 0) / n.length); return mode; }
function getStatusHtml(val, target) {
const diff = val - target;
// text-[10px] yerine text-xs yaptÄ±k, bÃ¶ylece daha okunaklÄ± oldu
if (Math.abs(diff) >= 1) return diff < 0 ?
`<span class="px-2 py-1 rounded text-xs font-bold bg-red-100 text-red-700 block border border-red-200">EKSÄ°K (${diff})</span>` :
`<span class="px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-700 block border border-green-200">FAZLA (+${diff})</span>`;
return `<span class="text-xs text-gray-400 font-bold">TAM</span>`;
}

// YENÄ° EKLENECEK FONKSÄ°YON
function renderReminderProcs() {
const select = document.getElementById('rem-proc');
if (!select) return;

// Mevcut listeyi temizle
select.innerHTML = '';

// Global procList (Ä°ÅŸlem Listesi) dizisindeki her iÅŸlemi ekle
procList.forEach(p => {
const opt = document.createElement('option');
opt.value = p;
opt.innerText = p;
select.appendChild(opt);
});

// Tarih inputunu bugÃ¼nÃ¼n tarihine ayarla
const dateInput = document.getElementById('rem-date');
if (dateInput && !dateInput.value) {
const today = new Date();
const formattedDate = today.toISOString().split('T')[0];
dateInput.value = formattedDate;
// GÃ¼n adÄ±nÄ± gÃ¼ncelle
if (typeof updateDayName === 'function') {
updateDayName('rem-date', 'rem-date-day');
}
}
}

// RENDER FUNCTIONS
function renderUI() {
const dates = getWeekDates(currentWeekStart);
renderTable(dates); renderTeamTable(dates); renderStats(); renderSpecialistTab(); renderDoctorTable(dates); renderLeaveRecords(); renderDoctorLeaveRecords(); populateDoctorSuggestions(); renderRoutines(); renderUmkeRecords();
lucide.createIcons();
}

function renderTable(dates) {
const thead = document.querySelector('#tracking-head'), tbody = document.getElementById('tracking-body');

// BaÅŸlÄ±klarÄ± temizle
thead.querySelectorAll(':not(.sticky-col-1)').forEach(e => e.remove());
tbody.innerHTML = '';

// --- GÃœN BAÅLIKLARI (Ãœst KÄ±sÄ±m) ---
days.forEach(day => {
const dStr = dates[day], d = new Date(dStr), note = allNotes[dStr];
const noteIcon = note ? `<button onclick="openNoteModal('${dStr}')" class="ml-1 focus:outline-none"><i data-lucide="sticky-note" class="w-4 h-4 text-yellow-500 fill-yellow-100 hover:scale-110 transition"></i></button>` : '';

// BURASI DEÄÄ°ÅTÄ°: border-2 ve border-gray-600 eklendi (KalÄ±n Ä±zgara baÅŸlÄ±k)
thead.insertAdjacentHTML('beforeend', `<th class="px-2 py-2 bg-gray-100 text-center border-2 border-gray-600 min-w-[90px]"><div class="font-bold text-gray-800 text-xs flex justify-center items-center">${day} ${noteIcon}</div><div class="text-[10px] text-gray-600 font-bold">${d.getDate()}/${d.getMonth() + 1}</div></th>`);
});

// "SAYI" SÃ¼tunu BaÅŸlÄ±ÄŸÄ± - karanlÄ±k mod uyumlu
thead.insertAdjacentHTML('beforeend', `<th class="px-2 py-2 bg-indigo-100 dark:bg-indigo-900 text-center font-bold text-indigo-900 dark:text-indigo-200 text-xs sticky right-0 w-12 border-2 border-gray-600 dark:border-gray-500">SAYI</th>`);

// --- SATIRLAR (GÃ¶vde) ---
staffList.forEach((s, index) => {
let t = 0;
const bgClass = (index % 2 === 0) ? 'bg-white' : 'bg-gray-100';

// BURASI DEÄÄ°ÅTÄ°: SatÄ±r ve Ä°sim hÃ¼cresine kalÄ±n Ã§erÃ§eveler (border-2 border-gray-600)
let h = `<tr class="${bgClass} hover:bg-indigo-50 border-b-2 border-gray-600">
<td class="px-4 py-2 font-bold text-gray-800 sticky-col-1 ${bgClass} border-2 border-gray-600 text-xs whitespace-nowrap shadow-sm">${s.name}</td>`;

days.forEach(day => {
const k = dates[day], r = allRecords[k]?.[s.name] || { mm: 0, mk: 0, am: 0, ak: 0, e: 0, specialists: [] };
const leave = leaveRecords.find(l => l.staffName === s.name && k >= l.startDate && k <= l.endDate);

if (leave) {
// Ä°zinli/Raporlu HÃ¼cresi
const typeClass = leave.type === 'Rapor' ? 'bg-red-100 text-red-800' : 'bg-orange-100 text-orange-800';
const typeText = leave.type === 'Rapor' ? 'RAPORLU' : 'Ä°ZÄ°NLÄ°';

// BURASI DEÄÄ°ÅTÄ°: border-2 border-gray-600
h += `<td class="px-1 py-1 text-center h-16 align-middle border-2 border-gray-600 relative"><div class="flex items-center justify-center w-full h-full p-1"><div class="w-full h-full flex items-center justify-center rounded border border-gray-400 font-bold text-[10px] tracking-wider transform -rotate-12 opacity-90 shadow-sm ${typeClass}">${typeText}</div></div></td>`;
} else {
const specCount = r.specialists ? r.specialists.length : 0;
const sc = r.mm + r.mk + r.am + r.ak + (r.e * 2) + specCount;
t += sc;

let c = '';

// NÃ–BETÃ‡Ä° kontrolÃ¼ - shiftList'te bu tarihte bu personel var mÄ±?
const isOnDuty = typeof shiftList !== 'undefined' && shiftList.find(shift => shift.date === k && shift.staff === s.name);
if (isOnDuty) {
c += `<div class="text-[9px] px-1 py-0.5 rounded mb-0.5 border-2 border-gray-500 bg-gray-600 text-center font-bold leading-tight w-full text-white">ğŸŒ™ NÃ–BETÃ‡Ä°</div>`;
}

if (r.mm) c += `<div class="text-[9px] px-1 py-0.5 rounded mb-0.5 border border-blue-300 bg-blue-50 text-center font-bold leading-tight w-full text-blue-800">SABAH<br>MERKEZ</div>`;
if (r.mk) c += `<div class="text-[9px] px-1 py-0.5 rounded mb-0.5 border border-orange-300 bg-orange-50 text-center font-bold leading-tight w-full text-orange-800">SABAH<br>KÃ–Y</div>`;
if (r.am) c += `<div class="text-[9px] px-1 py-0.5 rounded mb-0.5 border border-indigo-300 bg-indigo-50 text-center font-bold leading-tight w-full text-indigo-800">Ã–ÄLEN<br>MERKEZ</div>`;
if (r.ak) c += `<div class="text-[9px] px-1 py-0.5 rounded mb-0.5 border border-orange-300 bg-orange-50 text-center font-bold leading-tight w-full text-orange-800">Ã–ÄLEN<br>KÃ–Y</div>`;
if (r.e) c += `<div class="text-[9px] px-1 py-0.5 rounded border border-red-300 bg-red-50 text-center font-bold w-full text-red-700">MUAYENE</div>`;
// ESKÄ°SÄ°NÄ° SÄ°L VE BUNU YAPIÅTIR
if (r.specialists) {
r.specialists.forEach(sp => {
const timeText = sp.time === 'Ã–Ã–' ? 'SABAH' : 'Ã–ÄLEN';
// text-[8px] yerine text-[10px] yaptÄ±k, paddingleri artÄ±rdÄ±k, ismi 5 harfe Ã§Ä±kardÄ±k
c += `<div class="text-[10px] px-1 py-1 rounded border border-green-300 bg-green-50 mt-1 text-center leading-tight w-full text-green-900 font-bold shadow-sm">
<span class="block mb-0.5 text-green-700">${sp.name.substr(0, 5)}.</span>
<span class="text-[9px] text-gray-500">${timeText}</span>
</div>`;
});
}

// BURASI DEÄÄ°ÅTÄ°: Normal Veri HÃ¼cresi (border-2 border-gray-600)
// YENÄ° HALÄ°: h-16 yerine h-auto yaptÄ±k, py-1'i py-2 yaptÄ±k
h += `<td class="px-1 py-2 text-center h-auto min-h-[4rem] align-middle border-2 border-gray-600 relative"><div class="flex flex-col items-center justify-center w-full h-full">${c}</div></td>`;
}
});
// Toplam SayÄ± HÃ¼cresi - karanlÄ±k mod uyumlu
h += `<td class="px-2 py-2 text-center font-bold text-sm text-indigo-900 dark:text-indigo-200 bg-indigo-100 dark:bg-indigo-900 border-2 border-gray-600 dark:border-gray-500">${t}</td></tr>`;
tbody.insertAdjacentHTML('beforeend', h);
});
}

function renderTeamTable(dates) {
const head = document.getElementById('team-table-head'), body = document.getElementById('team-table-body');

// BaÅŸlÄ±klarÄ± temizle
head.querySelectorAll('th:not(.sticky-col-1)').forEach(e => e.remove());
body.innerHTML = '';

// --- BAÅLIKLAR (Header) ---
days.forEach(day => {
const d = new Date(dates[day]);
// BURASI DEÄÄ°ÅTÄ°: border-2 ve border-gray-600 (Koyu Ã§erÃ§eve baÅŸlÄ±klar)
head.insertAdjacentHTML('beforeend', `<th class="px-2 py-2 bg-gray-100 text-center border-2 border-gray-600 min-w-[100px] text-[10px] text-gray-800 font-bold">${day}<br>${d.getDate()}/${d.getMonth() + 1}</th>`);
});

if (teamList.length === 0) {
body.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400 text-xs border-2 border-gray-600">HenÃ¼z ekip tanÄ±mlanmamÄ±ÅŸ.</td></tr>';
return;
}

// --- SATIRLAR (Rows) ---
teamList.forEach((teamName, idx) => {
const bgClass = (idx % 2 === 0) ? 'bg-white' : 'bg-gray-50';

// SatÄ±rÄ±n alt Ã§izgisi de kalÄ±nlaÅŸtÄ±rÄ±ldÄ±
let row = `<tr class="${bgClass} hover:bg-indigo-50 border-b-2 border-gray-600">
<td class="px-4 py-3 font-bold text-gray-800 sticky-col-1 ${bgClass} border-2 border-gray-600 text-xs shadow-sm">${teamName}</td>`;

days.forEach(day => {
const dateKey = dates[day];
const teamData = allRecords[dateKey]?.teams?.[teamName] || [];

let cellContent = '-';
if (teamData.length > 0) {
// Ä°simleri biraz daha belirgin yaptÄ±m (indigo-800 ve font-bold)
cellContent = teamData.map(p => `<span class="block text-[10px] text-indigo-800 font-bold truncate border-b border-gray-300 pb-0.5 mb-0.5 last:border-0">â€¢ ${p}</span>`).join('');
}

// BURASI DEÄÄ°ÅTÄ°: HÃ¼cre Ã§erÃ§eveleri (border-2 border-gray-600)
row += `<td class="px-2 py-2 text-left border-2 border-gray-600 align-top h-16 overflow-y-auto">${cellContent}</td>`;
});
row += '</tr>';
body.insertAdjacentHTML('beforeend', row);
});
}

function renderLeaveRecords() {
const listEl = document.getElementById('leave-records-list'); if (!listEl) return;
const sortedLeaves = [...leaveRecords].sort((a, b) => b.startDate.localeCompare(a.startDate));
if (sortedLeaves.length === 0) { listEl.innerHTML = '<tr><td colspan="5" class="p-8 text-center"><div class="flex flex-col items-center justify-center text-gray-400"><svg class="w-12 h-12 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg><p class="text-sm font-medium">HenÃ¼z izin/rapor kaydÄ± yok</p><p class="text-xs mt-1">Yeni kayÄ±t eklemek iÃ§in formu kullanÄ±n</p></div></td></tr>'; return; }

const rows = sortedLeaves.map((l) => {
const originalIdx = leaveRecords.findIndex(rec => rec.staffName === l.staffName && rec.startDate === l.startDate && rec.endDate === l.endDate && rec.type === l.type);
const sDate = new Date(l.startDate), eDate = new Date(l.endDate);
const typeClass = l.type === 'Rapor' ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300' : 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300';
const diffTime = Math.abs(eDate - sDate);
const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

return `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700 group border-b last:border-0">
<td class="px-4 py-2 font-medium text-gray-700 dark:text-gray-300">${l.staffName}</td>
<td class="px-4 py-2"><span class="text-[10px] px-2 py-1 rounded-full font-bold ${typeClass}">${l.type}</span></td>
<td class="px-4 py-2 text-gray-600 dark:text-gray-400 text-xs">${sDate.toLocaleDateString('tr-TR')} - ${eDate.toLocaleDateString('tr-TR')}</td>
<td class="px-4 py-2 text-center"><span class="text-xs font-bold px-2 py-1 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">${diffDays} gÃ¼n</span></td>
<td class="px-4 py-2 text-right">
<button onclick="editLeaveRecord(${originalIdx})" class="text-gray-400 hover:text-blue-500 p-1 opacity-0 group-hover:opacity-100 transition" title="DÃ¼zenle"><i data-lucide="pencil" class="w-4 h-4"></i></button>
<button onclick="deleteLeaveRecord(${originalIdx})" class="text-gray-400 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition" title="Sil"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
</td>
</tr>`;
});
listEl.innerHTML = rows.join('');

const countEl = document.getElementById('leave-count');
if (countEl) countEl.textContent = `${leaveRecords.length} kayÄ±t`;
lucide.createIcons({ nodes: [listEl] });
}

// ===== DOKTOR Ä°ZÄ°N/RAPOR FONKSÄ°YONLARI =====
async function addDoctorLeaveRecord() {
const doctorName = document.getElementById('doctor-leave-input')?.value.trim();
const type = document.getElementById('doctor-leave-type-select')?.value;
const startDate = document.getElementById('doctor-leave-start-date')?.value;
const endDate = document.getElementById('doctor-leave-end-date')?.value;

if (!doctorName || !type || !startDate || !endDate) {
showToast('LÃ¼tfen tÃ¼m alanlarÄ± doldurun!', 'warning');
return;
}

if (new Date(startDate) > new Date(endDate)) {
showToast('BaÅŸlangÄ±Ã§ tarihi bitiÅŸ tarihinden sonra olamaz!', 'error');
return;
}

const record = {
id: `dl_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
doctorName,
type,
startDate,
endDate,
createdAt: new Date().toISOString(),
createdBy: currentUser?.email || 'unknown'
};

doctorLeaveRecords.push(record);
await saveDoctorLeaveRecords();
renderDoctorLeaveRecords();
populateDoctorSuggestions();

// Formu temizle
document.getElementById('doctor-leave-input').value = '';
document.getElementById('doctor-leave-start-date').value = '';
document.getElementById('doctor-leave-end-date').value = '';

showToast(`âœ… ${doctorName} iÃ§in ${type} kaydÄ± eklendi!`);
addActivityLog('doctor_leave', 'Doktor izin/rapor eklendi', doctorName);
}

function renderDoctorLeaveRecords() {
const listEl = document.getElementById('doctor-leave-records-list');
if (!listEl) return;

const sortedLeaves = [...doctorLeaveRecords].sort((a, b) => b.startDate.localeCompare(a.startDate));

if (sortedLeaves.length === 0) {
listEl.innerHTML = '<tr><td colspan="5" class="p-8 text-center"><div class="flex flex-col items-center justify-center text-gray-400"><svg class="w-12 h-12 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><p class="text-sm font-medium">HenÃ¼z doktor izin/rapor kaydÄ± yok</p><p class="text-xs mt-1">Yeni kayÄ±t eklemek iÃ§in formu kullanÄ±n</p></div></td></tr>';
const countEl = document.getElementById('doctor-leave-count');
if (countEl) countEl.textContent = '0 kayÄ±t';
return;
}

const rows = sortedLeaves.map((l) => {
const originalIdx = doctorLeaveRecords.findIndex(rec =>
rec.doctorName === l.doctorName &&
rec.startDate === l.startDate &&
rec.endDate === l.endDate &&
rec.type === l.type
);
const sDate = new Date(l.startDate), eDate = new Date(l.endDate);
const typeClass = l.type === 'Rapor'
? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300'
: 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300';

const diffTime = Math.abs(eDate - sDate);
const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

return `<tr class="hover:bg-blue-50 dark:hover:bg-gray-700 group border-b last:border-0">
<td class="px-4 py-2 font-medium text-gray-700 dark:text-gray-300">${l.doctorName}</td>
<td class="px-4 py-2"><span class="text-[10px] px-2 py-1 rounded-full font-bold ${typeClass}">${l.type}</span></td>
<td class="px-4 py-2 text-gray-600 dark:text-gray-400 text-xs">${sDate.toLocaleDateString('tr-TR')} - ${eDate.toLocaleDateString('tr-TR')}</td>
<td class="px-4 py-2 text-center"><span class="text-xs font-bold px-2 py-1 rounded-full bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300">${diffDays} gÃ¼n</span></td>
<td class="px-4 py-2 text-right">
<button onclick="editDoctorLeave(${originalIdx})" class="text-gray-400 hover:text-blue-500 p-1 opacity-0 group-hover:opacity-100 transition" title="DÃ¼zenle"><i data-lucide="pencil" class="w-4 h-4"></i></button>
<button onclick="deleteDoctorLeave(${originalIdx})" class="text-gray-400 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition" title="Sil"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
</td>
</tr>`;
});
listEl.innerHTML = rows.join('');

const countEl = document.getElementById('doctor-leave-count');
if (countEl) countEl.textContent = `${doctorLeaveRecords.length} kayÄ±t`;
lucide.createIcons({ nodes: [listEl] });
}

async function deleteDoctorLeave(idx) {
// Admin kontrolÃ¼
if (currentUserRole !== 'admin') {
showToast('Bu iÅŸlem iÃ§in admin yetkisi gereklidir!', 'error');
return;
}

if (!confirm('Bu kaydÄ± silmek istediÄŸinize emin misiniz?')) return;
const deleted = doctorLeaveRecords[idx];
doctorLeaveRecords.splice(idx, 1);
await saveDoctorLeaveRecords();
renderDoctorLeaveRecords();
showToast('Doktor izin/rapor kaydÄ± silindi!');
if (deleted) addActivityLog('doctor_leave', 'Doktor izin/rapor silindi', deleted.doctorName);
}

// Doktor izin/rapor dÃ¼zenleme
window.editDoctorLeave = function(idx) {
if (currentUserRole !== 'admin') {
showToast('Bu iÅŸlem iÃ§in admin yetkisi gereklidir!', 'error');
return;
}
const record = doctorLeaveRecords[idx];
if (!record) return;

// Form alanlarÄ±nÄ± doldur
document.getElementById('doctor-leave-input').value = record.doctorName || '';
document.getElementById('doctor-leave-type-select').value = record.type || 'Rapor';
document.getElementById('doctor-leave-start-date').value = record.startDate || '';
document.getElementById('doctor-leave-end-date').value = record.endDate || '';

// Eski kaydÄ± sil
doctorLeaveRecords.splice(idx, 1);
saveDoctorLeaveRecords();
renderDoctorLeaveRecords();

// Forma scroll yap ve vurgula
const form = document.getElementById('doctor-leave-add-form');
if (form) {
form.scrollIntoView({ behavior: 'smooth', block: 'center' });
form.classList.add('ring-2', 'ring-blue-500');
setTimeout(() => form.classList.remove('ring-2', 'ring-blue-500'), 2000);
}
showToast('KaydÄ± dÃ¼zenleyip tekrar ekleyin', 'info');
};

async function saveDoctorLeaveRecords() {
const key = 'evdeSaglikDoctorLeaves_V1';
localStorage.setItem(key, JSON.stringify(doctorLeaveRecords));
if (userDataPath && database) {
try {
await database.ref(`${userDataPath}/${key}`).set(doctorLeaveRecords);
} catch (e) {
console.error('Doktor izin kaydetme hatasÄ±:', e);
}
}
}

function populateDoctorSuggestions() {
const datalist = document.getElementById('doctor-suggestions');
if (!datalist) return;
datalist.innerHTML = '';
doctorList.forEach(d => {
const option = document.createElement('option');
option.value = d.name;
datalist.appendChild(option);
});
}
// ===== DOKTOR Ä°ZÄ°N/RAPOR FONKSÄ°YONLARI BÄ°TTÄ° =====

// ===== UMKE GÃ–REVÄ° FONKSÄ°YONLARI =====
async function addUmkeRecord() {
const staffName = document.getElementById('umke-staff-input')?.value.trim();
const startDate = document.getElementById('umke-start-date')?.value;
const endDate = document.getElementById('umke-end-date')?.value;
const location = document.getElementById('umke-location')?.value.trim();

if (!staffName || !startDate || !endDate) {
showToast('LÃ¼tfen personel ve tarih alanlarÄ±nÄ± doldurun!', 'warning');
return;
}

if (new Date(startDate) > new Date(endDate)) {
showToast('BaÅŸlangÄ±Ã§ tarihi bitiÅŸ tarihinden sonra olamaz!', 'error');
return;
}

const record = {
id: `umke_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
staffName,
startDate,
endDate,
location: location || null,
createdAt: new Date().toISOString(),
createdBy: currentUser?.email || 'unknown'
};

umkeRecords.push(record);
await saveUmkeRecords();
renderUmkeRecords();

// Formu temizle
document.getElementById('umke-staff-input').value = '';
document.getElementById('umke-start-date').value = '';
document.getElementById('umke-end-date').value = '';
document.getElementById('umke-location').value = '';

showToast(`âœ… ${staffName} iÃ§in UMKE gÃ¶revi eklendi!`);
addActivityLog('umke', 'UMKE gÃ¶revi eklendi', `${staffName} (${startDate} - ${endDate})`);
}
window.addUmkeRecord = addUmkeRecord;

function renderUmkeRecords() {
const listEl = document.getElementById('umke-records-list');
if (!listEl) return;

const sortedRecords = [...umkeRecords].sort((a, b) => b.startDate.localeCompare(a.startDate));

if (sortedRecords.length === 0) {
listEl.innerHTML = '<tr><td colspan="5" class="p-8 text-center"><div class="flex flex-col items-center justify-center text-gray-400"><svg class="w-12 h-12 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg><p class="text-sm font-medium">HenÃ¼z UMKE gÃ¶revi kaydÄ± yok</p><p class="text-xs mt-1">Yeni gÃ¶rev eklemek iÃ§in formu kullanÄ±n</p></div></td></tr>';
const countEl = document.getElementById('umke-count');
if (countEl) countEl.textContent = '0 kayÄ±t';
return;
}

const rows = sortedRecords.map((r) => {
const originalIdx = umkeRecords.findIndex(rec =>
rec.staffName === r.staffName &&
rec.startDate === r.startDate &&
rec.endDate === r.endDate
);
const sDate = new Date(r.startDate), eDate = new Date(r.endDate);
const diffTime = Math.abs(eDate - sDate);
const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

return `<tr class="hover:bg-cyan-50 dark:hover:bg-gray-700 group border-b last:border-0">
<td class="px-4 py-2 font-medium text-gray-700 dark:text-gray-300">${r.staffName}</td>
<td class="px-4 py-2 text-gray-600 dark:text-gray-400 text-xs">${sDate.toLocaleDateString('tr-TR')} - ${eDate.toLocaleDateString('tr-TR')}</td>
<td class="px-4 py-2 text-center"><span class="text-xs font-bold px-2 py-1 rounded-full bg-cyan-100 dark:bg-cyan-900/30 text-cyan-700 dark:text-cyan-300">${diffDays} gÃ¼n</span></td>
<td class="px-4 py-2 text-gray-600 text-xs">${r.location || '-'}</td>
<td class="px-4 py-2 text-right"><button onclick="deleteUmkeRecord(${originalIdx})" class="text-gray-400 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
</tr>`;
});
listEl.innerHTML = rows.join('');

const countEl = document.getElementById('umke-count');
if (countEl) countEl.textContent = `${umkeRecords.length} kayÄ±t`;
lucide.createIcons({ nodes: [listEl] });
}

async function deleteUmkeRecord(idx) {
// Admin kontrolÃ¼
if (currentUserRole !== 'admin') {
showToast('Bu iÅŸlem iÃ§in admin yetkisi gereklidir!', 'error');
return;
}

if (!confirm('Bu kaydÄ± silmek istediÄŸinize emin misiniz?')) return;
const deleted = umkeRecords[idx];
umkeRecords.splice(idx, 1);
await saveUmkeRecords();
renderUmkeRecords();
showToast('UMKE gÃ¶revi kaydÄ± silindi!');
if (deleted) addActivityLog('umke', 'UMKE gÃ¶revi silindi', deleted.staffName);
}
window.deleteUmkeRecord = deleteUmkeRecord;

async function saveUmkeRecords() {
const key = 'evdeSaglikUmkeRecords_V1';
localStorage.setItem(key, JSON.stringify(umkeRecords));
if (userDataPath && database) {
try {
await database.ref(`${userDataPath}/${key}`).set(umkeRecords);
} catch (e) {
console.error('UMKE kaydetme hatasÄ±:', e);
}
}
}

async function loadUmkeRecords() {
const key = 'evdeSaglikUmkeRecords_V1';
try {
// Ã–nce localStorage'dan dene
const local = localStorage.getItem(key);
if (local) {
umkeRecords = JSON.parse(local) || [];
}
// Firebase'den yÃ¼kle
if (userDataPath && database) {
const snapshot = await database.ref(`${userDataPath}/${key}`).once('value');
const data = snapshot.val();
if (data) {
umkeRecords = Array.isArray(data) ? data : Object.values(data);
}
}
renderUmkeRecords();
} catch (e) {
console.error('UMKE yÃ¼kleme hatasÄ±:', e);
}
}

// UMKE kayÄ±tlarÄ± real-time listener
function startUmkeRealtimeListener() {
const key = 'evdeSaglikUmkeRecords_V1';
const checkAndStart = () => {
if (!userDataPath || typeof firebase === 'undefined' || !firebase.database) {
setTimeout(checkAndStart, 1000);
return;
}
firebase.database().ref(`${userDataPath}/${key}`).on('value', (snapshot) => {
const data = snapshot.val();
umkeRecords = data ? (Array.isArray(data) ? data : Object.values(data)) : [];
renderUmkeRecords();
});
};
checkAndStart();
}
// ===== UMKE GÃ–REVÄ° FONKSÄ°YONLARI BÄ°TTÄ° =====

function renderDoctorTable(dates) {
const head = document.getElementById('doctor-table-head'), body = document.getElementById('doctor-table-body');

// BaÅŸlÄ±klarÄ± temizle
head.querySelectorAll('th:not(.sticky-col-1)').forEach(e => e.remove());
body.innerHTML = '';

// --- GÃœN BAÅLIKLARI ---
days.forEach(day => {
const d = new Date(dates[day]);
// BURASI DEÄÄ°ÅTÄ°: border-2 ve border-gray-600 eklendi
head.insertAdjacentHTML('beforeend', `<th class="px-3 py-2 bg-gray-100 text-center border-2 border-gray-600 min-w-[70px] text-[10px] text-gray-700 font-bold">${day}<br>${d.getDate()}/${d.getMonth() + 1}</th>`);
});

// TOPLAM SÃœTUNU BAÅLIÄI
head.insertAdjacentHTML('beforeend', `<th class="px-3 py-2 bg-blue-100 text-center font-bold text-blue-900 text-xs border-2 border-gray-600">TOP. H.</th>`);

// Veri HazÄ±rlÄ±ÄŸÄ±
const procStats = {};
procList.forEach(p => procStats[p] = 0);

const activeDoctors = doctorList.filter(doc => {
return days.some(day => {
const k = dates[day], rec = docRecords[k]?.[doc.name];
return rec && (parseInt(rec.pCount) > 0 || (rec.procs && Object.values(rec.procs).some(v => parseInt(v) > 0)));
});
});

if (activeDoctors.length === 0) {
body.innerHTML = '<tr><td colspan="8" class="p-6 text-center text-gray-500 text-sm bg-gray-50 border-2 border-gray-600 font-bold">Bu hafta iÃ§in kayÄ±tlÄ± veri bulunmamaktadÄ±r.</td></tr>';
}

// --- DOKTOR SATIRLARI ---
activeDoctors.forEach((doc, idx) => {
const bgClass = (idx % 2 === 0) ? 'bg-white' : 'bg-gray-100';
let totalPatients = 0;

// SatÄ±r ve Ä°sim HÃ¼cresi (Sticky) - KalÄ±n Ã‡erÃ§eve
let h = `<tr class="${bgClass} hover:bg-gray-200 border-b-2 border-gray-600">
<td class="px-4 py-2 sticky-col-1 ${bgClass} border-2 border-gray-600 text-xs font-bold text-gray-800 shadow-sm">${doc.name}</td>`;

days.forEach(day => {
const k = dates[day], rec = docRecords[k]?.[doc.name] || { pCount: 0, procs: {} };
const pCount = parseInt(rec.pCount) || 0;
totalPatients += pCount;

if (rec.procs) Object.keys(rec.procs).forEach(pk => { if (procStats[pk] !== undefined) procStats[pk] += (parseInt(rec.procs[pk]) || 0); });

let cellContent = '-';
if (pCount > 0 || (rec.procs && Object.values(rec.procs).some(v => v > 0))) {
let details = [];
if (rec.procs) Object.keys(rec.procs).forEach(pk => { if (rec.procs[pk] > 0) details.push(`${pk.substr(0, 3)}:${rec.procs[pk]}`); });
cellContent = `<div class="flex flex-col items-center"><span class="font-bold text-blue-700">${pCount} H.</span><span class="text-[12px] text-gray-600 font-semibold">${details.join(', ')}</span></div>`;
}

// Veri HÃ¼cresi - KalÄ±n Ã‡erÃ§eve
h += `<td class="px-1 py-1 text-center border-2 border-gray-600 align-middle">${cellContent}</td>`;
});

// SatÄ±r Sonu Toplam - KalÄ±n Ã‡erÃ§eve
h += `<td class="px-2 py-2 text-center font-bold text-blue-800 bg-blue-100 border-2 border-gray-600">${totalPatients}</td></tr>`;
body.insertAdjacentHTML('beforeend', h);
});

// --- ALTAKÄ° KÃœÃ‡ÃœK "Ä°ÅLEM Ã–ZETÄ°" TABLOSU (Onu da Grid YapÄ±yoruz) ---
const psBody = document.getElementById('procedure-stats-body');
psBody.innerHTML = '';

// Bu kÃ¼Ã§Ã¼k tablonun baÅŸlÄ±ÄŸÄ±nÄ± da (HTML'de) grid yapmak iÃ§in:
const summaryTable = psBody.closest('table');
if (summaryTable) {
summaryTable.querySelectorAll('thead th').forEach(th => {
th.classList.add('border-2', 'border-gray-600');
th.classList.remove('bg-gray-50');
th.classList.add('bg-gray-200'); // BaÅŸlÄ±ÄŸÄ± biraz koyulaÅŸtÄ±r
});
}

Object.keys(procStats).forEach((proc, idx) => {
if (procStats[proc] > 0) {
const bgClass = (idx % 2 === 0) ? 'bg-white' : 'bg-gray-100';
psBody.innerHTML += `<tr class="border-b-2 border-gray-600 ${bgClass}">
<td class="px-4 py-1.5 font-bold text-gray-700 border-2 border-gray-600 text-xs">${proc}</td>
<td class="px-4 py-1.5 text-center font-bold text-green-700 border-2 border-gray-600 text-xs">${procStats[proc]}</td>
</tr>`;
}
});
}

// Tarih seÃ§iciyi bir gÃ¼n ileri/geri al
function changeEntryDate(days) {
const dateInput = document.getElementById('entry-date-picker');
if (!dateInput.value) dateInput.value = getLocalDateString(new Date());
const currentDate = new Date(dateInput.value);
currentDate.setDate(currentDate.getDate() + days);
dateInput.value = getLocalDateString(currentDate);
renderEntryForm();
lucide.createIcons();
// GÃ¼n ismini gÃ¼ncelle
updateDayName('entry-date-picker', 'entry-date-day');
}

// Genel tarih deÄŸiÅŸtirme fonksiyonu (herhangi bir tarih input iÃ§in)
function changeDateInput(inputId, days) {
const dateInput = document.getElementById(inputId);
if (!dateInput) return;
if (!dateInput.value) dateInput.value = getLocalDateString(new Date());
const currentDate = new Date(dateInput.value);
currentDate.setDate(currentDate.getDate() + days);
dateInput.value = getLocalDateString(currentDate);
// GÃ¼n ismini gÃ¼ncelle
const daySpanId = inputId + '-day';
updateDayName(inputId, daySpanId);
}

// GÃ¼n ismini gÃ¼ncelleme fonksiyonu (bugÃ¼n/yarÄ±n/dÃ¼n desteÄŸi ile)
function updateDayName(inputId, spanId) {
const dateInput = document.getElementById(inputId);
const daySpan = document.getElementById(spanId);
if (!dateInput || !daySpan) return;
if (!dateInput.value) {
daySpan.textContent = '';
return;
}
const days = ['Pazar', 'Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi'];
const date = new Date(dateInput.value);
const today = new Date();
today.setHours(0, 0, 0, 0);
const selectedDate = new Date(date);
selectedDate.setHours(0, 0, 0, 0);

const diffTime = selectedDate.getTime() - today.getTime();
const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

let dayLabel = '';
if (diffDays === 0) {
dayLabel = 'BugÃ¼n';
} else if (diffDays === 1) {
dayLabel = 'YarÄ±n';
} else if (diffDays === -1) {
dayLabel = 'DÃ¼n';
} else {
dayLabel = days[date.getDay()];
}
daySpan.textContent = '(' + dayLabel + ')';
}

function renderEntryForm() {
const dateInput = safeGet('entry-date-picker'); if (!dateInput.value) dateInput.value = getLocalDateString(new Date());
updateDayName('entry-date-picker', 'entry-date-day');
const l = document.getElementById('modal-staff-list'), dl = document.getElementById('modal-doctor-list'), tl = document.getElementById('modal-team-list'), date = dateInput.value;
const data = allRecords[date] || {}, docData = docRecords[date] || {}; l.innerHTML = ''; dl.innerHTML = ''; tl.innerHTML = '';
staffList.forEach(s => {
const r = data[s.name] || { mm: 0, mk: 0, am: 0, ak: 0, e: 0, specialists: [] }; const id = s.name.replace(/\s/g, '');
let specCheckboxes = ''; specialistList.forEach(sp => { const isM = r.specialists?.some(i => i.name === sp && i.time === 'Ã–Ã–'), isA = r.specialists?.some(i => i.name === sp && i.time === 'Ã–S'); specCheckboxes += `<div class="flex justify-between py-1 border-b border-gray-100 last:border-0"><span class="text-[10px] text-gray-600">${sp}</span><div class="flex gap-2"><label class="flex items-center gap-1"><input type="checkbox" class="specialist-checkbox" data-staff="${s.name}" data-spec="${sp}" data-time="Ã–Ã–" ${isM ? 'checked' : ''}><span class="text-[9px]">S</span></label><label class="flex items-center gap-1"><input type="checkbox" class="specialist-checkbox" data-staff="${s.name}" data-spec="${sp}" data-time="Ã–S" ${isA ? 'checked' : ''}><span class="text-[9px]">Ã–</span></label></div></div>`; });
l.innerHTML += `<div class="mb-2 border rounded overflow-hidden"><div class="flex justify-between p-2 bg-white hover:bg-gray-50"><div class="flex items-center gap-2 w-32"><button class="bg-blue-50 text-blue-600 p-1 rounded" onclick="toggleSpecPanel('${id}')"><i data-lucide="stethoscope" class="w-4 h-4"></i></button><span class="text-xs font-bold text-gray-700 truncate">${s.name}</span></div><div class="flex-1 grid grid-cols-4 gap-1 justify-items-center"><div class="col-span-2 grid grid-cols-2 gap-1 bg-gray-50 p-1 rounded w-full justify-items-center"><input type="checkbox" id="mm-${id}" class="custom-checkbox" ${r.mm ? 'checked' : ''} title="Ã–Ã–-Merkez"><input type="checkbox" id="mk-${id}" class="custom-checkbox" style="accent-color:#f97316" ${r.mk ? 'checked' : ''} title="Ã–Ã–-KÃ¶y"></div><div class="col-span-2 grid grid-cols-2 gap-1 bg-gray-200 p-1 rounded w-full justify-items-center"><input type="checkbox" id="am-${id}" class="custom-checkbox" ${r.am ? 'checked' : ''} title="Ã–S-Merkez"><input type="checkbox" id="ak-${id}" class="custom-checkbox" style="accent-color:#f97316" ${r.ak ? 'checked' : ''} title="Ã–S-KÃ¶y"></div></div><div class="w-10 flex justify-center"><input type="checkbox" id="e-${id}" class="custom-checkbox exam-checkbox" ${r.e ? 'checked' : ''}></div><div class="w-16 flex justify-center text-[10px] text-gray-400" id="count-${id}">${r.specialists ? r.specialists.length : 0} Uzm.</div></div><div id="spec-panel-${id}" class="hidden bg-gray-50 p-2 border-t">${specCheckboxes}</div></div>`;
});
doctorList.forEach((doc, idx) => {
const rec = docData[doc.name] || { pCount: '', km: '', procs: {} }; let procInputs = '';
procList.forEach(p => { const val = rec.procs ? (rec.procs[p] || '') : ''; procInputs += `<div class="flex items-center justify-between"><span class="text-[10px] text-gray-600">${p}</span><input type="number" class="w-12 p-1 border rounded text-xs text-center doc-proc-input" data-doc="${doc.name}" data-proc="${p}" value="${val}" min="0"></div>`; });
dl.innerHTML += `<div class="bg-white border rounded p-3 mb-2 shadow-sm"><div class="flex justify-between items-center mb-2 border-b pb-2"><span class="font-bold text-sm text-blue-800">${doc.name}</span><div class="flex items-center gap-3"><div class="flex items-center gap-1"><span class="text-xs font-bold text-gray-500">H:</span><input type="number" id="pcount-${idx}" class="w-12 p-1 border rounded text-sm text-center font-bold text-blue-600 doc-pcount" data-doc="${doc.name}" value="${rec.pCount}" min="0"></div><div class="flex items-center gap-1"><span class="text-xs font-bold text-emerald-600">KM:</span><input type="number" id="km-${idx}" class="w-14 p-1 border rounded text-sm text-center font-bold text-emerald-600 doc-km" data-doc="${doc.name}" value="${rec.km || ''}" min="0" step="0.1"></div></div></div><div class="grid grid-cols-2 gap-x-4 gap-y-2">${procInputs}</div></div>`;
});
if (teamList.length === 0) tl.innerHTML = '<p class="text-xs text-gray-400 text-center italic">HenÃ¼z liste/ekip tanÄ±mlanmamÄ±ÅŸ.<br>YÃ¶netim panelinden ekleyebilirsiniz.</p>';
teamList.forEach((teamName, i) => {
const assignedStaff = allRecords[date]?.teams?.[teamName] || [];
let staffCheckboxes = '';
staffList.forEach(s => { const isChecked = assignedStaff.includes(s.name) ? 'checked' : ''; staffCheckboxes += `<label class="flex items-center p-1 hover:bg-gray-50 rounded cursor-pointer"><input type="checkbox" class="team-staff-checkbox mr-2 accent-indigo-600" data-team="${teamName}" value="${s.name}" ${isChecked}><span class="text-xs text-gray-700">${s.name}</span></label>`; });
tl.innerHTML += `<div class="bg-white border border-indigo-100 rounded-lg shadow-sm overflow-hidden mb-2"><div class="bg-indigo-50 px-3 py-2 flex justify-between items-center cursor-pointer" onclick="toggleTeamBody('team-body-${i}')"><span class="font-bold text-xs text-indigo-800">${teamName}</span><i data-lucide="chevron-down" class="w-3 h-3 text-indigo-400"></i></div><div id="team-body-${i}" class="p-2 max-h-40 overflow-y-auto hidden">${staffCheckboxes}</div></div>`;
});
document.getElementById('daily-note').value = allNotes[date] || ''; lucide.createIcons();
}
window.toggleSpecPanel = (id) => { document.getElementById(`spec-panel-${id}`).classList.toggle('hidden'); };
window.toggleTeamBody = (id) => { document.getElementById(id).classList.toggle('hidden'); };

function renderMgmtLists() {
const sl = document.getElementById('staff-management-list'), dl = document.getElementById('doctor-management-list'), pl = document.getElementById('proc-management-list'), spl = document.getElementById('spec-management-list'), dsl = document.getElementById('doctor-staff-selection-list'), tml = document.getElementById('team-management-list');
const makeList = (list, type) => list.length ? list.map((item, i) => `<div class="flex justify-between items-center p-2 bg-gray-50 border rounded mb-1 text-xs"><span>${typeof item === 'object' ? item.name : item}</span><div class="flex gap-1"><button onclick="moveItem('${type}', ${i}, -1)" class="text-gray-500 hover:text-blue-600"><i data-lucide="arrow-up" class="w-3 h-3"></i></button><button onclick="moveItem('${type}', ${i}, 1)" class="text-gray-500 hover:text-blue-600"><i data-lucide="arrow-down" class="w-3 h-3"></i></button><button type="button" data-action="delete" data-type="${type}" data-index="${i}" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" class="w-3 h-3 pointer-events-none"></i></button></div></div>`).join('') : '<div class="text-xs text-gray-400 text-center p-2">Liste boÅŸ</div>';
if (sl) sl.innerHTML = makeList(staffList, 'staff');
if (dl) dl.innerHTML = makeList(doctorList, 'doc');
if (pl) pl.innerHTML = makeList(procList, 'proc');
if (spl) spl.innerHTML = makeList(specialistList, 'spec');
if (tml) tml.innerHTML = makeList(teamList, 'team');
if (dsl) {
let html = '';
if (staffList.length > 0) html += staffList.map(s => `<label class="flex justify-between items-center p-1.5 hover:bg-white rounded cursor-pointer border border-transparent hover:border-gray-200 transition"><div class="flex items-center"><input type="checkbox" class="custom-checkbox mr-2" onchange="toggleStaffInDocList('${s.name}', this.checked)" ${doctorList.some(d => d.name === s.name) ? 'checked' : ''}><span class="text-xs text-gray-700 font-medium select-none">${s.name}</span></div><span class="text-[10px] text-blue-500 bg-blue-50 px-1 rounded">Personel</span></label>`).join('');
if (quickList.length > 0) html += quickList.map((q, qIdx) => `<div class="flex justify-between items-center p-1.5 hover:bg-white rounded border border-transparent hover:border-gray-200 transition"><label class="flex items-center cursor-pointer flex-1"><input type="checkbox" class="custom-checkbox mr-2" onchange="toggleStaffInDocList('${q}', this.checked)" ${doctorList.some(d => d.name === q) ? 'checked' : ''}><span class="text-xs text-gray-700 font-medium select-none">${q}</span></label><button onclick="remQuickItem(${qIdx})" class="text-red-400 hover:text-red-600 p-1 rounded hover:bg-red-50 ml-2"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div>`).join('');
dsl.innerHTML = html || '<div class="text-xs text-gray-400 p-2">Liste boÅŸ</div>';
}
lucide.createIcons();
}

// --- GÃœNCELLENMÄ°Å SEKME DEÄÄ°ÅTÄ°RME (Ã–ZEL PAROLA KORUMALI) ---

// Kilitli sekmelerin aÃ§Ä±k kalma durumu (Ram'de tutulur)

// Mobil Tab MenÃ¼ Toggle Fonksiyonu
window.toggleMobileTabMenu = function() {
const dropdown = document.getElementById('mobile-tab-dropdown');
const arrow = document.getElementById('mobile-menu-arrow');
if (dropdown) {
dropdown.classList.toggle('hidden');
if (arrow) arrow.classList.toggle('rotate-180');
}
};

// Sekme isimlerini tutan obje
const tabNames = {
'hastatakip': 'Hasta Takip',
'personel': 'Personel',
'uzman': 'Uzman EÅŸleÅŸme',
'analiz': 'GeÃ§miÅŸ Analiz',
'rutinler': 'Rutinler',
'acilcanta': 'Acil Ã‡anta',
'butce': 'BÃ¼tÃ§e',
'notlar': 'Sor. Hem. Not',
'drnotlar': 'Dr NotlarÄ±',
'nobet': 'NÃ¶bet',
'cihazlar': 'Cihaz/Zimmet',
'istatistik': 'Ä°statistikler',
'puantaj': 'Puantaj',
'rehber': 'Rehber',
'takvim': 'Takvim',
'inrhesaplayici': 'Ä°NR Hesap',
'dogumgunu': 'DoÄŸum GÃ¼nÃ¼',
'pansuman': 'Pansuman',
'sondainr': 'Sonda/Ä°NR/NG',
'izinrapor': 'Ä°zin/Rapor',
'sokaksorgu': 'Sokak Sorgu'
};

window.switchTab = (tabId) => {
// 1. DÄ°NAMÄ°K GÃœVENLÄ°K KONTROLÃœ
// EÄŸer bu sekme kilitlenecekler listesindeyse HER SEFERINDE ÅŸifre sor
const userKey = window.currentUser?.email?.replace(/\./g, '_').replace(/@/g, '_at_');
const userLockedTabs = userKey && window.lockedTabsConfig ? window.lockedTabsConfig[userKey] || {} : {};
const isTabLocked = (Array.isArray(window.lockedTabsConfig) && window.lockedTabsConfig.includes(tabId)) || userLockedTabs[tabId];

if (isTabLocked) {
// Sekme adÄ±nÄ± bulalÄ±m (Buton textinden)
let tabName = tabId.toUpperCase();

const input = prompt(`ğŸ”’ "${tabName}" sekmesi kilitli.\nEriÅŸim iÃ§in sekme parolasÄ±nÄ± girin:`);
if (input === null) return; // Ä°ptal etti

if (input !== customTabPassword) {
return showToast("HatalÄ± parola! EriÅŸim reddedildi.", "error");
}

showToast("EriÅŸim izni verildi.");
}

// 2. STANDART SEKME DEÄÄ°ÅTÄ°RME
document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
document.getElementById(`tab-${tabId}`).classList.remove('hidden');

document.querySelectorAll('.tab-btn').forEach(b => {
b.classList.remove('border-indigo-600', 'text-indigo-700');
b.classList.add('border-transparent', 'text-gray-500');
});

if (event && event.target) {
const btn = event.target.closest('.tab-btn');
if (btn) {
btn.classList.remove('border-transparent', 'text-gray-500');
btn.classList.add('border-indigo-600', 'text-indigo-700');
}
}

// 3. MOBÄ°L MENÃœ GÃœNCELLE
const currentTabNameEl = document.getElementById('current-tab-name');
if (currentTabNameEl && tabNames[tabId]) {
currentTabNameEl.textContent = tabNames[tabId];
}
// Mobil menÃ¼de aktif sekmeyi vurgula
document.querySelectorAll('.mobile-tab-item').forEach(item => {
item.classList.remove('bg-indigo-100', 'text-indigo-700');
if (item.getAttribute('onclick')?.includes(tabId)) {
item.classList.add('bg-indigo-100', 'text-indigo-700');
}
});

const globalNav = document.getElementById('global-date-nav');
if (globalNav) {
if (tabId === 'butce' || tabId === 'analiz' || tabId === 'rutinler' || tabId === 'acilcanta' || tabId === 'notlar' || tabId === 'drnotlar' || tabId === 'nobet' || tabId === 'cihazlar' || tabId === 'istatistik' || tabId === 'rehber' || tabId === 'takvim' || tabId === 'hastatakip' || tabId === 'puantaj' || tabId === 'inrhesaplayici' || tabId === 'izinrapor' || tabId === 'dogumgunu' || tabId === 'pansuman' || tabId === 'sondainr' || tabId === 'sokaksorgu') {
globalNav.classList.add('hidden');
} else {
globalNav.classList.remove('hidden');
}
}

// --- BURASI EKSÄ°KTÄ°, O YÃœZDEN BOÅ GELÄ°YORDU ---
if (tabId === 'puantaj') renderPuantaj(); // <--- BU SATIR Ã‡OK Ã–NEMLÄ°

if (tabId === 'uzman') renderSpecialistTab();
if (tabId === 'rutinler' && typeof renderRoutines === 'function') renderRoutines();
if (tabId === 'acilcanta') { renderBagSelector(); renderEmergency(); }
if (tabId === 'butce') renderBudgetHeader();
if (tabId === 'notlar') renderGeneralNotes();
if (tabId === 'drnotlar') renderDrNotes();
if (tabId === 'nobet') renderShiftHeader();
if (tabId === 'cihazlar') renderDeviceTable();
if (tabId === 'istatistik') renderDashboard();
if (tabId === 'hastatakip') renderReminderProcs();
if (tabId === 'rehber') renderPhonebook();
if (tabId === 'takvim') renderCalendar();
if (tabId === 'pansuman' && typeof renderPansumanDay === 'function') renderPansumanDay();
if (tabId === 'sondainr' && typeof renderSondaInrContent === 'function') {
renderSondaInrContent();
// Tarih alanlarÄ±nÄ± bugÃ¼nÃ¼n tarihiyle doldur
const today = new Date().toISOString().split('T')[0];
const dateInput = document.getElementById('sondainr-date');
if (dateInput && !dateInput.value) {
dateInput.value = today;
}
}
if (tabId === 'sokaksorgu' && typeof initStreetSearch === 'function') {
initStreetSearch();
}
};

function setupEventListeners() {
setupKeyboardShortcuts(); //
const em = document.getElementById('data-entry-modal'), sm = document.getElementById('staff-modal'), pm = document.getElementById('password-modal');
const toggle = (m, s) => { m.classList.toggle('hidden', !s); m.classList.toggle('flex', s); };

safeGet('open-entry-modal-btn').onclick = () => checkLock(() => { toggle(em, 1); renderEntryForm(); });
safeGet('open-staff-modal-btn').onclick = () => checkLock(() => { toggle(sm, 1); renderMgmtLists(); });
document.querySelectorAll('.close-modal,.close-staff-modal').forEach(b => b.onclick = () => { toggle(em, 0); toggle(sm, 0); });

safeGet('save-entry-btn').onclick = async () => {
const date = document.getElementById('entry-date-picker').value; if (!date) return showToast('Tarih?', 'error');
if (!allRecords[date]) allRecords[date] = {};
staffList.forEach(s => {
const id = s.name.replace(/\s/g, '');
const entry = { mm: document.getElementById(`mm-${id}`).checked ? 1 : 0, mk: document.getElementById(`mk-${id}`).checked ? 1 : 0, am: document.getElementById(`am-${id}`).checked ? 1 : 0, ak: document.getElementById(`ak-${id}`).checked ? 1 : 0, e: document.getElementById(`e-${id}`).checked ? 1 : 0, specialists: [] };
const specPanel = document.getElementById(`spec-panel-${id}`);
if (specPanel) specPanel.querySelectorAll('.specialist-checkbox').forEach(cb => { if (cb.checked) entry.specialists.push({ name: cb.dataset.spec, time: cb.dataset.time }); });
allRecords[date][s.name] = entry;
});
if (!docRecords[date]) docRecords[date] = {};
document.querySelectorAll('.doc-pcount').forEach(inp => {
const docName = inp.dataset.doc; const procs = {};
document.querySelectorAll(`.doc-proc-input[data-doc="${docName}"]`).forEach(pi => procs[pi.dataset.proc] = pi.value);
const kmInput = document.querySelector(`.doc-km[data-doc="${docName}"]`);
const kmValue = kmInput ? kmInput.value : '';
docRecords[date][docName] = { pCount: inp.value, km: kmValue, procs };
});
if (!allRecords[date].teams) allRecords[date].teams = {};
const teamTemp = {};
document.querySelectorAll('.team-staff-checkbox').forEach(cb => { if (cb.checked) { if (!teamTemp[cb.dataset.team]) teamTemp[cb.dataset.team] = []; teamTemp[cb.dataset.team].push(cb.value); } });
allRecords[date].teams = teamTemp;

const note = document.getElementById('daily-note').value; if (note) allNotes[date] = note; else delete allNotes[date];
await saveAll(); showToast('âœ… Kaydedildi!');
};

safeGet('add-staff-btn').onclick = async () => { const n = safeGet('new-staff-name').value.trim(); const r = safeGet('new-staff-role').value.trim() || 'Personel'; if (n) { staffList.push({ name: n, role: r }); await saveAll(); renderMgmtLists(); safeGet('new-staff-name').value = ''; showToast('Personel eklendi'); } };
safeGet('add-doctor-btn').onclick = async () => { const n = safeGet('new-doctor-name').value.trim(); if (n) { doctorList.push({ name: n }); await saveAll(); renderMgmtLists(); safeGet('new-doctor-name').value = ''; showToast('Doktor eklendi'); } };
safeGet('add-proc-btn').onclick = async () => { const n = safeGet('new-proc-name').value.trim(); if (n) { procList.push(n); await saveAll(); renderMgmtLists(); safeGet('new-proc-name').value = ''; showToast('Ä°ÅŸlem eklendi'); } };
safeGet('add-spec-btn').onclick = async () => { const n = safeGet('new-spec-name').value.trim(); if (n) { specialistList.push(n); await saveAll(); renderMgmtLists(); safeGet('new-spec-name').value = ''; showToast('UzmanlÄ±k eklendi'); } };
safeGet('add-team-btn').onclick = async () => { const n = safeGet('new-team-name').value.trim(); if (n) { teamList.push(n); await saveAll(); renderMgmtLists(); safeGet('new-team-name').value = ''; showToast('Ekip eklendi'); } };
safeGet('add-leave-btn').onclick = async () => {
const sName = safeGet('leave-staff-input').value.trim(), type = safeGet('leave-type-select').value, sDate = safeGet('leave-start-date').value, eDate = safeGet('leave-end-date').value;
if (!sName || !sDate || !eDate) { showToast('Eksik bilgi', 'error'); return; }

// Tarih Ã§akÄ±ÅŸmasÄ± kontrolÃ¼
const hasConflict = leaveRecords.some(rec => {
if (rec.staffName !== sName) return false;
// Tarih aralÄ±klarÄ± Ã¶rtÃ¼ÅŸÃ¼yor mu kontrol et
return (sDate <= rec.endDate && eDate >= rec.startDate);
});

if (hasConflict) {
showToast('Bu personel seÃ§ili tarihlerde zaten izinli/raporlu!', 'error');
return;
}

leaveRecords.push({ staffName: sName, type: type, startDate: sDate, endDate: eDate });
await saveAll();
showToast('Ä°zin eklendi');

// ğŸ–ï¸ TELEGRAM BÄ°LDÄ°RÄ°MÄ°: Ä°zin/rapor eklendiÄŸinde anÄ±nda bildir
if (typeof isTelegramNotifyEnabled === 'function' && isTelegramNotifyEnabled('leave')) {
const startDateStr = new Date(sDate).toLocaleDateString('tr-TR');
const endDateStr = new Date(eDate).toLocaleDateString('tr-TR');
const message = `ğŸ–ï¸ YENÄ° Ä°ZÄ°N/RAPOR\n\nğŸ‘¤ Personel: ${sName}\nğŸ“… Tarih: ${startDateStr} - ${endDateStr}\nğŸ“ TÃ¼r: ${type}`;
sendTelegramMessage(message, 'leave');
}
};

document.addEventListener('click', (e) => { const btn = e.target.closest('button[data-action="delete"]'); if (btn) { const type = btn.dataset.type; const idx = parseInt(btn.dataset.index); remItem(type, idx); } });

safeGet('lock-toggle').onclick = () => { if (isEditing) { isEditing = false; updateLockUI(); } else { toggle(pm, 1); document.getElementById('password-input').focus(); } };
safeGet('modal-submit').onclick = () => { if (document.getElementById('password-input').value === adminPanelPassword) { isEditing = true; updateLockUI(); toggle(pm, 0); document.getElementById('password-input').value = ''; } else document.getElementById('password-error').classList.remove('hidden'); };
safeGet('password-input').onkeypress = (e) => { if (e.key === 'Enter') { e.preventDefault(); safeGet('modal-submit').click(); } };
safeGet('modal-cancel').onclick = () => { toggle(pm, 0); document.getElementById('password-input').value = ''; };
safeGet('prev-week').onclick = () => changeWeek(-7); safeGet('next-week').onclick = () => changeWeek(7);
safeGet('entry-date-picker').onchange = renderEntryForm;
safeGet('import-file').onchange = importData;
document.querySelectorAll('.close-note-modal').forEach(b => b.onclick = () => { document.getElementById('note-read-modal').classList.add('hidden'); document.getElementById('note-read-modal').classList.remove('flex'); });

safeGet('btn-open-settings').onclick = openSettingsModal;
safeGet('btn-close-settings').onclick = closeSettingsModal;
safeGet('btn-save-api-key').onclick = saveApiKey;
safeGet('btn-change-password').onclick = openPwModal;
safeGet('btn-close-pw').onclick = closePwModal;
safeGet('btn-save-pw').onclick = saveNewPw;
safeGet('btn-ai-report').onclick = generateAIReport;
safeGet('btn-close-ai-header').onclick = closeAiModal;
safeGet('btn-run-analysis').onclick = runAnalysis;
const btnSend = document.getElementById('btn-send-ai-query'); if (btnSend) btnSend.onclick = sendAIQuery;
const inputAI = document.getElementById('ai-user-input'); if (inputAI) inputAI.addEventListener('keypress', function (e) { if (e.key === 'Enter') sendAIQuery(); });
}

async function runAnalysis() {
const sDate = document.getElementById('analysis-start').value, eDate = document.getElementById('analysis-end').value, filterVal = document.getElementById('analysis-filter').value;
if (!sDate || !eDate) return showToast("Tarih seÃ§in", "error");

// --- NÃ–BET ANALÄ°ZÄ° BLOÄU (GÃœNCELLENMÄ°Å) ---
if (filterVal === 'shift_stats') {
document.getElementById('standard-analysis-container').classList.add('hidden');
document.getElementById('leave-analysis-container').classList.add('hidden');
document.getElementById('doctor-leave-analysis-container').classList.add('hidden');

const detContainer = document.getElementById('specialist-detail-container');
detContainer.classList.remove('hidden');

const headerEl = detContainer.firstElementChild;
if (headerEl) {
headerEl.className = "bg-indigo-50 px-4 py-3 border-b border-indigo-100 font-bold text-indigo-900 flex items-center";
headerEl.innerHTML = '<i data-lucide="calendar-clock" class="w-5 h-5 mr-2"></i> NÃ¶bet Performans Raporu';
}

const detBody = document.getElementById('specialist-detail-body');
detBody.innerHTML = '';

const stats = {};
// 1. Ã–nce tarihleri kronolojik sÄ±raya dizelim (KarmaÅŸayÄ± Ã¶nler)
const filteredShifts = shiftList
.filter(s => s.date >= sDate && s.date <= eDate)
.sort((a, b) => a.date.localeCompare(b.date));

if (filteredShifts.length === 0) {
detBody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400 border-2 border-gray-600">Bu tarih aralÄ±ÄŸÄ±nda nÃ¶bet kaydÄ± bulunmamaktadÄ±r.</td></tr>';
return;
}

filteredShifts.forEach(s => {
let cleanStaff = s.staff ? s.staff.trim() : "Bilinmeyen";
if (!stats[cleanStaff]) stats[cleanStaff] = {};
if (!stats[cleanStaff][s.type]) stats[cleanStaff][s.type] = { count: 0, dates: [] };

stats[cleanStaff][s.type].count++;

const dObj = new Date(s.date);
// GÃ¼n adÄ±nÄ± kÄ±saltÄ±lmÄ±ÅŸ al (Pzt, Sal, Ã‡ar...)
const dayName = dObj.toLocaleDateString('tr-TR', { weekday: 'short' });
const dateStr = `${dObj.getDate()}/${dObj.getMonth() + 1}`;

// ÅÄ±k bir etiket oluÅŸtur (Tarih + GÃ¼n)
const badgeHtml = `
<span class="inline-flex items-center gap-1 bg-gray-50 border border-gray-200 text-gray-700 px-1.5 py-0.5 rounded text-[10px] mx-0.5 mb-1 whitespace-nowrap shadow-sm hover:bg-indigo-50 hover:border-indigo-200 transition">
<span class="font-bold">${dateStr}</span>
<span class="text-indigo-600 text-[9px] border-l border-gray-300 pl-1">${dayName}</span>
</span>`;

stats[cleanStaff][s.type].dates.push(badgeHtml);
});

Object.keys(stats).sort().forEach(staff => {
const types = stats[staff];
Object.keys(types).forEach(type => {
const data = types[type];
detBody.innerHTML += `
<tr class="hover:bg-gray-50 border-b-2 border-gray-600">
<td class="px-4 py-2 font-bold text-gray-700 border-2 border-gray-600 text-xs">${staff}</td>
<td class="px-4 py-2 text-gray-600 border-2 border-gray-600 text-xs font-medium">${type}</td>
<td class="px-4 py-2 text-center font-extrabold text-indigo-700 border-2 border-gray-600 text-sm bg-indigo-50/30">${data.count}</td>
<td class="px-4 py-2 text-[10px] text-gray-500 leading-relaxed border-2 border-gray-600 flex flex-wrap gap-0.5 items-center">
${data.dates.join('')}
</td>
</tr>
`;
});
});
lucide.createIcons();
return;
}

// -----------------------------------------------------
// --- STANDART ANALÄ°Z BAÅLIYOR ---
document.getElementById('analysis-results').classList.remove('hidden');

// !!! BURASI YENÄ°: Sabit HTML BaÅŸlÄ±klarÄ±nÄ± JS ile Zorla KalÄ±nlaÅŸtÄ±r !!!
setTimeout(() => {
document.querySelectorAll('#standard-analysis-container table thead th').forEach(th => {
th.classList.add('border-2', 'border-gray-600');
th.classList.remove('border-b'); // Eski ince Ã§izgiyi sil
});
}, 50); // HTML render olduktan hemen sonra Ã§alÄ±ÅŸsÄ±n

const dRange = []; let curr = new Date(sDate); const end = new Date(eDate);
while (curr <= end) { dRange.push(getLocalDateString(curr)); curr.setDate(curr.getDate() + 1); }

// --- Ä°ZÄ°N RAPORU ---
if (filterVal === 'leave_report') {
document.getElementById('standard-analysis-container').classList.add('hidden');
document.getElementById('leave-analysis-container').classList.remove('hidden'); document.getElementById('specialist-detail-container').classList.add('hidden');

// Ä°zin Tablosu BaÅŸlÄ±klarÄ±nÄ± KalÄ±nlaÅŸtÄ±r
const leaveTable = document.querySelector('#leave-analysis-container table');
if (leaveTable) leaveTable.querySelectorAll('thead th').forEach(th => th.classList.add('border-2', 'border-gray-600'));

const tbody = document.getElementById('leave-analysis-body'); tbody.innerHTML = '';
const filteredLeaves = leaveRecords.filter(l => { return (l.startDate <= eDate && l.endDate >= sDate); }).sort((a, b) => a.startDate.localeCompare(b.startDate));

if (filteredLeaves.length === 0) {
tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400 border-2 border-gray-600">Bu tarih aralÄ±ÄŸÄ±nda personel izin/rapor kaydÄ± bulunamadÄ±.</td></tr>';
} else {
filteredLeaves.forEach(l => {
const s = new Date(l.startDate), e = new Date(l.endDate), diffDays = Math.ceil(Math.abs(e - s) / (1000 * 60 * 60 * 24)) + 1; const typeClass = l.type === 'Rapor' ? 'bg-red-100 text-red-700' : 'bg-orange-100 text-orange-700';
// Ä°zin Tablosu HÃ¼creleri (Grid)
tbody.innerHTML += `<tr class="border-b-2 border-gray-600 hover:bg-gray-50"><td class="px-4 py-3 font-medium text-gray-700 border-2 border-gray-600">${l.staffName}</td><td class="px-4 py-3 text-center border-2 border-gray-600"><span class="px-2 py-1 rounded text-xs font-bold ${typeClass}">${l.type}</span></td><td class="px-4 py-3 text-center text-gray-600 border-2 border-gray-600">${s.toLocaleDateString('tr-TR')}</td><td class="px-4 py-3 text-center text-gray-600 border-2 border-gray-600">${e.toLocaleDateString('tr-TR')}</td><td class="px-4 py-3 text-center font-bold text-gray-700 border-2 border-gray-600">${diffDays} GÃ¼n</td></tr>`;
});
}

// ===== DOKTOR Ä°ZÄ°N/RAPOR LÄ°STESÄ° =====
const doctorLeaveContainer = document.getElementById('doctor-leave-analysis-container');
doctorLeaveContainer.classList.remove('hidden');
const doctorTbody = document.getElementById('doctor-leave-analysis-body');
doctorTbody.innerHTML = '';

const filteredDoctorLeaves = doctorLeaveRecords.filter(l => { return (l.startDate <= eDate && l.endDate >= sDate); }).sort((a, b) => a.startDate.localeCompare(b.startDate));

if (filteredDoctorLeaves.length === 0) {
doctorTbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400">Bu tarih aralÄ±ÄŸÄ±nda doktor izin/rapor kaydÄ± bulunamadÄ±.</td></tr>';
} else {
filteredDoctorLeaves.forEach(l => {
const s = new Date(l.startDate), e = new Date(l.endDate), diffDays = Math.ceil(Math.abs(e - s) / (1000 * 60 * 60 * 24)) + 1;
const typeClass = l.type === 'Rapor' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700';
doctorTbody.innerHTML += `<tr class="border-b hover:bg-blue-50"><td class="px-4 py-3 font-medium text-gray-700">${l.doctorName}</td><td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded text-xs font-bold ${typeClass}">${l.type}</span></td><td class="px-4 py-3 text-center text-gray-600">${s.toLocaleDateString('tr-TR')}</td><td class="px-4 py-3 text-center text-gray-600">${e.toLocaleDateString('tr-TR')}</td><td class="px-4 py-3 text-center font-bold text-gray-700">${diffDays} GÃ¼n</td></tr>`;
});
}
lucide.createIcons();
// ===== DOKTOR Ä°ZÄ°N/RAPOR LÄ°STESÄ° BÄ°TTÄ° =====
return;
}

// --- TAKÄ°P NOTLARI ANALÄ°ZÄ° ---
if (filterVal === 'daily_notes') {
document.getElementById('standard-analysis-container').classList.add('hidden');
document.getElementById('leave-analysis-container').classList.add('hidden');
document.getElementById('doctor-leave-analysis-container').classList.add('hidden');

const detContainer = document.getElementById('specialist-detail-container');
detContainer.classList.remove('hidden');

const headerEl = detContainer.firstElementChild;
if (headerEl) {
headerEl.className = "bg-yellow-50 px-4 py-3 border-b border-yellow-100 font-bold text-yellow-800 flex items-center";
headerEl.innerHTML = '<i data-lucide="sticky-note" class="w-5 h-5 mr-2"></i> Takip NotlarÄ±';
}

// Tablo baÅŸlÄ±klarÄ±nÄ± deÄŸiÅŸtir
const thead = detContainer.querySelector('thead tr');
if (thead) {
thead.innerHTML = `
<th class="px-4 py-3 border-r border-2 border-gray-600 bg-yellow-100 text-yellow-800">Tarih</th>
<th class="px-4 py-3 border-2 border-gray-600 bg-yellow-100 text-yellow-800" colspan="3">Not Ä°Ã§eriÄŸi</th>
`;
}

const detBody = document.getElementById('specialist-detail-body');
detBody.innerHTML = '';

// allNotes iÃ§inden tarih aralÄ±ÄŸÄ±ndaki notlarÄ± filtrele
const filteredNotes = [];
Object.keys(allNotes).forEach(dateKey => {
if (dateKey >= sDate && dateKey <= eDate && allNotes[dateKey]) {
filteredNotes.push({
date: dateKey,
note: allNotes[dateKey]
});
}
});

// Tarihe gÃ¶re sÄ±rala (en yeni en Ã¼stte)
filteredNotes.sort((a, b) => b.date.localeCompare(a.date));

if (filteredNotes.length === 0) {
detBody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400 border-2 border-gray-600">Bu tarih aralÄ±ÄŸÄ±nda takip notu bulunmamaktadÄ±r.</td></tr>';
lucide.createIcons();
return;
}

filteredNotes.forEach((item, idx) => {
const dObj = new Date(item.date);
const dayName = dObj.toLocaleDateString('tr-TR', { weekday: 'long' });
const formattedDate = dObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
const bgClass = (idx % 2 === 0) ? 'bg-white' : 'bg-gray-50';

detBody.innerHTML += `
<tr class="${bgClass} hover:bg-yellow-50 border-b-2 border-gray-600">
<td class="px-4 py-3 font-bold text-gray-700 border-2 border-gray-600 text-sm whitespace-nowrap">
<div class="flex flex-col">
<span class="text-yellow-700">${formattedDate}</span>
<span class="text-xs text-gray-500">${dayName}</span>
</div>
</td>
<td colspan="3" class="px-4 py-3 text-gray-700 border-2 border-gray-600">
<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm">
ğŸ“ ${item.note}
</div>
</td>
</tr>`;
});

lucide.createIcons();
return;
}

// --- AKTÄ°VÄ°TE LOGLARI ANALÄ°ZÄ° ---
if (filterVal === 'activity_logs') {
document.getElementById('standard-analysis-container').classList.add('hidden');
document.getElementById('leave-analysis-container').classList.add('hidden');
document.getElementById('doctor-leave-analysis-container').classList.add('hidden');

const detContainer = document.getElementById('specialist-detail-container');
detContainer.classList.remove('hidden');

const headerEl = detContainer.firstElementChild;
if (headerEl) {
headerEl.className = "bg-blue-50 px-4 py-3 border-b border-blue-100 font-bold text-blue-800 flex items-center";
headerEl.innerHTML = '<i data-lucide="clipboard-list" class="w-5 h-5 mr-2"></i> Aktivite LoglarÄ±';
}

// Tablo baÅŸlÄ±klarÄ±nÄ± deÄŸiÅŸtir
const thead = detContainer.querySelector('thead tr');
if (thead) {
thead.innerHTML = `
<th class="px-4 py-3 border-2 border-gray-600 bg-blue-100 text-blue-800">Tarih/Saat</th>
<th class="px-4 py-3 border-2 border-gray-600 bg-blue-100 text-blue-800">KullanÄ±cÄ±</th>
<th class="px-4 py-3 border-2 border-gray-600 bg-blue-100 text-blue-800">Ä°ÅŸlem</th>
<th class="px-4 py-3 border-2 border-gray-600 bg-blue-100 text-blue-800">Detay</th>
`;
}

const detBody = document.getElementById('specialist-detail-body');
detBody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400">Loglar yÃ¼kleniyor...</td></tr>';

// Firebase'den loglarÄ± Ã§ek
try {
const snapshot = await database.ref('evde_saglik_ortak_veri/activity_logs').orderByChild('timestamp').once('value');
const data = snapshot.val();

if (!data) {
detBody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400 border-2 border-gray-600">Aktivite logu bulunmamaktadÄ±r.</td></tr>';
lucide.createIcons();
return;
}

// LoglarÄ± diziye Ã§evir ve tarih aralÄ±ÄŸÄ±na gÃ¶re filtrele
const allLogs = Object.values(data);
const filteredLogs = allLogs.filter(log => {
if (!log.timestamp) return false;
const logDate = log.timestamp.split('T')[0];
return logDate >= sDate && logDate <= eDate;
}).sort((a, b) => b.timestamp.localeCompare(a.timestamp));

if (filteredLogs.length === 0) {
detBody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400 border-2 border-gray-600">Bu tarih aralÄ±ÄŸÄ±nda aktivite logu bulunmamaktadÄ±r.</td></tr>';
lucide.createIcons();
return;
}

detBody.innerHTML = '';

// Log tÃ¼rleri ve ikonlarÄ±
const logIcons = {
shift: 'ğŸ“…', budget: 'ğŸ’°', emergency: 'ğŸš‘', device: 'ğŸ“±',
reminder: 'â°', contact: 'ğŸ“', note: 'ğŸ“', routine: 'ğŸ”„', pansuman: 'ğŸ©¹', sondainr: 'ğŸ”§', general: 'ğŸ“‹'
};

filteredLogs.forEach((log, idx) => {
const dObj = new Date(log.timestamp);
const formattedDate = dObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', year: 'numeric' });
const formattedTime = dObj.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
const bgClass = (idx % 2 === 0) ? 'bg-white' : 'bg-gray-50';
const userDisplay = log.user ? log.user.split('@')[0] : 'Bilinmiyor';
const icon = logIcons[log.type] || logIcons.general;

detBody.innerHTML += `
<tr class="${bgClass} hover:bg-blue-50 border-b-2 border-gray-600">
<td class="px-4 py-3 border-2 border-gray-600 text-sm whitespace-nowrap">
<div class="flex flex-col">
<span class="font-bold text-gray-700">${formattedDate}</span>
<span class="text-xs text-blue-600">${formattedTime}</span>
</div>
</td>
<td class="px-4 py-3 border-2 border-gray-600">
<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-bold">${userDisplay}</span>
</td>
<td class="px-4 py-3 border-2 border-gray-600 font-medium text-gray-700">
${icon} ${log.action || 'Ä°ÅŸlem'}
</td>
<td class="px-4 py-3 border-2 border-gray-600 text-sm text-gray-600">
${log.details || '-'}
</td>
</tr>`;
});

lucide.createIcons();
} catch (error) {
console.error('Activity logs yÃ¼kleme hatasÄ±:', error);
detBody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-red-400 border-2 border-gray-600">Loglar yÃ¼klenirken hata oluÅŸtu.</td></tr>';
}
return;
}

// --- KM Ä°STATÄ°STÄ°ÄÄ° ANALÄ°ZÄ° ---
if (filterVal === 'km_stats') {
document.getElementById('standard-analysis-container').classList.add('hidden');
document.getElementById('leave-analysis-container').classList.add('hidden');
document.getElementById('doctor-leave-analysis-container').classList.add('hidden');

const detContainer = document.getElementById('specialist-detail-container');
detContainer.classList.remove('hidden');

const headerEl = detContainer.firstElementChild;
if (headerEl) {
headerEl.className = "bg-emerald-50 px-4 py-3 border-b border-emerald-100 font-bold text-emerald-800 flex items-center";
headerEl.innerHTML = '<i data-lucide="map-pin" class="w-5 h-5 mr-2"></i> ğŸš— KM Ä°statistiÄŸi';
}

// Tablo baÅŸlÄ±klarÄ±nÄ± deÄŸiÅŸtir
const thead = detContainer.querySelector('thead tr');
if (thead) {
thead.innerHTML = `
<th class="px-4 py-3 border-r border-2 border-gray-600 bg-emerald-100 text-emerald-800">Tarih</th>
<th class="px-4 py-3 border-2 border-gray-600 bg-emerald-100 text-emerald-800">GÃ¼n</th>
<th class="px-4 py-3 border-2 border-gray-600 bg-emerald-100 text-emerald-800">Doktor</th>
<th class="px-4 py-3 border-2 border-gray-600 bg-emerald-100 text-emerald-800 text-right">KM</th>
`;
}

const detBody = document.getElementById('specialist-detail-body');
detBody.innerHTML = '';

// docRecords'dan KM verilerini filtrele
const kmData = [];
let totalKm = 0;

Object.keys(docRecords).forEach(dateKey => {
if (dateKey >= sDate && dateKey <= eDate) {
Object.keys(docRecords[dateKey]).forEach(docName => {
const rec = docRecords[dateKey][docName];
if (rec && rec.km && parseFloat(rec.km) > 0) {
const kmVal = parseFloat(rec.km);
totalKm += kmVal;
kmData.push({
date: dateKey,
docName: docName,
km: kmVal
});
}
});
}
});

// Tarihe gÃ¶re sÄ±rala (en yeni en Ã¼stte)
kmData.sort((a, b) => b.date.localeCompare(a.date));

if (kmData.length === 0) {
detBody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400 border-2 border-gray-600">Bu tarih aralÄ±ÄŸÄ±nda KM verisi bulunmamaktadÄ±r.</td></tr>';
lucide.createIcons();
return;
}

// Doktor bazlÄ± toplam hesapla
const docTotals = {};
kmData.forEach(item => {
if (!docTotals[item.docName]) docTotals[item.docName] = 0;
docTotals[item.docName] += item.km;
});

kmData.forEach((item, idx) => {
const dObj = new Date(item.date);
const dayName = dObj.toLocaleDateString('tr-TR', { weekday: 'long' });
const formattedDate = dObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
const bgClass = (idx % 2 === 0) ? 'bg-white' : 'bg-gray-50';

detBody.innerHTML += `
<tr class="${bgClass} hover:bg-emerald-50 border-b-2 border-gray-600">
<td class="px-4 py-3 font-bold text-gray-700 border-2 border-gray-600 text-sm whitespace-nowrap">
<span class="text-emerald-700">${formattedDate}</span>
</td>
<td class="px-4 py-3 text-gray-600 border-2 border-gray-600 text-sm">${dayName}</td>
<td class="px-4 py-3 border-2 border-gray-600">
<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-bold">${item.docName}</span>
</td>
<td class="px-4 py-3 border-2 border-gray-600 text-right">
<span class="font-bold text-emerald-600 text-lg">${item.km.toFixed(1)} km</span>
</td>
</tr>`;
});

// Ã–zet satÄ±rÄ± ekle
detBody.innerHTML += `
<tr class="bg-emerald-100 dark:bg-emerald-900 font-bold border-t-4 border-emerald-500">
<td colspan="3" class="px-4 py-3 text-emerald-800 dark:text-emerald-200 border-2 border-gray-600 text-right">
ğŸ“Š TOPLAM:
</td>
<td class="px-4 py-3 border-2 border-gray-600 text-right">
<span class="text-emerald-700 dark:text-emerald-300 text-xl">${totalKm.toFixed(1)} km</span>
</td>
</tr>`;

// Doktor bazlÄ± Ã¶zet
Object.entries(docTotals).sort((a, b) => b[1] - a[1]).forEach(([docName, total]) => {
detBody.innerHTML += `
<tr class="bg-emerald-50 dark:bg-emerald-950 border-b border-emerald-200 dark:border-emerald-700">
<td colspan="3" class="px-4 py-2 text-gray-600 dark:text-gray-300 border-2 border-gray-600 text-right text-sm">
${docName}:
</td>
<td class="px-4 py-2 border-2 border-gray-600 text-right">
<span class="font-bold text-emerald-600 dark:text-emerald-400">${total.toFixed(1)} km</span>
</td>
</tr>`;
});

lucide.createIcons();
return;
}

// --- GENEL GÃ–RÃœNÃœM ---
document.getElementById('standard-analysis-container').classList.remove('hidden'); document.getElementById('leave-analysis-container').classList.add('hidden');

// UZMANLIK DETAY TABLOSU
if (filterVal === 'all_specialists') {
document.getElementById('specialist-detail-container').classList.remove('hidden');
const detBody = document.getElementById('specialist-detail-body');
detBody.innerHTML = ''; const detailMap = {};

// BaÅŸlÄ±klarÄ± kalÄ±nlaÅŸtÄ±r
document.querySelectorAll('#specialist-detail-container table th').forEach(th => th.classList.add('border-2', 'border-gray-600'));

staffList.forEach(s => { dRange.forEach(dStr => { const r = allRecords[dStr]?.[s.name]; if (r && r.specialists && r.specialists.length > 0) { if (!detailMap[s.name]) detailMap[s.name] = {}; r.specialists.forEach(sp => { if (!detailMap[s.name][sp.name]) { detailMap[s.name][sp.name] = { count: 0, items: [] }; } const dObj = new Date(dStr); const timeLabel = sp.time === 'Ã–Ã–' ? 'S' : 'Ã–'; const timeColor = sp.time === 'Ã–Ã–' ? 'text-blue-600' : 'text-orange-600'; detailMap[s.name][sp.name].count++; detailMap[s.name][sp.name].items.push(`<span class="${timeColor} font-semibold">${dObj.getDate()}/${dObj.getMonth() + 1}(${timeLabel})</span>`); }); } }); });
let hasData = false;
Object.keys(detailMap).sort().forEach(sName => {
Object.keys(detailMap[sName]).sort().forEach(spName => {
hasData = true; const data = detailMap[sName][spName];
detBody.innerHTML += `<tr class="hover:bg-gray-50 border-b-2 border-gray-600"><td class="px-4 py-2 font-medium text-gray-700 border-2 border-gray-600">${sName}</td><td class="px-4 py-2 text-gray-600 border-2 border-gray-600">${spName}</td><td class="px-4 py-2 text-center font-bold text-purple-700 border-2 border-gray-600">${data.count}</td><td class="px-4 py-2 text-xs text-gray-500 leading-relaxed border-2 border-gray-600">${data.items.join(', ')}</td></tr>`;
});
});
if (!hasData) detBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400 border-2 border-gray-600">Bu tarih aralÄ±ÄŸÄ±nda uzman eÅŸleÅŸmesi bulunamadÄ±.</td></tr>';
} else { document.getElementById('specialist-detail-container').classList.add('hidden'); }

// --- VERÄ° HESAPLAMA (ANA TABLO) ---
const stats = staffList.map(s => { let t = 0; dRange.forEach(d => { const r = allRecords[d]?.[s.name]; if (r) { if (filterVal === 'all') { const specCount = r.specialists ? r.specialists.length : 0; t += r.mm + r.mk + r.am + r.ak + (r.e * 2) + specCount; } else if (filterVal.startsWith('spec_')) { const specName = filterVal.replace('spec_', ''); if (r.specialists) { t += r.specialists.filter(sp => sp.name === specName).length; } } else if (filterVal === 'all_specialists') { t += r.specialists ? r.specialists.length : 0; } } }); return { name: s.name, t }; });
let staffColHeader = "Toplam SayÄ±"; if (filterVal.startsWith('spec_')) staffColHeader += ` (${filterVal.replace('spec_', '')})`; else if (filterVal === 'all_specialists') staffColHeader = "Toplam UzmanlÄ±k";
document.getElementById('analysis-staff-col-header').innerText = staffColHeader;

const mode = calculateMode(stats.map(s => s.t));
const statBody = document.getElementById('analysis-stats-body');
statBody.innerHTML = '';

if (filterVal === 'all' || filterVal.startsWith('spec_') || filterVal === 'all_specialists') {
stats.forEach((st, idx) => {
const bgClass = (idx % 2 === 0) ? 'bg-white' : 'bg-gray-100';
// ANA Ã–ZET TABLOSU (Grid)
statBody.innerHTML += `<tr class="${bgClass} hover:bg-gray-200 border-b-2 border-gray-600"><td class="px-4 py-2 border-2 border-gray-600 font-bold text-gray-700">${st.name}</td><td class="px-4 py-2 text-center font-bold border-2 border-gray-600">${st.t}</td><td class="px-4 py-2 text-center border-2 border-gray-600">${filterVal === 'all' ? getStatusHtml(st.t, mode) : '-'}</td></tr>`;
});
} else { statBody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-gray-400 text-xs border-2 border-gray-600">Bu filtre iÃ§in personel verisi bulunmamaktadÄ±r.</td></tr>'; }

// --- GÃœNLÃœK DETAY (Ã‡ARÅAF) TABLOSU ---
const hRow = document.getElementById('analysis-table-head'), bRow = document.getElementById('analysis-table-body');
hRow.querySelectorAll('th:not(.sticky-col-1)').forEach(e => e.remove()); bRow.innerHTML = '';

// Detay Tablosu BaÅŸlÄ±k Stili
const stickyTh = hRow.querySelector('.sticky-col-1');
if (stickyTh) { stickyTh.classList.add('border-2', 'border-gray-600', 'bg-gray-200'); stickyTh.classList.remove('bg-gray-100'); }

if (filterVal === 'all' || filterVal.startsWith('spec_') || filterVal === 'all_specialists') {
dRange.forEach(dStr => {
const d = new Date(dStr);
// Detay Tablosu GÃ¼n BaÅŸlÄ±klarÄ± (Grid)
hRow.insertAdjacentHTML('beforeend', `<th class="px-2 py-1 bg-gray-200 text-center min-w-[60px] text-[10px] border-2 border-gray-600 font-bold text-gray-700">${days[d.getDay() - 1]}<br>${d.getDate()}/${d.getMonth() + 1}</th>`);
});
staffList.forEach((s, idx) => {
const bgClass = (idx % 2 === 0) ? 'bg-white' : 'bg-gray-100';
// Detay Tablosu SatÄ±rlarÄ± (Grid)
let h = `<tr class="${bgClass} hover:bg-gray-200 border-b-2 border-gray-600"><td class="px-4 py-2 sticky-col-1 ${bgClass} border-2 border-gray-600 text-xs font-bold text-gray-800 shadow-sm">${s.name}</td>`;
dRange.forEach(dStr => {
const d = new Date(dStr); const r = allRecords[dStr]?.[s.name] || { mm: 0, mk: 0, am: 0, ak: 0, e: 0, specialists: [] };
let sum = 0; if (filterVal === 'all') { const specCount = r.specialists ? r.specialists.length : 0; sum = r.mm + r.mk + r.am + r.ak + (r.e * 2) + specCount; } else if (filterVal.startsWith('spec_')) { const specName = filterVal.replace('spec_', ''); if (r.specialists) sum = r.specialists.filter(sp => sp.name === specName).length; } else if (filterVal === 'all_specialists') { sum = r.specialists ? r.specialists.length : 0; }
// Detay Tablosu HÃ¼creleri (Grid)
h += `<td class="px-1 text-center text-xs border-2 border-gray-600 ${sum ? 'text-indigo-600 font-extrabold' : 'text-gray-300'}">${sum || '-'}</td>`;
}); bRow.insertAdjacentHTML('beforeend', h + `</tr>`);
});
} else { bRow.innerHTML = '<tr><td class="p-4 text-center text-gray-400 text-xs border-2 border-gray-600">Bu filtre iÃ§in detay verisi gÃ¶sterilmemektedir.</td></tr>'; }

// --- DOKTOR PERFORMANS TABLOSU ---
const docStatsBody = document.getElementById('analysis-doctor-stats-body'), procStatsBody = document.getElementById('analysis-proc-stats-body');
docStatsBody.innerHTML = ''; procStatsBody.innerHTML = ''; const periodProcStats = {}; procList.forEach(p => periodProcStats[p] = 0);
let docHeader = "SayÄ±";
if (filterVal === 'doc_counts') docHeader = "Hasta SayÄ±sÄ±"; else if (filterVal.startsWith('proc_')) docHeader = filterVal.replace('proc_', '');
document.getElementById('analysis-doc-col-header').innerText = docHeader;
let docIdx = 0;

if (!filterVal.startsWith('spec_') && filterVal !== 'all_specialists') {
doctorList.forEach((doc) => {
let valToShow = 0;
dRange.forEach(d => {
const r = docRecords[d]?.[doc.name];
if (r) {
if (filterVal === 'all' || filterVal === 'doc_counts') valToShow += parseInt(r.pCount) || 0;
else if (filterVal.startsWith('proc_')) { const pName = filterVal.replace('proc_', ''); valToShow += parseInt(r.procs?.[pName]) || 0; }
if (filterVal === 'all' && r.procs) { Object.keys(r.procs).forEach(pk => { const v = parseInt(r.procs[pk]) || 0; if (periodProcStats[pk] !== undefined) periodProcStats[pk] += v; }); }
}
});
const bgClass = (docIdx % 2 === 0) ? 'bg-white' : 'bg-gray-100';
// DOKTOR TABLOSU (Grid)
docStatsBody.innerHTML += `<tr class="${bgClass} hover:bg-gray-200 border-b-2 border-gray-600"><td class="px-4 py-2 font-medium border-2 border-gray-600">${doc.name}</td><td class="px-4 py-2 text-center text-blue-600 font-bold border-2 border-gray-600">${valToShow}</td></tr>`; docIdx++;
});
} else { docStatsBody.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-gray-400 text-xs border-2 border-gray-600">Bu filtre iÃ§in doktor verisi bulunmamaktadÄ±r.</td></tr>'; }

// --- Ä°ÅLEM DAÄILIM TABLOSU ---
if (filterVal === 'all') {
let procIdx = 0;
Object.keys(periodProcStats).forEach((proc) => {
if (periodProcStats[proc] > 0) {
const bgClass = (procIdx % 2 === 0) ? 'bg-white' : 'bg-gray-100';
// Ä°ÅLEM TABLOSU (Grid)
procStatsBody.innerHTML += `<tr class="${bgClass} hover:bg-gray-200 border-b-2 border-gray-600"><td class="px-4 py-2 font-medium border-2 border-gray-600">${proc}</td><td class="px-4 py-2 text-center font-bold text-green-600 border-2 border-gray-600">${periodProcStats[proc]}</td></tr>`; procIdx++;
}
});
} else { procStatsBody.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-gray-400 text-xs border-2 border-gray-600">Sadece "TÃ¼mÃ¼" seÃ§eneÄŸinde genel daÄŸÄ±lÄ±m gÃ¶sterilir.</td></tr>'; }
}

function checkLock(cb) { if (isEditing) cb(); else document.getElementById('lock-toggle').click(); }
function renderStats() {
const tbody = document.getElementById('stats-body');
tbody.innerHTML = '';

// --- BAÅLIKLARI GÃœNCELLEME (Otomatik) ---
// Tablo baÅŸlÄ±ÄŸÄ± HTML'de sabit olduÄŸu iÃ§in, bÃ¼tÃ¼nlÃ¼k bozulmasÄ±n diye buradan mÃ¼dahale ediyoruz.
const table = tbody.closest('table');
if (table) {
table.querySelectorAll('thead th').forEach(th => {
th.classList.add('border-2', 'border-gray-600'); // KalÄ±n Ã§erÃ§eve ekle
th.classList.remove('border-b'); // Eski ince Ã§izgiyi kaldÄ±r
});
}

// --- HESAPLAMALAR ---
const mStr = getLocalDateString(new Date()).slice(0, 7);
const wDates = Object.values(getWeekDates(currentWeekStart));

const stats = staffList.map(staff => {
let w = 0, m = 0;
Object.keys(allRecords).forEach(d => {
const r = allRecords[d][staff.name];
if (r) {
const specCount = r.specialists ? r.specialists.length : 0;
const v = r.mm + r.mk + r.am + r.ak + (r.e * 2) + specCount;
if (wDates.includes(d)) w += v;
if (d.startsWith(mStr)) m += v;
}
});
return { name: staff.name, w, m };
});

const wMode = calculateMode(stats.map(s => s.w));
const mMode = calculateMode(stats.map(s => s.m));

const elW = document.getElementById('weekly-mode-target');
const elM = document.getElementById('monthly-mode-target');
if (elW) elW.innerText = wMode;
if (elM) elM.innerText = mMode;

// --- SATIRLARI OLUÅTUR ---
stats.forEach((st, idx) => {
const bgClass = (idx % 2 === 0) ? 'bg-white dark:bg-gray-800' : 'bg-gray-100 dark:bg-gray-700';

// BURASI DEÄÄ°ÅTÄ°: Her hÃ¼creye (td) ve satÄ±ra (tr) kalÄ±n Ã§erÃ§eve (border-2 border-gray-600) + dark mode
tbody.innerHTML += `
<tr class="${bgClass} hover:bg-gray-200 dark:hover:bg-gray-600 border-b-2 border-gray-600 dark:border-gray-500">
<td class="px-4 py-2 font-bold text-gray-700 dark:text-gray-200 text-sm border-2 border-gray-600 dark:border-gray-500">${st.name}</td>
<td class="px-4 py-2 text-center font-bold text-blue-700 dark:text-blue-300 bg-blue-50 dark:bg-blue-900/40 text-xs border-2 border-gray-600 dark:border-gray-500">${st.w}</td>
<td class="px-4 py-2 text-center border-2 border-gray-600 dark:border-gray-500">${getStatusHtml(st.w, wMode)}</td>
<td class="px-4 py-2 text-center font-bold text-purple-700 dark:text-purple-300 bg-purple-50 dark:bg-purple-900/40 text-xs border-2 border-gray-600 dark:border-gray-500">${st.m}</td>
<td class="px-4 py-2 text-center border-2 border-gray-600 dark:border-gray-500">${getStatusHtml(st.m, mMode)}</td>
</tr>`;
});
}

function renderSpecialistTab() {
// --- 1. TABLO (ÃœST KISIM): HAFTALIK GÃœNLÃœK DETAY ---

// BaÅŸlÄ±ÄŸÄ± Dinamik Olarak GÃ¼ncelle
const titleEl = document.querySelector('#tab-uzman h2');
if (titleEl) titleEl.innerText = "Uzman Birim EÅŸleÅŸme Ã‡izelgesi (HaftalÄ±k)";

const thead = document.querySelector('#specialist-table thead');
const tbody = document.getElementById('specialist-body');

if (thead && tbody) {
thead.innerHTML = '';

// Tablo BaÅŸlÄ±klarÄ±
let headerRow = `<tr class="bg-gray-100 border-b"><th class="px-4 py-3 text-xs font-semibold text-gray-600 uppercase bg-gray-50 border-r sticky-col-1 border-2 border-gray-600">Tarih</th>`;
specialistList.forEach(spec => {
headerRow += `<th class="px-4 py-3 text-xs font-bold text-gray-700 uppercase text-center border-l min-w-[120px] border-2 border-gray-600">${spec}</th>`;
});
headerRow += `</tr>`;
thead.innerHTML = headerRow;

tbody.innerHTML = '';

// SEÃ‡Ä°LÄ° HAFTANIN TARÄ°HLERÄ°NÄ° OLUÅTUR (7 GÃœN)
const dates = [];
let tempDate = new Date(currentWeekStart);
for (let i = 0; i < 7; i++) {
dates.push(getLocalDateString(tempDate));
tempDate.setDate(tempDate.getDate() + 1);
}

dates.forEach((d, index) => {
const bgClass = (index % 2 === 0) ? 'bg-white' : 'bg-gray-100';

// Tarih Formatlama (Ã–rn: 22 AralÄ±k Pazartesi)
const dateObj = new Date(d);
const dateStr = dateObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', weekday: 'long' });

// Hafta sonu kontrolÃ¼ (Renklendirme iÃ§in)
const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
const dateClass = isWeekend ? 'text-red-600 font-bold' : 'text-gray-700 font-medium';

let row = `<tr class="${bgClass} border-b-2 border-gray-600 hover:bg-indigo-50">
<td class="px-4 py-2 text-xs ${dateClass} whitespace-nowrap ${bgClass} sticky-col-1 border-r border-2 border-gray-600">${dateStr}</td>`;

specialistList.forEach(spec => {
let content = '-';
// TÃ¼m personeli tara, o gÃ¼n o uzmanlÄ±kta kim var bul
staffList.forEach(s => {
const r = allRecords[d] ? allRecords[d][s.name] : null;
if (r && r.specialists) {
r.specialists.forEach(sp => {
if (sp.name === spec) {
const timeText = sp.time === 'Ã–Ã–' ? 'SABAH' : 'Ã–ÄLEN';
const timeColor = sp.time === 'Ã–Ã–' ? 'bg-blue-50 text-blue-700 border-blue-200' : 'bg-orange-50 text-orange-700 border-orange-200';

const newContent = `<div class="mb-1 bg-white border rounded p-1 shadow-sm flex items-center justify-between gap-2">
<span class="font-bold text-gray-800 block text-[10px] truncate">${s.name}</span>
<span class="text-[9px] px-1.5 py-0.5 rounded-full font-bold border ${timeColor}">${timeText}</span>
</div>`;

if (content === '-') content = newContent; else content += newContent;
}
});
}
});
row += `<td class="px-2 py-2 text-center text-xs border-l border-2 border-gray-600 align-top">${content}</td>`;
});
row += `</tr>`;
tbody.insertAdjacentHTML('beforeend', row);
});
}

// --- 2. YENÄ° HAFTALIK Ã–ZET TABLO (ALT KISIM) ---
// (BurasÄ± zaten haftalÄ±ktÄ±, sadece 7 gÃ¼n kuralÄ±na uyduÄŸundan emin oluyoruz)
const weeklyBody = document.getElementById('weekly-spec-body');
const weeklyHead = document.querySelector('#weekly-spec-table thead');

if (weeklyBody && weeklyHead) {
weeklyBody.innerHTML = '';
weeklyHead.innerHTML = '';

const startD = typeof currentWeekStart !== 'undefined' ? currentWeekStart : new Date();
// HaftanÄ±n tarihlerini hesapla (7 gÃ¼n)
const weekDatesObj = {};
const daysArr = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'];
let tDate = new Date(startD);
for (let i = 0; i < 7; i++) {
weekDatesObj[daysArr[i]] = getLocalDateString(tDate);
tDate.setDate(tDate.getDate() + 1);
}

// BAÅLIK
let wHeader = `<tr class="bg-gray-800 text-white border-b border-gray-600"><th class="px-4 py-3 text-xs font-bold uppercase sticky-col-1 bg-gray-800 border-r border-gray-500 text-left">Personel</th>`;
if (specialistList && specialistList.length > 0) {
specialistList.forEach(sp => {
wHeader += `<th class="px-2 py-3 text-center border-r border-gray-600 text-xs min-w-[100px]">${sp}</th>`;
});
} else {
wHeader += `<th class="px-2 py-3 text-center text-xs">UzmanlÄ±k Yok</th>`;
}
wHeader += '</tr>';
weeklyHead.innerHTML = wHeader;

// GÃ–VDE
if (staffList && staffList.length > 0) {
staffList.forEach((s, idx) => {
const rowBg = (idx % 2 === 0) ? 'bg-gray-300 dark:bg-gray-700' : 'bg-gray-100 dark:bg-gray-800';
const borderColor = 'border-gray-400 dark:border-gray-600';

let rowHtml = `<tr class="${rowBg} border-b ${borderColor} hover:bg-indigo-200 dark:hover:bg-indigo-900 transition">`;
rowHtml += `<td class="px-4 py-3 font-bold text-gray-900 dark:text-gray-100 text-xs sticky-col-1 ${rowBg} border-r ${borderColor}">${s.name}</td>`;

if (specialistList && specialistList.length > 0) {
specialistList.forEach(sp => {
let count = 0;
let dateDetails = [];

Object.entries(weekDatesObj).forEach(([dayName, dateStr]) => {
if (allRecords[dateStr] && allRecords[dateStr][s.name]) {
const r = allRecords[dateStr][s.name];
if (r.specialists && Array.isArray(r.specialists)) {
const matches = r.specialists.filter(item => item.name === sp);
if (matches.length > 0) {
count += matches.length;
const dObj = new Date(dateStr);
const shortDate = `${dObj.getDate()}/${dObj.getMonth() + 1}`;
const shortDay = dayName.slice(0, 3);
dateDetails.push(`${shortDate} ${shortDay}`);
}
}
}
});

let cellContent = '';
if (count > 0) {
cellContent = `
<div class="flex flex-col items-center justify-center gap-1">
<span class="font-extrabold text-white text-xs bg-indigo-600 px-3 py-1 rounded shadow-sm">${count}</span>
<span class="text-[9px] text-gray-700 dark:text-gray-200 font-bold text-center leading-tight bg-white/50 dark:bg-gray-600/50 px-1 py-0.5 rounded border border-gray-300 dark:border-gray-500 w-full">
${dateDetails.join('<br>')}
</span>
</div>
`;
} else {
cellContent = `<span class="text-gray-400 dark:text-gray-500 font-bold opacity-50">-</span>`;
}
rowHtml += `<td class="px-2 py-3 text-center border-r ${borderColor} align-middle">${cellContent}</td>`;
});
} else {
rowHtml += `<td class="px-2 py-3 text-center text-gray-500 dark:text-gray-400 italic">-</td>`;
}
rowHtml += '</tr>';
weeklyBody.insertAdjacentHTML('beforeend', rowHtml);
});
} else {
weeklyBody.innerHTML = `<tr><td colspan="${specialistList.length + 1}" class="p-6 text-center text-gray-500 font-bold bg-gray-100">Personel listesi boÅŸ.</td></tr>`;
}
}

if (typeof lucide !== 'undefined') lucide.createIcons();
}
window.openNoteModal = (dateStr) => { const modal = document.getElementById('note-read-modal'); const noteContent = allNotes[dateStr] || "Not bulunamadÄ±."; const d = new Date(dateStr); document.getElementById('note-read-date').innerText = d.toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); document.getElementById('note-read-content').innerText = noteContent; modal.classList.remove('hidden'); modal.classList.add('flex'); };
function updateLockUI() { const b = document.getElementById('lock-toggle'), i = document.getElementById('lock-icon'), t = document.getElementById('lock-status'), menuStatus = document.getElementById('menu-lock-status'); if (isEditing) { b.className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold bg-green-100 text-green-700"; i.setAttribute('data-lucide', 'unlock'); t.innerText = "AÃ§Ä±k"; if (menuStatus) { menuStatus.innerText = "AÃ§Ä±k"; menuStatus.className = "font-bold text-green-600"; } } else { b.className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold bg-red-100 text-red-700"; i.setAttribute('data-lucide', 'lock'); t.innerText = "KapalÄ±"; if (menuStatus) { menuStatus.innerText = "KapalÄ±"; menuStatus.className = "font-bold text-red-600"; } } lucide.createIcons(); }
function showToast(m, t = 's') { const b = document.getElementById('toast'); document.getElementById('toast-msg').innerText = m; b.classList.remove('translate-y-20', 'opacity-0'); setTimeout(() => b.classList.add('translate-y-20', 'opacity-0'), 3000); }
function formatDateTR(dStr) { return new Date(dStr).toLocaleDateString('tr-TR'); }
function getWeekDates(d) {
const m = new Date(d), day = m.getDay(), diff = m.getDate() - day + (day === 0 ? -6 : 1); const dates = {}; const monday = new Date(m.setDate(diff)); for (let i = 0; i < 7; i++) {
const temp = new Date(monday);
temp.setDate(monday.getDate() + i);
dates[days[i]] = getLocalDateString(temp);
}
return dates;
}
function changeWeek(d) { const date = new Date(currentWeekStart); date.setDate(date.getDate() + d); setWeekToMonday(date); }
function setWeekToMonday(d) {
const day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1); currentWeekStart = new Date(d.setDate(diff)); const end = new Date(currentWeekStart); end.setDate(end.getDate() + 6);

document.getElementById('current-week-display').innerText = `${currentWeekStart.getDate()} ${currentWeekStart.toLocaleDateString('tr-TR', { month: 'short' })} - ${end.getDate()} ${end.toLocaleDateString('tr-TR', { month: 'long' })}`;
renderUI();
}

// --- TELEFON REHBERÄ° MODÃœLÃœ (GÃœNCELLENMÄ°Å VERSÄ°YON) ---
const LS_PHONEBOOK = 'evdeSaglikPhonebook_V1';
let phonebookList = [];
let editingContactId = null; // DÃ¼zenleme modu iÃ§in deÄŸiÅŸken

// 1. YÃ¼kleme Fonksiyonu
// Rehber verilerini yÃ¼kle (ÅÄ°FRE Ã‡Ã–ZME DESTEKLÄ°)
async function loadPhonebook() {
try {
const stored = JSON.parse(localStorage.getItem(LS_PHONEBOOK)) || [];
// Åifreli alanlarÄ± Ã§Ã¶z (name, num/phone alanlarÄ±)
phonebookList = await decryptArray(stored, ['name', 'num', 'role']);
} catch { phonebookList = []; }

// Eskiden kalma ID'si olmayan kayÄ±t varsa onlara ID verelim (Hata Ã¶nleyici)
phonebookList.forEach(p => { if (!p.id) p.id = Date.now() + Math.random(); });

renderPhonebook();
}

// 2. KiÅŸi Ekleme ve GÃ¼ncelleme
window.addContact = async () => {
const name = document.getElementById('ph-name').value.trim();
const role = document.getElementById('ph-role').value.trim();
const num = document.getElementById('ph-num').value.trim();

if (!name || !num) return showToast("Ä°sim ve numara zorunlu!", "error");

if (editingContactId) {
// --- GÃœNCELLEME Ä°ÅLEMÄ° ---
const idx = phonebookList.findIndex(p => p.id === editingContactId);
if (idx > -1) {
phonebookList[idx].name = name;
phonebookList[idx].role = role;
phonebookList[idx].num = num;
showToast("KiÅŸi gÃ¼ncellendi.");
cancelEditContact(); // Moddan Ã§Ä±k
}
} else {
// --- YENÄ° KAYIT ---
phonebookList.push({
id: Date.now(), // Benzersiz ID
name,
role,
num
});
showToast("KiÅŸi eklendi.");
addActivityLog('contact', 'Rehbere kiÅŸi eklendi', name);
// Formu temizle
document.getElementById('ph-name').value = '';
document.getElementById('ph-num').value = '';
document.getElementById('ph-role').value = '';
askForBackup();
}

// Ä°sme gÃ¶re sÄ±rala
phonebookList.sort((a, b) => a.name.localeCompare(b.name));

// Åifrele ve kaydet
const encryptedPhonebook = await Promise.all(
phonebookList.map(async (p) => await encryptObject(p, ['name', 'num', 'role']))
);
await FirebaseStorage.setItem(LS_PHONEBOOK, JSON.stringify(encryptedPhonebook));
renderPhonebook();
};

// 3. DÃ¼zenleme Modunu BaÅŸlat
window.startEditContact = (id) => {
// Admin kontrolÃ¼
if (currentUserRole !== 'admin') {
showToast('DÃ¼zenleme iÅŸlemi iÃ§in admin yetkisi gereklidir!', 'error');
return;
}

const item = phonebookList.find(p => p.id === id);
if (!item) return;

// Formu doldur
document.getElementById('ph-name').value = item.name;
document.getElementById('ph-role').value = item.role;
document.getElementById('ph-num').value = item.num;

editingContactId = id;

// ButonlarÄ± ayarla
const btnSave = document.getElementById('btn-ph-save');
const btnCancel = document.getElementById('btn-ph-cancel');

btnSave.innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4"></i> <span>GÃ¼ncelle</span>';
btnSave.classList.replace('bg-indigo-600', 'bg-orange-600');
btnSave.classList.replace('hover:bg-indigo-700', 'hover:bg-orange-700');

btnCancel.classList.remove('hidden');
document.getElementById('ph-name').focus();
};

// 4. DÃ¼zenlemeyi Ä°ptal Et
window.cancelEditContact = () => {
document.getElementById('ph-name').value = '';
document.getElementById('ph-role').value = '';
document.getElementById('ph-num').value = '';

editingContactId = null;

const btnSave = document.getElementById('btn-ph-save');
const btnCancel = document.getElementById('btn-ph-cancel');

btnSave.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> <span>Rehbere Kaydet</span>';
btnSave.classList.replace('bg-orange-600', 'bg-indigo-600');
btnSave.classList.replace('hover:bg-orange-700', 'hover:bg-indigo-700');

btnCancel.classList.add('hidden');
};

// 5. KiÅŸi Silme
window.deleteContact = async (id) => {
// Admin kontrolÃ¼
if (currentUserRole !== 'admin') {
showToast('Silme iÅŸlemi iÃ§in admin yetkisi gereklidir!', 'error');
return;
}

if (confirm("Bu kiÅŸiyi silmek istiyor musunuz?")) {
const contact = phonebookList.find(p => p.id === id);
const contactInfo = contact?.name || 'KiÅŸi';
phonebookList = phonebookList.filter(p => p.id !== id);

// Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
await FirebaseStorage.setItem(LS_PHONEBOOK, JSON.stringify(phonebookList));
renderPhonebook();
showToast("Silindi.");
addActivityLog('contact', 'Rehberden kiÅŸi silindi', contactInfo);

// EÄŸer dÃ¼zenlenen kiÅŸi silindiyse formu sÄ±fÄ±rla
if (editingContactId === id) cancelEditContact();
}
};

// 6. Listeyi Ekrana Basma
window.renderPhonebook = () => {
const grid = document.getElementById('phonebook-grid');
const searchVal = document.getElementById('ph-search') ? document.getElementById('ph-search').value.toLowerCase() : "";

if (!grid) return;
grid.innerHTML = '';

const filteredList = phonebookList.filter(p =>
p.name.toLowerCase().includes(searchVal) ||
(p.role && p.role.toLowerCase().includes(searchVal)) ||
p.num.includes(searchVal)
);

if (filteredList.length === 0) {
grid.innerHTML = '<div class="col-span-full text-center text-gray-400 p-8 italic border-2 border-dashed border-gray-200 rounded-xl">KayÄ±t bulunamadÄ±.</div>';
return;
}

filteredList.forEach((p) => {
grid.innerHTML += `
<div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition flex items-center justify-between group">
<div class="flex items-center gap-3 overflow-hidden">
<div class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center font-bold text-sm flex-shrink-0">
${p.name.charAt(0).toUpperCase()}
</div>
<div class="min-w-0">
<h4 class="font-bold text-gray-800 text-sm truncate" title="${p.name}">${p.name}</h4>
<p class="text-xs text-gray-500 truncate">${p.role || 'Personel'}</p>
<p class="text-xs font-mono text-gray-600 font-bold mt-0.5">${p.num}</p>
</div>
</div>
<div class="flex gap-2 items-center flex-shrink-0">
<button onclick="startEditContact(${p.id})" class="p-2 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded-lg transition" title="DÃ¼zenle">
<i data-lucide="edit-3" class="w-4 h-4"></i>
</button>
<a href="tel:${p.num}" class="p-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition" title="Ara">
<i data-lucide="phone" class="w-4 h-4"></i>
</a>
<button onclick="deleteContact(${p.id})" class="p-2 bg-gray-50 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition" title="Sil">
<i data-lucide="trash-2" class="w-4 h-4"></i>
</button>
</div>
</div>
`;
});
if (typeof lucide !== 'undefined') lucide.createIcons();
};

// ============================================
// AI & OTOMASYON SÄ°STEMÄ°
// ============================================

// AI Sekme GeÃ§iÅŸi
function switchAITab(tabName) {
const tabs = ['planning', 'anomaly', 'chatbot'];
tabs.forEach(t => {
const tabBtn = document.getElementById(`ai-tab-${t}`);
const content = document.getElementById(`ai-content-${t}`);
if (t === tabName) {
tabBtn.classList.add('border-indigo-600', 'text-indigo-600', 'bg-white');
tabBtn.classList.remove('border-transparent', 'text-gray-500');
content.classList.remove('hidden');
} else {
tabBtn.classList.remove('border-indigo-600', 'text-indigo-600', 'bg-white');
tabBtn.classList.add('border-transparent', 'text-gray-500');
content.classList.add('hidden');
}
});
if (typeof lucide !== 'undefined') lucide.createIcons();
}

// AkÄ±llÄ± NÃ¶bet Planlama
async function generateSmartSchedule() {
const userKey = localStorage.getItem(LS_API_KEY);
if (!userKey && !apiKey) { showToast("API AnahtarÄ± eksik. Ayarlar'dan ekleyin.", "error"); openSettingsModal(); return; }

const startDate = document.getElementById('ai-plan-start').value;
const endDate = document.getElementById('ai-plan-end').value;
const resultDiv = document.getElementById('ai-planning-result');

if (!startDate || !endDate) {
showToast("LÃ¼tfen tarih aralÄ±ÄŸÄ± seÃ§in.", "warning");
return;
}

resultDiv.innerHTML = '<div class="flex items-center justify-center gap-2 text-indigo-600"><div class="animate-spin w-5 h-5 border-2 border-indigo-600 border-t-transparent rounded-full"></div> AI nÃ¶bet planÄ± oluÅŸturuluyor...</div>';

try {
// Personel ve mevcut nÃ¶bet verilerini hazÄ±rla
const staffData = staffList.map(s => ({ name: s.name, role: s.role }));
const existingShifts = shiftList.filter(s => s.date >= startDate && s.date <= endDate);

const prompt = `Sen bir nÃ¶bet planlama uzmanÄ±sÄ±n. AÅŸaÄŸÄ±daki personel listesi iÃ§in ${startDate} ile ${endDate} tarihleri arasÄ±nda adil bir nÃ¶bet planÄ± oluÅŸtur.

Personel Listesi: ${JSON.stringify(staffData)}
Mevcut NÃ¶betler: ${JSON.stringify(existingShifts)}

Kurallar:
1. Her gÃ¼n en az 1 kiÅŸi nÃ¶betÃ§i olmalÄ±
2. NÃ¶betler adaletli daÄŸÄ±tÄ±lmalÄ±
3. MÃ¼mkÃ¼nse arka arkaya nÃ¶bet verilmemeli

YanÄ±tÄ±nÄ± ÅŸu formatta ver:
- Her satÄ±rda: Tarih | Personel AdÄ± | NÃ¶bet Tipi (GÃ¼ndÃ¼z/Gece)
- Sonunda kÄ±sa bir Ã¶zet ve Ã¶neriler yaz.`;

const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userKey || apiKey}`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
});

const data = await response.json();
if (data.error) throw new Error(data.error.message);

const aiResponse = data.candidates[0].content.parts[0].text;
// Lazy load Marked.js for markdown rendering
await LazyLoader.loadMarked();
resultDiv.innerHTML = `<div class="prose prose-sm max-w-none">${marked.parse(aiResponse)}</div>`;
} catch (error) {
resultDiv.innerHTML = `<div class="text-red-600 bg-red-50 p-3 rounded-lg">âŒ Hata: ${error.message}</div>`;
}
}

// Anomali Tespiti
async function detectAnomalies() {
const userKey = localStorage.getItem(LS_API_KEY);
if (!userKey && !apiKey) { showToast("API AnahtarÄ± eksik. Ayarlar'dan ekleyin.", "error"); openSettingsModal(); return; }

const resultDiv = document.getElementById('ai-anomaly-result');
resultDiv.innerHTML = '<div class="flex items-center justify-center gap-2 text-orange-600"><div class="animate-spin w-5 h-5 border-2 border-orange-600 border-t-transparent rounded-full"></div> Veriler taranÄ±yor...</div>';

try {
const prompt = `Sen bir veri analisti ve anomali tespit uzmanÄ±sÄ±n. AÅŸaÄŸÄ±daki saÄŸlÄ±k hizmeti verilerini analiz et ve olaÄŸandÄ±ÅŸÄ± durumlarÄ± tespit et.

VERÄ°LER:
${prepareAIContext()}

KONTROL EDÄ°LECEKLER:
1. Fazla mesai yapan personel var mÄ±?
2. Eksik veya tutarsÄ±z kayÄ±tlar var mÄ±?
3. BÃ¼tÃ§ede anormal harcamalar var mÄ±?
4. Acil Ã§antada kritik eksiklikler var mÄ±?
5. Son kullanma tarihi yaklaÅŸan Ã¼rÃ¼nler var mÄ±?
6. Rutin gÃ¶revlerde gecikme var mÄ±?

Her anomali iÃ§in:
- ğŸ”´ Kritik (Acil mÃ¼dahale gerekli)
- ğŸŸ  UyarÄ± (Dikkat edilmeli)
- ğŸŸ¡ Bilgi (GÃ¶zden geÃ§irilmeli)

ÅŸeklinde sÄ±nÄ±flandÄ±r ve Ã¶neriler sun.`;

const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userKey || apiKey}`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
});

const data = await response.json();
if (data.error) throw new Error(data.error.message);

const aiResponse = data.candidates[0].content.parts[0].text;
// Lazy load Marked.js for markdown rendering
await LazyLoader.loadMarked();
resultDiv.innerHTML = `<div class="prose prose-sm max-w-none">${marked.parse(aiResponse)}</div>`;
} catch (error) {
resultDiv.innerHTML = `<div class="text-red-600 bg-red-50 p-3 rounded-lg">âŒ Hata: ${error.message}</div>`;
}
}

// AI CHATBOT - KapsamlÄ± Veri HazÄ±rlama
function prepareAIContext() {
let reportData = {
summary: "Evde SaÄŸlÄ±k Hizmetleri YÃ¶netim Sistemi - TÃ¼m veriler",
date: new Date().toLocaleDateString('tr-TR'),

// Personel Listesi
staff: [],

// GÃ¼nlÃ¼k Ã‡alÄ±ÅŸma KayÄ±tlarÄ±
daily_records: {},

// BÃ¼tÃ§e/Kasa
budget: [],

// Acil Ã‡anta Envanteri
emergency_inventory: [],

// NÃ¶bet/Vardiya Listesi
shifts: [],

// Rutin GÃ¶revler
routines: [],

// Hasta Takip (HatÄ±rlatmalar)
patient_reminders: [],

// Rehber (Telefon Defteri)
phonebook: [],

// Doktor Talepleri
doctor_requests: [],

// Genel Notlar
general_notes: [],

// Doktorlar ve Ä°ÅŸlemleri
doctors: [],
doctor_records: {}
};

// Personel Listesi
if (typeof staffList !== 'undefined' && staffList.length > 0) {
reportData.staff = staffList.map(s => ({ name: s.name, role: s.role || 'Personel' }));
}

// GÃ¼nlÃ¼k KayÄ±tlar
if (typeof allRecords !== 'undefined') {
const dates = Object.keys(allRecords).sort().slice(-30); // Son 30 gÃ¼n
dates.forEach(d => {
let dayLog = { staff_work: [], notes: "" };
if (allNotes && allNotes[d]) dayLog.notes = allNotes[d];
if (staffList) {
staffList.forEach(s => {
const r = allRecords[d]?.[s.name];
if (r) {
const score = (r.mm || 0) + (r.mk || 0) + (r.am || 0) + (r.ak || 0) + ((r.e || 0) * 2);
if (score > 0) {
let details = [];
if (r.mm) details.push("Sabah Merkez");
if (r.mk) details.push("Sabah KÃ¶y");
if (r.am) details.push("Ã–ÄŸle Merkez");
if (r.ak) details.push("Ã–ÄŸle KÃ¶y");
if (r.e) details.push(`${r.e} Muayene`);
dayLog.staff_work.push(`${s.name}: ${details.join(', ')}`);
}
}
});
}
if (dayLog.staff_work.length > 0 || dayLog.notes) {
reportData.daily_records[d] = dayLog;
}
});
}

// BÃ¼tÃ§e KayÄ±tlarÄ±
if (typeof budgetList !== 'undefined' && budgetList.length > 0) {
reportData.budget = budgetList.slice(-50).map(item => ({
date: item.date,
type: item.type === 'income' ? 'GELÄ°R' : 'GÄ°DER',
amount: item.amount + ' TL',
desc: item.desc
}));
}

// Acil Ã‡anta
if (typeof emergencyList !== 'undefined' && emergencyList.length > 0) {
reportData.emergency_inventory = emergencyList.map(item => ({
bag: item.bagName,
item: item.name,
count: item.count,
expiry: item.date || 'Belirsiz',
alert_days: item.alertDays
}));
}

// NÃ¶betler
if (typeof shiftList !== 'undefined' && shiftList.length > 0) {
reportData.shifts = shiftList.slice(-30).map(s => ({
date: s.date,
staff: s.staff,
time: `${s.startTime || ''} - ${s.endTime || ''}`.trim(),
note: s.note || ''
}));
}

// Rutinler
if (typeof routineList !== 'undefined' && routineList.length > 0) {
reportData.routines = routineList.map(r => ({
name: r.name,
frequency: r.freq,
last_done: r.lastDone || 'HiÃ§ yapÄ±lmadÄ±'
}));
}

// Hasta Takip
if (typeof patientReminders !== 'undefined' && patientReminders.length > 0) {
reportData.patient_reminders = patientReminders.map(p => ({
patient: p.name,
date: p.date,
note: p.note,
status: p.status || 'beklemede'
}));
}

// Rehber
if (typeof phonebookList !== 'undefined' && phonebookList.length > 0) {
reportData.phonebook = phonebookList.map(p => ({
name: p.name,
phone: p.num,
role: p.role || ''
}));
}

// Doktor Talepleri
if (typeof window.doctorRequestsList !== 'undefined' && window.doctorRequestsList.length > 0) {
reportData.doctor_requests = window.doctorRequestsList.map(r => ({
patient: r.patient,
request: r.request,
date: r.date,
status: r.status || 'pending'
}));
}

// Genel Notlar
if (typeof generalNotesList !== 'undefined' && generalNotesList.length > 0) {
reportData.general_notes = generalNotesList.map(n => ({
title: n.title || 'Not',
content: n.content,
date: n.date
}));
}

// Doktorlar
if (typeof doctorList !== 'undefined' && doctorList.length > 0) {
reportData.doctors = doctorList.map(d => d.name);
}

return JSON.stringify(reportData, null, 0);
}

function appendAIMessage(role, text) { const chatArea = document.getElementById('ai-chat-area'), isBot = role === 'bot', icon = isBot ? 'bot' : 'user', bgClass = isBot ? 'bg-white border border-gray-200' : 'bg-indigo-600 text-white', align = isBot ? 'justify-start' : 'justify-end', textColor = isBot ? 'text-gray-700' : 'text-white', formattedText = (typeof marked !== 'undefined' && isBot) ? marked.parse(text) : text; chatArea.insertAdjacentHTML('beforeend', `<div class="flex ${align} mb-4"><div class="flex max-w-[85%] ${isBot ? 'flex-row' : 'flex-row-reverse'} gap-3"><div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${isBot ? 'bg-purple-100 text-purple-600' : 'bg-indigo-800 text-indigo-200'}"><i data-lucide="${icon}" class="w-5 h-5"></i></div><div class="p-3.5 rounded-2xl shadow-sm prose prose-sm max-w-none ${bgClass} ${textColor}">${formattedText}</div></div></div>`); chatArea.scrollTop = chatArea.scrollHeight; if (typeof lucide !== 'undefined') lucide.createIcons(); }

async function generateAIReport() {
const userKey = localStorage.getItem(LS_API_KEY); if (!userKey && !apiKey) { showToast("API AnahtarÄ± eksik.", "error"); openSettingsModal(); return; }
const modal = document.getElementById('ai-report-modal'), chatArea = document.getElementById('ai-chat-area'); modal.classList.remove('hidden'); modal.classList.add('flex'); chatArea.innerHTML = ''; appendAIMessage('bot', '_Verileriniz analiz ediliyor..._');
try {
const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userKey || apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: `Analist ol. Veriler: ${prepareAIContext()}. KÄ±sa Ã¶zet geÃ§.` }] }] }) });
const data = await response.json(); if (data.error) throw new Error(data.error.message); appendAIMessage('bot', data.candidates[0].content.parts[0].text);
} catch (error) { appendAIMessage('bot', `**Hata:** ${error.message}`); }
}

async function sendAIQuery() {
const inputEl = document.getElementById('ai-user-input'), question = inputEl.value.trim(), userKey = localStorage.getItem(LS_API_KEY); if (!question || !userKey) return;
inputEl.value = ''; appendAIMessage('user', question);
try {
const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userKey || apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: `Veri: ${prepareAIContext()}. Soru: "${question}". Cevapla.` }] }] }) });
const data = await response.json(); if (data.error) throw new Error(data.error.message); appendAIMessage('bot', data.candidates[0].content.parts[0].text);
} catch (error) { appendAIMessage('bot', `âš ï¸ Hata: ${error.message}`); }
}

// ============================================
// RAPORLAMA SÄ°STEMÄ°
// ============================================

// KPI Dashboard Render
function renderKPIDashboard() {
const container = document.getElementById('kpi-cards');
if (!container) return;

// KPI HesaplamalarÄ±
const today = new Date();
const thisMonth = today.toISOString().slice(0, 7);

// Toplam Hasta (Bu Ay)
let totalPatients = 0;
if (typeof allRecords !== 'undefined') {
Object.keys(allRecords).filter(d => d.startsWith(thisMonth)).forEach(d => {
Object.values(allRecords[d] || {}).forEach(r => {
totalPatients += (r.e || 0);
});
});
}

// Aktif Personel
const activeStaff = typeof staffList !== 'undefined' ? staffList.length : 0;

// AylÄ±k Gelir/Gider
let monthlyIncome = 0, monthlyExpense = 0;
if (typeof budgetList !== 'undefined') {
budgetList.filter(b => b.date && b.date.startsWith(thisMonth)).forEach(b => {
if (b.type === 'income') monthlyIncome += parseFloat(b.amount) || 0;
else monthlyExpense += parseFloat(b.amount) || 0;
});
}

// Toplam NÃ¶bet (Bu Ay)
let totalShifts = 0;
if (typeof shiftList !== 'undefined') {
totalShifts = shiftList.filter(s => s.date && s.date.startsWith(thisMonth)).length;
}

// Tamamlanan Rutinler
let completedRoutines = 0, totalRoutines = 0;
if (typeof routineList !== 'undefined') {
totalRoutines = routineList.length;
routineList.forEach(r => {
if (r.lastDone) completedRoutines++;
});
}

// Bekleyen Hasta Takip
let pendingPatients = 0;
if (typeof patientReminders !== 'undefined') {
pendingPatients = patientReminders.filter(p => p.status !== 'completed').length;
}

const kpis = [
{ label: 'Toplam Hasta', value: totalPatients, icon: 'users', color: 'indigo' },
{ label: 'Aktif Personel', value: activeStaff, icon: 'user-check', color: 'emerald' },
{ label: 'AylÄ±k Gelir', value: `â‚º${monthlyIncome.toLocaleString()}`, icon: 'trending-up', color: 'green' },
{ label: 'AylÄ±k Gider', value: `â‚º${monthlyExpense.toLocaleString()}`, icon: 'trending-down', color: 'red' },
{ label: 'NÃ¶bet SayÄ±sÄ±', value: totalShifts, icon: 'calendar', color: 'purple' },
{ label: 'Bekleyen Hasta', value: pendingPatients, icon: 'clock', color: 'orange' }
];

container.innerHTML = kpis.map(kpi => `
<div class="bg-white rounded-xl p-4 border shadow-sm text-center">
<div class="w-10 h-10 bg-${kpi.color}-100 rounded-full flex items-center justify-center mx-auto mb-2">
<i data-lucide="${kpi.icon}" class="w-5 h-5 text-${kpi.color}-600"></i>
</div>
<div class="text-2xl font-bold text-gray-800">${kpi.value}</div>
<div class="text-xs text-gray-500 font-medium">${kpi.label}</div>
</div>
`).join('');

if (typeof lucide !== 'undefined') lucide.createIcons();
}

// Rapor OluÅŸtur
function generateCustomReport(period) {
const resultDiv = document.getElementById('report-content');
const dateRangeEl = document.getElementById('report-date-range');
const reportType = document.getElementById('report-type')?.value || 'general';

let startDate, endDate;
const today = new Date();

if (period === 'weekly') {
const weekStart = new Date(today);
weekStart.setDate(today.getDate() - today.getDay() + 1);
startDate = weekStart.toISOString().slice(0, 10);
endDate = today.toISOString().slice(0, 10);
} else if (period === 'monthly') {
startDate = today.toISOString().slice(0, 7) + '-01';
endDate = today.toISOString().slice(0, 10);
} else {
startDate = document.getElementById('report-start-date')?.value;
endDate = document.getElementById('report-end-date')?.value;
}

if (!startDate || !endDate) {
showToast('LÃ¼tfen tarih aralÄ±ÄŸÄ± seÃ§in', 'warning');
return;
}

dateRangeEl.textContent = `${startDate} - ${endDate}`;

// Rapor Verileri
let reportHTML = '<div class="space-y-6">';

if (reportType === 'general' || reportType === 'staff') {
// Personel PerformansÄ±
reportHTML += '<div class="bg-blue-50 rounded-lg p-4"><h4 class="font-bold text-blue-800 mb-3">ğŸ‘¥ Personel PerformansÄ±</h4><div class="grid grid-cols-2 md:grid-cols-4 gap-3">';
if (typeof staffList !== 'undefined') {
staffList.slice(0, 8).forEach(s => {
let score = 0;
if (typeof allRecords !== 'undefined') {
Object.keys(allRecords).filter(d => d >= startDate && d <= endDate).forEach(d => {
const r = allRecords[d]?.[s.name];
if (r) score += (r.mm || 0) + (r.mk || 0) + (r.am || 0) + (r.ak || 0) + ((r.e || 0) * 2);
});
}
reportHTML += `<div class="bg-white rounded p-3 text-center"><div class="font-bold text-sm">${s.name}</div><div class="text-lg text-blue-600 font-bold">${score}</div><div class="text-xs text-gray-500">puan</div></div>`;
});
}
reportHTML += '</div></div>';
}

if (reportType === 'general' || reportType === 'budget') {
// BÃ¼tÃ§e Ã–zeti
let income = 0, expense = 0;
if (typeof budgetList !== 'undefined') {
budgetList.filter(b => b.date >= startDate && b.date <= endDate).forEach(b => {
if (b.type === 'income') income += parseFloat(b.amount) || 0;
else expense += parseFloat(b.amount) || 0;
});
}
reportHTML += `<div class="bg-green-50 rounded-lg p-4"><h4 class="font-bold text-green-800 mb-3">ğŸ’° BÃ¼tÃ§e Ã–zeti</h4><div class="grid grid-cols-3 gap-4"><div class="bg-white rounded p-3 text-center"><div class="text-sm text-gray-600">Gelir</div><div class="text-xl font-bold text-green-600">â‚º${income.toLocaleString()}</div></div><div class="bg-white rounded p-3 text-center"><div class="text-sm text-gray-600">Gider</div><div class="text-xl font-bold text-red-600">â‚º${expense.toLocaleString()}</div></div><div class="bg-white rounded p-3 text-center"><div class="text-sm text-gray-600">Net</div><div class="text-xl font-bold ${income - expense >= 0 ? 'text-green-600' : 'text-red-600'}">â‚º${(income - expense).toLocaleString()}</div></div></div></div>`;
}

if (reportType === 'general' || reportType === 'shift') {
// NÃ¶bet Analizi
let shiftCount = 0;
const shiftByPerson = {};
if (typeof shiftList !== 'undefined') {
shiftList.filter(s => s.date >= startDate && s.date <= endDate).forEach(s => {
shiftCount++;
shiftByPerson[s.staff] = (shiftByPerson[s.staff] || 0) + 1;
});
}
reportHTML += `<div class="bg-purple-50 rounded-lg p-4"><h4 class="font-bold text-purple-800 mb-3">ğŸ“… NÃ¶bet Analizi</h4><div class="text-sm">Toplam NÃ¶bet: <span class="font-bold">${shiftCount}</span></div>`;
if (Object.keys(shiftByPerson).length > 0) {
reportHTML += '<div class="mt-2 flex flex-wrap gap-2">';
Object.entries(shiftByPerson).sort((a, b) => b[1] - a[1]).forEach(([name, count]) => {
reportHTML += `<span class="bg-white px-3 py-1 rounded-full text-xs font-bold">${name}: ${count}</span>`;
});
reportHTML += '</div>';
}
reportHTML += '</div>';
}

reportHTML += '</div>';
resultDiv.innerHTML = reportHTML;
if (typeof lucide !== 'undefined') lucide.createIcons();
}

// KarÅŸÄ±laÅŸtÄ±rmalÄ± Analiz
function runComparison() {
const p1Start = document.getElementById('compare-period1-start')?.value;
const p1End = document.getElementById('compare-period1-end')?.value;
const p2Start = document.getElementById('compare-period2-start')?.value;
const p2End = document.getElementById('compare-period2-end')?.value;

if (!p1Start || !p1End || !p2Start || !p2End) {
showToast('LÃ¼tfen her iki dÃ¶nem iÃ§in de tarih seÃ§in', 'warning');
return;
}

const resultDiv = document.getElementById('report-content');
const dateRangeEl = document.getElementById('report-date-range');
dateRangeEl.textContent = `DÃ¶nem 1: ${p1Start} - ${p1End} vs DÃ¶nem 2: ${p2Start} - ${p2End}`;

// Ä°ki dÃ¶nem verilerini hesapla
function calculatePeriodData(start, end) {
let patients = 0, income = 0, expense = 0, shifts = 0;

if (typeof allRecords !== 'undefined') {
Object.keys(allRecords).filter(d => d >= start && d <= end).forEach(d => {
Object.values(allRecords[d] || {}).forEach(r => { patients += (r.e || 0); });
});
}
if (typeof budgetList !== 'undefined') {
budgetList.filter(b => b.date >= start && b.date <= end).forEach(b => {
if (b.type === 'income') income += parseFloat(b.amount) || 0;
else expense += parseFloat(b.amount) || 0;
});
}
if (typeof shiftList !== 'undefined') {
shifts = shiftList.filter(s => s.date >= start && s.date <= end).length;
}
return { patients, income, expense, shifts };
}

const period1 = calculatePeriodData(p1Start, p1End);
const period2 = calculatePeriodData(p2Start, p2End);

function getChangeIcon(p1, p2) {
if (p2 > p1) return '<span class="text-green-600">â–²</span>';
if (p2 < p1) return '<span class="text-red-600">â–¼</span>';
return '<span class="text-gray-400">â€”</span>';
}

function getChangePercent(p1, p2) {
if (p1 === 0) return p2 > 0 ? '+âˆ%' : '0%';
const change = ((p2 - p1) / p1 * 100).toFixed(1);
return (change > 0 ? '+' : '') + change + '%';
}

resultDiv.innerHTML = `
<div class="overflow-x-auto">
<table class="w-full text-sm">
<thead class="bg-gray-100">
<tr>
<th class="p-3 text-left">Metrik</th>
<th class="p-3 text-center bg-blue-50">DÃ¶nem 1</th>
<th class="p-3 text-center bg-orange-50">DÃ¶nem 2</th>
<th class="p-3 text-center">DeÄŸiÅŸim</th>
</tr>
</thead>
<tbody class="divide-y">
<tr>
<td class="p-3 font-medium">ğŸ‘¥ Hasta SayÄ±sÄ±</td>
<td class="p-3 text-center font-bold">${period1.patients}</td>
<td class="p-3 text-center font-bold">${period2.patients}</td>
<td class="p-3 text-center">${getChangeIcon(period1.patients, period2.patients)} ${getChangePercent(period1.patients, period2.patients)}</td>
</tr>
<tr>
<td class="p-3 font-medium">ğŸ’° Gelir</td>
<td class="p-3 text-center font-bold text-green-600">â‚º${period1.income.toLocaleString()}</td>
<td class="p-3 text-center font-bold text-green-600">â‚º${period2.income.toLocaleString()}</td>
<td class="p-3 text-center">${getChangeIcon(period1.income, period2.income)} ${getChangePercent(period1.income, period2.income)}</td>
</tr>
<tr>
<td class="p-3 font-medium">ğŸ’¸ Gider</td>
<td class="p-3 text-center font-bold text-red-600">â‚º${period1.expense.toLocaleString()}</td>
<td class="p-3 text-center font-bold text-red-600">â‚º${period2.expense.toLocaleString()}</td>
<td class="p-3 text-center">${getChangeIcon(period1.expense, period2.expense)} ${getChangePercent(period1.expense, period2.expense)}</td>
</tr>
<tr>
<td class="p-3 font-medium">ğŸ“… NÃ¶bet</td>
<td class="p-3 text-center font-bold">${period1.shifts}</td>
<td class="p-3 text-center font-bold">${period2.shifts}</td>
<td class="p-3 text-center">${getChangeIcon(period1.shifts, period2.shifts)} ${getChangePercent(period1.shifts, period2.shifts)}</td>
</tr>
</tbody>
</table>
</div>
`;
}

// PDF DÄ±ÅŸa Aktarma
async function exportReportPDF() {
const content = document.getElementById('report-content');
if (!content || content.innerHTML.includes('Rapor oluÅŸturmak iÃ§in')) {
showToast('Ã–nce bir rapor oluÅŸturun', 'warning');
return;
}
showToast('PDF kÃ¼tÃ¼phanesi yÃ¼kleniyor...', 'info');

// Lazy load PDFMake
await LazyLoader.loadPDFMake();

showToast('PDF hazÄ±rlanÄ±yor...', 'info');
// pdfmake ile basit PDF oluÅŸturma
const docDefinition = {
content: [
{ text: 'RAPOR', style: 'header' },
{ text: document.getElementById('report-date-range')?.textContent || '', style: 'subheader' },
{ text: content.innerText, margin: [0, 20] }
],
styles: {
header: { fontSize: 18, bold: true, margin: [0, 0, 0, 10] },
subheader: { fontSize: 12, color: 'gray', margin: [0, 0, 0, 20] }
}
};
pdfMake.createPdf(docDefinition).download('rapor.pdf');
}

// Excel DÄ±ÅŸa Aktarma
function exportReportExcel() {
showToast('Excel hazÄ±rlanÄ±yor...', 'info');
// Basit CSV export
const dateRange = document.getElementById('report-date-range')?.textContent || '';
let csvContent = 'Rapor Tarihi,' + dateRange + '\n\n';
csvContent += 'Metrik,DeÄŸer\n';

// KPI verilerini ekle
const kpiContainer = document.getElementById('kpi-cards');
if (kpiContainer) {
const cards = kpiContainer.querySelectorAll('div.bg-white');
cards.forEach(card => {
const label = card.querySelector('.text-xs')?.textContent || '';
const value = card.querySelector('.text-2xl')?.textContent || '';
csvContent += `${label},${value}\n`;
});
}

// Ä°ndir
const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
const link = document.createElement('a');
link.href = URL.createObjectURL(blob);
link.download = 'rapor.csv';
link.click();
}

// Raporlar sekmesi aÃ§Ä±ldÄ±ÄŸÄ±nda KPI'larÄ± render et
const originalShowTab = window.showTab;
window.showTab = function (tabName) {
if (originalShowTab) originalShowTab(tabName);
if (tabName === 'raporlar') {
setTimeout(renderKPIDashboard, 100);
}
};

// ============================================
// GÃ–RÃœNÃœM AYARLARI SÄ°STEMÄ°
// ============================================
const APPEARANCE_STORAGE_KEY = 'evdeSaglik_Appearance_v1';

// Modal aÃ§/kapa
function openAppearanceModal() {
const modal = document.getElementById('appearance-modal');
if (modal) {
modal.classList.remove('hidden');
modal.classList.add('flex');
loadAppearanceSettings();
if (typeof lucide !== 'undefined') lucide.createIcons();
}
}

function closeAppearanceModal() {
const modal = document.getElementById('appearance-modal');
if (modal) {
modal.classList.add('hidden');
modal.classList.remove('flex');
}
}

// Renk seÃ§ici gÃ¼ncelleme
document.addEventListener('input', (e) => {
if (e.target.id === 'theme-primary-color') {
document.getElementById('primary-color-hex').textContent = e.target.value;
updatePreview();
}
if (e.target.id === 'theme-accent-color') {
document.getElementById('accent-color-hex').textContent = e.target.value;
updatePreview();
}
if (e.target.id === 'theme-bg-color') {
document.getElementById('bg-color-hex').textContent = e.target.value;
updatePreview();
}
});

function updatePreview() {
const primary = document.getElementById('theme-primary-color')?.value || '#4f46e5';
const accent = document.getElementById('theme-accent-color')?.value || '#7c3aed';
const previewBtn = document.getElementById('preview-btn');
const previewText = document.getElementById('preview-text');
if (previewBtn) previewBtn.style.background = primary;
if (previewText) previewText.style.color = accent;
}

function updateFontSizeLabel() {
const slider = document.getElementById('font-size-slider');
const label = document.getElementById('font-size-value');
if (slider && label) label.textContent = slider.value + '%';
}

// HazÄ±r temalar
const PRESET_THEMES = {
default: { primary: '#4f46e5', accent: '#7c3aed', bg: '#f8fafc' },
ocean: { primary: '#0891b2', accent: '#06b6d4', bg: '#ecfeff' },
forest: { primary: '#059669', accent: '#10b981', bg: '#ecfdf5' },
sunset: { primary: '#ea580c', accent: '#f97316', bg: '#fff7ed' },
rose: { primary: '#db2777', accent: '#ec4899', bg: '#fdf2f8' }
};

function applyPresetTheme(themeName) {
const theme = PRESET_THEMES[themeName];
if (!theme) return;
document.getElementById('theme-primary-color').value = theme.primary;
document.getElementById('theme-accent-color').value = theme.accent;
document.getElementById('theme-bg-color').value = theme.bg;
document.getElementById('primary-color-hex').textContent = theme.primary;
document.getElementById('accent-color-hex').textContent = theme.accent;
document.getElementById('bg-color-hex').textContent = theme.bg;
updatePreview();
}

// Kompakt mod
function toggleCompactMode() {
const isCompact = document.getElementById('compact-mode-toggle')?.checked;
document.body.classList.toggle('compact-mode', isCompact);
}

// YazÄ± tipi uygula
function applyFontFamily() {
const fontFamily = document.getElementById('font-family-select')?.value;
if (fontFamily) document.documentElement.style.setProperty('--app-font', fontFamily);
}

function applyFontSize() {
const size = document.getElementById('font-size-slider')?.value || 100;
document.documentElement.style.fontSize = size + '%';
}

// AyarlarÄ± kaydet
function saveAppearanceSettings() {
const settings = {
primaryColor: document.getElementById('theme-primary-color')?.value || '#4f46e5',
accentColor: document.getElementById('theme-accent-color')?.value || '#7c3aed',
bgColor: document.getElementById('theme-bg-color')?.value || '#f8fafc',
compactMode: document.getElementById('compact-mode-toggle')?.checked || false,
fontFamily: document.getElementById('font-family-select')?.value || 'Inter, system-ui, sans-serif',
fontSize: document.getElementById('font-size-slider')?.value || 100
};
localStorage.setItem(APPEARANCE_STORAGE_KEY, JSON.stringify(settings));
applyAllAppearanceSettings(settings);
showToast('GÃ¶rÃ¼nÃ¼m ayarlarÄ± kaydedildi!', 'success');
closeAppearanceModal();
}

// AyarlarÄ± yÃ¼kle
function loadAppearanceSettings() {
try {
const saved = localStorage.getItem(APPEARANCE_STORAGE_KEY);
if (saved) {
const settings = JSON.parse(saved);
document.getElementById('theme-primary-color').value = settings.primaryColor || '#4f46e5';
document.getElementById('theme-accent-color').value = settings.accentColor || '#7c3aed';
document.getElementById('theme-bg-color').value = settings.bgColor || '#f8fafc';
document.getElementById('primary-color-hex').textContent = settings.primaryColor || '#4f46e5';
document.getElementById('accent-color-hex').textContent = settings.accentColor || '#7c3aed';
document.getElementById('bg-color-hex').textContent = settings.bgColor || '#f8fafc';
document.getElementById('compact-mode-toggle').checked = settings.compactMode || false;
document.getElementById('font-family-select').value = settings.fontFamily || 'Inter, system-ui, sans-serif';
document.getElementById('font-size-slider').value = settings.fontSize || 100;
document.getElementById('font-size-value').textContent = (settings.fontSize || 100) + '%';
updatePreview();
}
} catch (e) { console.error('Ayar yÃ¼kleme hatasÄ±:', e); }
}

// TÃ¼m ayarlarÄ± uygula
function applyAllAppearanceSettings(settings) {
document.documentElement.style.setProperty('--theme-primary', settings.primaryColor);
document.documentElement.style.setProperty('--theme-accent', settings.accentColor);
document.body.style.backgroundColor = settings.bgColor;
document.body.classList.toggle('compact-mode', settings.compactMode);
document.documentElement.style.setProperty('--app-font', settings.fontFamily);
document.documentElement.style.fontSize = settings.fontSize + '%';
}

// SÄ±fÄ±rla
function resetAppearanceSettings() {
applyPresetTheme('default');
document.getElementById('compact-mode-toggle').checked = false;
document.getElementById('font-family-select').value = 'Inter, system-ui, sans-serif';
document.getElementById('font-size-slider').value = 100;
document.getElementById('font-size-value').textContent = '100%';
updatePreview();
}

// Sayfa yÃ¼klendiÄŸinde ayarlarÄ± uygula
document.addEventListener('DOMContentLoaded', () => {
try {
const saved = localStorage.getItem(APPEARANCE_STORAGE_KEY);
if (saved) applyAllAppearanceSettings(JSON.parse(saved));
} catch (e) { }
});

// ROUTINES
function renderRoutines() {
const listContainer = document.getElementById('routine-list-container'),
progressBar = document.getElementById('routine-progress-bar'),
progressText = document.getElementById('routine-progress-text'),
badge = document.getElementById('routine-count-badge');

if (!listContainer) return;

// 1. ADIM: Ã‡akÄ±ÅŸmayÄ± Ã¶nlemek iÃ§in ebeveyn div'deki bÃ¶lme Ã§izgilerini kaldÄ±rÄ±yoruz
listContainer.classList.remove('divide-y', 'divide-gray-100');
// Listeyi biraz daha rahatlatmak iÃ§in boÅŸluk ekleyelim
listContainer.classList.add('space-y-2');

listContainer.innerHTML = '';

if (routineList.length === 0) {
// Liste boÅŸsa uyarÄ± kutusu
listContainer.innerHTML = '<div class="p-8 text-center text-gray-400 flex flex-col items-center border-2 border-gray-600 bg-gray-50 rounded"><i data-lucide="clipboard-list" class="w-12 h-12 mb-2 opacity-20"></i><p class="text-sm">HenÃ¼z rutin eklenmemiÅŸ.</p></div>';
} else {
// 2. ADIM: Her bir maddeyi oluÅŸturup HTML string olarak topluyoruz
// BÃ¶ylece dÃ¶ngÃ¼ hatasÄ± olmadan hepsi ekrana basÄ±lÄ±r.
const listHTML = routineList.map((r, idx) => {
const isChecked = r.completed ? 'checked' : '';
const textClass = r.completed ? 'text-gray-400 line-through' : 'text-gray-700 font-medium';
const bgClass = r.completed ? 'bg-gray-50' : 'bg-white';

// BURASI Ã–NEMLÄ°: border-2 ve border-gray-600 her eleman iÃ§in eklendi
return `
<div class="flex items-center justify-between p-3 hover:bg-indigo-50 transition group ${bgClass} border-2 border-gray-600">
<label class="flex items-center gap-3 cursor-pointer flex-grow select-none">
<input type="checkbox" onchange="toggleRoutine(${idx})" class="peer h-5 w-5 cursor-pointer rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${isChecked}>
<span class="text-sm ${textClass}" id="routine-text-${idx}">${r.text}</span>
</label>
<div class="flex gap-1">
<button onclick="editRoutine(${idx})" class="text-gray-300 hover:text-blue-500" title="DÃ¼zenle">
<i data-lucide="edit-3" class="w-4 h-4"></i>
</button>
<button onclick="deleteRoutine(${idx})" class="text-gray-300 hover:text-red-500" title="Sil">
<i data-lucide="trash-2" class="w-4 h-4"></i>
</button>
</div>
</div>`;
}).join('');

listContainer.innerHTML = listHTML;
}

// Ä°statistikleri gÃ¼ncelle
const total = routineList.length, completed = routineList.filter(r => r.completed).length, percent = total === 0 ? 0 : Math.round((completed / total) * 100);
if (progressBar) progressBar.style.width = `${percent}%`;
if (progressText) progressText.innerText = `%${percent}`;
if (badge) badge.innerText = `${completed}/${total} GÃ¶rev`;

lucide.createIcons();
}
window.addRoutine = async () => {
const val = document.getElementById('new-routine-text').value.trim();
if (!val) return showToast("Rutin adÄ± yazÄ±n.", "error");
routineList.push({ text: val, completed: false });
document.getElementById('new-routine-text').value = '';
await FirebaseStorage.setItem(LS_ROUTINES, JSON.stringify(routineList));
renderRoutines();
showToast("Eklendi.");
addActivityLog('routine', 'Rutin eklendi', text);
};
window.toggleRoutine = async (idx) => {
if (routineList[idx]) {
routineList[idx].completed = !routineList[idx].completed;
await FirebaseStorage.setItem(LS_ROUTINES, JSON.stringify(routineList));
renderRoutines();
}
};
window.editRoutine = async (idx) => {
const routine = routineList[idx];
if (!routine) return;

const newText = prompt("Rutin metnini dÃ¼zenleyin:", routine.text);
if (newText === null || newText.trim() === '') return;

routineList[idx].text = newText.trim();
await FirebaseStorage.setItem(LS_ROUTINES, JSON.stringify(routineList));
renderRoutines();
showToast("Rutin gÃ¼ncellendi.");
addActivityLog('routine', 'Rutin gÃ¼ncellendi', newText.trim());
};

window.deleteRoutine = async (idx) => {
if (confirm("Silinsin mi?")) {
const routine = routineList[idx];
const routineInfo = routine?.text || 'Rutin';
routineList.splice(idx, 1);
await FirebaseStorage.setItem(LS_ROUTINES, JSON.stringify(routineList));
renderRoutines();
addActivityLog('routine', 'Rutin silindi', routineInfo);
}
};
window.resetRoutines = async () => {
if (confirm("TÃ¼m tikler kaldÄ±rÄ±lsÄ±n mÄ±?")) {
routineList.forEach(r => r.completed = false);
await FirebaseStorage.setItem(LS_ROUTINES, JSON.stringify(routineList));
renderRoutines();
showToast("SÄ±fÄ±rlandÄ±.");
}
};

// BUDGET (TEKÄ°L VE GÃœNCEL)
let budgetCursorDate = new Date(); let currentBudgetStartStr = ""; let currentBudgetEndStr = "";
window.renderBudgetHeader = function () {
const y = budgetCursorDate.getFullYear(), m = budgetCursorDate.getMonth(), d = budgetCursorDate.getDate();
let startDate, endDate;
if (d < 15) { startDate = new Date(y, m - 1, 15); endDate = new Date(y, m, 14); } else { startDate = new Date(y, m, 15); endDate = new Date(y, m + 1, 14); }
currentBudgetStartStr = getLocalDateString(startDate); currentBudgetEndStr = getLocalDateString(endDate);
const options = { month: 'long', day: 'numeric' }, startTxt = startDate.toLocaleDateString('tr-TR', options).toUpperCase(), endTxt = endDate.toLocaleDateString('tr-TR', { ...options, year: 'numeric' }).toUpperCase();
const displayEl = document.getElementById('budget-period-display'); if (displayEl) displayEl.innerText = `${startTxt} - ${endTxt}`;
renderBudget();
};
window.changeBudgetMonth = function (direction) { budgetCursorDate.setMonth(budgetCursorDate.getMonth() + direction); renderBudgetHeader(); };

window.renderBudget = function () {
const listBody = document.getElementById('budget-list-body'),
elIncome = document.getElementById('budget-income'),
elExpense = document.getElementById('budget-expense'),
elBalance = document.getElementById('budget-balance');

const sDate = typeof currentBudgetStartStr !== 'undefined' ? currentBudgetStartStr : document.getElementById('budget-start-date')?.value;
const eDate = typeof currentBudgetEndStr !== 'undefined' ? currentBudgetEndStr : document.getElementById('budget-end-date')?.value;

if (!listBody) return;
listBody.innerHTML = '';

let totalInc = 0, totalExp = 0, hasData = false;
if (!budgetList) budgetList = [];

const sortedList = [...budgetList].sort((a, b) => b.date.localeCompare(a.date));

sortedList.forEach((item, idx) => {
if (item.date >= sDate && item.date <= eDate) {
hasData = true;
const isInc = item.type === 'income';
const amount = parseFloat(item.amount);
if (isInc) totalInc += amount; else totalExp += amount;

const originalIndex = budgetList.indexOf(item);

// DEÄÄ°ÅÄ°KLÄ°K BURADA: Her <td> hÃ¼cresine 'border-2 border-gray-600' eklendi.
listBody.innerHTML += `
<tr class="hover:bg-indigo-50/50 group transition border-b-2 border-gray-600">
<td class="px-4 py-3 text-gray-500 text-xs font-mono border-2 border-gray-600">
${formatDateTR(item.date)}
</td>
<td class="px-4 py-3 font-medium text-gray-700 border-2 border-gray-600">
${item.desc}
${item.note ? `<div class="text-[10px] text-gray-400 italic mt-0.5"><i data-lucide="sticky-note" class="w-3 h-3 inline mr-1"></i>${item.note}</div>` : ''}
</td>
<td class="px-4 py-3 text-right font-bold border-2 border-gray-600 ${isInc ? 'text-green-600' : 'text-red-600'}">
${isInc ? '+' : '-'}${amount.toLocaleString('tr-TR')} â‚º
</td>
<td class="px-4 py-3 text-center border-2 border-gray-600">
<div class="flex items-center justify-center gap-2">
<button onclick="startEditBudget(${originalIndex})" class="text-gray-400 hover:text-orange-600 transition p-1">
<i data-lucide="edit-3" class="w-4 h-4"></i>
</button>
<button onclick="delBudgetItem(${originalIndex})" class="text-gray-400 hover:text-red-600 transition p-1">
<i data-lucide="trash-2" class="w-4 h-4"></i>
</button>
</div>
</td>
</tr>`;
}
});

if (!hasData) {
// BoÅŸ veri uyarÄ±sÄ±na da Ã§erÃ§eve ekledik
listBody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400 text-xs flex flex-col items-center border-2 border-gray-600 bg-gray-50"><i data-lucide="filter-x" class="w-8 h-8 mb-2 opacity-20"></i>Bu dÃ¶nemde kayÄ±t yok.</td></tr>';
}

const balance = totalInc - totalExp;
if (elIncome) elIncome.innerText = `${totalInc.toLocaleString('tr-TR')} â‚º`;
if (elExpense) elExpense.innerText = `${totalExp.toLocaleString('tr-TR')} â‚º`;
if (elBalance) {
elBalance.innerText = `${balance.toLocaleString('tr-TR')} â‚º`;
elBalance.className = `text-2xl font-bold ${balance >= 0 ? 'text-gray-800' : 'text-red-600'}`;
}

lucide.createIcons();
};

let editingBudgetIndex = -1;
window.startEditBudget = function (idx) {
const item = budgetList[idx]; if (!item) return;
document.getElementById('budget-desc').value = item.desc; document.getElementById('budget-amount').value = item.amount; document.getElementById('budget-entry-date').value = item.date; document.getElementById('budget-note').value = item.note || '';
const radios = document.getElementsByName('budgetType'); radios.forEach(r => { if (r.value === item.type) r.checked = true; });
editingBudgetIndex = idx;
const btnSave = document.getElementById('btn-budget-save'); const btnCancel = document.getElementById('btn-budget-cancel');
btnSave.innerText = "GÃ¼ncelle"; btnSave.classList.replace('bg-indigo-600', 'bg-orange-600'); btnSave.classList.replace('hover:bg-indigo-700', 'hover:bg-orange-700'); btnCancel.classList.remove('hidden'); document.getElementById('budget-desc').focus();
};
window.cancelBudgetEdit = function () {
document.getElementById('budget-desc').value = ''; document.getElementById('budget-amount').value = ''; document.getElementById('budget-note').value = ''; editingBudgetIndex = -1;
const btnSave = document.getElementById('btn-budget-save'); const btnCancel = document.getElementById('btn-budget-cancel');
btnSave.innerText = "Ekle"; btnSave.classList.replace('bg-orange-600', 'bg-indigo-600'); btnSave.classList.replace('hover:bg-orange-700', 'hover:bg-indigo-700'); btnCancel.classList.add('hidden');
};
// --- GÃœNCELLENMÄ°Å BÃœTÃ‡E EKLEME VE SÄ°LME (PAROLA KORUMALI) ---

window.addBudgetItem = async function () {
// MEVCUT Ä°ÅLEMLER
const typeRadio = document.querySelector('input[name="budgetType"]:checked');
const type = typeRadio ? typeRadio.value : 'expense';
const desc = document.getElementById('budget-desc').value.trim();
const amount = document.getElementById('budget-amount').value;
const date = document.getElementById('budget-entry-date').value;
const note = document.getElementById('budget-note').value.trim();

if (!desc || !amount || !date) { showToast("LÃ¼tfen tÃ¼m alanlarÄ± doldurun.", "error"); return; }

if (editingBudgetIndex > -1) {
budgetList[editingBudgetIndex] = { type, desc, amount, date, note };
showToast("KayÄ±t gÃ¼ncellendi.");
cancelBudgetEdit();
} else {
budgetList.push({ type, desc, amount, date, note });
showToast("Ä°ÅŸlem eklendi.");
addActivityLog('budget', type === 'income' ? 'Gelir eklendi' : 'Gider eklendi', `${desc} - ${amount}â‚º`);
// Formu temizle
document.getElementById('budget-desc').value = '';
document.getElementById('budget-amount').value = '';
document.getElementById('budget-note').value = '';
}

// Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
await FirebaseStorage.setItem(LS_BUDGET, JSON.stringify(budgetList));
if (typeof renderBudgetHeader === 'function') renderBudgetHeader(); else renderBudget();
};

window.delBudgetItem = async function (idx) {
if (confirm("Bu iÅŸlemi silmek istiyor musunuz?")) {
// SÄ°LME Ä°ÅLEMÄ°
budgetList.splice(idx, 1);

// Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
await FirebaseStorage.setItem(LS_BUDGET, JSON.stringify(budgetList));
if (typeof renderBudgetHeader === 'function') renderBudgetHeader(); else renderBudget();
showToast("KayÄ±t silindi.");
}
};

window.downloadBudgetExcel = function () {
if (!budgetList || budgetList.length === 0) return showToast("Ä°ndirilecek veri yok.", "error");
const budgetData = budgetList.map(item => ({ Tarih: item.date, Tur: item.type === 'income' ? 'Gelir' : 'Gider', Kategori_Aciklama: item.desc, Not: item.note || '', Tutar: parseFloat(item.amount) }));
const wb = XLSX.utils.book_new(), ws = XLSX.utils.json_to_sheet(budgetData); ws['!cols'] = [{ wch: 15 }, { wch: 10 }, { wch: 30 }, { wch: 30 }, { wch: 15 }];
XLSX.utils.book_append_sheet(wb, ws, "Butce_Raporu"); XLSX.writeFile(wb, `Butce_Raporu_${new Date().toISOString().slice(0, 10)}.xlsx`);
};
window.downloadBudgetPDF = function () {
if (!budgetList || budgetList.length === 0) return showToast("Raporlanacak veri yok.", "error");
const sDate = typeof currentBudgetStartStr !== 'undefined' ? currentBudgetStartStr : document.getElementById('budget-start-date')?.value;
const eDate = typeof currentBudgetEndStr !== 'undefined' ? currentBudgetEndStr : document.getElementById('budget-end-date')?.value;
const filteredList = budgetList.filter(item => item.date >= sDate && item.date <= eDate).sort((a, b) => a.date.localeCompare(b.date));
if (filteredList.length === 0) return showToast("Bu tarih aralÄ±ÄŸÄ±nda veri yok.", "error");
let totalInc = 0, totalExp = 0;
const tableBody = [[{ text: 'Tarih', style: 'tableHeader', fillColor: '#3730a3' }, { text: 'AÃ§Ä±klama / Not', style: 'tableHeader', fillColor: '#3730a3' }, { text: 'TÃ¼r', style: 'tableHeader', fillColor: '#3730a3' }, { text: 'Tutar', style: 'tableHeader', fillColor: '#3730a3', alignment: 'right' }]];
filteredList.forEach((item, idx) => {
const amount = parseFloat(item.amount), isInc = item.type === 'income'; if (isInc) totalInc += amount; else totalExp += amount;
const rowColor = isInc ? '#dcfce7' : '#fee2e2', textColor = isInc ? '#166534' : '#991b1b', sign = isInc ? '+' : '-', typeText = isInc ? 'GELÄ°R' : 'GÄ°DER';
tableBody.push([{ text: formatDateTR(item.date), fillColor: rowColor, style: 'tableRow' }, { stack: [{ text: item.desc }, item.note ? { text: `(Not: ${item.note})`, fontSize: 8, italics: true, color: '#4b5563' } : ''], fillColor: rowColor, style: 'tableRow' }, { text: typeText, fillColor: rowColor, color: textColor, bold: true, style: 'tableRow', alignment: 'center' }, { text: `${sign}${amount.toLocaleString('tr-TR')} â‚º`, fillColor: rowColor, color: textColor, bold: true, style: 'tableRow', alignment: 'right' }]);
});
const balance = totalInc - totalExp, balanceColor = balance >= 0 ? '#166534' : '#991b1b';
const docDefinition = { content: [{ text: 'BÃ¼tÃ§e ve Harcama Raporu', style: 'header', color: '#3730a3' }, { text: `DÃ¶nem: ${formatDateTR(sDate)} - ${formatDateTR(eDate)}`, style: 'subheader', margin: [0, 5, 0, 20] }, { style: 'summaryTable', table: { widths: ['*', '*', '*'], body: [[{ text: 'TOPLAM GELÄ°R', style: 'summaryHeader', fillColor: '#dcfce7', color: '#166534' }, { text: 'TOPLAM GÄ°DER', style: 'summaryHeader', fillColor: '#fee2e2', color: '#991b1b' }, { text: 'NET DURUM', style: 'summaryHeader', fillColor: '#e0e7ff', color: '#3730a3' }], [{ text: `${totalInc.toLocaleString('tr-TR')} â‚º`, style: 'summaryValue', color: '#166534' }, { text: `${totalExp.toLocaleString('tr-TR')} â‚º`, style: 'summaryValue', color: '#991b1b' }, { text: `${balance.toLocaleString('tr-TR')} â‚º`, style: 'summaryValue', color: balanceColor, bold: true }]] }, layout: 'noBorders' }, { text: 'Ä°ÅŸlem DetaylarÄ±', style: 'smallHeader', margin: [0, 20, 0, 10] }, { table: { headerRows: 1, widths: ['auto', '*', 'auto', 'auto'], body: tableBody }, layout: 'lightHorizontalLines' }], styles: { header: { fontSize: 20, bold: true, alignment: 'center' }, subheader: { fontSize: 12, italics: true, alignment: 'center', color: '#6b7280' }, smallHeader: { fontSize: 14, bold: true, color: '#374151', decoration: 'underline' }, tableHeader: { bold: true, fontSize: 11, color: 'white', margin: [0, 5, 0, 5] }, tableRow: { fontSize: 10, margin: [0, 3, 0, 3] }, summaryHeader: { bold: true, fontSize: 10, alignment: 'center', margin: [0, 5, 0, 0] }, summaryValue: { fontSize: 16, bold: true, alignment: 'center', margin: [0, 0, 0, 10] } } };
pdfMake.createPdf(docDefinition).download(`Butce_Raporu_${sDate}_${eDate}.pdf`);
};

// EMERGENCY BAG
let editingEmergencyIndex = -1;
function renderBagSelector() {
const selector = document.getElementById('bag-selector'); if (!selector) return;
selector.innerHTML = '';
emergencyBags.forEach(bag => { const option = document.createElement('option'); option.value = bag; option.text = bag; if (bag === currentBag) option.selected = true; selector.appendChild(option); });
}
window.switchBag = function () { currentBag = document.getElementById('bag-selector').value; cancelEmergencyEdit(); if (document.getElementById('select-all-em')) document.getElementById('select-all-em').checked = false; renderEmergency(); };
window.addNewBag = function () {
const newName = prompt("Yeni Ã‡anta AdÄ±:"); if (newName && newName.trim() !== "") { if (emergencyBags.includes(newName)) return showToast("Bu isim zaten var.", "error"); emergencyBags.push(newName.trim()); currentBag = newName.trim(); saveAll(); renderBagSelector(); renderEmergency(); showToast("Yeni Ã§anta oluÅŸturuldu."); }
};
window.deleteCurrentBag = function () {
if (emergencyBags.length <= 1) return showToast("En az bir Ã§anta kalmak zorunda.", "error");
const itemsInBag = emergencyList.filter(i => i.bagName === currentBag).length;
if (confirm(`"${currentBag}" ve iÃ§indeki ${itemsInBag} malzeme silinecek. Emin misiniz?`)) { emergencyList = emergencyList.filter(i => i.bagName !== currentBag); emergencyBags = emergencyBags.filter(b => b !== currentBag); currentBag = emergencyBags[0]; saveAll(); renderBagSelector(); renderEmergency(); showToast("Silindi."); }
};
window.renameCurrentBag = function () {
const newName = prompt("Yeni isim:", currentBag); if (newName && newName.trim() !== "" && newName !== currentBag) { const trimmed = newName.trim(); if (emergencyBags.includes(trimmed)) return showToast("Zaten var.", "error"); const idx = emergencyBags.indexOf(currentBag); if (idx !== -1) emergencyBags[idx] = trimmed; emergencyList.forEach(item => { if (item.bagName === currentBag) item.bagName = trimmed; }); currentBag = trimmed; saveAll(); renderBagSelector(); renderEmergency(); showToast("DeÄŸiÅŸtirildi."); }
};

function renderEmergency() {
const tbody = document.getElementById('emergency-list-body'), alertBadge = document.getElementById('em-alert-count'); if (!tbody) return;
const today = new Date(); today.setHours(0, 0, 0, 0); let alertCount = 0;
const filteredItems = emergencyList.map((item, index) => ({ ...item, originalIndex: index })).filter(item => item.bagName === currentBag);
if (filteredItems.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400 text-sm">"${currentBag}" boÅŸ. Malzeme ekleyiniz.</td></tr>`; }
else {
const rows = filteredItems.map((item) => {
let dateText = '-', dateClass = 'text-gray-600', rowClass = 'hover:bg-gray-50'; const warningThreshold = parseInt(item.alertDays) || 30;
if (item.date) { const d = new Date(item.date); dateText = d.toLocaleDateString('tr-TR'); if (d < today) { dateClass = 'text-red-600 font-bold'; dateText += ' (DOLDU!)'; rowClass = 'bg-red-50 hover:bg-red-100'; alertCount++; } else { const diffDays = Math.ceil(Math.abs(d - today) / (1000 * 60 * 60 * 24)); if (diffDays <= warningThreshold) { dateClass = 'text-orange-600 font-bold'; dateText += ` (${diffDays} gÃ¼n)`; rowClass = 'bg-orange-50 hover:bg-orange-100'; alertCount++; } } }
return `<tr class="${rowClass} border-b last:border-0 transition group"><td class="px-4 py-3 text-center"><input type="checkbox" class="em-item-checkbox w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer" value="${item.originalIndex}"></td><td class="px-4 py-3 font-medium text-gray-700">${item.name}${item.note ? `<div class="text-[10px] text-gray-400 italic mt-0.5"><i data-lucide="sticky-note" class="w-3 h-3 inline mr-1"></i>${item.note}</div>` : ''}</td><td class="px-4 py-3 text-center text-xs ${dateClass}">${dateText}</td><td class="px-4 py-3 text-center font-bold text-gray-700">${item.count}<div class="text-[9px] text-gray-400 font-normal">UyarÄ±: ${warningThreshold} gÃ¼n</div></td><td class="px-4 py-3 text-right"><div class="flex justify-end items-center gap-1"><button onclick="moveEmergencyItem(${item.originalIndex}, -1)" class="text-gray-400 hover:text-blue-600 p-1 hover:bg-blue-50 rounded transition"><i data-lucide="arrow-up" class="w-4 h-4"></i></button><button onclick="moveEmergencyItem(${item.originalIndex}, 1)" class="text-gray-400 hover:text-blue-600 p-1 hover:bg-blue-50 rounded transition"><i data-lucide="arrow-down" class="w-4 h-4"></i></button><div class="w-px h-4 bg-gray-300 mx-1"></div><button onclick="startEditEmergency(${item.originalIndex})" class="text-gray-400 hover:text-orange-600 p-1 hover:bg-orange-50 rounded transition"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="deleteEmergency(${item.originalIndex})" class="text-gray-400 hover:text-red-600 p-1 hover:bg-red-50 rounded transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></td></tr>`;
});
tbody.innerHTML = rows.join('');
}
if (alertBadge) alertBadge.innerText = alertCount; lucide.createIcons({ nodes: [tbody] });
}

window.toggleAllEm = function (source) { document.querySelectorAll('.em-item-checkbox').forEach(cb => cb.checked = source.checked); };
window.openCopyModal = function () {
if (document.querySelectorAll('.em-item-checkbox:checked').length === 0) return showToast("SeÃ§im yapÄ±n.", "error");
const targetList = document.getElementById('copy-target-list'), otherBags = emergencyBags.filter(b => b !== currentBag); targetList.innerHTML = '';
if (otherBags.length === 0) targetList.innerHTML = '<p class="text-xs text-red-500 p-2">BaÅŸka Ã§anta yok.</p>'; else targetList.innerHTML = otherBags.map(bag => `<label class="flex items-center gap-2 p-2 hover:bg-white rounded border border-transparent hover:border-gray-200 cursor-pointer"><input type="checkbox" class="copy-target-checkbox w-4 h-4 text-indigo-600 rounded" value="${bag}"><span class="text-sm font-medium text-gray-700">${bag}</span></label>`).join('');
document.getElementById('copy-bag-modal').classList.remove('hidden'); document.getElementById('copy-bag-modal').classList.add('flex');
};
window.closeCopyModal = function () { document.getElementById('copy-bag-modal').classList.add('hidden'); document.getElementById('copy-bag-modal').classList.remove('flex'); };
window.performCopy = function () {
const selected = Array.from(document.querySelectorAll('.em-item-checkbox:checked')).map(cb => parseInt(cb.value));
const targets = Array.from(document.querySelectorAll('.copy-target-checkbox:checked')).map(cb => cb.value);
if (targets.length === 0) return showToast("Hedef seÃ§mediniz!", "error");
selected.forEach(idx => { const item = emergencyList[idx]; if (item) targets.forEach(tBag => { const newItem = JSON.parse(JSON.stringify(item)); newItem.bagName = tBag; emergencyList.push(newItem); }); });
saveAll(); closeCopyModal(); showToast("KopyalandÄ±."); document.querySelectorAll('.em-item-checkbox').forEach(cb => cb.checked = false); if (document.getElementById('select-all-em')) document.getElementById('select-all-em').checked = false;
};

window.moveEmergencyItem = function (idx, dir) {
const currentIndices = emergencyList.map((item, i) => ({ item, i })).filter(obj => obj.item.bagName === currentBag).map(obj => obj.i);
const localPos = currentIndices.indexOf(idx), newLocalPos = localPos + dir;
if (newLocalPos < 0 || newLocalPos >= currentIndices.length) return;
const targetIdx = currentIndices[newLocalPos];[emergencyList[idx], emergencyList[targetIdx]] = [emergencyList[targetIdx], emergencyList[idx]];
saveAll(); renderEmergency();
};

window.startEditEmergency = function (idx) {
const item = emergencyList[idx]; if (!item) return;
document.getElementById('em-name').value = item.name; document.getElementById('em-date').value = item.date; document.getElementById('em-count').value = item.count; document.getElementById('em-note').value = item.note || ''; document.getElementById('em-alert-days').value = item.alertDays || 30;
editingEmergencyIndex = idx; const btnSave = document.getElementById('btn-em-save'), btnCancel = document.getElementById('btn-em-cancel');
btnSave.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> <span>GÃ¼ncelle</span>'; btnSave.classList.replace('bg-red-600', 'bg-orange-600'); btnSave.classList.replace('hover:bg-red-700', 'hover:bg-orange-700'); btnCancel.classList.remove('hidden'); document.getElementById('em-name').focus(); lucide.createIcons();
};
window.cancelEmergencyEdit = function () {
document.getElementById('em-name').value = ''; document.getElementById('em-date').value = ''; document.getElementById('em-count').value = ''; document.getElementById('em-note').value = ''; document.getElementById('em-alert-days').value = '30';
editingEmergencyIndex = -1; const btnSave = document.getElementById('btn-em-save'), btnCancel = document.getElementById('btn-em-cancel');
btnSave.innerHTML = '<i data-lucide="plus-circle" class="w-4 h-4"></i> <span>Listeye Ekle</span>'; btnSave.classList.replace('bg-orange-600', 'bg-red-600'); btnSave.classList.replace('hover:bg-orange-700', 'hover:bg-red-700'); btnCancel.classList.add('hidden'); lucide.createIcons();
};
window.addEmergencyItem = async function () {
const name = document.getElementById('em-name').value.trim(), date = document.getElementById('em-date').value, count = document.getElementById('em-count').value, note = document.getElementById('em-note').value.trim(), alertDays = document.getElementById('em-alert-days').value;
if (!name) return showToast("Malzeme adÄ± giriniz.", "error");
const itemData = { name, date, count: count || 1, note: note || '', alertDays: alertDays || 30, bagName: currentBag };
if (editingEmergencyIndex > -1) { emergencyList[editingEmergencyIndex] = { ...itemData, bagName: emergencyList[editingEmergencyIndex].bagName }; showToast("GÃ¼ncellendi."); cancelEmergencyEdit(); }
else {
emergencyList.push(itemData);
showToast("Eklendi.");
addActivityLog('emergency', 'Acil Ã§antaya malzeme eklendi', name);

// ğŸ§° TELEGRAM BÄ°LDÄ°RÄ°MÄ°: SKT kriterleri karÅŸÄ±lanÄ±yorsa anÄ±nda bildir
if (itemData.date && typeof isTelegramNotifyEnabled === 'function' && isTelegramNotifyEnabled('emergency')) {
const expiryDate = new Date(itemData.date);
const today = new Date();
today.setHours(0, 0, 0, 0);
const diffDays = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
const alertThreshold = parseInt(itemData.alertDays) || 30;

if (diffDays <= alertThreshold) {
const sktStr = expiryDate.toLocaleDateString('tr-TR');
const message = `ğŸ§° ACÄ°L Ã‡ANTA SKT UYARISI\n\nğŸ“¦ Malzeme: ${itemData.name}\nğŸ“… SKT: ${sktStr}\nâ° Kalan: ${diffDays} gÃ¼n\nğŸ’ Ã‡anta: ${currentBag}`;
sendTelegramMessage(message, 'emergency');
}
}

document.getElementById('em-name').value = ''; document.getElementById('em-count').value = ''; document.getElementById('em-note').value = ''; document.getElementById('em-name').focus();
}

// Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
await saveAll();
renderEmergency();
};
window.deleteEmergency = async function (idx) {
if (confirm("Ã‡antadan Ã§Ä±karmak istiyor musunuz?")) {
if (idx === editingEmergencyIndex) cancelEmergencyEdit(); emergencyList.splice(idx, 1);

// Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
await saveAll();
renderEmergency();
showToast("Silindi.");
}
};
window.exportEmergencyData = function () {
if (emergencyList.length === 0) return showToast("Liste boÅŸ.", "error");
const data = emergencyList.map(i => ({ Canta: i.bagName || 'Ana Ã‡anta', Malzeme: i.name, Not: i.note || '', SKT: i.date || 'Belirtilmedi', Adet: i.count, UyarÄ±_Gun: i.alertDays || 30 }));
const wb = XLSX.utils.book_new(), ws = XLSX.utils.json_to_sheet(data); ws['!cols'] = [{ wch: 15 }, { wch: 20 }, { wch: 30 }, { wch: 15 }, { wch: 10 }, { wch: 10 }];
XLSX.utils.book_append_sheet(wb, ws, "Acil_Canta_Yedek"); XLSX.writeFile(wb, `Acil_Canta_TAM_YEDEK_${new Date().toISOString().slice(0, 10)}.xlsx`);
};
window.importEmergencyData = function (e) {
const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
reader.onload = function (e) {
const data = new Uint8Array(e.target.result), workbook = XLSX.read(data, { type: 'array' });
let sheetName = workbook.SheetNames.find(n => n.includes("Acil_Canta")); if (!sheetName) sheetName = workbook.SheetNames[0];
const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
if (jsonData && jsonData.length > 0) {
if (confirm("TAMAM -> Mevcut listeyi SÄ°L ve yÃ¼kle.\nÄ°PTAL -> Mevcuta EKLE.")) { emergencyList = []; emergencyBags = ["Ana Ã‡anta"]; }
let importCount = 0; jsonData.forEach(row => { const bag = row['Canta'] || row['Ã‡anta'] || "Ana Ã‡anta"; if (!emergencyBags.includes(bag)) emergencyBags.push(bag); emergencyList.push({ bagName: bag, name: row['Malzeme'] || row['Ä°laÃ§'] || 'Bilinmeyen', note: row['Not'] || '', date: row['SKT'] === 'Belirtilmedi' ? '' : (row['SKT'] || ''), count: row['Adet'] || row['Stok'] || 1, alertDays: row['UyarÄ±_Gun'] || 30 }); importCount++; });
saveAll(); FirebaseStorage.setItem(LS_BAGS, JSON.stringify(emergencyBags)); renderBagSelector(); if (!emergencyBags.includes(currentBag)) currentBag = emergencyBags[0]; document.getElementById('bag-selector').value = currentBag; renderEmergency(); showToast(`${importCount} kayÄ±t yÃ¼klendi.`);
} else showToast("Veri bulunamadÄ±.", "error"); e.target.value = '';
}; reader.readAsArrayBuffer(file);
};
window.downloadEmergencyPDF = function () {
const filtered = emergencyList.filter(i => i.bagName === currentBag); if (!filtered || filtered.length === 0) return showToast("Veri yok.", "error");
const now = new Date(), dateStr = now.toLocaleDateString('tr-TR'), tableBody = [[{ text: 'Malzeme / Ä°laÃ§ AdÄ±', style: 'tableHeader', fillColor: '#991b1b' }, { text: 'Son Kull. Tarihi', style: 'tableHeader', fillColor: '#991b1b', alignment: 'center' }, { text: 'Durum / Kalan GÃ¼n', style: 'tableHeader', fillColor: '#991b1b', alignment: 'center' }, { text: 'Stok', style: 'tableHeader', fillColor: '#991b1b', alignment: 'center' }]];
filtered.forEach((item) => {
const warningThreshold = parseInt(item.alertDays) || 30; let sktText = '-', statusText = 'Normal', rowColor = '#ffffff', textColor = '#374151', statusColor = '#166534';
if (item.date) { const d = new Date(item.date); sktText = d.toLocaleDateString('tr-TR'); const today = new Date(); today.setHours(0, 0, 0, 0); if (d < today) { rowColor = '#fee2e2'; textColor = '#991b1b'; statusText = 'MÄ°ADI DOLDU!'; statusColor = '#991b1b'; } else { const diffDays = Math.ceil(Math.abs(d - today) / (1000 * 60 * 60 * 24)); if (diffDays <= warningThreshold) { rowColor = '#ffedd5'; textColor = '#c2410c'; statusText = `${diffDays} GÃ¼n KaldÄ±`; statusColor = '#c2410c'; } else statusText = `${diffDays} GÃ¼n Var`; } }
tableBody.push([{ stack: [{ text: item.name, bold: true, color: textColor }, item.note ? { text: `Not: ${item.note}`, fontSize: 8, italics: true, color: '#6b7280' } : ''], fillColor: rowColor, margin: [0, 5, 0, 5] }, { text: sktText, alignment: 'center', fillColor: rowColor, color: textColor, bold: true, margin: [0, 5, 0, 0] }, { text: statusText, alignment: 'center', fillColor: rowColor, color: statusColor, bold: true, margin: [0, 5, 0, 0] }, { text: item.count, alignment: 'center', fillColor: rowColor, color: textColor, bold: true, margin: [0, 5, 0, 0] }]);
});
const docDefinition = { content: [{ stack: [{ text: currentBag.toUpperCase() + ' RAPORU', style: 'header', color: '#991b1b' }, { text: 'Acil Ã‡anta Envanter Takip', style: 'subheader', margin: [0, 2, 0, 0] }, { text: `Rapor Tarihi: ${dateStr}`, fontSize: 10, color: '#6b7280', margin: [0, 5, 0, 20], alignment: 'center' }] }, { table: { headerRows: 1, widths: ['*', 'auto', 'auto', 'auto'], body: tableBody }, layout: 'lightHorizontalLines' }], styles: { header: { fontSize: 18, bold: true, alignment: 'center' }, subheader: { fontSize: 12, italics: true, alignment: 'center', color: '#4b5563' }, tableHeader: { bold: true, fontSize: 11, color: 'white', margin: [0, 6, 0, 6] } } };
pdfMake.createPdf(docDefinition).download(`${currentBag}_Rapor_${new Date().toISOString().slice(0, 10)}.pdf`);
};
// --- GENEL NOTLAR FONKSÄ°YONLARI ---
let selectedColor = 'yellow';

window.selectNoteColor = (color) => {
selectedColor = color;
document.getElementById('selected-note-color').value = color;
// GÃ¶rsel seÃ§im efekti
document.querySelectorAll('.note-color-btn').forEach(btn => {
if (btn.dataset.color === color) {
btn.classList.add('ring-2', 'ring-gray-400');
} else {
btn.classList.remove('ring-2', 'ring-gray-400');
}
});
};

// --- GÃœNCELLENMÄ°Å NOT SÄ°STEMÄ° (LÄ°STE GÃ–RÃœNÃœMÃœ) ---

// 1. Yeni Not Ekleme (Tarih formatÄ±nÄ± gÃ¼n ismini iÃ§erecek ÅŸekilde gÃ¼ncelledik)
// Global deÄŸiÅŸken - dÃ¼zenlenen notun index'i
let editingGeneralNoteIdx = null;

window.addGeneralNote = async () => {
const title = document.getElementById('gen-note-title').value.trim();
const content = document.getElementById('gen-note-content').value.trim();

if (!title && !content) return showToast("BaÅŸlÄ±k veya iÃ§erik giriniz.", "error");

// Tarih formatÄ±: 20 AralÄ±k Cumartesi 14:30
const now = new Date();
const dateStr = now.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', weekday: 'long' }) + ' ' +
now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

if (editingGeneralNoteIdx !== null) {
// GÃœNCELLEME MODU
generalNotesList[editingGeneralNoteIdx].title = title || 'BaÅŸlÄ±ksÄ±z Not';
generalNotesList[editingGeneralNoteIdx].content = content;
generalNotesList[editingGeneralNoteIdx].color = selectedColor;
generalNotesList[editingGeneralNoteIdx].updatedAt = new Date().toISOString();
generalNotesList[editingGeneralNoteIdx].updatedBy = currentUser?.email || 'unknown';

showToast("Not gÃ¼ncellendi.");
addActivityLog('note', 'Not gÃ¼ncellendi', title);

cancelGeneralNoteEdit();
} else {
// YENÄ° KAYIT MODU
const newNote = {
id: Date.now(),
title: title || 'BaÅŸlÄ±ksÄ±z Not',
content: content,
color: selectedColor,
date: dateStr,
createdBy: currentUser?.email || 'unknown',
createdAt: new Date().toISOString()
};

generalNotesList.unshift(newNote);

showToast("Not listeye eklendi.");
addActivityLog('note', 'Not eklendi', title);

// Site iÃ§i bildirim gÃ¶nder
sendInAppNotification('sorhemnotlar', 'ğŸ“ Yeni Sor. Hem. Notu', title || 'BaÅŸlÄ±ksÄ±z Not');
}

// Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
await saveAll();
renderGeneralNotes();

// Formu temizle
document.getElementById('gen-note-title').value = '';
document.getElementById('gen-note-content').value = '';
};

// DÃ¼zenlemeyi iptal et
window.cancelGeneralNoteEdit = () => {
editingGeneralNoteIdx = null;

document.getElementById('gen-note-title').value = '';
document.getElementById('gen-note-content').value = '';

const btnSave = document.getElementById('btn-gen-note-save');
const btnCancel = document.getElementById('btn-gen-note-cancel');

btnSave.innerHTML = '<i data-lucide="plus-circle" class="w-4 h-4"></i> Notu Kaydet';
btnSave.classList.remove('bg-orange-600', 'hover:bg-orange-700');
btnSave.classList.add('bg-indigo-600', 'hover:bg-indigo-700');

btnCancel.classList.add('hidden');

if (typeof lucide !== 'undefined') lucide.createIcons();
};

// 2. NotlarÄ± Listeleme (Accordion YapÄ±sÄ±)
window.renderGeneralNotes = () => {
const grid = document.getElementById('general-notes-grid');
const badge = document.getElementById('note-count-badge');
if (!grid) return;

grid.innerHTML = '';
badge.innerText = `${generalNotesList.length} Not`;

if (generalNotesList.length === 0) {
grid.innerHTML = '<div class="flex flex-col items-center justify-center text-gray-400 py-10"><i data-lucide="list" class="w-12 h-12 mb-2 opacity-20"></i><p class="text-sm">Listeniz boÅŸ.</p></div>';
return;
}

// Renk kodlarÄ± (Liste baÅŸlÄ±ÄŸÄ± iÃ§in sol kenar rengi ve hafif arka plan)
const colorStyles = {
'yellow': 'border-l-4 border-yellow-400 bg-yellow-50 hover:bg-yellow-100',
'blue': 'border-l-4 border-blue-400 bg-blue-50 hover:bg-blue-100',
'green': 'border-l-4 border-green-400 bg-green-50 hover:bg-green-100',
'red': 'border-l-4 border-red-400 bg-red-50 hover:bg-red-100',
'purple': 'border-l-4 border-purple-400 bg-purple-50 hover:bg-purple-100'
};

generalNotesList.forEach((note, idx) => {
const styleClass = colorStyles[note.color] || colorStyles['yellow'];
const isOwner = currentUser && note.createdBy === currentUser.email;
const isAdmin = currentUserRole === 'admin';
const canEdit = isOwner || isAdmin;
const createdByShort = note.createdBy ? note.createdBy.split('@')[0] : '?';

grid.innerHTML += `
<div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm transition-all duration-300">
<div onclick="toggleNote(${idx})" class="cursor-pointer p-3 flex justify-between items-center ${styleClass} select-none">
<div class="flex flex-col">
<span class="font-bold text-gray-800 text-sm flex items-center gap-2">
<i id="chevron-${idx}" data-lucide="chevron-right" class="w-4 h-4 text-gray-400 transition-transform duration-300"></i>
${note.title}
</span>
<span class="text-[10px] text-gray-500 pl-6 pt-0.5">(${note.date})</span>
${note.createdBy ? `<span class="text-[9px] text-gray-400 pl-6 pt-0.5">ğŸ‘¤ ${createdByShort}</span>` : ''}
</div>

<div class="flex gap-1">
${canEdit ? `
<button onclick="editGeneralNote(event, ${idx})" class="text-gray-400 hover:text-blue-600 p-1.5 rounded-full hover:bg-white transition" title="DÃ¼zenle">
<i data-lucide="edit-3" class="w-4 h-4"></i>
</button>
<button onclick="deleteGeneralNoteWithStop(event, ${idx})" class="text-gray-400 hover:text-red-600 p-1.5 rounded-full hover:bg-white transition" title="Sil">
<i data-lucide="trash-2" class="w-4 h-4"></i>
</button>
` : ''}
</div>
</div>

<div id="note-content-${idx}" class="hidden bg-white border-t border-gray-100 p-4">
<p class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">${note.content}</p>
</div>
</div>
`;
});
lucide.createIcons();
};

// 3. AÃ§/Kapa Fonksiyonu (Accordion MantÄ±ÄŸÄ±)
window.toggleNote = (idx) => {
const contentDiv = document.getElementById(`note-content-${idx}`);
const chevron = document.getElementById(`chevron-${idx}`);

if (contentDiv.classList.contains('hidden')) {
contentDiv.classList.remove('hidden');
chevron.classList.add('rotate-90'); // Oku aÅŸaÄŸÄ± Ã§evir
} else {
contentDiv.classList.add('hidden');
chevron.classList.remove('rotate-90'); // Oku saÄŸa Ã§evir
}
};

// --- NOT SÄ°LME ---
window.deleteGeneralNoteWithStop = async (e, idx) => {
e.stopPropagation(); // TÄ±klayÄ±nca notun detayÄ±nÄ± aÃ§masÄ±nÄ± engeller

const note = generalNotesList[idx];
if (!note) return;

// Sadece notu ekleyen kullanÄ±cÄ± veya admin silebilir
const isOwner = currentUser && note.createdBy === currentUser.email;
const isAdmin = currentUserRole === 'admin';

if (!isOwner && !isAdmin) {
showToast("Bu notu sadece ekleyen kullanÄ±cÄ± veya admin silebilir!", "error");
return;
}

if (confirm("Bu not silinsin mi?")) {
// SÄ°LME Ä°ÅLEMÄ°
generalNotesList.splice(idx, 1);
// Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
await saveAll();
renderGeneralNotes();
showToast("Not baÅŸarÄ±yla silindi.");
}
};

// --- NOT DÃœZENLEME ---
window.editGeneralNote = async (e, idx) => {
e.stopPropagation();
const note = generalNotesList[idx];
if (!note) return;

// Sadece notu ekleyen kullanÄ±cÄ± veya admin dÃ¼zenleyebilir
const isOwner = currentUser && note.createdBy === currentUser.email;
const isAdmin = currentUserRole === 'admin';

if (!isOwner && !isAdmin) {
showToast("Bu notu sadece ekleyen kullanÄ±cÄ± veya admin dÃ¼zenleyebilir!", "error");
return;
}

// DÃ¼zenleme moduna geÃ§
editingGeneralNoteIdx = idx;

// Formu doldur
document.getElementById('gen-note-title').value = note.title || '';
document.getElementById('gen-note-content').value = note.content || '';

// Renk seÃ§
if (note.color) {
selectNoteColor(note.color);
}

// ButonlarÄ± gÃ¼ncelle
const btnSave = document.getElementById('btn-gen-note-save');
const btnCancel = document.getElementById('btn-gen-note-cancel');

btnSave.innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4"></i> GÃ¼ncelle';
btnSave.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
btnSave.classList.add('bg-orange-600', 'hover:bg-orange-700');

btnCancel.classList.remove('hidden');

// Focus yap
document.getElementById('gen-note-title').focus();

if (typeof lucide !== 'undefined') lucide.createIcons();
};

// --- DR NOTLARI SÄ°STEMÄ° ---

// Renk seÃ§imi
window.selectDrNoteColor = (color) => {
selectedDrColor = color;
document.querySelectorAll('.dr-note-color-btn').forEach(btn => {
btn.classList.remove('ring-gray-600');
btn.classList.add('ring-transparent');
});
const selectedBtn = document.querySelector(`.dr-note-color-btn[data-color="${color}"]`);
if (selectedBtn) {
selectedBtn.classList.remove('ring-transparent');
selectedBtn.classList.add('ring-gray-600');
}
document.getElementById('selected-dr-note-color').value = color;
};

// Dr Not ekleme
window.addDrNote = async () => {
const title = document.getElementById('dr-note-title').value.trim();
const content = document.getElementById('dr-note-content').value.trim();

if (!title && !content) return showToast("BaÅŸlÄ±k veya iÃ§erik giriniz.", "error");

const now = new Date();
const dateStr = now.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', weekday: 'long' }) + ' ' +
now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

const newNote = {
id: Date.now(),
title: title || 'BaÅŸlÄ±ksÄ±z Not',
content: content,
color: selectedDrColor,
date: dateStr,
createdBy: currentUser?.email || 'unknown',
createdAt: new Date().toISOString()
};

drNotesList.unshift(newNote);

await saveDrNotes();
renderDrNotes();

document.getElementById('dr-note-title').value = '';
document.getElementById('dr-note-content').value = '';
showToast("Dr notu listeye eklendi.");
addActivityLog('dr_note', 'Dr notu eklendi', title);
sendInAppNotification('drnotlar', 'ğŸ©º Yeni Dr Notu Eklendi', title || 'BaÅŸlÄ±ksÄ±z Not');
};

// Dr NotlarÄ±nÄ± Listeleme
window.renderDrNotes = () => {
const grid = document.getElementById('dr-notes-grid');
const badge = document.getElementById('dr-note-count-badge');
if (!grid) return;

grid.innerHTML = '';
if (badge) badge.innerText = `${drNotesList.length} Not`;

if (drNotesList.length === 0) {
grid.innerHTML = '<div class="flex flex-col items-center justify-center text-gray-400 py-10"><i data-lucide="list" class="w-12 h-12 mb-2 opacity-20"></i><p class="text-sm">Listeniz boÅŸ.</p></div>';
lucide.createIcons();
return;
}

const colorStyles = {
'yellow': 'border-l-4 border-yellow-400 bg-yellow-50 hover:bg-yellow-100',
'blue': 'border-l-4 border-blue-400 bg-blue-50 hover:bg-blue-100',
'green': 'border-l-4 border-green-400 bg-green-50 hover:bg-green-100',
'red': 'border-l-4 border-red-400 bg-red-50 hover:bg-red-100',
'purple': 'border-l-4 border-purple-400 bg-purple-50 hover:bg-purple-100'
};

drNotesList.forEach((note, idx) => {
const styleClass = colorStyles[note.color] || colorStyles['blue'];
const isOwner = currentUser && note.createdBy === currentUser.email;
const isAdmin = currentUserRole === 'admin';
const canEdit = isOwner || isAdmin;
const createdByShort = note.createdBy ? note.createdBy.split('@')[0] : '?';

grid.innerHTML += `
<div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm transition-all duration-300">
<div onclick="toggleDrNote(${idx})" class="cursor-pointer p-3 flex justify-between items-center ${styleClass} select-none">
<div class="flex flex-col">
<span class="font-bold text-gray-800 text-sm flex items-center gap-2">
<i id="dr-chevron-${idx}" data-lucide="chevron-right" class="w-4 h-4 text-gray-400 transition-transform duration-300"></i>
${note.title}
</span>
<span class="text-[10px] text-gray-500 pl-6 pt-0.5">(${note.date})</span>
<span class="text-[9px] text-gray-400 pl-6 pt-0.5">ğŸ‘¤ ${createdByShort}</span>
</div>
<div class="flex gap-1">
${canEdit ? `
<button onclick="editDrNote(event, ${idx})" class="text-gray-400 hover:text-blue-600 p-1.5 rounded-full hover:bg-white transition" title="DÃ¼zenle">
<i data-lucide="edit-3" class="w-4 h-4"></i>
</button>
<button onclick="deleteDrNoteWithStop(event, ${idx})" class="text-gray-400 hover:text-red-600 p-1.5 rounded-full hover:bg-white transition" title="Sil">
<i data-lucide="trash-2" class="w-4 h-4"></i>
</button>
` : ''}
</div>
</div>
<div id="dr-note-content-${idx}" class="hidden bg-white border-t border-gray-100 p-4">
<p class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">${note.content}</p>
</div>
</div>
`;
});
lucide.createIcons();
};

// AÃ§/Kapa Fonksiyonu
window.toggleDrNote = (idx) => {
const contentDiv = document.getElementById(`dr-note-content-${idx}`);
const chevron = document.getElementById(`dr-chevron-${idx}`);
if (contentDiv.classList.contains('hidden')) {
contentDiv.classList.remove('hidden');
chevron.classList.add('rotate-90');
} else {
contentDiv.classList.add('hidden');
chevron.classList.remove('rotate-90');
}
};

// Dr Not Silme
window.deleteDrNoteWithStop = async (e, idx) => {
e.stopPropagation();
const note = drNotesList[idx];
if (!note) return;

// Sadece notu ekleyen kullanÄ±cÄ± veya admin silebilir
const isOwner = currentUser && note.createdBy === currentUser.email;
const isAdmin = currentUserRole === 'admin';

if (!isOwner && !isAdmin) {
showToast("Bu notu sadece ekleyen kullanÄ±cÄ± veya admin silebilir!", "error");
return;
}

if (confirm("Bu not silinsin mi?")) {
drNotesList.splice(idx, 1);
await saveDrNotes();
renderDrNotes();
showToast("Dr notu baÅŸarÄ±yla silindi.");
}
};

// Dr Not DÃ¼zenleme
window.editDrNote = async (e, idx) => {
e.stopPropagation();
const note = drNotesList[idx];
if (!note) return;

// Sadece notu ekleyen kullanÄ±cÄ± veya admin dÃ¼zenleyebilir
const isOwner = currentUser && note.createdBy === currentUser.email;
const isAdmin = currentUserRole === 'admin';

if (!isOwner && !isAdmin) {
showToast("Bu notu sadece ekleyen kullanÄ±cÄ± veya admin dÃ¼zenleyebilir!", "error");
return;
}

const newTitle = prompt("Yeni BaÅŸlÄ±k:", note.title);
if (newTitle === null) return; // Ä°ptal edildi

const newContent = prompt("Yeni Ä°Ã§erik:", note.content);
if (newContent === null) return; // Ä°ptal edildi

note.title = newTitle || note.title;
note.content = newContent || note.content;
note.updatedAt = new Date().toISOString();
note.updatedBy = currentUser?.email || 'unknown';

await saveDrNotes();
renderDrNotes();
showToast("Dr notu gÃ¼ncellendi!");
};

// Firebase'e kaydetme
async function saveDrNotes() {
const firebasePath = 'evde_saglik_ortak_veri/dr_notes';
if (typeof firebase !== 'undefined' && firebase.database) {
try {
await firebase.database().ref(firebasePath).set(drNotesList);
} catch (err) {
console.error('âŒ Dr notlarÄ± kayÄ±t hatasÄ±:', err);
}
}
// AyrÄ±ca localStorage'a da kaydet
try {
localStorage.setItem(LS_DR_NOTES_LIST, JSON.stringify(drNotesList));
} catch (e) { }
}

// Firebase'den yÃ¼kleme
async function loadDrNotes() {
const firebasePath = 'evde_saglik_ortak_veri/dr_notes';
try {
if (typeof firebase !== 'undefined' && firebase.database) {
const snapshot = await firebase.database().ref(firebasePath).once('value');
const value = snapshot.val();
if (value) {
drNotesList = Array.isArray(value) ? value : Object.values(value);
} else {
// localStorage'dan dene
const localData = localStorage.getItem(LS_DR_NOTES_LIST);
if (localData) drNotesList = JSON.parse(localData) || [];
}
renderDrNotes();
}
} catch (e) {
console.error('âŒ Dr notlarÄ± yÃ¼klenemedi:', e);
}
}

// Dr NotlarÄ± canlÄ± senkronizasyon
function startDrNotesRealtimeListener() {
const firebasePath = 'evde_saglik_ortak_veri/dr_notes';
const checkAndStart = () => {
if (typeof firebase === 'undefined' || !firebase.database) {
setTimeout(checkAndStart, 1000);
return;
}
firebase.database().ref(firebasePath).on('value', (snapshot) => {
const value = snapshot.val();
drNotesList = value ? (Array.isArray(value) ? value : Object.values(value)) : [];
renderDrNotes();
});
};
checkAndStart();
}

// Sayfa yÃ¼klendiÄŸinde Ã§alÄ±ÅŸtÄ±r
document.addEventListener('DOMContentLoaded', function () {
setTimeout(() => {
loadDrNotes();
startDrNotesRealtimeListener();
}, 2000);
});

// --- OTO-YEDEKLEME SÄ°STEMÄ° ---

// 1. Yedekleme Sorusu Soran Fonksiyon
window.askForBackup = () => {
// Ä°ÅŸlemlerin ekrana yansÄ±masÄ± iÃ§in Ã§ok kÄ±sa bekleyip soruyoruz
setTimeout(() => {
if (confirm("âœ… Veri kaydedildi.\n\nGÃ¼venlik iÃ§in YEDEK DOSYASI (Excel) ÅŸimdi indirilsin mi?")) {
exportData('xlsx');
}
}, 400);
};

// 2. saveAll Fonksiyonunu GÃ¼ncelliyoruz (TÃ¼m sistemi kapsasÄ±n diye)
// NOT: Bu duplicate fonksiyon kaldÄ±rÄ±ldÄ±, yukarÄ±daki async saveAll() kullanÄ±lacak

// 3. BÃ¼tÃ§e Ekleme Fonksiyonunu GÃ¼ncelliyoruz (ParolalÄ± + Yedek Soru)
// NOT: Bu duplicate fonksiyon kaldÄ±rÄ±ldÄ±, yukarÄ±daki async addBudgetItem() kullanÄ±lacak

// 4. BÃ¼tÃ§e Silme Fonksiyonunu GÃ¼ncelliyoruz (ParolalÄ± + Yedek Soru)
// NOT: Bu duplicate fonksiyon kaldÄ±rÄ±ldÄ±, yukarÄ±daki async delBudgetItem() kullanÄ±lacak
// --- SEKME KÄ°LÄ°TLEME FONKSÄ°YONU ---
window.lockSpecialTab = (tabId) => {
// Kilidi kapat
unlockedSpecialTabs[tabId] = false;

// Sekme kilit sistemine de ekle (eÄŸer henÃ¼z eklenmemiÅŸse)
if (typeof window.lockedTabsConfig !== 'undefined' && window.currentUser) {
const userKey = window.currentUser.email.replace(/\./g, '_').replace(/@/g, '_at_');
if (!window.lockedTabsConfig[userKey]) {
window.lockedTabsConfig[userKey] = {};
}
if (!window.lockedTabsConfig[userKey][tabId]) {
window.lockedTabsConfig[userKey][tabId] = true;
}
}

// KullanÄ±cÄ±yÄ± bilgilendir
showToast("Sekme kilitlendi. Ana ekrana dÃ¶nÃ¼lÃ¼yor.");

// GÃ¼venlik iÃ§in hemen hasta takip (ana) sekmesine at
switchTab('hastatakip');
};
// --- NÃ–BET (SHIFT) MODÃœLÃœ FONKSÄ°YONLARI ---

window.renderShiftHeader = function () {
const d = shiftCursorDate;
// Ay ismini yazdÄ±r (Ã–rn: ARALIK 2025)
const monthName = monthsTR[d.getMonth()];
const year = d.getFullYear();

const displayEl = document.getElementById('shift-period-display');
if (displayEl) displayEl.innerText = `${monthName} ${year}`;

// Input tarihini seÃ§ili aya ayarla (kolaylÄ±k olsun diye)
const dateInput = document.getElementById('shift-date');
if (dateInput && !dateInput.value) {
// BugÃ¼nÃ¼n tarihini formatla, ama cursor'daki ay seÃ§ili olsun
const now = new Date();
if (now.getMonth() === d.getMonth() && now.getFullYear() === d.getFullYear()) {
dateInput.value = getLocalDateString(now);
} else {
// O ayÄ±n 1'ini ayarla
const firstDay = new Date(d.getFullYear(), d.getMonth(), 1);
// Timezone farkÄ±nÄ± dÃ¼zeltmek iÃ§in basit yÃ¶ntem
const offset = firstDay.getTimezoneOffset();
const adjDate = new Date(firstDay.getTime() - (offset * 60 * 1000));
dateInput.value = adjDate.toISOString().split('T')[0];
}
}

renderShiftTable();
};

window.changeShiftMonth = function (direction) {
shiftCursorDate.setMonth(shiftCursorDate.getMonth() + direction);
renderShiftHeader();
};

window.renderShiftTable = function () {
const tbody = document.getElementById('shift-list-body');
const badge = document.getElementById('shift-count-badge');
if (!tbody) return;
tbody.innerHTML = '';

// SeÃ§ili ay ve yÄ±la gÃ¶re filtrele
const selectedMonth = shiftCursorDate.getMonth();
const selectedYear = shiftCursorDate.getFullYear();

const filteredShifts = shiftList.filter(s => {
const d = new Date(s.date);
return d.getMonth() === selectedMonth && d.getFullYear() === selectedYear;
});

// Tarihe gÃ¶re sÄ±rala
filteredShifts.sort((a, b) => a.date.localeCompare(b.date));

if (filteredShifts.length === 0) {
tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400 text-xs flex flex-col items-center"><i data-lucide="calendar-off" class="w-8 h-8 mb-2 opacity-20"></i>Bu ay nÃ¶bet kaydÄ± yok.</td></tr>';
if (badge) badge.innerText = "0 KayÄ±t";
// AylÄ±k Ã§izelgeyi de render et
renderWorkSchedule();
return;
}

filteredShifts.forEach((s) => {
// Orjinal listedeki indexini bul (silme iÅŸlemi iÃ§in)
const originalIndex = shiftList.indexOf(s);

// Tarih formatÄ± (GÃ¼n adÄ± dahil)
const dObj = new Date(s.date);
const dateStr = dObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', weekday: 'short' });

// Renkler (Hafta sonu kÄ±rmÄ±zÄ±msÄ± olsun mesela)
const isWeekend = (dObj.getDay() === 0 || dObj.getDay() === 6);
const dateClass = isWeekend ? 'text-red-600 font-bold' : 'text-gray-600 font-medium';

// DeÄŸiÅŸim bilgisi varsa gÃ¶ster
const swapInfo = s.swappedFrom ? `
<div class="flex items-center gap-1 mt-1 text-[10px] text-purple-600 bg-purple-50 px-1.5 py-0.5 rounded border border-purple-200">
<i data-lucide="arrow-left-right" class="w-3 h-3"></i>
<span>${s.swappedFrom} ile deÄŸiÅŸti</span>
</div>
` : '';

tbody.innerHTML += `
<tr class="hover:bg-indigo-50/50 group transition border-b-2 border-gray-600">
<td class="px-4 py-3 text-xs ${dateClass} border-2 border-gray-600 border-r-2">${dObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', weekday: 'short' })}</td>

<td class="px-4 py-3 font-bold text-gray-700 border-2 border-gray-600 border-r-2">
<div class="flex items-center gap-2">
${s.staff}
${s.swappedFrom ? '<i data-lucide="arrow-left-right" class="w-3.5 h-3.5 text-purple-500" title="NÃ¶bet deÄŸiÅŸimi yapÄ±ldÄ±"></i>' : ''}
</div>
${s.note ? `<div class="text-[10px] text-gray-400 font-normal italic border-t border-gray-300 mt-1 pt-0.5">${s.note}</div>` : ''}
${swapInfo}
</td>

<td class="px-4 py-3 text-center border-2 border-gray-600 border-r-2">
<span class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-[10px] font-bold border border-indigo-200 shadow-sm">${s.type}</span>
</td>

<td class="px-4 py-3 text-right border-2 border-gray-600">
<div class="flex items-center justify-end gap-1">
<button onclick="openShiftSwapModal(${originalIndex})"
class="text-gray-400 hover:text-purple-600 transition p-1.5 hover:bg-purple-50 rounded border border-transparent hover:border-purple-200"
title="NÃ¶bet DeÄŸiÅŸtir">
<i data-lucide="pencil" class="w-4 h-4"></i>
</button>
<button onclick="deleteShift(${originalIndex})"
class="text-gray-400 hover:text-red-600 transition p-1.5 hover:bg-red-50 rounded border border-transparent hover:border-red-200"
title="Sil">
<i data-lucide="trash-2" class="w-4 h-4"></i>
</button>
</div>
</td>
</tr>
`;
});

if (badge) badge.innerText = `${filteredShifts.length} KayÄ±t`;

// AylÄ±k Ã§izelgeyi de render et
renderWorkSchedule();

lucide.createIcons();
};

// NÃ¶bet DeÄŸiÅŸim Modal FonksiyonlarÄ±
window.openShiftSwapModal = function (shiftIndex) {
const shift = shiftList[shiftIndex];
if (!shift) return;

const modal = document.getElementById('shift-swap-modal');
if (!modal) return;

// Index'i kaydet
document.getElementById('shift-swap-index').value = shiftIndex;

// Mevcut nÃ¶bet bilgisini gÃ¶ster
const dObj = new Date(shift.date);
const dateStr = dObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric', weekday: 'long' });
document.getElementById('shift-swap-current-info').innerHTML = `
<span class="text-indigo-600">${shift.staff}</span> - ${dateStr}
<span class="ml-2 px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded text-xs">${shift.type}</span>
`;

// Personel listesini doldur (mevcut personel hariÃ§)
const select = document.getElementById('shift-swap-new-staff');
select.innerHTML = '<option value="">-- Personel SeÃ§in --</option>';
staffList.forEach(s => {
if (s.name !== shift.staff) {
select.innerHTML += `<option value="${s.name}">${s.name}</option>`;
}
});

// Nedeni temizle
document.getElementById('shift-swap-reason').value = '';

// ModalÄ± gÃ¶ster
modal.classList.remove('hidden');
modal.classList.add('flex');

if (typeof lucide !== 'undefined') {
lucide.createIcons();
}
};

window.closeShiftSwapModal = function () {
const modal = document.getElementById('shift-swap-modal');
if (modal) {
modal.classList.add('hidden');
modal.classList.remove('flex');
}
};

window.confirmShiftSwap = async function () {
const shiftIndex = parseInt(document.getElementById('shift-swap-index').value);
const newStaff = document.getElementById('shift-swap-new-staff').value;
const reason = document.getElementById('shift-swap-reason').value.trim();

if (!newStaff) {
showToast('LÃ¼tfen deÄŸiÅŸim yapÄ±lacak personeli seÃ§in.', 'error');
return;
}

const shift = shiftList[shiftIndex];
if (!shift) {
showToast('NÃ¶bet kaydÄ± bulunamadÄ±.', 'error');
return;
}

const oldStaff = shift.staff;

// DeÄŸiÅŸimi yap
shift.swappedFrom = oldStaff;
shift.staff = newStaff;
shift.swapDate = new Date().toISOString();
shift.swapReason = reason || null;

// Not'a da ekle
const swapNote = `(${oldStaff} ile deÄŸiÅŸti${reason ? ': ' + reason : ''})`;
shift.note = shift.note ? `${shift.note} ${swapNote}` : swapNote;

// Kaydet
await saveAll();
renderShiftTable();
closeShiftSwapModal();
showToast(`NÃ¶bet ${oldStaff} â†’ ${newStaff} olarak deÄŸiÅŸtirildi.`, 'success');
addActivityLog('shift', 'NÃ¶bet deÄŸiÅŸimi', `${oldStaff} â†’ ${newStaff} (${shift.date})`);

// Telegram bildirimi
if (typeof isTelegramNotifyEnabled === 'function' && isTelegramNotifyEnabled('shift')) {
const dateStr = new Date(shift.date).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', weekday: 'long' });
const message = `ğŸ”„ NÃ–BET DEÄÄ°ÅÄ°MÄ°\n\nğŸ“… Tarih: ${dateStr}\nğŸ‘¤ Eski: ${oldStaff}\nğŸ‘¤ Yeni: ${newStaff}${reason ? `\nğŸ“ Neden: ${reason}` : ''}`;
sendTelegramMessage(message, 'shift');
}
};

// AylÄ±k Ã‡alÄ±ÅŸma Ã‡izelgesi Render Fonksiyonu
window.renderWorkSchedule = function () {
const tbody = document.getElementById('work-schedule-body');
if (!tbody) return;
tbody.innerHTML = '';

const selectedMonth = shiftCursorDate.getMonth();
const selectedYear = shiftCursorDate.getFullYear();
const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();

// Ekran geniÅŸliÄŸini kontrol et
const isMobile = window.innerWidth < 768;

for (let day = 1; day <= daysInMonth; day++) {
const dateObj = new Date(selectedYear, selectedMonth, day);
const dateStr = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
const dayName = dateObj.toLocaleDateString('tr-TR', { weekday: 'short' });
const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
const holiday = getHolidayInfo ? getHolidayInfo(dateStr) : null;

// O gÃ¼n iÃ§in nÃ¶betÃ§ileri bul
const dayShifts = shiftList.filter(s => s.date === dateStr);
const shiftStaff = dayShifts.map(s => s.staff);

// O gÃ¼n iÃ§in izinli/raporlu olanlarÄ± bul
const onLeave = leaveRecords.filter(l => dateStr >= l.startDate && dateStr <= l.endDate);
const leaveStaff = onLeave.map(l => l.staffName);

// Ã‡alÄ±ÅŸan personel listesi (nÃ¶betÃ§i, izinli, raporlu hariÃ§)
let workingStaff = [];

// Hafta sonu veya tam gÃ¼n resmi tatil ise sadece nÃ¶betÃ§iler Ã§alÄ±ÅŸÄ±r
if (isWeekend || (holiday && holiday.hours === 0)) {
workingStaff = []; // Hafta sonu/tatil - normal Ã§alÄ±ÅŸan yok
} else {
// Hafta iÃ§i - nÃ¶betÃ§i ve izinliler hariÃ§ herkes
workingStaff = staffList
.filter(s => !shiftStaff.includes(s.name) && !leaveStaff.includes(s.name))
.map(s => s.name);
}

// SatÄ±r renklendirme
let rowClass = '';
let dateClass = 'text-gray-700';
if (isWeekend) {
rowClass = 'bg-red-50';
dateClass = 'text-red-600 font-bold';
} else if (holiday) {
rowClass = 'bg-amber-50';
dateClass = 'text-amber-700 font-bold';
}

// NÃ¶betÃ§i gÃ¶sterimi - MasaÃ¼stÃ¼nde tam isim, mobilde sadece ad
const shiftDisplay = dayShifts.length > 0
? dayShifts.map(s => `
<span class="inline-flex items-center gap-1 bg-purple-100 text-purple-700 rounded font-bold mr-1 mb-1 border border-purple-200
px-1 py-0.5 text-[9px] md:px-2 md:py-1 md:text-xs">
<span class="md:hidden">${s.staff.split(' ')[0]}</span>
<span class="hidden md:inline">${s.staff}</span>
</span>`).join('')
: '<span class="text-gray-400 text-[10px] md:text-xs">-</span>';

// Ã‡alÄ±ÅŸan personel gÃ¶sterimi - MasaÃ¼stÃ¼nde tam isim, mobilde sadece ad
let workingDisplay = '';
if (isWeekend || (holiday && holiday.hours === 0)) {
workingDisplay = `<span class="text-gray-400 italic text-[9px] md:text-xs">${holiday ? 'ğŸŒ ' + holiday.name : 'Hafta Sonu'}</span>`;
} else if (workingStaff.length === 0) {
workingDisplay = '<span class="text-gray-400 text-[10px] md:text-xs">-</span>';
} else {
workingDisplay = workingStaff.map(name => `
<span class="inline-block bg-green-50 text-green-700 rounded border border-green-200 font-medium mr-1 mb-1
px-1 py-0.5 text-[9px] md:px-2 md:py-1 md:text-xs">
<span class="md:hidden">${name.split(' ')[0]}</span>
<span class="hidden md:inline">${name}</span>
</span>`
).join('');
}

tbody.innerHTML += `
<tr class="${rowClass} hover:bg-gray-100/50 transition">
<td class="border border-gray-200 ${dateClass} whitespace-nowrap px-2 py-1.5 md:px-3 md:py-2">
<div class="flex items-center gap-1 md:gap-2">
<span class="font-bold text-xs md:text-sm">${day}</span>
<span class="text-[9px] md:text-xs">${dayName}</span>
${holiday ? '<span class="text-[8px] md:text-sm">ğŸŒ</span>' : ''}
</div>
</td>
<td class="border border-gray-200 px-2 py-1.5 md:px-3 md:py-2">
<div class="flex flex-wrap">${workingDisplay}</div>
</td>
<td class="border border-gray-200 px-2 py-1.5 md:px-3 md:py-2">
<div class="flex flex-wrap">${shiftDisplay}</div>
</td>
</tr>
`;
}

// AylÄ±k notlarÄ± da render et
renderMonthlyNotes();

if (typeof lucide !== 'undefined') {
lucide.createIcons();
}
};

// AylÄ±k Notlar (Ä°zin, Rapor, NÃ¶bet Ã–zeti) Render Fonksiyonu
window.renderMonthlyNotes = function () {
const container = document.getElementById('monthly-notes-container');
if (!container) return;

const selectedMonth = shiftCursorDate.getMonth();
const selectedYear = shiftCursorDate.getFullYear();
const monthName = monthsTR[selectedMonth];

// Ay baÅŸÄ± ve sonu tarihleri
const monthStart = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-01`;
const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
const monthEnd = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;

let notesHtml = '';
let hasNotes = false;

// 1. Ä°zin ve Rapor kayÄ±tlarÄ±nÄ± topla
const monthLeaves = leaveRecords.filter(l => {
// Bu ay iÃ§inde olan veya bu ayla kesiÅŸen kayÄ±tlarÄ± al
return (l.startDate <= monthEnd && l.endDate >= monthStart);
});

// Ä°zinleri grupla (personele gÃ¶re)
const leavesByStaff = {};
monthLeaves.forEach(l => {
if (!leavesByStaff[l.staffName]) {
leavesByStaff[l.staffName] = [];
}
leavesByStaff[l.staffName].push(l);
});

// Ä°zin ve rapor notlarÄ±nÄ± oluÅŸtur
Object.keys(leavesByStaff).sort().forEach(staffName => {
leavesByStaff[staffName].forEach(leave => {
hasNotes = true;
const startDate = new Date(leave.startDate);
const endDate = new Date(leave.endDate);
const startStr = startDate.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
const endStr = endDate.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });

// GÃ¼n sayÄ±sÄ±nÄ± hesapla
const dayCount = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

const isRapor = leave.type === 'Rapor';
const icon = isRapor ? 'ğŸ¥' : 'ğŸ–ï¸';
const bgColor = isRapor ? 'bg-red-50 border-red-200' : 'bg-orange-50 border-orange-200';
const textColor = isRapor ? 'text-red-700' : 'text-orange-700';
const typeText = isRapor ? 'raporlu' : 'izinli';

notesHtml += `
<div class="flex items-start gap-2 p-2 ${bgColor} rounded-lg border mb-2">
<span class="text-lg">${icon}</span>
<div class="flex-1">
<p class="text-xs ${textColor}">
<span class="font-bold">${staffName}</span>
<span class="text-gray-600">${startStr} - ${endStr}</span> tarihinde
<span class="font-bold">${dayCount} gÃ¼n ${typeText}</span>.
</p>
${leave.reason ? `<p class="text-[10px] text-gray-500 mt-0.5 italic">ğŸ“ ${leave.reason}</p>` : ''}
</div>
</div>
`;
});
});

// 2. UMKE GÃ¶revlerini umkeRecords dizisinden al
const monthUmke = (typeof umkeRecords !== 'undefined' ? umkeRecords : []).filter(u => {
// Bu ay iÃ§inde olan veya bu ayla kesiÅŸen kayÄ±tlarÄ± al
return (u.startDate <= monthEnd && u.endDate >= monthStart);
});

// UMKE gÃ¶revlerini personele gÃ¶re grupla
const umkeByStaff = {};
monthUmke.forEach(u => {
if (!umkeByStaff[u.staffName]) {
umkeByStaff[u.staffName] = [];
}
umkeByStaff[u.staffName].push(u);
});

// UMKE gÃ¶revlerini not olarak ekle
Object.keys(umkeByStaff).sort().forEach(staffName => {
umkeByStaff[staffName].forEach(umke => {
hasNotes = true;
const startDate = new Date(umke.startDate);
const endDate = new Date(umke.endDate);
const startStr = startDate.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
const endStr = endDate.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
const dayCount = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
const locationInfo = umke.location ? ` - ${umke.location}` : '';

notesHtml += `
<div class="flex items-start gap-2 p-2 bg-cyan-50 border-cyan-200 rounded-lg border mb-2">
<span class="text-lg">ğŸš‘</span>
<div class="flex-1">
<p class="text-xs text-cyan-700">
<span class="font-bold">${staffName}</span>
<span class="text-gray-600">${startStr}${dayCount > 1 ? ' - ' + endStr : ''}</span> tarihinde
<span class="font-bold">${dayCount} gÃ¼n UMKE gÃ¶revinde</span>${locationInfo}.
</p>
</div>
</div>
`;
});
});

// EÄŸer hiÃ§ not yoksa
if (!hasNotes) {
notesHtml = `
<div class="text-center py-6 text-gray-400">
<i data-lucide="clipboard-check" class="w-8 h-8 mx-auto mb-2 opacity-30"></i>
<p class="text-xs">Bu ay iÃ§in izin, rapor veya UMKE gÃ¶revi kaydÄ± bulunmuyor.</p>
</div>
`;
}

container.innerHTML = notesHtml;

if (typeof lucide !== 'undefined') {
lucide.createIcons();
}
};

// AylÄ±k Ã‡alÄ±ÅŸma Ã‡izelgesi Excel Ä°ndirme
window.downloadWorkScheduleExcel = function () {
const selectedMonth = shiftCursorDate.getMonth();
const selectedYear = shiftCursorDate.getFullYear();
const monthName = monthsTR[selectedMonth];
const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();

const wb = XLSX.utils.book_new();
const ws_data = [
['Tarih', 'GÃ¼n', 'Ã‡alÄ±ÅŸan Personel', 'NÃ¶betÃ§i']
];

for (let day = 1; day <= daysInMonth; day++) {
const dateObj = new Date(selectedYear, selectedMonth, day);
const dateStr = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
const dayName = dateObj.toLocaleDateString('tr-TR', { weekday: 'long' });
const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
const holiday = getHolidayInfo ? getHolidayInfo(dateStr) : null;

// NÃ¶betÃ§iler
const dayShifts = shiftList.filter(s => s.date === dateStr);
const shiftStaff = dayShifts.map(s => s.staff);

// Ä°zinliler
const onLeave = leaveRecords.filter(l => dateStr >= l.startDate && dateStr <= l.endDate);
const leaveStaff = onLeave.map(l => l.staffName);

// Ã‡alÄ±ÅŸanlar
let workingStaff = [];
if (!isWeekend && !(holiday && holiday.hours === 0)) {
workingStaff = staffList
.filter(s => !shiftStaff.includes(s.name) && !leaveStaff.includes(s.name))
.map(s => s.name);
}

const formattedDate = `${day} ${monthName}`;
const workingDisplay = isWeekend ? 'HAFTA SONU' :
(holiday && holiday.hours === 0) ? holiday.name :
workingStaff.join(', ') || '-';
const shiftDisplay = shiftStaff.join(', ') || '-';

ws_data.push([formattedDate, dayName, workingDisplay, shiftDisplay]);
}

const ws = XLSX.utils.aoa_to_sheet(ws_data);
XLSX.utils.book_append_sheet(wb, ws, 'Ã‡alÄ±ÅŸma Ã‡izelgesi');
XLSX.writeFile(wb, `Calisma_Cizelgesi_${monthName}_${selectedYear}.xlsx`);
showToast('Excel indirildi.', 'success');
};

window.addShift = async function () {
// GÃ¼venlik: EÄŸer 'lock-toggle' aÃ§Ä±ksa ve isEditing false ise engelle (isteÄŸe baÄŸlÄ±, ÅŸimdilik direkt ekleyelim)

const date = document.getElementById('shift-date').value;
const staff = document.getElementById('shift-staff').value.trim();
const type = document.getElementById('shift-type').value;
const note = document.getElementById('shift-note').value.trim();

if (!date || !staff) return showToast("Tarih ve Personel seÃ§iniz.", "error");

shiftList.push({
date: date,
staff: staff,
type: type,
note: note
});

// Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
await saveAll();
renderShiftTable();

// Personel ismini temizleme, seri giriÅŸ iÃ§in kalsÄ±n mÄ±? Genelde kalmasÄ± iyidir.
// Sadece notu temizleyelim.
document.getElementById('shift-note').value = '';
showToast("NÃ¶bet eklendi.");
addActivityLog('shift', 'NÃ¶bet eklendi', `${staff} - ${date} (${type})`);

// ğŸ“‹ TELEGRAM BÄ°LDÄ°RÄ°MÄ°: NÃ¶bet eklendiÄŸinde anÄ±nda bildir
if (typeof isTelegramNotifyEnabled === 'function' && isTelegramNotifyEnabled('shift')) {
const dateStr = new Date(date).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', weekday: 'long' });
const message = `ğŸ“‹ YENÄ° NÃ–BET\n\nğŸ‘¤ Personel: ${staff}\nğŸ“… Tarih: ${dateStr}\nğŸ• TÃ¼r: ${type}${note ? `\nğŸ“ Not: ${note}` : ''}`;
sendTelegramMessage(message, 'shift');
}
};

window.deleteShift = async function (idx) {
// Admin kontrolÃ¼
if (currentUserRole !== 'admin') {
showToast('NÃ¶bet silme iÅŸlemi iÃ§in admin yetkisi gereklidir!', 'error');
return;
}

if (confirm("Bu nÃ¶bet kaydÄ±nÄ± silmek istiyor musunuz?")) {
const shift = shiftList[idx];
const shiftInfo = shift ? `${shift.staff} - ${shift.date} (${shift.type})` : 'NÃ¶bet';
shiftList.splice(idx, 1);

// Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
await saveAll();
renderShiftTable();
showToast("Silindi.");
addActivityLog('shift', 'NÃ¶bet silindi', shiftInfo);
}
};

window.downloadShiftPDF = function () {
const d = shiftCursorDate;
const monthName = monthsTR[d.getMonth()];
const year = d.getFullYear();

// Filtreli liste
const selectedMonth = d.getMonth();
const selectedYear = d.getFullYear();
const filteredShifts = shiftList.filter(s => {
const dateObj = new Date(s.date);
return dateObj.getMonth() === selectedMonth && dateObj.getFullYear() === selectedYear;
}).sort((a, b) => a.date.localeCompare(b.date));

if (filteredShifts.length === 0) return showToast("Bu ay iÃ§in veri yok.", "error");

const tableBody = [
[
{ text: 'Tarih', style: 'tableHeader', fillColor: '#3730a3' },
{ text: 'Personel', style: 'tableHeader', fillColor: '#3730a3' },
{ text: 'NÃ¶bet TÃ¼rÃ¼', style: 'tableHeader', fillColor: '#3730a3' },
{ text: 'Not', style: 'tableHeader', fillColor: '#3730a3' }
]
];

filteredShifts.forEach((s, idx) => {
const dateObj = new Date(s.date);
const dateStr = dateObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', weekday: 'long' });
const rowColor = (idx % 2 === 0) ? '#ffffff' : '#f3f4f6';

tableBody.push([
{ text: dateStr, fillColor: rowColor, style: 'tableRow' },
{ text: s.staff, fillColor: rowColor, style: 'tableRow', bold: true },
{ text: s.type, fillColor: rowColor, style: 'tableRow', alignment: 'center' },
{ text: s.note || '-', fillColor: rowColor, style: 'tableRow', italics: true, color: '#6b7280' }
]);
});

const docDefinition = {
content: [
{ text: `NÃ–BET Ã‡Ä°ZELGESÄ° - ${monthName} ${year}`, style: 'header', color: '#3730a3', alignment: 'center', margin: [0, 0, 0, 20] },
{
table: {
headerRows: 1,
widths: ['auto', '*', 'auto', '*'],
body: tableBody
},
layout: 'lightHorizontalLines'
}
],
styles: {
header: { fontSize: 18, bold: true },
tableHeader: { bold: true, fontSize: 11, color: 'white', margin: [0, 6, 0, 6] },
tableRow: { fontSize: 10, margin: [0, 4, 0, 4] }
}
};

pdfMake.createPdf(docDefinition).download(`Nobet_Listesi_${monthName}_${year}.pdf`);
};

// --- YENÄ° EXPORT FONKSÄ°YONLARI ---

// NÃ¶bet Excel Export
window.downloadShiftExcel = function () {
const d = shiftCursorDate;
const monthName = monthsTR[d.getMonth()];
const year = d.getFullYear();
const filteredShifts = shiftList.filter(s => {
const dateObj = new Date(s.date);
return dateObj.getMonth() === d.getMonth() && dateObj.getFullYear() === d.getFullYear();
}).sort((a, b) => a.date.localeCompare(b.date));

if (filteredShifts.length === 0) return showToast("Bu ay iÃ§in veri yok.", "error");

const data = filteredShifts.map(s => ({
'Tarih': new Date(s.date).toLocaleDateString('tr-TR'),
'Personel': s.staff,
'NÃ¶bet TÃ¼rÃ¼': s.type,
'Not': s.note || ''
}));

const ws = XLSX.utils.json_to_sheet(data);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, 'NÃ¶bet Listesi');
XLSX.writeFile(wb, `Nobet_Listesi_${monthName}_${year}.xlsx`);
showToast('Excel indirildi!', 'success');
};

// Personel Takip Excel Export - Tablo verileriyle beraber
window.exportPersonelExcel = function () {
if (staffList.length === 0) return showToast("Personel listesi boÅŸ.", "error");

const wb = XLSX.utils.book_new();

// Personel Listesi
const personelData = staffList.map(s => ({
'Personel': s.name,
'Telefon': s.phone || '',
'DoÄŸum Tarihi': s.birthDate ? new Date(s.birthDate).toLocaleDateString('tr-TR') : ''
}));
const ws1 = XLSX.utils.json_to_sheet(personelData);
XLSX.utils.book_append_sheet(wb, ws1, 'Personel Listesi');

// HaftalÄ±k Takip Verileri (allRecords varsa)
if (typeof allRecords !== 'undefined' && Object.keys(allRecords).length > 0) {
const takipData = [];
const dates = Object.keys(allRecords).sort();

staffList.forEach(staff => {
let totalMM = 0, totalMK = 0, totalAM = 0, totalAK = 0, totalE = 0, totalSpec = 0;

dates.forEach(date => {
const record = allRecords[date]?.[staff.name];
if (record) {
totalMM += record.mm || 0;
totalMK += record.mk || 0;
totalAM += record.am || 0;
totalAK += record.ak || 0;
totalE += record.e || 0;
totalSpec += record.specialists ? record.specialists.length : 0;
}
});

takipData.push({
'Personel': staff.name,
'Ã–Ã– Merkez': totalMM,
'Ã–Ã– KÃ¶y': totalMK,
'Ã–S Merkez': totalAM,
'Ã–S KÃ¶y': totalAK,
'Muayene': totalE,
'UzmanlÄ±k': totalSpec,
'Toplam': totalMM + totalMK + totalAM + totalAK + (totalE * 2) + totalSpec
});
});

if (takipData.length > 0) {
const ws2 = XLSX.utils.json_to_sheet(takipData);
XLSX.utils.book_append_sheet(wb, ws2, 'Takip Verileri');
}
}

XLSX.writeFile(wb, `Personel_Takip_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.xlsx`);
showToast('Excel indirildi!', 'success');
};

// Personel Takip PDF Export - Tablo verileriyle beraber
window.exportPersonelPDF = function () {
if (staffList.length === 0) return showToast("Personel listesi boÅŸ.", "error");

const content = [];

content.push({ text: 'PERSONEL TAKÄ°P RAPORU', style: 'mainHeader', alignment: 'center', margin: [0, 0, 0, 20] });
content.push({ text: `Tarih: ${new Date().toLocaleDateString('tr-TR')}`, alignment: 'center', fontSize: 10, color: '#666', margin: [0, 0, 0, 20] });

// Personel Listesi
content.push({ text: 'ğŸ‘¤ PERSONEL LÄ°STESÄ°', style: 'sectionHeader', margin: [0, 10, 0, 10] });
const personelTable = [[
{ text: 'Personel', style: 'tableHeader', fillColor: '#4f46e5' },
{ text: 'Telefon', style: 'tableHeader', fillColor: '#4f46e5' },
{ text: 'DoÄŸum Tarihi', style: 'tableHeader', fillColor: '#4f46e5' }
]];
staffList.forEach((s, idx) => {
const rowColor = (idx % 2 === 0) ? '#ffffff' : '#f3f4f6';
personelTable.push([
{ text: s.name, fillColor: rowColor },
{ text: s.phone || '-', fillColor: rowColor },
{ text: s.birthDate ? new Date(s.birthDate).toLocaleDateString('tr-TR') : '-', fillColor: rowColor }
]);
});
content.push({ table: { headerRows: 1, widths: ['*', 'auto', 'auto'], body: personelTable }, layout: 'lightHorizontalLines' });

// Takip Verileri (allRecords varsa)
if (typeof allRecords !== 'undefined' && Object.keys(allRecords).length > 0) {
content.push({ text: 'ğŸ“Š TAKÄ°P VERÄ°LERÄ°', style: 'sectionHeader', margin: [0, 20, 0, 10] });
const takipTable = [[
{ text: 'Personel', style: 'tableHeader', fillColor: '#7c3aed' },
{ text: 'Ã–Ã–-M', style: 'tableHeader', fillColor: '#7c3aed' },
{ text: 'Ã–Ã–-K', style: 'tableHeader', fillColor: '#7c3aed' },
{ text: 'Ã–S-M', style: 'tableHeader', fillColor: '#7c3aed' },
{ text: 'Ã–S-K', style: 'tableHeader', fillColor: '#7c3aed' },
{ text: 'Mua.', style: 'tableHeader', fillColor: '#7c3aed' },
{ text: 'Uzm.', style: 'tableHeader', fillColor: '#7c3aed' },
{ text: 'Top.', style: 'tableHeader', fillColor: '#7c3aed' }
]];

const dates = Object.keys(allRecords).sort();
staffList.forEach((staff, idx) => {
let totalMM = 0, totalMK = 0, totalAM = 0, totalAK = 0, totalE = 0, totalSpec = 0;
dates.forEach(date => {
const record = allRecords[date]?.[staff.name];
if (record) {
totalMM += record.mm || 0;
totalMK += record.mk || 0;
totalAM += record.am || 0;
totalAK += record.ak || 0;
totalE += record.e || 0;
totalSpec += record.specialists ? record.specialists.length : 0;
}
});
const total = totalMM + totalMK + totalAM + totalAK + (totalE * 2) + totalSpec;
const rowColor = (idx % 2 === 0) ? '#ffffff' : '#f5f3ff';
takipTable.push([
{ text: staff.name, fillColor: rowColor },
{ text: totalMM.toString(), fillColor: rowColor, alignment: 'center' },
{ text: totalMK.toString(), fillColor: rowColor, alignment: 'center' },
{ text: totalAM.toString(), fillColor: rowColor, alignment: 'center' },
{ text: totalAK.toString(), fillColor: rowColor, alignment: 'center' },
{ text: totalE.toString(), fillColor: rowColor, alignment: 'center' },
{ text: totalSpec.toString(), fillColor: rowColor, alignment: 'center' },
{ text: total.toString(), fillColor: rowColor, alignment: 'center', bold: true }
]);
});
content.push({ table: { headerRows: 1, widths: ['*', 'auto', 'auto', 'auto', 'auto', 'auto', 'auto', 'auto'], body: takipTable }, layout: 'lightHorizontalLines' });
}

const docDef = {
content: content,
styles: {
mainHeader: { fontSize: 20, bold: true, color: '#1f2937' },
sectionHeader: { fontSize: 14, bold: true, color: '#374151' },
tableHeader: { bold: true, fontSize: 9, color: 'white' }
}
};
pdfMake.createPdf(docDef).download(`Personel_Takip_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.pdf`);
};

// Cihaz/Zimmet Excel Export
window.exportDeviceExcel = function () {
if (deviceList.length === 0) return showToast("Cihaz listesi boÅŸ.", "error");

const data = deviceList.map(d => ({
'KÃ¼nye No': d.tagNo || '',
'Cihaz': d.name,
'Zimmet': d.holder,
'Kalibrasyon Tarihi': d.calibDate ? new Date(d.calibDate).toLocaleDateString('tr-TR') : '',
'Durum': d.status
}));

const ws = XLSX.utils.json_to_sheet(data);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, 'Cihazlar');
XLSX.writeFile(wb, `Cihaz_Envanter_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.xlsx`);
showToast('Excel indirildi!', 'success');
};

// Cihaz/Zimmet PDF Export
window.exportDevicePDF = function () {
if (deviceList.length === 0) return showToast("Cihaz listesi boÅŸ.", "error");

const tableBody = [[
{ text: 'KÃ¼nye', style: 'tableHeader', fillColor: '#0d9488' },
{ text: 'Cihaz', style: 'tableHeader', fillColor: '#0d9488' },
{ text: 'Zimmet', style: 'tableHeader', fillColor: '#0d9488' },
{ text: 'Kalibrasyon', style: 'tableHeader', fillColor: '#0d9488' },
{ text: 'Durum', style: 'tableHeader', fillColor: '#0d9488' }
]];

deviceList.forEach((d, idx) => {
const rowColor = (idx % 2 === 0) ? '#ffffff' : '#f3f4f6';
tableBody.push([
{ text: d.tagNo || '-', fillColor: rowColor },
{ text: d.name, fillColor: rowColor },
{ text: d.holder, fillColor: rowColor },
{ text: d.calibDate ? new Date(d.calibDate).toLocaleDateString('tr-TR') : '-', fillColor: rowColor },
{ text: d.status, fillColor: rowColor }
]);
});

const docDef = {
content: [
{ text: 'CÄ°HAZ ENVANTER LÄ°STESÄ°', style: 'header', alignment: 'center', margin: [0, 0, 0, 20] },
{ table: { headerRows: 1, widths: ['auto', '*', '*', 'auto', 'auto'], body: tableBody }, layout: 'lightHorizontalLines' }
],
styles: { header: { fontSize: 18, bold: true, color: '#0d9488' }, tableHeader: { bold: true, fontSize: 10, color: 'white' } }
};
pdfMake.createPdf(docDef).download(`Cihaz_Envanter_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.pdf`);
};

// =============================================
// TALEPLER Export FonksiyonlarÄ±
// =============================================
window.exportTaleplerExcel = function () {
const wb = XLSX.utils.book_new();

// Aktif Talepler - doÄŸru alan adlarÄ±: name, proc
const aktifData = patientReminders.filter(p => p.status !== 'completed').map(p => ({
'Hasta AdÄ± SoyadÄ±': p.name || '',
'Ä°ÅŸlem': p.proc || '',
'Tarih': p.date ? new Date(p.date).toLocaleDateString('tr-TR') : '',
'Not': p.note || '',
'Durum': p.status || 'bekliyor'
}));
if (aktifData.length > 0) {
const ws1 = XLSX.utils.json_to_sheet(aktifData);
XLSX.utils.book_append_sheet(wb, ws1, 'Aktif');
}

// Tamamlanan Talepler
const tamamlananData = patientReminders.filter(p => p.status === 'completed').map(p => ({
'Hasta AdÄ± SoyadÄ±': p.name || '',
'Ä°ÅŸlem': p.proc || '',
'Tarih': p.date ? new Date(p.date).toLocaleDateString('tr-TR') : '',
'Not': p.note || '',
'Tamamlanma': p.completedAt ? new Date(p.completedAt).toLocaleDateString('tr-TR') : ''
}));
if (tamamlananData.length > 0) {
const ws2 = XLSX.utils.json_to_sheet(tamamlananData);
XLSX.utils.book_append_sheet(wb, ws2, 'Tamamlanan');
}

if (wb.SheetNames.length === 0) {
return showToast("Talep kaydÄ± yok.", "error");
}

XLSX.writeFile(wb, `Talepler_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.xlsx`);
showToast('Excel indirildi!', 'success');
};

window.exportTaleplerPDF = function () {
const content = [];
const headerColor = '#4f46e5';

content.push({ text: 'TALEPLER RAPORU', style: 'mainHeader', alignment: 'center', margin: [0, 0, 0, 20] });
content.push({ text: `Tarih: ${new Date().toLocaleDateString('tr-TR')}`, alignment: 'center', fontSize: 10, color: '#666', margin: [0, 0, 0, 20] });

// Aktif Talepler - doÄŸru alan adlarÄ±: name, proc
const aktif = patientReminders.filter(p => p.status !== 'completed');
if (aktif.length > 0) {
content.push({ text: 'ğŸ“‹ AKTÄ°F TALEPLER', style: 'sectionHeader', margin: [0, 10, 0, 10] });
const tableBody = [[
{ text: 'Hasta AdÄ± SoyadÄ±', style: 'tableHeader', fillColor: headerColor },
{ text: 'Ä°ÅŸlem', style: 'tableHeader', fillColor: headerColor },
{ text: 'Tarih', style: 'tableHeader', fillColor: headerColor },
{ text: 'Not', style: 'tableHeader', fillColor: headerColor }
]];
aktif.forEach((p, idx) => {
const rowColor = (idx % 2 === 0) ? '#ffffff' : '#f3f4f6';
tableBody.push([
{ text: p.name || '-', fillColor: rowColor },
{ text: p.proc || '-', fillColor: rowColor },
{ text: p.date ? new Date(p.date).toLocaleDateString('tr-TR') : '-', fillColor: rowColor },
{ text: p.note || '-', fillColor: rowColor }
]);
});
content.push({ table: { headerRows: 1, widths: ['*', '*', 'auto', '*'], body: tableBody }, layout: 'lightHorizontalLines' });
}

// Tamamlanan Talepler
const tamamlanan = patientReminders.filter(p => p.status === 'completed');
if (tamamlanan.length > 0) {
content.push({ text: 'âœ… TAMAMLANAN TALEPLER', style: 'sectionHeader', margin: [0, 20, 0, 10] });
const tableBody = [[
{ text: 'Hasta AdÄ± SoyadÄ±', style: 'tableHeader', fillColor: '#059669' },
{ text: 'Ä°ÅŸlem', style: 'tableHeader', fillColor: '#059669' },
{ text: 'Tarih', style: 'tableHeader', fillColor: '#059669' },
{ text: 'Tamamlanma', style: 'tableHeader', fillColor: '#059669' }
]];
tamamlanan.forEach((p, idx) => {
const rowColor = (idx % 2 === 0) ? '#ffffff' : '#ecfdf5';
tableBody.push([
{ text: p.name || '-', fillColor: rowColor },
{ text: p.proc || '-', fillColor: rowColor },
{ text: p.date ? new Date(p.date).toLocaleDateString('tr-TR') : '-', fillColor: rowColor },
{ text: p.completedAt ? new Date(p.completedAt).toLocaleDateString('tr-TR') : '-', fillColor: rowColor }
]);
});
content.push({ table: { headerRows: 1, widths: ['*', '*', 'auto', 'auto'], body: tableBody }, layout: 'lightHorizontalLines' });
}

if (content.length <= 2) {
return showToast("Talep kaydÄ± yok.", "error");
}

const docDef = {
content: content,
styles: {
mainHeader: { fontSize: 20, bold: true, color: '#1f2937' },
sectionHeader: { fontSize: 14, bold: true, color: '#374151' },
tableHeader: { bold: true, fontSize: 10, color: 'white' }
}
};
pdfMake.createPdf(docDef).download(`Talepler_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.pdf`);
};

// =============================================
// DOKTOR'A Ä°LET Export FonksiyonlarÄ± - doctorRequestsList kullanÄ±r
// =============================================
window.exportDoktorExcel = function () {
const list = window.doctorRequestsList || [];
const wb = XLSX.utils.book_new();

// Aktif - status !== 'completed' ve status !== 'cancelled'
const aktifData = list.filter(p => {
const status = p.status || 'pending';
return status !== 'completed' && status !== 'cancelled';
}).map(p => ({
'Hasta AdÄ± SoyadÄ±': p.patient || '',
'Talep': p.request || '',
'Tarih': p.date ? new Date(p.date).toLocaleDateString('tr-TR') : '',
'Durum': p.status === 'in-progress' ? 'Ä°ÅŸlemde' : 'Bekliyor'
}));
if (aktifData.length > 0) {
const ws1 = XLSX.utils.json_to_sheet(aktifData);
XLSX.utils.book_append_sheet(wb, ws1, 'Aktif');
}

// Tamamlanan - status === 'completed' veya status === 'cancelled'
const tamamlananData = list.filter(p => {
const status = p.status || 'pending';
return status === 'completed' || status === 'cancelled';
}).map(p => ({
'Hasta AdÄ± SoyadÄ±': p.patient || '',
'Talep': p.request || '',
'Tarih': p.date ? new Date(p.date).toLocaleDateString('tr-TR') : '',
'Durum': p.status === 'completed' ? 'TamamlandÄ±' : 'Ä°ptal Edildi',
'Tamamlanma': p.lastModifiedAt ? new Date(p.lastModifiedAt).toLocaleDateString('tr-TR') : ''
}));
if (tamamlananData.length > 0) {
const ws2 = XLSX.utils.json_to_sheet(tamamlananData);
XLSX.utils.book_append_sheet(wb, ws2, 'Tamamlanan');
}

if (wb.SheetNames.length === 0) {
return showToast("Doktor talebi yok.", "error");
}

XLSX.writeFile(wb, `Doktor_Talepleri_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.xlsx`);
showToast('Excel indirildi!', 'success');
};

window.exportDoktorPDF = function () {
const list = window.doctorRequestsList || [];
const content = [];
const headerColor = '#2563eb';

content.push({ text: 'DOKTOR TALEPLERÄ° RAPORU', style: 'mainHeader', alignment: 'center', margin: [0, 0, 0, 20] });
content.push({ text: `Tarih: ${new Date().toLocaleDateString('tr-TR')}`, alignment: 'center', fontSize: 10, color: '#666', margin: [0, 0, 0, 20] });

// Aktif - status !== 'completed' ve status !== 'cancelled'
const aktif = list.filter(p => {
const status = p.status || 'pending';
return status !== 'completed' && status !== 'cancelled';
});
if (aktif.length > 0) {
content.push({ text: 'ğŸ‘¨â€âš•ï¸ AKTÄ°F TALEPLER', style: 'sectionHeader', margin: [0, 10, 0, 10] });
const tableBody = [[
{ text: 'Hasta AdÄ± SoyadÄ±', style: 'tableHeader', fillColor: headerColor },
{ text: 'Talep', style: 'tableHeader', fillColor: headerColor },
{ text: 'Tarih', style: 'tableHeader', fillColor: headerColor }
]];
aktif.forEach((p, idx) => {
const rowColor = (idx % 2 === 0) ? '#ffffff' : '#eff6ff';
tableBody.push([
{ text: p.patient || '-', fillColor: rowColor },
{ text: p.request || '-', fillColor: rowColor },
{ text: p.date ? new Date(p.date).toLocaleDateString('tr-TR') : '-', fillColor: rowColor }
]);
});
content.push({ table: { headerRows: 1, widths: ['*', '*', 'auto'], body: tableBody }, layout: 'lightHorizontalLines' });
}

// Tamamlanan - status === 'completed' veya status === 'cancelled'
const tamamlanan = list.filter(p => {
const status = p.status || 'pending';
return status === 'completed' || status === 'cancelled';
});
if (tamamlanan.length > 0) {
content.push({ text: 'âœ… TAMAMLANAN / GEÃ‡MÄ°Å TALEPLER', style: 'sectionHeader', margin: [0, 20, 0, 10] });
const tableBody = [[
{ text: 'Hasta AdÄ± SoyadÄ±', style: 'tableHeader', fillColor: '#059669' },
{ text: 'Talep', style: 'tableHeader', fillColor: '#059669' },
{ text: 'Tarih', style: 'tableHeader', fillColor: '#059669' },
{ text: 'Durum', style: 'tableHeader', fillColor: '#059669' }
]];
tamamlanan.forEach((p, idx) => {
const rowColor = (idx % 2 === 0) ? '#ffffff' : '#ecfdf5';
tableBody.push([
{ text: p.patient || '-', fillColor: rowColor },
{ text: p.request || '-', fillColor: rowColor },
{ text: p.date ? new Date(p.date).toLocaleDateString('tr-TR') : '-', fillColor: rowColor },
{ text: p.status === 'completed' ? 'TamamlandÄ±' : 'Ä°ptal', fillColor: rowColor }
]);
});
content.push({ table: { headerRows: 1, widths: ['*', '*', 'auto', 'auto'], body: tableBody }, layout: 'lightHorizontalLines' });
}

if (content.length <= 2) {
return showToast("Doktor talebi yok.", "error");
}

const docDef = {
content: content,
styles: {
mainHeader: { fontSize: 20, bold: true, color: '#1f2937' },
sectionHeader: { fontSize: 14, bold: true, color: '#374151' },
tableHeader: { bold: true, fontSize: 10, color: 'white' }
}
};
pdfMake.createPdf(docDef).download(`Doktor_Talepleri_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.pdf`);
};

// =============================================
// TIBBÄ° SEKRETER Export FonksiyonlarÄ± - secretaryNotesList kullanÄ±r
// =============================================
window.exportSekreterExcel = function () {
const list = window.secretaryNotesList || [];
const wb = XLSX.utils.book_new();

// Aktif
const aktifData = list.filter(p => !p.completed).map(p => ({
'Hasta AdÄ± SoyadÄ±': p.patient || '',
'Not/Talep': p.request || '',
'Tarih': p.date ? new Date(p.date).toLocaleDateString('tr-TR') : '',
'Durum': p.completed ? 'TamamlandÄ±' : 'Bekliyor'
}));
if (aktifData.length > 0) {
const ws1 = XLSX.utils.json_to_sheet(aktifData);
XLSX.utils.book_append_sheet(wb, ws1, 'Aktif');
}

// Tamamlanan
const tamamlananData = list.filter(p => p.completed).map(p => ({
'Hasta AdÄ± SoyadÄ±': p.patient || '',
'Not/Talep': p.request || '',
'Tarih': p.date ? new Date(p.date).toLocaleDateString('tr-TR') : '',
'Tamamlanma': p.completedAt ? new Date(p.completedAt).toLocaleDateString('tr-TR') : ''
}));
if (tamamlananData.length > 0) {
const ws2 = XLSX.utils.json_to_sheet(tamamlananData);
XLSX.utils.book_append_sheet(wb, ws2, 'Tamamlanan');
}

if (wb.SheetNames.length === 0) {
return showToast("Sekreter notu yok.", "error");
}

XLSX.writeFile(wb, `Tibbi_Sekreter_Notlari_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.xlsx`);
showToast('Excel indirildi!', 'success');
};

window.exportSekreterPDF = function () {
const list = window.secretaryNotesList || [];
const content = [];
const headerColor = '#059669';

content.push({ text: 'TIBBÄ° SEKRETER NOTLARI', style: 'mainHeader', alignment: 'center', margin: [0, 0, 0, 20] });
content.push({ text: `Tarih: ${new Date().toLocaleDateString('tr-TR')}`, alignment: 'center', fontSize: 10, color: '#666', margin: [0, 0, 0, 20] });

// Aktif
const aktif = list.filter(p => !p.completed);
if (aktif.length > 0) {
content.push({ text: 'ğŸ“ AKTÄ°F NOTLAR', style: 'sectionHeader', margin: [0, 10, 0, 10] });
const tableBody = [[
{ text: 'Hasta AdÄ± SoyadÄ±', style: 'tableHeader', fillColor: headerColor },
{ text: 'Not/Talep', style: 'tableHeader', fillColor: headerColor },
{ text: 'Tarih', style: 'tableHeader', fillColor: headerColor }
]];
aktif.forEach((p, idx) => {
const rowColor = (idx % 2 === 0) ? '#ffffff' : '#ecfdf5';
tableBody.push([
{ text: p.patient || '-', fillColor: rowColor },
{ text: p.request || '-', fillColor: rowColor },
{ text: p.date ? new Date(p.date).toLocaleDateString('tr-TR') : '-', fillColor: rowColor }
]);
});
content.push({ table: { headerRows: 1, widths: ['*', '*', 'auto'], body: tableBody }, layout: 'lightHorizontalLines' });
}

// Tamamlanan
const tamamlanan = list.filter(p => p.completed);
if (tamamlanan.length > 0) {
content.push({ text: 'âœ… TAMAMLANAN NOTLAR', style: 'sectionHeader', margin: [0, 20, 0, 10] });
const tableBody = [[
{ text: 'Hasta AdÄ± SoyadÄ±', style: 'tableHeader', fillColor: '#6b7280' },
{ text: 'Not/Talep', style: 'tableHeader', fillColor: '#6b7280' },
{ text: 'Tarih', style: 'tableHeader', fillColor: '#6b7280' },
{ text: 'Tamamlanma', style: 'tableHeader', fillColor: '#6b7280' }
]];
tamamlanan.forEach((p, idx) => {
const rowColor = (idx % 2 === 0) ? '#ffffff' : '#f3f4f6';
tableBody.push([
{ text: p.patient || '-', fillColor: rowColor },
{ text: p.request || '-', fillColor: rowColor },
{ text: p.date ? new Date(p.date).toLocaleDateString('tr-TR') : '-', fillColor: rowColor },
{ text: p.completedAt ? new Date(p.completedAt).toLocaleDateString('tr-TR') : '-', fillColor: rowColor }
]);
});
content.push({ table: { headerRows: 1, widths: ['*', '*', 'auto', 'auto'], body: tableBody }, layout: 'lightHorizontalLines' });
}

if (content.length <= 2) {
return showToast("Sekreter notu yok.", "error");
}

const docDef = {
content: content,
styles: {
mainHeader: { fontSize: 20, bold: true, color: '#1f2937' },
sectionHeader: { fontSize: 14, bold: true, color: '#374151' },
tableHeader: { bold: true, fontSize: 10, color: 'white' }
}
};
pdfMake.createPdf(docDef).download(`Tibbi_Sekreter_Notlari_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.pdf`);
};

// Eski fonksiyonlarÄ± kaldÄ±rmak yerine yÃ¶nlendirme yapalÄ±m (geriye uyumluluk)
window.exportHastaTakipExcel = window.exportTaleplerExcel;
window.exportHastaTakipPDF = window.exportTaleplerPDF;

// Pansuman Excel Export
window.exportPansumanExcel = function () {
if (pansumanList.length === 0) return showToast("Pansuman kaydÄ± yok.", "error");

const gunlerTR = { pazartesi: 'Pazartesi', sali: 'SalÄ±', carsamba: 'Ã‡arÅŸamba', persembe: 'PerÅŸembe', cuma: 'Cuma', cumartesi: 'Cumartesi', pazar: 'Pazar' };
const data = pansumanList.filter(p => !p.completed).map(p => ({
'Hasta': p.patient,
'Telefon': p.phone || '',
'Konum': p.location === 'merkez' ? 'Merkez' : 'KÃ¶y',
'TÃ¼r': p.type,
'GÃ¼nler': (p.days || []).map(d => gunlerTR[d] || d).join(', '),
'Tekrar': p.repeatCount || 0,
'Adres': p.address || ''
}));

const ws = XLSX.utils.json_to_sheet(data);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, 'Pansuman');
XLSX.writeFile(wb, `Pansuman_Listesi_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.xlsx`);
showToast('Excel indirildi!', 'success');
};

// Pansuman PDF Export
window.exportPansumanPDF = function () {
const activeList = pansumanList.filter(p => !p.completed);
if (activeList.length === 0) return showToast("Aktif pansuman kaydÄ± yok.", "error");

const gunlerTR = { pazartesi: 'Pzt', sali: 'Sal', carsamba: 'Ã‡ar', persembe: 'Per', cuma: 'Cum', cumartesi: 'Cmt', pazar: 'Paz' };
const tableBody = [[
{ text: 'Hasta', style: 'tableHeader', fillColor: '#db2777' },
{ text: 'Konum', style: 'tableHeader', fillColor: '#db2777' },
{ text: 'TÃ¼r', style: 'tableHeader', fillColor: '#db2777' },
{ text: 'GÃ¼nler', style: 'tableHeader', fillColor: '#db2777' }
]];

activeList.forEach((p, idx) => {
const rowColor = (idx % 2 === 0) ? '#ffffff' : '#fdf2f8';
tableBody.push([
{ text: p.patient, fillColor: rowColor },
{ text: p.location === 'merkez' ? 'Merkez' : 'KÃ¶y', fillColor: rowColor },
{ text: p.type, fillColor: rowColor },
{ text: (p.days || []).map(d => gunlerTR[d] || d).join(', '), fillColor: rowColor }
]);
});

const docDef = {
content: [
{ text: 'PANSUMAN TAKÄ°P LÄ°STESÄ°', style: 'header', alignment: 'center', margin: [0, 0, 0, 20] },
{ table: { headerRows: 1, widths: ['*', 'auto', 'auto', '*'], body: tableBody }, layout: 'lightHorizontalLines' }
],
styles: { header: { fontSize: 18, bold: true, color: '#db2777' }, tableHeader: { bold: true, fontSize: 11, color: 'white' } }
};
pdfMake.createPdf(docDef).download(`Pansuman_Listesi_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.pdf`);
};

// Sonda/INR/NG Excel Export - Her alt sekme ayrÄ± sheet
window.exportSondaInrExcel = function () {
const wb = XLSX.utils.book_new();
const typeNames = { erkekSonda: 'Erkek Sonda', kadinSonda: 'KadÄ±n Sonda', inr: 'Ä°NR', ng: 'NG' };
const types = ['erkekSonda', 'kadinSonda', 'inr', 'ng'];

// Her tÃ¼r iÃ§in ayrÄ± sekme - sadece aktif kayÄ±tlar (status !== 'completed')
types.forEach(type => {
const data = sondaInrList.filter(p => p.type === type && p.status !== 'completed').map(p => ({
'Hasta': p.patient || '',
'Mahalle': p.mahalle || '',
'Tarih': p.date ? new Date(p.date).toLocaleDateString('tr-TR') : '',
'Sonraki Tarih': p.nextDate ? new Date(p.nextDate).toLocaleDateString('tr-TR') : '',
'Not': p.note || ''
}));
if (data.length > 0) {
const ws = XLSX.utils.json_to_sheet(data);
XLSX.utils.book_append_sheet(wb, ws, typeNames[type]);
}
});

// GeÃ§miÅŸ (status === 'completed') - ayrÄ± sekme
const gecmisData = sondaInrList.filter(p => p.status === 'completed').map(p => ({
'Hasta': p.patient || '',
'Mahalle': p.mahalle || '',
'TÃ¼r': typeNames[p.type] || p.type,
'Tarih': p.date ? new Date(p.date).toLocaleDateString('tr-TR') : '',
'Tamamlanma': p.completedAt ? new Date(p.completedAt).toLocaleDateString('tr-TR') : ''
}));
if (gecmisData.length > 0) {
const ws = XLSX.utils.json_to_sheet(gecmisData);
XLSX.utils.book_append_sheet(wb, ws, 'Gecmis');
}

if (wb.SheetNames.length === 0) {
return showToast("KayÄ±t yok.", "error");
}

XLSX.writeFile(wb, `Sonda_INR_NG_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.xlsx`);
showToast('Excel indirildi!', 'success');
};

// Sonda/INR/NG PDF Export - Her alt sekme alt alta
window.exportSondaInrPDF = function () {
const content = [];
const typeNames = { erkekSonda: 'Erkek Sonda', kadinSonda: 'KadÄ±n Sonda', inr: 'Ä°NR', ng: 'NG' };
const typeColors = { erkekSonda: '#0891b2', kadinSonda: '#ec4899', inr: '#dc2626', ng: '#7c3aed' };
const types = ['erkekSonda', 'kadinSonda', 'inr', 'ng'];

content.push({ text: 'SONDA / Ä°NR / NG TAKÄ°P RAPORU', style: 'mainHeader', alignment: 'center', margin: [0, 0, 0, 20] });
content.push({ text: `Tarih: ${new Date().toLocaleDateString('tr-TR')}`, alignment: 'center', fontSize: 10, color: '#666', margin: [0, 0, 0, 20] });

// Her tÃ¼r iÃ§in ayrÄ± bÃ¶lÃ¼m - sadece aktif kayÄ±tlar (status !== 'completed')
types.forEach(type => {
const data = sondaInrList.filter(p => p.type === type && p.status !== 'completed');
if (data.length > 0) {
content.push({ text: `ğŸ“‹ ${typeNames[type].toUpperCase()}`, style: 'sectionHeader', margin: [0, 15, 0, 10] });
const tableBody = [[
{ text: 'Hasta', style: 'tableHeader', fillColor: typeColors[type] },
{ text: 'Mahalle', style: 'tableHeader', fillColor: typeColors[type] },
{ text: 'Sonraki Tarih', style: 'tableHeader', fillColor: typeColors[type] },
{ text: 'Not', style: 'tableHeader', fillColor: typeColors[type] }
]];
data.forEach((p, idx) => {
const rowColor = (idx % 2 === 0) ? '#ffffff' : '#f3f4f6';
tableBody.push([
{ text: p.patient || '-', fillColor: rowColor },
{ text: p.mahalle || '-', fillColor: rowColor },
{ text: p.nextDate ? new Date(p.nextDate).toLocaleDateString('tr-TR') : '-', fillColor: rowColor },
{ text: p.note || '-', fillColor: rowColor }
]);
});
content.push({ table: { headerRows: 1, widths: ['*', '*', 'auto', '*'], body: tableBody }, layout: 'lightHorizontalLines' });
}
});

// GeÃ§miÅŸ (status === 'completed') - ayrÄ± bÃ¶lÃ¼m
const gecmis = sondaInrList.filter(p => p.status === 'completed');
if (gecmis.length > 0) {
content.push({ text: 'ğŸ“ GEÃ‡MÄ°Å KAYITLAR', style: 'sectionHeader', margin: [0, 20, 0, 10] });
const tableBody = [[
{ text: 'Hasta', style: 'tableHeader', fillColor: '#6b7280' },
{ text: 'TÃ¼r', style: 'tableHeader', fillColor: '#6b7280' },
{ text: 'Tarih', style: 'tableHeader', fillColor: '#6b7280' }
]];
gecmis.forEach((p, idx) => {
const rowColor = (idx % 2 === 0) ? '#ffffff' : '#f3f4f6';
tableBody.push([
{ text: p.patient || '-', fillColor: rowColor },
{ text: typeNames[p.type] || p.type, fillColor: rowColor },
{ text: p.date ? new Date(p.date).toLocaleDateString('tr-TR') : '-', fillColor: rowColor }
]);
});
content.push({ table: { headerRows: 1, widths: ['*', 'auto', 'auto'], body: tableBody }, layout: 'lightHorizontalLines' });
}

if (content.length <= 2) {
return showToast("KayÄ±t yok.", "error");
}

const docDef = {
content: content,
styles: {
mainHeader: { fontSize: 20, bold: true, color: '#1f2937' },
sectionHeader: { fontSize: 14, bold: true, color: '#374151' },
tableHeader: { bold: true, fontSize: 10, color: 'white' }
}
};
pdfMake.createPdf(docDef).download(`Sonda_INR_NG_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.pdf`);
};

// Ä°zin/Rapor Excel Export - Personel ve Doktor ayrÄ± sheet
window.exportIzinRaporExcel = function () {
const wb = XLSX.utils.book_new();

// Personel Ä°zin/Rapor
const personelData = leaveRecords.map(l => ({
'Personel': l.staffName,
'Durum': l.type,
'BaÅŸlangÄ±Ã§': l.startDate ? new Date(l.startDate).toLocaleDateString('tr-TR') : '',
'BitiÅŸ': l.endDate ? new Date(l.endDate).toLocaleDateString('tr-TR') : '',
'GÃ¼n SayÄ±sÄ±': l.startDate && l.endDate ? Math.ceil(Math.abs(new Date(l.endDate) - new Date(l.startDate)) / (1000 * 60 * 60 * 24)) + 1 : ''
}));
if (personelData.length > 0) {
const ws1 = XLSX.utils.json_to_sheet(personelData);
XLSX.utils.book_append_sheet(wb, ws1, 'Personel Izin');
}

// Doktor Ä°zin/Rapor
const doktorData = doctorLeaveRecords.map(l => ({
'Doktor': l.doctorName,
'Durum': l.type,
'BaÅŸlangÄ±Ã§': l.startDate ? new Date(l.startDate).toLocaleDateString('tr-TR') : '',
'BitiÅŸ': l.endDate ? new Date(l.endDate).toLocaleDateString('tr-TR') : '',
'GÃ¼n SayÄ±sÄ±': l.startDate && l.endDate ? Math.ceil(Math.abs(new Date(l.endDate) - new Date(l.startDate)) / (1000 * 60 * 60 * 24)) + 1 : ''
}));
if (doktorData.length > 0) {
const ws2 = XLSX.utils.json_to_sheet(doktorData);
XLSX.utils.book_append_sheet(wb, ws2, 'Doktor Izin');
}

if (wb.SheetNames.length === 0) {
return showToast("KayÄ±t yok.", "error");
}

XLSX.writeFile(wb, `Izin_Rapor_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.xlsx`);
showToast('Excel indirildi!', 'success');
};

// Ä°zin/Rapor PDF Export - Personel ve Doktor alt alta
window.exportIzinRaporPDF = function () {
const content = [];

content.push({ text: 'Ä°ZÄ°N / RAPOR LÄ°STESÄ°', style: 'mainHeader', alignment: 'center', margin: [0, 0, 0, 20] });
content.push({ text: `Tarih: ${new Date().toLocaleDateString('tr-TR')}`, alignment: 'center', fontSize: 10, color: '#666', margin: [0, 0, 0, 20] });

// Personel Ä°zin/Rapor
if (leaveRecords.length > 0) {
content.push({ text: 'ğŸ‘¤ PERSONEL Ä°ZÄ°N/RAPOR', style: 'sectionHeader', margin: [0, 10, 0, 10] });
const tableBody = [[
{ text: 'Personel', style: 'tableHeader', fillColor: '#ea580c' },
{ text: 'Durum', style: 'tableHeader', fillColor: '#ea580c' },
{ text: 'BaÅŸlangÄ±Ã§', style: 'tableHeader', fillColor: '#ea580c' },
{ text: 'BitiÅŸ', style: 'tableHeader', fillColor: '#ea580c' },
{ text: 'GÃ¼n', style: 'tableHeader', fillColor: '#ea580c' }
]];
leaveRecords.forEach((l, idx) => {
const rowColor = (idx % 2 === 0) ? '#ffffff' : '#fff7ed';
const days = l.startDate && l.endDate ? Math.ceil(Math.abs(new Date(l.endDate) - new Date(l.startDate)) / (1000 * 60 * 60 * 24)) + 1 : '-';
tableBody.push([
{ text: l.staffName, fillColor: rowColor },
{ text: l.type, fillColor: rowColor },
{ text: l.startDate ? new Date(l.startDate).toLocaleDateString('tr-TR') : '-', fillColor: rowColor },
{ text: l.endDate ? new Date(l.endDate).toLocaleDateString('tr-TR') : '-', fillColor: rowColor },
{ text: days.toString(), fillColor: rowColor, alignment: 'center' }
]);
});
content.push({ table: { headerRows: 1, widths: ['*', 'auto', 'auto', 'auto', 'auto'], body: tableBody }, layout: 'lightHorizontalLines' });
}

// Doktor Ä°zin/Rapor
if (doctorLeaveRecords.length > 0) {
content.push({ text: 'ğŸ‘¨â€âš•ï¸ DOKTOR Ä°ZÄ°N/RAPOR', style: 'sectionHeader', margin: [0, 20, 0, 10] });
const tableBody = [[
{ text: 'Doktor', style: 'tableHeader', fillColor: '#2563eb' },
{ text: 'Durum', style: 'tableHeader', fillColor: '#2563eb' },
{ text: 'BaÅŸlangÄ±Ã§', style: 'tableHeader', fillColor: '#2563eb' },
{ text: 'BitiÅŸ', style: 'tableHeader', fillColor: '#2563eb' },
{ text: 'GÃ¼n', style: 'tableHeader', fillColor: '#2563eb' }
]];
doctorLeaveRecords.forEach((l, idx) => {
const rowColor = (idx % 2 === 0) ? '#ffffff' : '#eff6ff';
const days = l.startDate && l.endDate ? Math.ceil(Math.abs(new Date(l.endDate) - new Date(l.startDate)) / (1000 * 60 * 60 * 24)) + 1 : '-';
tableBody.push([
{ text: l.doctorName, fillColor: rowColor },
{ text: l.type, fillColor: rowColor },
{ text: l.startDate ? new Date(l.startDate).toLocaleDateString('tr-TR') : '-', fillColor: rowColor },
{ text: l.endDate ? new Date(l.endDate).toLocaleDateString('tr-TR') : '-', fillColor: rowColor },
{ text: days.toString(), fillColor: rowColor, alignment: 'center' }
]);
});
content.push({ table: { headerRows: 1, widths: ['*', 'auto', 'auto', 'auto', 'auto'], body: tableBody }, layout: 'lightHorizontalLines' });
}

if (content.length <= 2) {
return showToast("KayÄ±t yok.", "error");
}

const docDef = {
content: content,
styles: {
mainHeader: { fontSize: 20, bold: true, color: '#1f2937' },
sectionHeader: { fontSize: 14, bold: true, color: '#374151' },
tableHeader: { bold: true, fontSize: 10, color: 'white' }
}
};
pdfMake.createPdf(docDef).download(`Izin_Rapor_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.pdf`);
};

// --- YENÄ° EXPORT FONKSÄ°YONLARI BÄ°TTÄ° ---

// --- NÃ–BET FONKSÄ°YONLARI ---
window.renderShiftHeader = function () {
const d = shiftCursorDate;
document.getElementById('shift-period-display').innerText = `${monthsTR[d.getMonth()]} ${d.getFullYear()}`;
const dateInput = document.getElementById('shift-date');
if (dateInput && !dateInput.value) {
const now = new Date();
dateInput.value = (now.getMonth() === d.getMonth() && now.getFullYear() === d.getFullYear()) ? getLocalDateString(now) : getLocalDateString(new Date(d.getFullYear(), d.getMonth(), 1));
}
renderShiftTable();
};
window.changeShiftMonth = function (dir) { shiftCursorDate.setMonth(shiftCursorDate.getMonth() + dir); renderShiftHeader(); };
// NOT: Duplicate renderShiftTable kaldÄ±rÄ±ldÄ±, yukarÄ±daki ana fonksiyon kullanÄ±lacak
// NOT: Duplicate addShift ve deleteShift fonksiyonlarÄ± kaldÄ±rÄ±ldÄ±, yukarÄ±daki async versiyonlar kullanÄ±lacak
// --- CÄ°HAZ / ZÄ°MMET FONKSÄ°YONLARI ---
window.renderDeviceTable = function () {
const tbody = document.getElementById('dev-list-body');
const badge = document.getElementById('dev-count-badge');
if (!tbody) return;

if (deviceList.length === 0) {
tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-400 text-xs">KayÄ±tlÄ± cihaz yok.</td></tr>';
if (badge) badge.innerText = "0 Cihaz";
return;
}

const today = new Date();
today.setHours(0, 0, 0, 0);

const rows = deviceList.map((d, idx) => {
let calibStatusHtml = '<span class="text-gray-400">-</span>';
if (d.calibDate) {
const cDate = new Date(d.calibDate);
const isExpired = cDate < today;
const isClose = (cDate - today) / (1000 * 60 * 60 * 24) < 7;

let dateColor = "text-gray-600";
let icon = "";

if (isExpired) {
dateColor = "text-red-600 font-bold";
icon = '<i data-lucide="alert-triangle" class="w-3 h-3 inline mr-1 text-red-600"></i>';
} else if (isClose) {
dateColor = "text-orange-600 font-bold";
icon = '<i data-lucide="clock" class="w-3 h-3 inline mr-1 text-orange-600"></i>';
}
calibStatusHtml = `<span class="${dateColor} text-xs">${icon}${new Date(d.calibDate).toLocaleDateString('tr-TR')}</span>`;
}

let statusClass = "bg-gray-100 text-gray-700";
if (d.status.includes("SaÄŸlam")) statusClass = "bg-teal-100 text-teal-800";
if (d.status.includes("ArÄ±zalÄ±")) statusClass = "bg-red-100 text-red-800";
if (d.status.includes("Serviste")) statusClass = "bg-orange-100 text-orange-800";
if (d.status.includes("Kayboldu")) statusClass = "bg-gray-800 text-white";

return `
<tr class="hover:bg-teal-50/30 border-b last:border-0 group transition">
<td class="px-4 py-3 font-bold text-teal-700 text-xs font-mono">${d.tagNo || '-'}</td>
<td class="px-4 py-3 font-medium text-gray-700">${d.name}</td>
<td class="px-4 py-3 font-bold text-gray-600">${d.holder}</td>
<td class="px-4 py-3">${calibStatusHtml}</td>
<td class="px-4 py-3"><span class="px-2 py-1 rounded text-[10px] font-bold ${statusClass}">${d.status}</span></td>
<td class="px-4 py-3 text-right">
<div class="flex justify-end items-center gap-2">
<button onclick="startEditDevice(${idx})" class="text-gray-400 hover:text-orange-600 transition p-1" title="DÃ¼zenle">
<i data-lucide="edit-3" class="w-4 h-4"></i>
</button>
<button onclick="deleteDevice(${idx})" class="text-gray-400 hover:text-red-600 transition p-1" title="Sil">
<i data-lucide="trash-2" class="w-4 h-4"></i>
</button>
</div>
</td>
</tr>
`;
});
tbody.innerHTML = rows.join('');

if (badge) badge.innerText = `${deviceList.length} Cihaz`;
lucide.createIcons({ nodes: [tbody] });
};

window.addDevice = async function () {
const tagNo = document.getElementById('dev-tag-no').value.trim();
const name = document.getElementById('dev-name').value.trim();
const holder = document.getElementById('dev-holder').value.trim();
const calibDate = document.getElementById('dev-calib-date').value;
const status = document.getElementById('dev-status').value;

if (!name || !holder) return showToast("Cihaz adÄ± ve Zimmet kiÅŸisi zorunludur.", "error");

const deviceObj = { tagNo, name, holder, calibDate, status };

if (editingDeviceIndex > -1) {
// DÃ¼zenleme Modu
deviceList[editingDeviceIndex] = deviceObj;
showToast("Cihaz bilgileri gÃ¼ncellendi.");
cancelDeviceEdit(); // Moddan Ã§Ä±k
} else {
// Yeni Ekleme Modu
deviceList.push(deviceObj);
showToast("Cihaz eklendi.");
addActivityLog('device', 'Cihaz eklendi', `${name} â†’ ${holder}`);
// Formu temizle
document.getElementById('dev-tag-no').value = '';
document.getElementById('dev-name').value = '';
document.getElementById('dev-name').focus();
}

// Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
await saveAll();
renderDeviceTable();
showToast("Cihaz eklendi");
};

window.startEditDevice = function (idx) {
const item = deviceList[idx];
if (!item) return;

// Formu doldur
document.getElementById('dev-tag-no').value = item.tagNo || '';
document.getElementById('dev-name').value = item.name;
document.getElementById('dev-holder').value = item.holder;
document.getElementById('dev-calib-date').value = item.calibDate || '';
document.getElementById('dev-status').value = item.status;

// Modu aktif et
editingDeviceIndex = idx;

// ButonlarÄ± gÃ¼ncelle
const btnSave = document.getElementById('btn-device-save');
const btnCancel = document.getElementById('btn-device-cancel');

btnSave.innerHTML = '<span>GÃ¼ncelle</span>';
btnSave.classList.replace('bg-teal-600', 'bg-orange-600');
btnSave.classList.replace('hover:bg-teal-700', 'hover:bg-orange-700');

btnCancel.classList.remove('hidden');

// YukarÄ± kaydÄ±r (Mobil iÃ§in)
document.getElementById('dev-name').scrollIntoView({ behavior: 'smooth', block: 'center' });
};

window.cancelDeviceEdit = function () {
// Formu temizle
document.getElementById('dev-tag-no').value = '';
document.getElementById('dev-name').value = '';
document.getElementById('dev-holder').value = '';
document.getElementById('dev-calib-date').value = '';
document.getElementById('dev-status').value = 'SaÄŸlam';

// Modu kapat
editingDeviceIndex = -1;

// ButonlarÄ± eski haline getir
const btnSave = document.getElementById('btn-device-save');
const btnCancel = document.getElementById('btn-device-cancel');

btnSave.innerHTML = '<span>Envantere Ekle</span>';
btnSave.classList.replace('bg-orange-600', 'bg-teal-600');
btnSave.classList.replace('hover:bg-orange-700', 'hover:bg-teal-700');

btnCancel.classList.add('hidden');
};

window.deleteDevice = async function (idx) {
if (confirm("Bu cihaz kaydÄ±nÄ± silmek istiyor musunuz?")) {
const device = deviceList[idx];
const deviceInfo = device ? `${device.name} â†’ ${device.holder}` : 'Cihaz';
deviceList.splice(idx, 1);

// Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
await saveAll();
renderDeviceTable();
showToast("Silindi.");
addActivityLog('device', 'Cihaz silindi', deviceInfo);
}
};
// --- Ä°STATÄ°STÄ°K PANOSU JS ---
let chartInstances = {}; // Grafikleri hafÄ±zada tutmak iÃ§in
let statsSelectedMonth = new Date(); // SeÃ§ili ay iÃ§in global deÄŸiÅŸken

// TÃ¼rkÃ§e ay isimleri
const monthNamesTR = ['Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran',
'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];

// Ay gÃ¶stergesini gÃ¼ncelle
function updateStatsMonthDisplay() {
const monthEl = document.getElementById('stats-month-display');
const labelEl = document.getElementById('stat-total-label');
if (monthEl) {
const monthName = monthNamesTR[statsSelectedMonth.getMonth()];
const year = statsSelectedMonth.getFullYear();
monthEl.textContent = `${monthName} ${year}`;

// Toplam Hasta etiketini gÃ¼ncelle
if (labelEl) {
labelEl.textContent = `Toplam Hasta (${monthName} ${year})`;
}
}
// Lucide ikonlarÄ±nÄ± yenile
if (typeof lucide !== 'undefined') lucide.createIcons();
}

// Ay deÄŸiÅŸtir (delta: -1 = Ã¶nceki, +1 = sonraki)
function changeStatsMonth(delta) {
statsSelectedMonth.setMonth(statsSelectedMonth.getMonth() + delta);
updateStatsMonthDisplay();
renderDashboard();
}

// Bu aya git
function goToCurrentMonth() {
statsSelectedMonth = new Date();
updateStatsMonthDisplay();
renderDashboard();
}

window.renderDashboard = function () {
// --- 1. TARÄ°H AYARLARI ---
// SeÃ§ili ayÄ± kullan (global deÄŸiÅŸken)
const currentMonth = `${statsSelectedMonth.getFullYear()}-${String(statsSelectedMonth.getMonth() + 1).padStart(2, '0')}`; // "2025-12"

// Ay gÃ¶stergesini gÃ¼ncelle
updateStatsMonthDisplay();

// --- 2. VERÄ°LERÄ° HAZIRLA ---
let totalPatientsThisMonth = 0;
const procStats = {};
procList.forEach(p => procStats[p] = 0);

// Doktor Detay YapÄ±sÄ±
const doctorDetailedStats = {};
const allEncounteredProcs = new Set();

doctorList.forEach(d => {
doctorDetailedStats[d.name] = { patients: 0, procs: {} };
});

// --- 3. DOKTOR VE Ä°ÅLEM VERÄ°LERÄ°NÄ° HESAPLA ---
Object.keys(docRecords).forEach(date => {
if (date.startsWith(currentMonth)) {
doctorList.forEach(doc => {
const rec = docRecords[date][doc.name];
if (rec) {
// A) Hasta SayÄ±sÄ±
const pCount = parseInt(rec.pCount) || 0;
if (pCount > 0) {
totalPatientsThisMonth += pCount;
if (doctorDetailedStats[doc.name]) doctorDetailedStats[doc.name].patients += pCount;
}

// B) Ä°ÅŸlem SayÄ±larÄ±
if (rec.procs) {
Object.entries(rec.procs).forEach(([procName, count]) => {
const val = parseInt(count) || 0;
if (val > 0) {
if (procStats[procName] === undefined) procStats[procName] = 0;
procStats[procName] += val;

if (doctorDetailedStats[doc.name]) {
if (!doctorDetailedStats[doc.name].procs[procName]) doctorDetailedStats[doc.name].procs[procName] = 0;
doctorDetailedStats[doc.name].procs[procName] += val;
allEncounteredProcs.add(procName);
}
}
});
}
}
});
}
});

// --- 4. PERSONEL PERFORMANS VERÄ°LERÄ° ---
const staffStats = {};
Object.keys(allRecords).forEach(date => {
if (!date.startsWith(currentMonth)) return;
staffList.forEach(s => {
const r = allRecords[date][s.name];
if (r) {
const specCount = r.specialists ? r.specialists.length : 0;
const dailyScore = (r.mm || 0) + (r.mk || 0) + (r.am || 0) + (r.ak || 0) + ((r.e || 0) * 2) + specCount;
if (dailyScore > 0) staffStats[s.name] = (staffStats[s.name] || 0) + dailyScore;
}
});
});

// --- 5. KARTLARI GÃœNCELLE ---
document.getElementById('stat-total-visit').innerText = totalPatientsThisMonth;

let maxScore = 0;
Object.values(staffStats).forEach(score => { if (score > maxScore) maxScore = score; });
let topPerformers = [];
if (maxScore > 0) {
Object.entries(staffStats).forEach(([name, score]) => { if (score === maxScore) topPerformers.push(name); });
}
const topStaffText = topPerformers.length > 0 ? `${topPerformers.join(', ')} (${maxScore})` : "-";
const elTopStaff = document.getElementById('stat-top-staff');
elTopStaff.innerText = topStaffText;
elTopStaff.classList.replace(topPerformers.length > 2 ? 'text-xl' : 'text-sm', topPerformers.length > 2 ? 'text-sm' : 'text-xl');

// --- 6. GRAFÄ°KLERÄ° Ã‡Ä°Z ---
if (chartInstances['staff']) chartInstances['staff'].destroy();
if (chartInstances['types']) chartInstances['types'].destroy();
if (chartInstances['docDetail']) chartInstances['docDetail'].destroy();

const colors = [
'rgba(59, 130, 246, 0.7)', 'rgba(249, 115, 22, 0.7)', 'rgba(16, 185, 129, 0.7)',
'rgba(239, 68, 68, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(236, 72, 153, 0.7)',
'rgba(245, 158, 11, 0.7)', 'rgba(6, 182, 212, 0.7)'
];

// Grafik 1
const ctxStaff = document.getElementById('chart-staff-performance').getContext('2d');
chartInstances['staff'] = new Chart(ctxStaff, {
type: 'bar',
data: {
labels: Object.keys(staffStats),
datasets: [{
label: 'Bu Ayki Performans PuanÄ±',
data: Object.values(staffStats),
backgroundColor: 'rgba(79, 70, 229, 0.7)',
borderColor: 'rgba(79, 70, 229, 1)',
borderWidth: 1,
borderRadius: 5
}]
},
options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
});

// Grafik 2 (Pasta - SayÄ±lÄ± Etiketler)
const activeProcs = []; const activeCounts = [];
Object.entries(procStats).forEach(([name, count]) => {
if (count > 0) { activeProcs.push(`${name} (${count})`); activeCounts.push(count); }
});
const ctxTypes = document.getElementById('chart-visit-types').getContext('2d');
chartInstances['types'] = new Chart(ctxTypes, {
type: 'doughnut',
data: {
labels: activeProcs.length ? activeProcs : ['Veri Yok'],
datasets: [{
data: activeCounts.length ? activeCounts : [1],
backgroundColor: activeCounts.length ? colors : ['#e5e7eb'],
borderWidth: 0
}]
},
options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } } }
});

// Grafik 3 (Doktor Detay)
const docNames = Object.keys(doctorDetailedStats);
const docDatasets = [];

// Hasta SayÄ±sÄ±
docDatasets.push({
label: 'Toplam Hasta',
data: docNames.map(name => doctorDetailedStats[name].patients),
backgroundColor: 'rgba(30, 64, 175, 0.8)',
stack: 'Patients',
});

// Ä°ÅŸlemler
let colorIdx = 0;
Array.from(allEncounteredProcs).forEach(procName => {
docDatasets.push({
label: procName,
data: docNames.map(name => doctorDetailedStats[name].procs[procName] || 0),
backgroundColor: colors[colorIdx % colors.length],
stack: 'Procedures',
});
colorIdx++;
});

const ctxDocDetail = document.getElementById('chart-doctor-details').getContext('2d');
chartInstances['docDetail'] = new Chart(ctxDocDetail, {
type: 'bar',
data: { labels: docNames, datasets: docDatasets },
options: {
responsive: true, maintainAspectRatio: false,
scales: { x: { stacked: true }, y: { beginAtZero: true, stacked: true } },
plugins: { tooltip: { mode: 'index', intersect: false } }
}
});

// --- 7. DETAY KARTLARINI OLUÅTUR (HTML) ---
const breakdownArea = document.getElementById('doc-breakdown-area');
breakdownArea.innerHTML = ''; // Temizle

Object.entries(doctorDetailedStats).forEach(([docName, stats]) => {
// Sadece verisi olan doktorlarÄ± gÃ¶sterelim
if (stats.patients === 0 && Object.keys(stats.procs).length === 0) return;

// Ä°ÅŸlem Listesi HTML'i HazÄ±rla
let procsHtml = '';
Object.entries(stats.procs).forEach(([pName, pCount]) => {
if (pCount > 0) {
procsHtml += `<span class="inline-block bg-gray-100 dark:bg-gray-700 rounded px-2 py-1 text-xs mr-1 mb-1 text-gray-700 dark:text-gray-300">${pName} <b>(${pCount})</b></span>`;
}
});

if (procsHtml === '') procsHtml = '<span class="text-xs text-gray-400">Ä°ÅŸlem yok</span>';

const cardHtml = `
<div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-3 border border-gray-100 dark:border-gray-700">
<div class="flex justify-between items-center mb-2 border-b pb-1 dark:border-gray-700">
<h4 class="font-bold text-sm text-indigo-700 dark:text-indigo-400">${docName}</h4>
<span class="text-xs font-bold bg-blue-100 text-blue-800 px-2 py-0.5 rounded">H: ${stats.patients}</span>
</div>
<div class="flex flex-wrap">
${procsHtml}
</div>
</div>
`;
breakdownArea.innerHTML += cardHtml;
});
// --- 8. NÃ–BET Ã‡Ä°ZELGESÄ° MODÃœLÃœ (3 HAFTALIK) ---

// YardÄ±mcÄ± Fonksiyon: Belirli bir baÅŸlangÄ±Ã§ tarihine gÃ¶re tabloyu doldurur
const renderWeekTable = (startDate, containerId, emptyMsg) => {
const tbody = document.getElementById(containerId);
if (!tbody) return;

tbody.innerHTML = '';

// 7 GÃ¼nlÃ¼k Tarih Listesi OluÅŸtur
const targetDates = [];
let tempDate = new Date(startDate);
for (let i = 0; i < 7; i++) {
targetDates.push(getLocalDateString(tempDate));
tempDate.setDate(tempDate.getDate() + 1);
}

// NÃ¶betleri SÃ¼z
const weekShifts = shiftList.filter(s => targetDates.includes(s.date));
weekShifts.sort((a, b) => a.date.localeCompare(b.date));

if (weekShifts.length === 0) {
tbody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-gray-400 italic text-[10px]">${emptyMsg}</td></tr>`;
} else {
weekShifts.forEach(s => {
const d = new Date(s.date);
const dayName = d.toLocaleDateString('tr-TR', { weekday: 'long' });
const dateDisplay = d.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' });
const isWeekend = (d.getDay() === 0 || d.getDay() === 6);

// Hafta sonu rengi
const rowBg = isWeekend ? 'bg-orange-50/40 dark:bg-orange-900/10' : 'hover:bg-gray-50 dark:hover:bg-gray-700';
const dateColor = isWeekend ? 'text-orange-700 dark:text-orange-400' : 'text-gray-700 dark:text-gray-200';

// TÃ¼r Rengi
let badgeClass = "bg-indigo-100 text-indigo-700 border-indigo-200";
if (s.type === 'Ä°cap') badgeClass = "bg-yellow-100 text-yellow-700 border-yellow-200";
if (s.type === '24 Saat' || s.type === 'Gece') badgeClass = "bg-red-100 text-red-700 border-red-200";

tbody.innerHTML += `
<tr class="${rowBg} transition border-b border-gray-100 dark:border-gray-700 last:border-0">
<td class="px-4 py-2 w-1/3">
<div class="flex flex-col">
<span class="font-bold text-[11px] ${dateColor}">${dayName}</span>
<span class="text-[9px] text-gray-400">${dateDisplay}</span>
</div>
</td>
<td class="px-4 py-2 w-1/3">
<div class="flex items-center gap-2">
<div class="w-5 h-5 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-500 font-bold text-[9px] shadow-sm">
${s.staff.charAt(0)}
</div>
<span class="font-bold text-gray-800 dark:text-gray-100 text-xs truncate max-w-[120px]">${s.staff}</span>
</div>
${s.note ? `<div class="text-[9px] text-gray-400 italic mt-0.5 ml-7 truncate max-w-[150px]">${s.note}</div>` : ''}
</td>
<td class="px-4 py-2 w-1/3 text-right">
<span class="px-1.5 py-0.5 rounded text-[9px] font-bold border ${badgeClass} shadow-sm">
${s.type}
</span>
</td>
</tr>
`;
});
}
};

// 1. MEVCUT HAFTA (Current Week)
renderWeekTable(currentWeekStart, 'stat-weekly-shifts-body', 'Bu hafta nÃ¶bet yok.');

// 2. GEÃ‡EN HAFTA (Previous Week)
const prevWeekStart = new Date(currentWeekStart);
prevWeekStart.setDate(prevWeekStart.getDate() - 7);
renderWeekTable(prevWeekStart, 'stat-prev-week-shifts-body', 'GeÃ§en hafta nÃ¶bet yok.');

// 3. GELECEK HAFTA (Next Week)
const nextWeekStart = new Date(currentWeekStart);
nextWeekStart.setDate(nextWeekStart.getDate() + 7);
renderWeekTable(nextWeekStart, 'stat-next-week-shifts-body', 'Gelecek hafta nÃ¶bet yok.');
};
// --- KARANLIK MOD MANTIÄI ---
const themeBtn = document.getElementById('btn-theme-toggle');
const themeIcon = document.getElementById('theme-icon');
const htmlEl = document.documentElement;

// Sayfa yÃ¼klendiÄŸinde hafÄ±zayÄ± kontrol et
if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
htmlEl.classList.add('dark');
themeIcon.setAttribute('data-lucide', 'sun'); // Ä°konu GÃ¼neÅŸ yap
} else {
htmlEl.classList.remove('dark');
themeIcon.setAttribute('data-lucide', 'moon'); // Ä°konu Ay yap
}

// Butona tÄ±klama olayÄ±
if (themeBtn) {
themeBtn.addEventListener('click', function () {
if (htmlEl.classList.contains('dark')) {
htmlEl.classList.remove('dark');
localStorage.setItem('color-theme', 'light');
themeIcon.setAttribute('data-lucide', 'moon');
} else {
htmlEl.classList.add('dark');
localStorage.setItem('color-theme', 'dark');
themeIcon.setAttribute('data-lucide', 'sun');
}
lucide.createIcons(); // Ä°konu yenile
});
}
// --- GLOBAL ARAMA (SPOTLIGHT SEARCH) MANTIÄI ---
const searchInput = document.getElementById('global-search-input');
const searchResults = document.getElementById('global-search-results');

// Vurgulama ve KaydÄ±rma Fonksiyonu (Arama sonuÃ§larÄ± iÃ§in)
window.highlightSearchTarget = function (tabId, searchText, delay = 800) {
setTimeout(() => {
// Arama metnini temizle
const searchPart = searchText.split(' - ')[0].trim();

let targetElement = null;

// Aktif tab iÃ§indeki tÃ¼m tablolarda ve Ã¶ÄŸelerde ara
const containers = [
'#personel-table tbody tr',
'#doctor-table tbody tr',
'#device-body tr',
'#shift-body tr',
'#general-notes-grid > div',
'#emergency-bag-list > div',
'#patient-reminder-table tbody tr',
'#budget-table tbody tr',
'#daily-routines-table tbody tr',
'#leave-table tbody tr',
'#phonebook-table tbody tr',
'#pansuman-table tbody tr',
'#sekreter-notes-grid > div',
'#sonda-patients-body tr',
'#street-results-container > *',
'.patient-request-table tbody tr',
'.doctor-request-table tbody tr'
];

for (const selector of containers) {
const elements = document.querySelectorAll(selector);
for (const el of elements) {
if (el.textContent.toLowerCase().includes(searchPart.toLowerCase())) {
targetElement = el;
break;
}
}
if (targetElement) break;
}

// EÄŸer bulunamadÄ±ysa, aktif tab'Ä±n tÃ¼m iÃ§eriÄŸinde ara
if (!targetElement) {
const activeTab = document.querySelector('.tab-content:not(.hidden)');
if (activeTab) {
const allRows = activeTab.querySelectorAll('table tbody tr, .grid > div, .flex > div');
for (const row of allRows) {
if (row.textContent.toLowerCase().includes(searchPart.toLowerCase())) {
targetElement = row;
break;
}
}
}
}

if (targetElement) {

// EkranÄ±n ortasÄ±na kaydÄ±r
targetElement.scrollIntoView({
behavior: 'smooth',
block: 'center',
inline: 'nearest'
});

// Highlight efekti ekle (bildirim sistemiyle aynÄ± stil)
targetElement.style.transition = 'all 0.3s ease';
targetElement.style.boxShadow = '0 0 0 4px rgba(251, 146, 60, 0.8)';
targetElement.style.background = 'rgba(251, 146, 60, 0.15)';
targetElement.style.transform = 'scale(1.01)';
targetElement.style.borderRadius = '8px';
targetElement.style.position = 'relative';
targetElement.style.zIndex = '10';

// 3 saniye sonra efekti kaldÄ±r
setTimeout(() => {
targetElement.style.boxShadow = '';
targetElement.style.background = '';
targetElement.style.transform = '';
targetElement.style.borderRadius = '';
targetElement.style.zIndex = '';
}, 3000);
} else {
}
}, delay);
};

// Element ID ile vurgulama (eski fonksiyon - uyumluluk iÃ§in)
window.highlightAndScrollTo = function (elementId, delay = 300) {
setTimeout(() => {
const element = document.getElementById(elementId);
if (!element) return;

element.scrollIntoView({ behavior: 'smooth', block: 'center' });
element.style.transition = 'all 0.3s ease';
element.style.boxShadow = '0 0 0 4px rgba(251, 146, 60, 0.8)';
element.style.background = 'rgba(251, 146, 60, 0.15)';

setTimeout(() => {
element.style.boxShadow = '';
element.style.background = '';
}, 3000);
}, delay);
};

// Arama sonuÃ§larÄ±nÄ± input altÄ±na konumlandÄ±r
function positionSearchResults() {
if (!searchInput || !searchResults) return;
const rect = searchInput.getBoundingClientRect();
searchResults.style.top = (rect.bottom + 4) + 'px';
searchResults.style.left = rect.left + 'px';
searchResults.style.width = Math.max(rect.width, 450) + 'px';
}

if (searchInput) {
// 1. Arama YapÄ±ldÄ±kÃ§a Ã‡alÄ±ÅŸ
searchInput.addEventListener('input', (e) => {
const query = e.target.value.toLowerCase().trim();
if (query.length < 2) { // 2 harften azsa arama yapma
searchResults.classList.add('hidden');
return;
}
positionSearchResults();
const results = performGlobalSearch(query);
renderGlobalSearchResults(results);
});

// 2. DÄ±ÅŸarÄ± TÄ±klayÄ±nca Kapat
document.addEventListener('click', (e) => {
if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
searchResults.classList.add('hidden');
}
});

// 3. Kutuya TÄ±klayÄ±nca (EÄŸer veri varsa) AÃ§
searchInput.addEventListener('focus', () => {
if (searchInput.value.trim().length >= 2) {
positionSearchResults();
searchResults.classList.remove('hidden');
}
});

// 4. Pencere kaydÄ±rÄ±ldÄ±ÄŸÄ±nda veya resize edildiÄŸinde pozisyonu gÃ¼ncelle
window.addEventListener('scroll', () => {
if (!searchResults.classList.contains('hidden')) {
positionSearchResults();
}
});
window.addEventListener('resize', positionSearchResults);
}

// --- MOBÄ°L TAM EKRAN ARAMA MODAL ---
const mobileSearchModal = document.getElementById('mobile-search-modal');
const mobileSearchInput = document.getElementById('mobile-search-modal-input');
const mobileSearchResults = document.getElementById('mobile-search-modal-results');

// Modal AÃ§
window.openMobileSearchModal = function() {
if (mobileSearchModal) {
mobileSearchModal.classList.remove('hidden');
mobileSearchModal.classList.add('flex');
setTimeout(() => {
if (mobileSearchInput) mobileSearchInput.focus();
if (typeof lucide !== 'undefined') lucide.createIcons();
}, 100);
}
};

// Modal Kapat
window.closeMobileSearchModal = function() {
if (mobileSearchModal) {
mobileSearchModal.classList.add('hidden');
mobileSearchModal.classList.remove('flex');
if (mobileSearchInput) mobileSearchInput.value = '';
if (mobileSearchResults) {
mobileSearchResults.innerHTML = '<div class="text-center text-gray-400 py-8"><i data-lucide="search" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i><p>Aramak iÃ§in yazÄ±n...</p></div>';
if (typeof lucide !== 'undefined') lucide.createIcons();
}
}
};

// Arama Input Eventi
if (mobileSearchInput) {
mobileSearchInput.addEventListener('input', (e) => {
const query = e.target.value.trim();
if (query.length < 2) {
mobileSearchResults.innerHTML = '<div class="text-center text-gray-400 py-8"><i data-lucide="search" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i><p>En az 2 karakter yazÄ±n...</p></div>';
if (typeof lucide !== 'undefined') lucide.createIcons();
return;
}
const results = performGlobalSearch(query);
renderMobileSearchResultsFullscreen(results);
});
}

// Tam Ekran SonuÃ§ Render - action fonksiyonunu saklayarak
function renderMobileSearchResultsFullscreen(results) {
if (!mobileSearchResults) return;

if (results.length === 0) {
mobileSearchResults.innerHTML = '<div class="text-center text-gray-400 py-8"><i data-lucide="search-x" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i><p>EÅŸleÅŸen kayÄ±t bulunamadÄ±.</p></div>';
if (typeof lucide !== 'undefined') lucide.createIcons();
return;
}

// SonuÃ§larÄ± global olarak sakla
window._mobileSearchResults = results;

let html = '';
results.forEach((res, index) => {
html += `
<div class="flex items-center gap-3 p-3 bg-white rounded-xl border border-gray-100 shadow-sm cursor-pointer hover:shadow-md active:bg-gray-50 transition" 
onclick="handleMobileSearchClick(${index})">
<div class="${res.bg} ${res.color} p-2.5 rounded-xl flex-shrink-0">
<i data-lucide="${res.icon}" class="w-5 h-5"></i>
</div>
<div class="flex-1 min-w-0">
<div class="text-sm font-bold text-gray-800 truncate">${res.title}</div>
<div class="text-xs text-gray-500 flex items-center gap-1.5 mt-0.5">
<span class="font-bold ${res.color} bg-gray-50 px-1.5 py-0.5 rounded text-[10px] uppercase">${res.type}</span>
<span class="text-gray-400 truncate">${res.sub}</span>
</div>
</div>
<i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 flex-shrink-0"></i>
</div>`;
});

if (results.length > 20) {
html += `<div class="text-center text-xs text-gray-500 font-medium py-3">+${results.length - 20} kayÄ±t daha var</div>`;
}

mobileSearchResults.innerHTML = html;
if (typeof lucide !== 'undefined') lucide.createIcons();
}

// Sonuca TÄ±klama - action fonksiyonunu Ã§aÄŸÄ±rarak doÄŸru sekmeye git
window.handleMobileSearchClick = function(index) {
const results = window._mobileSearchResults;
if (!results || !results[index]) return;

const res = results[index];
const searchText = res.title;

// Modal'Ä± kapat
closeMobileSearchModal();

// Action fonksiyonunu Ã§aÄŸÄ±r (sekme deÄŸiÅŸtirme)
if (res.action && typeof res.action === 'function') {
res.action();
}

// Sekme deÄŸiÅŸtikten sonra Ã¶ÄŸeyi bul ve vurgula
setTimeout(() => {
if (typeof highlightSearchTarget === 'function') {
highlightSearchTarget(res.tabId || '', searchText, 500);
}
}, 800);
};

// --- GELÄ°ÅTÄ°RÄ°LMÄ°Å GLOBAL ARAMA (HER ÅEY DAHÄ°L) ---
function performGlobalSearch(q) {
// TÃ¼rkÃ§e karakter normalizasyonu - hem kÃ¼Ã§Ã¼k hem bÃ¼yÃ¼k harfler
const normalizeTurkish = (str) => {
if (!str) return '';
return str
.toString()
.toLowerCase()
.replace(/Ã¶/g, 'o').replace(/Ã–/g, 'o')
.replace(/Ã¼/g, 'u').replace(/Ãœ/g, 'u')
.replace(/ÅŸ/g, 's').replace(/Å/g, 's')
.replace(/Ã§/g, 'c').replace(/Ã‡/g, 'c')
.replace(/ÄŸ/g, 'g').replace(/Ä/g, 'g')
.replace(/Ä±/g, 'i').replace(/Ä°/g, 'i')
.replace(/I/g, 'i');
};

// Arama terimlerini parÃ§ala ve normalize et
const normalizedQuery = normalizeTurkish(q);
const terms = normalizedQuery.split(' ').filter(t => t.trim() !== '');

let hits = [];

// YardÄ±mcÄ± Fonksiyon: Normalize edilmiÅŸ metin iÃ§inde arama
const checkMatch = (textSource) => {
const text = normalizeTurkish(textSource);
return terms.every(term => text.includes(term));
};

// 1. PERSONEL ARAMASI
staffList.forEach(s => {
if (checkMatch(s.name + " " + s.role))
hits.push({ type: 'Personel', title: s.name, sub: s.role, icon: 'user', color: 'text-blue-600', bg: 'bg-blue-100', action: () => switchTab('personel') });
});

// 2. DOKTOR ARAMASI
doctorList.forEach(d => {
if (checkMatch(d.name + " Doktor"))
hits.push({ type: 'Doktor', title: d.name, sub: 'Doktor Listesi', icon: 'stethoscope', color: 'text-indigo-600', bg: 'bg-indigo-100', action: () => switchTab('personel') });
});

// 3. CÄ°HAZ & ZÄ°MMET
deviceList.forEach(d => {
if (checkMatch((d.name || '') + " " + (d.tagNo || '') + " " + (d.holder || '') + " " + (d.status || ''))) {
hits.push({ type: 'Cihaz', title: d.name, sub: `${d.tagNo || 'No Yok'} - ${d.holder}`, icon: 'activity', color: 'text-teal-600', bg: 'bg-teal-100', action: () => switchTab('cihazlar') });
}
});

// 4. NÃ–BET LÄ°STESÄ°
shiftList.forEach(s => {
if (checkMatch((s.staff || '') + " " + (s.note || '') + " " + (s.type || ''))) {
const d = new Date(s.date);
hits.push({
type: 'NÃ¶bet', title: s.staff, sub: `${d.toLocaleDateString('tr-TR')} (${s.type})`, icon: 'calendar-clock', color: 'text-purple-600', bg: 'bg-purple-100',
action: () => {
shiftCursorDate = new Date(s.date); // O aya git
switchTab('nobet');
}
});
}
});

// 5. GENEL NOTLAR
generalNotesList.forEach(n => {
if (checkMatch((n.title || '') + " " + (n.content || ''))) {
hits.push({ type: 'Not', title: n.title, sub: n.date, icon: 'sticky-note', color: 'text-yellow-600', bg: 'bg-yellow-100', action: () => { switchTab('notlar'); } });
}
});

// 6. ACÄ°L Ã‡ANTA MALZEMELERÄ°
emergencyList.forEach(i => {
if (checkMatch((i.name || '') + " " + (i.bagName || '') + " " + (i.note || ''))) {
hits.push({
type: 'Acil Ã‡anta', title: i.name, sub: `${i.bagName} (Stok: ${i.count})`, icon: 'briefcase-medical', color: 'text-red-600', bg: 'bg-red-100',
action: () => {
currentBag = i.bagName; // Ã‡antayÄ± seÃ§
if (document.getElementById('bag-selector')) document.getElementById('bag-selector').value = i.bagName;
switchTab('acilcanta');
}
});
}
});

// --- YENÄ° EKLENEN ARAMA KAPSAMLARI ---

// 7. HASTA TAKÄ°P & Ä°ÅLEMLER
if (typeof patientReminders !== 'undefined') {
patientReminders.forEach(r => {
if (checkMatch((r.name || '') + " " + (r.proc || '') + " " + (r.note || ''))) {
hits.push({
type: 'Hasta Ä°ÅŸlemi', title: r.name, sub: `${r.proc} - ${formatDateTR(r.date)}`, icon: 'calendar-plus', color: 'text-indigo-600', bg: 'bg-indigo-50',
action: () => switchTab('hastatakip')
});
}
});
}

// 8. BÃœTÃ‡E HAREKETLERÄ°
if (typeof budgetList !== 'undefined') {
budgetList.forEach(b => {
if (checkMatch((b.desc || '') + " " + (b.note || '') + " " + (b.amount || '') + " " + (b.type === 'income' ? 'Gelir' : 'Gider'))) {
hits.push({
type: 'BÃ¼tÃ§e', title: b.desc, sub: `${b.amount} TL (${b.type === 'income' ? 'Gelir' : 'Gider'})`, icon: 'wallet', color: 'text-green-600', bg: 'bg-green-50',
action: () => {
// O tarihin olduÄŸu aya git
budgetCursorDate = new Date(b.date);
switchTab('butce');
}
});
}
});
}

// 9. RUTÄ°NLER
if (typeof routineList !== 'undefined') {
routineList.forEach(r => {
if (checkMatch(r.text || '')) {
hits.push({ type: 'Rutin', title: r.text, sub: r.completed ? 'TamamlandÄ±' : 'Bekliyor', icon: 'list-todo', color: 'text-gray-600', bg: 'bg-gray-100', action: () => switchTab('rutinler') });
}
});
}

// 10. Ä°ZÄ°NLER
if (typeof leaveRecords !== 'undefined') {
leaveRecords.forEach(l => {
if (checkMatch((l.staffName || '') + " " + (l.type || ''))) {
hits.push({ type: 'Ä°zin/Rapor', title: l.staffName, sub: `${l.type} (${formatDateTR(l.startDate)})`, icon: 'calendar-off', color: 'text-orange-600', bg: 'bg-orange-50', action: () => switchTab('personel') });
}
});
}

// 11. TELEFON REHBERÄ° (EÄŸer eklendiyse)
if (typeof phonebookList !== 'undefined') {
phonebookList.forEach(p => {
if (checkMatch((p.name || '') + " " + (p.role || '') + " " + (p.num || ''))) {
hits.push({ type: 'Rehber', title: p.name, sub: `${p.num} - ${p.role}`, icon: 'phone', color: 'text-green-600', bg: 'bg-green-50', action: () => switchTab('rehber') });
}
});
}

// 12. PANSUMAN HASTALARI
if (typeof pansumanList !== 'undefined') {
pansumanList.forEach(p => {
if (checkMatch((p.patient || '') + " " + (p.address || '') + " " + (p.phone || '') + " " + (p.note || '') + " pansuman")) {
const typeLabels = { dekubit: 'DekÃ¼bit', sutur: 'SÃ¼tÃ¼r', diger: 'DiÄŸer' };
const daysStr = p.days?.map(d => ({ pazartesi: 'Pzt', sali: 'Sal', carsamba: 'Ã‡ar', persembe: 'Per', cuma: 'Cum', cumartesi: 'Cmt', pazar: 'Paz' }[d] || d)).join(', ') || '';
const statusLabel = p.status === 'completed' ? ' (Stop)' : p.status === 'yatisli' ? ' (YatÄ±ÅŸ)' : '';
hits.push({
type: 'Pansuman',
title: p.patient,
sub: `${typeLabels[p.type] || 'DiÄŸer'} - ${daysStr}${statusLabel}`,
icon: 'bandage',
color: 'text-pink-600',
bg: 'bg-pink-50',
action: () => switchTab('pansuman')
});
}
});
}

// 13. TIBBÄ° SEKRETERE NOTLAR
if (typeof window.secretaryNotesList !== 'undefined') {
window.secretaryNotesList.forEach(n => {
if (checkMatch((n.patient || '') + " " + (n.request || '') + " sekreter tÄ±bbi")) {
hits.push({
type: 'Sekreter Notu',
title: n.patient,
sub: n.request?.substring(0, 50) + (n.request?.length > 50 ? '...' : ''),
icon: 'clipboard-pen',
color: 'text-amber-600',
bg: 'bg-amber-50',
action: () => { switchTab('hastatakip'); setTimeout(() => switchPatientSubTab('sekreter'), 100); }
});
}
});
}

// 14. SONDA, Ä°NR, NG HASTALARI
if (typeof sondaInrList !== 'undefined') {
sondaInrList.forEach(p => {
const typeLabels = { erkekSonda: 'Erkek Sonda', kadinSonda: 'KadÄ±n Sonda', inr: 'Ä°NR', ng: 'NG' };
if (checkMatch((p.patient || '') + " " + (p.mahalle || '') + " " + (p.note || '') + " " + (typeLabels[p.type] || '') + " sonda inr ng")) {
const isSonda = p.type === 'erkekSonda' || p.type === 'kadinSonda';
const subText = isSonda
? `${p.catheterType === 'silikon' ? 'Silikon' : 'Lateks'} - ${p.mahalle || ''} - Sonraki: ${p.nextDate ? new Date(p.nextDate).toLocaleDateString('tr-TR') : '-'}`
: `${p.mahalle || ''} - Sonraki: ${p.nextDate ? new Date(p.nextDate).toLocaleDateString('tr-TR') : '-'}`;
hits.push({
type: typeLabels[p.type] || 'Sonda/Ä°NR',
title: p.patient,
sub: subText,
icon: 'activity',
color: 'text-cyan-600',
bg: 'bg-cyan-50',
action: () => switchTab('sondainr')
});
}
});
}

// 15. SOKAK SORGU VERÄ°LERÄ°
if (typeof streetData !== 'undefined' && Array.isArray(streetData)) {
streetData.forEach(s => {
if (checkMatch((s.oldName || '') + " " + (s.newName || '') + " " + (s.context || '') + " sokak cadde")) {
hits.push({
type: 'Sokak',
title: s.newName,
sub: `Eski: ${s.oldName} - ${s.context}`,
icon: 'map-pin',
color: 'text-emerald-600',
bg: 'bg-emerald-50',
action: () => {
switchTab('sokaksorgu');
// Arama kutusuna yaz ve ara
setTimeout(() => {
const searchInput = document.getElementById('street-search-input');
if (searchInput) {
searchInput.value = s.oldName;
if (typeof searchStreets === 'function') searchStreets(s.oldName);
}
}, 200);
}
});
}
});
}

return hits;
}

function renderGlobalSearchResults(results) {
searchResults.innerHTML = '';
if (results.length === 0) {
searchResults.innerHTML = '<div class="p-4 text-sm text-gray-400 text-center italic">EÅŸleÅŸen kayÄ±t bulunamadÄ±.</div>';
searchResults.classList.remove('hidden');
return;
}

// SonuÃ§larÄ± Listele (Maksimum 12 tane gÃ¶sterelim)
results.slice(0, 12).forEach(res => {
const item = document.createElement('div');
item.className = 'flex items-center gap-3 p-3 hover:bg-gray-50 cursor-pointer transition group border-b border-gray-100 last:border-0';
item.innerHTML = `
<div class="${res.bg} ${res.color} p-2 rounded-lg group-hover:scale-110 transition-transform flex-shrink-0"><i data-lucide="${res.icon}" class="w-5 h-5"></i></div>
<div class="flex-1">
<div class="text-sm font-bold text-gray-800">${res.title}</div>
<div class="text-xs text-gray-500 flex items-center gap-1.5">
<span class="font-semibold ${res.color} bg-white border px-1.5 py-0.5 rounded text-[10px] uppercase tracking-wide">${res.type}</span>
<span class="text-gray-400">${res.sub}</span>
</div>
</div>
`;
item.onclick = () => {
const searchText = res.title; // Arama hedefi iÃ§in baÅŸlÄ±k kullan
res.action(); // Ä°lgili sekmeye git
searchResults.classList.add('hidden'); // Listeyi kapat
searchInput.value = ''; // Kutuyu temizle

// Sekme deÄŸiÅŸtikten sonra Ã¶ÄŸeyi bul ve vurgula
if (typeof highlightSearchTarget === 'function') {
highlightSearchTarget(res.tabId || '', searchText, 800);
}
};
searchResults.appendChild(item);
});

// EÄŸer Ã§ok sonuÃ§ varsa altÄ±na not dÃ¼ÅŸ
if (results.length > 12) {
searchResults.insertAdjacentHTML('beforeend', `<div class="p-3 text-center text-xs text-gray-500 font-medium bg-gray-50 sticky bottom-0 border-t">+${results.length - 12} kayÄ±t daha var</div>`);
}

searchResults.classList.remove('hidden');
if (typeof lucide !== 'undefined') lucide.createIcons();
}
// --- GÃœNLÃœK PDF RAPOR MODÃœLÃœ ---
window.generateDailyReport = function () {
// 1. BugÃ¼nÃ¼n Tarihini ve Verilerini HazÄ±rla
const today = new Date();
const dateKey = getLocalDateString(today); // "2025-12-20" formatÄ± (Senin sistemindeki fonksiyon)
const dateDisplay = today.toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

// Ä°statistikler
let totalStaff = staffList.length;
let activeStaff = 0;
let totalPoints = 0;
let onLeave = 0;

// 2. Tablo GÃ¶vdesini OluÅŸtur
// BaÅŸlÄ±k SatÄ±rÄ±
let tableBody = [
[
{ text: 'Personel AdÄ±', style: 'tableHeader', fillColor: '#f3f4f6' },
{ text: 'Sabah GÃ¶revi', style: 'tableHeader', fillColor: '#f3f4f6' },
{ text: 'Ã–ÄŸle GÃ¶revi', style: 'tableHeader', fillColor: '#f3f4f6' },
{ text: 'Durum / Puan', style: 'tableHeader', fillColor: '#f3f4f6' }
]
];

// Personel Listesini DÃ¶n
staffList.forEach(s => {
const r = allRecords[dateKey]?.[s.name]; // O gÃ¼nkÃ¼ kayÄ±t
const leave = leaveRecords.find(l => l.staffName === s.name && dateKey >= l.startDate && dateKey <= l.endDate);

let row = [];

if (leave) {
// Ä°ZÄ°NLÄ° Ä°SE
onLeave++;
const typeText = leave.type === 'Rapor' ? 'RAPORLU' : 'Ä°ZÄ°NLÄ°';
const color = leave.type === 'Rapor' ? '#fee2e2' : '#ffedd5'; // KÄ±rmÄ±zÄ±msÄ± veya Turuncumsu

row = [
{ text: s.name, style: 'cellText' },
{ text: typeText, colSpan: 2, alignment: 'center', style: 'cellText', fillColor: color, color: '#991b1b', bold: true },
{}, // colSpan olduÄŸu iÃ§in boÅŸ
{ text: '-', alignment: 'center', style: 'cellText' }
];
} else if (r) {
// Ã‡ALIÅIYORSA
activeStaff++;

// Puan HesabÄ±
const specCount = r.specialists ? r.specialists.length : 0;
const score = (r.mm || 0) + (r.mk || 0) + (r.am || 0) + (r.ak || 0) + ((r.e || 0) * 2) + specCount;
totalPoints += score;

// Sabah Durumu Metni
let morningText = [];
if (r.mm) morningText.push("Merkez");
if (r.mk) morningText.push("KÃ¶y");
if (morningText.length === 0) morningText.push("-");

// Ã–ÄŸle Durumu Metni
let noonText = [];
if (r.am) noonText.push("Merkez");
if (r.ak) noonText.push("KÃ¶y");
if (noonText.length === 0) noonText.push("-");

// Muayene Varsa Ekle
let statusText = score.toString();
if (r.e > 0) statusText += ` (${r.e} Muayene)`;

row = [
{ text: s.name, style: 'cellText', bold: true },
{ text: morningText.join(' + '), style: 'cellText' },
{ text: noonText.join(' + '), style: 'cellText' },
{ text: statusText, alignment: 'center', style: 'cellText', bold: true, color: score > 0 ? '#166534' : '#000' }
];
} else {
// VERÄ° YOKSA (BOÅ)
row = [
{ text: s.name, style: 'cellText', color: '#9ca3af' },
{ text: '-', alignment: 'center', style: 'cellText', color: '#9ca3af' },
{ text: '-', alignment: 'center', style: 'cellText', color: '#9ca3af' },
{ text: '0', alignment: 'center', style: 'cellText', color: '#9ca3af' }
];
}
tableBody.push(row);
});

// 3. PDF TanÄ±mlamasÄ± (Design)
const docDefinition = {
pageSize: 'A4',
pageMargins: [40, 40, 40, 40],
content: [
// BAÅLIK
{ text: 'EVDE SAÄLIK HÄ°ZMETLERÄ° BÄ°RÄ°MÄ°', style: 'mainHeader', alignment: 'center' },
{ text: 'GÃœNLÃœK FAALÄ°YET VE PERSONEL DURUM RAPORU', style: 'subHeader', alignment: 'center', margin: [0, 5, 0, 20] },

// TARÄ°H VE Ã–ZET KUTUSU
{
style: 'summaryBox',
table: {
widths: ['*', '*', '*', '*'],
body: [[
{ text: `Rapor Tarihi:\n${dateDisplay}`, style: 'summaryItem', fillOpacity: 0.5 },
{ text: `Toplam Personel:\n${totalStaff}`, style: 'summaryItem' },
{ text: `Aktif/Ä°zinli:\n${activeStaff} / ${onLeave}`, style: 'summaryItem' },
{ text: `GÃ¼nlÃ¼k Toplam Puan:\n${totalPoints}`, style: 'summaryItem', bold: true }
]]
},
layout: 'noBorders',
margin: [0, 0, 0, 20]
},

// ANA TABLO
{
table: {
headerRows: 1,
widths: ['35%', '25%', '25%', '15%'],
body: tableBody
},
layout: {
fillColor: function (rowIndex) { return (rowIndex % 2 === 0) ? null : '#f9fafb'; }, // SatÄ±rlarÄ± kÄ±rÃ§Ä±llÄ± yap
hLineWidth: function (i, node) { return (i === 0 || i === node.table.body.length) ? 2 : 1; },
vLineWidth: function (i, node) { return (i === 0 || i === node.table.widths.length) ? 2 : 1; },
hLineColor: function (i) { return (i === 0) ? '#1f2937' : '#e5e7eb'; },
vLineColor: function (i) { return '#e5e7eb'; }
}
},

// Ä°MZA ALANI
{
margin: [0, 40, 0, 0],
columns: [
{
width: '*',
stack: [
{ text: '', alignment: 'center', bold: true, decoration: 'underline' },
{ text: '\n\n..........................................', alignment: 'center', color: '#d1d5db' },
{ text: '', alignment: 'center', fontSize: 8, color: '#6b7280' }
]
},
{
width: '*',
stack: [
{ text: '', alignment: 'center', bold: true, decoration: 'underline' },
{ text: '\n\n..........................................', alignment: 'center', color: '#d1d5db' },
{ text: '', alignment: 'center', fontSize: 8, color: '#6b7280' }
]
}
]
},

// ALT BÄ°LGÄ°
{ text: 'Bu rapor Evde SaÄŸlÄ±k Takip Sistemi tarafÄ±ndan otomatik oluÅŸturulmuÅŸtur.', style: 'footer', alignment: 'center', margin: [0, 30, 0, 0] }
],

// STÄ°LLER
styles: {
mainHeader: { fontSize: 16, bold: true, color: '#111827' },
subHeader: { fontSize: 12, color: '#4b5563', bold: true },
tableHeader: { bold: true, fontSize: 10, color: '#1f2937', margin: [0, 5, 0, 5] },
cellText: { fontSize: 9, color: '#374151', margin: [0, 4, 0, 4] },
summaryItem: { fontSize: 10, alignment: 'center', color: '#374151' },
footer: { fontSize: 8, color: '#9ca3af', italics: true }
}
};

// PDF OLUÅTUR VE Ä°NDÄ°R
pdfMake.createPdf(docDefinition).download(`Gunluk_Rapor_${dateKey}.pdf`);
showToast("GÃ¼nlÃ¼k rapor PDF olarak indiriliyor...");
};
// --- HASTA TAKÄ°P & HATIRLATICI MODÃœLÃœ ---
const LS_PATIENT_REMINDERS = 'evdeSaglikReminders_V1';
window.patientReminders = window.patientReminders || [];

// 1. Verileri YÃ¼kle (ÅÄ°FRE Ã‡Ã–ZME DESTEKLÄ°)
async function loadReminders() {
try {
const stored = JSON.parse(localStorage.getItem(LS_PATIENT_REMINDERS)) || [];
// Åifreli alanlarÄ± Ã§Ã¶z
window.patientReminders = await decryptArray(stored, ENCRYPTED_FIELDS.patientReminders);
} catch { window.patientReminders = []; }
renderPatientReminders();
checkTomorrowAlert(); // Sayfa aÃ§Ä±lÄ±nca kontrol et
}

// --- BURADAN KOPYALA ---

// 1. GLOBAL DEÄÄ°ÅKEN (Hangi kaydÄ± dÃ¼zenlediÄŸimizi tutar)
let editingReminderId = -1;

// 2. GÃœNCELLENMÄ°Å KAYDETME FONKSÄ°YONU (Hem Yeni KayÄ±t Hem DÃ¼zenleme Yapar)
window.addPatientReminder = async () => {
const pName = document.getElementById('rem-patient').value.trim();
const pProc = document.getElementById('rem-proc').value;
const pDate = document.getElementById('rem-date').value;
const pNote = document.getElementById('rem-note').value.trim();

if (!pName || !pDate) return showToast("Hasta adÄ± ve tarih zorunlu!", "error");

if (editingReminderId > -1) {
// --- GÃœNCELLEME MODU ---
// Listede dÃ¼zenlenen kaydÄ± bul
const idx = patientReminders.findIndex(r => r.id === editingReminderId);
if (idx > -1) {
// KullanÄ±cÄ± bilgisini al (takma ad varsa takma ad, yoksa email)
const userEmail = currentUser?.email || 'Bilinmeyen';
const userName = getNickname(userEmail);
// Sadece verileri gÃ¼ncelle, ID ve Status aynÄ± kalsÄ±n
patientReminders[idx].name = pName;
patientReminders[idx].proc = pProc;
patientReminders[idx].date = pDate;
patientReminders[idx].note = pNote;
patientReminders[idx].lastModifiedBy = userName;
patientReminders[idx].lastModifiedAt = new Date().toISOString();

showToast("KayÄ±t gÃ¼ncellendi.");
addActivityLog('reminder', 'Hasta kaydÄ± dÃ¼zenlendi', pName + ' - ' + pProc);
cancelReminderEdit(); // Moddan Ã§Ä±k ve formu temizle
}
} else {
// --- YENÄ° EKLEME MODU ---
// KullanÄ±cÄ± bilgisini al (takma ad varsa takma ad, yoksa email)
const userEmail = currentUser?.email || 'Bilinmeyen';
const userName = getNickname(userEmail);
patientReminders.push({
id: Date.now(),
name: pName,
proc: pProc,
date: pDate,
note: pNote,
status: 'pending', // VarsayÄ±lan durum
createdBy: userName,
createdAt: new Date().toISOString()
});
showToast("Ä°ÅŸlem planlandÄ±.");
addActivityLog('reminder', 'Hasta planlandÄ±', pName + ' - ' + pProc);

// Site iÃ§i bildirim gÃ¶nder
sendInAppNotification('islemplanla', 'ğŸ“… Yeni Ä°ÅŸlem PlanlandÄ±', `${pName} - ${pProc}`);

// Telegram bildirimi gÃ¶nder
const isNotifyEnabled = isTelegramNotifyEnabled('islemplanla');
if (isNotifyEnabled) {
const addedBy = getNickname(currentUser?.email) || 'Bilinmeyen';
const now = new Date().toLocaleString('tr-TR');
const msg = `ğŸ”” <b>Yeni Ä°ÅŸlem PlanlandÄ±</b>\n\nğŸ‘¤ Hasta: ${pName}\nğŸ“‹ Ä°ÅŸlem: ${pProc}\nğŸ“… Tarih: ${formatDateTR(pDate)}${pNote ? '\nğŸ“ Not: ' + pNote : ''}\nğŸ‘¤ Ekleyen: ${addedBy}\nğŸ• Eklenme: ${now}`;
await sendTelegramMessage(msg, 'islemplanla');
}

// Formu temizle
document.getElementById('rem-patient').value = '';
document.getElementById('rem-note').value = '';
}

// Tarihe gÃ¶re sÄ±rala ve kaydet
patientReminders.sort((a, b) => a.date.localeCompare(b.date));

// Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
await saveReminders();
};

// 3. DÃœZENLEMEYÄ° BAÅLATAN FONKSÄ°YON (Listeden 'DÃ¼zenle'ye basÄ±nca Ã§alÄ±ÅŸÄ±r)
window.startEditReminder = (id) => {
const item = patientReminders.find(r => r.id === id);
if (!item) return;

// Formu seÃ§ilen kaydÄ±n bilgileriyle doldur
document.getElementById('rem-patient').value = item.name;
document.getElementById('rem-proc').value = item.proc;
document.getElementById('rem-date').value = item.date;
document.getElementById('rem-note').value = item.note || '';

// Modu aktif et (ID'yi hafÄ±zaya al)
editingReminderId = id;

// ButonlarÄ± deÄŸiÅŸtir (Kaydet -> GÃ¼ncelle yap)
const btnSave = document.getElementById('btn-rem-save');
const btnCancel = document.getElementById('btn-rem-cancel');

btnSave.innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4"></i> <span>GÃ¼ncelle</span>';
btnSave.classList.replace('bg-indigo-600', 'bg-orange-600');
btnSave.classList.replace('hover:bg-indigo-700', 'hover:bg-orange-700');

btnCancel.classList.remove('hidden'); // Ä°ptal butonunu gÃ¶ster

// YukarÄ± kaydÄ±r
document.getElementById('rem-patient').scrollIntoView({ behavior: 'smooth', block: 'center' });
document.getElementById('rem-patient').focus();
lucide.createIcons();
};

// 4. DÃœZENLEMEYÄ° Ä°PTAL EDEN FONKSÄ°YON
window.cancelReminderEdit = () => {
// Formu temizle
document.getElementById('rem-patient').value = '';
document.getElementById('rem-note').value = '';

// Modu kapat
editingReminderId = -1;

// ButonlarÄ± eski haline getir
const btnSave = document.getElementById('btn-rem-save');
const btnCancel = document.getElementById('btn-rem-cancel');

btnSave.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> <span>Kaydet ve Planla</span>';
btnSave.classList.replace('bg-orange-600', 'bg-indigo-600');
btnSave.classList.replace('hover:bg-orange-700', 'hover:bg-indigo-700');

btnCancel.classList.add('hidden'); // Ä°ptal butonunu gizle
lucide.createIcons();
};

// --- BURADA BÄ°TÄ°R ---

// 3. KayÄ±t Sil
window.deleteReminder = async (id) => {
if (confirm("Bu planÄ± silmek istiyor musunuz?")) {
const item = patientReminders.find(r => r.id === id);
const itemInfo = item ? `${item.name} - ${item.proc || 'Ä°ÅŸlem'}` : 'Hasta planÄ±';
patientReminders = patientReminders.filter(r => r.id !== id);
await saveReminders();
showToast("Silindi.");
addActivityLog('reminder', 'Hasta planÄ± silindi', itemInfo);
}
};
// --- YENÄ° EKLENEN FONKSÄ°YON: SON DURUM NOTU GÃœNCELLEME ---
window.updateReminderNote = async (id, value, showMessage = false) => {
// Ä°lgili kaydÄ± bul
const item = patientReminders.find(r => r.id === id);
if (item) {
// KullanÄ±cÄ± bilgisini al
const userEmail = currentUser?.email || 'Bilinmeyen';
const userNickname = window.userNicknames?.[userEmail] || userEmail.split('@')[0];

// Eski not deÄŸerini sakla (bildirim iÃ§in)
const oldNote = item.statusNote || '';
const isNewNote = !oldNote && value;
const isEdit = oldNote && value && oldNote !== value;
const isDelete = oldNote && !value;

// Veriyi gÃ¼ncelle
item.statusNote = value;
item.statusNoteBy = userNickname;
item.statusNoteAt = new Date().toISOString();

// Veriyi KalÄ±cÄ± HafÄ±zaya/Firebase'e Kaydet
if (typeof FirebaseStorage !== 'undefined') {
await FirebaseStorage.setItem(LS_PATIENT_REMINDERS, JSON.stringify(patientReminders));
}

// Kaydet butonuna tÄ±klandÄ±ÄŸÄ±nda mesaj gÃ¶ster ve listeyi yenile
if (showMessage) {
showToast("Not kaydedildi.");
addActivityLog('reminder', 'Not eklendi/gÃ¼ncellendi', `${item.name} - ${value.substring(0, 30)}${value.length > 30 ? '...' : ''}`);

// NOT Bildirimi gÃ¶nder (islemplanla_not tabId ile)
let notifTitle = '';
let notifBody = '';
if (isNewNote) {
notifTitle = 'ğŸ“ Talep Notu Eklendi';
notifBody = `${item.name} - ${value.substring(0, 50)}${value.length > 50 ? '...' : ''}`;
} else if (isEdit) {
notifTitle = 'âœï¸ Talep Notu GÃ¼ncellendi';
notifBody = `${item.name} - ${value.substring(0, 50)}${value.length > 50 ? '...' : ''}`;
} else if (isDelete) {
notifTitle = 'ğŸ—‘ï¸ Talep Notu Silindi';
notifBody = `${item.name} - Not silindi`;
}

if (notifTitle) {
sendInAppNotification('islemplanla_not', notifTitle, notifBody, id);
}

renderPatientReminders();
}
}
};

// 4. Kaydet ve Listele (ÅÄ°FRELEME DESTEKLÄ°)
async function saveReminders() {
// Hassas alanlarÄ± ÅŸifrele ve kaydet
const encryptedReminders = await Promise.all(
patientReminders.map(async (r) => {
return await encryptObject(r, ENCRYPTED_FIELDS.patientReminders);
})
);
await FirebaseStorage.setItem(LS_PATIENT_REMINDERS, JSON.stringify(encryptedReminders));
renderPatientReminders();
checkTomorrowAlert();
}

// --- GÃœNCELLENMÄ°Å HASTA TAKÄ°P LÄ°STELEME VE YÃ–NETÄ°M FONKSÄ°YONLARI ---

// Sekme state'i
window.remActiveTab = 'active';

// Sekme deÄŸiÅŸtirme fonksiyonu
window.switchRemTab = function (tab) {
window.remActiveTab = tab;

// Buton stillerini gÃ¼ncelle
const activeBtn = document.getElementById('rem-tab-active');
const historyBtn = document.getElementById('rem-tab-history');

if (tab === 'active') {
activeBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-indigo-600 text-white transition';
historyBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition';
} else {
activeBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition';
historyBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-indigo-600 text-white transition';
}

renderPatientReminders();
};

// Arama fonksiyonu
window.remSearchTerm = '';
function searchPatientReminders(term) {
window.remSearchTerm = term.toLowerCase();
renderPatientReminders();
}

// 5. Listeyi Ekrana Bas (GÃœNCELLENDÄ°: Butonlar ve Durum YÃ¶netimi Eklendi)
function renderPatientReminders() {
const patientReminders = window.patientReminders || [];
const tbody = document.getElementById('reminder-list-body');
const badge = document.getElementById('rem-count-badge');
if (!tbody) return;

tbody.innerHTML = '';

// BUGÃœNÃœN TARÄ°HÄ° (Saat sÄ±fÄ±rlanmÄ±ÅŸ)
const today = new Date();
today.setHours(0, 0, 0, 0);

// Arama filtresi uygula
const searchTerm = window.remSearchTerm || '';
const currentTab = window.remActiveTab || 'active';
let filteredReminders = patientReminders;

// Sekme filtreleme: Aktif veya GeÃ§miÅŸ
if (currentTab === 'active') {
// Aktif: TamamlanmamÄ±ÅŸ ve iptal edilmemiÅŸ iÅŸlemler
filteredReminders = filteredReminders.filter(r => {
const status = r.status || 'pending';
return status !== 'completed' && status !== 'cancelled';
});
} else {
// GeÃ§miÅŸ: TamamlanmÄ±ÅŸ veya iptal edilmiÅŸ iÅŸlemler
filteredReminders = filteredReminders.filter(r => {
const status = r.status || 'pending';
return status === 'completed' || status === 'cancelled';
});
}

// Arama filtresi uygula
if (searchTerm) {
filteredReminders = filteredReminders.filter(r => {
const patientMatch = r.name && r.name.toLowerCase().includes(searchTerm);
const procMatch = r.proc && r.proc.toLowerCase().includes(searchTerm);
const noteMatch = r.note && r.note.toLowerCase().includes(searchTerm);
return patientMatch || procMatch || noteMatch;
});
}

if (filteredReminders.length === 0) {
let emptyHtml = '';
if (searchTerm) {
emptyHtml = `<tr><td colspan="4" class="p-8 text-center text-gray-400 italic">SonuÃ§ bulunamadÄ±.</td></tr>`;
} else if (currentTab === 'active') {
emptyHtml = `<tr><td colspan="4" class="p-0">
<div class="flex flex-col items-center justify-center text-gray-400 py-12">
<i data-lucide="inbox" class="w-12 h-12 mb-3 opacity-50"></i>
<div class="flex flex-col items-center justify-center text-gray-400 py-8"><svg class="w-12 h-12 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg><p class="text-sm font-medium">HenÃ¼z planlanmÄ±ÅŸ iÅŸlem yok</p>
<p class="text-xs">Yeni iÅŸlem eklemek iÃ§in formu kullanÄ±n</p>
</div>
</td></tr>`;
} else {
emptyHtml = `<tr><td colspan="4" class="p-0">
<div class="flex flex-col items-center justify-center text-gray-400 py-12">
<i data-lucide="archive" class="w-12 h-12 mb-3 opacity-50"></i>
<p class="text-sm font-medium">GeÃ§miÅŸ iÅŸlem bulunamadÄ±</p>
<p class="text-xs">Tamamlanan iÅŸlemler burada gÃ¶rÃ¼necek</p>
</div>
</td></tr>`;
}
tbody.innerHTML = emptyHtml;
if (badge) badge.innerText = filteredReminders.length + " KayÄ±t";
if (typeof lucide !== 'undefined') lucide.createIcons();
return;
}

filteredReminders.forEach(r => {
// --- DÃœZELTME BURADA YAPILDI ---
// Tarihi string'den (YYYY-MM-DD) parÃ§alayarak oluÅŸturuyoruz ki saat farkÄ± olmasÄ±n
const dParts = r.date.split('-'); // ["2025", "12", "21"]
const rDate = new Date(dParts[0], dParts[1] - 1, dParts[2]); // Ay 0'dan baÅŸlar
rDate.setHours(0, 0, 0, 0);

const diffTime = rDate.getTime() - today.getTime();
// Math.ceil yerine Math.round kullanÄ±yoruz, tam gÃ¼n farkÄ±nÄ± bulmak iÃ§in
const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
// -------------------------------

let statusBadge = '';
let rowClass = 'hover:bg-gray-50';
let statusStyle = '';

if (r.status === 'completed') {
statusBadge = `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold border border-green-200 block text-center mt-1">TAMAMLANDI</span>`;
rowClass = 'bg-green-50/60 opacity-75';
statusStyle = 'line-through text-gray-400';
} else if (r.status === 'cancelled') {
statusBadge = `<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-[10px] font-bold border border-red-200 block text-center mt-1">Ä°PTAL EDÄ°LDÄ°</span>`;
rowClass = 'bg-gray-100 text-gray-400';
statusStyle = 'line-through';
} else {
// Ertelendi bilgisi ekle
let postponedInfo = '';
if (r.postponedFrom) {
postponedInfo = `<span class="text-amber-600 font-bold text-[10px] block mt-1">â³ (${formatDateTR(r.postponedFrom)} tarihinden ertelendi)</span>`;
rowClass = 'bg-amber-50';
}

// Sadece ertelendi bilgisi gÃ¶ster, BUGÃœN/YARIN vb. kaldÄ±rÄ±ldÄ±
statusBadge = postponedInfo;

// SatÄ±r rengi ayarla
if (!r.postponedFrom) {
if (diffDays < 0) {
rowClass = 'bg-red-50';
} else if (diffDays === 0) {
rowClass = 'bg-green-50 border-green-200';
} else if (diffDays === 1) {
rowClass = 'bg-orange-50 border-orange-200';
}
}
}

let actionButtons = '';
if (r.status !== 'completed' && r.status !== 'cancelled') {
actionButtons = `
<div class="flex flex-wrap gap-1 justify-end">
<button onclick="startEditReminder(${r.id})" class="p-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg border border-blue-200 transition" title="DÃ¼zenle"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
<button onclick="updateStatus(${r.id}, 'completed')" class="p-2 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg border border-green-200 transition" title="TamamlandÄ±"><i data-lucide="check" class="w-4 h-4"></i></button>
<button onclick="document.getElementById('picker-${r.id}').showPicker()" class="p-2 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-lg border border-orange-200 transition" title="Ertele"><i data-lucide="calendar-clock" class="w-4 h-4"></i></button>
<input type="date" id="picker-${r.id}" class="invisible absolute" style="width:0; height:0; top:0; left:0;" onchange="handlePostpone(${r.id}, this.value)">
<button onclick="updateStatus(${r.id}, 'cancelled')" class="p-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg border border-red-200 transition" title="Ä°ptal"><i data-lucide="x" class="w-4 h-4"></i></button>
</div>
`;
} else {
actionButtons = `
<div class="flex justify-end">
<button onclick="updateStatus(${r.id}, 'pending')" class="text-gray-400 hover:text-indigo-600 text-[10px] underline">Durumu Geri Al</button>
<button onclick="deleteReminder(${r.id})" class="ml-2 text-red-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
</div>
`;
}

tbody.innerHTML += `
<tr class="${rowClass} border-b-2 border-gray-600 transition group">
<td class="px-4 py-3 border-2 border-gray-600 w-32">
<div class="font-bold text-gray-700 text-xs ${statusStyle}">${formatDateTR(r.date)}</div>
<span class="text-[10px] px-2 py-0.5 rounded-full font-bold ${diffDays === 0 ? 'bg-green-100 text-green-700' : diffDays < 0 ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}">${diffDays === 0 ? 'BugÃ¼n' : diffDays === 1 ? 'YarÄ±n' : diffDays === -1 ? 'DÃ¼n' : diffDays > 1 ? diffDays + ' gÃ¼n sonra' : Math.abs(diffDays) + ' gÃ¼n Ã¶nce'}</span>
${statusBadge}
</td>

<td class="px-4 py-3 font-medium text-gray-800 border-2 border-gray-600 w-72 ${statusStyle}">
<div class="flex items-center gap-2">
<span class="truncate font-bold" title="${r.name}">${r.name}</span>
</div>
${r.note && !r.note.includes('tarihinden ertelendi') ? `<div class="text-xs text-gray-700 italic mt-1 border-t border-gray-300 pt-1 whitespace-normal leading-snug">${r.note}</div>` : ''}
<div class="text-[10px] text-gray-400 mt-1">
<i data-lucide="user" class="w-2.5 h-2.5 inline mr-0.5"></i>
Ekl: ${r.createdBy || 'Bilinmiyor'}
</div>
${r.lastModifiedBy ? `
<div class="text-[10px] text-blue-500 mt-0.5">
<i data-lucide="edit-3" class="w-2.5 h-2.5 inline mr-0.5"></i>
Son: ${r.lastModifiedBy} ${r.lastModifiedAt ? 'â€¢ ' + new Date(r.lastModifiedAt).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : ''}
</div>
` : ''}
</td>

<td class="px-4 py-3 border-2 border-gray-600 ${statusStyle}">
<span class="px-2 py-1 bg-white border border-gray-300 rounded text-[10px] font-bold text-gray-600 shadow-sm block w-fit">${r.proc}</span>
</td>
<td class="px-4 py-3 border-2 border-gray-600 bg-white/50 align-middle">
${!r.statusNote ? `
<div class="flex items-center justify-center h-full min-h-[60px]">
<button
onclick="document.getElementById('noteContainer-${r.id}').classList.remove('hidden'); document.getElementById('emptyNote-${r.id}').classList.add('hidden'); document.getElementById('statusNote-${r.id}').focus();"
id="emptyNote-${r.id}"
class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-2 transition shadow-sm border border-indigo-200">
<i data-lucide="plus-circle" class="w-4 h-4"></i> Not Ekle
</button>
<div id="noteContainer-${r.id}" class="hidden w-full">
<div class="flex gap-1 items-start">
<textarea
id="statusNote-${r.id}"
class="flex-1 text-xs p-1.5 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none resize-none bg-white transition hover:border-indigo-300"
rows="2"
placeholder="Durum notu gir..."></textarea>
<button
onclick="updateReminderNote(${r.id}, document.getElementById('statusNote-${r.id}').value, true)"
class="bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1.5 rounded text-[10px] font-bold flex items-center gap-1 transition shadow-sm whitespace-nowrap"
title="Notu kaydet">
<i data-lucide="save" class="w-3 h-3"></i> Kaydet
</button>
</div>
</div>
</div>
` : `
<div class="flex gap-1 items-start">
<textarea
id="statusNote-${r.id}"
class="flex-1 text-xs p-1.5 border border-gray-300 rounded outline-none resize-none bg-gray-50 transition cursor-not-allowed"
rows="2"
readonly
placeholder="Durum notu...">${r.statusNote || ''}</textarea>
<div class="flex flex-col gap-1">
<button
id="saveBtn-${r.id}"
onclick="updateReminderNote(${r.id}, document.getElementById('statusNote-${r.id}').value, true)"
class="hidden bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1.5 rounded text-[10px] font-bold flex items-center gap-1 transition shadow-sm whitespace-nowrap"
title="Notu kaydet">
<i data-lucide="save" class="w-3 h-3"></i> Kaydet
</button>
<button
id="editBtn-${r.id}"
onclick="
const ta = document.getElementById('statusNote-${r.id}');
ta.readOnly = false;
ta.classList.remove('bg-gray-50', 'cursor-not-allowed');
ta.classList.add('bg-white', 'focus:ring-2', 'focus:ring-indigo-500', 'hover:border-indigo-300');
ta.focus();
document.getElementById('saveBtn-${r.id}').classList.remove('hidden');
document.getElementById('editBtn-${r.id}').classList.add('hidden');
"
class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1.5 rounded text-[10px] font-bold flex items-center gap-1 transition shadow-sm whitespace-nowrap"
title="Notu dÃ¼zenle">
<i data-lucide="edit-3" class="w-3 h-3"></i> DÃ¼zenle
</button>
</div>
</div>
<div class="text-[10px] text-gray-500 mt-1.5 flex items-center gap-1 border-t border-gray-200 pt-1">
<i data-lucide="user-check" class="w-3 h-3 text-indigo-500"></i>
<span class="font-medium text-indigo-600">${r.statusNoteBy || 'Bilinmiyor'}</span>
${r.statusNoteAt ? `<span class="text-gray-400">â€¢ ${new Date(r.statusNoteAt).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}</span>` : ''}
</div>
`}
</td>
<td class="px-4 py-3 text-right border-2 border-gray-600 w-48 align-middle">
${actionButtons}
</td>
</tr>
`;
});
if (badge) badge.innerText = `${filteredReminders.length} KayÄ±t`;
if (typeof lucide !== 'undefined') lucide.createIcons();
}

// YENÄ°: Durum GÃ¼ncelleme (TamamlandÄ± / Ä°ptal / Bekliyor)
window.updateStatus = async (id, newStatus) => {
const item = patientReminders.find(r => r.id === id);
if (item) {
const itemInfo = `${item.name} - ${item.proc || 'Ä°ÅŸlem'}`;
item.status = newStatus;
await saveReminders();

let msg = "Durum gÃ¼ncellendi.";
let logAction = 'Durum gÃ¼ncellendi';
if (newStatus === 'completed') { msg = "Ä°ÅŸlem tamamlandÄ± olarak iÅŸaretlendi."; logAction = 'Ä°ÅŸlem tamamlandÄ±'; }
if (newStatus === 'cancelled') { msg = "Ä°ÅŸlem iptal edildi."; logAction = 'Ä°ÅŸlem iptal edildi'; }
if (newStatus === 'pending') { msg = "Durum geri alÄ±ndÄ±."; logAction = 'Durum geri alÄ±ndÄ±'; }
showToast(msg);
addActivityLog('reminder', logAction, itemInfo);
}
};

// YENÄ°: Erteleme Fonksiyonu (Tarih SeÃ§ilince Ã‡alÄ±ÅŸÄ±r)
window.handlePostpone = async (id, newDate) => {
if (!newDate) return;
const item = patientReminders.find(r => r.id === id);
if (item) {
// KullanÄ±cÄ± bilgisini al (takma ad varsa takma ad, yoksa email)
const userEmail = currentUser?.email || 'Bilinmeyen';
const userName = getNickname(userEmail);
const oldDateStr = formatDateTR(item.date);
item.postponedFrom = item.date; // Eski tarihi sakla
item.date = newDate;
item.status = 'pending'; // Durumu tekrar bekliyor yap
item.lastModifiedBy = userName;
item.lastModifiedAt = new Date().toISOString();

// Otomatik not dÃ¼ÅŸelim ki unutulmasÄ±n
const autoNote = `(${oldDateStr} tarihinden ertelendi)`;
if (!item.note.includes('ertelendi')) {
item.note = item.note ? item.note + ' ' + autoNote : autoNote;
}

// Listeyi yeniden tarihe gÃ¶re sÄ±rala
patientReminders.sort((a, b) => a.date.localeCompare(b.date));

await saveReminders();
showToast(`Ä°ÅŸlem ${formatDateTR(newDate)} tarihine ertelendi.`);
addActivityLog('reminder', 'Ä°ÅŸlem ertelendi', `${item.name} - ${formatDateTR(newDate)} tarihine`);
}
};

// 6. YARININ KONTROLÃœ (UYARI SÄ°STEMÄ°)
function checkTomorrowAlert() {
const alertBox = document.getElementById('tomorrow-alert-box');
const alertText = document.getElementById('tomorrow-alert-text');
if (!alertBox) return;

// YarÄ±nÄ±n tarihini bul (String formatÄ±nda: YYYY-MM-DD)
const today = new Date();
const tomorrow = new Date(today);
tomorrow.setDate(tomorrow.getDate() + 1);
const tomorrowStr = getLocalDateString(tomorrow);

// YarÄ±na ait kayÄ±tlarÄ± bul (sadece bekleyen)
const tomorrowTasks = patientReminders.filter(r => r.date === tomorrowStr && r.status !== 'completed' && r.status !== 'cancelled');

if (tomorrowTasks.length > 0) {
// UyarÄ±yÄ± gÃ¶ster
alertBox.classList.remove('hidden');

// MesajÄ± oluÅŸtur
const names = tomorrowTasks.map(t => `<b>${t.name}</b> (${t.proc})`).join(', ');
alertText.innerHTML = `${tomorrowTasks.length} hasta iÃ§in iÅŸlem gÃ¶rÃ¼nÃ¼yor: ${names}`;

// Telegram bildirimi gÃ¶nder (gÃ¼nde bir kez - localStorage ile kontrol)
const lastTelegramDate = localStorage.getItem('lastTomorrowTelegramDate');
const todayStr = getLocalDateString(today);
if (lastTelegramDate !== todayStr && localStorage.getItem('evdeSaglik_TelegramToken') && isTelegramNotifyEnabled('tomorrow')) {
const taskList = tomorrowTasks.map(t => `â€¢ ${t.name} - ${t.proc}`).join('\n');
const now = new Date().toLocaleString('tr-TR');
const msg = `ğŸ“¢ <b>YarÄ±n iÃ§in HatÄ±rlatma</b>\n\n${tomorrowTasks.length} hasta iÅŸlemi planlandÄ±:\n\n${taskList}\n\nğŸ• GÃ¶nderilme: ${now}`;
sendTelegramMessage(msg);
localStorage.setItem('lastTomorrowTelegramDate', todayStr);
}
} else {
// UyarÄ±yÄ± gizle
alertBox.classList.add('hidden');
}
}

function quickAction(type) {
toggleFab(); // Ã–nce menÃ¼yÃ¼ kapat

if (type === 'note') {
switchTab('notlar');
setTimeout(() => {
document.getElementById('gen-note-title').focus();
showToast("Not baÅŸlÄ±ÄŸÄ±na odaklandÄ±");
}, 300);
}
else if (type === 'patient') {
switchTab('hastatakip');
setTimeout(() => {
document.getElementById('rem-patient').focus();
showToast("Hasta adÄ± giriÅŸine odaklandÄ±");
}, 300);
}
else if (type === 'emergency') {
// Ana Ã§antayÄ± seÃ§ip odakla
currentBag = "Ana Ã‡anta";
if (document.getElementById('bag-selector')) document.getElementById('bag-selector').value = currentBag;
switchTab('acilcanta');
setTimeout(() => {
document.getElementById('em-name').focus();
showToast("Malzeme adÄ±na odaklandÄ±");
}, 300);
}
}
// --- GÃ–RSEL TAKVÄ°M MODÃœLÃœ ---
let calendarCursor = new Date();

window.renderCalendar = () => {
const grid = document.getElementById('calendar-grid');
const display = document.getElementById('calendar-month-display');

if (!grid) return;

// Ay ismini yazdÄ±r
const y = calendarCursor.getFullYear();
const m = calendarCursor.getMonth();
display.innerText = `${monthsTR[m]} ${y}`;

grid.innerHTML = '';

// AyÄ±n ilk gÃ¼nÃ¼ ve toplam gÃ¼n sayÄ±sÄ±
const firstDay = new Date(y, m, 1);
const lastDay = new Date(y, m + 1, 0);

// Pazartesi'den baÅŸlamasÄ± iÃ§in index ayarÄ± (Pazar 0 -> 7 olsun)
let startDayIndex = firstDay.getDay();
if (startDayIndex === 0) startDayIndex = 7;

const totalDays = lastDay.getDate();

// 1. BOÅ KUTULAR (AyÄ±n 1'inden Ã¶nceki gÃ¼nler)
for (let i = 1; i < startDayIndex; i++) {
grid.innerHTML += `<div class="bg-gray-200/50 rounded-lg border border-transparent"></div>`;
}

// 2. DOLU GÃœNLER
const todayStr = getLocalDateString(new Date()); // BugÃ¼nÃ¼n tarihi (renklendirme iÃ§in)

for (let d = 1; d <= totalDays; d++) {
// O gÃ¼nÃ¼n tarihi string formatÄ±nda (YYYY-MM-DD)
const currentDateObj = new Date(y, m, d);
// Timezone farkÄ±nÄ± dÃ¼zelt (JS Date objesi bazen saat farkÄ±ndan gÃ¼nÃ¼ kaydÄ±rÄ±r)
const currentStr = new Date(currentDateObj.getTime() - (currentDateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];

// A) Hasta Ä°ÅŸlemlerini Bul
const dayReminders = patientReminders.filter(r => r.date === currentStr);

// B) NÃ¶betÃ§iyi Bul
const dayShifts = shiftList.filter(s => s.date === currentStr);

// TasarÄ±m ayarlarÄ±
const isToday = (currentStr === todayStr);
const boxClass = isToday ? 'bg-indigo-50 border-2 border-indigo-400 shadow-md' : 'bg-white border border-gray-200 hover:border-indigo-300';
const dateColor = isToday ? 'text-indigo-700 bg-indigo-100 px-2 rounded' : 'text-gray-700';

let cellContent = `
<div class="${boxClass} rounded-lg p-2 flex flex-col gap-1 min-h-[100px] transition overflow-hidden group relative">
<div class="flex justify-between items-start">
<span class="text-sm font-bold ${dateColor}">${d}</span>
${dayReminders.length + dayShifts.length > 0 ? `<span class="text-[9px] text-gray-400 font-bold">${dayReminders.length + dayShifts.length} KayÄ±t</span>` : ''}
</div>

<div class="flex-grow flex flex-col gap-1 overflow-y-auto custom-scrollbar max-h-[120px]">
`;

// NÃ¶betÃ§ileri Ekle (Mor Etiket)
dayShifts.forEach(s => {
let badgeColor = "bg-purple-100 text-purple-700 border-purple-200";
if (s.type === 'Ä°cap') badgeColor = "bg-yellow-50 text-yellow-700 border-yellow-200";

cellContent += `
<div class="flex items-center gap-1 px-1.5 py-1 rounded text-[10px] font-bold border ${badgeColor} cursor-pointer hover:opacity-80" onclick="shiftCursorDate=new Date('${s.date}'); switchTab('nobet');" title="NÃ¶betÃ§i: ${s.staff} (${s.type})">
<i data-lucide="moon" class="w-3 h-3"></i>
<span class="truncate">${s.staff.split(' ')[0]}</span>
</div>
`;
});

// Hasta Ä°ÅŸlemlerini Ekle (Mavi Etiket)
dayReminders.forEach(r => {
const statusClass = r.status === 'completed' ? 'opacity-50 line-through' : '';
const itemColor = r.status === 'completed' ? 'bg-green-50 text-green-700 border-green-100' : 'bg-blue-50 text-blue-700 border-blue-100';

cellContent += `
<div class="flex items-center gap-1 px-1.5 py-1 rounded text-[10px] font-bold border ${itemColor} ${statusClass} cursor-pointer hover:opacity-80" onclick="switchTab('hastatakip')" title="${r.name} - ${r.proc}">
<i data-lucide="activity" class="w-3 h-3"></i>
<span class="truncate">${r.name.split(' ')[0]}</span>
</div>
`;
});

cellContent += `</div></div>`; // KapanÄ±ÅŸ
grid.innerHTML += cellContent;
}

lucide.createIcons();
};

window.changeCalendarMonth = (dir) => {
calendarCursor.setMonth(calendarCursor.getMonth() + dir);
renderCalendar();
};
// --- NÃ–BET ADALET ANALÄ°ZÄ° FONKSÄ°YONLARI ---

function openFairnessModal() {
const modal = document.getElementById('fairness-modal');
const startInp = document.getElementById('fair-start');
const endInp = document.getElementById('fair-end');

// VarsayÄ±lan olarak bu yÄ±lÄ± seÃ§
const now = new Date();
const firstDay = new Date(now.getFullYear(), 0, 1); // 1 Ocak
const lastDay = new Date(now.getFullYear(), 11, 31); // 31 AralÄ±k

if (!startInp.value) startInp.value = getLocalDateString(firstDay);
if (!endInp.value) endInp.value = getLocalDateString(lastDay);

modal.classList.remove('hidden');
modal.classList.add('flex');
}

function closeFairnessModal() {
const modal = document.getElementById('fairness-modal');
modal.classList.add('hidden');
modal.classList.remove('flex');
}

// --- NÃ–BET ADALET ANALÄ°ZÄ° (GÃœNCELLENDÄ°: PUAN GÄ°ZLENDÄ°) ---
function calculateFairness() {
const sDate = document.getElementById('fair-start').value;
const eDate = document.getElementById('fair-end').value;
const tbody = document.getElementById('fairness-body');

if (!sDate || !eDate) return showToast("Tarih aralÄ±ÄŸÄ± seÃ§in.", "error");

const filteredShifts = shiftList.filter(s => s.date >= sDate && s.date <= eDate);
const stats = {};

staffList.forEach(p => { stats[p.name] = { total: 0, weekend: 0, weekday: 0, score: 0 }; });

filteredShifts.forEach(s => {
if (!stats[s.staff]) stats[s.staff] = { total: 0, weekend: 0, weekday: 0, score: 0 };

const d = new Date(s.date);
const isWeekend = (d.getDay() === 0 || d.getDay() === 6);

stats[s.staff].total += 1;

if (isWeekend) {
stats[s.staff].weekend += 1;
stats[s.staff].score += 2.5;
} else {
stats[s.staff].weekday += 1;
stats[s.staff].score += 1.0;
}
});

// Yine de puana gÃ¶re sÄ±ralayalÄ±m ki en yorulan en Ã¼stte Ã§Ä±ksÄ±n
const sortedStaff = Object.keys(stats).sort((a, b) => stats[b].score - stats[a].score);

const totalScore = Object.values(stats).reduce((acc, curr) => acc + curr.score, 0);
const avgScore = sortedStaff.length > 0 ? totalScore / sortedStaff.length : 0;

tbody.innerHTML = '';

if (sortedStaff.length === 0) {
tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400">Veri bulunamadÄ±.</td></tr>';
return;
}

sortedStaff.forEach((name, index) => {
const data = stats[name];

// Durum Belirleme
let statusBadge = '';
const diff = data.score - avgScore;

if (data.total === 0) {
statusBadge = '<span class="px-2 py-1 rounded text-[10px] font-bold bg-gray-100 text-gray-500">NÃ–BETSÄ°Z</span>';
} else if (diff > 5) {
statusBadge = '<span class="px-2 py-1 rounded text-[10px] font-bold bg-red-100 text-red-700 flex items-center justify-center gap-1 w-fit mx-auto"><i data-lucide="arrow-up" class="w-3 h-3"></i> YOÄUN</span>';
} else if (diff < -5) {
statusBadge = '<span class="px-2 py-1 rounded text-[10px] font-bold bg-green-100 text-green-700 flex items-center justify-center gap-1 w-fit mx-auto"><i data-lucide="arrow-down" class="w-3 h-3"></i> RAHAT</span>';
} else {
statusBadge = '<span class="px-2 py-1 rounded text-[10px] font-bold bg-blue-50 text-blue-600 flex items-center justify-center w-fit mx-auto">DENGELÄ°</span>';
}

let rankIcon = `<span class="font-bold text-gray-400 text-xs w-6 inline-block text-center">${index + 1}.</span>`;
if (index === 0) rankIcon = 'ğŸ¥‡';
if (index === 1) rankIcon = 'ğŸ¥ˆ';
if (index === 2) rankIcon = 'ğŸ¥‰';

const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';

tbody.innerHTML += `
<tr class="${rowClass} hover:bg-purple-50 transition border-b border-gray-100">
<td class="px-6 py-3 font-bold text-gray-700 flex items-center gap-2 border-r border-gray-100">
${rankIcon} ${name}
</td>
<td class="px-6 py-3 text-center font-bold text-gray-800 border-r border-gray-100">${data.total}</td>
<td class="px-6 py-3 text-center font-bold text-orange-600 bg-orange-50/30 border-r border-gray-100">${data.weekend}</td>
<td class="px-6 py-3 text-center text-blue-600 bg-blue-50/30 border-r border-gray-100">${data.weekday}</td>
<td class="px-6 py-3 text-center">${statusBadge}</td>
</tr>
`;
});
lucide.createIcons();
}
// --- GÃœNCELLENMÄ°Å VE SORUNSUZ YAZDIRMA FONKSÄ°YONU ---
function printFairnessReport() {
// 1. YazdÄ±rma iÃ§in geÃ§ici bir stil oluÅŸturuyoruz
const printStyle = document.createElement('style');
printStyle.innerHTML = `
@media print {
/* Sayfadaki her ÅŸeyi gizle */
body * {
visibility: hidden;
}
/* Sadece ModalÄ± ve iÃ§indekileri gÃ¶ster */
#fairness-modal, #fairness-modal * {
visibility: visible;
}
/* ModalÄ± kaÄŸÄ±da tam oturt */
#fairness-modal {
position: fixed;
left: 0;
top: 0;
width: 100%;
height: 100%;
background: white;
z-index: 9999;
display: block !important;
padding: 20px;
overflow: visible !important;
}
/* Ä°Ã§erik taÅŸmasÄ±nÄ± engelle, tÃ¼m listeyi dÃ¶k */
#fairness-modal .overflow-y-auto {
overflow: visible !important;
height: auto !important;
max-height: none !important;
}
/* Gereksiz butonlarÄ±, filtreleri ve kapat tuÅŸunu gizle */
#fairness-modal button,
#fairness-modal input,
#fairness-modal label,
#fairness-modal .bg-gray-50 { /* Filtre ve alt barÄ± gizler */
display: none !important;
}
/* BaÅŸlÄ±ÄŸÄ± dÃ¼zelt ve gÃ¶ster */
#fairness-modal h3 {
display: block !important;
font-size: 20px;
color: black !important;
margin-bottom: 20px;
border-bottom: 2px solid black;
padding-bottom: 10px;
}
/* Tablo renklerini kaÄŸÄ±t dostu yap */
table {
width: 100% !important;
border-collapse: collapse;
}
th, td {
border: 1px solid #ddd !important;
padding: 8px !important;
color: black !important;
}
thead th {
background-color: #f3f4f6 !important;
-webkit-print-color-adjust: exact;
}
}
`;
document.head.appendChild(printStyle);

// 2. YazdÄ±r
window.print();

// 3. Ä°ÅŸ bitince stili temizle (Hemen silersek yazdÄ±rma diyaloÄŸu bozulabilir, az bekletiyoruz)
setTimeout(() => {
document.head.removeChild(printStyle);
}, 1000);
}
// ============================================================
// --- MANUEL KÄ°LÄ°TLEME SÄ°STEMÄ° (OTOMATÄ°K KÄ°LÄ°T KALDIRILDI) ---
// ============================================================

// Manuel kilitleme iÃ§in yardÄ±mcÄ± fonksiyonlar
function lockSession() {
// Yeni kilit sistemine yÃ¶nlendir (Firebase ÅŸifreli)
if (typeof window.lockSession === 'function') {
window.lockSession();
} else {
}
}

function unlockSession() {
// Yeni kilit sistemine yÃ¶nlendir (Firebase ÅŸifreli)
if (typeof window.unlockScreen === 'function') {
window.unlockScreen();
} else {
}
}

function handleEnterUnlock(e) {
if (e.key === 'Enter') unlockSession();
}

// --- KÄ°LÄ°T EKRANINDAN ÅÄ°FRE DEÄÄ°ÅTÄ°RME ---
window.openPwModalFromLock = function () {
if (typeof openPwModal === 'function') {
openPwModal();
// Pencereyi kilit ekranÄ±nÄ±n (z-999) Ã¼zerine Ã§Ä±karmak iÃ§in z-index'i artÄ±r
const pwModal = document.getElementById('change-pw-modal');
if (pwModal) pwModal.style.zIndex = "1001";
}
};

// --- MANUEL KÄ°LÄ°TLEME KISAYOLU (Ctrl + L) ---
document.addEventListener('keydown', (e) => {
// Ctrl + L tuÅŸlarÄ±na basÄ±ldÄ±ysa
if (e.ctrlKey && (e.key === 'L' || e.key === 'l')) {
// EÄŸer yazÄ± yazÄ±yorsan (input iÃ§indysen) Ã§alÄ±ÅŸma
if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;

e.preventDefault(); // TarayÄ±cÄ± kÄ±sayolunu engelle
lockSession(); // KÄ°LÄ°TLE
showToast("Ekran kilitlendi.");
}
});

// ===============================================
// --- SPOTLIGHT ARAMA SÄ°STEMÄ° (JS KODLARI) ---
// ===============================================

// 1. Arama Penceresini AÃ§
function openSpotlight() {
const modal = document.getElementById('spotlight-modal');
const input = document.getElementById('spotlight-input');

// Kilitliyse aÃ§ma
const lockScreen = document.getElementById('auto-lock-screen');
if (lockScreen && !lockScreen.classList.contains('hidden')) return;

if (modal && input) {
modal.classList.remove('hidden');
modal.classList.add('flex');
input.value = '';
// Ä°mleci odakla
setTimeout(() => input.focus(), 100);
}
}

// 2. Arama Penceresini Kapat
function closeSpotlight(e) {
if (e && e.target.id !== 'spotlight-modal' && e.type === 'click') return;
const modal = document.getElementById('spotlight-modal');
if (modal) {
modal.classList.add('hidden');
modal.classList.remove('flex');
}
}

// 3. Klavye KÄ±sayollarÄ±
function setupKeyboardShortcuts() {
document.addEventListener('keydown', (e) => {
// Input/textarea iÃ§indeyken bazÄ± kÄ±sayollarÄ± engelle
const isTyping = document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA';

// Ctrl+K: KÄ±sayol listesini gÃ¶ster
if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
e.preventDefault();
showKeyboardShortcutsModal();
return;
}

// Ctrl+Space: Spotlight arama aÃ§
if ((e.ctrlKey || e.metaKey) && e.code === 'Space') {
e.preventDefault();
openSpotlight();
return;
}

// Ctrl+D: Hasta Takip > Doktor'a Ä°let sekmesine git ve input'a odaklan
if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'd' && !isTyping) {
e.preventDefault();
// Ã–nce Hasta Takip sekmesine geÃ§
if (typeof switchTab === 'function') switchTab('hastatakip');
// Sonra Doktor'a Ä°let alt sekmesine geÃ§
setTimeout(() => {
if (typeof switchPatientSubTab === 'function') switchPatientSubTab('doktor');
// Input'a odaklan
setTimeout(() => {
const patientInput = document.getElementById('dr-patient');
if (patientInput) patientInput.focus();
}, 100);
}, 150);
showToast('ğŸ“‹ Doktor\'a Ä°let - Veri GiriÅŸi');
return;
}

// Ctrl+S: Hasta Takip > Ä°ÅŸlem Planla sekmesine git ve input'a odaklan
if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's' && !isTyping) {
e.preventDefault();
// Ã–nce Hasta Takip sekmesine geÃ§
if (typeof switchTab === 'function') switchTab('hastatakip');
// Sonra Ä°ÅŸlem Planla alt sekmesine geÃ§ (zaten varsayÄ±lan)
setTimeout(() => {
if (typeof switchPatientSubTab === 'function') switchPatientSubTab('islem');
// Input'a odaklan
setTimeout(() => {
const patientInput = document.getElementById('rem-patient');
if (patientInput) patientInput.focus();
}, 100);
}, 150);
showToast('ğŸ“Œ Ä°ÅŸlem Planla - Veri GiriÅŸi');
return;
}

// Ctrl+A: Anasayfaya git
if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'a' && !isTyping) {
e.preventDefault();
if (typeof switchTab === 'function') switchTab('personel');
showToast('ğŸ  Anasayfa');
return;
}

// ESC TuÅŸu: TÃ¼m aÃ§Ä±k modallarÄ± kapat
if (e.key === 'Escape') {
closeSpotlight();
// AÃ§Ä±k olan diÄŸer pencereleri de kapat
document.querySelectorAll('.fixed').forEach(m => {
if (!m.classList.contains('hidden') && m.id !== 'toast' && m.id !== 'auto-lock-screen' && m.id !== 'chat-toggle-btn' && m.id !== 'chat-panel' && m.id !== 'app') {
m.classList.add('hidden');
m.classList.remove('flex');
}
});
return;
}

// Shift+L: EkranÄ± kilitle
if (e.shiftKey && e.key.toLowerCase() === 'l' && !isTyping) {
e.preventDefault();
if (typeof lockSession === 'function') lockSession();
return;
}
});
}

// KÄ±sayol listesi modalÄ±nÄ± gÃ¶ster
function showKeyboardShortcutsModal() {
// EÄŸer modal yoksa oluÅŸtur
let modal = document.getElementById('keyboard-shortcuts-modal');
if (!modal) {
modal = document.createElement('div');
modal.id = 'keyboard-shortcuts-modal';
modal.className = 'fixed inset-0 bg-black/60 z-[200] flex items-center justify-center p-4 backdrop-blur-sm';
modal.innerHTML = `
<div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md p-6">
<div class="flex justify-between items-center mb-4">
<h3 class="text-lg font-bold text-gray-800 dark:text-white flex items-center gap-2">
âŒ¨ï¸ Klavye KÄ±sayollarÄ±
</h3>
<button onclick="document.getElementById('keyboard-shortcuts-modal').classList.add('hidden')"
class="text-gray-400 hover:text-red-500 text-xl">&times;</button>
</div>
<div class="space-y-2 text-sm">
<div class="flex justify-between py-2 border-b dark:border-gray-700">
<span class="text-gray-600 dark:text-gray-300">KÄ±sayol Listesi</span>
<kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">Ctrl+K</kbd>
</div>
<div class="flex justify-between py-2 border-b dark:border-gray-700">
<span class="text-gray-600 dark:text-gray-300">Spotlight Arama</span>
<kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">Ctrl+Space</kbd>
</div>
<div class="flex justify-between py-2 border-b dark:border-gray-700">
<span class="text-gray-600 dark:text-gray-300">Anasayfa</span>
<kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">Ctrl+A</kbd>
</div>
<div class="flex justify-between py-2 border-b dark:border-gray-700">
<span class="text-gray-600 dark:text-gray-300">Doktor'a Ä°let - Ekle</span>
<kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">Ctrl+D</kbd>
</div>
<div class="flex justify-between py-2 border-b dark:border-gray-700">
<span class="text-gray-600 dark:text-gray-300">Ä°ÅŸlem Planla - Ekle</span>
<kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">Ctrl+S</kbd>
</div>
<div class="flex justify-between py-2 border-b dark:border-gray-700">
<span class="text-gray-600 dark:text-gray-300">EkranÄ± Kilitle</span>
<kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">Ctrl+L</kbd>
</div>
<div class="flex justify-between py-2">
<span class="text-gray-600 dark:text-gray-300">ModallarÄ± Kapat</span>
<kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">ESC</kbd>
</div>
</div>
<div class="mt-4 pt-4 border-t dark:border-gray-700">
<p class="text-xs text-gray-400 text-center">Form iÃ§indeyken Enter ile kaydet</p>
</div>
</div>
`;
document.body.appendChild(modal);
} else {
modal.classList.remove('hidden');
}
}

// ================================================================
// --- ULTIMATE SPOTLIGHT ARAMA MOTORU (TÃœM VERÄ°TABANI) ---
// ================================================================
function handleSpotlightSearch() {
const input = document.getElementById('spotlight-input');
if (!input) return;

// TÃ¼rkÃ§e karakter uyumlu kÃ¼Ã§Ã¼k harfe Ã§evirme
const query = input.value.toLocaleLowerCase('tr').trim();
const resultsDiv = document.getElementById('spotlight-results');

// 2 harften azsa arama yapma
if (query.length < 2) {
resultsDiv.innerHTML = '<div class="p-8 text-center text-gray-400 text-sm flex flex-col items-center"><i data-lucide="keyboard" class="w-8 h-8 mb-2 opacity-20"></i><p>Aramak iÃ§in en az 2 harf yaz...</p></div>';
if (typeof lucide !== 'undefined') lucide.createIcons();
return;
}

let html = '';
let totalCount = 0;

// ---------------------------------------------------------
// 1. HASTA TARAMASI (DeÄŸiÅŸken: patientReminders)
// ---------------------------------------------------------
if (typeof patientReminders !== 'undefined' && Array.isArray(patientReminders)) {
const found = patientReminders.filter(p =>
(p.name && p.name.toLocaleLowerCase('tr').includes(query)) ||
(p.note && p.note.toLocaleLowerCase('tr').includes(query)) ||
(p.proc && p.proc.toLocaleLowerCase('tr').includes(query))
);

if (found.length > 0) {
html += `<div class="sticky top-0 z-10 px-4 py-2 bg-indigo-50 text-[10px] font-bold text-indigo-600 uppercase border-y border-indigo-100 flex justify-between">
<span>HASTA TAKÄ°P LÄ°STESÄ°</span>
<span class="bg-indigo-200 px-1.5 rounded text-indigo-800">${found.length}</span>
</div>`;
found.forEach(p => {
totalCount++;
html += `
<div onclick="goToResult('hastatakip', '${p.name.replace(/'/g, "\\'")}')" class="group flex items-center gap-3 p-3 px-4 hover:bg-indigo-50 cursor-pointer border-b border-gray-50 transition-colors">
<div class="bg-indigo-100 text-indigo-600 w-8 h-8 rounded-lg flex items-center justify-center shrink-0 group-hover:bg-indigo-600 group-hover:text-white transition">
<i data-lucide="user" class="w-4 h-4"></i>
</div>
<div class="min-w-0">
<div class="font-bold text-gray-800 text-sm truncate">${p.name}</div>
<div class="text-xs text-gray-500 truncate">${p.proc || 'Ä°ÅŸlem yok'} â€¢ ${formatDateTR(p.date)}</div>
</div>
</div>`;
});
}
}

// ---------------------------------------------------------
// 2. REHBER TARAMASI (DeÄŸiÅŸken: phonebookList VEYA phoneBook)
// ---------------------------------------------------------
// Ä°ki ihtimali de kontrol ediyoruz, hangisi doluysa onu kullanÄ±r.
let contacts = [];
if (typeof phonebookList !== 'undefined' && Array.isArray(phonebookList)) contacts = phonebookList;
else if (typeof phoneBook !== 'undefined' && Array.isArray(phoneBook)) contacts = phoneBook;

const foundContacts = contacts.filter(c =>
(c.name && c.name.toLocaleLowerCase('tr').includes(query)) ||
(c.num && c.num.includes(query)) ||
(c.title && c.title.toLocaleLowerCase('tr').includes(query))
);

if (foundContacts.length > 0) {
html += `<div class="sticky top-0 z-10 px-4 py-2 bg-green-50 text-[10px] font-bold text-green-600 uppercase border-y border-green-100 flex justify-between">
<span>REHBER & Ä°LETÄ°ÅÄ°M</span>
<span class="bg-green-200 px-1.5 rounded text-green-800">${foundContacts.length}</span>
</div>`;
foundContacts.forEach(c => {
totalCount++;
html += `
<div onclick="goToResult('rehber', '${c.name.replace(/'/g, "\\'")}')" class="group flex items-center gap-3 p-3 px-4 hover:bg-green-50 cursor-pointer border-b border-gray-50 transition-colors">
<div class="bg-green-100 text-green-600 w-8 h-8 rounded-lg flex items-center justify-center shrink-0 group-hover:bg-green-600 group-hover:text-white transition">
<i data-lucide="phone" class="w-4 h-4"></i>
</div>
<div class="min-w-0">
<div class="font-bold text-gray-800 text-sm truncate">${c.name}</div>
<div class="text-xs text-gray-500 truncate">${c.num} â€¢ ${c.title || 'Personel'}</div>
</div>
</div>`;
});
}

// ---------------------------------------------------------
// 3. NÃ–BET TARAMASI (DeÄŸiÅŸken: shiftList)
// ---------------------------------------------------------
if (typeof shiftList !== 'undefined' && Array.isArray(shiftList)) {
const foundShifts = shiftList.filter(s =>
(s.staff && s.staff.toLocaleLowerCase('tr').includes(query)) ||
(s.note && s.note.toLocaleLowerCase('tr').includes(query))
);

if (foundShifts.length > 0) {
html += `<div class="sticky top-0 z-10 px-4 py-2 bg-purple-50 text-[10px] font-bold text-purple-600 uppercase border-y border-purple-100 flex justify-between">
<span>NÃ–BET LÄ°STESÄ°</span>
<span class="bg-purple-200 px-1.5 rounded text-purple-800">${foundShifts.length}</span>
</div>`;
// Listeyi boÄŸmamak iÃ§in ilk 5 sonucu gÃ¶sterelim
foundShifts.slice(0, 5).forEach(s => {
totalCount++;
html += `
<div onclick="goToResult('nobet', null)" class="group flex items-center gap-3 p-3 px-4 hover:bg-purple-50 cursor-pointer border-b border-gray-50 transition-colors">
<div class="bg-purple-100 text-purple-600 w-8 h-8 rounded-lg flex items-center justify-center shrink-0 group-hover:bg-purple-600 group-hover:text-white transition">
<i data-lucide="moon" class="w-4 h-4"></i>
</div>
<div class="min-w-0">
<div class="font-bold text-gray-800 text-sm truncate">${s.staff}</div>
<div class="text-xs text-gray-500 truncate">${formatDateTR(s.date)} â€¢ ${s.type}</div>
</div>
</div>`;
});
}
}

// ---------------------------------------------------------
// 4. BÃœTÃ‡E TARAMASI (DeÄŸiÅŸken: budgetList)
// ---------------------------------------------------------
if (typeof budgetList !== 'undefined' && Array.isArray(budgetList)) {
const foundBudget = budgetList.filter(b =>
(b.desc && b.desc.toLocaleLowerCase('tr').includes(query)) ||
(b.category && b.category.toLocaleLowerCase('tr').includes(query))
);

if (foundBudget.length > 0) {
html += `<div class="sticky top-0 z-10 px-4 py-2 bg-orange-50 text-[10px] font-bold text-orange-600 uppercase border-y border-orange-100 flex justify-between">
<span>BÃœTÃ‡E / MUHASEBE</span>
<span class="bg-orange-200 px-1.5 rounded text-orange-800">${foundBudget.length}</span>
</div>`;
foundBudget.slice(0, 3).forEach(b => {
totalCount++;
const isInc = b.type === 'income';
html += `
<div onclick="goToResult('butce', null)" class="group flex items-center gap-3 p-3 px-4 hover:bg-orange-50 cursor-pointer border-b border-gray-50 transition-colors">
<div class="${isInc ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'} w-8 h-8 rounded-lg flex items-center justify-center shrink-0">
<i data-lucide="${isInc ? 'trending-up' : 'trending-down'}" class="w-4 h-4"></i>
</div>
<div class="min-w-0 flex-1">
<div class="font-bold text-gray-800 text-sm truncate">${b.desc}</div>
<div class="text-xs text-gray-500 truncate">${formatDateTR(b.date)}</div>
</div>
<div class="font-mono font-bold text-sm ${isInc ? 'text-green-600' : 'text-red-600'}">
${b.amount}â‚º
</div>
</div>`;
});
}
}

// ---------------------------------------------------------
// 5. NOTLAR TARAMASI (DeÄŸiÅŸken: generalNotesList)
// ---------------------------------------------------------
if (typeof generalNotesList !== 'undefined' && Array.isArray(generalNotesList)) {
const foundNotes = generalNotesList.filter(n =>
(n.title && n.title.toLocaleLowerCase('tr').includes(query)) ||
(n.content && n.content.toLocaleLowerCase('tr').includes(query))
);

if (foundNotes.length > 0) {
html += `<div class="sticky top-0 z-10 px-4 py-2 bg-yellow-50 text-[10px] font-bold text-yellow-600 uppercase border-y border-yellow-100 flex justify-between">
<span>NOTLAR</span>
<span class="bg-yellow-200 px-1.5 rounded text-yellow-800">${foundNotes.length}</span>
</div>`;
foundNotes.forEach(n => {
totalCount++;
html += `
<div onclick="goToResult('notlar', null)" class="group flex items-center gap-3 p-3 px-4 hover:bg-yellow-50 cursor-pointer border-b border-gray-50 transition-colors">
<div class="bg-yellow-100 text-yellow-600 w-8 h-8 rounded-lg flex items-center justify-center shrink-0 group-hover:bg-yellow-600 group-hover:text-white transition">
<i data-lucide="sticky-note" class="w-4 h-4"></i>
</div>
<div class="min-w-0">
<div class="font-bold text-gray-800 text-sm truncate">${n.title}</div>
<div class="text-xs text-gray-500 truncate line-clamp-1">${n.content.substring(0, 60)}...</div>
</div>
</div>`;
});
}
}

// ---------------------------------------------------------
// SONUÃ‡ YOKSA
// ---------------------------------------------------------
if (totalCount === 0) {
html = `
<div class="flex flex-col items-center justify-center py-12 text-gray-400">
<i data-lucide="search-x" class="w-16 h-16 mb-4 text-gray-200"></i>
<h3 class="font-bold text-gray-500 text-sm">HiÃ§bir ÅŸey bulamadÄ±m patron!</h3>
<p class="text-xs mt-1 text-gray-400">"${input.value}" ile ilgili kayÄ±t yok.</p>
</div>`;
}

resultsDiv.innerHTML = html;
if (typeof lucide !== 'undefined') lucide.createIcons();
}
// --- SEKME AYARLARI YÃ–NETÄ°MÄ° ---

function openTabSettingsModal() {
// 1. GÃ¼venlik: Sekme kilit ÅŸifresini sor
const input = prompt("GÃ¼venlik ayarlarÄ±nÄ± deÄŸiÅŸtirmek iÃ§in sekme kilit ÅŸifrenizi girin:");
if (input === null) return;
if (input !== customTabPassword) return showToast("HatalÄ± ÅŸifre!", "error");

const modal = document.getElementById('tab-settings-modal');
const grid = document.getElementById('tab-selection-grid');
const passInput = document.getElementById('setting-tab-pass');

// Mevcut ÅŸifreyi gÃ¶ster
passInput.value = customTabPassword;
// AÃ§Ä±lÄ±ÅŸ kilidi ayarÄ±nÄ± gÃ¶ster
document.getElementById('setting-startup-lock').checked = startupLockEnabled;

// Sekme listesini oluÅŸtur (id ve gÃ¶rÃ¼nen ad)
const tabs = [
{ id: 'hastatakip', name: 'Hasta Takip' },
{ id: 'personel', name: 'Personel Takip' },
{ id: 'uzman', name: 'Uzman EÅŸleÅŸme' },
{ id: 'analiz', name: 'GeÃ§miÅŸ Analiz' },
{ id: 'rutinler', name: 'GÃ¼nlÃ¼k Rutinler' },
{ id: 'acilcanta', name: 'Acil Ã‡anta' },
{ id: 'butce', name: 'BÃ¼tÃ§e Takip' },
{ id: 'notlar', name: 'Sor. Hem. NotlarÄ±' },
{ id: 'drnotlar', name: 'Dr NotlarÄ±' },
{ id: 'nobet', name: 'NÃ¶bet Listesi' },
{ id: 'cihazlar', name: 'Cihaz & Zimmet' },
{ id: 'istatistik', name: 'Ä°statistikler' },
{ id: 'puantaj', name: 'Puantaj' },
{ id: 'rehber', name: 'Rehber' },
{ id: 'takvim', name: 'Takvim' },
{ id: 'inrhesaplayici', name: 'Ä°NR HesaplayÄ±cÄ±' },
{ id: 'izinrapor', name: 'Ä°zin/Rapor' },
{ id: 'dogumgunu', name: 'DoÄŸum GÃ¼nÃ¼' },
{ id: 'pansuman', name: 'Pansuman' },
{ id: 'sondainr', name: 'Sonda, Ä°NR, NG' },
{ id: 'sokaksorgu', name: 'Sokak Sorgu' }
];

grid.innerHTML = '';
tabs.forEach(tab => {
const isLocked = lockedTabsConfig.includes(tab.id);
grid.innerHTML += `
<label class="flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-orange-50 transition ${isLocked ? 'border-orange-300 bg-orange-50' : 'border-gray-200'}">
<input type="checkbox" onchange="toggleTabLock('${tab.id}')" class="w-4 h-4 text-orange-600 rounded border-gray-300 focus:ring-orange-500" ${isLocked ? 'checked' : ''}>
<span class="text-xs font-bold ${isLocked ? 'text-orange-700' : 'text-gray-600'}">${tab.name}</span>
</label>
`;
});

modal.classList.remove('hidden');
modal.classList.add('flex');
}

async function updateAdminPassword() {
const newVal = document.getElementById('setting-admin-pass').value.trim();
if (newVal.length < 3) return showToast("Åifre en az 3 karakter olmalÄ±!", "error");

adminPanelPassword = newVal;

// KullanÄ±cÄ± bazlÄ± Firebase path'ine kaydet
if (currentUser && currentUser.email) {
const userKey = currentUser.email.replace(/\./g, ',').replace(/@/g, '_at_');
await database.ref(`evde_saglik_ortak_veri/user_settings/${userKey}/adminPassword`).set(newVal);
}
// Eski global path'e de kaydet (geriye uyumluluk)
await FirebaseStorage.setItem(LS_ADMIN_PASS, adminPanelPassword);
showToast("YÃ¶netim ÅŸifresi baÅŸarÄ±yla deÄŸiÅŸtirildi.");
}

async function updateTabPassword() {
const newVal = document.getElementById('setting-tab-pass').value.trim();
if (newVal.length < 3) return showToast("Åifre Ã§ok kÄ±sa!", "error");

customTabPassword = newVal;

// KullanÄ±cÄ± bazlÄ± Firebase path'ine kaydet
if (currentUser && currentUser.email) {
const userKey = currentUser.email.replace(/\./g, ',').replace(/@/g, '_at_');
await database.ref(`evde_saglik_ortak_veri/user_settings/${userKey}/tabLockPassword`).set(newVal);
}
// Eski global path'e de kaydet (geriye uyumluluk)
await FirebaseStorage.setItem(LS_TAB_LOCK_PASS_CUSTOM, customTabPassword);
showToast("Sekme ÅŸifresi gÃ¼ncellendi.");
}

async function toggleTabLock(tabId) {
// Listede varsa Ã§Ä±kar, yoksa ekle
if (lockedTabsConfig.includes(tabId)) {
lockedTabsConfig = lockedTabsConfig.filter(t => t !== tabId);
} else {
lockedTabsConfig.push(tabId);
}

// KullanÄ±cÄ± bazlÄ± Firebase path'ine kaydet
if (currentUser && currentUser.email) {
const userKey = currentUser.email.replace(/\./g, ',').replace(/@/g, '_at_');
await database.ref(`evde_saglik_ortak_veri/user_settings/${userKey}/lockedTabs`).set(lockedTabsConfig);
}

// UI'Ä± anlÄ±k gÃ¼ncelle (gÃ¶rsel efekt iÃ§in)
openTabSettingsModalCheckboxesOnly();
showToast("Ayarlar gÃ¼ncellendi.");
}

// CheckboxlarÄ± yeniden render etmek iÃ§in yardÄ±mcÄ± (ModalÄ± kapatmadan)
function openTabSettingsModalCheckboxesOnly() {
const grid = document.getElementById('tab-selection-grid');
// Sadece classlarÄ± gÃ¼ncellemek daha performanslÄ± olur ama
// basitlik iÃ§in burayÄ± tekrar render etmiyoruz, kullanÄ±cÄ± zaten tÄ±klayÄ±nca gÃ¶rÃ¼yor.
// Ancak gÃ¶rsel renk deÄŸiÅŸimi iÃ§in listeyi yenilemek istersen grid.innerHTML kÄ±smÄ±nÄ± buraya taÅŸÄ±yabiliriz.
// Åimdilik gerek yok, CSS zaten checked durumuna gÃ¶re stil veriyor.
}

// --- YÃ–NETÄ°M ÅÄ°FRESÄ°NÄ° KAYDETME FONKSÄ°YONU BAÅLANGICI ---
async function updateAdminPassword() {
// 1. Kutudaki yeni ÅŸifreyi al
const newVal = document.getElementById('setting-admin-pass').value.trim();

// 2. Kontrol et (Ã‡ok kÄ±sa olmasÄ±n)
if (newVal.length < 3) return showToast("Åifre en az 3 karakter olmalÄ±!", "error");

// 3. DeÄŸiÅŸkeni gÃ¼ncelle
adminPanelPassword = newVal;

// 4. Buluta (Firebase) kaydet
await FirebaseStorage.setItem(LS_ADMIN_PASS, adminPanelPassword);

// 5. Bilgi ver
showToast("YÃ¶netim ÅŸifresi baÅŸarÄ±yla deÄŸiÅŸtirildi.");
}
// --- YÃ–NETÄ°M ÅÄ°FRESÄ°NÄ° KAYDETME FONKSÄ°YONU BÄ°TÄ°ÅÄ° ---
// --- PUANTAJ MODÃœLÃœ ---
let puantajCursorDate = new Date();

// 1. Sekme AÃ§Ä±ldÄ±ÄŸÄ±nda Ã‡alÄ±ÅŸacak Fonksiyon
// (Bunu switchTab fonksiyonuna eklemeyi unutma!)
window.renderPuantaj = function () {
renderPuantajHeader();
renderPuantajTable();
}

window.renderPuantajHeader = function () {
const d = puantajCursorDate;
document.getElementById('puantaj-period-display').innerText = `${monthsTR[d.getMonth()]} ${d.getFullYear()}`;
}

window.changePuantajMonth = function (dir) {
puantajCursorDate.setMonth(puantajCursorDate.getMonth() + dir);
renderPuantajHeader();
renderPuantajTable();
}

// 2025 Resmi Tatiller ve YarÄ±m GÃ¼n Ã‡alÄ±ÅŸma Listesi
const OFFICIAL_HOLIDAYS_2025 = {
'2025-01-01': { hours: 0, name: 'YÄ±lbaÅŸÄ±' },
'2025-03-19': { hours: 4, name: 'Arife (YarÄ±m GÃ¼n)' },
'2025-03-20': { hours: 0, name: 'Ramazan BayramÄ± 1. GÃ¼n' },
'2025-04-23': { hours: 0, name: '23 Nisan' },
'2025-05-01': { hours: 0, name: '1 MayÄ±s' },
'2025-05-19': { hours: 0, name: '19 MayÄ±s' },
'2025-05-26': { hours: 4, name: 'Arife (YarÄ±m GÃ¼n)' },
'2025-05-27': { hours: 0, name: 'Kurban BayramÄ± 1. GÃ¼n' },
'2025-05-28': { hours: 0, name: 'Kurban BayramÄ± 2. GÃ¼n' },
'2025-05-29': { hours: 0, name: 'Kurban BayramÄ± 3. GÃ¼n' },
'2025-07-15': { hours: 0, name: '15 Temmuz' },
'2025-10-28': { hours: 4, name: 'Cumhuriyet BayramÄ± Arife' },
'2025-10-29': { hours: 0, name: '29 Ekim' },
// 2026 Resmi Tatilleri
'2026-01-01': { hours: 0, name: 'YÄ±lbaÅŸÄ±' },
'2026-03-09': { hours: 4, name: 'Arife (YarÄ±m GÃ¼n)' },
'2026-03-10': { hours: 0, name: 'Ramazan BayramÄ± 1. GÃ¼n' },
'2026-03-11': { hours: 0, name: 'Ramazan BayramÄ± 2. GÃ¼n' },
'2026-03-12': { hours: 0, name: 'Ramazan BayramÄ± 3. GÃ¼n' },
'2026-04-23': { hours: 0, name: '23 Nisan' },
'2026-05-01': { hours: 0, name: '1 MayÄ±s' },
'2026-05-16': { hours: 4, name: 'Arife (YarÄ±m GÃ¼n)' },
'2026-05-17': { hours: 0, name: 'Kurban BayramÄ± 1. GÃ¼n' },
'2026-05-18': { hours: 0, name: 'Kurban BayramÄ± 2. GÃ¼n' },
'2026-05-19': { hours: 0, name: '19 MayÄ±s & Kurban BayramÄ± 3. GÃ¼n' },
'2026-05-20': { hours: 0, name: 'Kurban BayramÄ± 4. GÃ¼n' },
'2026-07-15': { hours: 0, name: '15 Temmuz' },
'2026-08-30': { hours: 0, name: '30 AÄŸustos' },
'2026-10-28': { hours: 4, name: 'Cumhuriyet BayramÄ± Arife' },
'2026-10-29': { hours: 0, name: '29 Ekim' }
};

// Puantaj manuel dÃ¼zenlemeleri (Firebase'den yÃ¼klenir)
window.puantajOverrides = {};

// Firebase'den puantaj dÃ¼zenlemelerini yÃ¼kle
async function loadPuantajOverrides() {
if (typeof firebase !== 'undefined' && firebase.database) {
try {
const snapshot = await firebase.database().ref('evde_saglik_ortak_veri/puantaj_overrides').once('value');
window.puantajOverrides = snapshot.val() || {};
} catch (e) {
console.error('Puantaj dÃ¼zenlemeleri yÃ¼klenemedi:', e);
}
}
}

// Firebase'e puantaj dÃ¼zenlemesini kaydet (geniÅŸletilmiÅŸ veri yapÄ±sÄ±)
async function savePuantajOverride(staffName, dateStr, data) {
const key = `${staffName}_${dateStr}`.replace(/\./g, '_').replace(/\s/g, '_');
if (typeof firebase !== 'undefined' && firebase.database) {
try {
if (data === null) {
await firebase.database().ref(`evde_saglik_ortak_veri/puantaj_overrides/${key}`).remove();
delete window.puantajOverrides[key];
} else {
// Geriye uyumluluk: eÄŸer sadece sayÄ± geldiyse eski formata Ã§evir
let saveData;
if (typeof data === 'number') {
saveData = {
staffName,
date: dateStr,
hours: data,
status: 'mesai',
updatedAt: new Date().toISOString(),
updatedBy: currentUser?.email || 'unknown'
};
} else {
saveData = {
staffName,
date: dateStr,
hours: data.hours || 0,
status: data.status || 'mesai',
isOnDuty: data.isOnDuty || false,
updatedAt: new Date().toISOString(),
updatedBy: currentUser?.email || 'unknown'
};
}
await firebase.database().ref(`evde_saglik_ortak_veri/puantaj_overrides/${key}`).set(saveData);
window.puantajOverrides[key] = saveData;
}
} catch (e) {
console.error('Puantaj kaydedilemedi:', e);
}
}
}

// Puantaj dÃ¼zenleme popup state
let puantajEditState = {
staffName: '',
dateStr: '',
status: 'mesai',
hours: 8,
isOnDuty: false
};

// Puantaj popup aÃ§
window.openPuantajEditModal = function (staffName, dateStr, currentData) {
const modal = document.getElementById('puantaj-edit-modal');
if (!modal) return;

// State'i sÄ±fÄ±rla
puantajEditState = {
staffName: staffName,
dateStr: dateStr,
status: 'mesai',
hours: 8,
isOnDuty: false
};

// Mevcut override varsa yÃ¼kle
const overrideKey = `${staffName}_${dateStr}`.replace(/\./g, '_').replace(/\s/g, '_');
const override = window.puantajOverrides[overrideKey];

if (override) {
puantajEditState.status = override.status || 'mesai';
puantajEditState.hours = override.hours !== undefined ? override.hours : 8;
puantajEditState.isOnDuty = override.isOnDuty || false;
} else if (currentData) {
// Mevcut veriden tahmin et
if (currentData === 'R') {
puantajEditState.status = 'rapor';
puantajEditState.hours = 0;
} else if (currentData === 'Ä°') {
puantajEditState.status = 'izin';
puantajEditState.hours = 0;
} else if (!isNaN(parseInt(currentData))) {
puantajEditState.hours = parseInt(currentData);
}
}

// NÃ¶bet listesinden kontrol et
const shift = shiftList.find(sh => sh.staff === staffName && sh.date === dateStr);
if (shift) {
puantajEditState.isOnDuty = true;
}

// Tarih bilgilerini gÃ¶ster
const dateObj = new Date(dateStr);
const dayName = dateObj.toLocaleDateString('tr-TR', { weekday: 'long' });
const formattedDate = dateObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
const holiday = getHolidayInfo(dateStr);

document.getElementById('puantaj-edit-staff').value = staffName;
document.getElementById('puantaj-edit-date').value = dateStr;
document.getElementById('puantaj-edit-staff-display').textContent = staffName;
document.getElementById('puantaj-edit-date-display').textContent = formattedDate;

let dayInfo = dayName;
if (isWeekend) dayInfo += ' (Hafta Sonu)';
if (holiday) dayInfo += ` - ğŸŒ ${holiday.name}`;
document.getElementById('puantaj-edit-day-info').textContent = dayInfo;

// NÃ¶bet bilgisi
const nobetInfo = document.getElementById('puantaj-nobet-info');
if (shift) {
nobetInfo.textContent = `KayÄ±tlÄ±: ${shift.type}`;
} else {
nobetInfo.textContent = '';
}

// Bilgi notunu gÃ¼ncelle
const infoDiv = document.getElementById('puantaj-edit-info');
if (holiday && holiday.hours === 0) {
infoDiv.innerHTML = `ğŸŒ <strong>${holiday.name}</strong> - Tam gÃ¼n resmi tatil. Sadece nÃ¶betÃ§ilere mesai yazÄ±lÄ±r.`;
infoDiv.className = 'text-xs text-amber-700 bg-amber-100 p-2 rounded border border-amber-300';
} else if (holiday && holiday.hours === 4) {
infoDiv.innerHTML = `ğŸŒ <strong>${holiday.name}</strong> - YarÄ±m gÃ¼n Ã§alÄ±ÅŸma (4 saat).`;
infoDiv.className = 'text-xs text-amber-600 bg-amber-50 p-2 rounded border border-amber-200';
} else if (isWeekend) {
infoDiv.innerHTML = 'ğŸ“… Hafta sonu - Sadece nÃ¶betÃ§ilere mesai yazÄ±lÄ±r.';
infoDiv.className = 'text-xs text-purple-600 bg-purple-50 p-2 rounded border border-purple-200';
} else {
infoDiv.innerHTML = 'ğŸ’¡ Normal mesai gÃ¼nÃ¼ - VarsayÄ±lan 8 saat.';
infoDiv.className = 'text-xs text-gray-500 bg-gray-50 p-2 rounded border border-gray-200';
}

// Checkbox'Ä± ayarla
document.getElementById('puantaj-edit-nobet').checked = puantajEditState.isOnDuty;

// ButonlarÄ± gÃ¼ncelle
updatePuantajStatusButtons();
updatePuantajHoursButtons();
updatePuantajHoursVisibility();

// ModalÄ± gÃ¶ster
modal.classList.remove('hidden');
modal.classList.add('flex');

if (typeof lucide !== 'undefined') {
lucide.createIcons();
}
};

// Status seÃ§
window.selectPuantajStatus = function (status) {
puantajEditState.status = status;
if (status === 'rapor' || status === 'izin' || status === 'umke') {
puantajEditState.hours = 0;
} else if (puantajEditState.hours === 0) {
puantajEditState.hours = 8;
}
updatePuantajStatusButtons();
updatePuantajHoursButtons();
updatePuantajHoursVisibility();
};

// Saat seÃ§
window.selectPuantajHours = function (hours) {
puantajEditState.hours = hours;
updatePuantajHoursButtons();
};

// Status butonlarÄ±nÄ± gÃ¼ncelle
function updatePuantajStatusButtons() {
document.querySelectorAll('.puantaj-status-btn').forEach(btn => {
const status = btn.dataset.status;
btn.classList.remove('border-indigo-500', 'bg-indigo-50', 'border-red-500', 'bg-red-50', 'border-orange-500', 'bg-orange-50', 'border-cyan-500', 'bg-cyan-50', 'border-gray-300');

if (status === puantajEditState.status) {
if (status === 'mesai') {
btn.classList.add('border-indigo-500', 'bg-indigo-50');
} else if (status === 'rapor') {
btn.classList.add('border-red-500', 'bg-red-50');
} else if (status === 'izin') {
btn.classList.add('border-orange-500', 'bg-orange-50');
} else if (status === 'umke') {
btn.classList.add('border-cyan-500', 'bg-cyan-50');
}
} else {
btn.classList.add('border-gray-300');
}
});
}

// Saat butonlarÄ±nÄ± gÃ¼ncelle
function updatePuantajHoursButtons() {
document.querySelectorAll('.puantaj-hours-btn').forEach(btn => {
const hours = parseInt(btn.dataset.hours);
btn.classList.remove('border-green-500', 'bg-green-50', 'border-gray-300');

if (hours === puantajEditState.hours) {
btn.classList.add('border-green-500', 'bg-green-50');
} else {
btn.classList.add('border-gray-300');
}
});
}

// Saat seÃ§imi gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ gÃ¼ncelle
function updatePuantajHoursVisibility() {
const hoursSection = document.getElementById('puantaj-hours-section');
if (puantajEditState.status === 'mesai') {
hoursSection.style.display = 'block';
} else {
hoursSection.style.display = 'none';
}
}

// Modal kapat
window.closePuantajEditModal = function () {
const modal = document.getElementById('puantaj-edit-modal');
if (modal) {
modal.classList.add('hidden');
modal.classList.remove('flex');
}
};

// Override'Ä± sÄ±fÄ±rla
window.resetPuantajOverride = function () {
if (confirm('Bu gÃ¼n iÃ§in yapÄ±lan dÃ¼zenleme silinecek, varsayÄ±lan deÄŸerlere dÃ¶nÃ¼lecek. Emin misiniz?')) {
savePuantajOverride(puantajEditState.staffName, puantajEditState.dateStr, null);
renderPuantajTable();
closePuantajEditModal();
showToast('DÃ¼zenleme sÄ±fÄ±rlandÄ±.', 'success');
}
};

// Puantaj kaydet
window.savePuantajEdit = function () {
const isOnDuty = document.getElementById('puantaj-edit-nobet').checked;

const data = {
status: puantajEditState.status,
hours: puantajEditState.status === 'mesai' ? puantajEditState.hours : 0,
isOnDuty: isOnDuty
};

savePuantajOverride(puantajEditState.staffName, puantajEditState.dateStr, data);
renderPuantajTable();
closePuantajEditModal();
showToast('Puantaj gÃ¼ncellendi.', 'success');
};

// Eski fonksiyonu yeni popup'a yÃ¶nlendir
window.editPuantajCell = function (staffName, dateStr, currentValue) {
openPuantajEditModal(staffName, dateStr, currentValue);
};

// Resmi tatil kontrolÃ¼
function getHolidayInfo(dateStr) {
return OFFICIAL_HOLIDAYS_2025[dateStr] || null;
}

window.renderPuantajTable = function () {
const thead = document.getElementById('puantaj-head');
const tbody = document.getElementById('puantaj-body');
if (!thead || !tbody) return;

thead.innerHTML = '';
tbody.innerHTML = '';

const y = puantajCursorDate.getFullYear();
const m = puantajCursorDate.getMonth();

// ÅU ANKÄ° ZAMAN BÄ°LGÄ°LERÄ°
const now = new Date();
// Sadece tarih karÅŸÄ±laÅŸtÄ±rmasÄ± iÃ§in saati sÄ±fÄ±rlanmÄ±ÅŸ "BugÃ¼n"
const todayMid = new Date(now.getFullYear(), now.getMonth(), now.getDate());

const daysInMonth = new Date(y, m + 1, 0).getDate();

// --- BAÅLIK OLUÅTURMA ---
let headerHtml = `<tr>
<th class="px-4 py-3 bg-gray-100 sticky left-0 z-20 border-r border-gray-300 font-bold text-gray-800 shadow-sm min-w-[150px]">Personel</th>`;

for (let d = 1; d <= daysInMonth; d++) {
const dateObj = new Date(y, m, d);
const dateStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
const dayName = dateObj.toLocaleDateString('tr-TR', { weekday: 'short' });
const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
const holiday = getHolidayInfo(dateStr);

let colorClass = isWeekend ? 'text-red-600 bg-red-50' : 'text-gray-600';
let titleAttr = '';
if (holiday) {
colorClass = 'text-amber-700 bg-amber-100';
titleAttr = `title="${holiday.name}"`;
}

headerHtml += `<th class="px-1 py-2 text-center border-r border-gray-200 min-w-[36px] ${colorClass}" ${titleAttr}>
<div class="flex flex-col items-center">
<span class="text-[10px]">${dayName}</span>
<span class="text-sm font-bold">${d}</span>
${holiday ? `<span class="text-[8px]">ğŸŒ</span>` : ''}
</div>
</th>`;
}
headerHtml += `<th class="px-2 py-3 bg-indigo-50 text-indigo-800 text-center font-bold border-l border-indigo-100 text-[10px]">TOPLAM</th>`;
headerHtml += `<th class="px-2 py-3 bg-purple-50 text-purple-800 text-center font-bold border-l border-purple-100 text-[10px]">NÃ–BET</th>`;
headerHtml += `<th class="px-2 py-3 bg-green-50 text-green-800 text-center font-bold sticky right-0 z-10 shadow-sm border-l border-green-100 text-[10px]">MESAÄ°</th></tr>`;
thead.innerHTML = headerHtml;

// --- SATIRLARI OLUÅTURMA ---
staffList.forEach((s, idx) => {
const bgClass = (idx % 2 === 0) ? 'bg-white' : 'bg-gray-50/50';
let rowHtml = `<tr class="${bgClass} hover:bg-indigo-50/30 transition group border-b border-gray-100">
<td class="px-4 py-2 font-bold text-gray-700 sticky left-0 z-10 ${bgClass} border-r border-gray-200 shadow-sm whitespace-nowrap text-xs">${s.name}</td>`;

let totalHours = 0;
let nobetHours = 0;  // Hafta sonu Ã§alÄ±ÅŸÄ±lan gÃ¼nler
let mesaiHours = 0;  // Hafta iÃ§i Ã§alÄ±ÅŸÄ±lan gÃ¼nler

for (let d = 1; d <= daysInMonth; d++) {
const loopDate = new Date(y, m, d);
const dateStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
const isWeekend = (loopDate.getDay() === 0 || loopDate.getDay() === 6);
const holiday = getHolidayInfo(dateStr);

// Manuel override kontrolÃ¼
const overrideKey = `${s.name}_${dateStr}`.replace(/\./g, '_').replace(/\s/g, '_');
const override = window.puantajOverrides[overrideKey];

// ZAMAN KONTROLÃœ (Gelecek mi? BugÃ¼n mÃ¼?)
let isFutureData = false;

if (loopDate > todayMid) {
isFutureData = true;
} else if (loopDate.getTime() === todayMid.getTime()) {
if (now.getHours() < 17) {
isFutureData = true;
}
}

// Verileri Ã‡ek
const leave = leaveRecords.find(l => l.staffName === s.name && dateStr >= l.startDate && dateStr <= l.endDate);
const shift = shiftList.find(sh => sh.staff === s.name && sh.date === dateStr);
const umkeRecord = (typeof umkeRecords !== 'undefined' ? umkeRecords : []).find(u => u.staffName === s.name && dateStr >= u.startDate && dateStr <= u.endDate);

let cellContent = '';
let cellClass = '';
let cellHours = 0;

// EÄER GELECEK TARÄ°HSE -> BOÅ GÃ–STER
if (isFutureData) {
cellContent = '-';
cellClass = 'text-gray-200 bg-gray-50';
}
// Manuel override varsa onu kullan
else if (override !== undefined) {
// Yeni geniÅŸletilmiÅŸ format kontrolÃ¼
if (override.status === 'rapor') {
cellContent = 'R';
cellClass = 'bg-red-100 text-red-700';
} else if (override.status === 'izin') {
cellContent = 'Ä°';
cellClass = 'bg-orange-100 text-orange-700';
} else if (override.status === 'umke') {
cellContent = 'U';
cellClass = 'bg-cyan-100 text-cyan-700';
} else {
// Mesai durumu
cellHours = override.hours !== undefined ? override.hours : 0;
cellContent = cellHours.toString();
cellClass = cellHours === 0 ? 'bg-gray-100 text-gray-500' :
cellHours === 4 ? 'bg-amber-100 text-amber-700' : 'bg-green-50 text-green-700';

// NÃ¶betÃ§i ise mor renk
if (override.isOnDuty) {
cellClass = 'bg-purple-100 text-purple-700 ring-1 ring-purple-200';
}

totalHours += cellHours;
if (isWeekend || (holiday && holiday.hours === 0) || override.isOnDuty) {
nobetHours += cellHours;
} else {
mesaiHours += cellHours;
}
}
}
// UMKE gÃ¶revi varsa (umkeRecords dizisinden)
else if (umkeRecord) {
cellContent = 'U';
cellClass = 'bg-cyan-100 text-cyan-700';
}
// Ä°zin/Rapor varsa
else if (leave) {
if (leave.type === 'Rapor') {
cellContent = 'R'; cellClass = 'bg-red-100 text-red-700';
} else {
cellContent = 'Ä°'; cellClass = 'bg-orange-100 text-orange-700';
}
}
// Resmi tatil kontrolÃ¼ (TAM GÃœN - hours: 0)
else if (holiday && holiday.hours === 0) {
// Tam gÃ¼n resmi tatil - sadece nÃ¶betÃ§ilere mesai yazÄ±lÄ±r
if (shift) {
cellHours = 8;
cellContent = '8';
cellClass = 'bg-purple-100 text-purple-700 ring-1 ring-purple-200';
totalHours += cellHours;
nobetHours += cellHours;
} else {
// NÃ¶betÃ§i deÄŸilse tatil
cellContent = 'ğŸŒ';
cellClass = 'bg-amber-100 text-amber-700';
}
}
// Resmi tatil kontrolÃ¼ (YARIM GÃœN - hours: 4)
else if (holiday && holiday.hours > 0) {
// YarÄ±m gÃ¼n - herkese yarÄ±m mesai
cellHours = holiday.hours;
cellContent = cellHours.toString();
cellClass = 'bg-amber-50 text-amber-600';
totalHours += cellHours;
mesaiHours += cellHours;
}
// Normal gÃ¼n
else {
if (!isWeekend) {
cellHours = 8;
cellContent = '8'; cellClass = 'bg-green-50 text-green-700';
totalHours += 8;
mesaiHours += 8;
} else {
if (shift) {
cellHours = 8;
cellContent = '8'; cellClass = 'bg-purple-100 text-purple-700 ring-1 ring-purple-200';
totalHours += 8;
nobetHours += 8;
} else {
cellContent = '-'; cellClass = 'text-gray-300 bg-gray-50';
}
}
}

// HÃ¼creyi tÄ±klanabilir yap (gelecek deÄŸilse)
const clickHandler = !isFutureData ? `onclick="editPuantajCell('${s.name.replace(/'/g, "\\'")}', '${dateStr}', '${cellContent}')"` : '';
const cursorClass = !isFutureData ? 'cursor-pointer hover:ring-2 hover:ring-indigo-400' : '';

rowHtml += `<td class="px-1 py-1 text-center border-r border-gray-100">
<div ${clickHandler} class="w-full h-8 flex items-center justify-center rounded text-xs ${cellClass} ${cursorClass}" title="${holiday ? holiday.name : 'DÃ¼zenlemek iÃ§in tÄ±kla'}">
${cellContent}
</div>
</td>`;
}

rowHtml += `<td class="px-2 py-2 text-center font-bold text-indigo-700 bg-indigo-50 border-l border-indigo-100">${totalHours}</td>`;
rowHtml += `<td class="px-2 py-2 text-center font-bold text-purple-700 bg-purple-50 border-l border-purple-100">${nobetHours}</td>`;
rowHtml += `<td class="px-2 py-2 text-center font-bold text-green-700 bg-green-50 sticky right-0 z-10 border-l border-green-100">${mesaiHours}</td></tr>`;
tbody.insertAdjacentHTML('beforeend', rowHtml);
});
}

// Excel Ä°ndirme (Puantaj iÃ§in Ã¶zel)
window.downloadPuantajExcel = function () {
const wb = XLSX.utils.book_new();
const ws_data = [];
const d = puantajCursorDate;

// ÅU ANKÄ° ZAMAN BÄ°LGÄ°LERÄ°
const now = new Date();
const todayMid = new Date(now.getFullYear(), now.getMonth(), now.getDate());

// BaÅŸlÄ±k
const header = ["Personel"];
const daysInMonth = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
for (let i = 1; i <= daysInMonth; i++) header.push(i.toString());
header.push("TOPLAM");
header.push("NÃ–BET");
header.push("MESAÄ°");
ws_data.push(header);

staffList.forEach(s => {
let row = [s.name];
let total = 0;
let nobetTotal = 0;
let mesaiTotal = 0;

for (let i = 1; i <= daysInMonth; i++) {
const loopDate = new Date(d.getFullYear(), d.getMonth(), i);
const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
const isWeekend = (loopDate.getDay() === 0 || loopDate.getDay() === 6);
const holiday = getHolidayInfo(dateStr);

// ZAMAN KONTROLÃœ
let isFutureData = false;
if (loopDate > todayMid) isFutureData = true;
else if (loopDate.getTime() === todayMid.getTime() && now.getHours() < 17) isFutureData = true;

// Override kontrolÃ¼
const overrideKey = `${s.name}_${dateStr}`.replace(/\./g, '_').replace(/\s/g, '_');
const override = window.puantajOverrides[overrideKey];

const leave = leaveRecords.find(l => l.staffName === s.name && dateStr >= l.startDate && dateStr <= l.endDate);
const shift = shiftList.find(sh => sh.staff === s.name && sh.date === dateStr);
const umkeRecord = (typeof umkeRecords !== 'undefined' ? umkeRecords : []).find(u => u.staffName === s.name && dateStr >= u.startDate && dateStr <= u.endDate);

if (isFutureData) {
row.push('');
} else if (override) {
if (override.status === 'rapor') {
row.push('R');
} else if (override.status === 'izin') {
row.push('Ä°');
} else if (override.status === 'umke') {
row.push('U');
} else {
const hours = override.hours || 0;
row.push(hours);
total += hours;
if (isWeekend || (holiday && holiday.hours === 0) || override.isOnDuty) {
nobetTotal += hours;
} else {
mesaiTotal += hours;
}
}
} else if (umkeRecord) {
row.push('U');
} else if (leave) {
row.push(leave.type === 'Rapor' ? 'R' : 'Ä°');
} else if (holiday && holiday.hours === 0) {
// Tam gÃ¼n resmi tatil
if (shift) {
row.push(8); total += 8; nobetTotal += 8;
} else {
row.push('TATÄ°L');
}
} else if (holiday && holiday.hours > 0) {
// YarÄ±m gÃ¼n
row.push(holiday.hours);
total += holiday.hours;
mesaiTotal += holiday.hours;
} else if (!isWeekend) {
row.push(8); total += 8; mesaiTotal += 8;
} else {
if (shift) {
row.push(8); total += 8; nobetTotal += 8;
} else {
row.push('');
}
}
}
row.push(total);
row.push(nobetTotal);
row.push(mesaiTotal);
ws_data.push(row);
});

const ws = XLSX.utils.aoa_to_sheet(ws_data);
XLSX.utils.book_append_sheet(wb, ws, "Puantaj");
XLSX.writeFile(wb, `Puantaj_${monthsTR[d.getMonth()]}_${d.getFullYear()}.xlsx`);
}
</script>
<div id="auto-lock-screen"
class="hidden fixed inset-0 bg-gray-900/95 z-[999] hidden flex-col items-center justify-center text-center backdrop-blur-sm transition-opacity duration-500">
<div class="bg-white/10 p-6 rounded-full mb-6 border-4 border-white/20 animate-pulse">
<i data-lucide="lock" class="w-12 h-12 text-white"></i>
</div>

<h2 class="text-2xl font-bold text-white mb-2 tracking-tight">Oturum Kilitlendi</h2>
<p class="text-gray-400 mb-6 text-sm">Devam etmek iÃ§in ana parolayÄ± giriniz.</p>

<div class="flex flex-col gap-3 w-full max-w-[280px]">
<input type="password" id="session-pass-input" placeholder="Parola"
class="p-3 rounded-xl text-gray-800 text-center text-lg font-bold tracking-widest outline-none border-4 border-white/10 focus:border-indigo-500 transition shadow-xl"
onkeypress="handleEnterUnlock(event)">

<button onclick="unlockSession()"
class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2">
<i data-lucide="key" class="w-4 h-4"></i> Kilidi AÃ§
</button>
</div>

<button onclick="openPwModalFromLock()"
class="mt-4 text-xs text-gray-400 hover:text-white underline transition flex items-center justify-center gap-1 w-full">
<i data-lucide="refresh-cw" class="w-3 h-3"></i> Åifre DeÄŸiÅŸtir
</button>
</div>

<p class="mt-8 text-[10px] text-gray-600 opacity-50">GÃ¼venlik Modu Aktif</p>
</div>
<div id="spotlight-modal"
class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-[2000] hidden items-start justify-center pt-[10vh]"
onclick="closeSpotlight(event)">
<div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden transform transition-all scale-100 ring-1 ring-gray-900/5"
onclick="event.stopPropagation()">

<div class="relative border-b border-gray-100">
<div class="absolute left-4 top-4 text-indigo-500">
<i data-lucide="search" class="w-6 h-6"></i>
</div>
<input type="text" id="spotlight-input"
class="w-full py-4 pl-12 pr-12 text-lg text-gray-800 outline-none placeholder-gray-400 bg-transparent font-medium"
placeholder="Ne aramak istiyorsun? (Hasta, NÃ¶bet, BÃ¼tÃ§e...)" oninput="handleSpotlightSearch()"
autocomplete="off">
<button onclick="closeSpotlight()"
class="absolute right-4 top-4 text-xs font-bold text-gray-400 border border-gray-200 rounded px-2 py-1 hover:bg-gray-50 transition">ESC</button>
</div>

<div id="spotlight-results" class="max-h-[60vh] overflow-y-auto custom-scrollbar bg-gray-50/30">
<div class="p-10 text-center text-gray-400 text-sm flex flex-col items-center">
<i data-lucide="command" class="w-8 h-8 mb-2 opacity-20"></i>
<p>Aramaya baÅŸlamak iÃ§in yazÄ±n...</p>
</div>
</div>

<div class="bg-gray-50 px-4 py-2 text-[10px] text-gray-400 flex justify-between border-t border-gray-100">
<span class="flex items-center gap-1"><i data-lucide="corner-down-left" class="w-3 h-3"></i>
<b>Enter</b> seÃ§</span>
<span class="flex items-center gap-1"><i data-lucide="move-vertical" class="w-3 h-3"></i> <b>YÃ¶n
TuÅŸlarÄ±</b> gezin</span>
</div>
</div>
</div>
<script>
// MENÃœ SÃœRÃœKLEME Ã–ZELLÄ°ÄÄ° (DRAG TO SCROLL)
const menu = document.getElementById('ust-menu');
let isDown = false;
let startX;
let scrollLeft;

menu.addEventListener('mousedown', (e) => {
isDown = true;
menu.classList.add('cursor-grabbing'); // Tutma ikonu
menu.classList.remove('cursor-grab');
startX = e.pageX - menu.offsetLeft;
scrollLeft = menu.scrollLeft;
});

menu.addEventListener('mouseleave', () => {
isDown = false;
menu.classList.remove('cursor-grabbing');
menu.classList.add('cursor-grab');
});

menu.addEventListener('mouseup', () => {
isDown = false;
menu.classList.remove('cursor-grabbing');
menu.classList.add('cursor-grab');
});

menu.addEventListener('mousemove', (e) => {
if (!isDown) return;
e.preventDefault();
const x = e.pageX - menu.offsetLeft;
const walk = (x - startX) * 2; // KaydÄ±rma hÄ±zÄ± (2x idealdir)
menu.scrollLeft = scrollLeft - walk;
});
async function forceSyncData() {
if (!currentUser || !userDataPath) {
showToast("Ã–nce giriÅŸ yapmalÄ±sÄ±nÄ±z.", "error");
return;
}

const syncIcon = document.getElementById('sync-icon');
if (syncIcon) syncIcon.classList.add('animate-spin'); // DÃ¶nme animasyonu ekle
showToast("Veriler buluttan Ã§ekiliyor...", "info");

// Ã‡ekilecek tÃ¼m veri anahtarlarÄ±
const keys = [
'evdeSaglikShifts_V19', 'evdeSaglikDevices_V1', 'evdeSaglikData_ULTIMATE_V18',
'evdeSaglikStaff_ULTIMATE_V18', 'evdeSaglikNotes_ULTIMATE_V18', 'evdeSaglikApiKey_V18',
'evdeSaglikDoctors_V18', 'evdeSaglikDocData_V18', 'evdeSaglikProcs_V18',
'evdeSaglikAppPW_Enc_V1', 'evdeSaglikSpecList_V18', 'evdeSaglikQuickList_V18',
'evdeSaglikLeaveRec_V18', 'evdeSaglikTeams_V19', 'evdeSaglikRoutines_V19',
'evdeSaglikBudget_V19', 'evdeSaglikEmergency_V19', 'evdeSaglikBags_V19',
'evdeSaglikGenNotesList_V1', 'evdeSaglikPhonebook_V1', 'evdeSaglikReminders_V1',
'evdeSaglikLockedTabsConfig_V1', 'evdeSaglikTabLockPassCustom_V1',
'evdeSaglikStartupLock_V1', 'evdeSaglikAdminPass_V1'
];

try {
// TÃ¼m verileri paralel olarak Ã§ek (Daha hÄ±zlÄ±)
const promises = keys.map(key => database.ref(`${userDataPath}/${key}`).once('value'));
const snapshots = await Promise.all(promises);

// Ã–nbelleÄŸi ve Yerel HafÄ±zayÄ± GÃ¼ncelle
if (!window._firebaseCache) window._firebaseCache = {};

snapshots.forEach((snap, index) => {
const key = keys[index];
const val = snap.val();

// 1. RAM Cache GÃ¼ncelle
window._firebaseCache[key] = val;

// 2. LocalStorage GÃ¼ncelle (KalÄ±cÄ±lÄ±k iÃ§in)
if (val !== null) {
const storeVal = (typeof val === 'object') ? JSON.stringify(val) : val;
originalLocalStorage.setItem(key, storeVal);
} else {
originalLocalStorage.removeItem(key);
}
});

// 3. Global DeÄŸiÅŸkenleri Yeniden YÃ¼kle
loadAll();

// 4. TÃ¼m ArayÃ¼zÃ¼ Yenile
renderUI();
renderShiftTable();
renderDeviceTable();
if (typeof renderBudgetHeader === 'function') renderBudgetHeader();
renderPhonebook();
renderPatientReminders();
if (typeof renderRoutines === 'function') renderRoutines();
renderBagSelector();
renderEmergency();
renderGeneralNotes();

showToast("TÃ¼m veriler baÅŸarÄ±yla gÃ¼ncellendi!");

} catch (error) {
console.error("Sync HatasÄ±:", error);
showToast("Senkronizasyon sÄ±rasÄ±nda hata oluÅŸtu!", "error");
} finally {
if (syncIcon) syncIcon.classList.remove('animate-spin'); // Animasyonu durdur
}
}
// ================================================================
// OTOMATÄ°K ARKA PLAN SENKRONÄ°ZASYON SÄ°STEMÄ°
// ================================================================

// Takip edilecek veriler ve veritabanÄ± yollarÄ±
const SYNC_KEYS = [
'evdeSaglikShifts_V19', 'evdeSaglikDevices_V1', 'evdeSaglikData_ULTIMATE_V18',
'evdeSaglikStaff_ULTIMATE_V18', 'evdeSaglikNotes_ULTIMATE_V18',
'evdeSaglikDoctors_V18', 'evdeSaglikDocData_V18', 'evdeSaglikProcs_V18',
'evdeSaglikSpecList_V18', 'evdeSaglikQuickList_V18', 'evdeSaglikLeaveRec_V18',
'evdeSaglikTeams_V19', 'evdeSaglikRoutines_V19', 'evdeSaglikBudget_V19',
'evdeSaglikEmergency_V19', 'evdeSaglikBags_V19', 'evdeSaglikGenNotesList_V1',
'evdeSaglikPhonebook_V1', 'evdeSaglikReminders_V1', 'evdeSaglikApiKey_V18',
'evdeSaglikAppPW_Enc_V1', 'evdeSaglikLockedTabsConfig_V1', 'evdeSaglikDoctorLeaves_V1'
];

// Bu fonksiyonu auth.onAuthStateChanged iÃ§inde "GiriÅŸ BaÅŸarÄ±lÄ±" kÄ±smÄ±na ekle
function startRealtimeListeners() {

SYNC_KEYS.forEach(key => {
// Ã‡akÄ±ÅŸma olmamasÄ± iÃ§in Ã¶nce eski dinleyiciyi kapat
try { database.ref(`${userDataPath}/${key}`).off(); } catch (e) { }

// CanlÄ± dinleyiciyi (listener) aÃ§ - ASYNC ÅŸifre Ã§Ã¶zme destekli
database.ref(`${userDataPath}/${key}`).on('value', async (snapshot) => {
const value = snapshot.val();

// 1. Veriyi Cache ve LocalStorage'a kaydet
updateLocalData(key, value);

// 2. Ä°lgili Global DeÄŸiÅŸkeni GÃ¼ncelle (AWAIT - ÅŸifre Ã§Ã¶zme iÃ§in)
await updateGlobalVariable(key, value);

// 3. Sadece Ä°lgili EkranÄ± Yenile (Performans iÃ§in akÄ±llÄ± yÃ¶nlendirme)
triggerSpecificRender(key);
});
});

// ===== ENGELLÄ° KULLANICI CANLI DÄ°NLEME =====
// KullanÄ±cÄ± engellendiÄŸinde anÄ±nda oturum kapatÄ±lÄ±r
if (currentUser && currentUser.email) {
const emailKey = currentUser.email.replace(/\./g, ',').replace(/@/g, '_at_');
let isFirstCheck = true; // Ä°lk kontrol flag'i

database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}/blocked`).on('value', async (snapshot) => {
const isBlocked = snapshot.val() === true;

// Ä°lk yÃ¼klemede kontrol etme (zaten giriÅŸ kontrolÃ¼nde yapÄ±ldÄ±)
if (isFirstCheck) {
isFirstCheck = false;
return;
}

if (isBlocked) {

// Ã–nce tÃ¼m listener'larÄ± kapat
database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}/blocked`).off();
SYNC_KEYS.forEach(key => {
try { database.ref(`${userDataPath}/${key}`).off(); } catch (e) { }
});

// Oturumu kapat
await auth.signOut();

// UI'Ä± hemen giriÅŸ ekranÄ±na dÃ¶ndÃ¼r
const authContainer = document.getElementById('auth-container');
const appContainer = document.getElementById('app');

if (appContainer) appContainer.style.display = 'none';
if (authContainer) authContainer.style.display = 'flex';

// UyarÄ± mesajÄ± gÃ¶ster
if (typeof showToast === 'function') {
showToast('ğŸš« HesabÄ±nÄ±z engellenmiÅŸtir! Oturumunuz kapatÄ±ldÄ±.', 'error');
}

// GiriÅŸ ekranÄ±nda da mesaj gÃ¶ster
const authMsg = document.getElementById('auth-message');
if (authMsg) {
authMsg.className = 'mt-2 text-sm text-red-600 font-bold bg-red-100 p-3 rounded-lg';
authMsg.innerHTML = 'ğŸš« HesabÄ±nÄ±z engellenmiÅŸtir. YÃ¶netici ile iletiÅŸime geÃ§in.';
authMsg.classList.remove('hidden');
}

// currentUser'Ä± temizle
currentUser = null;
}
});
}
// ===== ENGELLÄ° KULLANICI CANLI DÄ°NLEME BÄ°TTÄ° =====
}

// Veriyi hafÄ±zaya yazar
function updateLocalData(key, value) {
if (!window._firebaseCache) window._firebaseCache = {};
window._firebaseCache[key] = value;

if (value !== null) {
const storeVal = (typeof value === 'object') ? JSON.stringify(value) : value;
originalLocalStorage.setItem(key, storeVal);
} else {
originalLocalStorage.removeItem(key);
}
}

// Hangi veri geldiyse, sadece onunla ilgili fonksiyonu Ã§alÄ±ÅŸtÄ±rÄ±r
function triggerSpecificRender(key) {
// Sayfa ilk yÃ¼klenirken (initial load) gereksiz render yapmasÄ±n diye kontrol eklenebilir
// Ancak veri bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ iÃ§in her deÄŸiÅŸikliÄŸi yansÄ±tÄ±yoruz.

//console.log(`ğŸ”„ Veri DeÄŸiÅŸti: ${key}`); // Test iÃ§in aÃ§abilirsin

switch (key) {
// NÃ¶bet Listesi
case 'evdeSaglikShifts_V19':
if (typeof renderShiftTable === 'function') renderShiftTable();
break;

// Cihazlar
case 'evdeSaglikDevices_V1':
if (typeof renderDeviceTable === 'function') renderDeviceTable();
break;

// BÃ¼tÃ§e
case 'evdeSaglikBudget_V19':
if (typeof renderBudgetHeader === 'function') renderBudgetHeader();
else if (typeof renderBudget === 'function') renderBudget();
break;

// Rehber
case 'evdeSaglikPhonebook_V1':
if (typeof renderPhonebook === 'function') renderPhonebook();
break;

// Hasta HatÄ±rlatmalarÄ±
case 'evdeSaglikReminders_V1':
if (typeof renderPatientReminders === 'function') renderPatientReminders();
break;

// Rutinler
case 'evdeSaglikRoutines_V19':
if (typeof renderRoutines === 'function') renderRoutines();
break;

// Acil Durum & Ã‡antalar
case 'evdeSaglikEmergency_V19':
case 'evdeSaglikBags_V19':
if (typeof renderBagSelector === 'function') renderBagSelector();
if (typeof renderEmergency === 'function') renderEmergency();
break;

// Genel Notlar
case 'evdeSaglikGenNotesList_V1':
if (typeof renderGeneralNotes === 'function') renderGeneralNotes();
break;

// Ana Veriler (Personel, Hasta Listesi vb.) deÄŸiÅŸince genel UI yenile
case 'evdeSaglikData_ULTIMATE_V18':
case 'evdeSaglikStaff_ULTIMATE_V18':
case 'evdeSaglikNotes_ULTIMATE_V18':
case 'evdeSaglikLeaveRec_V18':
case 'evdeSaglikDocData_V18':
if (typeof renderUI === 'function') renderUI();
// YÃ¶netimsel listeler de etkilenebilir
if (typeof renderMgmtLists === 'function') renderMgmtLists();
break;

// Sadece Liste/Dropdown gÃ¼ncellemeleri
case 'evdeSaglikDoctors_V18':
case 'evdeSaglikTeams_V19':
case 'evdeSaglikProcs_V18':
case 'evdeSaglikSpecList_V18':
if (typeof renderMgmtLists === 'function') renderMgmtLists();
break;
}
}

// Global deÄŸiÅŸkenleri gÃ¼ncelleme haritasÄ± (ÅÄ°FRE Ã‡Ã–ZME DESTEKLÄ°)
async function updateGlobalVariable(key, value) {
// DeÄŸer null veya undefined ise boÅŸ dizi/obje ata
switch (key) {
case 'evdeSaglikShifts_V19': shiftList = value || []; break;
case 'evdeSaglikDevices_V1': deviceList = value || []; break;
case 'evdeSaglikData_ULTIMATE_V18': allRecords = value || {}; break;
case 'evdeSaglikStaff_ULTIMATE_V18': staffList = value || []; break;
case 'evdeSaglikNotes_ULTIMATE_V18': allNotes = value || {}; break;
case 'evdeSaglikDoctors_V18': doctorList = value || []; break;
case 'evdeSaglikDocData_V18':
docRecords = typeof unsanitizeDocRecordsFromFirebase === 'function'
? unsanitizeDocRecordsFromFirebase(value)
: (value || {});
break;
case 'evdeSaglikProcs_V18': procList = value || []; break;
case 'evdeSaglikSpecList_V18': specialistList = value || []; break;
case 'evdeSaglikQuickList_V18': quickList = value || []; break;
case 'evdeSaglikLeaveRec_V18': leaveRecords = value || []; break;
case 'evdeSaglikDoctorLeaves_V1': doctorLeaveRecords = value || []; renderDoctorLeaveRecords(); break;
case 'evdeSaglikUmkeRecords_V1': umkeRecords = value || []; renderUmkeRecords(); break;
case 'evdeSaglikTeams_V19': teamList = value || []; break;
case 'evdeSaglikRoutines_V19': routineList = value || []; break;
case 'evdeSaglikBudget_V19': budgetList = value || []; break;
case 'evdeSaglikEmergency_V19': emergencyList = value || []; break;
case 'evdeSaglikBags_V19': emergencyBags = value || ["Ana Ã‡anta"]; break;
case 'evdeSaglikGenNotesList_V1': generalNotesList = value || []; break;
// Rehber - ÅŸifre Ã§Ã¶zme gerekli
case 'evdeSaglikPhonebook_V1':
phonebookList = await decryptArray(value || [], ['name', 'num', 'role']);
break;
// Hasta takip - ÅŸifre Ã§Ã¶zme gerekli
case 'evdeSaglikReminders_V1':
patientReminders = await decryptArray(value || [], ENCRYPTED_FIELDS.patientReminders);
break;
case 'evdeSaglikApiKey_V18': apiKey = value || ""; break;
case 'evdeSaglikAppPW_Enc_V1':
if (value) { try { appPassword = atob(value); } catch (e) { } }
break;
case 'evdeSaglikLockedTabsConfig_V1':
// 1. Listeyi GÃ¼ncelle (Global deÄŸiÅŸkene yaz)
if (typeof value === 'string') {
try { window.lockedTabsConfig = JSON.parse(value); } catch (e) { window.lockedTabsConfig = []; }
} else {
window.lockedTabsConfig = value || [];
}

// 2. HafÄ±zayÄ± Temizle (Eski izinleri iptal et)
if (window.unlockedSessionTabs) {
if (Array.isArray(window.lockedTabsConfig)) {
window.lockedTabsConfig.forEach(tabId => {
window.unlockedSessionTabs[tabId] = false;
});
}
}

// 3. SUÃ‡ÃœSTÃœ YAP (EÄŸer kullanÄ±cÄ± ÅŸu an kilitlenen o sekmedeyse KOV!)
// Åu an aÃ§Ä±k olan (gÃ¶rÃ¼nÃ¼r) sekmeyi bul
const currentVisTab = document.querySelector('.tab-content:not(.hidden)');

if (currentVisTab && currentVisTab.id) {
// ID genelde 'tab-butce' ÅŸeklindedir, baÅŸÄ±ndaki 'tab-' kÄ±smÄ±nÄ± atalÄ±m
const curId = currentVisTab.id.replace('tab-', '');

// EÄŸer adamÄ±n baktÄ±ÄŸÄ± sayfa kilitliler listesindeyse
if (window.lockedTabsConfig.includes(curId)) {

// switchTab fonksiyonu hazÄ±rsa kullan
if (typeof switchTab === 'function') {
switchTab('personel'); // AdamÄ± Personel (Ana) sekmesine fÄ±rlat

// KullanÄ±cÄ±ya bilgi ver
if (typeof showToast === 'function') {
showToast("Bu sekme yÃ¶netici tarafÄ±ndan kilitlendi!", "warning");
}
} else {
// switchTab yoksa manuel gizle (Acil Durum)
document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
const safe = document.getElementById('tab-personel');
if (safe) safe.classList.remove('hidden');
}
}
}
break;
case 'evdeSaglikTabLockPassCustom_V1': customTabPassword = value || '0000'; break;
// YENÄ°
case 'evdeSaglikStartupLock_V1': startupLockEnabled = (value === 'true' || value === true); break;
// YENÄ°
case 'evdeSaglikAdminPass_V1': adminPanelPassword = value || '1234'; break;
}
}
async function toggleStartupLock() {
startupLockEnabled = document.getElementById('setting-startup-lock').checked;
await FirebaseStorage.setItem(LS_STARTUP_LOCK_ENABLED, JSON.stringify(startupLockEnabled));
showToast(`AÃ§Ä±lÄ±ÅŸ kilidi ${startupLockEnabled ? 'AKTÄ°F' : 'DEVRE DIÅI'}`);
}
// --- YÃ–NETÄ°M ÅÄ°FRESÄ°NÄ° KAYDETME FONKSÄ°YONU ---
async function updateAdminPassword() {
const newVal = document.getElementById('setting-admin-pass').value.trim();
if (newVal.length < 3) return showToast("Åifre en az 3 karakter olmalÄ±!", "error");

adminPanelPassword = newVal;
await FirebaseStorage.setItem('evdeSaglikAdminPass_V1', adminPanelPassword);
showToast("YÃ¶netim ÅŸifresi gÃ¼ncellendi.");
}
// --- YEDEK YÃœKLEME GÃœVENLÄ°K KONTROLÃœ ---
function triggerImportWithPassword() {
// Sekme Kilit Åifresini Sor (customTabPassword)
// EÄŸer ÅŸifre boÅŸsa varsayÄ±lan '3981'dir.
const pass = prompt("Yedek dosya yÃ¼klemek iÃ§in Sekme ParolasÄ±nÄ± girin:");

if (pass === null) return; // Ä°ptal etti

// customTabPassword ile kontrol ediyoruz (Sekme Åifresi)
if (pass === customTabPassword) {
// Åifre doÄŸruysa gizli dosya kutusuna tÄ±klat
document.getElementById('import-file').click();
} else {
showToast("HatalÄ± Parola!", "error");
}
}
// --- CANLI KÄ°LÄ°T BEKÃ‡Ä°SÄ° (ZORUNLU YAMA) ---
// --- ISRARCI CANLI KÄ°LÄ°T SÄ°STEMÄ° (TERMINATOR VERSÄ°YON) ---
function baslatCanliGuvenlik() {
// Kontrol 1: Firebase kÃ¼tÃ¼phanesi yÃ¼klendi mi?
if (typeof firebase === 'undefined' || typeof firebase.database !== 'function') {
// YÃ¼klenmediyse 500 milisaniye (yarÄ±m saniye) sonra tekrar dene
setTimeout(baslatCanliGuvenlik, 500);
return;
}

// Kontrol 2: Daha Ã¶nce baÅŸlatÄ±ldÄ± mÄ±? (Ã‡ift Ã§alÄ±ÅŸmasÄ±n)
if (window.canliGuvenlikAktif) return;

try {
const db = firebase.database();

// Kilitli Sekmeler Listesini Dinle (Her deÄŸiÅŸiklikte Ã§alÄ±ÅŸÄ±r)
db.ref('evdeSaglikLockedTabsConfig_V1').on('value', (snapshot) => {

// EÄŸer updateGlobalVariable fonksiyonu hazÄ±rsa Ã§alÄ±ÅŸtÄ±r
if (typeof updateGlobalVariable === 'function') {
updateGlobalVariable('evdeSaglikLockedTabsConfig_V1', snapshot.val());
}
});

// Sekme Åifresini Dinle
db.ref('evdeSaglikTabLockPassCustom_V1').on('value', (snapshot) => {
if (typeof updateGlobalVariable === 'function') {
updateGlobalVariable('evdeSaglikTabLockPassCustom_V1', snapshot.val());
}
});

// YÃ¶netim Åifresini Dinle
db.ref('evdeSaglikAdminPass_V1').on('value', (snapshot) => {
if (typeof updateGlobalVariable === 'function') {
updateGlobalVariable('evdeSaglikAdminPass_V1', snapshot.val());
}
});

// Sistemin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± iÅŸaretle
window.canliGuvenlikAktif = true;

// Ekrana kÃ¼Ã§Ã¼k bir bilgi ver (Ä°stersen silebilirsin)
// if(typeof showToast === 'function') showToast("CanlÄ± GÃ¼venlik Aktif");

} catch (err) {
console.error("GÃ¼venlik BaÅŸlatma HatasÄ±:", err);
// Hata olursa 1 saniye sonra tekrar dene
setTimeout(baslatCanliGuvenlik, 1000);
}
}

// Fonksiyonu ilk kez tetikle
baslatCanliGuvenlik();
// ================================================================
// YENÄ° Ã–ZELLÄ°K: KAYIT OLMA DURUMU KONTROLÃœ
// ================================================================

let isRegistrationEnabled = true; // VarsayÄ±lan aÃ§Ä±k

// 1. VeritabanÄ±ndan AyarÄ± Dinle (Uygulama aÃ§Ä±lÄ±r aÃ§Ä±lmaz Ã§alÄ±ÅŸÄ±r)
// Bu kÄ±sÄ±m giriÅŸ yapÄ±lmÄ±ÅŸ olsun veya olmasÄ±n Ã§alÄ±ÅŸÄ±r
database.ref('evde_saglik_ortak_veri/evdeSaglikRegStatus_V1').on('value', (snapshot) => {
const val = snapshot.val();
// EÄŸer veritabanÄ±nda kayÄ±t yoksa (null) varsayÄ±lan olarak aÃ§Ä±k olsun (true)
isRegistrationEnabled = (val === null) ? true : val;

// A) GiriÅŸ EkranÄ±ndaki Butonu YÃ¶net
const regBtn = document.getElementById('tab-register-btn');
const regForm = document.getElementById('register-form');

if (regBtn) {
if (isRegistrationEnabled) {
// KayÄ±t aÃ§Ä±ksa butonu gÃ¶ster
regBtn.style.display = 'block';
// Buton geniÅŸliklerini dÃ¼zelt (GiriÅŸ Yap butonu tek kalmasÄ±n)
document.getElementById('tab-login-btn').classList.remove('w-full');
document.getElementById('tab-login-btn').classList.add('flex-1');
} else {
// KayÄ±t kapalÄ±ysa butonu gizle
regBtn.style.display = 'none';
// GiriÅŸ Yap butonunu tam geniÅŸlik yap
document.getElementById('tab-login-btn').classList.remove('flex-1');
document.getElementById('tab-login-btn').classList.add('w-full');

// EÄŸer kullanÄ±cÄ± o sÄ±rada "KayÄ±t Ol" formundaysa zorla "GiriÅŸ Yap"a at
if (regForm && !regForm.classList.contains('hidden')) {
switchAuthTab('login');
showAuthMessage('Yeni Ã¼ye kaydÄ± yÃ¶netici tarafÄ±ndan kapatÄ±lmÄ±ÅŸtÄ±r.', 'error');
}
}
}

// B) Ayarlar MenÃ¼sÃ¼ndeki AnahtarÄ± (Switch) GÃ¼ncelle
const toggleEl = document.getElementById('setting-reg-toggle');
if (toggleEl) {
toggleEl.checked = isRegistrationEnabled;
}

});

// 2. AyarÄ± DeÄŸiÅŸtirme Fonksiyonu (Kalkan menÃ¼sÃ¼nden Ã§aÄŸrÄ±lÄ±r)
async function updateRegistrationStatus(isChecked) {
// Sadece giriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ± deÄŸiÅŸtirebilir
if (!auth.currentUser) {
showToast('Bunu deÄŸiÅŸtirmek iÃ§in giriÅŸ yapmalÄ±sÄ±nÄ±z.', 'error');
// Switch'i eski haline getir
document.getElementById('setting-reg-toggle').checked = !isChecked;
return;
}

try {
await database.ref('evde_saglik_ortak_veri/evdeSaglikRegStatus_V1').set(isChecked);
showToast(isChecked ? 'Ãœye kaydÄ± AÃ‡ILDI' : 'Ãœye kaydÄ± KAPATILDI');
} catch (error) {
console.error('KayÄ±t ayarÄ± deÄŸiÅŸtirilemedi:', error);
showToast('Hata oluÅŸtu, yetkinizi kontrol edin.', 'error');
// Hata olursa switch'i geri al
document.getElementById('setting-reg-toggle').checked = !isChecked;
}
}
</script>
<div id="tab-settings-modal"
class="fixed inset-0 bg-black/60 z-[110] hidden items-center justify-center p-4 backdrop-blur-sm">
<div class="bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col modal-enter max-h-[85vh]">
<div class="p-4 border-b flex justify-between items-center bg-orange-50 rounded-t-xl">
<h3 class="text-lg font-bold text-orange-900 flex items-center gap-2">
<i data-lucide="shield" class="w-5 h-5"></i> Sekme GÃ¼venlik AyarlarÄ±
</h3>
<button
onclick="document.getElementById('tab-settings-modal').classList.add('hidden'); document.getElementById('tab-settings-modal').classList.remove('flex');"
class="text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button>
</div>

<div class="p-6 space-y-6 overflow-y-auto">
<div class="flex items-center justify-between bg-orange-50 p-3 rounded-lg border border-orange-100">
<div>
<h4 class="text-sm font-bold text-orange-900">AÃ§Ä±lÄ±ÅŸta Kilit EkranÄ±</h4>
<p class="text-[10px] text-gray-500">Uygulama aÃ§Ä±ldÄ±ÄŸÄ±nda ÅŸifre sorulsun mu?</p>
</div>
<label class="relative inline-flex items-center cursor-pointer">
<input type="checkbox" id="setting-startup-lock" onchange="toggleStartupLock()"
class="sr-only peer">
<div
class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-600">
</div>
</label>
</div>

<hr class="border-gray-100">
<div>
<label class="block text-xs font-bold text-gray-500 uppercase mb-2">Sekme Kilit Åifresi</label>
<div class="flex gap-2">
<input type="text" id="setting-tab-pass"
class="flex-1 p-2 border border-gray-300 rounded text-sm font-bold text-center tracking-widest focus:ring-2 focus:ring-orange-500 outline-none"
placeholder="Åifre">
<button onclick="updateTabPassword()"
class="bg-orange-600 text-white px-3 py-2 rounded font-bold text-xs hover:bg-orange-700 transition">Åifreyi
GÃ¼ncelle</button>
</div>
<p class="text-[10px] text-gray-400 mt-1">* Bu ÅŸifre sadece sekmeleri aÃ§arken sorulur.</p>
</div>

<br>

<div>
<label class="block text-xs font-bold text-gray-500 uppercase mb-3">Hangi Sekmeler
Åifrelensin?</label>
<div class="grid grid-cols-2 gap-2" id="tab-selection-grid">
</div>
</div>
</div>

<div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end">
<button
onclick="document.getElementById('tab-settings-modal').classList.add('hidden'); document.getElementById('tab-settings-modal').classList.remove('flex');"
class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold text-sm hover:bg-gray-300">Kapat</button>
</div>
</div>
</div>
<script>
const LS_THEME_DISMISSED = 'evdeSaglikThemeDismissed';

// Hicri bayram tarihleri (2024-2030)
const islamicHolidays = {
ramazan: [
{ year: 2024, start: '2024-04-10', end: '2024-04-12' },
{ year: 2025, start: '2025-03-30', end: '2025-04-01' },
{ year: 2026, start: '2026-03-20', end: '2026-03-22' },
{ year: 2027, start: '2027-03-09', end: '2027-03-11' },
{ year: 2028, start: '2028-02-26', end: '2028-02-28' },
{ year: 2029, start: '2029-02-14', end: '2029-02-16' },
{ year: 2030, start: '2030-02-04', end: '2030-02-06' }
],
kurban: [
{ year: 2024, start: '2024-06-16', end: '2024-06-19' },
{ year: 2025, start: '2025-06-06', end: '2025-06-09' },
{ year: 2026, start: '2026-05-27', end: '2026-05-30' },
{ year: 2027, start: '2027-05-16', end: '2027-05-19' },
{ year: 2028, start: '2028-05-05', end: '2028-05-08' },
{ year: 2029, start: '2029-04-24', end: '2029-04-27' },
{ year: 2030, start: '2030-04-13', end: '2030-04-16' }
]
};

// Ã–zel gÃ¼n tanÄ±mlarÄ±
const specialDays = {
children: {
check: (d, m) => m === 4 && d === 23,
icon: String.fromCodePoint(0x1F388),
title: '23 Nisan Ulusal Egemenlik ve Ã‡ocuk BayramÄ±',
message: 'TÃ¼m Ã§ocuklarÄ±mÄ±zÄ±n bayramÄ± kutlu olsun!',
bannerClass: 'banner-children',
effect: 'balloon'
},
youth: {
check: (d, m) => m === 5 && d === 19,
icon: String.fromCodePoint(0x1F3C3),
title: '19 MayÄ±s GenÃ§lik ve Spor BayramÄ±',
message: 'GenÃ§liÄŸe armaÄŸan edilen bu Ã¶zel gÃ¼n kutlu olsun!',
bannerClass: 'banner-national',
effect: 'confetti'
},
democracy: {
check: (d, m) => m === 7 && d === 15,
icon: String.fromCodePoint(0x1F1F9) + String.fromCodePoint(0x1F1F7),
title: '15 Temmuz Demokrasi ve Milli Birlik GÃ¼nÃ¼',
message: 'Åehitlerimizi saygÄ± ve minnetle anÄ±yoruz.',
bannerClass: 'banner-democracy',
effect: 'flag'
},
victory: {
check: (d, m) => m === 8 && d === 30,
icon: String.fromCodePoint(0x2694),
title: '30 AÄŸustos Zafer BayramÄ±',
message: 'BÃ¼yÃ¼k Zaferin yÄ±ldÃ¶nÃ¼mÃ¼ kutlu olsun!',
bannerClass: 'banner-national',
effect: 'confetti'
},
republic: {
check: (d, m) => m === 10 && d === 29,
icon: String.fromCodePoint(0x1F386),
title: 'Cumhuriyet BayramÄ± Kutlu Olsun!',
message: 'Cumhuriyetimizin kuruluÅŸu coÅŸkuyla kutlanÄ±yor!',
bannerClass: 'banner-republic',
effect: 'firework'
},
ataturk: {
check: (d, m) => m === 11 && d === 10,
icon: String.fromCodePoint(0x1F5A4),
title: 'AtatÃ¼rk\'Ã¼ Anma GÃ¼nÃ¼',
message: 'Ulu Ã–nder Mustafa Kemal AtatÃ¼rk\'Ã¼ saygÄ± ve minnetle anÄ±yoruz.',
bannerClass: 'banner-ataturk',
effect: 'memorial'
}
};

function isDateInRange(dateStr, startStr, endStr) {
const date = new Date(dateStr);
return date >= new Date(startStr) && date <= new Date(endStr);
}

function getSpecialDay() {
const now = new Date();
const day = now.getDate();
const month = now.getMonth() + 1;
const year = now.getFullYear();
const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

for (const [key, config] of Object.entries(specialDays)) {
if (config.check(day, month)) return { key, ...config };
}

const ramazanData = islamicHolidays.ramazan.find(h => h.year === year);
if (ramazanData && isDateInRange(dateStr, ramazanData.start, ramazanData.end)) {
return { key: 'ramazan', icon: String.fromCodePoint(0x1F319), title: 'Ramazan BayramÄ±nÄ±z MÃ¼barek Olsun!', message: 'Nice gÃ¼zel bayramlara...', bannerClass: 'banner-religious', effect: 'crescent' };
}

const kurbanData = islamicHolidays.kurban.find(h => h.year === year);
if (kurbanData && isDateInRange(dateStr, kurbanData.start, kurbanData.end)) {
return { key: 'kurban', icon: String.fromCodePoint(0x1F411), title: 'Kurban BayramÄ±nÄ±z MÃ¼barek Olsun!', message: 'HayÄ±rlÄ± bayramlar dileriz.', bannerClass: 'banner-religious', effect: 'crescent' };
}

return null;
}

function createSnowEffect() {
const container = document.getElementById('theme-effects-container');
if (!container) return;
const snowflakes = [String.fromCodePoint(0x2744), String.fromCodePoint(0x2745), String.fromCodePoint(0x2746)];
for (let i = 0; i < 50; i++) {
const sf = document.createElement('div');
sf.className = 'snowflake';
sf.textContent = snowflakes[Math.floor(Math.random() * snowflakes.length)];
sf.style.left = Math.random() * 100 + 'vw';
sf.style.animationDuration = (Math.random() * 5 + 5) + 's';
sf.style.animationDelay = Math.random() * 10 + 's';
sf.style.fontSize = (Math.random() * 1.5 + 0.8) + 'rem';
container.appendChild(sf);
}
}

function createConfettiEffect() {
const container = document.getElementById('theme-effects-container');
if (!container) return;
const colors = ['#f43f5e', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'];
for (let i = 0; i < 80; i++) {
const c = document.createElement('div');
c.className = 'confetti';
c.style.left = Math.random() * 100 + 'vw';
c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
c.style.animationDuration = (Math.random() * 3 + 3) + 's';
c.style.animationDelay = Math.random() * 5 + 's';
c.style.width = (Math.random() * 8 + 5) + 'px';
c.style.height = (Math.random() * 8 + 5) + 'px';
container.appendChild(c);
}
}

function createBalloonEffect() {
const container = document.getElementById('theme-effects-container');
if (!container) return;
const balloons = [String.fromCodePoint(0x1F388), String.fromCodePoint(0x1F381), String.fromCodePoint(0x1F380)];
for (let i = 0; i < 20; i++) {
const b = document.createElement('div');
b.className = 'balloon';
b.textContent = balloons[Math.floor(Math.random() * balloons.length)];
b.style.left = Math.random() * 100 + 'vw';
b.style.animationDuration = (Math.random() * 10 + 15) + 's';
b.style.animationDelay = Math.random() * 10 + 's';
container.appendChild(b);
}
}

function createFireworkEffect() {
const container = document.getElementById('theme-effects-container');
if (!container) return;
const colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6'];
function launch() {
const x = Math.random() * window.innerWidth;
const y = Math.random() * (window.innerHeight * 0.6);
for (let i = 0; i < 20; i++) {
const p = document.createElement('div');
p.className = 'firework';
p.style.left = x + 'px';
p.style.top = y + 'px';
p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
const angle = (Math.PI * 2 / 20) * i;
const v = 50 + Math.random() * 50;
p.style.transform = `translate(${Math.cos(angle) * v}px, ${Math.sin(angle) * v}px)`;
container.appendChild(p);
setTimeout(() => p.remove(), 1500);
}
}
launch();
setInterval(launch, 3000);
}

function createCrescentEffect() {
const container = document.getElementById('theme-effects-container');
if (!container) return;
const crescents = [String.fromCodePoint(0x1F319), String.fromCodePoint(0x2728), String.fromCodePoint(0x2B50)];
for (let i = 0; i < 30; i++) {
const c = document.createElement('div');
c.className = 'snowflake crescent-icon';
c.textContent = crescents[Math.floor(Math.random() * crescents.length)];
c.style.left = Math.random() * 100 + 'vw';
c.style.animationDuration = (Math.random() * 8 + 8) + 's';
c.style.animationDelay = Math.random() * 10 + 's';
container.appendChild(c);
}
}

function createFlagEffect() {
const container = document.getElementById('theme-effects-container');
if (!container) return;
const flag = String.fromCodePoint(0x1F1F9) + String.fromCodePoint(0x1F1F7);
for (let i = 0; i < 15; i++) {
const f = document.createElement('div');
f.className = 'snowflake flag-icon';
f.textContent = flag;
f.style.left = Math.random() * 100 + 'vw';
f.style.animationDuration = (Math.random() * 10 + 10) + 's';
f.style.animationDelay = Math.random() * 8 + 's';
f.style.fontSize = '2rem';
container.appendChild(f);
}
}

function applyMemorialMode() { document.body.classList.add('ataturk-memorial-mode'); }

function applyEffect(effectType) {
switch (effectType) {
case 'snow': createSnowEffect(); break;
case 'confetti': createConfettiEffect(); break;
case 'balloon': createBalloonEffect(); break;
case 'firework': createFireworkEffect(); break;
case 'crescent': createCrescentEffect(); break;
case 'flag': createFlagEffect(); break;
case 'memorial': applyMemorialMode(); break;
}
}

function showSpecialDayBanner(specialDay) {
const banner = document.getElementById('special-day-banner');
const iconEl = document.getElementById('special-day-icon');
const titleEl = document.getElementById('special-day-title');
const messageEl = document.getElementById('special-day-message');
if (!banner || !iconEl || !titleEl || !messageEl) return;
iconEl.textContent = specialDay.icon;
titleEl.textContent = specialDay.title;
messageEl.textContent = specialDay.message;
banner.className = `px-4 py-3 text-white ${specialDay.bannerClass}`;
banner.classList.remove('hidden');
}

function applySpecialDayTheme() {
const today = new Date().toDateString();
if (localStorage.getItem(LS_THEME_DISMISSED) === today) return;
const specialDay = getSpecialDay();
if (!specialDay) return;
console.log('%cğŸ‰ Ã–zel gÃ¼n tespit edildi: ' + specialDay.title, 'color: #8b5cf6; font-weight: bold;');
showSpecialDayBanner(specialDay);
applyEffect(specialDay.effect);
}

function dismissSpecialDayTheme() {
const banner = document.getElementById('special-day-banner');
const container = document.getElementById('theme-effects-container');
if (banner) banner.classList.add('hidden');
if (container) container.innerHTML = '';
document.body.classList.remove('ataturk-memorial-mode');
localStorage.setItem(LS_THEME_DISMISSED, new Date().toDateString());
console.log('%cğŸ”• Ã–zel gÃ¼n temasÄ± kapatÄ±ldÄ±', 'color: #6b7280;');
}

function createBannerElements() {
if (document.getElementById('special-day-banner')) return;

// Effects container - body'ye ekle
const effectsContainer = document.createElement('div');
effectsContainer.id = 'theme-effects-container';
document.body.appendChild(effectsContainer);

// Banner - app'in iÃ§ine ekle
const app = document.getElementById('app');
if (!app) return;

const bannerHTML = `
<div id="special-day-banner" class="hidden px-4 py-3 text-white" style="position:relative; z-index:100;">
<div class="flex items-center justify-between max-w-7xl mx-auto">
<div class="flex items-center gap-3">
<span id="special-day-icon" class="text-3xl"></span>
<div>
<h3 id="special-day-title" class="font-bold text-lg"></h3>
<p id="special-day-message" class="text-sm opacity-90"></p>
</div>
</div>
<button onclick="dismissSpecialDayTheme()" class="text-white/70 hover:text-white hover:bg-white/20 rounded-full p-2 transition" title="Kapat">
<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
</button>
</div>
</div>
`;
app.insertAdjacentHTML('afterbegin', bannerHTML);
}

// Firebase auth sonrasÄ± Ã§alÄ±ÅŸtÄ±r
if (typeof auth !== 'undefined') {
auth.onAuthStateChanged((user) => {
if (user) {
setTimeout(() => {
createBannerElements();
applySpecialDayTheme();
}, 1500);
}
});
}

console.log('%cğŸŠ Ã–zel GÃ¼n Tema Sistemi YÃ¼klendi', 'color: #10b981; font-weight: bold; font-size: 14px;');

// ============================================
// AKTÄ°VÄ°TE LOG SÄ°STEMÄ°
// ============================================

const LS_ACTIVITY_LOGS = 'evdeSaglik_ActivityLogs';
let activityLogs = [];

// Log tÃ¼rleri ve ikonlarÄ±
const LOG_TYPES = {
shift: { icon: 'ğŸ“…', label: 'NÃ¶bet' },
budget: { icon: 'ğŸ’°', label: 'BÃ¼tÃ§e' },
emergency: { icon: 'ğŸ§°', label: 'Acil Ã‡anta' },
device: { icon: 'ğŸ“±', label: 'Cihaz' },
reminder: { icon: 'â°', label: 'HatÄ±rlatÄ±cÄ±' },
contact: { icon: 'ğŸ“', label: 'Rehber' },
note: { icon: 'ğŸ“', label: 'Not' },
routine: { icon: 'âœ…', label: 'Rutin' },
user: { icon: 'ğŸ‘¤', label: 'KullanÄ±cÄ±' },
pansuman: { icon: 'ğŸ©¹', label: 'Pansuman' },
sondainr: { icon: 'ğŸ”§', label: 'Sonda/Ä°NR/NG' },
general: { icon: 'ğŸ“‹', label: 'Genel' }
};

// Aktivite loglarÄ±nÄ± yÃ¼kle
async function loadActivityLogs() {
try {
const snapshot = await database.ref('evde_saglik_ortak_veri/activity_logs').orderByChild('timestamp').limitToLast(50).once('value');
const data = snapshot.val();
activityLogs = data ? Object.values(data).reverse() : [];
renderActivityLogs();
} catch (error) {
console.error('Log yÃ¼kleme hatasÄ±:', error);
activityLogs = [];
}
}

// Yeni aktivite logu ekle
async function addActivityLog(type, action, details = '') {
if (!currentUser) return;

const log = {
id: Date.now().toString(),
type: type,
action: action,
details: details,
user: currentUser.email,
timestamp: new Date().toISOString()
};

try {
await database.ref(`evde_saglik_ortak_veri/activity_logs/${log.id}`).set(log);
activityLogs.unshift(log);
if (activityLogs.length > 50) activityLogs.pop();
renderActivityLogs();
updateActivityBadge();
} catch (error) {
console.error('Log kaydetme hatasÄ±:', error);
}
}

// LoglarÄ± render et
function renderActivityLogs() {
const container = document.getElementById('activity-log-list');
const countEl = document.getElementById('activity-count');

if (!container) return;

if (activityLogs.length === 0) {
container.innerHTML = '<p class="text-center text-gray-400 text-xs py-10">HenÃ¼z iÅŸlem yok</p>';
if (countEl) countEl.textContent = '0 kayÄ±t';
return;
}

let html = '';
activityLogs.forEach(log => {
const logType = LOG_TYPES[log.type] || LOG_TYPES.general;
const date = new Date(log.timestamp);
const timeStr = date.toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
const userShort = log.user ? log.user.split('@')[0] : '?';

html += `
<div class="bg-gray-50 rounded-lg p-3 border border-gray-200 hover:bg-gray-100 transition">
<div class="flex items-start gap-2">
<span class="text-lg">${logType.icon}</span>
<div class="flex-1">
<div class="text-xs font-bold text-gray-800">${log.action}</div>
${log.details ? `<div class="text-[10px] text-gray-500 mt-0.5">${log.details}</div>` : ''}
<div class="text-[10px] text-gray-400 mt-1 flex items-center gap-2">
<span>ğŸ‘¤ ${userShort}</span>
<span>â€¢</span>
<span>${timeStr}</span>
</div>
</div>
</div>
</div>
`;
});

container.innerHTML = html;
if (countEl) countEl.textContent = `${activityLogs.length} kayÄ±t`;
}

// Badge gÃ¼ncelle
function updateActivityBadge() {
const badge = document.getElementById('activity-badge');
if (!badge) return;

// Son 1 saat iÃ§indeki loglarÄ± say
const oneHourAgo = Date.now() - (60 * 60 * 1000);
const recentCount = activityLogs.filter(log => new Date(log.timestamp).getTime() > oneHourAgo).length;

if (recentCount > 0) {
badge.textContent = recentCount > 9 ? '9+' : recentCount;
badge.classList.remove('hidden');
} else {
badge.classList.add('hidden');
}
}

// Panel aÃ§
function openActivityLogPanel() {
document.getElementById('activity-log-panel').classList.remove('translate-x-full');
document.getElementById('activity-log-overlay').classList.remove('hidden');
loadActivityLogs();
}

// Panel kapat
function closeActivityLogPanel() {
document.getElementById('activity-log-panel').classList.add('translate-x-full');
document.getElementById('activity-log-overlay').classList.add('hidden');
}
// Log Temizleyici
async function clearActivityLogs() {
// Sadece admin temizleyebilir (bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf duyarsÄ±z)
if (currentUserRole?.toLowerCase() !== 'admin') {
showToast('Sadece Admin loglarÄ± temizleyebilir!', 'error');
return;
}
if (!confirm('TÃ¼m loglarÄ± silmek istiyor musunuz?')) return;
try {
await database.ref('evde_saglik_ortak_veri/activity_logs').remove();
activityLogs = [];
renderActivityLogs();
showToast('Loglar temizlendi', 'success');
} catch (error) {
showToast('Hata oluÅŸtu', 'error');
}
}

// Sayfa yÃ¼klendiÄŸinde
document.addEventListener('DOMContentLoaded', () => {
setTimeout(() => {
if (currentUser) loadActivityLogs();
}, 3000);
});

// Firebase auth sonrasÄ±
if (typeof auth !== 'undefined') {
auth.onAuthStateChanged((user) => {
if (user) {
setTimeout(loadActivityLogs, 3000);
}
});
}
// Her 30 saniyede badge gÃ¼ncelle
setInterval(() => {
if (currentUser) updateActivityBadge();
}, 30000);

// Badge'i gÃ¶ster
function updateActivityBadge() {
const badge = document.getElementById('activity-badge');
if (!badge || activityLogs.length === 0) return;

// Son 1 saat iÃ§indeki log sayÄ±sÄ±
const oneHourAgo = Date.now() - (60 * 60 * 1000);
const newCount = activityLogs.filter(l => new Date(l.timestamp).getTime() > oneHourAgo).length;

if (newCount > 0) {
badge.textContent = newCount > 9 ? '9+' : newCount;
badge.classList.remove('hidden');
badge.classList.add('flex');
} else {
badge.classList.add('hidden');
}
}
// Bildirim butonunu sadece admin gÃ¶rsÃ¼n
setTimeout(() => {
const actBtn = document.getElementById('btn-activity-log');
if (actBtn && currentUserRole !== 'admin') {
actBtn.style.display = 'none';
}
}, 3000);
</script>
<script>
// ============================================
// ROL BAZLI YETKÄ°LENDÄ°RME SÄ°STEMÄ°
// ============================================

const ROLES = { ADMIN: 'admin', USER: 'user', VIEWER: 'viewer' };
const LS_USER_ROLES = 'evdeSaglik_UserRoles';
let currentUserRole = ROLES.VIEWER; // VarsayÄ±lan: GÃ¶rÃ¼ntÃ¼leyici
let allUsersRoles = {};

// Email'i Firebase key formatÄ±na Ã§evir
function emailToKey(email) {
return email.replace(/\./g, ',').replace(/@/g, '_at_');
}

// Firebase key'i email'e Ã§evir
function keyToEmail(key) {
return key.replace(/,/g, '.').replace(/_at_/g, '@');
}

// KullanÄ±cÄ± rolÃ¼nÃ¼ kaydet (kayÄ±t sÄ±rasÄ±nda)
async function saveUserRole(email, role) {
const emailKey = emailToKey(email);
const roleData = {
email: email,
role: role,
createdAt: new Date().toISOString()
};

try {
await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}`).set(roleData);
return true;
} catch (error) {
console.error('âŒ Rol kaydetme hatasÄ±:', error);
return false;
}
}

// KullanÄ±cÄ± rolÃ¼nÃ¼ oku
async function getUserRole(email) {
const emailKey = emailToKey(email);

try {
const snapshot = await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}`).once('value');
const data = snapshot.val();

if (data && data.role) {
return data.role;
}
return null;
} catch (error) {
console.error('âŒ Rol okuma hatasÄ±:', error);
return null;
}
}

// TÃ¼m kullanÄ±cÄ± rollerini oku
async function getAllUserRoles() {
try {
const snapshot = await database.ref('evde_saglik_ortak_veri/users_roles').once('value');
const data = snapshot.val();
return data || {};
} catch (error) {
console.error('âŒ KullanÄ±cÄ± listesi okuma hatasÄ±:', error);
return {};
}
}

// Rol bazlÄ± UI kÄ±sÄ±tlamalarÄ±nÄ± uygula
function applyRoleRestrictions() {

// TÃ¼m role-hide sÄ±nÄ±flarÄ±nÄ± temizle
document.querySelectorAll('.role-hide-viewer, .role-hide-user').forEach(el => {
el.classList.remove('role-hide-viewer', 'role-hide-user');
});

// Viewer iÃ§in kÄ±sÄ±tlamalar
if (currentUserRole === ROLES.VIEWER) {
// Ekleme/dÃ¼zenleme butonlarÄ±nÄ± gizle
const hideForViewer = [
'#open-entry-modal-btn',
'#open-staff-modal-btn',
'#add-leave-btn',
'#save-entry-btn',
'#add-staff-btn',
'#add-doctor-btn',
'#add-spec-btn',
'#add-proc-btn',
'#add-team-btn',
'#btn-em-save',
'#btn-budget-save',
'#btn-rem-save',
'#btn-ph-save',
'#btn-device-save',
'[onclick*="addShift"]',
'[onclick*="addRoutine"]',
'[onclick*="addGeneralNote"]',
'[onclick*="addContact"]',
'[onclick*="addDevice"]',
'[onclick*="addBudgetItem"]',
'[onclick*="addEmergencyItem"]',
'[onclick*="triggerImportWithPassword"]',
'[onclick*="clearBudget"]',
'[onclick*="resetRoutines"]',
'#btn-user-management'
];

hideForViewer.forEach(selector => {
document.querySelectorAll(selector).forEach(el => {
el.classList.add('role-hide-viewer');
});
});

// Silme butonlarÄ±nÄ± gizle (tablolardaki)
document.querySelectorAll('[onclick*="delete"], [onclick*="remove"], [onclick*="Delete"], [onclick*="Remove"]').forEach(el => {
el.classList.add('role-hide-viewer');
});

// Aktivite LoglarÄ± seÃ§eneÄŸini gizle (sadece admin gÃ¶rebilir)
const activityLogsOption = document.getElementById('activity-logs-option');
if (activityLogsOption) activityLogsOption.style.display = 'none';

// Header butonlarÄ±nÄ± gizle (AI, Excel, PDF, YÃ¼kle - sadece admin gÃ¶rebilir)
const adminOnlyHeaderBtns = ['btn-ai-report', 'header-export-buttons', 'btn-import-data'];
adminOnlyHeaderBtns.forEach(id => {
const el = document.getElementById(id);
if (el) el.style.display = 'none';
});

// NÃ¶bet Yaz alanÄ±nÄ± gizle (sadece admin gÃ¶rebilir)
const shiftAddSection = document.getElementById('shift-add-section');
if (shiftAddSection) shiftAddSection.style.display = 'none';
// NÃ¶bet listesini tam geniÅŸliÄŸe Ã§Ä±kar
const shiftListWrapper = document.getElementById('shift-list-wrapper');
if (shiftListWrapper) {
shiftListWrapper.classList.remove('lg:col-span-2');
shiftListWrapper.classList.add('lg:col-span-3');
}

// Ä°zin/Rapor formlarÄ±nÄ± gizle (sadece admin gÃ¶rebilir)
const leaveAddForm = document.getElementById('leave-add-form');
if (leaveAddForm) leaveAddForm.style.display = 'none';
const doctorLeaveAddForm = document.getElementById('doctor-leave-add-form');
if (doctorLeaveAddForm) doctorLeaveAddForm.style.display = 'none';

}

// User iÃ§in kÄ±sÄ±tlamalar (sadece kullanÄ±cÄ± yÃ¶netimi gizli)
if (currentUserRole === ROLES.USER) {
document.querySelectorAll('#btn-user-management').forEach(el => {
el.classList.add('role-hide-user');
});

// Aktivite LoglarÄ± seÃ§eneÄŸini gizle (sadece admin gÃ¶rebilir)
const activityLogsOption = document.getElementById('activity-logs-option');
if (activityLogsOption) activityLogsOption.style.display = 'none';

// Header butonlarÄ±nÄ± gizle (AI, Excel, PDF, YÃ¼kle - sadece admin gÃ¶rebilir)
const adminOnlyHeaderBtns = ['btn-ai-report', 'header-export-buttons', 'btn-import-data'];
adminOnlyHeaderBtns.forEach(id => {
const el = document.getElementById(id);
if (el) el.style.display = 'none';
});

// NÃ¶bet Yaz alanÄ±nÄ± gizle (sadece admin gÃ¶rebilir)
const shiftAddSection = document.getElementById('shift-add-section');
if (shiftAddSection) shiftAddSection.style.display = 'none';
// NÃ¶bet listesini tam geniÅŸliÄŸe Ã§Ä±kar
const shiftListWrapper = document.getElementById('shift-list-wrapper');
if (shiftListWrapper) {
shiftListWrapper.classList.remove('lg:col-span-2');
shiftListWrapper.classList.add('lg:col-span-3');
}

// Ä°zin/Rapor formlarÄ±nÄ± gizle (sadece admin gÃ¶rebilir)
const leaveAddForm = document.getElementById('leave-add-form');
if (leaveAddForm) leaveAddForm.style.display = 'none';
const doctorLeaveAddForm = document.getElementById('doctor-leave-add-form');
if (doctorLeaveAddForm) doctorLeaveAddForm.style.display = 'none';

}

// Admin iÃ§in hiÃ§bir kÄ±sÄ±tlama yok
if (currentUserRole === ROLES.ADMIN) {
// API AyarlarÄ± butonunu gÃ¶ster (sadece admin iÃ§in)
const apiSettingsBtn = document.getElementById('menu-api-settings');
if (apiSettingsBtn) apiSettingsBtn.style.display = '';

// Bekleyen KullanÄ±cÄ±lar butonunu gÃ¶ster (sadece admin iÃ§in)
document.querySelectorAll('[data-admin-only]').forEach(el => {
el.classList.remove('hidden');
el.style.display = '';
});

// Admin-only butonlarÄ± gÃ¶ster
document.querySelectorAll('.admin-only-btn').forEach(el => {
el.classList.remove('hidden');
el.style.display = '';
});

// Header butonlarÄ±nÄ± gÃ¶ster (Admin iÃ§in)
const adminOnlyHeaderBtns = ['btn-ai-report', 'header-export-buttons', 'btn-import-data'];
adminOnlyHeaderBtns.forEach(id => {
const el = document.getElementById(id);
if (el) el.style.display = '';
});

// Bekleyen kullanÄ±cÄ± sayÄ±sÄ±nÄ± kontrol et
if (typeof checkPendingUsersCount === 'function') {
checkPendingUsersCount();
}

} else {
// Admin deÄŸilse admin-only butonlarÄ± gizle
document.querySelectorAll('.admin-only-btn').forEach(el => {
el.classList.add('hidden');
el.style.display = 'none';
});
}

// Rol badge'ini gÃ¼ncelle
updateRoleBadge();
// Ã‡Ä±kÄ±ÅŸ butonu her zaman gÃ¶rÃ¼nsÃ¼n
setTimeout(() => {
const logoutBtn = document.querySelector('[onclick*="logoutUser"]');
if (logoutBtn) {
logoutBtn.classList.remove('role-hide-viewer', 'role-hide-user');
logoutBtn.style.display = '';
}
}, 100);
}

// Header'a rol badge'i ekle (Sol tarafta, logo yanÄ±nda)
function updateRoleBadge() {
let badge = document.getElementById('current-role-badge');

if (!badge) {
// Header'Ä±n sol tarafÄ±ndaki logo/baÅŸlÄ±k container'Ä±nÄ± bul
// Bu ".flex.justify-between.items-center.px-6.py-4" iÃ§indeki ilk ".flex.items-center.gap-3"
const headerContainer = document.querySelector('.flex.justify-between.items-center.px-6.py-4.border-b.bg-white');
if (headerContainer) {
const logoContainer = headerContainer.querySelector('.flex.items-center.gap-3');
if (logoContainer) {
badge = document.createElement('span');
badge.id = 'current-role-badge';
badge.style.marginRight = '8px';
// Logo container'Ä±n en baÅŸÄ±na ekle
logoContainer.insertBefore(badge, logoContainer.firstChild);
}
}
}

if (badge) {
const roleNames = {
admin: 'ğŸ‘‘',
user: 'ğŸ‘¤',
viewer: 'ğŸ‘ï¸'
};
badge.className = `role-badge ${currentUserRole}`;
badge.textContent = roleNames[currentUserRole] || currentUserRole;
badge.title = currentUserRole === 'admin' ? 'Admin' : currentUserRole === 'user' ? 'KullanÄ±cÄ±' : 'GÃ¶rÃ¼ntÃ¼leyici';
}
}

// KullanÄ±cÄ± YÃ¶netim ModalÄ±nÄ± AÃ§
async function openUserManagementModal() {
if (currentUserRole !== ROLES.ADMIN) {
showToast('Bu iÅŸlem iÃ§in Admin yetkisi gerekli!', 'error');
return;
}

const modal = document.getElementById('user-management-modal');
modal.classList.remove('hidden');
modal.classList.add('flex');

// KullanÄ±cÄ± listesini yÃ¼kle
await loadUserList();

// YÃ¶netim ÅŸifresini kutuya yaz
const adminPassInput = document.getElementById('setting-admin-pass');
if (adminPassInput) adminPassInput.value = adminPanelPassword;

// Yeni Ãœye KaydÄ± durumunu yÃ¼kle
try {
const regSnap = await database.ref('app_settings/registration_enabled').once('value');
const regEnabled = regSnap.val() !== false; // varsayÄ±lan true
const regToggle = document.getElementById('setting-reg-toggle');
if (regToggle) regToggle.checked = regEnabled;
} catch (e) {
console.error('KayÄ±t durumu yÃ¼klenirken hata:', e);
}

if (typeof lucide !== 'undefined') lucide.createIcons();
}

// KullanÄ±cÄ± YÃ¶netim ModalÄ±nÄ± Kapat
function closeUserManagementModal() {
const modal = document.getElementById('user-management-modal');
modal.classList.add('hidden');
modal.classList.remove('flex');
}

// KullanÄ±cÄ± listesini yÃ¼kle
async function loadUserList() {
const container = document.getElementById('user-list-container');
container.innerHTML = '<p class="text-center py-4 text-gray-400">YÃ¼kleniyor...</p>';

allUsersRoles = await getAllUserRoles();

if (Object.keys(allUsersRoles).length === 0) {
container.innerHTML = '<p class="text-center py-4 text-gray-400">HenÃ¼z kayÄ±tlÄ± kullanÄ±cÄ± yok</p>';
return;
}

let html = '';
for (const [key, data] of Object.entries(allUsersRoles)) {
const email = data.email || keyToEmail(key);
const role = data.role || 'viewer';
const nickname = data.nickname || '';
const allowedTabs = data.allowedTabs || ALL_TABS.map(t => t.id);
const notificationSettings = data.notificationSettings || { enabled: false, tabs: [] };
const isCurrentUser = currentUser && currentUser.email === email;
const isBlocked = data.blocked || false;

// Engellenen kullanÄ±cÄ± iÃ§in kart stili
const cardClass = isBlocked
? 'bg-red-50 border-red-300 border-2'
: (isCurrentUser ? 'bg-yellow-50 border-yellow-300' : 'bg-white');

html += `
<div class="border rounded-lg p-4 ${cardClass}">
<div class="flex justify-between items-start mb-3">
<div class="flex-1">
<div class="font-bold text-gray-800 flex items-center gap-2">
${isBlocked ? '<span class="text-red-600">ğŸš«</span>' : ''}
${email}
${isCurrentUser ? '<span class="text-[10px] text-yellow-600 font-bold">(Sen)</span>' : ''}
${isBlocked ? '<span class="text-[10px] bg-red-600 text-white px-2 py-0.5 rounded-full font-bold">ENGELLÄ°</span>' : ''}
</div>
<div class="flex items-center gap-2 mt-2">
<span class="text-xs text-gray-500">Takma Ad:</span>
<input type="text"
id="nickname-${key}"
value="${nickname}"
placeholder="Takma ad girin..."
class="text-sm border border-gray-300 rounded px-2 py-1 w-40 focus:ring-2 focus:ring-indigo-500 outline-none">
<button onclick="saveUserNickname('${key}')"
class="px-2 py-1 bg-green-600 text-white rounded text-[10px] font-bold hover:bg-green-700 flex items-center gap-1">
<i data-lucide="save" class="w-3 h-3"></i> Kaydet
</button>
</div>
${nickname ? `<div class="text-xs text-indigo-600 font-medium mt-1">ğŸ“› GÃ¶rÃ¼nen Ad: <strong>${nickname}</strong></div>` : ''}
</div>
<div class="flex items-center gap-2">
${!isCurrentUser ? `
<button onclick="toggleUserBlock('${key}', ${isBlocked})"
class="px-3 py-1 ${isBlocked ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'} text-white rounded text-xs font-bold flex items-center gap-1">
<i data-lucide="${isBlocked ? 'unlock' : 'lock'}" class="w-3 h-3"></i>
${isBlocked ? 'Engeli KaldÄ±r' : 'Engelle'}
</button>
<button onclick="deleteSystemUser('${key}', '${email.replace(/'/g, "\\'")}')"
class="px-3 py-1 bg-gray-700 hover:bg-gray-900 text-white rounded text-xs font-bold flex items-center gap-1" title="KullanÄ±cÄ±yÄ± Sistemden Sil">
<i data-lucide="trash-2" class="w-3 h-3"></i>
Sil
</button>
` : ''}
<select id="role-select-${key}" class="text-xs border rounded px-2 py-1" ${isCurrentUser || isBlocked ? 'disabled' : ''}>
<option value="admin" ${role === 'admin' ? 'selected' : ''}>ğŸ‘‘ Admin</option>
<option value="user" ${role === 'user' ? 'selected' : ''}>ğŸ‘¤ KullanÄ±cÄ±</option>
<option value="viewer" ${role === 'viewer' ? 'selected' : ''}>ğŸ‘ï¸ GÃ¶rÃ¼ntÃ¼leyici</option>
</select>
${!isCurrentUser && !isBlocked ? `<button onclick="saveUserPermissions('${key}')" class="px-3 py-1 bg-indigo-600 text-white rounded text-xs font-bold hover:bg-indigo-700">Yetki Kaydet</button>` : ''}
</div>
</div>
<div class="border-t pt-3">
<div class="text-xs font-bold text-gray-500 mb-2">ğŸ“‘ EriÅŸebileceÄŸi Sekmeler:</div>
<div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="tabs-${key}">
${ALL_TABS.map(tab => `
<label class="flex items-center gap-1 text-xs cursor-pointer ${isCurrentUser ? 'opacity-50' : ''}">
<input type="checkbox" class="rounded border-gray-300" value="${tab.id}" ${allowedTabs.includes(tab.id) ? 'checked' : ''} ${isCurrentUser ? 'disabled' : ''}>
${tab.name}
</label>
`).join('')}
</div>
</div>

<div class="border-t pt-3 mt-3">
<div class="flex items-center gap-3 mb-2">
<div class="text-xs font-bold text-gray-500">ğŸ”” Bildirim AyarlarÄ±:</div>
<label class="flex items-center gap-1.5 text-xs cursor-pointer">
<input type="checkbox" id="notif-enabled-${key}" class="rounded border-gray-300" ${notificationSettings.enabled ? 'checked' : ''}>
<span class="font-medium ${notificationSettings.enabled ? 'text-green-600' : 'text-gray-500'}">Bildirimleri Aktif Et</span>
</label>
</div>
<div class="text-[10px] text-gray-400 mb-2">SeÃ§ilen iÅŸlemlerde veri giriÅŸi olduÄŸunda bu kullanÄ±cÄ±ya bildirim gider.</div>
<div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="notif-tabs-${key}">
<label class="flex items-center gap-1 text-xs cursor-pointer font-medium text-indigo-700">
<input type="checkbox" class="rounded border-orange-300 text-orange-600" value="islemplanla" ${notificationSettings.tabs && notificationSettings.tabs.includes('islemplanla') ? 'checked' : ''}>
ğŸ“… TALEPLER
</label>
<label class="flex items-center gap-1 text-xs cursor-pointer font-medium text-blue-700">
<input type="checkbox" class="rounded border-orange-300 text-orange-600" value="doktorailet" ${notificationSettings.tabs && notificationSettings.tabs.includes('doktorailet') ? 'checked' : ''}>
ğŸ‘¨â€âš•ï¸ Doktor'a Ä°let
</label>
<label class="flex items-center gap-1 text-xs cursor-pointer font-medium text-green-700">
<input type="checkbox" class="rounded border-orange-300 text-orange-600" value="sekreternot" ${notificationSettings.tabs && notificationSettings.tabs.includes('sekreternot') ? 'checked' : ''}>
ğŸ“‹ TÄ±bbi Sekretere Not
</label>
<label class="flex items-center gap-1 text-xs cursor-pointer font-medium text-purple-700">
<input type="checkbox" class="rounded border-orange-300 text-orange-600" value="drnotlar" ${notificationSettings.tabs && notificationSettings.tabs.includes('drnotlar') ? 'checked' : ''}>
ğŸ©º Dr. NotlarÄ±
</label>
<label class="flex items-center gap-1 text-xs cursor-pointer font-medium text-amber-700">
<input type="checkbox" class="rounded border-orange-300 text-orange-600" value="sorhemnotlar" ${notificationSettings.tabs && notificationSettings.tabs.includes('sorhemnotlar') ? 'checked' : ''}>
ğŸ“ Sor. Hem. NotlarÄ±
</label>
<label class="flex items-center gap-1 text-xs cursor-pointer font-medium text-cyan-700">
<input type="checkbox" class="rounded border-orange-300 text-orange-600" value="sondainr" ${notificationSettings.tabs && notificationSettings.tabs.includes('sondainr') ? 'checked' : ''}>
ğŸ©º Sonda, Ä°NR, NG
</label>
</div>
<div class="mt-3 pt-3 border-t border-gray-200">
<div class="text-[10px] text-gray-500 font-bold mb-2">ğŸ“ SON DURUM NOT BÄ°LDÄ°RÄ°MLERÄ°</div>
<div class="grid grid-cols-2 md:grid-cols-3 gap-2">
<label class="flex items-center gap-1 text-xs cursor-pointer font-medium text-indigo-600">
<input type="checkbox" class="rounded border-indigo-300 text-indigo-600" value="islemplanla_not" ${notificationSettings.tabs && notificationSettings.tabs.includes('islemplanla_not') ? 'checked' : ''}>
ğŸ“ Talep NotlarÄ±
</label>
<label class="flex items-center gap-1 text-xs cursor-pointer font-medium text-blue-600">
<input type="checkbox" class="rounded border-blue-300 text-blue-600" value="doktorailet_not" ${notificationSettings.tabs && notificationSettings.tabs.includes('doktorailet_not') ? 'checked' : ''}>
ğŸ“ Dr. Talep NotlarÄ±
</label>
<label class="flex items-center gap-1 text-xs cursor-pointer font-medium text-green-600">
<input type="checkbox" class="rounded border-green-300 text-green-600" value="sekreternot_not" ${notificationSettings.tabs && notificationSettings.tabs.includes('sekreternot_not') ? 'checked' : ''}>
ğŸ“ Sek. Not Bildirimleri
</label>
</div>
</div>
<button onclick="saveNotificationSettings('${key}')"
class="mt-2 px-3 py-1.5 bg-orange-500 text-white rounded text-xs font-bold hover:bg-orange-600 flex items-center gap-1.5">
<i data-lucide="bell" class="w-3 h-3"></i> Bildirim AyarlarÄ±nÄ± Kaydet
</button>
</div>
</div>
`;
}
container.innerHTML = html;
}

// KullanÄ±cÄ± rolÃ¼nÃ¼ gÃ¼ncelle
async function updateUserRole(emailKey) {
const select = document.getElementById(`role-select-${emailKey}`);
const newRole = select.value;
const email = keyToEmail(emailKey);

try {
await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}/role`).set(newRole);
showToast(`${email} rolÃ¼ "${newRole}" olarak gÃ¼ncellendi!`, 'success');
await loadUserList();
} catch (error) {
console.error('Rol gÃ¼ncelleme hatasÄ±:', error);
showToast('Rol gÃ¼ncellenemedi!', 'error');
}
}

// KullanÄ±cÄ±yÄ± engelle veya engeli kaldÄ±r
window.toggleUserBlock = async function (emailKey, currentlyBlocked) {
const email = keyToEmail(emailKey);
const newBlockedStatus = !currentlyBlocked;

const actionText = newBlockedStatus ? 'engellemek' : 'engelini kaldÄ±rmak';
if (!confirm(`"${email}" kullanÄ±cÄ±sÄ±nÄ± ${actionText} istediÄŸinize emin misiniz?`)) {
return;
}

try {
if (newBlockedStatus) {
// Engelle
await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}/blocked`).set(true);
await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}/blockedAt`).set(new Date().toISOString());
await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}/blockedBy`).set(currentUser?.email || 'admin');
showToast(`ğŸš« "${email}" kullanÄ±cÄ±sÄ± engellendi!`, 'error');
} else {
// Engeli kaldÄ±r
await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}/blocked`).set(false);
await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}/blockedAt`).remove();
await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}/blockedBy`).remove();
showToast(`âœ… "${email}" kullanÄ±cÄ±sÄ±nÄ±n engeli kaldÄ±rÄ±ldÄ±!`, 'success');
}

// Listeyi yenile
await loadUserList();
if (typeof lucide !== 'undefined') lucide.createIcons();
} catch (error) {
console.error('KullanÄ±cÄ± engelleme hatasÄ±:', error);
showToast('Ä°ÅŸlem gerÃ§ekleÅŸtirilemedi!', 'error');
}
};

// KullanÄ±cÄ±yÄ± sistemden tamamen sil (Admin only + ÅŸifre doÄŸrulama)
window.deleteSystemUser = async function (emailKey, email) {
// Admin kontrolÃ¼
if (currentUserRole !== ROLES.ADMIN && currentUserRole !== 'admin') {
showToast('Bu iÅŸlem iÃ§in Admin yetkisi gerekli!', 'error');
return;
}

// Veri giriÅŸi ÅŸifresi kontrolÃ¼
const password = prompt(`ğŸ” "${email}" kullanÄ±cÄ±sÄ±nÄ± sistemden KALICI olarak silmek Ã¼zeresiniz!\n\nBu iÅŸlem geri alÄ±namaz ve tÃ¼m kullanÄ±cÄ± verileri silinecektir.\n\nDevam etmek iÃ§in VERÄ° GÄ°RÄ°ÅÄ° ÅÄ°FRESÄ°NÄ° girin:`);

if (password === null) {
return; // Ä°ptal edildi
}

// Åifre doÄŸrulama (adminPanelPassword veya varsayÄ±lan "1234")
const correctPassword = adminPanelPassword || '1234';
if (password !== correctPassword) {
showToast('âŒ HatalÄ± ÅŸifre! Ä°ÅŸlem iptal edildi.', 'error');
return;
}

// Son onay
if (!confirm(`âš ï¸ SON ONAY:\n\n"${email}" kullanÄ±cÄ±sÄ± ve tÃ¼m iliÅŸkili verileri kalÄ±cÄ± olarak silinecek.\n\nDevam etmek istediÄŸinize emin misiniz?`)) {
return;
}

try {
// 1. users_roles'dan sil
await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}`).remove();

// 2. pending_users'dan sil (varsa)
await database.ref(`pending_users/${emailKey}`).remove();

// 3. approved_users'dan sil (varsa)
await database.ref(`approved_users/${emailKey}`).remove();

// 4. security_questions'dan sil (varsa)
await database.ref(`security_questions/${emailKey}`).remove();

// 5. user_settings'den sil (varsa)
await database.ref(`evde_saglik_ortak_veri/user_settings/${emailKey}`).remove();

// 6. in_app_notifications'dan sil (varsa)
await database.ref(`evde_saglik_ortak_veri/in_app_notifications/${emailKey}`).remove();

// 7. Silinen kullanÄ±cÄ±yÄ± kara listeye ekle (tekrar giriÅŸ engellenir)
await database.ref(`deleted_users/${emailKey}`).set({
email: email,
deletedAt: new Date().toISOString(),
deletedBy: currentUser?.email || 'admin'
});

showToast(`âœ… "${email}" kullanÄ±cÄ±sÄ± baÅŸarÄ±yla silindi ve kara listeye eklendi!`, 'success');

// Listeyi yenile
await loadUserList();
if (typeof lucide !== 'undefined') lucide.createIcons();

} catch (error) {
console.error('KullanÄ±cÄ± silme hatasÄ±:', error);
showToast('âŒ KullanÄ±cÄ± silinemedi: ' + error.message, 'error');
}
};

// KullanÄ±cÄ± takma adÄ±nÄ± kaydet
window.saveUserNickname = async function (emailKey) {
const nicknameInput = document.getElementById(`nickname-${emailKey}`);
const nickname = nicknameInput ? nicknameInput.value.trim() : '';
const email = keyToEmail(emailKey);

try {
await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}/nickname`).set(nickname);

// Global nickname cache'i gÃ¼ncelle
if (!window.userNicknames) window.userNicknames = {};
window.userNicknames[email] = nickname;

showToast(`"${email}" iÃ§in takma ad "${nickname}" olarak kaydedildi!`);
await loadUserList();

// Lucide ikonlarÄ±nÄ± yenile
if (typeof lucide !== 'undefined') lucide.createIcons();
} catch (error) {
console.error('Takma ad kaydetme hatasÄ±:', error);
showToast('Takma ad kaydedilemedi!', 'error');
}
};

// TÃ¼m kullanÄ±cÄ± takma adlarÄ±nÄ± yÃ¼kle (uygulama genelinde kullanÄ±lmak Ã¼zere)
async function loadAllNicknames() {
try {
const snapshot = await database.ref('evde_saglik_ortak_veri/users_roles').once('value');
const data = snapshot.val() || {};

window.userNicknames = {};
for (const [key, userData] of Object.entries(data)) {
const email = userData.email || keyToEmail(key);
if (userData.nickname) {
window.userNicknames[email] = userData.nickname;
}
}
} catch (error) {
console.error('Takma ad yÃ¼kleme hatasÄ±:', error);
window.userNicknames = {};
}
}

// Email'den takma ad getir (varsa takma ad, yoksa email'in @ Ã¶ncesi)
window.getNickname = function (email) {
if (window.userNicknames && window.userNicknames[email]) {
return window.userNicknames[email];
}
return email ? email.split('@')[0] : 'Bilinmiyor';
};

// Auth listener'a rol kontrolÃ¼ ekle (mevcut onAuthStateChanged'e ek)
const originalAuthListener = auth.onAuthStateChanged;
auth.onAuthStateChanged(async (user) => {
if (user) {
// TÃ¼m kullanÄ±cÄ± takma adlarÄ±nÄ± yÃ¼kle
await loadAllNicknames();

// KullanÄ±cÄ±nÄ±n rolÃ¼nÃ¼ kontrol et
let role = await getUserRole(user.email);

// EÄŸer rol yoksa (yeni kullanÄ±cÄ±), varsayÄ±lan "viewer" ata
if (!role) {
await saveUserRole(user.email, ROLES.VIEWER);
role = ROLES.VIEWER;
}

currentUserRole = role;
// Sekme yetkilerini al
const userDataFull = await database.ref(`evde_saglik_ortak_veri/users_roles/${emailToKey(user.email)}`).once('value');
const userData = userDataFull.val();
currentUserAllowedTabs = userData?.allowedTabs || ALL_TABS.map(t => t.id);

// KullanÄ±cÄ±ya Ã¶zel ÅŸifreleri ve sekme kilit listesini yÃ¼kle
try {
const userKey = emailToKey(user.email);
const userSettingsSnap = await database.ref(`evde_saglik_ortak_veri/user_settings/${userKey}`).once('value');
const userSettings = userSettingsSnap.val();
if (userSettings) {
if (userSettings.adminPassword) {
adminPanelPassword = userSettings.adminPassword;
}
if (userSettings.tabLockPassword) {
customTabPassword = userSettings.tabLockPassword;
}
// KullanÄ±cÄ± bazlÄ± sekme kilit listesini yÃ¼kle
if (userSettings.lockedTabs && Array.isArray(userSettings.lockedTabs)) {
window.lockedTabsConfig = userSettings.lockedTabs;
} else {
// KullanÄ±cÄ±nÄ±n kendi kilit listesi yoksa boÅŸ liste
window.lockedTabsConfig = [];
}
} else {
// KullanÄ±cÄ± ayarlarÄ± yoksa boÅŸ kilit listesi
window.lockedTabsConfig = [];
}
} catch (e) {
console.error('KullanÄ±cÄ± ÅŸifreleri yÃ¼klenirken hata:', e);
window.lockedTabsConfig = [];
}

// UI kÄ±sÄ±tlamalarÄ±nÄ± uygula (biraz gecikmeyle, UI yÃ¼klendikten sonra)
setTimeout(() => {
applyRoleRestrictions();
applyTabRestrictions();

// Bildirim butonunu sadece admin gÃ¶rsÃ¼n
const actBtn = document.getElementById('btn-activity-log');
if (actBtn && currentUserRole !== 'admin') {
actBtn.style.display = 'none';
}

// Admin log temizleme bÃ¶lÃ¼mÃ¼nÃ¼ sadece admin gÃ¶rsÃ¼n
const adminLogSection = document.getElementById('admin-log-clear-section');
if (adminLogSection) {
adminLogSection.style.display = (currentUserRole === 'Admin' || currentUserRole === 'admin') ? 'block' : 'none';
}
}, 2000);
}
});

// Sayfa yÃ¼klendiÄŸinde Lucide ikonlarÄ±nÄ± gÃ¼ncelle
document.addEventListener('DOMContentLoaded', () => {
setTimeout(() => {
if (typeof lucide !== 'undefined') lucide.createIcons();
}, 1000);
});
// ============================================
// SEKME BAZLI YETKÄ°LENDÄ°RME
// ============================================

const ALL_TABS = [
{ id: 'hastatakip', name: 'Hasta Takip' },
{ id: 'personel', name: 'Personel Takip' },
{ id: 'uzman', name: 'Uzman EÅŸleÅŸmeleri' },
{ id: 'analiz', name: 'GeÃ§miÅŸ Analiz' },
{ id: 'rutinler', name: 'GÃ¼nlÃ¼k Rutinler' },
{ id: 'acilcanta', name: 'Acil Ã‡anta' },
{ id: 'butce', name: 'BÃ¼tÃ§e Takip' },
{ id: 'notlar', name: 'Sor. Hem. NotlarÄ±' },
{ id: 'drnotlar', name: 'Dr NotlarÄ±' },
{ id: 'nobet', name: 'NÃ¶bet Listesi' },
{ id: 'cihazlar', name: 'Cihaz & Zimmet' },
{ id: 'istatistik', name: 'Ä°statistikler' },
{ id: 'puantaj', name: 'Puantaj' },
{ id: 'rehber', name: 'Rehber' },
{ id: 'takvim', name: 'Takvim' },
{ id: 'inrhesaplayici', name: 'Ä°NR HesaplayÄ±cÄ±' },
{ id: 'izinrapor', name: 'Ä°zin/Rapor' },
{ id: 'dogumgunu', name: 'DoÄŸum GÃ¼nÃ¼' },
{ id: 'pansuman', name: 'Pansuman' },
{ id: 'sondainr', name: 'Sonda, Ä°NR, NG' },
{ id: 'sokaksorgu', name: 'Sokak Sorgu' }
];

let currentUserAllowedTabs = [];

// Sekme kÄ±sÄ±tlamalarÄ±nÄ± uygula
function applyTabRestrictions() {
if (currentUserRole === ROLES.ADMIN) {
// Admin iÃ§in tÃ¼m sekmeleri gÃ¶ster (desktop)
document.querySelectorAll('.tab-btn').forEach(btn => {
btn.style.display = '';
btn.disabled = false;
});
// Admin iÃ§in tÃ¼m sekmeleri gÃ¶ster (mobil hamburger menÃ¼)
document.querySelectorAll('.mobile-tab-item').forEach(btn => {
btn.style.display = '';
});
return;
}

// Desktop sekme butonlarÄ± (.tab-btn)
document.querySelectorAll('.tab-btn').forEach(btn => {
const onclick = btn.getAttribute('onclick') || '';
const match = onclick.match(/switchTab\(['"](.+?)['"]\)/);
if (match) {
const tabId = match[1];
btn.style.display = currentUserAllowedTabs.includes(tabId) ? '' : 'none';
}
});

// Mobil hamburger menÃ¼deki sekmeler (.mobile-tab-item)
document.querySelectorAll('.mobile-tab-item').forEach(btn => {
const onclick = btn.getAttribute('onclick') || '';
const match = onclick.match(/switchTab\(['"](.+?)['"]\)/);
if (match) {
const tabId = match[1];
btn.style.display = currentUserAllowedTabs.includes(tabId) ? '' : 'none';
}
});
}

// KullanÄ±cÄ± yetkilerini kaydet
async function saveUserPermissions(emailKey) {
const roleSelect = document.getElementById(`role-select-${emailKey}`);
const tabsContainer = document.getElementById(`tabs-${emailKey}`);
const newRole = roleSelect.value;
const allowedTabs = [];

tabsContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
allowedTabs.push(cb.value);
});

try {
await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}`).update({
role: newRole,
allowedTabs: allowedTabs
});
showToast('Yetkiler gÃ¼ncellendi!', 'success');
await loadUserList();
} catch (error) {
showToast('GÃ¼ncelleme baÅŸarÄ±sÄ±z!', 'error');
}
}

// ============================================
// SITE Ä°Ã‡Ä° BÄ°LDÄ°RÄ°M SÄ°STEMÄ°
// ============================================

let inAppNotifications = [];
window.inAppNotifications = inAppNotifications; // Global eriÅŸim iÃ§in

// Bildirim panelini aÃ§/kapa
window.toggleNotificationPanel = function () {
const panel = document.getElementById('notification-panel');
const overlay = document.getElementById('notification-panel-overlay');
if (panel.classList.contains('translate-x-full')) {
panel.classList.remove('translate-x-full');
overlay.classList.remove('hidden');
} else {
panel.classList.add('translate-x-full');
overlay.classList.add('hidden');
}
};

window.closeNotificationPanel = function () {
const panel = document.getElementById('notification-panel');
const overlay = document.getElementById('notification-panel-overlay');
panel.classList.add('translate-x-full');
overlay.classList.add('hidden');
};

// Bildirim badge'ini gÃ¼ncelle
function updateNotificationBadge() {
const badge = document.getElementById('notification-badge');
const unreadCount = inAppNotifications.filter(n => !n.read).length;

if (unreadCount > 0) {
badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
badge.classList.remove('hidden');

// Sekme baÅŸlÄ±ÄŸÄ±nÄ± gÃ¼ncelle ve yanÄ±p sÃ¶nsÃ¼n
updateTabTitleWithNotification(unreadCount);
} else {
badge.classList.add('hidden');

// Sekme baÅŸlÄ±ÄŸÄ±nÄ± normale dÃ¶ndÃ¼r
stopTabTitleFlashing();
}
}

// ============================================
// SEKME BAÅLIÄI BÄ°LDÄ°RÄ°M SÄ°STEMÄ°
// ============================================

// Orijinal sayfa baÅŸlÄ±ÄŸÄ±
const originalPageTitle = 'Evde SaÄŸlÄ±k YÃ¶netimi';
let tabTitleFlashInterval = null;
let isFlashingTitle = false;

// Sekme baÅŸlÄ±ÄŸÄ±nÄ± bildirim sayÄ±sÄ±yla gÃ¼ncelle ve yanÄ±p sÃ¶nsÃ¼n
function updateTabTitleWithNotification(count) {
const notificationTitle = `ğŸ”” (${count}) Yeni Bildirim`;

// EÄŸer zaten yanÄ±p sÃ¶nÃ¼yorsa, sadece sayÄ±yÄ± gÃ¼ncelle
if (tabTitleFlashInterval) {
clearInterval(tabTitleFlashInterval);
}

isFlashingTitle = true;
let showNotification = true;

// Her 0.5 saniyede bir baÅŸlÄ±ÄŸÄ± deÄŸiÅŸtir (yanÄ±p sÃ¶nme efekti)
tabTitleFlashInterval = setInterval(() => {
if (showNotification) {
document.title = notificationTitle;
} else {
document.title = originalPageTitle;
}
showNotification = !showNotification;
}, 500);

// Ä°lk olarak bildirim baÅŸlÄ±ÄŸÄ±nÄ± gÃ¶ster
document.title = notificationTitle;
}

// YanÄ±p sÃ¶nmeyi durdur ve normale dÃ¶ndÃ¼r
function stopTabTitleFlashing() {
if (tabTitleFlashInterval) {
clearInterval(tabTitleFlashInterval);
tabTitleFlashInterval = null;
}
isFlashingTitle = false;
document.title = originalPageTitle;
}

// Sayfa odaklandÄ±ÄŸÄ±nda yanÄ±p sÃ¶nmeyi durdur (kullanÄ±cÄ± sayfaya dÃ¶ndÃ¼)
document.addEventListener('visibilitychange', () => {
if (!document.hidden && isFlashingTitle) {
// Sayfa gÃ¶rÃ¼nÃ¼r olduÄŸunda, okunmamÄ±ÅŸ bildirim yoksa yanÄ±p sÃ¶nmeyi durdur
const unreadCount = inAppNotifications.filter(n => !n.read).length;
if (unreadCount === 0) {
stopTabTitleFlashing();
}
}
});

// Bildirimleri render et
function renderNotifications() {
const listEl = document.getElementById('notification-list');
const countEl = document.getElementById('notification-count');

if (!listEl) return;

if (inAppNotifications.length === 0) {
listEl.innerHTML = '<div class="flex flex-col items-center justify-center text-gray-400 py-10"><svg class="w-10 h-10 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg><p class="text-sm font-medium">HenÃ¼z bildirim yok</p></div>';
if (countEl) countEl.textContent = '0 bildirim';
updateNotificationBadge();
return;
}

const sorted = [...inAppNotifications].sort((a, b) => b.timestamp - a.timestamp);

let html = '';
sorted.forEach(notif => {
const date = new Date(notif.timestamp);
const timeStr = date.toLocaleString('tr-TR', {
day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
});

// Tab adÄ±nÄ± belirle
let tabName = notif.tabId;
if (notif.tabId === 'islemplanla') tabName = 'TALEPLER';
else if (notif.tabId === 'islemplanla_not') tabName = 'ğŸ“ Talep Notu';
else if (notif.tabId === 'doktorailet') tabName = 'Doktor\'a Ä°let';
else if (notif.tabId === 'doktorailet_not') tabName = 'ğŸ“ Dr. Talep Notu';
else if (notif.tabId === 'sekreternot') tabName = 'Sekretere Not';
else if (notif.tabId === 'sekreternot_not') tabName = 'ğŸ“ Sek. Notu';
else if (notif.tabId === 'notlar') tabName = 'Notlar';
else {
const foundTab = ALL_TABS.find(t => t.id === notif.tabId);
if (foundTab) tabName = foundTab.name;
}

// Tab'a gÃ¶re arka plan rengi belirleme
let bgClass = notif.read ? 'bg-gray-50 border-gray-200' : 'bg-orange-50 border-orange-200';
if (!notif.read) {
if (notif.tabId === 'doktorailet' || notif.tabId === 'doktorailet_not') {
bgClass = 'bg-purple-50 border-purple-200'; // MOR
} else if (notif.tabId === 'islemplanla' || notif.tabId === 'islemplanla_not') {
bgClass = 'bg-red-50 border-red-200'; // KIRMIZI
} else if (notif.tabId === 'sekreternot' || notif.tabId === 'sekreternot_not') {
bgClass = 'bg-green-50 border-green-200'; // YEÅÄ°L
}
// drnotlar ve sorhemnotlar varsayÄ±lan turuncu kalÄ±r
}

html += `
<div class="p-3 rounded-lg border ${bgClass} transition cursor-pointer hover:shadow-md" onclick="navigateToNotification('${notif.tabId}', '${encodeURIComponent(notif.body)}', '${notif.id}')">
<div class="flex items-start justify-between gap-2">
<div class="flex-1">
<div class="font-bold text-sm text-gray-800">${notif.title}</div>
<div class="text-xs text-gray-600 mt-1">${notif.body}</div>
<div class="flex items-center gap-2 mt-2">
<span class="text-[10px] text-gray-400">${timeStr}</span>
<span class="text-[10px] bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded">${tabName}</span>
<span class="text-[10px] text-gray-500">ğŸ“ ${notif.from}</span>
</div>
</div>
<button onclick="event.stopPropagation(); deleteNotification('${notif.id}')" class="text-gray-400 hover:text-red-500 text-sm">âœ•</button>
</div>
${!notif.read ? `<button onclick="event.stopPropagation(); markNotificationRead('${notif.id}')" class="mt-2 text-[10px] text-blue-600 hover:text-blue-800">Okundu iÅŸaretle</button>` : ''}
</div>`;
});

listEl.innerHTML = html;
if (countEl) countEl.textContent = `${inAppNotifications.length} bildirim`;
updateNotificationBadge();
}

// Bildirime tÄ±klandÄ±ÄŸÄ±nda ilgili sekmeye git ve Ã¶ÄŸeyi vurgula
window.navigateToNotification = async function (tabId, encodedBody, notifId) {
const body = decodeURIComponent(encodedBody);

// Paneli kapat
closeNotificationPanel();

// Bildirimi okundu iÅŸaretle
markNotificationRead(notifId);

// Sekmeye gÃ¶re iÅŸlem yap
let targetTab = 'hastatakip';
let subtab = null;

// NOT bildirimleri iÃ§in ana tabId'ye dÃ¶nÃ¼ÅŸtÃ¼r
let effectiveTabId = tabId;
if (tabId === 'islemplanla_not') {
effectiveTabId = 'islemplanla';
} else if (tabId === 'doktorailet_not') {
effectiveTabId = 'doktorailet';
} else if (tabId === 'sekreternot_not') {
effectiveTabId = 'sekreternot';
}

if (effectiveTabId === 'islemplanla') {
targetTab = 'hastatakip';
subtab = 'islem';
} else if (effectiveTabId === 'doktorailet') {
targetTab = 'hastatakip';
subtab = 'doktor';
} else if (effectiveTabId === 'sekreternot') {
targetTab = 'hastatakip';
subtab = 'sekreter';
} else if (effectiveTabId === 'notlar') {
targetTab = 'notlar';
} else {
targetTab = effectiveTabId;
}

// Sekmeye geÃ§
if (typeof switchTab === 'function') {
switchTab(targetTab);
}

// Alt sekme varsa geÃ§
if (subtab && typeof switchPatientSubTab === 'function') {
setTimeout(() => {
switchPatientSubTab(subtab);
}, 500);
}

// Yeterince bekleyip Ã¶ÄŸeyi bul ve vurgula (sekme render'Ä± iÃ§in)
const waitTime = subtab ? 1200 : 800;
setTimeout(() => {
highlightNotificationTarget(effectiveTabId, body, notifId);
}, waitTime);
};

// Bildirimin hedefini vurgula
function highlightNotificationTarget(tabId, searchText, notifId = null) {
// Arama metninin ilk kÄ±smÄ±nÄ± al (hasta adÄ± veya not baÅŸlÄ±ÄŸÄ±)
const searchPart = searchText.split(' - ')[0].trim();

// Notif Ã¼zerinden itemId'yi al
let targetItemId = null;
if (notifId && window.inAppNotifications) {
const notif = window.inAppNotifications.find(n => n.id === notifId);
if (notif && notif.itemId) {
targetItemId = notif.itemId;
}
}

let targetElement = null;

// TÃ¼m tablo bazlÄ± sekmeler iÃ§in arama
if (tabId === 'islemplanla' || tabId === 'doktorailet' || tabId === 'sekreternot' || tabId === 'sondainr') {
// Aktif tab iÃ§indeki tabloda ara
const activeTab = document.querySelector('.tab-content:not(.hidden)');
if (activeTab) {
const rows = activeTab.querySelectorAll('table tbody tr');
rows.forEach(row => {
// Ã–nce itemId ile eÅŸleÅŸtir (daha kesin)
if (targetItemId) {
const hasMatchingId = row.innerHTML.includes(`(${targetItemId})`) || 
                      row.innerHTML.includes(`${targetItemId}`) ||
                      row.querySelector(`[onclick*="${targetItemId}"]`);
if (hasMatchingId) {
targetElement = row;
return;
}
}
// Fallback: metin aramasÄ±
if (row.textContent.includes(searchPart)) {
targetElement = row;
}
});
}
} else if (tabId === 'notlar' || tabId === 'sorhemnotlar') {
// Sor.Hem.Notlar listesinde ara
const noteItems = document.querySelectorAll('#general-notes-grid > div');
noteItems.forEach(item => {
if (item.textContent.includes(searchPart)) {
targetElement = item;
}
});
} else if (tabId === 'drnotlar') {
// Dr. Notlar listesinde ara
const noteItems = document.querySelectorAll('#dr-notes-grid > div');
noteItems.forEach(item => {
if (item.textContent.includes(searchPart)) {
targetElement = item;
}
});
} else {
// Genel arama - aktif tab'da herhangi bir table satÄ±rÄ± veya div
const activeTab = document.querySelector('.tab-content:not(.hidden)');
if (activeTab) {
// Ã–nce tablo satÄ±rlarÄ±nda ara
const rows = activeTab.querySelectorAll('table tbody tr');
rows.forEach(row => {
if (row.textContent.includes(searchPart)) {
targetElement = row;
}
});
// BulunamadÄ±ysa div'lerde ara
if (!targetElement) {
const divs = activeTab.querySelectorAll('div[class*="border"]');
divs.forEach(div => {
if (div.textContent.includes(searchPart)) {
targetElement = div;
}
});
}
}
}

if (targetElement) {
// Scroll container'Ä± bul - main iÃ§eriÄŸi veya tab container
let scrollContainer = targetElement.closest('.overflow-y-auto') ||
targetElement.closest('.tab-content') ||
targetElement.closest('main') ||
document.documentElement;

// Element'in pozisyonunu hesapla
const elementRect = targetElement.getBoundingClientRect();
const containerRect = scrollContainer.getBoundingClientRect ? scrollContainer.getBoundingClientRect() : { top: 0 };

// Hedef: ekranÄ±n ortasÄ±na getir
const viewportHeight = window.innerHeight;
const targetY = elementRect.top - (viewportHeight / 2) + (elementRect.height / 2);

// Window scroll yap
window.scrollTo({
top: window.scrollY + targetY,
behavior: 'smooth'
});

// AyrÄ±ca scrollIntoView de Ã§aÄŸÄ±r (yedek olarak)
setTimeout(() => {
targetElement.scrollIntoView({
behavior: 'smooth',
block: 'center',
inline: 'nearest'
});
}, 100);

// Turuncu Ã§erÃ§eve highlight efekti ekle (3 saniye)
targetElement.classList.add('notification-highlight');
targetElement.style.transition = 'all 0.3s ease';
targetElement.style.outline = '3px solid #f97316';
targetElement.style.outlineOffset = '2px';
targetElement.style.boxShadow = '0 0 15px rgba(249, 115, 22, 0.6)';
targetElement.style.background = 'rgba(251, 146, 60, 0.15)';
targetElement.style.transform = 'scale(1.01)';
targetElement.style.zIndex = '50';
targetElement.style.position = 'relative';

// 3 saniye sonra efekti kaldÄ±r
setTimeout(() => {
targetElement.style.outline = '';
targetElement.style.outlineOffset = '';
targetElement.style.boxShadow = '';
targetElement.style.background = '';
targetElement.style.transform = '';
targetElement.style.zIndex = '';
targetElement.style.position = '';
targetElement.classList.remove('notification-highlight');
}, 3000);
} else {
console.log('Hedef Ã¶ÄŸe bulunamadÄ±:', searchPart);
}
}

// Firebase'den bildirimleri dinle
function listenForInAppNotifications() {
if (!currentUser) return;

const emailKey = emailToKey(currentUser.email);

database.ref(`evde_saglik_ortak_veri/in_app_notifications/${emailKey}`).on('value', (snapshot) => {
const data = snapshot.val() || {};
inAppNotifications = Object.entries(data).map(([id, notif]) => ({
id,
...notif
}));
window.inAppNotifications = inAppNotifications; // Global eriÅŸim iÃ§in gÃ¼ncelle
renderNotifications();
});
}

// Bildirimi okundu iÅŸaretle
window.markNotificationRead = async function (notifId) {
if (!currentUser) return;
const emailKey = emailToKey(currentUser.email);
try {
await database.ref(`evde_saglik_ortak_veri/in_app_notifications/${emailKey}/${notifId}/read`).set(true);
} catch (error) {
console.error('Bildirim iÅŸaretleme hatasÄ±:', error);
}
};

// TÃ¼m bildirimleri okundu iÅŸaretle
window.markAllNotificationsRead = async function () {
if (!currentUser) return;
const emailKey = emailToKey(currentUser.email);
try {
const updates = {};
inAppNotifications.forEach(notif => {
updates[`${notif.id}/read`] = true;
});
await database.ref(`evde_saglik_ortak_veri/in_app_notifications/${emailKey}`).update(updates);
showToast('TÃ¼m bildirimler okundu iÅŸaretlendi', 'success');
} catch (error) {
console.error('Toplu iÅŸaretleme hatasÄ±:', error);
}
};

// Bildirimi sil
window.deleteNotification = async function (notifId) {
if (!currentUser) return;
const emailKey = emailToKey(currentUser.email);
try {
await database.ref(`evde_saglik_ortak_veri/in_app_notifications/${emailKey}/${notifId}`).remove();
} catch (error) {
console.error('Bildirim silme hatasÄ±:', error);
}
};

// TÃ¼m bildirimleri temizle
window.clearAllNotifications = async function () {
if (!currentUser) return;
if (!confirm('TÃ¼m bildirimleri silmek istediÄŸinize emin misiniz?')) return;
const emailKey = emailToKey(currentUser.email);
try {
await database.ref(`evde_saglik_ortak_veri/in_app_notifications/${emailKey}`).remove();
showToast('TÃ¼m bildirimler silindi', 'success');
} catch (error) {
console.error('Bildirimleri temizleme hatasÄ±:', error);
}
};

// Sekme bazlÄ± kullanÄ±cÄ±lara bildirim gÃ¶nder
window.sendInAppNotification = async function (tabId, title, body, itemId = null) {
const currentEmail = currentUser?.email;
if (!currentEmail) {
return;
}

try {
const snapshot = await database.ref('evde_saglik_ortak_veri/users_roles').once('value');
const allUsers = snapshot.val() || {};

let sentCount = 0;
for (const [key, userData] of Object.entries(allUsers)) {
const userEmail = userData.email || keyToEmail(key);

// Kendine bildirim gÃ¶nderme
if (userEmail === currentEmail) {
continue;
}

const settings = userData.notificationSettings;

if (settings && settings.enabled && settings.tabs && settings.tabs.includes(tabId)) {
// Bu kullanÄ±cÄ± bu sekme iÃ§in bildirim istiyor
const notificationData = {
title: title,
body: body,
tabId: tabId,
from: getNickname(currentEmail),
timestamp: Date.now(),
read: false
};

// itemId varsa ekle (vurgulama iÃ§in)
if (itemId) {
notificationData.itemId = itemId;
}

await database.ref(`evde_saglik_ortak_veri/in_app_notifications/${key}`).push(notificationData);
sentCount++;
} else {
console.log(`â© Atlanan (ayar yok veya sekme yok): ${userEmail}`,
'enabled:', settings?.enabled,
'tabs:', settings?.tabs,
'aranan sekme:', tabId);
}
}

} catch (error) {
console.error('Bildirim gÃ¶nderme hatasÄ±:', error);
}
};

// Bildirim ayarlarÄ±nÄ± kaydet
window.saveNotificationSettings = async function (emailKey) {
const enabledCheckbox = document.getElementById(`notif-enabled-${emailKey}`);
const tabsContainer = document.getElementById(`notif-tabs-${emailKey}`);
const enabled = enabledCheckbox ? enabledCheckbox.checked : false;
const tabs = [];

if (tabsContainer) {
tabsContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
tabs.push(cb.value);
});
}

console.log('ğŸ’¾ Bildirim ayarlarÄ± kaydediliyor:', {
emailKey: emailKey,
enabled: enabled,
tabs: tabs,
enabledCheckboxFound: !!enabledCheckbox,
tabsContainerFound: !!tabsContainer
});

try {
await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}/notificationSettings`).set({
enabled: enabled,
tabs: tabs
});
showToast('Bildirim ayarlarÄ± kaydedildi!', 'success');
await loadUserList();
if (typeof lucide !== 'undefined') lucide.createIcons();
} catch (error) {
console.error('Bildirim ayarlarÄ± kaydetme hatasÄ±:', error);
showToast('Bildirim ayarlarÄ± kaydedilemedi!', 'error');
}
};

// Auth deÄŸiÅŸikliÄŸinde bildirim dinleyicisini baÅŸlat
if (typeof auth !== 'undefined') {
auth.onAuthStateChanged((user) => {
if (user) {
setTimeout(listenForInAppNotifications, 2000);
}
});
}

</script>
<div id="user-management-modal"
class="fixed inset-0 bg-black/60 z-[100] hidden items-center justify-center p-4 backdrop-blur-sm">
<div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[85vh] flex flex-col modal-enter">
<div class="p-5 border-b flex justify-between items-center bg-yellow-50 rounded-t-xl">
<h3 class="text-lg font-bold text-yellow-800 flex items-center gap-2">
ğŸ‘¥ KullanÄ±cÄ± YÃ¶netimi
</h3>
<button onclick="closeUserManagementModal()"
class="text-gray-400 hover:text-red-500 text-xl font-bold">âœ•</button>
</div>
<div class="p-4 overflow-y-auto flex-grow">
<div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-700">
<strong>ğŸ‘‘ Admin:</strong> Tam yetki | <strong>ğŸ‘¤ KullanÄ±cÄ±:</strong> Veri giriÅŸi | <strong>ğŸ‘ï¸
GÃ¶rÃ¼ntÃ¼leyici:</strong> Sadece okuma
</div>

<div class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
<h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
<i data-lucide="settings" class="w-4 h-4"></i> YÃ¶netim AyarlarÄ±
</h4>
<div class="space-y-4">
<div>
<label class="block text-xs font-bold text-gray-500 uppercase mb-2">YÃ¶netim & Veri GiriÅŸi
Åifresi</label>
<div class="flex gap-2">
<input type="text" id="setting-admin-pass"
class="flex-1 p-2 border border-gray-300 rounded text-sm font-bold text-center tracking-widest focus:ring-2 focus:ring-red-500 outline-none"
placeholder="1234">
<button onclick="updateAdminPassword()"
class="bg-red-600 text-white px-3 py-2 rounded font-bold text-xs hover:bg-red-700 transition">GÃ¼ncelle</button>
</div>
<p class="text-[10px] text-gray-400 mt-1">* Kalem ikonuna basÄ±nca sorulan ÅŸifredir.</p>
</div>

<div class="flex items-center justify-between pt-2 border-t border-gray-200">
<div>
<label class="block text-xs font-bold text-gray-700 uppercase mb-1">Yeni Ãœye
KaydÄ±</label>
<p class="text-[10px] text-gray-400">KapalÄ±yken giriÅŸ ekranÄ±nda "KayÄ±t Ol" butonu
gizlenir.</p>
</div>
<label class="relative inline-flex items-center cursor-pointer">
<input type="checkbox" id="setting-reg-toggle"
onchange="updateRegistrationStatus(this.checked)" class="sr-only peer">
<div
class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
</div>
</label>
</div>
</div>
</div>

<div id="user-list-container" class="space-y-4"></div>
</div>
<div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-between items-center">
<button onclick="clearAllChatMessages()"
class="px-4 py-2 bg-red-500 text-white rounded-lg font-bold text-sm hover:bg-red-600 flex items-center gap-2">
ğŸ—‘ï¸ MesajlarÄ± Temizle
</button>
<button onclick="closeUserManagementModal()"
class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold text-sm hover:bg-gray-300">Kapat</button>
</div>
</div>
</div>
<div id="activity-log-panel"
class="fixed top-0 right-0 w-80 h-full bg-white shadow-2xl z-[200] transform translate-x-full transition-transform duration-300 border-l">
<div class="p-4 bg-gray-800 text-white flex justify-between items-center">
<h3 class="font-bold flex items-center gap-2">ğŸ”” Son Ä°ÅŸlemler</h3>
<button onclick="closeActivityLogPanel()" class="text-white/70 hover:text-white text-xl">âœ•</button>
</div>
<div class="p-2 bg-gray-100 border-b flex justify-between items-center">
<span class="text-[10px] text-gray-500" id="activity-count">0 kayÄ±t</span>
<button onclick="clearActivityLogs()"
class="text-[10px] text-red-500 hover:text-red-700 font-bold">Temizle</button>
</div>
<div id="activity-log-list" class="overflow-y-auto h-[calc(100%-100px)] p-2 space-y-2">
<p class="text-center text-gray-400 text-xs py-10">HenÃ¼z iÅŸlem yok</p>
</div>
</div>
<div id="activity-log-overlay" onclick="closeActivityLogPanel()" class="fixed inset-0 bg-black/30 z-[199] hidden">
</div>

<div id="notification-panel"
class="fixed top-0 right-0 w-80 h-full bg-white shadow-2xl z-[200] transform translate-x-full transition-transform duration-300 border-l">
<div class="p-4 bg-orange-600 text-white flex justify-between items-center">
<h3 class="font-bold flex items-center gap-2">ğŸ”” Bildirimler</h3>
<button onclick="closeNotificationPanel()" class="text-white/70 hover:text-white text-xl">âœ•</button>
</div>
<div class="p-2 bg-orange-50 border-b flex justify-between items-center">
<span class="text-[10px] text-gray-500" id="notification-count">0 bildirim</span>
<div class="flex gap-2">
<button onclick="markAllNotificationsRead()"
class="text-[10px] text-blue-600 hover:text-blue-800 font-bold">Okundu iÅŸaretle</button>
<button onclick="clearAllNotifications()"
class="text-[10px] text-red-500 hover:text-red-700 font-bold">Temizle</button>
</div>
</div>
<div id="notification-list" class="overflow-y-auto h-[calc(100%-100px)] p-2 space-y-2">
<p class="text-center text-gray-400 text-xs py-10">HenÃ¼z bildirim yok</p>
</div>
</div>
<div id="notification-panel-overlay" onclick="closeNotificationPanel()"
class="fixed inset-0 bg-black/30 z-[199] hidden">
</div>

<script>
// ============================================
// DOKTOR'A Ä°LET - VERÄ° VE FONKSÄ°YONLAR
// ============================================

// Global deÄŸiÅŸken - doctorRequestsList ana script bloÄŸunda tanÄ±mlÄ±
let editingDoctorRequestId = null;

// Alt sekme deÄŸiÅŸtirme fonksiyonu
function switchPatientSubTab(tabName) {
// TÃ¼m subtab iÃ§eriklerini gizle
document.querySelectorAll('#tab-hastatakip .subtab-content').forEach(el => {
el.classList.add('hidden');
});

// TÃ¼m subtab butonlarÄ±nÄ± pasif yap
document.querySelectorAll('#tab-hastatakip [id^="subtab-btn-"]').forEach(btn => {
btn.classList.remove('bg-white', 'text-indigo-700', 'shadow-sm', 'border', 'border-indigo-200', 'text-blue-700', 'border-blue-200', 'text-green-700', 'border-green-200');
btn.classList.add('bg-transparent', 'text-gray-600');
});

// SeÃ§ilen sekmeyi gÃ¶ster
const targetContent = document.getElementById('subtab-' + tabName);
const targetBtn = document.getElementById('subtab-btn-' + tabName);

if (targetContent) {
targetContent.classList.remove('hidden');
}

if (targetBtn) {
targetBtn.classList.remove('bg-transparent', 'text-gray-600');
targetBtn.classList.add('bg-white', 'shadow-sm', 'border');
if (tabName === 'islem') {
targetBtn.classList.add('text-indigo-700', 'border-indigo-200');
} else if (tabName === 'sekreter') {
targetBtn.classList.add('text-green-700', 'border-green-200');
} else {
targetBtn.classList.add('text-blue-700', 'border-blue-200');
}
}

// Export butonlarÄ±nÄ± gÃ¼ncelle
document.getElementById('export-btns-talepler')?.classList.add('hidden');
document.getElementById('export-btns-doktor')?.classList.add('hidden');
document.getElementById('export-btns-sekreter')?.classList.add('hidden');
if (tabName === 'islem') {
document.getElementById('export-btns-talepler')?.classList.remove('hidden');
} else if (tabName === 'doktor') {
document.getElementById('export-btns-doktor')?.classList.remove('hidden');
} else if (tabName === 'sekreter') {
document.getElementById('export-btns-sekreter')?.classList.remove('hidden');
}

// Ä°lgili listeyi render et
if (tabName === 'doktor') {
renderDoctorRequestsList();
// BugÃ¼nÃ¼n tarihini varsayÄ±lan olarak ayarla
const today = new Date().toISOString().split('T')[0];
const dateInput = document.getElementById('dr-date');
if (dateInput && !dateInput.value) {
dateInput.value = today;
}
} else if (tabName === 'sekreter') {
renderSecretaryNotesList();
// BugÃ¼nÃ¼n tarihini varsayÄ±lan olarak ayarla
const today = new Date().toISOString().split('T')[0];
const dateInput = document.getElementById('sek-date');
if (dateInput && !dateInput.value) {
dateInput.value = today;
}
}

// Sekme gÃ¶rÃ¼ntÃ¼lendiÄŸinde badge'i sÄ±fÄ±rla (kullanÄ±cÄ± bazlÄ±)
markTabAsViewed(tabName);

// Lucide ikonlarÄ± yenile
if (typeof lucide !== 'undefined') lucide.createIcons();
}

// Doktor talebi ekleme
function addDoctorRequest() {
const patientInput = document.getElementById('dr-patient');
const requestInput = document.getElementById('dr-request');
const dateInput = document.getElementById('dr-date');

const patient = patientInput?.value?.trim();
const request = requestInput?.value?.trim();
const date = dateInput?.value;

if (!patient) {
if (typeof showToast === 'function') showToast('LÃ¼tfen hasta adÄ± girin!', 'warning');
patientInput?.focus();
return;
}

if (!request) {
if (typeof showToast === 'function') showToast('LÃ¼tfen talebi yazÄ±n!', 'warning');
requestInput?.focus();
return;
}

if (!date) {
if (typeof showToast === 'function') showToast('LÃ¼tfen tarih seÃ§in!', 'warning');
dateInput?.focus();
return;
}

// KullanÄ±cÄ± bilgisini al (takma ad varsa takma ad, yoksa email)
const userEmail = currentUser?.email || 'Bilinmeyen';
const userName = getNickname(userEmail);

if (editingDoctorRequestId) {
// DÃ¼zenleme modu
const index = window.doctorRequestsList.findIndex(r => r.id === editingDoctorRequestId);
if (index !== -1) {
window.doctorRequestsList[index].patient = patient;
window.doctorRequestsList[index].request = request;
window.doctorRequestsList[index].date = date;
window.doctorRequestsList[index].lastModifiedBy = userName;
window.doctorRequestsList[index].lastModifiedAt = new Date().toISOString();
}
editingDoctorRequestId = null;
document.getElementById('btn-dr-save').innerHTML = '<i data-lucide="send" class="w-4 h-4"></i> <span>Doktora Ä°let</span>';
document.getElementById('btn-dr-cancel').classList.add('hidden');
if (typeof showToast === 'function') showToast('Talep gÃ¼ncellendi!', 'success');
addActivityLog('doctor_request', 'Doktor talebi dÃ¼zenlendi', `${patient} - ${request}`);
} else {
// Yeni kayÄ±t
const newRequest = {
id: Date.now(),
patient: patient,
request: request,
date: date,
createdBy: userName,
createdAt: new Date().toISOString()
};
window.doctorRequestsList.push(newRequest);
if (typeof showToast === 'function') showToast('Talep doktora iletildi!', 'success');
addActivityLog('doctor_request', 'Doktor talebi eklendi', `${patient} - ${request}`);

// Site iÃ§i bildirim gÃ¶nder
sendInAppNotification('doktorailet', 'ğŸ‘¨â€âš•ï¸ Yeni Doktor Talebi', `${patient} - ${request}`);

// Telegram bildirimi gÃ¶nder
if (isTelegramNotifyEnabled('doctor')) {
const addedBy = getNickname(currentUser?.email) || 'Bilinmeyen';
const now = new Date().toLocaleString('tr-TR');
const msg = `ğŸ©ºğŸ’ŠğŸ¥ <b>Yeni Doktor Talebi</b>\n\nğŸ‘¤ Hasta: ${patient}\nğŸ“‹ Talep: ${request}\nğŸ“… Tarih: ${formatDateTR(date)}\nğŸ‘¤ Ekleyen: ${addedBy}\nğŸ• Eklenme: ${now}`;
sendTelegramMessage(msg, 'doctor');
}
}

// Formu temizle
patientInput.value = '';
requestInput.value = '';
dateInput.value = new Date().toISOString().split('T')[0];

// Kaydet ve render et
saveDoctorRequests();
renderDoctorRequestsList();

// Lucide ikonlarÄ± yenile
if (typeof lucide !== 'undefined') lucide.createIcons();
}

// Talep silme
function deleteDoctorRequest(id) {
if (!confirm('Bu talebi silmek istediÄŸinize emin misiniz?')) return;

const request = window.doctorRequestsList.find(r => r.id === id);
const requestInfo = request ? `${request.patient || 'Hasta'} - ${request.request || 'Talep'}` : 'Doktor talebi';

window.doctorRequestsList = window.doctorRequestsList.filter(r => r.id !== id);
saveDoctorRequests();
renderDoctorRequestsList();

if (typeof showToast === 'function') showToast('Talep silindi!', 'info');
addActivityLog('doctor_request', 'Doktor talebi silindi', requestInfo);
}

// Talep dÃ¼zenleme
function editDoctorRequest(id) {
const request = window.doctorRequestsList.find(r => r.id === id);
if (!request) return;

editingDoctorRequestId = id;

document.getElementById('dr-patient').value = request.patient || '';
document.getElementById('dr-request').value = request.request || '';
document.getElementById('dr-date').value = request.date || '';

document.getElementById('btn-dr-save').innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4"></i> <span>GÃ¼ncelle</span>';
document.getElementById('btn-dr-cancel').classList.remove('hidden');

// Forma scroll
document.getElementById('dr-patient').focus();

if (typeof lucide !== 'undefined') lucide.createIcons();
}

// DÃ¼zenleme iptali
function cancelDoctorRequestEdit() {
editingDoctorRequestId = null;

document.getElementById('dr-patient').value = '';
document.getElementById('dr-request').value = '';
document.getElementById('dr-date').value = new Date().toISOString().split('T')[0];

document.getElementById('btn-dr-save').innerHTML = '<i data-lucide="send" class="w-4 h-4"></i> <span>Doktora Ä°let</span>';
document.getElementById('btn-dr-cancel').classList.add('hidden');

if (typeof lucide !== 'undefined') lucide.createIcons();
}

// Aktif sekme durumu (varsayÄ±lan: 'active')
window.drActiveTab = window.drActiveTab || 'active';

// Sekme deÄŸiÅŸtirme fonksiyonu
function switchDrTab(tab) {
window.drActiveTab = tab;

// Sekme butonlarÄ±nÄ± gÃ¼ncelle
const activeBtn = document.getElementById('dr-tab-active');
const historyBtn = document.getElementById('dr-tab-history');

if (activeBtn && historyBtn) {
if (tab === 'active') {
activeBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-blue-600 text-white transition';
historyBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition';
} else {
historyBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-blue-600 text-white transition';
activeBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition';
}
}

renderDoctorRequestsList();
}

// Debounce timer
let drSearchDebounceTimer = null;

// Arama fonksiyonu (Debounce ile)
function searchDoctorRequests(term) {
// Arama terimini hemen gÃ¼ncelle (filtering iÃ§in)
window.drSearchTerm = term.toLowerCase();

// Ã–nceki timer'Ä± iptal et
if (drSearchDebounceTimer) {
clearTimeout(drSearchDebounceTimer);
}

// 300ms bekle, sonra render et (hÄ±zlÄ± yazarken Ã§akÄ±ÅŸma olmaz)
drSearchDebounceTimer = setTimeout(() => {
// Mevcut cursor pozisyonunu al
const searchInput = document.getElementById('dr-search-input');
const cursorPos = searchInput ? searchInput.selectionStart : term.length;

renderDoctorRequestsList();

// Focus'u geri ver
requestAnimationFrame(() => {
const newInput = document.getElementById('dr-search-input');
if (newInput && document.activeElement !== newInput) {
newInput.focus();
newInput.setSelectionRange(cursorPos, cursorPos);
}
});
}, 300);
}

// AramayÄ± temizle
function clearDrSearch() {
window.drSearchTerm = '';
const searchInput = document.getElementById('dr-search-input');
if (searchInput) searchInput.value = '';
renderDoctorRequestsList();
}
// Liste render fonksiyonu
function renderDoctorRequestsList() {
const container = document.getElementById('doctor-requests-list');
const countBadge = document.getElementById('dr-count-badge');

if (!container) return;

const today = new Date().toISOString().split('T')[0];
const currentTab = window.drActiveTab || 'active';
const searchTerm = window.drSearchTerm || '';

// Sekme ve arama HTML
const tabsHtml = `
<div class="flex flex-col gap-2 mb-4">
<div class="flex gap-2 p-1 bg-gray-100 rounded-lg">
<button id="dr-tab-active" onclick="switchDrTab('active')"
class="${currentTab === 'active' ? 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-blue-600 text-white transition' : 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition'}">
ğŸ“‹ Aktif Talepler
</button>
<button id="dr-tab-history" onclick="switchDrTab('history')"
class="${currentTab === 'history' ? 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-blue-600 text-white transition' : 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition'}">
ğŸ“ GeÃ§miÅŸ
</button>
</div>
<div class="relative">
<i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
<input type="text" id="dr-search-input"
placeholder="Hasta adÄ± veya talep ara..."
value="${searchTerm}"
oninput="searchDoctorRequests(this.value)"
class="w-full pl-9 pr-8 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
${searchTerm ? `
<button onclick="clearDrSearch()" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
<i data-lucide="x" class="w-4 h-4"></i>
</button>
` : ''}
</div>
</div>
`;

// Liste boÅŸsa mesaj gÃ¶ster
if (!window.doctorRequestsList || window.doctorRequestsList.length === 0) {
container.innerHTML = tabsHtml + `
<div class="flex flex-col items-center justify-center h-full text-gray-400 py-20">
<i data-lucide="inbox" class="w-12 h-12 mb-3 opacity-50"></i>
<div class="flex flex-col items-center justify-center text-gray-400 py-8"><svg class="w-12 h-12 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><p class="text-sm font-medium">HenÃ¼z doktor talebi yok</p>
<p class="text-xs">Yeni talep eklemek iÃ§in formu kullanÄ±n</p>
</div>
`;
if (countBadge) countBadge.textContent = '0 KayÄ±t';
if (typeof lucide !== 'undefined') lucide.createIcons();
return;
}

// GÃ¶receli tarih formatÄ± fonksiyonu
function getRelativeDate(dateStr) {
const todayDate = new Date();
todayDate.setHours(0, 0, 0, 0);
const targetDate = new Date(dateStr);
targetDate.setHours(0, 0, 0, 0);

const diffTime = targetDate - todayDate;
const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

if (diffDays === 0) return 'BugÃ¼n';
if (diffDays === 1) return 'YarÄ±n';
if (diffDays === -1) return 'DÃ¼n';
if (diffDays > 1) return `${diffDays} gÃ¼n sonra`;
if (diffDays < -1) return `${Math.abs(diffDays)} gÃ¼n Ã¶nce`;
return dateStr;
}

// Sekmeye gÃ¶re filtrele
let filteredList;
if (currentTab === 'active') {
// Aktif: TamamlanmamÄ±ÅŸ ve iptal edilmemiÅŸ TÃœM talepler (geÃ§miÅŸ tarihli olanlar dahil)
filteredList = window.doctorRequestsList.filter(item => {
const status = item.status || 'pending';
// Aktif sekmede: sadece tamamlanmamÄ±ÅŸ ve iptal edilmemiÅŸ olanlar
return status !== 'completed' && status !== 'cancelled';
});
} else {
// GeÃ§miÅŸ: TamamlanmÄ±ÅŸ veya iptal edilmiÅŸ
filteredList = window.doctorRequestsList.filter(item => {
const status = item.status || 'pending';
// GeÃ§miÅŸ sekmede: tamamlanmÄ±ÅŸ veya iptal edilmiÅŸ
return status === 'completed' || status === 'cancelled';
});
}

// Arama filtresi uygula
if (searchTerm) {
filteredList = filteredList.filter(item => {
const patientMatch = item.patient && item.patient.toLowerCase().includes(searchTerm);
const requestMatch = item.request && item.request.toLowerCase().includes(searchTerm);
return patientMatch || requestMatch;
});
}

// Tarihe gÃ¶re kronolojik sÄ±rala (eski tarihler Ã¼stte)
const sortedList = [...filteredList].sort((a, b) => {
const dateA = new Date(a.date);
const dateB = new Date(b.date);
return dateA - dateB; // KÃ¼Ã§Ã¼k tarih Ã¶nce (eski tarihler Ã¼stte)
});

let html = tabsHtml;

// FiltrelenmiÅŸ liste boÅŸsa
if (sortedList.length === 0) {
html += `
<div class="flex flex-col items-center justify-center text-gray-400 py-10">
<i data-lucide="inbox" class="w-10 h-10 mb-2 opacity-50"></i>
<p class="text-sm font-medium">${currentTab === 'active' ? 'Aktif talep yok' : 'GeÃ§miÅŸ talep yok'}</p>
</div>
`;
container.innerHTML = html;
if (countBadge) countBadge.textContent = `${sortedList.length} KayÄ±t`;
if (typeof lucide !== 'undefined') lucide.createIcons();
return;
}

// Tablo baÅŸlÄ±ÄŸÄ±
html += `
<div class="overflow-x-auto">
<table class="w-full text-sm text-left">
<thead class="text-xs text-gray-800 uppercase bg-blue-50 border-b-2 border-blue-200 sticky top-0">
<tr>
<th class="px-4 py-3 border-2 border-gray-600 w-32 text-center font-extrabold">Tarih</th>
<th class="px-4 py-3 border-2 border-gray-600 w-72 text-center font-extrabold">Hasta Bilgisi</th>
<th class="px-4 py-3 border-2 border-gray-600 text-center font-extrabold">Not</th>
<th class="px-4 py-3 border-2 border-gray-600 w-64 text-center font-extrabold">Son Durum</th>
<th class="px-4 py-3 border-2 border-gray-600 w-48 text-center font-extrabold">YÃ¶net</th>
</tr>
</thead>
<tbody>
`;

sortedList.forEach(item => {
const isToday = item.date === today;
const isPast = item.date < today;

// GÃ¶receli tarih formatÄ±
const relativeDate = getRelativeDate(item.date);
const dateObj = new Date(item.date);
const formattedDate = dateObj.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });

// Durum bazlÄ± renk ÅŸemasÄ±
const status = item.status || 'pending';
let rowClass = 'hover:bg-gray-50';
let statusBadge = '';
let statusStyle = '';
let showActionButtons = true;

switch (status) {
case 'completed':
rowClass = 'bg-green-50/60 opacity-75';
statusBadge = `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold border border-green-200 block text-center mt-1">TAMAMLANDI</span>`;
statusStyle = 'line-through text-gray-400';
showActionButtons = false;
break;
case 'postponed':
rowClass = 'bg-amber-50';
const postponedFromDate = item.postponedFrom ? new Date(item.postponedFrom).toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '';
statusBadge = `<span class="text-amber-600 font-bold text-[10px] block mt-1">â³ ${postponedFromDate ? postponedFromDate + ' tarihinden ' : ''}ERTELENDÄ°</span>`;
break;
case 'cancelled':
rowClass = 'bg-gray-100 text-gray-400';
statusBadge = `<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-[10px] font-bold border border-red-200 block text-center mt-1">Ä°PTAL</span>`;
statusStyle = 'line-through';
showActionButtons = false;
break;
default: // pending
if (isToday) {
statusBadge = `<span class="text-green-600 font-bold text-[10px] block mt-1">BUGÃœN</span>`;
rowClass = 'bg-green-50 border-green-200';
} else if (isPast) {
statusBadge = `<span class="text-red-600 font-bold text-[10px] block mt-1">GEÃ‡TÄ°</span>`;
rowClass = 'bg-red-50';
} else {
const diffDays = Math.round((dateObj - new Date().setHours(0, 0, 0, 0)) / (1000 * 60 * 60 * 24));
statusBadge = `<span class="text-gray-500 text-[10px] block mt-1">${diffDays} GÃ¼n KaldÄ±</span>`;
}
}

// Aksiyon butonlarÄ±
let actionButtons = '';
if (showActionButtons) {
actionButtons = `
<div class="flex flex-wrap gap-1 justify-end">
<button onclick="editDoctorRequest(${item.id})" class="p-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg border border-blue-200 transition" title="DÃ¼zenle"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
<button onclick="setDoctorRequestStatus(${item.id}, 'completed')" class="p-2 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg border border-green-200 transition" title="TamamlandÄ±"><i data-lucide="check" class="w-4 h-4"></i></button>
<button onclick="postponeDoctorRequest(${item.id})" class="p-2 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-lg border border-orange-200 transition" title="Ertele"><i data-lucide="calendar-clock" class="w-4 h-4"></i></button>
<button onclick="setDoctorRequestStatus(${item.id}, 'cancelled')" class="p-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg border border-red-200 transition" title="Ä°ptal"><i data-lucide="x" class="w-4 h-4"></i></button>
</div>
`;
} else {
actionButtons = `
<div class="flex flex-wrap gap-1 justify-end">
<button onclick="setDoctorRequestStatus(${item.id}, 'pending')" class="p-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg border border-gray-200 transition" title="Geri Al"><i data-lucide="undo" class="w-4 h-4"></i></button>
<button onclick="deleteDoctorRequest(${item.id})" class="p-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg border border-red-200 transition" title="Sil"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
</div>
`;
}

html += `
<tr class="${rowClass} border-b border-gray-200">
<td class="px-4 py-3 border-2 border-gray-600">
<div class="font-bold text-sm ${statusStyle}">${formattedDate}</div>
${statusBadge}
</td>
<td class="px-4 py-3 border-2 border-gray-600">
<div class="flex items-center gap-2">
<span class="font-bold text-sm ${statusStyle}">${escapeHtml(item.patient)}</span>
</div>
<div class="text-[10px] text-gray-400 mt-1">
<i data-lucide="user" class="w-2.5 h-2.5 inline mr-0.5"></i>
Ekl: ${escapeHtml(item.createdBy || 'Bilinmiyor')}
</div>
${item.lastModifiedBy ? `
<div class="text-[10px] text-blue-500 mt-0.5">
<i data-lucide="edit-3" class="w-2.5 h-2.5 inline mr-0.5"></i>
Son: ${escapeHtml(item.lastModifiedBy)} â€¢ ${item.lastModifiedAt ? new Date(item.lastModifiedAt).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : ''}
</div>
` : ''}
</td>
<td class="px-4 py-3 border-2 border-gray-600">
<div class="text-sm ${statusStyle} whitespace-pre-line">${escapeHtml(item.request)}</div>
</td>
<td class="px-4 py-3 border-2 border-gray-600 bg-white/50 align-middle">
${!item.statusNote ? `
<div class="flex items-center justify-center h-full min-h-[60px]">
<button
onclick="document.getElementById('drNoteContainer-${item.id}').classList.remove('hidden'); document.getElementById('drEmptyNote-${item.id}').classList.add('hidden'); document.getElementById('drStatusNote-${item.id}').focus();"
id="drEmptyNote-${item.id}"
class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-2 transition shadow-sm border border-blue-200">
<i data-lucide="plus-circle" class="w-4 h-4"></i> Not Ekle
</button>
<div id="drNoteContainer-${item.id}" class="hidden w-full">
<div class="flex gap-1 items-start">
<textarea
id="drStatusNote-${item.id}"
class="flex-1 text-xs p-1.5 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none resize-none bg-white transition hover:border-blue-300"
rows="2"
placeholder="Durum notu gir..."></textarea>
<button
onclick="updateDrNote(${item.id}, document.getElementById('drStatusNote-${item.id}').value, true)"
class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1.5 rounded text-[10px] font-bold flex items-center gap-1 transition shadow-sm whitespace-nowrap"
title="Notu kaydet">
<i data-lucide="save" class="w-3 h-3"></i> Kaydet
</button>
</div>
</div>
</div>
` : `
<div class="flex gap-1 items-start">
<textarea
id="drStatusNote-${item.id}"
class="flex-1 text-xs p-1.5 border border-gray-300 rounded outline-none resize-none bg-gray-50 transition cursor-not-allowed"
rows="2"
readonly
placeholder="Durum notu...">${escapeHtml(item.statusNote || '')}</textarea>
<div class="flex flex-col gap-1">
<button
id="drSaveBtn-${item.id}"
onclick="updateDrNote(${item.id}, document.getElementById('drStatusNote-${item.id}').value, true)"
class="hidden bg-blue-600 hover:bg-blue-700 text-white px-2 py-1.5 rounded text-[10px] font-bold flex items-center gap-1 transition shadow-sm whitespace-nowrap"
title="Notu kaydet">
<i data-lucide="save" class="w-3 h-3"></i> Kaydet
</button>
<button
id="drEditBtn-${item.id}"
onclick="
const ta = document.getElementById('drStatusNote-${item.id}');
ta.readOnly = false;
ta.classList.remove('bg-gray-50', 'cursor-not-allowed');
ta.classList.add('bg-white', 'focus:ring-2', 'focus:ring-blue-500', 'hover:border-blue-300');
ta.focus();
document.getElementById('drSaveBtn-${item.id}').classList.remove('hidden');
document.getElementById('drEditBtn-${item.id}').classList.add('hidden');
"
class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1.5 rounded text-[10px] font-bold flex items-center gap-1 transition shadow-sm whitespace-nowrap"
title="Notu dÃ¼zenle">
<i data-lucide="edit-3" class="w-3 h-3"></i> DÃ¼zenle
</button>
</div>
</div>
<div class="text-[10px] text-gray-500 mt-1.5 flex items-center gap-1 border-t border-gray-200 pt-1">
<i data-lucide="user-check" class="w-3 h-3 text-blue-500"></i>
<span class="font-medium text-blue-600">${escapeHtml(item.statusNoteBy || 'Bilinmiyor')}</span>
${item.statusNoteAt ? `<span class="text-gray-400">â€¢ ${new Date(item.statusNoteAt).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}</span>` : ''}
</div>
`}
</td>
<td class="px-4 py-3 border-2 border-gray-600">
${actionButtons}
</td>
</tr>
`;
});

html += `
</tbody>
</table>
</div>
`;

container.innerHTML = html;
if (countBadge) countBadge.textContent = window.doctorRequestsList.length + ' KayÄ±t';

if (typeof lucide !== 'undefined') lucide.createIcons();

// Arama kutusuna focus'u geri ver
if (searchTerm) {
const searchInput = document.getElementById('dr-search-input');
if (searchInput) {
searchInput.focus();
searchInput.setSelectionRange(searchTerm.length, searchTerm.length);
}
}
}

// HTML escape fonksiyonu (gÃ¼venlik iÃ§in)
function escapeHtml(text) {
if (!text) return '';
const div = document.createElement('div');
div.textContent = text;
return div.innerHTML;
}

// Doktor talebi Son Durum notu gÃ¼ncelleme
window.updateDrNote = async function (id, value, showMessage = false) {
const index = window.doctorRequestsList.findIndex(r => r.id === id);
if (index === -1) return;

// KullanÄ±cÄ± bilgisini al (takma ad varsa takma ad, yoksa email)
let userEmail = 'Bilinmeyen';
if (typeof firebase !== 'undefined' && firebase.auth().currentUser) {
userEmail = firebase.auth().currentUser.email || 'Bilinmeyen';
}
const userName = getNickname(userEmail);

// Eski not deÄŸerini sakla (bildirim iÃ§in)
const oldNote = window.doctorRequestsList[index].statusNote || '';
const isNewNote = !oldNote && value;
const isEdit = oldNote && value && oldNote !== value;
const isDelete = oldNote && !value;

// Veriyi gÃ¼ncelle
window.doctorRequestsList[index].statusNote = value;
window.doctorRequestsList[index].statusNoteBy = userName;
window.doctorRequestsList[index].statusNoteAt = new Date().toISOString();

// Firebase'e kaydet
saveDoctorRequests();

// Kaydet butonuna tÄ±klandÄ±ÄŸÄ±nda mesaj gÃ¶ster ve listeyi yenile
if (showMessage) {
const item = window.doctorRequestsList[index];
if (typeof showToast === 'function') showToast('Not kaydedildi.');
addActivityLog('doctor_request', 'Doktor talebi notuna ekleme/dÃ¼zenleme', `${item.patient || 'Hasta'} - ${value.substring(0, 30)}${value.length > 30 ? '...' : ''}`);

// NOT Bildirimi gÃ¶nder (doktorailet_not tabId ile)
let notifTitle = '';
let notifBody = '';
if (isNewNote) {
notifTitle = 'ğŸ“ Dr. Talep Notu Eklendi';
notifBody = `${item.patient || 'Hasta'} - ${value.substring(0, 50)}${value.length > 50 ? '...' : ''}`;
} else if (isEdit) {
notifTitle = 'âœï¸ Dr. Talep Notu GÃ¼ncellendi';
notifBody = `${item.patient || 'Hasta'} - ${value.substring(0, 50)}${value.length > 50 ? '...' : ''}`;
} else if (isDelete) {
notifTitle = 'ğŸ—‘ï¸ Dr. Talep Notu Silindi';
notifBody = `${item.patient || 'Hasta'} - Not silindi`;
}

if (notifTitle) {
sendInAppNotification('doktorailet_not', notifTitle, notifBody, id);
}

renderDoctorRequestsList();
}
};

// Durum deÄŸiÅŸtirme fonksiyonu (TamamlandÄ±/Ertele/Ä°ptal/Geri Al)
function setDoctorRequestStatus(id, newStatus) {
const index = window.doctorRequestsList.findIndex(r => r.id === id);
if (index === -1) {
console.error('Talep bulunamadÄ±:', id);
return;
}

// KullanÄ±cÄ± bilgisini al (takma ad varsa takma ad, yoksa email)
let userEmail = 'Bilinmeyen';
if (typeof firebase !== 'undefined' && firebase.auth().currentUser) {
userEmail = firebase.auth().currentUser.email || 'Bilinmeyen';
}
const userName = getNickname(userEmail);

// Mevcut durumu kaydet (geri alma iÃ§in)
const currentStatus = window.doctorRequestsList[index].status || 'pending';
const today = new Date().toISOString().split('T')[0];

// EÄŸer geri alma iÅŸlemi ise, Ã¶nceki durumu kullan
let finalStatus = newStatus;
if (newStatus === 'pending' && window.doctorRequestsList[index].previousStatus) {
finalStatus = window.doctorRequestsList[index].previousStatus;
}

// Ã–nceki durumu kaydet (sadece yeni bir durum deÄŸiÅŸikliÄŸi ise)
if (newStatus !== 'pending') {
window.doctorRequestsList[index].previousStatus = currentStatus;
}

// Not: Geri alma iÅŸleminde tarih deÄŸiÅŸtirilmez
// BugÃ¼n veya gelecek tarihli iÅŸlemler Aktif'e, geÃ§miÅŸ tarihli olanlar GeÃ§miÅŸ'te kalÄ±r

// Durumu gÃ¼ncelle
window.doctorRequestsList[index].status = finalStatus;
window.doctorRequestsList[index].lastModifiedBy = userName;
window.doctorRequestsList[index].lastModifiedAt = new Date().toISOString();

// Duruma gÃ¶re mesaj gÃ¶ster
let statusMessage = '';
switch (finalStatus) {
case 'completed':
statusMessage = 'âœ“ Talep tamamlandÄ± olarak iÅŸaretlendi';
break;
case 'postponed':
statusMessage = newStatus === 'pending' ? 'â†© Talep ertelendi durumuna geri alÄ±ndÄ±' : 'â³ Talep ertelendi';
break;
case 'cancelled':
statusMessage = 'âœ• Talep iptal edildi';
break;
case 'pending':
statusMessage = 'â†© Talep durumu geri alÄ±ndÄ±';
break;
}

// Kaydet ve render et
saveDoctorRequests();
renderDoctorRequestsList();

// Aktivite logu ekle
const item = window.doctorRequestsList[index];
let logAction = 'Durum gÃ¼ncellendi';
if (finalStatus === 'completed') logAction = 'TamamlandÄ±';
else if (finalStatus === 'postponed') logAction = 'Ertelendi';
else if (finalStatus === 'cancelled') logAction = 'Ä°ptal edildi';
else if (newStatus === 'pending') logAction = 'Geri alÄ±ndÄ±';
addActivityLog('doctor_request', `Doktor talebi: ${logAction}`, `${item.patient || 'Hasta'} - ${item.request || 'Talep'}`);

if (typeof showToast === 'function') {
showToast(statusMessage, finalStatus === 'cancelled' ? 'warning' : 'success');
}

}

// Erteleme fonksiyonu - Tarih seÃ§ici ile
function postponeDoctorRequest(id) {
const request = window.doctorRequestsList.find(r => r.id === id);
if (!request) {
console.error('Talep bulunamadÄ±:', id);
return;
}

// Tarih seÃ§ici modalÄ± oluÅŸtur
const modalHtml = `
<div id="postpone-modal" class="fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center p-4">
<div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full">
<h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
<span class="text-2xl">ğŸ“…</span> Erteleme Tarihi SeÃ§
</h3>
<p class="text-sm text-gray-600 mb-4">
<strong>${escapeHtml(request.patient)}</strong> hastasÄ±nÄ±n talebini hangi gÃ¼ne ertelemek istiyorsunuz?
</p>
<input type="date" id="postpone-date-input"
class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 text-lg"
min="${new Date().toISOString().split('T')[0]}"
value="${request.date || new Date().toISOString().split('T')[0]}">
<div class="flex gap-2 mt-6">
<button onclick="closePostponeModal()"
class="flex-1 py-2.5 px-4 bg-gray-100 text-gray-700 rounded-lg font-bold hover:bg-gray-200 transition">
Ä°ptal
</button>
<button onclick="confirmPostpone(${id})"
class="flex-1 py-2.5 px-4 bg-amber-500 text-white rounded-lg font-bold hover:bg-amber-600 transition">
â³ Ertele
</button>
</div>
</div>
</div>
`;

// ModalÄ± ekle
document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Modal kapatma
function closePostponeModal() {
const modal = document.getElementById('postpone-modal');
if (modal) modal.remove();
}

// Erteleme onaylama
function confirmPostpone(id) {
const dateInput = document.getElementById('postpone-date-input');
const newDate = dateInput?.value;

if (!newDate) {
if (typeof showToast === 'function') showToast('LÃ¼tfen bir tarih seÃ§in!', 'warning');
return;
}

const index = window.doctorRequestsList.findIndex(r => r.id === id);
if (index === -1) return;

// KullanÄ±cÄ± bilgisini al (takma ad varsa takma ad, yoksa email)
let userEmail = 'Bilinmeyen';
if (typeof firebase !== 'undefined' && firebase.auth().currentUser) {
userEmail = firebase.auth().currentUser.email || 'Bilinmeyen';
}
const userName = getNickname(userEmail);

// Tarihi ve durumu gÃ¼ncelle
const oldDate = window.doctorRequestsList[index].date;
window.doctorRequestsList[index].date = newDate;
window.doctorRequestsList[index].status = 'postponed';
window.doctorRequestsList[index].lastModifiedBy = userName;
window.doctorRequestsList[index].lastModifiedAt = new Date().toISOString();
window.doctorRequestsList[index].postponedFrom = oldDate; // Eski tarihi sakla

// ModalÄ± kapat
closePostponeModal();

// Kaydet ve render et
saveDoctorRequests();
renderDoctorRequestsList();

// Tarih formatla
const formattedDate = new Date(newDate).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });

if (typeof showToast === 'function') {
showToast(`â³ Talep ${formattedDate} tarihine ertelendi`, 'success');
}

}

// Firebase'e kaydetme (ORTAK VERÄ° YOLU - tÃ¼m kullanÄ±cÄ±lar senkronize)
// Doktor taleplerini kaydet (ÅÄ°FRELEME DESTEKLÄ°)
async function saveDoctorRequests() {
const firebasePath = 'evde_saglik_ortak_veri/doctor_requests';

// Åifrele
const encryptedRequests = await Promise.all(
window.doctorRequestsList.map(async (r) => await encryptObject(r, ENCRYPTED_FIELDS.doctorRequests))
);

// Firebase baÄŸlantÄ±sÄ± kontrolÃ¼
if (typeof firebase !== 'undefined' && firebase.database) {
try {
await firebase.database().ref(firebasePath).set(encryptedRequests);
} catch (err) {
console.error('âŒ Firebase kaydetme hatasÄ±:', err);
}
} else {
// Fallback: localStorage'a kaydet
try {
localStorage.setItem('evdeSaglikDoctorRequests_V1', JSON.stringify(window.doctorRequestsList));
} catch (e) {
console.error('localStorage hatasÄ±:', e);
}
}
}

// Sayfa yÃ¼klendiÄŸinde verileri yÃ¼kle (ORTAK VERÄ° YOLU)
// Doktor taleplerini yÃ¼kle (ÅÄ°FRE Ã‡Ã–ZME DESTEKLÄ°)
async function loadDoctorRequests() {
const firebasePath = 'evde_saglik_ortak_veri/doctor_requests';

try {
// Firebase baÄŸlantÄ±sÄ± kontrolÃ¼
if (typeof firebase !== 'undefined' && firebase.database) {

// Firebase'den doÄŸrudan oku
const snapshot = await firebase.database().ref(firebasePath).once('value');
const value = snapshot.val();

if (value) {
let rawList = [];
if (Array.isArray(value)) {
rawList = value;
} else if (typeof value === 'object') {
rawList = Object.values(value);
}
// Åifreli alanlarÄ± Ã§Ã¶z
window.doctorRequestsList = await decryptArray(rawList, ENCRYPTED_FIELDS.doctorRequests);
} else {
window.doctorRequestsList = [];
}
} else {
// Firebase yoksa localStorage'dan oku
const data = localStorage.getItem('evdeSaglikDoctorRequests_V1');
if (data) {
const rawList = JSON.parse(data) || [];
window.doctorRequestsList = await decryptArray(rawList, ENCRYPTED_FIELDS.doctorRequests);
}
}

// Listeyi render et
if (typeof renderDoctorRequestsList === 'function') {
renderDoctorRequestsList();
}
} catch (e) {
console.error('âŒ Doktor talepleri yÃ¼klenirken hata:', e);
window.doctorRequestsList = [];
}
}

// Sayfa yÃ¼klendiÄŸinde Ã§alÄ±ÅŸtÄ±r
document.addEventListener('DOMContentLoaded', function () {
// Veriler Firebase'den yÃ¼klenene kadar bekle
setTimeout(() => {
loadDoctorRequests();
loadPuantajOverrides(); // Puantaj dÃ¼zenlemelerini yÃ¼kle

// Ã–ZEL CANLI SENKRONÄ°ZASYON - Firebase Real-time Listener
startDoctorRequestsRealtimeListener();
startPuantajOverridesRealtimeListener(); // Puantaj real-time listener
}, 2000);
});

// Puantaj overrides iÃ§in Ã¶zel Firebase real-time listener
function startPuantajOverridesRealtimeListener() {
if (typeof firebase === 'undefined' || !firebase.database) {
setTimeout(startPuantajOverridesRealtimeListener, 1000);
return;
}

const firebasePath = 'evde_saglik_ortak_veri/puantaj_overrides';
firebase.database().ref(firebasePath).on('value', (snapshot) => {
window.puantajOverrides = snapshot.val() || {};
// Puantaj sekmesi aÃ§Ä±ksa yenile
if (!document.getElementById('tab-puantaj').classList.contains('hidden')) {
renderPuantajTable();
}
});
}

// Doktor talepleri iÃ§in Ã¶zel Firebase real-time listener (ORTAK VERÄ° YOLU)
function startDoctorRequestsRealtimeListener() {
const firebasePath = 'evde_saglik_ortak_veri/doctor_requests';

// Firebase baÄŸlantÄ±sÄ±nÄ± kontrol et
const checkAndStartListener = () => {
// Firebase database eriÅŸimi kontrol
if (typeof firebase === 'undefined' || !firebase.database) {
setTimeout(checkAndStartListener, 1000);
return;
}

const dbRef = firebase.database().ref(firebasePath);

// Real-time listener ekle (ÅÄ°FRE Ã‡Ã–ZME DESTEKLÄ°)
dbRef.on('value', async (snapshot) => {
const value = snapshot.val();

// Global deÄŸiÅŸkeni gÃ¼ncelle
let rawList = [];
if (Array.isArray(value)) {
rawList = value;
} else if (value && typeof value === 'object') {
rawList = Object.values(value);
}

// Åifreyi Ã§Ã¶z
window.doctorRequestsList = await decryptArray(rawList, ENCRYPTED_FIELDS.doctorRequests);

// Listeyi render et
if (typeof renderDoctorRequestsList === 'function') {
renderDoctorRequestsList();
}
// Badge'leri gÃ¼ncelle
if (typeof updatePatientTabBadges === 'function') {
updatePatientTabBadges();
}
}, (error) => {
console.error('âŒ Firebase listener hatasÄ±:', error);
});
};

checkAndStartListener();
}

// ============================================
// TIBBÄ° SEKRETERE NOT SÄ°STEMÄ°
// ============================================

window.secretaryNotesList = window.secretaryNotesList || [];
let editingSecretaryNoteId = null;
window.sekActiveTab = window.sekActiveTab || 'active';
window.sekSearchTerm = '';

// Sekreter notu ekleme
function addSecretaryNote() {
const patientInput = document.getElementById('sek-patient');
const requestInput = document.getElementById('sek-request');
const dateInput = document.getElementById('sek-date');

const patient = patientInput?.value?.trim();
const request = requestInput?.value?.trim();
const date = dateInput?.value;

if (!patient) {
if (typeof showToast === 'function') showToast('LÃ¼tfen hasta adÄ± girin!', 'warning');
patientInput?.focus();
return;
}

if (!request) {
if (typeof showToast === 'function') showToast('LÃ¼tfen notu yazÄ±n!', 'warning');
requestInput?.focus();
return;
}

if (!date) {
if (typeof showToast === 'function') showToast('LÃ¼tfen tarih seÃ§in!', 'warning');
dateInput?.focus();
return;
}

const userEmail = currentUser?.email || 'Bilinmeyen';
const userName = getNickname(userEmail);

if (editingSecretaryNoteId) {
// DÃ¼zenleme modu
const index = window.secretaryNotesList.findIndex(r => r.id === editingSecretaryNoteId);
if (index !== -1) {
window.secretaryNotesList[index].patient = patient;
window.secretaryNotesList[index].request = request;
window.secretaryNotesList[index].date = date;
window.secretaryNotesList[index].lastModifiedBy = userName;
window.secretaryNotesList[index].lastModifiedAt = new Date().toISOString();
}
editingSecretaryNoteId = null;
document.getElementById('btn-sek-save').innerHTML = '<i data-lucide="send" class="w-4 h-4"></i> <span>Sekretere Ä°let</span>';
document.getElementById('btn-sek-cancel').classList.add('hidden');
if (typeof showToast === 'function') showToast('Not gÃ¼ncellendi!', 'success');
addActivityLog('secretary_note', 'Sekreter notu dÃ¼zenlendi', `${patient} - ${request}`);
} else {
// Yeni kayÄ±t
const newNote = {
id: Date.now(),
patient: patient,
request: request,
date: date,
createdBy: userEmail, // Email olarak kaydet
createdByName: userName, // Ä°sim ayrÄ± alana
createdAt: new Date().toISOString()
};
window.secretaryNotesList.push(newNote);
if (typeof showToast === 'function') showToast('Not sekretere iletildi!', 'success');
addActivityLog('secretary_note', 'Sekreter notu eklendi', `${patient} - ${request}`);

// Site iÃ§i bildirim gÃ¶nder
sendInAppNotification('sekreternot', 'ğŸ“‹ Yeni Sekreter Notu', `${patient} - ${request}`);
}

// Formu temizle
patientInput.value = '';
requestInput.value = '';
dateInput.value = new Date().toISOString().split('T')[0];

// Kaydet ve render et
saveSecretaryNotes();
renderSecretaryNotesList();
updatePatientTabBadges();

if (typeof lucide !== 'undefined') lucide.createIcons();
}

// Not silme
function deleteSecretaryNote(id) {
const note = window.secretaryNotesList.find(r => r.id === id);
if (!note) return;

// Sadece notu ekleyen kullanÄ±cÄ± veya admin silebilir
const isOwner = currentUser && note.createdBy === currentUser.email;
const isAdmin = currentUserRole === 'admin';

if (!isOwner && !isAdmin) {
showToast("Bu notu sadece ekleyen kullanÄ±cÄ± veya admin silebilir!", "error");
return;
}

if (!confirm('Bu notu silmek istediÄŸinize emin misiniz?')) return;

const noteInfo = note ? `${note.patient} - ${note.request}` : 'Sekreter notu';

window.secretaryNotesList = window.secretaryNotesList.filter(r => r.id !== id);
saveSecretaryNotes();
renderSecretaryNotesList();
updatePatientTabBadges();

if (typeof showToast === 'function') showToast('Not silindi!', 'info');
addActivityLog('secretary_note', 'Sekreter notu silindi', noteInfo);
}

// Not dÃ¼zenleme
function editSecretaryNote(id) {
const note = window.secretaryNotesList.find(r => r.id === id);
if (!note) return;

// Sadece notu ekleyen kullanÄ±cÄ± veya admin dÃ¼zenleyebilir
const isOwner = currentUser && note.createdBy === currentUser.email;
const isAdmin = currentUserRole === 'admin';

if (!isOwner && !isAdmin) {
showToast("Bu notu sadece ekleyen kullanÄ±cÄ± veya admin dÃ¼zenleyebilir!", "error");
return;
}

editingSecretaryNoteId = id;

document.getElementById('sek-patient').value = note.patient || '';
document.getElementById('sek-request').value = note.request || '';
document.getElementById('sek-date').value = note.date || '';

document.getElementById('btn-sek-save').innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4"></i> <span>GÃ¼ncelle</span>';
document.getElementById('btn-sek-cancel').classList.remove('hidden');

document.getElementById('sek-patient').focus();

if (typeof lucide !== 'undefined') lucide.createIcons();
}

// DÃ¼zenleme iptali
function cancelSecretaryNoteEdit() {
editingSecretaryNoteId = null;

document.getElementById('sek-patient').value = '';
document.getElementById('sek-request').value = '';
document.getElementById('sek-date').value = new Date().toISOString().split('T')[0];

document.getElementById('btn-sek-save').innerHTML = '<i data-lucide="send" class="w-4 h-4"></i> <span>Sekretere Ä°let</span>';
document.getElementById('btn-sek-cancel').classList.add('hidden');

if (typeof lucide !== 'undefined') lucide.createIcons();
}

// Notu tamamlandÄ± iÅŸaretle
function markSecretaryNoteComplete(id) {
const index = window.secretaryNotesList.findIndex(r => r.id === id);
if (index !== -1) {
window.secretaryNotesList[index].completed = true;
window.secretaryNotesList[index].completedBy = getNickname(currentUser?.email) || 'Bilinmeyen';
window.secretaryNotesList[index].completedAt = new Date().toISOString();
saveSecretaryNotes();
renderSecretaryNotesList();
updatePatientTabBadges();
if (typeof showToast === 'function') showToast('Not tamamlandÄ± olarak iÅŸaretlendi!', 'success');
}
}

// Tamamlanan notu geri al (aktife taÅŸÄ±)
function revertSecretaryNote(id) {
const index = window.secretaryNotesList.findIndex(r => r.id === id);
if (index !== -1) {
window.secretaryNotesList[index].completed = false;
window.secretaryNotesList[index].revertedBy = getNickname(currentUser?.email) || 'Bilinmeyen';
window.secretaryNotesList[index].revertedAt = new Date().toISOString();
// Tamamlayan bilgisini silmiyoruz, geÃ§miÅŸte kalsÄ±n
saveSecretaryNotes();
renderSecretaryNotesList();
updatePatientTabBadges();
if (typeof showToast === 'function') showToast('Not aktif listeye geri alÄ±ndÄ±!', 'success');
}
}

// Sekme deÄŸiÅŸtirme
function switchSekTab(tab) {
window.sekActiveTab = tab;
const activeBtn = document.getElementById('sek-tab-active');
const historyBtn = document.getElementById('sek-tab-history');
if (activeBtn && historyBtn) {
if (tab === 'active') {
activeBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-green-600 text-white transition';
historyBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition';
} else {
historyBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-green-600 text-white transition';
activeBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition';
}
}
renderSecretaryNotesList();
}

// Arama fonksiyonu
function searchSecretaryNotes(term) {
window.sekSearchTerm = term.toLowerCase();
renderSecretaryNotesList();
}

// Liste render
function renderSecretaryNotesList() {
const container = document.getElementById('secretary-notes-list');
const countBadge = document.getElementById('sek-count-badge');
if (!container) return;

let list = window.secretaryNotesList || [];
const showActive = window.sekActiveTab === 'active';

// Aktif/TamamlananlarÄ± filtrele
list = list.filter(r => showActive ? !r.completed : r.completed);

// Arama filtresi
if (window.sekSearchTerm) {
list = list.filter(r =>
(r.patient?.toLowerCase() || '').includes(window.sekSearchTerm) ||
(r.request?.toLowerCase() || '').includes(window.sekSearchTerm)
);
}

// Tarihe gÃ¶re sÄ±rala (en yeni en Ã¼stte)
list.sort((a, b) => new Date(b.date || b.createdAt) - new Date(a.date || a.createdAt));

if (countBadge) {
const activeCount = (window.secretaryNotesList || []).filter(r => !r.completed).length;
countBadge.textContent = `${activeCount} Aktif`;
}

// Sekme butonlarÄ± ve arama - her zaman gÃ¶ster
let html = `
<div class="flex gap-2 mb-3">
<button id="sek-tab-active" onclick="switchSekTab('active')"
class="${showActive ? 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-green-600 text-white transition' : 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition'}">
Aktif
</button>
<button id="sek-tab-history" onclick="switchSekTab('history')"
class="${!showActive ? 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-green-600 text-white transition' : 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition'}">
Tamamlanan
</button>
</div>
<div class="mb-3">
<input type="text" id="sek-search-input" placeholder="Ara..."
class="w-full p-2 border border-gray-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-green-500"
value="${window.sekSearchTerm || ''}" oninput="searchSecretaryNotes(this.value)">
</div>
`;

if (list.length === 0) {
html += `
<div class="text-center py-10 text-gray-400">
<i data-lucide="clipboard-x" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
<p class="text-sm">${showActive ? 'Aktif not bulunmuyor' : 'Tamamlanan not bulunmuyor'}</p>
</div>`;
container.innerHTML = html;
if (typeof lucide !== 'undefined') lucide.createIcons();
return;
}

// TABLO BAÅLANGICI
html += `
<div class="overflow-x-auto">
<table class="w-full text-sm border-collapse">
<thead>
<tr class="bg-green-100 text-green-800">
<th class="px-3 py-2 text-left text-xs font-bold uppercase border border-green-200 w-1/2">Hasta Bilgisi</th>
<th class="px-3 py-2 text-left text-xs font-bold uppercase border border-green-200 w-1/2">Son Durum</th>
<th class="px-3 py-2 text-center text-xs font-bold uppercase border border-green-200 w-24">Ä°ÅŸlem</th>
</tr>
</thead>
<tbody>
`;

list.forEach(note => {
const dateStr = note.date ? formatDateTR(note.date) : '-';
const createdAtStr = note.createdAt ? new Date(note.createdAt).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';
const lastModifiedAtStr = note.lastModifiedAt ? new Date(note.lastModifiedAt).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';
const completedAtStr = note.completedAt ? new Date(note.completedAt).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';

// createdBy gÃ¶sterimi iÃ§in - email veya isim
const createdByDisplay = note.createdByName || getNickname(note.createdBy) || note.createdBy || 'Bilinmeyen';

html += `
<tr class="${note.completed ? 'bg-gray-50 opacity-70' : 'bg-white hover:bg-green-50'} transition">
<td class="px-3 py-3 border border-green-200 align-top">
<div class="font-bold text-green-900 text-sm">${escapeHtml(note.patient || '')}</div>
<div class="text-xs text-gray-600 mt-1">${escapeHtml(note.request || '')}</div>

<div class="text-[10px] text-gray-500 mt-2 space-y-0.5 border-t border-green-100 pt-2">
<div class="flex items-center gap-1">
<i data-lucide="calendar" class="w-3 h-3 text-green-500"></i>
<span class="font-medium">Tarih:</span>
<span>${dateStr}</span>
</div>
<div class="flex items-center gap-1">
<i data-lucide="user-plus" class="w-3 h-3 text-blue-500"></i>
<span class="font-medium">Ekleyen:</span>
<span class="text-blue-600">${escapeHtml(createdByDisplay)}</span>
${createdAtStr ? `<span class="text-gray-400">â€¢ ${createdAtStr}</span>` : ''}
</div>
${note.lastModifiedBy ? `
<div class="flex items-center gap-1">
<i data-lucide="edit-3" class="w-3 h-3 text-orange-500"></i>
<span class="font-medium">Son DÃ¼zenleyen:</span>
<span class="text-orange-600">${escapeHtml(note.lastModifiedBy)}</span>
${lastModifiedAtStr ? `<span class="text-gray-400">â€¢ ${lastModifiedAtStr}</span>` : ''}
</div>
` : ''}
${note.completed && note.completedBy ? `
<div class="flex items-center gap-1">
<i data-lucide="check-circle" class="w-3 h-3 text-green-600"></i>
<span class="font-medium text-green-700">Tamamlayan:</span>
<span class="text-green-600">${escapeHtml(note.completedBy)}</span>
${completedAtStr ? `<span class="text-gray-400">â€¢ ${completedAtStr}</span>` : ''}
</div>
` : ''}
</div>
</td>

<td class="px-3 py-3 border border-green-200 align-top bg-white/50">
${!note.statusNote ? `
<div id="sekEmptyNote-${note.id}" class="flex items-center justify-center min-h-[60px]">
<button
onclick="document.getElementById('sekNoteContainer-${note.id}').classList.remove('hidden'); document.getElementById('sekEmptyNote-${note.id}').classList.add('hidden'); document.getElementById('sekStatusNote-${note.id}').focus();"
class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-2 transition shadow-sm border border-green-200">
<i data-lucide="plus-circle" class="w-4 h-4"></i> Not Ekle
</button>
</div>
<div id="sekNoteContainer-${note.id}" class="hidden">
<div class="flex gap-1 items-start">
<textarea
id="sekStatusNote-${note.id}"
class="flex-1 text-xs p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none resize-none bg-white transition hover:border-green-300"
rows="2"
placeholder="Not yazÄ±n..."></textarea>
<button
onclick="updateSekNote(${note.id}, document.getElementById('sekStatusNote-${note.id}').value, true)"
class="bg-green-600 hover:bg-green-700 text-white px-2 py-1.5 rounded text-[10px] font-bold flex items-center gap-1 transition shadow-sm whitespace-nowrap"
title="Notu kaydet">
<i data-lucide="save" class="w-3 h-3"></i> Kaydet
</button>
</div>
</div>
${note.statusNoteDeletedBy ? `
<div class="text-[10px] text-red-500 mt-2 flex items-center gap-1 border-t border-red-100 pt-2">
<i data-lucide="trash-2" class="w-3 h-3"></i>
<span class="font-medium">Ã–nceki not silindi:</span>
<span>${escapeHtml(note.statusNoteDeletedBy)}</span>
${note.statusNoteDeletedAt ? `<span class="text-gray-400">â€¢ ${new Date(note.statusNoteDeletedAt).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}</span>` : ''}
</div>
` : ''}
` : `
<div class="flex gap-1 items-start">
<textarea
id="sekStatusNote-${note.id}"
class="flex-1 text-xs p-2 border border-gray-300 rounded-lg outline-none resize-none bg-gray-50 transition cursor-not-allowed"
rows="2"
readonly>${escapeHtml(note.statusNote || '')}</textarea>
<div class="flex flex-col gap-1">
<button
id="sekSaveBtn-${note.id}"
onclick="updateSekNote(${note.id}, document.getElementById('sekStatusNote-${note.id}').value, true)"
class="hidden bg-green-600 hover:bg-green-700 text-white px-2 py-1.5 rounded text-[10px] font-bold flex items-center gap-1 transition shadow-sm whitespace-nowrap"
title="Notu kaydet">
<i data-lucide="save" class="w-3 h-3"></i> Kaydet
</button>
<button
id="sekEditBtn-${note.id}"
onclick="
const ta = document.getElementById('sekStatusNote-${note.id}');
ta.readOnly = false;
ta.classList.remove('bg-gray-50', 'cursor-not-allowed');
ta.classList.add('bg-white', 'focus:ring-2', 'focus:ring-green-500', 'hover:border-green-300');
ta.focus();
document.getElementById('sekSaveBtn-${note.id}').classList.remove('hidden');
document.getElementById('sekEditBtn-${note.id}').classList.add('hidden');
document.getElementById('sekDeleteNoteBtn-${note.id}').classList.add('hidden');
"
class="bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1.5 rounded text-[10px] font-bold flex items-center gap-1 transition shadow-sm whitespace-nowrap"
title="Notu dÃ¼zenle">
<i data-lucide="edit-3" class="w-3 h-3"></i> DÃ¼zenle
</button>
<button
id="sekDeleteNoteBtn-${note.id}"
onclick="deleteSekNote(${note.id})"
class="bg-red-100 hover:bg-red-200 text-red-600 px-2 py-1.5 rounded text-[10px] font-bold flex items-center gap-1 transition shadow-sm whitespace-nowrap"
title="Notu sil">
<i data-lucide="trash-2" class="w-3 h-3"></i> Sil
</button>
</div>
</div>
<div class="text-[10px] text-gray-500 mt-2 flex flex-wrap items-center gap-x-2 gap-y-1 border-t border-green-100 pt-2">
<div class="flex items-center gap-1">
<i data-lucide="user-plus" class="w-3 h-3 text-green-500"></i>
<span class="font-medium text-green-600">Ekl: ${escapeHtml(note.statusNoteBy || 'Bilinmiyor')}</span>
${note.statusNoteAt ? `<span class="text-gray-400">â€¢ ${new Date(note.statusNoteAt).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}</span>` : ''}
</div>
${note.statusNoteLastEditBy ? `
<div class="flex items-center gap-1">
<i data-lucide="edit-3" class="w-3 h-3 text-blue-500"></i>
<span class="font-medium text-blue-600">Son DÃ¼z: ${escapeHtml(note.statusNoteLastEditBy)}</span>
${note.statusNoteLastEditAt ? `<span class="text-gray-400">â€¢ ${new Date(note.statusNoteLastEditAt).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}</span>` : ''}
</div>
` : ''}
</div>
`}
</td>

<td class="px-3 py-3 border border-green-200 align-middle text-center">
<div class="flex flex-col gap-1 items-center flex-wrap">
${!note.completed ? `
<button onclick="markSecretaryNoteComplete(${note.id})" class="p-1.5 bg-green-100 hover:bg-green-200 rounded text-green-600" title="TamamlandÄ±">
<i data-lucide="check" class="w-4 h-4"></i>
</button>
${(currentUser && note.createdBy === currentUser.email) || currentUserRole === 'admin' ? `
<button onclick="editSecretaryNote(${note.id})" class="p-1.5 bg-blue-100 hover:bg-blue-200 rounded text-blue-600" title="DÃ¼zenle">
<i data-lucide="pencil" class="w-4 h-4"></i>
</button>
` : ''}
` : `
<button onclick="revertSecretaryNote(${note.id})" class="p-1.5 bg-orange-100 hover:bg-orange-200 rounded text-orange-600" title="Geri Al - Aktife TaÅŸÄ±">
<i data-lucide="undo-2" class="w-4 h-4"></i>
</button>
`}
${(currentUser && note.createdBy === currentUser.email) || currentUserRole === 'admin' ? `
<button onclick="deleteSecretaryNote(${note.id})" class="p-1.5 bg-red-100 hover:bg-red-200 rounded text-red-600" title="Sil">
<i data-lucide="trash-2" class="w-4 h-4"></i>
</button>
` : ''}
</div>
</td>
</tr>
`;
});

html += `
</tbody>
</table>
</div>
`;

container.innerHTML = html;
if (typeof lucide !== 'undefined') lucide.createIcons();
}

// Sekreter notu Son Durum notu gÃ¼ncelleme
window.updateSekNote = async function (id, value, showMessage = false) {
const index = window.secretaryNotesList.findIndex(r => r.id === id);
if (index === -1) return;

// KullanÄ±cÄ± bilgisini al
let userEmail = 'Bilinmeyen';
if (typeof firebase !== 'undefined' && firebase.auth().currentUser) {
userEmail = firebase.auth().currentUser.email || 'Bilinmeyen';
}
const userName = getNickname(userEmail);
const now = new Date().toISOString();

// Ä°lk kez mi ekleniyor yoksa dÃ¼zenleme mi?
const isFirstTime = !window.secretaryNotesList[index].statusNote;
const oldNote = window.secretaryNotesList[index].statusNote || '';
const isEdit = oldNote && value && oldNote !== value;

// Veriyi gÃ¼ncelle
window.secretaryNotesList[index].statusNote = value;

if (isFirstTime) {
// Ä°lk ekleme
window.secretaryNotesList[index].statusNoteBy = userName;
window.secretaryNotesList[index].statusNoteAt = now;
// Yeni not eklendiÄŸinde silen bilgisini temizle
window.secretaryNotesList[index].statusNoteDeletedBy = null;
window.secretaryNotesList[index].statusNoteDeletedAt = null;
} else {
// DÃ¼zenleme - son dÃ¼zenleyeni kaydet
window.secretaryNotesList[index].statusNoteLastEditBy = userName;
window.secretaryNotesList[index].statusNoteLastEditAt = now;
}

// Firebase'e kaydet
saveSecretaryNotes();

if (showMessage) {
const item = window.secretaryNotesList[index];
if (typeof showToast === 'function') showToast('Not kaydedildi.', 'success');
if (typeof addActivityLog === 'function') {
addActivityLog('secretary_note', 'Sekreter notuna ekleme/dÃ¼zenleme', `${item.patient || 'Hasta'} - ${value.substring(0, 30)}${value.length > 30 ? '...' : ''}`);
}

// NOT Bildirimi gÃ¶nder (sekreternot_not tabId ile)
let notifTitle = '';
let notifBody = '';
if (isFirstTime && value) {
notifTitle = 'ğŸ“ Sek. Not Eklendi';
notifBody = `${item.patient || 'Hasta'} - ${value.substring(0, 50)}${value.length > 50 ? '...' : ''}`;
} else if (isEdit) {
notifTitle = 'âœï¸ Sek. Not GÃ¼ncellendi';
notifBody = `${item.patient || 'Hasta'} - ${value.substring(0, 50)}${value.length > 50 ? '...' : ''}`;
}

if (notifTitle) {
sendInAppNotification('sekreternot_not', notifTitle, notifBody, id);
}

renderSecretaryNotesList();
}
};

// Sekreter notu silme
window.deleteSekNote = async function (id) {
if (!confirm('Bu notu silmek istediÄŸinize emin misiniz?')) return;

const index = window.secretaryNotesList.findIndex(r => r.id === id);
if (index === -1) return;

// Hasta bilgisini al (bildirim iÃ§in)
const item = window.secretaryNotesList[index];
const patientName = item.patient || 'Hasta';

// KullanÄ±cÄ± bilgisini al
let userEmail = 'Bilinmeyen';
if (typeof firebase !== 'undefined' && firebase.auth().currentUser) {
userEmail = firebase.auth().currentUser.email || 'Bilinmeyen';
}
const userName = getNickname(userEmail);
const now = new Date().toISOString();

// Not alanlarÄ±nÄ± temizle ama silen bilgisini kaydet
window.secretaryNotesList[index].statusNote = null;
window.secretaryNotesList[index].statusNoteBy = null;
window.secretaryNotesList[index].statusNoteAt = null;
window.secretaryNotesList[index].statusNoteLastEditBy = null;
window.secretaryNotesList[index].statusNoteLastEditAt = null;

// Silen bilgisini kaydet
window.secretaryNotesList[index].statusNoteDeletedBy = userName;
window.secretaryNotesList[index].statusNoteDeletedAt = now;

// Firebase'e kaydet
saveSecretaryNotes();

if (typeof showToast === 'function') showToast('Not silindi.', 'success');

// NOT Bildirimi gÃ¶nder
sendInAppNotification('sekreternot_not', 'ğŸ—‘ï¸ Sek. Not Silindi', `${patientName} - Not silindi`, id);

renderSecretaryNotesList();
};

// Firebase'e kaydetme
async function saveSecretaryNotes() {
const firebasePath = 'evde_saglik_ortak_veri/secretary_notes';
if (typeof firebase !== 'undefined' && firebase.database) {
try {
await firebase.database().ref(firebasePath).set(window.secretaryNotesList);
} catch (err) {
console.error('âŒ Sekreter notlarÄ± kayÄ±t hatasÄ±:', err);
}
}
}

// Firebase'den yÃ¼kleme
async function loadSecretaryNotes() {
const firebasePath = 'evde_saglik_ortak_veri/secretary_notes';
try {
if (typeof firebase !== 'undefined' && firebase.database) {
const snapshot = await firebase.database().ref(firebasePath).once('value');
const value = snapshot.val();
if (value) {
window.secretaryNotesList = Array.isArray(value) ? value : Object.values(value);
} else {
window.secretaryNotesList = [];
}
renderSecretaryNotesList();
updatePatientTabBadges();
}
} catch (e) {
console.error('âŒ Sekreter notlarÄ± yÃ¼klenemedi:', e);
}
}

// CanlÄ± senkronizasyon
function startSecretaryNotesRealtimeListener() {
const firebasePath = 'evde_saglik_ortak_veri/secretary_notes';
const checkAndStart = () => {
if (typeof firebase === 'undefined' || !firebase.database) {
setTimeout(checkAndStart, 1000);
return;
}
firebase.database().ref(firebasePath).on('value', (snapshot) => {
const value = snapshot.val();
window.secretaryNotesList = value ? (Array.isArray(value) ? value : Object.values(value)) : [];
renderSecretaryNotesList();
updatePatientTabBadges();
});
};
checkAndStart();
}

// TALEPLER (patientReminders) iÃ§in canlÄ± Firebase dinleyicisi
function startPatientRemindersRealtimeListener() {
const firebasePath = 'evde_saglik_ortak_veri/evdeSaglikReminders_V1';
const checkAndStart = () => {
if (typeof firebase === 'undefined' || !firebase.database) {
setTimeout(checkAndStart, 1000);
return;
}
firebase.database().ref(firebasePath).on('value', async (snapshot) => {
const value = snapshot.val();

let rawList = [];
if (Array.isArray(value)) {
rawList = value;
} else if (value && typeof value === 'object') {
rawList = Object.values(value);
}

// Åifreyi Ã§Ã¶z (eÄŸer ÅŸifreli ise)
if (typeof decryptArray === 'function' && ENCRYPTED_FIELDS && ENCRYPTED_FIELDS.patientReminders) {
window.patientReminders = await decryptArray(rawList, ENCRYPTED_FIELDS.patientReminders);
} else {
window.patientReminders = rawList;
}

// Listeyi render et
if (typeof renderPatientReminders === 'function') {
renderPatientReminders();
}

// Badge'leri gÃ¼ncelle
if (typeof updatePatientTabBadges === 'function') {
updatePatientTabBadges();
}
}, (error) => {
console.error('âŒ TALEPLER listener hatasÄ±:', error);
});
};
checkAndStart();
}

// KullanÄ±cÄ± bazlÄ± son gÃ¶rÃ¼ntÃ¼leme zamanlarÄ±
window.userTabViewTimes = window.userTabViewTimes || {};

// Firebase'den son gÃ¶rÃ¼ntÃ¼leme zamanlarÄ±nÄ± yÃ¼kle
async function loadUserTabViewTimes() {
if (!currentUser || !currentUser.email) return;
const userEmailKey = currentUser.email.replace(/\./g, '_').replace(/@/g, '_at_');
const firebasePath = `evde_saglik_ortak_veri/user_tab_views/${userEmailKey}`;

try {
if (typeof firebase !== 'undefined' && firebase.database) {
const snapshot = await firebase.database().ref(firebasePath).once('value');
const value = snapshot.val();
if (value) {
window.userTabViewTimes = value;
}
}
} catch (e) {
console.error('Tab view times yÃ¼klenemedi:', e);
}
}

// Sekme gÃ¶rÃ¼ntÃ¼lendiÄŸinde zamanÄ± kaydet
async function markTabAsViewed(tabName) {
if (!currentUser || !currentUser.email) return;
const userEmailKey = currentUser.email.replace(/\./g, '_').replace(/@/g, '_at_');
const firebasePath = `evde_saglik_ortak_veri/user_tab_views/${userEmailKey}/${tabName}`;

const now = new Date().toISOString();
window.userTabViewTimes[tabName] = now;

try {
if (typeof firebase !== 'undefined' && firebase.database) {
await firebase.database().ref(firebasePath).set(now);
}
} catch (e) {
console.error('Tab view time kaydedilemedi:', e);
}

// Sekme adÄ±nÄ± bildirim tabId'sine Ã§evir
let notifTabId = null;
if (tabName === 'islem') notifTabId = 'islemplanla';
else if (tabName === 'doktor') notifTabId = 'doktorailet';
else if (tabName === 'sekreter') notifTabId = 'sekreternot';

// Bu sekmeye ait okunmamÄ±ÅŸ bildirimleri okundu olarak iÅŸaretle
if (notifTabId && window.inAppNotifications && window.inAppNotifications.length > 0) {
const unreadNotifs = window.inAppNotifications.filter(n => !n.read && n.tabId === notifTabId);
if (unreadNotifs.length > 0) {
for (const notif of unreadNotifs) {
if (typeof window.markNotificationRead === 'function') {
await window.markNotificationRead(notif.id);
}
}
}
}

// Badge'leri gÃ¼ncelle
updatePatientTabBadges();
}

// Badge gÃ¼ncelleme fonksiyonu (kullanÄ±cÄ± bazlÄ±)
function updatePatientTabBadges() {
const viewTimes = window.userTabViewTimes || {};
// Mevcut kullanÄ±cÄ±nÄ±n takma adÄ±nÄ± al
const currentUserName = currentUser && currentUser.email ? getNickname(currentUser.email) : null;

// Doktor badge - son gÃ¶rÃ¼ntÃ¼lemeden sonra eklenen aktif talepler (kendi eklediÄŸi hariÃ§)
const doktorBadge = document.getElementById('doktor-badge');
const lastDoktorView = viewTimes.doktor ? new Date(viewTimes.doktor) : new Date(0);
const newDoktorCount = (window.doctorRequestsList || []).filter(r => {
if (r.completed) return false;
// Kendi eklediÄŸi kayÄ±tlarÄ± sayma
if (currentUserName && r.createdBy === currentUserName) return false;
const createdAt = r.createdAt ? new Date(r.createdAt) : new Date(0);
return createdAt > lastDoktorView;
}).length;

if (doktorBadge) {
if (newDoktorCount > 0) {
doktorBadge.textContent = newDoktorCount;
doktorBadge.classList.remove('hidden');
doktorBadge.classList.add('flex');
} else {
doktorBadge.classList.add('hidden');
doktorBadge.classList.remove('flex');
}
}

// Sekreter badge - son gÃ¶rÃ¼ntÃ¼lemeden sonra eklenen aktif notlar (kendi eklediÄŸi hariÃ§)
const sekreterBadge = document.getElementById('sekreter-badge');
const lastSekreterView = viewTimes.sekreter ? new Date(viewTimes.sekreter) : new Date(0);
const newSekreterCount = (window.secretaryNotesList || []).filter(r => {
if (r.completed) return false;
// Kendi eklediÄŸi kayÄ±tlarÄ± sayma
if (currentUserName && r.createdBy === currentUserName) return false;
const createdAt = r.createdAt ? new Date(r.createdAt) : new Date(0);
return createdAt > lastSekreterView;
}).length;

if (sekreterBadge) {
if (newSekreterCount > 0) {
sekreterBadge.textContent = newSekreterCount;
sekreterBadge.classList.remove('hidden');
sekreterBadge.classList.add('flex');
} else {
sekreterBadge.classList.add('hidden');
sekreterBadge.classList.remove('flex');
}
}

// Ä°ÅŸlem badge - son gÃ¶rÃ¼ntÃ¼lemeden sonra eklenen aktif iÅŸlemler (kendi eklediÄŸi hariÃ§)
const islemBadge = document.getElementById('islem-badge');
const lastIslemView = viewTimes.islem ? new Date(viewTimes.islem) : new Date(0);
const newIslemCount = (window.patientReminders || []).filter(r => {
if (r.completed) return false;
// Kendi eklediÄŸi kayÄ±tlarÄ± sayma
if (currentUserName && r.createdBy === currentUserName) return false;
const createdAt = r.createdAt ? new Date(r.createdAt) : new Date(0);
return createdAt > lastIslemView;
}).length;

if (islemBadge) {
if (newIslemCount > 0) {
islemBadge.textContent = newIslemCount;
islemBadge.classList.remove('hidden');
islemBadge.classList.add('flex');
} else {
islemBadge.classList.add('hidden');
islemBadge.classList.remove('flex');
}
}
}

// Sayfa yÃ¼klendiÄŸinde Ã§alÄ±ÅŸtÄ±r
document.addEventListener('DOMContentLoaded', function () {
setTimeout(() => {
loadSecretaryNotes();
startSecretaryNotesRealtimeListener();
startPatientRemindersRealtimeListener(); // TALEPLER iÃ§in canlÄ± dinleyici
loadUserTabViewTimes().then(() => {
updatePatientTabBadges();
});
}, 2500);
});

// ============================================
// SEKME SIRALAMA SÄ°STEMÄ°
// ============================================

// VarsayÄ±lan sekme sÄ±rasÄ± ve tanÄ±mlarÄ±
const DEFAULT_TAB_ORDER = [
{ id: 'hastatakip', name: 'Hasta Takip', icon: null },
{ id: 'personel', name: 'Personel Takip', icon: null },
{ id: 'uzman', name: 'Uzman EÅŸleÅŸmeleri', icon: null },
{ id: 'analiz', name: 'GeÃ§miÅŸ Analiz', icon: null },
{ id: 'rutinler', name: 'GÃ¼nlÃ¼k Rutinler', icon: null },
{ id: 'acilcanta', name: 'Acil Ã‡anta Takip', icon: null },
{ id: 'butce', name: 'BÃ¼tÃ§e Takip', icon: null },
{ id: 'notlar', name: 'Sor. Hem. NotlarÄ±', icon: null },
{ id: 'drnotlar', name: 'Dr NotlarÄ±', icon: 'stethoscope' },
{ id: 'nobet', name: 'NÃ¶bet Listesi', icon: null },
{ id: 'cihazlar', name: 'Cihaz & Zimmet', icon: null },
{ id: 'istatistik', name: 'Ä°statistikler', icon: 'pie-chart' },
{ id: 'puantaj', name: 'Puantaj', icon: 'calculator' },
{ id: 'rehber', name: 'Rehber', icon: 'phone' },
{ id: 'takvim', name: 'Takvim', icon: 'calendar' },
{ id: 'inrhesaplayici', name: 'Ä°NR HesaplayÄ±cÄ±', icon: 'activity' },
{ id: 'izinrapor', name: 'Ä°zin/Rapor', icon: 'calendar-off' },
{ id: 'dogumgunu', name: 'DoÄŸum GÃ¼nÃ¼', icon: 'cake' },
{ id: 'pansuman', name: 'Pansuman', icon: 'bandage' },
{ id: 'sondainr', name: 'Sonda, Ä°NR, NG', icon: 'activity' },
{ id: 'sokaksorgu', name: 'Sokak Sorgu', icon: 'map-pin' }
];

// Global deÄŸiÅŸken: mevcut sekme sÄ±rasÄ±
window.currentTabOrder = [...DEFAULT_TAB_ORDER];

// Firebase'den sekme sÄ±rasÄ±nÄ± yÃ¼kle (kullanÄ±cÄ±ya Ã¶zel)
async function loadTabOrder() {
try {
if (typeof FirebaseStorage !== 'undefined' && currentUser) {
// KullanÄ±cÄ±ya Ã¶zel key oluÅŸtur
const userKey = currentUser.email.replace(/[.@]/g, '_');
const saved = await FirebaseStorage.getItem(`evdeSaglikTabOrder_${userKey}`);
if (saved) {
const order = typeof saved === 'string' ? JSON.parse(saved) : saved;
if (Array.isArray(order) && order.length > 0) {
// KaydedilmiÅŸ sÄ±rayÄ± uygula, eksik sekmeleri ekle
const savedIds = order.map(t => t.id);
window.currentTabOrder = [...order];

// Yeni eklenen sekmeleri sona ekle
DEFAULT_TAB_ORDER.forEach(tab => {
if (!savedIds.includes(tab.id)) {
window.currentTabOrder.push(tab);
}
});

}
}
}
} catch (error) {
console.error('Sekme sÄ±rasÄ± yÃ¼klenirken hata:', error);
}

// Sekme butonlarÄ±nÄ± render et
renderTabButtons();
}

// Sekme ikonlarÄ± mapping
const TAB_ICONS = {
'hastatakip': 'heart-pulse',
'personel': 'users',
'uzman': 'user-check',
'analiz': 'bar-chart-3',
'rutinler': 'repeat',
'acilcanta': 'briefcase-medical',
'butce': 'wallet',
'notlar': 'sticky-note',
'drnotlar': 'stethoscope',
'nobet': 'moon',
'cihazlar': 'monitor-smartphone',
'istatistik': 'pie-chart',
'puantaj': 'calculator',
'rehber': 'phone',
'takvim': 'calendar',
'inrhesaplayici': 'activity',
'dogumgunu': 'cake',
'pansuman': 'bandage',
'sondainr': 'syringe',
'izinrapor': 'calendar-off',
'sokaksorgu': 'map-pin'
};

const TAB_COLORS = {
'hastatakip': 'text-indigo-600',
'personel': 'text-blue-600',
'uzman': 'text-purple-600',
'analiz': 'text-emerald-600',
'rutinler': 'text-orange-600',
'acilcanta': 'text-red-600',
'butce': 'text-green-600',
'notlar': 'text-yellow-600',
'drnotlar': 'text-blue-600',
'nobet': 'text-indigo-600',
'cihazlar': 'text-gray-600',
'istatistik': 'text-pink-600',
'puantaj': 'text-cyan-600',
'rehber': 'text-green-600',
'takvim': 'text-blue-600',
'inrhesaplayici': 'text-red-600',
'dogumgunu': 'text-pink-500',
'pansuman': 'text-orange-500',
'sondainr': 'text-teal-600',
'izinrapor': 'text-orange-600',
'sokaksorgu': 'text-red-500'
};

// Sekme butonlarÄ±nÄ± render et (MasaÃ¼stÃ¼ + Mobil)
function renderTabButtons() {
const desktopContainer = document.getElementById('ust-menu');
const mobileContainer = document.getElementById('mobile-tab-dropdown');

// Aktif sekmeyi bul
const activeTab = document.querySelector('.tab-content:not(.hidden)');
const activeId = activeTab ? activeTab.id.replace('tab-', '') : 'hastatakip';

// ===== MASAÃœSTÃœ MENÃœ =====
if (desktopContainer) {
const buttons = desktopContainer.querySelectorAll('.tab-btn');
buttons.forEach(btn => btn.remove());

window.currentTabOrder.forEach(tab => {
if (tab.hidden) return; // Gizli sekmeleri atla

const defaultTab = DEFAULT_TAB_ORDER.find(d => d.id === tab.id);
const displayName = defaultTab ? defaultTab.name : tab.name;
const icon = TAB_ICONS[tab.id] || 'circle';

const btn = document.createElement('button');
btn.className = `tab-btn flex-shrink-0 px-3 py-2.5 text-xs font-medium border-b-2 ${tab.id === activeId ? 'border-indigo-600 text-indigo-700' : 'border-transparent text-gray-500 hover:text-gray-700'} focus:outline-none whitespace-nowrap flex items-center gap-1`;
btn.setAttribute('onclick', `switchTab('${tab.id}')`);
btn.setAttribute('data-tab-id', tab.id);
btn.innerHTML = `<i data-lucide="${icon}" class="w-3.5 h-3.5"></i> ${displayName}`;

desktopContainer.appendChild(btn);
});
}

// ===== MOBÄ°L MENÃœ =====
if (mobileContainer) {
const gridContainer = mobileContainer.querySelector('.grid');
if (gridContainer) {
gridContainer.innerHTML = '';

window.currentTabOrder.forEach(tab => {
if (tab.hidden) return; // Gizli sekmeleri atla

const defaultTab = DEFAULT_TAB_ORDER.find(d => d.id === tab.id);
const displayName = defaultTab ? defaultTab.name : tab.name;
const icon = TAB_ICONS[tab.id] || 'circle';
const color = TAB_COLORS[tab.id] || 'text-gray-600';

const btn = document.createElement('button');
btn.className = `mobile-tab-item flex items-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-700 hover:bg-indigo-50 rounded-lg transition ${tab.id === activeId ? 'bg-indigo-100 text-indigo-700' : ''}`;
btn.setAttribute('onclick', `switchTab('${tab.id}'); toggleMobileTabMenu();`);
btn.setAttribute('data-tab-id', tab.id);
btn.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 ${color}"></i> ${displayName}`;

gridContainer.appendChild(btn);
});
}
}

// Lucide ikonlarÄ±nÄ± gÃ¼ncelle
if (typeof lucide !== 'undefined') lucide.createIcons();

// Rol bazlÄ± sekme kÄ±sÄ±tlamalarÄ±nÄ± uygula
if (typeof applyTabRestrictions === 'function') {
setTimeout(() => applyTabRestrictions(), 100);
}

// Admin-only butonlarÄ± kontrol et
applyAdminOnlyButtons();
}

// Admin-only butonlarÄ± gizle/gÃ¶ster
function applyAdminOnlyButtons() {
const adminBtns = document.querySelectorAll('.admin-only-btn');
const isAdmin = window.currentUserRole === 'admin';

adminBtns.forEach(btn => {
if (isAdmin) {
btn.classList.remove('hidden');
} else {
btn.classList.add('hidden');
}
});
}

// Sekme sÄ±ralama modalÄ±nÄ± aÃ§
window.openTabSortModal = function () {
const modal = document.getElementById('tab-sort-modal');
const listContainer = document.getElementById('tab-sort-list');

if (!modal || !listContainer) return;

// Listeyi doldur
let html = '';
window.currentTabOrder.forEach((tab, index) => {
const isHidden = tab.hidden === true;
const defaultTab = DEFAULT_TAB_ORDER.find(d => d.id === tab.id);
const displayName = defaultTab ? defaultTab.name : tab.name;
const icon = TAB_ICONS[tab.id] || 'circle';

html += `
<div class="tab-sort-item flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200 cursor-grab hover:bg-purple-50 hover:border-purple-300 transition ${isHidden ? 'opacity-50' : ''}"
draggable="true"
data-tab-id="${tab.id}"
data-index="${index}">
<i data-lucide="grip-vertical" class="w-4 h-4 text-gray-400 flex-shrink-0"></i>
<label class="flex items-center gap-2 flex-1 cursor-pointer">
<input type="checkbox" class="tab-visibility-checkbox rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" 
data-tab-id="${tab.id}" ${!isHidden ? 'checked' : ''} onchange="toggleTabVisibility('${tab.id}', this.checked)">
<span class="text-sm font-medium text-gray-700"><i data-lucide="${icon}" class="w-4 h-4 inline mr-1"></i> ${displayName}</span>
</label>
<span class="text-[10px] text-gray-400 bg-gray-100 px-2 py-0.5 rounded">${index + 1}</span>
</div>
`;
});
listContainer.innerHTML = html;

// Drag & drop event'leri ekle
initTabSortDragDrop();

// ModalÄ± gÃ¶ster
modal.classList.remove('hidden');
modal.classList.add('flex');

if (typeof lucide !== 'undefined') lucide.createIcons();
};

// Sekme gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ deÄŸiÅŸtir
window.toggleTabVisibility = function(tabId, isVisible) {
const tabIndex = window.currentTabOrder.findIndex(t => t.id === tabId);
if (tabIndex !== -1) {
window.currentTabOrder[tabIndex].hidden = !isVisible;

// Item'Ä±n opacity'sini gÃ¼ncelle
const item = document.querySelector(`.tab-sort-item[data-tab-id="${tabId}"]`);
if (item) {
if (isVisible) {
item.classList.remove('opacity-50');
} else {
item.classList.add('opacity-50');
}
}
}
};

// Drag & drop baÅŸlat (MasaÃ¼stÃ¼ + Mobil Touch DesteÄŸi)
function initTabSortDragDrop() {
const listContainer = document.getElementById('tab-sort-list');
const items = listContainer.querySelectorAll('.tab-sort-item');

let draggedItem = null;
let touchStartY = 0;
let touchCurrentItem = null;

items.forEach(item => {
// === MASAÃœSTÃœ: Mouse Drag Events ===
item.addEventListener('dragstart', (e) => {
draggedItem = item;
item.classList.add('opacity-50', 'bg-purple-100');
e.dataTransfer.effectAllowed = 'move';
});

item.addEventListener('dragend', () => {
draggedItem = null;
item.classList.remove('opacity-50', 'bg-purple-100');
updateSortIndexes();
});

item.addEventListener('dragover', (e) => {
e.preventDefault();
e.dataTransfer.dropEffect = 'move';

if (draggedItem && draggedItem !== item) {
const rect = item.getBoundingClientRect();
const midY = rect.top + rect.height / 2;

if (e.clientY < midY) {
item.parentNode.insertBefore(draggedItem, item);
} else {
item.parentNode.insertBefore(draggedItem, item.nextSibling);
}
}
});

// === MOBÄ°L: Touch Events ===
item.addEventListener('touchstart', (e) => {
touchStartY = e.touches[0].clientY;
touchCurrentItem = item;
draggedItem = item;
item.classList.add('opacity-50', 'bg-purple-100', 'scale-105');
item.style.zIndex = '100';
}, { passive: true });

item.addEventListener('touchmove', (e) => {
if (!draggedItem || draggedItem !== item) return;

e.preventDefault();
const touchY = e.touches[0].clientY;

// DiÄŸer itemlarÄ± kontrol et
const allItems = listContainer.querySelectorAll('.tab-sort-item');
allItems.forEach(otherItem => {
if (otherItem === item) return;

const rect = otherItem.getBoundingClientRect();
const midY = rect.top + rect.height / 2;

if (touchY > rect.top && touchY < rect.bottom) {
if (touchY < midY) {
listContainer.insertBefore(item, otherItem);
} else {
listContainer.insertBefore(item, otherItem.nextSibling);
}
}
});
}, { passive: false });

item.addEventListener('touchend', () => {
if (draggedItem === item) {
item.classList.remove('opacity-50', 'bg-purple-100', 'scale-105');
item.style.zIndex = '';
draggedItem = null;
touchCurrentItem = null;
updateSortIndexes();
}
}, { passive: true });
});
}

// SÄ±ralama indexlerini gÃ¼ncelle
function updateSortIndexes() {
const items = document.querySelectorAll('#tab-sort-list .tab-sort-item');
items.forEach((item, index) => {
const badge = item.querySelector('.bg-gray-100');
if (badge) badge.textContent = index + 1;
});
}

// Sekme sÄ±rasÄ±nÄ± kaydet
window.saveTabOrder = async function () {
const items = document.querySelectorAll('#tab-sort-list .tab-sort-item');
const newOrder = [];

items.forEach(item => {
const tabId = item.getAttribute('data-tab-id');
const checkbox = item.querySelector('.tab-visibility-checkbox');
const isHidden = checkbox ? !checkbox.checked : false;

const tabDef = DEFAULT_TAB_ORDER.find(t => t.id === tabId) || window.currentTabOrder.find(t => t.id === tabId);
if (tabDef) {
newOrder.push({ ...tabDef, hidden: isHidden });
}
});

if (newOrder.length > 0) {
window.currentTabOrder = newOrder;

// KullanÄ±cÄ±ya Ã¶zel Firebase key ile kaydet
try {
if (typeof FirebaseStorage !== 'undefined' && currentUser) {
const userKey = currentUser.email.replace(/[.@]/g, '_');
await FirebaseStorage.setItem(`evdeSaglikTabOrder_${userKey}`, JSON.stringify(newOrder));
}
} catch (error) {
console.error('Sekme sÄ±rasÄ± kaydedilemedi:', error);
}

// Sekme butonlarÄ±nÄ± yeniden render et
renderTabButtons();

// ModalÄ± kapat
closeTabSortModal();

if (typeof showToast === 'function') showToast('Sekme sÄ±ralamasÄ± ve gÃ¶rÃ¼nÃ¼rlÃ¼k kaydedildi!');
}
};

// VarsayÄ±lan sÄ±raya dÃ¶n
window.resetTabOrder = async function () {
window.currentTabOrder = [...DEFAULT_TAB_ORDER];

// Firebase'den sil
try {
if (typeof database !== 'undefined' && userDataPath) {
await database.ref(`${userDataPath}/evdeSaglikTabOrder_V1`).remove();
}
} catch (error) {
console.error('Sekme sÄ±rasÄ± sÄ±fÄ±rlanamadÄ±:', error);
}

// Sekme butonlarÄ±nÄ± yeniden render et
renderTabButtons();

// ModalÄ± kapat
closeTabSortModal();

if (typeof showToast === 'function') showToast('Sekme sÄ±rasÄ± varsayÄ±lana dÃ¶ndÃ¼rÃ¼ldÃ¼!');
};

// ModalÄ± kapat
window.closeTabSortModal = function () {
const modal = document.getElementById('tab-sort-modal');
if (modal) {
modal.classList.add('hidden');
modal.classList.remove('flex');
}
};

// Sayfa yÃ¼klendiÄŸinde sekme sÄ±rasÄ±nÄ± yÃ¼kle
document.addEventListener('DOMContentLoaded', () => {
// Biraz gecikme ile yÃ¼kle (auth iÅŸlemleri tamamlandÄ±ktan sonra)
setTimeout(() => {
if (currentUser) {
loadTabOrder();
}
}, 3000);
});

// Auth deÄŸiÅŸikliÄŸinde sekme sÄ±rasÄ±nÄ± yÃ¼kle
if (typeof auth !== 'undefined') {
auth.onAuthStateChanged((user) => {
if (user) {
setTimeout(loadTabOrder, 2500);
}
});
}

// ============================================
// PROFÄ°LÄ°M MODAL FONKSÄ°YONLARI
// ============================================

// Profil modalÄ±nÄ± aÃ§
window.openProfileModal = async function () {
const modal = document.getElementById('profile-modal');
if (!modal) return;

// KullanÄ±cÄ± bilgilerini doldur
const emailSpan = document.getElementById('profile-email');
const nicknameDisplay = document.getElementById('profile-nickname-display');
const roleDiv = document.getElementById('profile-role');

if (currentUser) {
// Email
if (emailSpan) emailSpan.textContent = currentUser.email || '-';

// Takma ad (salt okunur)
if (nicknameDisplay) {
const nickname = getNickname(currentUser.email);
nicknameDisplay.textContent = nickname || '-';
}

// Rol
if (roleDiv && typeof currentUserRole !== 'undefined') {
const roleLabels = {
'admin': 'ğŸ‘‘ YÃ¶netici (Admin)',
'user': 'ğŸ‘¤ KullanÄ±cÄ± (User)',
'viewer': 'ğŸ‘ï¸ Ä°zleyici (Viewer)'
};
const roleColors = {
'admin': 'text-yellow-700 bg-yellow-50',
'user': 'text-blue-700 bg-blue-50',
'viewer': 'text-gray-600 bg-gray-100'
};
roleDiv.textContent = roleLabels[currentUserRole] || currentUserRole;
roleDiv.className = `p-3 rounded-lg border border-gray-200 text-sm font-medium flex items-center gap-2 ${roleColors[currentUserRole] || ''}`;
}
}

// Åifre alanlarÄ±nÄ± temizle
document.getElementById('profile-new-password').value = '';
document.getElementById('profile-confirm-password').value = '';

// ModalÄ± gÃ¶ster
modal.classList.remove('hidden');
modal.classList.add('flex');

if (typeof lucide !== 'undefined') lucide.createIcons();
};

// Profil modalÄ±nÄ± kapat
window.closeProfileModal = function () {
const modal = document.getElementById('profile-modal');
if (modal) {
modal.classList.add('hidden');
modal.classList.remove('flex');
}
};

// Profil takma adÄ±nÄ± kaydet
window.saveProfileNickname = async function () {
const nicknameInput = document.getElementById('profile-nickname');
const nickname = nicknameInput?.value?.trim() || '';

if (!currentUser?.email) {
if (typeof showToast === 'function') showToast('KullanÄ±cÄ± bilgisi bulunamadÄ±!', 'error');
return;
}

try {
const emailKey = emailToKey(currentUser.email);

// Firebase'e kaydet
await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}/nickname`).set(nickname);

// Global cache'i gÃ¼ncelle
if (!window.userNicknames) window.userNicknames = {};
window.userNicknames[currentUser.email] = nickname;

if (typeof showToast === 'function') showToast('Takma adÄ±nÄ±z kaydedildi!', 'success');
} catch (error) {
console.error('Takma ad kaydetme hatasÄ±:', error);
if (typeof showToast === 'function') showToast('Takma ad kaydedilemedi!', 'error');
}
};

// Profil ÅŸifresini deÄŸiÅŸtir
window.clearOldPasswordError = function () {
const oldPasswordInput = document.getElementById('profile-old-password');
const errorDiv = document.getElementById('old-password-error');

if (errorDiv) {
errorDiv.classList.add('hidden');
}
if (oldPasswordInput) {
oldPasswordInput.classList.remove('border-red-500', 'focus:ring-red-500');
oldPasswordInput.classList.add('border-gray-200', 'focus:ring-teal-500');
}
};

window.changeProfilePassword = async function () {
const oldPasswordInput = document.getElementById('profile-old-password');
const newPasswordInput = document.getElementById('profile-new-password');
const confirmPasswordInput = document.getElementById('profile-confirm-password');
const errorDiv = document.getElementById('old-password-error');

const oldPassword = oldPasswordInput?.value;
const newPassword = newPasswordInput?.value;
const confirmPassword = confirmPasswordInput?.value;

// Hata mesajÄ±nÄ± gizle ve input'u normale dÃ¶ndÃ¼r
if (errorDiv) {
errorDiv.classList.add('hidden');
}
if (oldPasswordInput) {
oldPasswordInput.classList.remove('border-red-500', 'focus:ring-red-500');
oldPasswordInput.classList.add('border-gray-200', 'focus:ring-teal-500');
}

// Validasyonlar
if (!oldPassword) {
if (typeof showToast === 'function') showToast('Mevcut ÅŸifrenizi girmelisiniz!', 'warning');
return;
}

if (!newPassword || newPassword.length < 6) {
if (typeof showToast === 'function') showToast('Yeni ÅŸifre en az 6 karakter olmalÄ±dÄ±r!', 'warning');
return;
}

if (newPassword !== confirmPassword) {
if (typeof showToast === 'function') showToast('Yeni ÅŸifreler eÅŸleÅŸmiyor!', 'warning');
return;
}

if (!currentUser) {
if (typeof showToast === 'function') showToast('KullanÄ±cÄ± bilgisi bulunamadÄ±!', 'error');
return;
}

try {
// Ã–nce mevcut ÅŸifreyi doÄŸrula (yeniden kimlik doÄŸrulama)
const credential = firebase.auth.EmailAuthProvider.credential(
currentUser.email,
oldPassword
);

await currentUser.reauthenticateWithCredential(credential);

// Eski ÅŸifre doÄŸru, yeni ÅŸifreyi ayarla
await currentUser.updatePassword(newPassword);

// Åifre alanlarÄ±nÄ± temizle
oldPasswordInput.value = '';
newPasswordInput.value = '';
confirmPasswordInput.value = '';

if (typeof showToast === 'function') showToast('Åifreniz baÅŸarÄ±yla deÄŸiÅŸtirildi!', 'success');
} catch (error) {
console.error('Åifre deÄŸiÅŸtirme hatasÄ±:', error);

// Firebase hata mesajlarÄ±nÄ± TÃ¼rkÃ§eleÅŸtir
let errorMessage = 'Åifre deÄŸiÅŸtirilemedi!';
let showInlineError = false;

if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
errorMessage = 'Mevcut ÅŸifreniz yanlÄ±ÅŸ!';
showInlineError = true;

// Input'u kÄ±rmÄ±zÄ± yap ve hata mesajÄ±nÄ± gÃ¶ster
if (oldPasswordInput) {
oldPasswordInput.classList.remove('border-gray-200', 'focus:ring-teal-500');
oldPasswordInput.classList.add('border-red-500', 'focus:ring-red-500');
}
if (errorDiv) {
errorDiv.classList.remove('hidden');
// Lucide ikonlarÄ±nÄ± yenile
if (typeof lucide !== 'undefined') lucide.createIcons();
}
} else if (error.code === 'auth/requires-recent-login') {
errorMessage = 'GÃ¼venlik nedeniyle yeniden giriÅŸ yapmanÄ±z gerekiyor. LÃ¼tfen Ã§Ä±kÄ±ÅŸ yapÄ±p tekrar giriÅŸ yapÄ±n.';
} else if (error.code === 'auth/weak-password') {
errorMessage = 'Åifre Ã§ok zayÄ±f! Daha gÃ¼Ã§lÃ¼ bir ÅŸifre seÃ§in.';
}

if (typeof showToast === 'function') showToast(errorMessage, 'error');
}
};

// ============================================
// HEADER MENÃœ FONKSÄ°YONLARI
// ============================================

// MenÃ¼yÃ¼ aÃ§/kapat
window.toggleHeaderMenu = function () {
const dropdown = document.getElementById('header-menu-dropdown');
if (dropdown) {
dropdown.classList.toggle('hidden');
}
};

// MenÃ¼yÃ¼ kapat
window.closeHeaderMenu = function () {
const dropdown = document.getElementById('header-menu-dropdown');
if (dropdown) {
dropdown.classList.add('hidden');
}
};

// DÄ±ÅŸarÄ± tÄ±klayÄ±nca menÃ¼yÃ¼ kapat
document.addEventListener('click', function (e) {
const menuBtn = document.getElementById('header-menu-btn');
const dropdown = document.getElementById('header-menu-dropdown');

if (menuBtn && dropdown && !menuBtn.contains(e.target) && !dropdown.contains(e.target)) {
dropdown.classList.add('hidden');
}
});

// toggleTheme fonksiyonu yoksa tanÄ±mla
if (typeof toggleTheme === 'undefined') {
window.toggleTheme = function () {
const btnTheme = document.getElementById('btn-theme-toggle');
if (btnTheme) btnTheme.click();
};
}

// ============================================
// AKTÄ°F CÄ°HAZ YÃ–NETÄ°MÄ° SÄ°STEMÄ°
// ============================================

// Cihaz bazlÄ± kalÄ±cÄ± ID - localStorage'da saklanÄ±yor
// AynÄ± tarayÄ±cÄ±da her zaman aynÄ± ID kullanÄ±lÄ±r
function getOrCreateDeviceId() {
const DEVICE_ID_KEY = 'evdeSaglik_deviceId';
let deviceId = localStorage.getItem(DEVICE_ID_KEY);

if (!deviceId) {
// Yeni cihaz iÃ§in benzersiz ID oluÅŸtur
deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
localStorage.setItem(DEVICE_ID_KEY, deviceId);
} else {
}

return deviceId;
}

const currentSessionId = getOrCreateDeviceId();

// Cihaz bilgisini Ã§Ä±kar
function getDeviceInfo() {
const ua = navigator.userAgent;
let browser = 'Bilinmeyen TarayÄ±cÄ±';
let os = 'Bilinmeyen Ä°ÅŸletim Sistemi';

// TarayÄ±cÄ± tespiti
if (ua.includes('Firefox')) browser = 'Firefox';
else if (ua.includes('Edg')) browser = 'Edge';
else if (ua.includes('Chrome')) browser = 'Chrome';
else if (ua.includes('Safari')) browser = 'Safari';
else if (ua.includes('Opera')) browser = 'Opera';

// Ä°ÅŸletim sistemi tespiti
if (ua.includes('Windows')) os = 'Windows';
else if (ua.includes('Mac')) os = 'macOS';
else if (ua.includes('Linux')) os = 'Linux';
else if (ua.includes('Android')) os = 'Android';
else if (ua.includes('iPhone') || ua.includes('iPad')) os = 'iOS';

return { browser, os, userAgent: ua };
}

// Oturumu Firebase'e kaydet (veya mevcut kaydÄ± gÃ¼ncelle)
async function registerDeviceSession() {
if (!auth.currentUser) return;

const email = auth.currentUser.email;
const sanitizedEmail = email.replace(/[.@]/g, '_');
const deviceInfo = getDeviceInfo();
const sessionRef = database.ref(`evde_saglik_ortak_veri/active_sessions/${sanitizedEmail}/${currentSessionId}`);

try {
// Mevcut kaydÄ± kontrol et
const snapshot = await sessionRef.once('value');
const existingData = snapshot.val();

if (existingData) {
// Mevcut cihaz - sadece lastActive ve cihaz bilgisini gÃ¼ncelle
await sessionRef.update({
browser: deviceInfo.browser,
os: deviceInfo.os,
lastActive: Date.now(),
userAgent: deviceInfo.userAgent
});
} else {
// Yeni cihaz - tam kayÄ±t oluÅŸtur
const sessionData = {
sessionId: currentSessionId,
browser: deviceInfo.browser,
os: deviceInfo.os,
lastActive: Date.now(),
loginTime: Date.now(),
userAgent: deviceInfo.userAgent
};
await sessionRef.set(sessionData);
}

// Periyodik olarak lastActive gÃ¼ncelle (her 5 dakikada bir)
setInterval(async () => {
if (auth.currentUser) {
await database.ref(`evde_saglik_ortak_veri/active_sessions/${sanitizedEmail}/${currentSessionId}/lastActive`).set(Date.now());
}
}, 5 * 60 * 1000);
} catch (error) {
console.error('Cihaz kaydÄ± hatasÄ±:', error);
}
}

// Ã‡Ä±kÄ±ÅŸ yaparken oturumu sil
async function unregisterDeviceSession() {
if (!auth.currentUser) return;

const email = auth.currentUser.email;
const sanitizedEmail = email.replace(/[.@]/g, '_');

try {
await database.ref(`evde_saglik_ortak_veri/active_sessions/${sanitizedEmail}/${currentSessionId}`).remove();
} catch (error) {
console.error('Cihaz silme hatasÄ±:', error);
}
}

// Aktif cihazlarÄ± yÃ¼kle ve gÃ¶ster
async function loadActiveDevices() {
if (!auth.currentUser) return;

const email = auth.currentUser.email;
const sanitizedEmail = email.replace(/[.@]/g, '_');
const container = document.getElementById('active-devices-list');

try {
const snapshot = await database.ref(`evde_saglik_ortak_veri/active_sessions/${sanitizedEmail}`).once('value');
const sessions = snapshot.val() || {};

if (Object.keys(sessions).length === 0) {
container.innerHTML = `
<div class="text-center py-8 text-gray-400">
<i data-lucide="smartphone-off" class="w-8 h-8 mx-auto mb-2"></i>
<p>Aktif oturum bulunamadÄ±</p>
</div>
`;
if (typeof lucide !== 'undefined') lucide.createIcons();
return;
}

let html = '';
const now = Date.now();

Object.entries(sessions).forEach(([sessionId, session]) => {
const isCurrentDevice = sessionId === currentSessionId;
const lastActiveMinutes = Math.floor((now - session.lastActive) / (1000 * 60));
const loginDate = new Date(session.loginTime).toLocaleString('tr-TR');

let statusText = 'Aktif';
let statusColor = 'green';
if (lastActiveMinutes > 30) {
statusText = `${lastActiveMinutes} dk Ã¶nce`;
statusColor = 'yellow';
}
if (lastActiveMinutes > 60 * 24) {
statusText = 'Pasif';
statusColor = 'gray';
}

html += `
<div class="p-4 border rounded-xl ${isCurrentDevice ? 'bg-blue-50 border-blue-200' : 'bg-white border-gray-200'} relative">
${isCurrentDevice ? '<span class="absolute top-2 right-2 text-[10px] bg-blue-500 text-white px-2 py-0.5 rounded-full">Bu Cihaz</span>' : ''}
<div class="flex items-start gap-3">
<div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center text-white">
<i data-lucide="${session.os === 'Android' || session.os === 'iOS' ? 'smartphone' : 'monitor'}" class="w-5 h-5"></i>
</div>
<div class="flex-1">
<p class="font-bold text-gray-800">${session.browser} - ${session.os}</p>
<p class="text-xs text-gray-500">GiriÅŸ: ${loginDate}</p>
<p class="text-xs mt-1">
<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-${statusColor}-100 text-${statusColor}-700">
<span class="w-1.5 h-1.5 rounded-full bg-${statusColor}-500"></span>
${statusText}
</span>
</p>
</div>
${!isCurrentDevice ? `
<button onclick="logoutDevice('${sessionId}')"
class="px-3 py-1 text-xs bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition font-semibold">
Ã‡Ä±kÄ±ÅŸ Yap
</button>
` : ''}
</div>
</div>
`;
});

container.innerHTML = html;
if (typeof lucide !== 'undefined') lucide.createIcons();

} catch (error) {
console.error('Aktif cihazlar yÃ¼kleme hatasÄ±:', error);
container.innerHTML = `
<div class="text-center py-8 text-red-400">
<p>YÃ¼kleme hatasÄ±: ${error.message}</p>
</div>
`;
}
}

// Tek bir cihazÄ± Ã§Ä±kÄ±ÅŸ yap
async function logoutDevice(sessionId) {
if (!auth.currentUser) return;
if (!confirm('Bu cihazÄ± oturumdan Ã§Ä±karmak istediÄŸinize emin misiniz?')) return;

const email = auth.currentUser.email;
const sanitizedEmail = email.replace(/[.@]/g, '_');

try {
await database.ref(`evde_saglik_ortak_veri/active_sessions/${sanitizedEmail}/${sessionId}`).remove();
showToast('Cihaz oturumu sonlandÄ±rÄ±ldÄ±', 'success');
loadActiveDevices(); // Listeyi yenile
} catch (error) {
showToast('Hata: ' + error.message, 'error');
}
}

// TÃ¼m cihazlardan Ã§Ä±kÄ±ÅŸ yap
async function logoutAllDevices() {
if (!auth.currentUser) return;
if (!confirm('TÃœM cihazlardan Ã§Ä±kÄ±ÅŸ yapmak istediÄŸinize emin misiniz? Bu iÅŸlem sizi de Ã§Ä±kÄ±ÅŸ yapacaktÄ±r.')) return;

const email = auth.currentUser.email;
const sanitizedEmail = email.replace(/[.@]/g, '_');

try {
await database.ref(`evde_saglik_ortak_veri/active_sessions/${sanitizedEmail}`).remove();
showToast('TÃ¼m oturumlar sonlandÄ±rÄ±ldÄ±', 'success');
closeActiveDevicesModal();
// Ã‡Ä±kÄ±ÅŸ yap
auth.signOut();
} catch (error) {
showToast('Hata: ' + error.message, 'error');
}
}

// Modal aÃ§/kapa
function openActiveDevicesModal() {
document.getElementById('active-devices-modal').classList.remove('hidden');
document.getElementById('active-devices-modal').classList.add('flex');
loadActiveDevices();
if (typeof lucide !== 'undefined') lucide.createIcons();
}

function closeActiveDevicesModal() {
document.getElementById('active-devices-modal').classList.add('hidden');
document.getElementById('active-devices-modal').classList.remove('flex');
}

// ============================================
// BEKLEYEN KULLANICI YÃ–NETÄ°MÄ°
// ============================================

async function openPendingUsersModal() {
document.getElementById('pending-users-modal').classList.remove('hidden');
document.getElementById('pending-users-modal').classList.add('flex');
await renderPendingUsers();
if (typeof lucide !== 'undefined') lucide.createIcons();
}

function closePendingUsersModal() {
document.getElementById('pending-users-modal').classList.add('hidden');
document.getElementById('pending-users-modal').classList.remove('flex');
}

async function renderPendingUsers() {
const listEl = document.getElementById('pending-users-list');
if (!listEl) return;

listEl.innerHTML = '<div class="text-center text-gray-400 text-sm py-8"><i data-lucide="loader" class="w-8 h-8 mx-auto mb-2 animate-spin"></i>YÃ¼kleniyor...</div>';

try {
const snapshot = await database.ref('pending_users').once('value');
const pendingUsers = snapshot.val() || {};
const userList = Object.entries(pendingUsers);

// Badge gÃ¼ncelle
const badge = document.getElementById('pending-users-badge');
if (badge) {
if (userList.length > 0) {
badge.textContent = userList.length;
badge.classList.remove('hidden');
} else {
badge.classList.add('hidden');
}
}

if (userList.length === 0) {
listEl.innerHTML = '<div class="text-center text-gray-400 text-sm py-8"><i data-lucide="check-circle" class="w-8 h-8 mx-auto mb-2 text-green-500"></i>Bekleyen kullanÄ±cÄ± yok</div>';
if (typeof lucide !== 'undefined') lucide.createIcons();
return;
}

listEl.innerHTML = userList.map(([key, user]) => `
<div class="bg-gray-50 rounded-lg p-3 border flex items-center justify-between">
<div>
<div class="font-bold text-gray-800 text-sm">${user.email}</div>
<div class="text-xs text-gray-500">KayÄ±t: ${new Date(user.registeredAt).toLocaleString('tr-TR')}</div>
</div>
<div class="flex gap-2">
<button onclick="approveUser('${key}')"
class="px-3 py-1.5 bg-green-500 text-white rounded-lg text-xs font-bold hover:bg-green-600 transition flex items-center gap-1">
<i data-lucide="check" class="w-3 h-3"></i> Onayla
</button>
<button onclick="rejectUser('${key}')"
class="px-3 py-1.5 bg-red-500 text-white rounded-lg text-xs font-bold hover:bg-red-600 transition flex items-center gap-1">
<i data-lucide="x" class="w-3 h-3"></i> Reddet
</button>
</div>
</div>
`).join('');

if (typeof lucide !== 'undefined') lucide.createIcons();
} catch (error) {
console.error('Bekleyen kullanÄ±cÄ±lar yÃ¼klenemedi:', error);
listEl.innerHTML = '<div class="text-center text-red-500 text-sm py-8">Hata oluÅŸtu</div>';
}
}

async function approveUser(emailKey) {
if (!confirm('Bu kullanÄ±cÄ±yÄ± onaylamak istediÄŸinize emin misiniz?')) return;

try {
// pending_users'dan kullanÄ±cÄ± bilgisini al
const pendingSnap = await database.ref(`pending_users/${emailKey}`).once('value');
const userData = pendingSnap.val();

if (!userData) {
showToast('KullanÄ±cÄ± bulunamadÄ±!', 'error');
return;
}

// approved_users'a ekle
await database.ref(`approved_users/${emailKey}`).set({
email: userData.email,
uid: userData.uid,
approvedAt: new Date().toISOString(),
approvedBy: currentUser?.email || 'admin',
registeredAt: userData.registeredAt
});

// Yeni kullanÄ±cÄ± iÃ§in varsayÄ±lan sekme izinlerini ayarla
const defaultAllowedTabs = [
'hastatakip',    // Hasta Takip
'personel',      // Personel Takip
'analiz',        // GeÃ§miÅŸ Analiz
'nobet',         // NÃ¶bet Listesi
'istatistik',    // Ä°statistikler
'puantaj',       // Puantaj
'rehber',        // Rehber
'takvim',        // Takvim
'izinrapor'      // Ä°zin/Rapor
];

// users_roles tablosuna varsayÄ±lan izinleri ekle
await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}`).set({
email: userData.email,
role: 'user',
allowedTabs: defaultAllowedTabs,
createdAt: new Date().toISOString(),
approvedBy: currentUser?.email || 'admin'
});

// pending_users'dan sil
await database.ref(`pending_users/${emailKey}`).remove();

showToast('âœ… KullanÄ±cÄ± onaylandÄ± ve varsayÄ±lan izinler atandÄ±!', 'success');
await renderPendingUsers();

} catch (error) {
console.error('KullanÄ±cÄ± onaylama hatasÄ±:', error);
showToast('Hata oluÅŸtu: ' + error.message, 'error');
}
}

async function rejectUser(emailKey) {
if (!confirm('Bu kullanÄ±cÄ±yÄ± reddetmek istediÄŸinize emin misiniz? Hesap silinecektir.')) return;

try {
// pending_users'dan kullanÄ±cÄ± bilgisini al
const pendingSnap = await database.ref(`pending_users/${emailKey}`).once('value');
const userData = pendingSnap.val();

// rejected_users tablosuna ekle (giriÅŸ engellemek iÃ§in)
await database.ref(`rejected_users/${emailKey}`).set({
email: userData?.email || emailKey.replace(/_at_/g, '@').replace(/,/g, '.'),
uid: userData?.uid || null,
rejectedAt: new Date().toISOString(),
rejectedBy: currentUser?.email || 'admin'
});

// pending_users'dan sil
await database.ref(`pending_users/${emailKey}`).remove();

showToast('âŒ KullanÄ±cÄ± reddedildi', 'warning');
await renderPendingUsers();

} catch (error) {
console.error('KullanÄ±cÄ± reddetme hatasÄ±:', error);
showToast('Hata oluÅŸtu: ' + error.message, 'error');
}
}

// Sayfa yÃ¼klendiÄŸinde bekleyen kullanÄ±cÄ± sayÄ±sÄ±nÄ± kontrol et
async function checkPendingUsersCount() {
try {
const snapshot = await database.ref('pending_users').once('value');
const count = snapshot.numChildren();
const badge = document.getElementById('pending-users-badge');
if (badge) {
if (count > 0) {
badge.textContent = count;
badge.classList.remove('hidden');
} else {
badge.classList.add('hidden');
}
}
} catch (e) { console.log('Badge gÃ¼ncelleme hatasÄ±:', e); }
}

// Sayfa yÃ¼klendiÄŸinde ve auth deÄŸiÅŸtiÄŸinde oturumu kaydet
let sessionListener = null; // Oturum dinleyicisi referansÄ±

if (typeof auth !== 'undefined') {
auth.onAuthStateChanged((user) => {
if (user) {
setTimeout(registerDeviceSession, 3000); // 3 saniye sonra kaydet

// Uzaktan Ã§Ä±kÄ±ÅŸ dinleyicisi baÅŸlat
setTimeout(() => {
const email = user.email;
const sanitizedEmail = email.replace(/[.@]/g, '_');
const sessionRef = database.ref(`evde_saglik_ortak_veri/active_sessions/${sanitizedEmail}/${currentSessionId}`);

// Bu oturumu dinle - silinirse Ã§Ä±kÄ±ÅŸ yap
sessionListener = sessionRef.on('value', (snapshot) => {
if (!snapshot.exists() && auth.currentUser) {
showToast('Oturumunuz baÅŸka bir cihazdan sonlandÄ±rÄ±ldÄ±!', 'warning');
setTimeout(() => {
auth.signOut();
}, 2000);
}
});

}, 5000); // 5 saniye sonra dinlemeye baÅŸla
} else {
// Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±ÄŸÄ±nda dinleyiciyi kaldÄ±r
if (sessionListener) {
sessionListener = null;
}
}
});
}

// ============================================
// EKRAN KÄ°LÄ°DÄ° SÄ°STEMÄ° (FÄ°REBASE SENKRONÄ°ZE)
// ============================================

let screenLockPassword = '0000'; // VarsayÄ±lan ÅŸifre

// Firebase'den ekran kilidi ayarlarÄ±nÄ± yÃ¼kle
async function loadLockSettings() {
if (!currentUser) return;
try {
const emailKey = emailToKey(currentUser.email);
const snapshot = await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}`).once('value');
const userData = snapshot.val() || {};

// Åifre
if (userData.lockPassword) {
screenLockPassword = userData.lockPassword;
}
} catch (error) {
console.error('Kilit ayarlarÄ± yÃ¼kleme hatasÄ±:', error);
}
}

// Eski fonksiyon adÄ±nÄ± koruyalÄ±m
async function loadLockPassword() {
return loadLockSettings();
}

// Ekran Kilidi AyarlarÄ± modalÄ±nÄ± aÃ§
window.openScreenLockSettingsModal = function () {
const modal = document.getElementById('screen-lock-settings-modal');
if (modal) {
modal.classList.remove('hidden');
modal.classList.add('flex');
// AlanlarÄ± temizle
document.getElementById('lock-pw-current').value = '';
document.getElementById('lock-pw-new').value = '';
document.getElementById('lock-pw-confirm').value = '';
if (typeof lucide !== 'undefined') lucide.createIcons();
}
};

// Ekran Kilidi AyarlarÄ± modalÄ±nÄ± kapat
window.closeScreenLockSettingsModal = function () {
const modal = document.getElementById('screen-lock-settings-modal');
if (modal) {
modal.classList.add('hidden');
modal.classList.remove('flex');
}
};

// Eski fonksiyon adlarÄ±nÄ± koruyalÄ±m (geriye uyumluluk)
window.openLockPasswordModal = window.openScreenLockSettingsModal;
window.closeLockPasswordModal = window.closeScreenLockSettingsModal;

// EkranÄ± kilitle
window.lockSession = function () {
// Åifre tanÄ±mlÄ± deÄŸilse uyar
if (!screenLockPassword) {
showToast('Ã–nce ekran kilidi ÅŸifresi belirlemelisiniz!', 'warning');
openScreenLockSettingsModal();
return;
}

const modal = document.getElementById('lock-screen-modal');
if (!modal) return;

// Kilit durumunu localStorage'a kaydet (sayfa yenilendiÄŸinde korunsun)
window.localStorage.setItem('isSystemLocked', 'yes');

// KullanÄ±cÄ± bilgisini gÃ¶ster
const userEl = document.getElementById('lock-screen-user');
if (userEl && currentUser) {
const nickname = getNickname(currentUser.email);
userEl.textContent = nickname || currentUser.email;
}

// ModalÄ± gÃ¶ster
modal.classList.remove('hidden');
modal.classList.add('flex');

// Åifre inputuna focus
setTimeout(() => {
const pwInput = document.getElementById('lock-screen-password');
if (pwInput) {
pwInput.value = '';
pwInput.focus();
}
}, 100);

// Hata mesajÄ±nÄ± gizle
document.getElementById('lock-screen-error')?.classList.add('hidden');

if (typeof lucide !== 'undefined') lucide.createIcons();
};

// Ekran kilidini aÃ§
window.unlockScreen = function () {
const pwInput = document.getElementById('lock-screen-password');
const errorEl = document.getElementById('lock-screen-error');
const enteredPassword = pwInput?.value || '';

// Åifreyi kontrol et
if (enteredPassword === screenLockPassword) {
// DoÄŸru ÅŸifre - kilit durumunu localStorage'dan sil
window.localStorage.removeItem('isSystemLocked');

const modal = document.getElementById('lock-screen-modal');
if (modal) {
modal.classList.add('hidden');
modal.classList.remove('flex');
}
pwInput.value = '';
errorEl?.classList.add('hidden');
if (typeof showToast === 'function') showToast('Ekran kilidi aÃ§Ä±ldÄ±!', 'success');
} else {
// YanlÄ±ÅŸ ÅŸifre
errorEl?.classList.remove('hidden');
pwInput.value = '';
pwInput.focus();
// Titretme efekti
pwInput.classList.add('animate-pulse');
setTimeout(() => pwInput.classList.remove('animate-pulse'), 500);
}
};

// Kilit ÅŸifresini kaydet (Firebase'e)
window.saveLockPassword = async function () {
const currentPw = document.getElementById('lock-pw-current')?.value;
const newPw = document.getElementById('lock-pw-new')?.value;
const confirmPw = document.getElementById('lock-pw-confirm')?.value;

// Ä°lk kez ÅŸifre belirleme (mevcut ÅŸifre yoksa)
if (!screenLockPassword) {
// Yeni ÅŸifre uzunluÄŸu
if (!newPw || newPw.length < 4) {
if (typeof showToast === 'function') showToast('Åifre en az 4 karakter olmalÄ±!', 'warning');
return;
}
// Åifre eÅŸleÅŸmesi
if (newPw !== confirmPw) {
if (typeof showToast === 'function') showToast('Åifreler eÅŸleÅŸmiyor!', 'warning');
return;
}
} else {
// Mevcut ÅŸifreyi kontrol et
if (currentPw !== screenLockPassword) {
if (typeof showToast === 'function') showToast('Mevcut ÅŸifre hatalÄ±!', 'error');
return;
}
// Yeni ÅŸifre uzunluÄŸu
if (!newPw || newPw.length < 4) {
if (typeof showToast === 'function') showToast('Yeni ÅŸifre en az 4 karakter olmalÄ±!', 'warning');
return;
}
// Åifre eÅŸleÅŸmesi
if (newPw !== confirmPw) {
if (typeof showToast === 'function') showToast('Yeni ÅŸifreler eÅŸleÅŸmiyor!', 'warning');
return;
}
}

// Firebase'e kaydet
try {
if (currentUser) {
const emailKey = emailToKey(currentUser.email);
await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}/lockPassword`).set(newPw);
screenLockPassword = newPw;
}
} catch (error) {
console.error('Åifre kaydetme hatasÄ±:', error);
if (typeof showToast === 'function') showToast('Åifre kaydedilemedi!', 'error');
return;
}

// AlanlarÄ± temizle
document.getElementById('lock-pw-current').value = '';
document.getElementById('lock-pw-new').value = '';
document.getElementById('lock-pw-confirm').value = '';

if (typeof showToast === 'function') showToast('Ekran kilidi ÅŸifresi kaydedildi!', 'success');
};

// Ctrl+L kÄ±sayolu ile kilitle
document.addEventListener('keydown', function (e) {
// Ctrl + L ile ekranÄ± kilitle
if (e.ctrlKey && (e.key === 'l' || e.key === 'L')) {
e.preventDefault();
lockSession();
}
});

// Auth deÄŸiÅŸikliÄŸinde kilit ÅŸifresini yÃ¼kle
if (typeof auth !== 'undefined') {
auth.onAuthStateChanged((user) => {
if (user) {
setTimeout(loadLockPassword, 2000);
}
});
}

</script>

<script>
(function () {
'use strict';

// Mesaj verisi iÃ§in anahtar
const LS_USER_MESSAGES = 'evdeSaglikUserMessages_V1';
const LS_MESSAGES_PASSWORD = 'evdeSaglikMessagesPassword_V1';
let userMessages = [];
let currentReplyTo = null;
let messagesPassword = '0000'; // VarsayÄ±lan ÅŸifre

// Åifre yÃ¼kleme (kullanÄ±cÄ± bazlÄ±)
async function loadMessagesPassword() {
if (typeof database !== 'undefined' && userDataPath && currentUser && currentUser.email) {
try {
// KullanÄ±cÄ± email'ini Firebase uyumlu formata Ã§evir
const userEmailKey = currentUser.email.replace(/\./g, '_').replace(/@/g, '_at_');
const snapshot = await database.ref(`${userDataPath}/${LS_MESSAGES_PASSWORD}/${userEmailKey}`).once('value');
const savedPassword = snapshot.val();
if (savedPassword) {
messagesPassword = savedPassword;
} else {
messagesPassword = '0000'; // VarsayÄ±lan ÅŸifre
}
} catch (error) {
console.error('Mesaj ÅŸifresi yÃ¼klenemedi:', error);
messagesPassword = '0000';
}
}
}

// Åifre modalÄ± aÃ§
window.promptMessagesPassword = function () {
const modal = document.getElementById('messages-password-modal');
if (modal) {
modal.classList.remove('hidden');
modal.classList.add('flex');
const input = document.getElementById('messages-password-input');
if (input) {
input.value = '';
setTimeout(() => input.focus(), 100);
}
if (typeof lucide !== 'undefined') lucide.createIcons();
}
};

window.closeMessagesPasswordModal = function () {
const modal = document.getElementById('messages-password-modal');
if (modal) {
modal.classList.add('hidden');
modal.classList.remove('flex');
}
};

// Åifre kontrol (Sekme Kilit ÅŸifresi ile ortak)
window.checkMessagesPassword = function () {
const input = document.getElementById('messages-password-input');
const enteredPassword = input ? input.value : '';

// customTabPassword ile kontrol et (Sekme Kilit ÅŸifresi ile ortak)
if (enteredPassword === customTabPassword) {
closeMessagesPasswordModal();
openMessagesModal();
} else {
showToast('YanlÄ±ÅŸ ÅŸifre!', 'error');
if (input) {
input.value = '';
input.focus();
}
}
};

// Åifre deÄŸiÅŸtir modal aÃ§
window.openChangeMessagesPasswordModal = function () {
const modal = document.getElementById('messages-change-password-modal');
if (modal) {
modal.classList.remove('hidden');
modal.classList.add('flex');
document.getElementById('messages-current-password').value = '';
document.getElementById('messages-new-password').value = '';
document.getElementById('messages-confirm-password').value = '';
if (typeof lucide !== 'undefined') lucide.createIcons();
}
};

window.closeChangeMessagesPasswordModal = function () {
const modal = document.getElementById('messages-change-password-modal');
if (modal) {
modal.classList.add('hidden');
modal.classList.remove('flex');
}
};

// Åifre deÄŸiÅŸtir (Sekme Kilit ÅŸifresi ile ortak - aynÄ± ÅŸifre kullanÄ±lÄ±yor)
window.changeMessagesPassword = async function () {
const currentPw = document.getElementById('messages-current-password').value;
const newPw = document.getElementById('messages-new-password').value;
const confirmPw = document.getElementById('messages-confirm-password').value;

// customTabPassword ile kontrol et (Sekme Kilit ÅŸifresi ile ortak)
if (currentPw !== customTabPassword) {
showToast('Mevcut ÅŸifre yanlÄ±ÅŸ!', 'error');
return;
}

if (!newPw || newPw.length < 4) {
showToast('Yeni ÅŸifre en az 4 karakter olmalÄ±!', 'error');
return;
}

if (newPw !== confirmPw) {
showToast('Yeni ÅŸifreler eÅŸleÅŸmiyor!', 'error');
return;
}

try {
if (typeof database !== 'undefined' && currentUser && currentUser.email) {
// Sekme Kilit ÅŸifresini gÃ¼ncelle (user_settings yolunda)
const userKey = emailToKey(currentUser.email);
customTabPassword = newPw;

// Firebase'e kaydet
await database.ref(`evde_saglik_ortak_veri/user_settings/${userKey}/tabLockPassword`).set(newPw);
await FirebaseStorage.setItem(LS_TAB_LOCK_PASS_CUSTOM, customTabPassword);

showToast('âœ… Åifre baÅŸarÄ±yla deÄŸiÅŸtirildi! (MesajlarÄ±m ve Sekme Kilit ÅŸifresi ortak)', 'success');
closeChangeMessagesPasswordModal();
}
} catch (error) {
console.error('Åifre deÄŸiÅŸtirme hatasÄ±:', error);
showToast('Åifre deÄŸiÅŸtirilemedi', 'error');
}
};

// Modal aÃ§/kapat fonksiyonlarÄ±
window.openSendMessageModal = function () {
const modal = document.getElementById('send-message-modal');
if (modal) {
modal.classList.remove('hidden');
modal.classList.add('flex');
loadUserListForMessages();
if (typeof lucide !== 'undefined') lucide.createIcons();
}
};

window.closeSendMessageModal = function () {
const modal = document.getElementById('send-message-modal');
if (modal) {
modal.classList.add('hidden');
modal.classList.remove('flex');
document.getElementById('message-content').value = '';
document.getElementById('message-recipient').value = '';
cancelReply();
}
};

window.openMessagesModal = function () {
const modal = document.getElementById('messages-modal');
if (modal) {
modal.classList.remove('hidden');
modal.classList.add('flex');
renderMessagesList();
if (typeof lucide !== 'undefined') lucide.createIcons();
}
};

window.closeMessagesModal = function () {
const modal = document.getElementById('messages-modal');
if (modal) {
modal.classList.add('hidden');
modal.classList.remove('flex');
}
};

// KullanÄ±cÄ± listesini yÃ¼kle
function loadUserListForMessages() {
const select = document.getElementById('message-recipient');
if (!select) return;

select.innerHTML = '<option value="">-- KullanÄ±cÄ± SeÃ§in --</option>';

// userNicknames global deÄŸiÅŸkeninden veya Firebase'den
if (typeof userNicknames !== 'undefined' && userNicknames) {
Object.entries(userNicknames).forEach(([email, nickname]) => {
if (currentUser && email !== currentUser.email) {
const displayName = nickname || email.split('@')[0];
select.innerHTML += `<option value="${email}">${displayName} (${email})</option>`;
}
});
}

// EÄŸer userNicknames boÅŸsa, Firebase'den kayÄ±tlÄ± kullanÄ±cÄ±larÄ± Ã§ek
if (select.options.length <= 1 && typeof database !== 'undefined') {
database.ref('evde_saglik_ortak_veri/users_roles').once('value').then(snapshot => {
const users = snapshot.val();
if (users) {
Object.keys(users).forEach(emailKey => {
const email = emailKey.replace(/_at_/g, '@').replace(/,/g, '.');
if (currentUser && email !== currentUser.email) {
const userData = users[emailKey];
const displayName = userData.nickname || email.split('@')[0];
select.innerHTML += `<option value="${email}">${displayName}</option>`;
}
});
}
});
}
}

// Mesaj gÃ¶nder
window.sendUserMessage = async function () {
const recipientEmail = document.getElementById('message-recipient').value;
const content = document.getElementById('message-content').value.trim();

if (!recipientEmail) {
showToast('LÃ¼tfen alÄ±cÄ± seÃ§in', 'error');
return;
}
if (!content) {
showToast('LÃ¼tfen mesaj yazÄ±n', 'error');
return;
}
if (!currentUser || !currentUser.email) {
showToast('GiriÅŸ yapmalÄ±sÄ±nÄ±z', 'error');
return;
}

const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
const senderNickname = (typeof userNicknames !== 'undefined' && userNicknames[currentUser.email])
? userNicknames[currentUser.email]
: currentUser.email.split('@')[0];

const newMessage = {
id: messageId,
from: currentUser.email,
fromName: senderNickname,
to: recipientEmail,
content: content,
timestamp: new Date().toISOString(),
read: false,
replyTo: currentReplyTo ? currentReplyTo.id : null,
replyPreview: currentReplyTo ? currentReplyTo.content.substring(0, 50) : null
};

try {
// Firebase'e kaydet
if (typeof database !== 'undefined' && userDataPath) {
await database.ref(`${userDataPath}/${LS_USER_MESSAGES}/${messageId}`).set(newMessage);
}

showToast('âœ‰ï¸ Mesaj gÃ¶nderildi!', 'success');
closeSendMessageModal();

} catch (error) {
console.error('Mesaj gÃ¶nderme hatasÄ±:', error);
showToast('Mesaj gÃ¶nderilemedi', 'error');
}
};

// MesajlarÄ± render et - WhatsApp tarzÄ± collapse/expand
let expandedConversations = {};

function renderMessagesList() {
const container = document.getElementById('messages-list');
if (!container) return;

// Mevcut kullanÄ±cÄ±ya gelen ve giden mesajlarÄ± al (silinmemiÅŸ olanlar)
const allMyMessages = userMessages.filter(msg => {
// Mesaj bu kullanÄ±cÄ± tarafÄ±ndan silindiyse gÃ¶sterme
if (msg.deletedFor && msg.deletedFor.includes(currentUser.email)) {
return false;
}
return currentUser && (msg.to === currentUser.email || msg.from === currentUser.email);
});

// KonuÅŸmalarÄ± grupla (kiÅŸi bazÄ±nda)
const conversations = {};
allMyMessages.forEach(msg => {
const otherPerson = msg.from === currentUser.email ? msg.to : msg.from;
if (!conversations[otherPerson]) {
conversations[otherPerson] = [];
}
conversations[otherPerson].push(msg);
});

// Her konuÅŸmayÄ± tarihe gÃ¶re sÄ±rala
Object.keys(conversations).forEach(person => {
conversations[person].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
});

// SayÄ±yÄ± gÃ¼ncelle
const countEl = document.getElementById('messages-count');
if (countEl) countEl.textContent = Object.keys(conversations).length;

if (Object.keys(conversations).length === 0) {
container.innerHTML = `
<div class="text-center text-gray-400 dark:text-gray-500 py-10">
<i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
<p class="text-sm">HenÃ¼z mesajÄ±nÄ±z yok</p>
</div>`;
if (typeof lucide !== 'undefined') lucide.createIcons();
return;
}

// KonuÅŸmalarÄ± son mesaj tarihine gÃ¶re sÄ±rala
const sortedConversations = Object.entries(conversations).sort((a, b) => {
const lastA = a[1][a[1].length - 1];
const lastB = b[1][b[1].length - 1];
return new Date(lastB.timestamp) - new Date(lastA.timestamp);
});

let html = '';
sortedConversations.forEach(([person, messages], index) => {
const displayName = (typeof userNicknames !== 'undefined' && userNicknames[person])
? userNicknames[person]
: person.split('@')[0];

const unreadCount = messages.filter(m => m.to === currentUser.email && !m.read).length;
const hasUnread = unreadCount > 0;
const lastMsg = messages[messages.length - 1];
const lastMsgTime = new Date(lastMsg.timestamp);
const timeStr = lastMsgTime.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' }) + ' ' +
lastMsgTime.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
const lastMsgPreview = lastMsg.content.length > 35 ? lastMsg.content.substring(0, 35) + '...' : lastMsg.content;
const isExpanded = expandedConversations[person] === true;
const personId = 'conv_' + index;

const headerBg = hasUnread
? 'bg-blue-50 dark:bg-blue-900 hover:bg-blue-100 dark:hover:bg-blue-800'
: 'bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600';

html += `
<div class="mb-2 rounded-xl border border-gray-200 dark:border-gray-600 overflow-hidden shadow-sm">
<div onclick="toggleConversation('${person}')"
class="px-4 py-3 ${headerBg} cursor-pointer transition-all">
<div class="flex justify-between items-center">
<div class="flex items-center gap-3">
<div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold text-sm">
${displayName.charAt(0).toUpperCase()}
</div>
<div>
<div class="flex items-center gap-2">
<span class="font-bold text-sm text-gray-800 dark:text-white">${displayName}</span>
${hasUnread ? `<span class="bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full">${unreadCount}</span>` : ''}
</div>
<p class="text-xs text-gray-500 dark:text-gray-400 truncate max-w-[180px]">
${lastMsg.from === currentUser.email ? '<span class="text-green-600">Sen:</span> ' : ''}${lastMsgPreview}
</p>
</div>
</div>
<div class="flex items-center gap-2">
<button onclick="event.stopPropagation(); deleteConversation('${person}')"
class="p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900 rounded-full transition"
title="TÃ¼m konuÅŸmayÄ± sil">
<i data-lucide="trash-2" class="w-4 h-4"></i>
</button>
<div class="flex flex-col items-end gap-1">
<span class="text-[10px] text-gray-400 dark:text-gray-500">${timeStr}</span>
<i data-lucide="${isExpanded ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4 text-gray-400"></i>
</div>
</div>
</div>
</div>
<div id="${personId}" class="${isExpanded ? '' : 'hidden'} p-3 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-600 space-y-2 max-h-60 overflow-y-auto">`;

messages.forEach(msg => {
const date = new Date(msg.timestamp);
const msgTimeStr = date.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' }) + ' ' +
date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

const isSent = msg.from === currentUser.email;
const bubbleClass = isSent
? 'bg-green-100 dark:bg-green-900 ml-8 border-green-200 dark:border-green-700'
: 'bg-gray-100 dark:bg-gray-700 mr-8 border-gray-200 dark:border-gray-600';
const alignClass = isSent ? 'text-right' : 'text-left';
const readIndicator = !isSent && !msg.read ? '<span class="inline-block w-2 h-2 bg-blue-500 rounded-full mr-1"></span>' : '';

html += `
<div class="${alignClass}">
<div class="inline-block p-2 rounded-lg border ${bubbleClass} max-w-[85%]">
<div class="flex items-center gap-2 mb-1">
${readIndicator}
<span class="text-[10px] text-gray-500 dark:text-gray-400">${isSent ? 'Sen' : displayName} â€¢ ${msgTimeStr}</span>
${!isSent ? `
<button onclick="event.stopPropagation(); replyToMessage('${msg.id}')" class="text-green-500 hover:text-green-700 p-0.5" title="YanÄ±tla"><i data-lucide="reply" class="w-3 h-3"></i></button>
${!msg.read ? `<button onclick="event.stopPropagation(); markMessageAsRead('${msg.id}')" class="text-blue-500 hover:text-blue-700 p-0.5" title="Okundu"><i data-lucide="check" class="w-3 h-3"></i></button>` : ''}
<button onclick="event.stopPropagation(); deleteMessage('${msg.id}')" class="text-red-400 hover:text-red-600 p-0.5" title="Sil"><i data-lucide="x" class="w-3 h-3"></i></button>
` : `<button onclick="event.stopPropagation(); deleteMessage('${msg.id}')" class="text-red-400 hover:text-red-600 p-0.5" title="Sil"><i data-lucide="x" class="w-3 h-3"></i></button>`}
</div>
<p class="text-sm text-gray-700 dark:text-gray-300 ${alignClass}">${msg.content}</p>
</div>
</div>`;
});

// KonuÅŸma aÃ§Ä±ksa mesaj yazma alanÄ± ekle
if (isExpanded) {
html += `
</div>
<div class="p-2 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600 flex gap-2">
<input type="text" id="quick-reply-${index}"
class="flex-1 px-3 py-2 text-sm border border-gray-200 dark:border-gray-600 rounded-full bg-white dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-green-500 outline-none"
placeholder="Mesaj yazÄ±n..."
onkeypress="if(event.key==='Enter') sendQuickReply('${person}', ${index})">
<button onclick="sendQuickReply('${person}', ${index})"
class="px-4 py-2 bg-green-500 text-white rounded-full font-bold text-sm hover:bg-green-600 transition flex items-center gap-1">
<i data-lucide="send" class="w-4 h-4"></i>
</button>
</div>
</div>`;
} else {
html += `
</div>
</div>`;
}
});

container.innerHTML = html;
if (typeof lucide !== 'undefined') lucide.createIcons();
}

// KonuÅŸmayÄ± aÃ§/kapat
window.toggleConversation = function (person) {
expandedConversations[person] = !expandedConversations[person];
renderMessagesList();

// AÃ§Ä±ldÄ±ysa
if (expandedConversations[person]) {
setTimeout(() => {
// O kiÅŸinin mesajlarÄ±nÄ± okundu iÅŸaretle
markConversationAsRead(person);

// Mesaj listesini en alta scroll et
const convContainers = document.querySelectorAll('[id^="conv_"]');
convContainers.forEach(container => {
if (!container.classList.contains('hidden')) {
container.scrollTop = container.scrollHeight;
}
});

// Input'a focus ver
const inputs = document.querySelectorAll('[id^="quick-reply-"]');
if (inputs.length > 0) {
inputs[inputs.length - 1].focus();
}
}, 100);
}
};

// KonuÅŸmadaki tÃ¼m mesajlarÄ± okundu iÅŸaretle
async function markConversationAsRead(person) {
const unreadMessages = userMessages.filter(msg =>
msg.from === person && msg.to === currentUser.email && !msg.read
);

for (const msg of unreadMessages) {
try {
if (typeof database !== 'undefined' && userDataPath) {
await database.ref(`${userDataPath}/${LS_USER_MESSAGES}/${msg.id}/read`).set(true);
}
msg.read = true;
} catch (error) {
console.error('Okundu iÅŸaretleme hatasÄ±:', error);
}
}

if (unreadMessages.length > 0) {
updateMessageBadge();
}
}

// KonuÅŸmadaki tÃ¼m mesajlarÄ± sil (sadece mevcut kullanÄ±cÄ± iÃ§in)
window.deleteConversation = async function (person) {
if (!confirm(`${person} ile olan tÃ¼m mesajlarÄ± silmek istediÄŸinize emin misiniz?`)) {
return;
}

const conversationMessages = userMessages.filter(msg =>
(msg.from === person && msg.to === currentUser.email) ||
(msg.from === currentUser.email && msg.to === person)
);

try {
for (const msg of conversationMessages) {
// deletedFor dizisine mevcut kullanÄ±cÄ±yÄ± ekle
const deletedFor = msg.deletedFor || [];
if (!deletedFor.includes(currentUser.email)) {
deletedFor.push(currentUser.email);
}

if (typeof database !== 'undefined' && userDataPath) {
await database.ref(`${userDataPath}/${LS_USER_MESSAGES}/${msg.id}/deletedFor`).set(deletedFor);
}

// Local olarak gÃ¼ncelle
msg.deletedFor = deletedFor;
}

delete expandedConversations[person];
renderMessagesList();
updateMessageBadge();
showToast('ğŸ—‘ï¸ KonuÅŸma silindi', 'success');
} catch (error) {
console.error('KonuÅŸma silme hatasÄ±:', error);
showToast('KonuÅŸma silinemedi', 'error');
}
};

// HÄ±zlÄ± yanÄ±t gÃ¶nder
window.sendQuickReply = async function (recipientEmail, index) {
const input = document.getElementById('quick-reply-' + index);
const content = input ? input.value.trim() : '';

if (!content) {
showToast('Mesaj boÅŸ olamaz', 'error');
return;
}

if (!currentUser || !currentUser.email) {
showToast('GiriÅŸ yapmalÄ±sÄ±nÄ±z', 'error');
return;
}

const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
const senderNickname = (typeof userNicknames !== 'undefined' && userNicknames[currentUser.email])
? userNicknames[currentUser.email]
: currentUser.email.split('@')[0];

const newMessage = {
id: messageId,
from: currentUser.email,
fromName: senderNickname,
to: recipientEmail,
content: content,
timestamp: new Date().toISOString(),
read: false,
replyTo: null,
replyPreview: null
};

try {
if (typeof database !== 'undefined' && userDataPath) {
await database.ref(`${userDataPath}/${LS_USER_MESSAGES}/${messageId}`).set(newMessage);
}
input.value = '';
showToast('âœ‰ï¸ Mesaj gÃ¶nderildi!', 'success');

// Mesaj gÃ¶nderildikten sonra en alta scroll et
setTimeout(() => {
const convContainers = document.querySelectorAll('[id^="conv_"]');
convContainers.forEach(container => {
if (!container.classList.contains('hidden')) {
container.scrollTop = container.scrollHeight;
}
});
input.focus();
}, 200);
} catch (error) {
console.error('Mesaj gÃ¶nderme hatasÄ±:', error);
showToast('Mesaj gÃ¶nderilemedi', 'error');
}
};

// MesajÄ± okundu iÅŸaretle
window.markMessageAsRead = async function (messageId) {
try {
if (typeof database !== 'undefined' && userDataPath) {
await database.ref(`${userDataPath}/${LS_USER_MESSAGES}/${messageId}/read`).set(true);
}
const msg = userMessages.find(m => m.id === messageId);
if (msg) msg.read = true;
renderMessagesList();
updateMessageBadge();
} catch (error) {
console.error('Okundu iÅŸaretleme hatasÄ±:', error);
}
};

// TÃ¼mÃ¼nÃ¼ okundu iÅŸaretle
window.markAllMessagesAsRead = async function () {
try {
const myMessages = userMessages.filter(msg => currentUser && msg.to === currentUser.email && !msg.read);
for (const msg of myMessages) {
if (typeof database !== 'undefined' && userDataPath) {
await database.ref(`${userDataPath}/${LS_USER_MESSAGES}/${msg.id}/read`).set(true);
}
msg.read = true;
}
renderMessagesList();
updateMessageBadge();
showToast('TÃ¼m mesajlar okundu olarak iÅŸaretlendi', 'success');
} catch (error) {
console.error('Toplu okundu iÅŸaretleme hatasÄ±:', error);
}
};

// MesajÄ± sil (sadece mevcut kullanÄ±cÄ± iÃ§in)
window.deleteMessage = async function (messageId) {
if (!confirm('Bu mesajÄ± silmek istediÄŸinize emin misiniz?')) return;

try {
const msg = userMessages.find(m => m.id === messageId);
if (!msg) return;

// deletedFor dizisine mevcut kullanÄ±cÄ±yÄ± ekle
const deletedFor = msg.deletedFor || [];
if (!deletedFor.includes(currentUser.email)) {
deletedFor.push(currentUser.email);
}

if (typeof database !== 'undefined' && userDataPath) {
await database.ref(`${userDataPath}/${LS_USER_MESSAGES}/${messageId}/deletedFor`).set(deletedFor);
}

// Local olarak gÃ¼ncelle
msg.deletedFor = deletedFor;
renderMessagesList();
updateMessageBadge();
showToast('Mesaj silindi', 'success');
} catch (error) {
console.error('Mesaj silme hatasÄ±:', error);
showToast('Mesaj silinemedi', 'error');
}
};

// YanÄ±tla
window.replyToMessage = function (messageId) {
const msg = userMessages.find(m => m.id === messageId);
if (!msg) return;

currentReplyTo = {
id: msg.id,
content: msg.content,
from: msg.from
};

closeMessagesModal();
openSendMessageModal();

// AlÄ±cÄ±yÄ± ayarla
setTimeout(() => {
const recipientSelect = document.getElementById('message-recipient');
if (recipientSelect) {
recipientSelect.value = msg.from;
}

// YanÄ±t bilgisini gÃ¶ster
const replyInfo = document.getElementById('reply-info');
const replyOriginal = document.getElementById('reply-original-message');
if (replyInfo && replyOriginal) {
replyInfo.classList.remove('hidden');
replyOriginal.textContent = msg.content.substring(0, 100) + (msg.content.length > 100 ? '...' : '');
}
}, 100);
};

// YanÄ±tÄ± iptal et
window.cancelReply = function () {
currentReplyTo = null;
const replyInfo = document.getElementById('reply-info');
if (replyInfo) replyInfo.classList.add('hidden');
};

// Badge gÃ¼ncelle
function updateMessageBadge() {
const badge = document.getElementById('messages-badge');
if (!badge) return;

const unreadCount = userMessages.filter(msg => {
// Mesaj bu kullanÄ±cÄ± tarafÄ±ndan silindiyse sayma
if (msg.deletedFor && msg.deletedFor.includes(currentUser.email)) {
return false;
}
return currentUser && msg.to === currentUser.email && !msg.read;
}).length;

if (unreadCount > 0) {
badge.textContent = unreadCount;
badge.classList.remove('hidden');
badge.classList.add('flex');
} else {
badge.classList.add('hidden');
badge.classList.remove('flex');
}
}

// Firebase realtime listener
function startMessageListener() {
if (typeof database === 'undefined' || !userDataPath) {
setTimeout(startMessageListener, 1000);
return;
}

database.ref(`${userDataPath}/${LS_USER_MESSAGES}`).on('value', (snapshot) => {
const data = snapshot.val();
userMessages = data ? Object.values(data) : [];
updateMessageBadge();

// Modal aÃ§Ä±ksa gÃ¼ncelle
const modal = document.getElementById('messages-modal');
if (modal && modal.classList.contains('flex')) {
renderMessagesList();
}
});
}

// Sistem baÅŸlat
document.addEventListener('DOMContentLoaded', () => {
setTimeout(() => {
startMessageListener();
loadMessagesPassword();
}, 2000);
});

})();
</script>

<button id="chat-toggle-btn" onclick="toggleChatBar()"
class="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-br from-green-500 to-green-600 text-white rounded-full shadow-lg hover:shadow-xl hover:scale-110 transition-all duration-300 z-[150] flex items-center justify-center">
<span class="text-2xl">ğŸ’¬</span>
<span id="chat-unread-badge"
class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] font-bold rounded-full items-center justify-center hidden">0</span>
</button>

<div id="chat-panel"
class="fixed bottom-24 right-6 w-80 h-[450px] bg-white rounded-2xl shadow-2xl z-[150] transform translate-y-4 opacity-0 pointer-events-none transition-all duration-300 flex flex-col overflow-hidden border border-gray-200">

<div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-3 flex items-center justify-between">
<div class="flex items-center gap-2">
<span class="text-xl">ğŸ’¬</span>
<div>
<h3 class="font-bold text-sm">Ekip Sohbeti</h3>
<p class="text-[10px] text-green-100" id="chat-online-count">Ã‡evrimiÃ§i</p>
</div>
</div>
<button onclick="toggleChatBar()" class="text-white/80 hover:text-white text-xl">âœ•</button>
</div>

<div class="bg-amber-50 px-3 py-1.5 text-[10px] text-amber-700 border-b border-amber-100">
â° Mesajlar her gÃ¼n saat 16:00'da otomatik temizlenir
</div>

<div id="chat-messages" class="flex-1 overflow-y-auto p-3 space-y-2 bg-gray-50">
<p class="text-center text-gray-400 text-xs py-10">HenÃ¼z mesaj yok. Sohbeti baÅŸlatÄ±n!</p>
</div>

<div class="p-3 bg-white border-t border-gray-100 relative">
<div id="emoji-picker"
class="absolute bottom-16 left-3 right-3 bg-white border border-gray-200 rounded-xl shadow-xl p-2 hidden z-10">
<div class="grid grid-cols-8 gap-1 max-h-32 overflow-y-auto">
<button onclick="insertEmoji('ğŸ˜€')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ˜€</button>
<button onclick="insertEmoji('ğŸ˜‚')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ˜‚</button>
<button onclick="insertEmoji('ğŸ˜Š')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ˜Š</button>
<button onclick="insertEmoji('â¤ï¸')" class="text-xl hover:bg-gray-100 rounded p-1">â¤ï¸</button>
<button onclick="insertEmoji('ğŸ‘')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ‘</button>
<button onclick="insertEmoji('ğŸ‘')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ‘</button>
<button onclick="insertEmoji('ğŸ‰')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ‰</button>
<button onclick="insertEmoji('ğŸ”¥')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ”¥</button>
<button onclick="insertEmoji('âœ…')" class="text-xl hover:bg-gray-100 rounded p-1">âœ…</button>
<button onclick="insertEmoji('â­')" class="text-xl hover:bg-gray-100 rounded p-1">â­</button>
<button onclick="insertEmoji('ğŸ’ª')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ’ª</button>
<button onclick="insertEmoji('ğŸ™')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ™</button>
<button onclick="insertEmoji('ğŸ‘‹')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ‘‹</button>
<button onclick="insertEmoji('ğŸ¤”')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ¤”</button>
<button onclick="insertEmoji('ğŸ˜¢')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ˜¢</button>
<button onclick="insertEmoji('ğŸ˜…')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ˜…</button>
<button onclick="insertEmoji('ğŸ¤')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ¤</button>
<button onclick="insertEmoji('ğŸ’Š')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ’Š</button>
<button onclick="insertEmoji('ğŸ¥')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ¥</button>
<button onclick="insertEmoji('ğŸ‘¨â€âš•ï¸')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ‘¨â€âš•ï¸</button>
<button onclick="insertEmoji('ğŸ’‰')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ’‰</button>
<button onclick="insertEmoji('ğŸ©º')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ©º</button>
<button onclick="insertEmoji('ğŸ“‹')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ“‹</button>
<button onclick="insertEmoji('ğŸ“')" class="text-xl hover:bg-gray-100 rounded p-1">ğŸ“</button>
</div>
</div>
<div class="flex gap-2">
<input type="text" id="chat-input" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..."
onkeypress="if(event.key==='Enter') sendChatMessage()"
class="flex-1 px-3 py-2 text-sm border border-gray-200 rounded-full focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none">
<button onclick="toggleEmojiPicker()"
class="w-10 h-10 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition flex items-center justify-center">
<span class="text-lg">ğŸ˜Š</span>
</button>
<button onclick="sendChatMessage()"
class="w-10 h-10 bg-green-500 text-white rounded-full hover:bg-green-600 transition flex items-center justify-center">
<span class="text-lg">â¤</span>
</button>
</div>
</div>
</div>

<script>
// ============================================
// SOHBET BARI SÄ°STEMÄ°
// ============================================

let chatMessages = [];
let chatPanelOpen = false;
let lastSeenTimestamp = 0;

// Emoji picker aÃ§/kapa
window.toggleEmojiPicker = function () {
const picker = document.getElementById('emoji-picker');
picker.classList.toggle('hidden');
};

// Emoji ekle
window.insertEmoji = function (emoji) {
const input = document.getElementById('chat-input');
input.value += emoji;
input.focus();
document.getElementById('emoji-picker').classList.add('hidden');
};

// Panel aÃ§/kapa
window.toggleChatBar = function () {
const panel = document.getElementById('chat-panel');
chatPanelOpen = !chatPanelOpen;

if (chatPanelOpen) {
panel.classList.remove('translate-y-4', 'opacity-0', 'pointer-events-none');
panel.classList.add('translate-y-0', 'opacity-100', 'pointer-events-auto');

// OkunmamÄ±ÅŸ badge'i sÄ±fÄ±rla
lastSeenTimestamp = Date.now();
updateChatBadge();

// Mesajlara scroll
setTimeout(() => {
const messagesEl = document.getElementById('chat-messages');
if (messagesEl) messagesEl.scrollTop = messagesEl.scrollHeight;
}, 100);
} else {
panel.classList.add('translate-y-4', 'opacity-0', 'pointer-events-none');
panel.classList.remove('translate-y-0', 'opacity-100', 'pointer-events-auto');
}
};

// Mesaj gÃ¶nder
window.sendChatMessage = async function () {
const input = document.getElementById('chat-input');
const text = input.value.trim();

if (!text || !currentUser) return;

const nickname = getNickname(currentUser.email);

try {
await database.ref('evde_saglik_ortak_veri/chat_messages').push({
text: text,
from: nickname,
email: currentUser.email,
timestamp: Date.now()
});

input.value = '';
} catch (error) {
console.error('Mesaj gÃ¶nderme hatasÄ±:', error);
showToast('Mesaj gÃ¶nderilemedi!', 'error');
}
};

// Mesaj sil
window.deleteChatMessage = async function (msgId) {
if (!confirm('Bu mesajÄ± silmek istediÄŸinize emin misiniz?')) return;

try {
await database.ref(`evde_saglik_ortak_veri/chat_messages/${msgId}`).remove();
showToast('Mesaj silindi', 'success');
} catch (error) {
console.error('Mesaj silme hatasÄ±:', error);
showToast('Mesaj silinemedi!', 'error');
}
};

// Mesaj dÃ¼zenle
let editingMessageId = null;

window.editChatMessage = function (msgId, encodedText) {
const text = decodeURIComponent(encodedText);
const input = document.getElementById('chat-input');
const sendBtn = document.querySelector('#chat-panel button[onclick="sendChatMessage()"]');

editingMessageId = msgId;
input.value = text;
input.focus();

// GÃ¶nder butonunu gÃ¼ncelle
if (sendBtn) {
sendBtn.innerHTML = '<span class="text-lg">âœ“</span>';
sendBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
sendBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
sendBtn.setAttribute('onclick', 'saveEditedMessage()');
}

showToast('MesajÄ± dÃ¼zenleyin ve âœ“ tuÅŸuna basÄ±n', 'info');
};

// DÃ¼zenlenen mesajÄ± kaydet
window.saveEditedMessage = async function () {
const input = document.getElementById('chat-input');
const text = input.value.trim();
const sendBtn = document.querySelector('#chat-panel button[onclick="saveEditedMessage()"]');

if (!text || !editingMessageId) {
showToast('Mesaj boÅŸ olamaz!', 'error');
return;
}

try {
await database.ref(`evde_saglik_ortak_veri/chat_messages/${editingMessageId}/text`).set(text);
showToast('Mesaj gÃ¼ncellendi', 'success');

// Formu sÄ±fÄ±rla
input.value = '';
editingMessageId = null;

// Butonu eski haline getir
if (sendBtn) {
sendBtn.innerHTML = '<span class="text-lg">â¤</span>';
sendBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
sendBtn.classList.add('bg-green-500', 'hover:bg-green-600');
sendBtn.setAttribute('onclick', 'sendChatMessage()');
}
} catch (error) {
console.error('Mesaj gÃ¼ncelleme hatasÄ±:', error);
showToast('Mesaj gÃ¼ncellenemedi!', 'error');
}
};

// MesajlarÄ± render et
function renderChatMessages() {
const container = document.getElementById('chat-messages');
if (!container) return;

if (chatMessages.length === 0) {
container.innerHTML = '<p class="text-center text-gray-400 text-xs py-10">HenÃ¼z mesaj yok. Sohbeti baÅŸlatÄ±n!</p>';
return;
}

const myEmail = currentUser?.email || '';

let html = '';
chatMessages.forEach(msg => {
const isMe = msg.email === myEmail;
const time = new Date(msg.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

if (isMe) {
html += `
<div class="flex justify-end group">
<div class="max-w-[80%] bg-green-500 text-white px-3 py-2 rounded-2xl rounded-br-md relative">
<div class="absolute -left-16 top-1/2 -translate-y-1/2 hidden group-hover:flex gap-1">
<button onclick="editChatMessage('${msg.id}', '${encodeURIComponent(msg.text)}')" class="w-6 h-6 bg-blue-500 text-white rounded-full text-xs hover:bg-blue-600" title="DÃ¼zenle">âœï¸</button>
<button onclick="deleteChatMessage('${msg.id}')" class="w-6 h-6 bg-red-500 text-white rounded-full text-xs hover:bg-red-600" title="Sil">ğŸ—‘ï¸</button>
</div>
<p class="text-sm">${escapeHtmlChat(msg.text)}</p>
<p class="text-[9px] text-green-100 mt-1 text-right">${time}</p>
</div>
</div>`;
} else {
html += `
<div class="flex justify-start">
<div class="max-w-[80%] bg-white border border-gray-200 px-3 py-2 rounded-2xl rounded-bl-md shadow-sm">
<p class="text-[10px] font-bold text-green-600 mb-0.5">${escapeHtmlChat(msg.from)}</p>
<p class="text-sm text-gray-800">${escapeHtmlChat(msg.text)}</p>
<p class="text-[9px] text-gray-400 mt-1">${time}</p>
</div>
</div>`;
}
});

container.innerHTML = html;
container.scrollTop = container.scrollHeight;
}

// HTML escape
function escapeHtmlChat(text) {
const div = document.createElement('div');
div.textContent = text;
return div.innerHTML;
}

// Firebase'den mesajlarÄ± dinle
function listenForChatMessages() {
if (!currentUser) return;

database.ref('evde_saglik_ortak_veri/chat_messages')
.orderByChild('timestamp')
.limitToLast(100)
.on('value', (snapshot) => {
const data = snapshot.val() || {};
// MesajlarÄ± ID ile birlikte sakla
chatMessages = Object.entries(data).map(([id, msg]) => ({ ...msg, id })).sort((a, b) => a.timestamp - b.timestamp);
renderChatMessages();
updateChatBadge();
});
}

// OkunmamÄ±ÅŸ badge gÃ¼ncelle
function updateChatBadge() {
const badge = document.getElementById('chat-unread-badge');
if (!badge) return;

const unreadCount = chatMessages.filter(m => m.timestamp > lastSeenTimestamp && m.email !== currentUser?.email).length;

if (unreadCount > 0 && !chatPanelOpen) {
badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
badge.classList.remove('hidden');
badge.classList.add('flex');
} else {
badge.classList.add('hidden');
badge.classList.remove('flex');
}
}

// GÃ¼nlÃ¼k 16:00 temizleme kontrolÃ¼
async function checkAndCleanOldMessages() {
if (!currentUser) return;

try {
const now = new Date();
const today16 = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 16, 0, 0);

// Saat 16'dan Ã¶nceyse bugÃ¼nkÃ¼ 16:00'Ä± bekle
// Saat 16'dan sonraysa temizleme yap
if (now.getHours() < 16) {
return;
}

// Son temizleme zamanÄ±nÄ± kontrol et
const lastCleanupSnapshot = await database.ref('evde_saglik_ortak_veri/chat_last_cleanup').once('value');
const lastCleanup = lastCleanupSnapshot.val() || 0;

// BugÃ¼n 16:00'dan sonra temizleme yapÄ±ldÄ± mÄ±?
if (lastCleanup >= today16.getTime()) {
return;
}

// Temizlik yap
await database.ref('evde_saglik_ortak_veri/chat_messages').remove();
await database.ref('evde_saglik_ortak_veri/chat_last_cleanup').set(Date.now());

showToast('ğŸ’¬ GÃ¼nlÃ¼k sohbet temizliÄŸi yapÄ±ldÄ±', 'info');

} catch (error) {
console.error('Sohbet temizleme hatasÄ±:', error);
}
}

// Admin iÃ§in tÃ¼m mesajlarÄ± temizle
window.clearAllChatMessages = async function () {
if (currentUserRole !== 'admin') {
showToast('Bu iÅŸlem sadece admin tarafÄ±ndan yapÄ±labilir!', 'error');
return;
}

if (!confirm('âš ï¸ TÃ¼m sohbet mesajlarÄ± kalÄ±cÄ± olarak silinecek!\n\nBu iÅŸlemi onaylÄ±yor musunuz?')) {
return;
}

try {
await database.ref('evde_saglik_ortak_veri/chat_messages').remove();
await database.ref('evde_saglik_ortak_veri/chat_last_cleanup').set(Date.now());

showToast('âœ… TÃ¼m mesajlar temizlendi!', 'success');
} catch (error) {
console.error('Mesaj temizleme hatasÄ±:', error);
showToast('Mesajlar temizlenemedi!', 'error');
}
};

// Auth deÄŸiÅŸikliÄŸinde sohbet dinleyicisini baÅŸlat
if (typeof auth !== 'undefined') {
auth.onAuthStateChanged((user) => {
if (user) {
setTimeout(() => {
listenForChatMessages();
checkAndCleanOldMessages();
lastSeenTimestamp = Date.now();
}, 2500);
}
});
}

// GiriÅŸ yapmamÄ±ÅŸsa sohbet butonunu gizle
setTimeout(() => {
const chatBtn = document.getElementById('chat-toggle-btn');
if (chatBtn && !currentUser) {
chatBtn.style.display = 'none';
}
}, 3000);

</script>

<div id="birthday-banner" class="fixed top-0 left-0 right-0 z-[300] hidden">
<div class="bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 text-white py-3 px-4 shadow-lg">
<div class="max-w-4xl mx-auto flex items-center justify-between">
<div class="flex items-center gap-3">
<span class="text-3xl animate-bounce">ğŸ‚</span>
<span class="text-3xl">ğŸ‰</span>
<div>
<p class="font-bold text-lg" id="birthday-banner-text">BugÃ¼n birinin doÄŸum gÃ¼nÃ¼!</p>
<p class="text-sm text-white/80" id="birthday-banner-note"></p>
</div>
<span class="text-3xl">ğŸˆ</span>
<span class="text-3xl animate-bounce">ğŸ</span>
</div>
<button onclick="closeBirthdayBanner()"
class="text-white/80 hover:text-white text-2xl font-bold px-2">âœ•</button>
</div>
</div>
</div>

<script>
// ============================================
// PANSUMAN TAKÄ°P SÄ°STEMÄ° - V5 (ADMIN + LOG)
// ============================================

let pansumanList = [];
let pansumanCurrentSubtab = 'pazartesi';
let pansumanSearchMode = false;
let generatedPansumanLists = [];

const PANSUMAN_DAYS_MAP = { 'pazartesi': 'Pazartesi', 'sali': 'SalÄ±', 'carsamba': 'Ã‡arÅŸamba', 'persembe': 'PerÅŸembe', 'cuma': 'Cuma', 'cumartesi': 'Cumartesi', 'pazar': 'Pazar' };
const PANSUMAN_DAYS_SHORT = { 'pazartesi': 'Pzt', 'sali': 'Sal', 'carsamba': 'Ã‡ar', 'persembe': 'Per', 'cuma': 'Cum', 'cumartesi': 'Cmt', 'pazar': 'Paz' };

// Admin kontrolÃ¼ - currentUserRole deÄŸiÅŸkenini kullan
function isPansumanAdmin() {
// currentUserRole global deÄŸiÅŸkeni kullanÄ±lÄ±yor (rol sisteminden)
if (typeof currentUserRole === 'undefined') return false;
return currentUserRole === 'admin' || currentUserRole === 'Admin';
}

// Admin deÄŸilse uyarÄ± gÃ¶ster
function checkPansumanAdminAccess(action = 'Bu iÅŸlemi') {
if (!isPansumanAdmin()) {
showToast(`${action} yapmak iÃ§in admin yetkisi gereklidir!`, 'error');
return false;
}
return true;
}

async function loadPansumanData() {
if (typeof firebase !== 'undefined' && firebase.database) {
try {
const snapshot = await firebase.database().ref('evde_saglik_ortak_veri/pansuman_list').once('value');
const data = snapshot.val();
pansumanList = data ? (Array.isArray(data) ? data : Object.values(data)) : [];
renderPansumanContent();
} catch (e) { console.error('Pansuman verileri yÃ¼klenemedi:', e); }
}
}

async function savePansumanData() {
if (typeof firebase !== 'undefined' && firebase.database) {
try { await firebase.database().ref('evde_saglik_ortak_veri/pansuman_list').set(pansumanList); }
catch (e) { console.error('Pansuman verileri kaydedilemedi:', e); }
}
}

// Buton seÃ§im fonksiyonlarÄ±
window.selectPansumanLocation = function (value) {
document.getElementById('pansuman-location-value').value = value;
document.querySelectorAll('#pansuman-location-btns button').forEach(btn => {
if (btn.dataset.value === value) {
btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
if (value === 'merkez') {
btn.classList.add('bg-blue-500', 'border-blue-500', 'text-white');
} else {
btn.classList.add('bg-green-500', 'border-green-500', 'text-white');
}
} else {
btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
btn.classList.remove('bg-blue-500', 'border-blue-500', 'bg-green-500', 'border-green-500', 'text-white');
}
});
};

window.selectPansumanType = function (value) {
document.getElementById('pansuman-type-value').value = value;
const colors = { 'dekubit': 'red', 'sutur': 'blue', 'diger': 'gray' };
document.querySelectorAll('#pansuman-type-btns button').forEach(btn => {
const btnValue = btn.dataset.value;
const color = colors[btnValue];
if (btnValue === value) {
btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
btn.classList.add(`bg-${color}-500`, `border-${color}-500`, 'text-white');
if (color === 'gray') btn.classList.add('bg-gray-600', 'border-gray-600');
} else {
btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
btn.classList.remove(`bg-${colors[btnValue]}-500`, `border-${colors[btnValue]}-500`, 'bg-gray-600', 'border-gray-600', 'text-white');
}
});
};

window.togglePansumanDay = function (btn, value) {
const selected = btn.dataset.selected === 'true';
btn.dataset.selected = (!selected).toString();
if (!selected) {
btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
btn.classList.add('bg-pink-500', 'border-pink-500', 'text-white');
} else {
btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
btn.classList.remove('bg-pink-500', 'border-pink-500', 'text-white');
}
};

window.selectPansumanRepeat = function (value) {
document.getElementById('pansuman-repeat-value').value = value;
document.querySelectorAll('#pansuman-repeat-btns button').forEach(btn => {
if (parseInt(btn.dataset.value) === value) {
btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
btn.classList.add('bg-purple-500', 'border-purple-500', 'text-white');
} else {
btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
btn.classList.remove('bg-purple-500', 'border-purple-500', 'text-white');
}
});
};

window.addPansumanPatient = function () {
// Admin kontrolÃ¼
if (!checkPansumanAdminAccess('Hasta ekleme')) return;

const patient = document.getElementById('pansuman-patient').value.trim();
const phone = document.getElementById('pansuman-phone').value.trim();
const address = document.getElementById('pansuman-address').value.trim();
const type = document.getElementById('pansuman-type-value').value || 'diger';
const location = document.getElementById('pansuman-location-value').value || 'merkez';
const note = document.getElementById('pansuman-note').value.trim();
const days = Array.from(document.querySelectorAll('#pansuman-days-btns button[data-selected="true"]')).map(btn => btn.dataset.value);
const repeatCount = parseInt(document.getElementById('pansuman-repeat-value').value || '0');

if (!patient) { showToast('Hasta adÄ± girin!', 'error'); return; }
if (days.length === 0) { showToast('En az bir gÃ¼n seÃ§in!', 'error'); return; }

const typeLabels = { dekubit: 'DekÃ¼bit', sutur: 'SÃ¼tÃ¼r', diger: 'DiÄŸer' };
const daysStr = days.map(d => PANSUMAN_DAYS_SHORT[d]).join(', ');

pansumanList.push({
id: Date.now(), patient, phone, address, type, location, note, days,
repeatCount,
status: 'active', createdAt: new Date().toISOString(), createdBy: currentUser?.email || 'unknown'
});
savePansumanData();

// Aktivite logu
if (typeof addActivityLog === 'function') {
addActivityLog('pansuman', 'Yeni hasta eklendi', `${patient} - ${typeLabels[type] || type} (${location === 'merkez' ? 'Merkez' : 'KÃ¶y'}) - ${daysStr}`);
}

// Form temizle
document.getElementById('pansuman-patient').value = '';
document.getElementById('pansuman-phone').value = '';
document.getElementById('pansuman-address').value = '';
document.getElementById('pansuman-note').value = '';

// GÃ¼nleri sÄ±fÄ±rla
document.querySelectorAll('#pansuman-days-btns button').forEach(btn => {
btn.dataset.selected = 'false';
btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
btn.classList.remove('bg-pink-500', 'border-pink-500', 'text-white');
});

// VarsayÄ±lan deÄŸerlere dÃ¶n
selectPansumanLocation('merkez');
selectPansumanType('diger');
selectPansumanRepeat(0);

showToast('Hasta eklendi!', 'success');
renderPansumanContent();
};

window.switchPansumanSubtab = function (subtab) {
pansumanCurrentSubtab = subtab;
pansumanSearchMode = false;
const searchInput = document.getElementById('pansuman-search-input');
const clearBtn = document.getElementById('pansuman-search-clear');
if (searchInput) searchInput.value = '';
if (clearBtn) clearBtn.classList.add('hidden');

// TÃ¼m sekme butonlarÄ±nÄ± resetle
document.querySelectorAll('.pansuman-subtab-btn').forEach(btn => {
btn.classList.remove('bg-pink-500', 'text-white', 'border-pink-500', 'bg-blue-500', 'border-blue-500', 'bg-emerald-500', 'border-emerald-500', 'bg-red-500', 'border-red-500', 'bg-indigo-500', 'border-indigo-500', 'shadow-sm');
btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-200', 'border-transparent');
});

const activeBtn = document.getElementById(`pansuman-subtab-${subtab}`);
if (activeBtn) {
activeBtn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-200', 'border-transparent');
// Sekme tÃ¼rÃ¼ne gÃ¶re renk
if (subtab === 'yatisli') {
activeBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500', 'shadow-sm');
} else if (subtab === 'biten') {
activeBtn.classList.add('bg-emerald-500', 'text-white', 'border-emerald-500', 'shadow-sm');
} else if (subtab === 'silindi') {
activeBtn.classList.add('bg-red-500', 'text-white', 'border-red-500', 'shadow-sm');
} else if (subtab === 'listeOlustur') {
activeBtn.classList.add('bg-indigo-500', 'text-white', 'border-indigo-500', 'shadow-sm');
} else {
activeBtn.classList.add('bg-pink-500', 'text-white', 'border-pink-500', 'shadow-sm');
}
}
renderPansumanContent();
};

window.clearPansumanSearch = function () {
const searchInput = document.getElementById('pansuman-search-input');
const clearBtn = document.getElementById('pansuman-search-clear');
if (searchInput) searchInput.value = '';
if (clearBtn) clearBtn.classList.add('hidden');
pansumanSearchMode = false;
renderPansumanContent();
};

function renderPansumanSearchResults(query) {
const contentArea = document.getElementById('pansuman-content-area');
if (!contentArea) return;
const q = query.toLowerCase();
const results = pansumanList.filter(p => p.patient?.toLowerCase().includes(q) || p.address?.toLowerCase().includes(q) || p.phone?.includes(q) || p.note?.toLowerCase().includes(q));

contentArea.innerHTML = `
<div class="mb-4 p-4 bg-amber-100 dark:bg-amber-900/30 border border-amber-300 dark:border-amber-700 rounded-2xl flex items-center justify-between">
<span class="text-base text-amber-800 dark:text-amber-200 font-medium"><i data-lucide="search" class="w-5 h-5 inline-block mr-2"></i>"${escapeHtml(query)}" iÃ§in ${results.length} sonuÃ§</span>
<button onclick="clearPansumanSearch()" class="text-sm text-amber-700 dark:text-amber-300 font-semibold px-3 py-1 bg-amber-200 dark:bg-amber-800 rounded-lg hover:bg-amber-300 dark:hover:bg-amber-700 transition">Temizle</button>
</div>
<div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm">
<table class="w-full">
<thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 dark:text-gray-200">Ad Soyad</th><th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 dark:text-gray-200">Adres</th><th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 dark:text-gray-200">Telefon</th><th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 dark:text-gray-200">Ä°ÅŸlem</th></tr></thead>
<tbody class="divide-y divide-gray-200 dark:divide-gray-700">${results.length === 0 ? '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-400 dark:text-gray-500 text-base">SonuÃ§ bulunamadÄ±.</td></tr>' : results.map(p => renderPansumanTableRow(p, p.status !== 'active')).join('')}</tbody>
</table>
</div>`;
if (typeof lucide !== 'undefined') lucide.createIcons();
}

window.renderPansumanContent = function () {
if (pansumanSearchMode) return;
const contentArea = document.getElementById('pansuman-content-area');
if (!contentArea) return;

if (pansumanCurrentSubtab === 'listeOlustur') { renderListeOlusturucu(); return; }

// YATIÅLI sekmesi
if (pansumanCurrentSubtab === 'yatisli') {
const yatisliList = pansumanList.filter(p => p.status === 'yatisli');
contentArea.innerHTML = `
<div class="mb-4 flex items-center gap-3">
<div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl flex items-center justify-center shadow-lg"><i data-lucide="bed" class="w-5 h-5 text-white"></i></div>
<div><h4 class="font-bold text-gray-800 dark:text-white text-lg">YatÄ±ÅŸlÄ± Hastalar</h4><p class="text-sm text-gray-500 dark:text-gray-400">${yatisliList.length} hasta</p></div>
</div>
<div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm">
<table class="w-full"><thead class="bg-blue-100 dark:bg-blue-900/50"><tr><th class="px-4 py-3 text-left text-sm font-semibold text-blue-800 dark:text-blue-200">Ad Soyad</th><th class="px-4 py-3 text-left text-sm font-semibold text-blue-800 dark:text-blue-200">Adres</th><th class="px-4 py-3 text-left text-sm font-semibold text-blue-800 dark:text-blue-200">Telefon</th><th class="px-4 py-3 text-center text-sm font-semibold text-blue-800 dark:text-blue-200">Ä°ÅŸlem</th></tr></thead>
<tbody class="divide-y divide-gray-200 dark:divide-gray-700">${yatisliList.length === 0 ? '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-400 dark:text-gray-500 text-base">YatÄ±ÅŸlÄ± hasta yok.</td></tr>' : yatisliList.map(p => renderPansumanTableRow(p, 'yatisli')).join('')}</tbody></table>
</div>`;
if (typeof lucide !== 'undefined') lucide.createIcons();
return;
}

// BÄ°TEN sekmesi (sadece stoplanan hastalar)
if (pansumanCurrentSubtab === 'biten') {
const bitenList = pansumanList.filter(p => p.status === 'completed');
contentArea.innerHTML = `
<div class="mb-4 flex items-center gap-3">
<div class="w-10 h-10 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-xl flex items-center justify-center shadow-lg"><i data-lucide="check-circle-2" class="w-5 h-5 text-white"></i></div>
<div><h4 class="font-bold text-gray-800 dark:text-white text-lg">Biten Pansumanlar (Stop)</h4><p class="text-sm text-gray-500 dark:text-gray-400">${bitenList.length} hasta</p></div>
</div>
<div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm">
<table class="w-full"><thead class="bg-emerald-100 dark:bg-emerald-900/50"><tr><th class="px-4 py-3 text-left text-sm font-semibold text-emerald-800 dark:text-emerald-200">Ad Soyad</th><th class="px-4 py-3 text-left text-sm font-semibold text-emerald-800 dark:text-emerald-200">Adres</th><th class="px-4 py-3 text-left text-sm font-semibold text-emerald-800 dark:text-emerald-200">Telefon</th><th class="px-4 py-3 text-center text-sm font-semibold text-emerald-800 dark:text-emerald-200">Ä°ÅŸlem</th></tr></thead>
<tbody class="divide-y divide-gray-200 dark:divide-gray-700">${bitenList.length === 0 ? '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-400 dark:text-gray-500 text-base">Biten pansuman yok.</td></tr>' : bitenList.map(p => renderPansumanTableRow(p, 'biten')).join('')}</tbody></table>
</div>`;
if (typeof lucide !== 'undefined') lucide.createIcons();
return;
}

// SÄ°LÄ°NDÄ° sekmesi
if (pansumanCurrentSubtab === 'silindi') {
const silindiList = pansumanList.filter(p => p.status === 'deleted');
contentArea.innerHTML = `
<div class="mb-4 flex items-center gap-3">
<div class="w-10 h-10 bg-gradient-to-br from-red-400 to-red-600 rounded-xl flex items-center justify-center shadow-lg"><i data-lucide="trash-2" class="w-5 h-5 text-white"></i></div>
<div><h4 class="font-bold text-gray-800 dark:text-white text-lg">Silinen Hastalar</h4><p class="text-sm text-gray-500 dark:text-gray-400">${silindiList.length} hasta</p></div>
</div>
<div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm">
<table class="w-full"><thead class="bg-red-100 dark:bg-red-900/50"><tr><th class="px-4 py-3 text-left text-sm font-semibold text-red-800 dark:text-red-200">Ad Soyad</th><th class="px-4 py-3 text-left text-sm font-semibold text-red-800 dark:text-red-200">Adres</th><th class="px-4 py-3 text-left text-sm font-semibold text-red-800 dark:text-red-200">Telefon</th><th class="px-4 py-3 text-center text-sm font-semibold text-red-800 dark:text-red-200">Ä°ÅŸlem</th></tr></thead>
<tbody class="divide-y divide-gray-200 dark:divide-gray-700">${silindiList.length === 0 ? '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-400 dark:text-gray-500 text-base">Silinen hasta yok.</td></tr>' : silindiList.map(p => renderPansumanTableRow(p, 'silindi')).join('')}</tbody></table>
</div>`;
if (typeof lucide !== 'undefined') lucide.createIcons();
return;
}

// HaftalÄ±k tekrar kontrolÃ¼ - aktif hastalarda sadece geÃ§erli olanlarÄ± gÃ¶ster
const now = new Date();
const dayPatients = pansumanList.filter(p => {
if (p.status !== 'active') return false;
if (!p.days?.includes(pansumanCurrentSubtab)) return false;

// HaftalÄ±k tekrar kontrolÃ¼
if (p.repeatCount > 0 && p.createdAt) {
const createdDate = new Date(p.createdAt);
const weeksPassed = Math.floor((now - createdDate) / (7 * 24 * 60 * 60 * 1000));
// EÄŸer geÃ§en hafta sayÄ±sÄ± repeatCount'u geÃ§tiyse gÃ¶sterme
if (weeksPassed >= p.repeatCount) {
return false;
}
}
return true;
});
const merkez = dayPatients.filter(p => p.location === 'merkez');
const koy = dayPatients.filter(p => p.location === 'koy');

contentArea.innerHTML = `
<div class="mb-6">
<div class="flex items-center gap-3 mb-4">
<div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-xl flex items-center justify-center shadow-lg"><i data-lucide="building-2" class="w-5 h-5 text-white"></i></div>
<div><h4 class="font-bold text-gray-800 dark:text-white text-lg">Merkez</h4><p class="text-sm text-gray-500 dark:text-gray-400">${merkez.length} hasta</p></div>
</div>
<div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm">
<table class="w-full"><thead class="bg-blue-100 dark:bg-blue-900/50"><tr><th class="px-4 py-3 text-left text-sm font-semibold text-blue-800 dark:text-blue-200">Ad Soyad</th><th class="px-4 py-3 text-left text-sm font-semibold text-blue-800 dark:text-blue-200">Adres</th><th class="px-4 py-3 text-left text-sm font-semibold text-blue-800 dark:text-blue-200">Telefon</th><th class="px-4 py-3 text-center text-sm font-semibold text-blue-800 dark:text-blue-200">Ä°ÅŸlem</th></tr></thead>
<tbody class="divide-y divide-gray-200 dark:divide-gray-700">${merkez.length === 0 ? '<tr><td colspan="4" class="px-4 py-6 text-center text-gray-400 dark:text-gray-500 text-base">Bu gÃ¼n iÃ§in merkez hastasÄ± yok.</td></tr>' : merkez.map(p => renderPansumanTableRow(p, false)).join('')}</tbody></table>
</div>
</div>
<div>
<div class="flex items-center gap-3 mb-4">
<div class="w-10 h-10 bg-gradient-to-br from-green-400 to-emerald-500 rounded-xl flex items-center justify-center shadow-lg"><i data-lucide="trees" class="w-5 h-5 text-white"></i></div>
<div><h4 class="font-bold text-gray-800 dark:text-white text-lg">KÃ¶y</h4><p class="text-sm text-gray-500 dark:text-gray-400">${koy.length} hasta</p></div>
</div>
<div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm">
<table class="w-full"><thead class="bg-green-100 dark:bg-green-900/50"><tr><th class="px-4 py-3 text-left text-sm font-semibold text-green-800 dark:text-green-200">Ad Soyad</th><th class="px-4 py-3 text-left text-sm font-semibold text-green-800 dark:text-green-200">Adres</th><th class="px-4 py-3 text-left text-sm font-semibold text-green-800 dark:text-green-200">Telefon</th><th class="px-4 py-3 text-center text-sm font-semibold text-green-800 dark:text-green-200">Ä°ÅŸlem</th></tr></thead>
<tbody class="divide-y divide-gray-200 dark:divide-gray-700">${koy.length === 0 ? '<tr><td colspan="4" class="px-4 py-6 text-center text-gray-400 dark:text-gray-500 text-base">Bu gÃ¼n iÃ§in kÃ¶y hastasÄ± yok.</td></tr>' : koy.map(p => renderPansumanTableRow(p, false)).join('')}</tbody></table>
</div>
</div>`;
if (typeof lucide !== 'undefined') lucide.createIcons();
};

function renderPansumanTableRow(p, tabType) {
const typeConfig = { 'dekubit': { bg: 'bg-red-500', label: 'DekÃ¼bit' }, 'sutur': { bg: 'bg-blue-500', label: 'SÃ¼tÃ¼r' }, 'diger': { bg: 'bg-gray-500', label: 'DiÄŸer' } };
const tc = typeConfig[p.type] || typeConfig.diger;
const daysStr = p.days?.map(d => PANSUMAN_DAYS_SHORT[d] || d).join(', ') || '';

// HaftalÄ±k tekrar sayÄ±sÄ± badge
let repeatBadge = '';
if (p.repeatCount === 0) {
repeatBadge = '<span class="inline-flex items-center gap-1 bg-purple-500 text-white text-xs px-2 py-1 rounded-lg font-bold">âˆ</span>';
} else if (p.repeatCount > 0) {
// Kalan hafta sayÄ±sÄ±nÄ± hesapla
const now = new Date();
const createdDate = p.createdAt ? new Date(p.createdAt) : now;
const weeksPassed = Math.floor((now - createdDate) / (7 * 24 * 60 * 60 * 1000));
const remainingWeeks = Math.max(0, p.repeatCount - weeksPassed);
repeatBadge = `<span class="inline-flex items-center gap-1 bg-purple-500 text-white text-xs px-2 py-1 rounded-lg font-bold">${remainingWeeks}/${p.repeatCount} hf</span>`;
}

const statusBadge = p.status === 'completed' ? '<span class="inline-flex items-center gap-1 bg-emerald-500 text-white text-xs px-2 py-1 rounded-lg font-medium">Stop</span>' : p.status === 'yatisli' ? '<span class="inline-flex items-center gap-1 bg-blue-600 text-white text-xs px-2 py-1 rounded-lg font-medium">YatÄ±ÅŸ</span>' : p.status === 'deleted' ? '<span class="inline-flex items-center gap-1 bg-red-500 text-white text-xs px-2 py-1 rounded-lg font-medium">Silindi</span>' : '';

// Ekleyen ve tarih bilgisi
let createdInfo = '';
if (p.createdBy || p.createdAt) {
const createdByShort = p.createdBy ? p.createdBy.split('@')[0] : '?';
const createdDate = p.createdAt ? new Date(p.createdAt).toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: '2-digit' }) : '';
createdInfo = `<div class="text-[10px] text-gray-400 dark:text-gray-500 mt-1 flex items-center gap-1"><i data-lucide="user" class="w-3 h-3"></i>${createdByShort} â€¢ ${createdDate}</div>`;
}

// Sekme tÃ¼rÃ¼ne gÃ¶re butonlar
let actionButtons = '';
if (tabType === 'silindi') {
// Silindi sekmesinde: Geri Al ve KalÄ±cÄ± Sil
actionButtons = `
<button onclick="restorePansumanPatient(${p.id})" class="p-2 hover:bg-blue-100 dark:hover:bg-blue-900/50 rounded-xl text-blue-600 dark:text-blue-400 transition" title="Geri Al"><i data-lucide="undo-2" class="w-5 h-5"></i></button>
<button onclick="permanentDeletePansumanPatient(${p.id})" class="p-2 hover:bg-red-100 dark:hover:bg-red-900/50 rounded-xl text-red-500 dark:text-red-400 transition" title="KalÄ±cÄ± Sil"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
`;
} else if (tabType === 'yatisli') {
// YatÄ±ÅŸlÄ± sekmesinde: Geri Al (aktife) ve Sil
actionButtons = `
<button onclick="restorePansumanPatient(${p.id})" class="p-2 hover:bg-blue-100 dark:hover:bg-blue-900/50 rounded-xl text-blue-600 dark:text-blue-400 transition" title="Aktife Al"><i data-lucide="undo-2" class="w-5 h-5"></i></button>
<button onclick="deletePansumanPatient(${p.id})" class="p-2 hover:bg-red-100 dark:hover:bg-red-900/50 rounded-xl text-red-500 dark:text-red-400 transition" title="Sil"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
`;
} else if (tabType === 'biten') {
// Biten sekmesinde: Geri Al (aktife) ve Sil
actionButtons = `
<button onclick="restorePansumanPatient(${p.id})" class="p-2 hover:bg-blue-100 dark:hover:bg-blue-900/50 rounded-xl text-blue-600 dark:text-blue-400 transition" title="Aktife Al"><i data-lucide="undo-2" class="w-5 h-5"></i></button>
<button onclick="deletePansumanPatient(${p.id})" class="p-2 hover:bg-red-100 dark:hover:bg-red-900/50 rounded-xl text-red-500 dark:text-red-400 transition" title="Sil"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
`;
} else {
// Aktif gÃ¼n sekmelerinde: Stop, YatÄ±ÅŸ, DÃ¼zenle, Sil (Tamamla butonu kaldÄ±rÄ±ldÄ±)
actionButtons = `
<button onclick="stopPansumanPatient(${p.id})" class="p-2 hover:bg-orange-100 dark:hover:bg-orange-900/50 rounded-xl text-orange-600 dark:text-orange-400 transition" title="Stopla"><i data-lucide="ban" class="w-5 h-5"></i></button>
<button onclick="yatisliPansumanPatient(${p.id})" class="p-2 hover:bg-blue-100 dark:hover:bg-blue-900/50 rounded-xl text-blue-600 dark:text-blue-400 transition" title="YatÄ±ÅŸlÄ±"><i data-lucide="bed" class="w-5 h-5"></i></button>
<button onclick="openPansumanEditModal(${p.id})" class="p-2 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 rounded-xl text-indigo-600 dark:text-indigo-400 transition" title="DÃ¼zenle"><i data-lucide="edit-3" class="w-5 h-5"></i></button>
<button onclick="deletePansumanPatient(${p.id})" class="p-2 hover:bg-red-100 dark:hover:bg-red-900/50 rounded-xl text-red-500 dark:text-red-400 transition" title="Sil"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
`;
}

return `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition">
<td class="px-4 py-3">
<div class="font-semibold text-gray-800 dark:text-white text-base">${escapeHtml(p.patient || '')}</div>
<div class="flex items-center gap-2 mt-1.5 flex-wrap">
<span class="inline-flex items-center gap-1.5 ${tc.bg} text-white text-xs px-2 py-1 rounded-lg font-medium">${tc.label}</span>
<span class="text-xs text-gray-500 dark:text-gray-400 bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded-lg">${daysStr}</span>
${repeatBadge}
${statusBadge}
</div>
${p.note ? `<div class="text-sm text-gray-500 dark:text-gray-400 mt-1">${escapeHtml(p.note)}</div>` : ''}
${createdInfo}
</td>
<td class="px-4 py-3 text-gray-600 dark:text-gray-300 text-base">${escapeHtml(p.address || '-')}</td>
<td class="px-4 py-3 text-gray-600 dark:text-gray-300 text-base">${escapeHtml(p.phone || '-')}</td>
<td class="px-4 py-3"><div class="flex items-center justify-center gap-1 flex-wrap max-w-[200px] md:max-w-none">${actionButtons}</div></td>
</tr>`;
}

window.completePansumanVisit = function (id) {
// Admin kontrolÃ¼
if (!checkPansumanAdminAccess('Ziyaret tamamlama')) return;

const idx = pansumanList.findIndex(p => p.id === id);
if (idx === -1) return;
const p = pansumanList[idx];

if (p.repeatCount === 0) {
// Aktivite logu - sÃ¼rekli hasta
if (typeof addActivityLog === 'function') {
addActivityLog('pansuman', 'Ziyaret kaydedildi (sÃ¼rekli)', `${p.patient}`);
}
showToast('SÃ¼rekli hasta, ziyaret kaydedildi.', 'success');
return;
}

p.repeatCount--;
if (p.repeatCount <= 0) {
p.status = 'completed';
p.completedAt = new Date().toISOString();
// Aktivite logu - otomatik stop
if (typeof addActivityLog === 'function') {
addActivityLog('pansuman', 'Hasta otomatik stoplandÄ±', `${p.patient} - Son ziyaret tamamlandÄ±`);
}
showToast('Son ziyaret tamamlandÄ±, hasta otomatik stoplandÄ±.', 'success');
} else {
// Aktivite logu - ziyaret
if (typeof addActivityLog === 'function') {
addActivityLog('pansuman', 'Ziyaret tamamlandÄ±', `${p.patient} - Kalan: ${p.repeatCount}`);
}
showToast(`Ziyaret tamamlandÄ±. Kalan: ${p.repeatCount}`, 'success');
}
savePansumanData();
renderPansumanContent();
};

// Modal buton seÃ§im fonksiyonlarÄ±
window.selectPansumanEditLocation = function (value) {
document.getElementById('pansuman-edit-location-value').value = value;
document.querySelectorAll('#pansuman-edit-location-btns button').forEach(btn => {
if (btn.dataset.value === value) {
btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
if (value === 'merkez') {
btn.classList.add('bg-blue-500', 'border-blue-500', 'text-white');
} else {
btn.classList.add('bg-green-500', 'border-green-500', 'text-white');
}
} else {
btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
btn.classList.remove('bg-blue-500', 'border-blue-500', 'bg-green-500', 'border-green-500', 'text-white');
}
});
};

window.selectPansumanEditType = function (value) {
document.getElementById('pansuman-edit-type-value').value = value;
document.querySelectorAll('#pansuman-edit-type-btns button').forEach(btn => {
const btnValue = btn.dataset.value;
btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
btn.classList.remove('bg-red-500', 'border-red-500', 'bg-blue-500', 'border-blue-500', 'bg-gray-600', 'border-gray-600', 'text-white');
if (btnValue === value) {
btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
if (value === 'dekubit') btn.classList.add('bg-red-500', 'border-red-500', 'text-white');
else if (value === 'sutur') btn.classList.add('bg-blue-500', 'border-blue-500', 'text-white');
else btn.classList.add('bg-gray-600', 'border-gray-600', 'text-white');
}
});
};

window.togglePansumanEditDay = function (btn, value) {
const selected = btn.dataset.selected === 'true';
btn.dataset.selected = (!selected).toString();
if (!selected) {
btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
btn.classList.add('bg-pink-500', 'border-pink-500', 'text-white');
} else {
btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
btn.classList.remove('bg-pink-500', 'border-pink-500', 'text-white');
}
};

window.openPansumanEditModal = function (id) {
// Admin kontrolÃ¼
if (!checkPansumanAdminAccess('Hasta dÃ¼zenleme')) return;

const p = pansumanList.find(x => x.id === id);
if (!p) return;
document.getElementById('pansuman-edit-id').value = id;
document.getElementById('pansuman-edit-patient').value = p.patient || '';
document.getElementById('pansuman-edit-phone').value = p.phone || '';
document.getElementById('pansuman-edit-address').value = p.address || '';
document.getElementById('pansuman-edit-note').value = p.note || '';
document.getElementById('pansuman-edit-repeat').value = p.repeatCount ?? 0;

// Konum seÃ§
selectPansumanEditLocation(p.location || 'merkez');
// TÃ¼r seÃ§
selectPansumanEditType(p.type || 'diger');
// GÃ¼nleri seÃ§
document.querySelectorAll('#pansuman-edit-days-btns button').forEach(btn => {
const isSelected = p.days?.includes(btn.dataset.value);
btn.dataset.selected = isSelected.toString();
if (isSelected) {
btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
btn.classList.add('bg-pink-500', 'border-pink-500', 'text-white');
} else {
btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
btn.classList.remove('bg-pink-500', 'border-pink-500', 'text-white');
}
});

document.getElementById('pansuman-modal-title').textContent = 'Hasta DÃ¼zenle';
document.getElementById('pansuman-edit-modal').classList.remove('hidden');
document.getElementById('pansuman-edit-modal').classList.add('flex');
if (typeof lucide !== 'undefined') lucide.createIcons();
};

window.openPansumanRestoreModal = function (id) {
// Admin kontrolÃ¼
if (!checkPansumanAdminAccess('Hasta geri alma')) return;

const p = pansumanList.find(x => x.id === id);
if (!p) return;
document.getElementById('pansuman-edit-id').value = id;
document.getElementById('pansuman-edit-patient').value = p.patient || '';
document.getElementById('pansuman-edit-phone').value = p.phone || '';
document.getElementById('pansuman-edit-address').value = p.address || '';
document.getElementById('pansuman-edit-note').value = p.note || '';
document.getElementById('pansuman-edit-repeat').value = p.repeatCount ?? 0;

// Konum seÃ§
selectPansumanEditLocation(p.location || 'merkez');
// TÃ¼r seÃ§
selectPansumanEditType(p.type || 'diger');
// GÃ¼nleri sÄ±fÄ±rla (kullanÄ±cÄ± yeniden seÃ§sin)
document.querySelectorAll('#pansuman-edit-days-btns button').forEach(btn => {
btn.dataset.selected = 'false';
btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
btn.classList.remove('bg-pink-500', 'border-pink-500', 'text-white');
});

document.getElementById('pansuman-modal-title').textContent = 'HastayÄ± Geri Al';
document.getElementById('pansuman-edit-modal').classList.remove('hidden');
document.getElementById('pansuman-edit-modal').classList.add('flex');
if (typeof lucide !== 'undefined') lucide.createIcons();
};

window.closePansumanModal = function () {
document.getElementById('pansuman-edit-modal').classList.add('hidden');
document.getElementById('pansuman-edit-modal').classList.remove('flex');
};

window.savePansumanEdit = function () {
const id = parseInt(document.getElementById('pansuman-edit-id').value);
const idx = pansumanList.findIndex(p => p.id === id);
if (idx === -1) return;

const days = Array.from(document.querySelectorAll('#pansuman-edit-days-btns button[data-selected="true"]')).map(btn => btn.dataset.value);
if (days.length === 0) { showToast('En az bir gÃ¼n seÃ§in!', 'error'); return; }

const oldStatus = pansumanList[idx].status;
const patientName = document.getElementById('pansuman-edit-patient').value.trim();

pansumanList[idx].patient = patientName;
pansumanList[idx].phone = document.getElementById('pansuman-edit-phone').value.trim();
pansumanList[idx].address = document.getElementById('pansuman-edit-address').value.trim();
pansumanList[idx].note = document.getElementById('pansuman-edit-note').value.trim();
pansumanList[idx].location = document.getElementById('pansuman-edit-location-value').value || 'merkez';
pansumanList[idx].type = document.getElementById('pansuman-edit-type-value').value || 'diger';
pansumanList[idx].days = days;
pansumanList[idx].repeatCount = parseInt(document.getElementById('pansuman-edit-repeat').value) || 0;
pansumanList[idx].status = 'active';
pansumanList[idx].updatedAt = new Date().toISOString();
pansumanList[idx].updatedBy = currentUser?.email || 'unknown';
delete pansumanList[idx].completedAt;
delete pansumanList[idx].yatisAt;

savePansumanData();
closePansumanModal();
renderPansumanContent();

// Aktivite logu
if (typeof addActivityLog === 'function') {
const action = oldStatus !== 'active' ? 'Hasta geri alÄ±ndÄ±' : 'Hasta dÃ¼zenlendi';
addActivityLog('pansuman', action, patientName);
}
showToast('Hasta gÃ¼ncellendi!', 'success');
};

window.stopPansumanPatient = function (id) {
if (!checkPansumanAdminAccess('Hasta stoplama')) return;
const idx = pansumanList.findIndex(p => p.id === id);
if (idx === -1) return;
if (!confirm('Bu hastayÄ± stoplamak istediÄŸinize emin misiniz?')) return;
const patientName = pansumanList[idx].patient;
pansumanList[idx].status = 'completed';
pansumanList[idx].completedAt = new Date().toISOString();
pansumanList[idx].completedBy = currentUser?.email || 'unknown';
savePansumanData();
renderPansumanContent();
if (typeof addActivityLog === 'function') addActivityLog('pansuman', 'Hasta stoplandÄ±', patientName);
showToast('Hasta stoplandÄ± ve BÄ°TEN sekmesine taÅŸÄ±ndÄ±.', 'success');
};
window.yatisliPansumanPatient = function (id) {
if (!checkPansumanAdminAccess('Hasta yatÄ±ÅŸlÄ± iÅŸaretleme')) return;
const idx = pansumanList.findIndex(p => p.id === id);
if (idx === -1) return;
if (!confirm('Bu hastayÄ± yatÄ±ÅŸlÄ± olarak iÅŸaretlemek istediÄŸinize emin misiniz?')) return;
const patientName = pansumanList[idx].patient;
pansumanList[idx].status = 'yatisli';
pansumanList[idx].yatisAt = new Date().toISOString();
pansumanList[idx].yatisBy = currentUser?.email || 'unknown';
savePansumanData();
renderPansumanContent();
if (typeof addActivityLog === 'function') addActivityLog('pansuman', 'Hasta yatÄ±ÅŸlÄ± iÅŸaretlendi', patientName);
showToast('Hasta yatÄ±ÅŸlÄ± olarak iÅŸaretlendi ve YATIÅLI sekmesine taÅŸÄ±ndÄ±.', 'success');
};
// Soft delete - hasta SÄ°LÄ°NDÄ° sekmesine taÅŸÄ±nÄ±r
window.deletePansumanPatient = function (id) {
if (!checkPansumanAdminAccess('Hasta silme')) return;
const idx = pansumanList.findIndex(p => p.id === id);
if (idx === -1) return;
if (!confirm('Bu hastayÄ± silmek istediÄŸinize emin misiniz?\n(SÄ°LÄ°NDÄ° sekmesine taÅŸÄ±nacak)')) return;
const patientName = pansumanList[idx].patient;
pansumanList[idx].status = 'deleted';
pansumanList[idx].deletedAt = new Date().toISOString();
pansumanList[idx].deletedBy = currentUser?.email || 'unknown';
savePansumanData();
renderPansumanContent();
if (typeof addActivityLog === 'function') addActivityLog('pansuman', 'Hasta silindi', patientName);
showToast('Hasta SÄ°LÄ°NDÄ° sekmesine taÅŸÄ±ndÄ±.', 'success');
};
// Geri alma - hasta aktif duruma dÃ¶ner
window.restorePansumanPatient = function (id) {
if (!checkPansumanAdminAccess('Hasta geri alma')) return;
const idx = pansumanList.findIndex(p => p.id === id);
if (idx === -1) return;
if (!confirm('Bu hastayÄ± aktif listeye geri almak istediÄŸinize emin misiniz?')) return;
const patientName = pansumanList[idx].patient;
pansumanList[idx].status = 'active';
pansumanList[idx].restoredAt = new Date().toISOString();
pansumanList[idx].restoredBy = currentUser?.email || 'unknown';
savePansumanData();
renderPansumanContent();
if (typeof addActivityLog === 'function') addActivityLog('pansuman', 'Hasta geri alÄ±ndÄ±', patientName);
showToast('Hasta aktif listeye geri alÄ±ndÄ±.', 'success');
};
// KalÄ±cÄ± silme - hasta tamamen silinir
window.permanentDeletePansumanPatient = function (id) {
if (!checkPansumanAdminAccess('KalÄ±cÄ± silme')) return;
const p = pansumanList.find(x => x.id === id);
if (!p) return;
if (!confirm('Bu hastayÄ± KALICI olarak silmek istediÄŸinize emin misiniz?\n\nâš ï¸ Bu iÅŸlem geri alÄ±namaz!')) return;
const patientName = p.patient;
pansumanList = pansumanList.filter(x => x.id !== id);
savePansumanData();
renderPansumanContent();
if (typeof addActivityLog === 'function') addActivityLog('pansuman', 'Hasta kalÄ±cÄ± silindi', patientName);
showToast('Hasta kalÄ±cÄ± olarak silindi.', 'warning');
};

function extractMahalle(address) {
if (!address) return null;
const patterns = [/^(.+?)\s+mahallesi/i, /^(.+?)\s+mahalle/i, /^(.+?)\s+mah\./i, /^(.+?)\s+mah(?:\s|$)/i, /^(.+?)\s+mh\./i, /^(.+?)\s+mh(?:\s|$)/i];
for (const pattern of patterns) { const match = address.match(pattern); if (match) return match[1].trim(); }
return null;
}

function renderListeOlusturucu() {
const contentArea = document.getElementById('pansuman-content-area');
if (!contentArea) return;

contentArea.innerHTML = `
<div class="max-w-4xl mx-auto">
<div class="bg-gradient-to-br from-indigo-100 to-purple-100 dark:from-indigo-900/30 dark:to-purple-900/30 border border-indigo-200 dark:border-indigo-700 rounded-2xl p-6 mb-6 shadow-sm">
<div class="flex items-center gap-3 mb-6">
<div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg"><i data-lucide="layout-list" class="w-6 h-6 text-white"></i></div>
<div><h4 class="font-bold text-gray-800 dark:text-white text-xl">Liste OluÅŸturucu</h4><p class="text-sm text-gray-600 dark:text-gray-400">HastalarÄ± filtreleyerek yazdÄ±rÄ±labilir listeler oluÅŸturun</p></div>
</div>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
<div>
<label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">GÃ¼n</label>
<select id="liste-gun" class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl text-base focus:ring-2 focus:ring-indigo-500 outline-none" onchange="updateListeMahalleler()">
${Object.keys(PANSUMAN_DAYS_MAP).map(d => `<option value="${d}">${PANSUMAN_DAYS_MAP[d]}</option>`).join('')}
</select>
</div>
<div>
<label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">Konum</label>
<select id="liste-konum" class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl text-base focus:ring-2 focus:ring-indigo-500 outline-none" onchange="updateListeMahalleler()">
<option value="merkez">Merkez</option><option value="koy">KÃ¶y</option><option value="hepsi">Hepsi</option>
</select>
</div>
<div>
<label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">Liste SayÄ±sÄ±</label>
<select id="liste-sayi" class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl text-base focus:ring-2 focus:ring-indigo-500 outline-none">
<option value="1">1 Liste</option><option value="2">2 Liste</option><option value="3">3 Liste</option><option value="4">4 Liste</option>
</select>
</div>
</div>
<div class="mb-6">
<label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-3">Mahalle Filtresi</label>
<div id="liste-mahalleler" class="flex flex-wrap gap-2 p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-600 min-h-[60px]"></div>
</div>
<button onclick="generateListes()" class="px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl font-bold hover:from-indigo-600 hover:to-purple-700 transition-all text-base shadow-lg flex items-center gap-2">
<i data-lucide="list-plus" class="w-5 h-5"></i> Listeleri OluÅŸtur
</button>
</div>
<div id="generated-lists" class="space-y-4"></div>
</div>`;
if (typeof lucide !== 'undefined') lucide.createIcons();
updateListeMahalleler();
}

window.updateListeMahalleler = function () {
const gun = document.getElementById('liste-gun')?.value;
const konum = document.getElementById('liste-konum')?.value;
const container = document.getElementById('liste-mahalleler');
if (!container) return;

// TÃ¼m aktif hastalar (bu gÃ¼n ve konum iÃ§in)
let allPatients = pansumanList.filter(p => p.status === 'active' && p.days?.includes(gun));
if (konum !== 'hepsi') allPatients = allPatients.filter(p => p.location === konum);

// Listeye eklenen hastalarÄ±n ID'leri
const listedeOlanIds = new Set();
generatedPansumanLists.forEach(list => {
list.forEach(p => listedeOlanIds.add(p.id));
});

// Mahalle bazlÄ± kalan hasta sayÄ±sÄ± hesapla
const mahalleCount = {};
allPatients.forEach(p => {
const m = extractMahalle(p.address);
if (m) {
if (!mahalleCount[m]) mahalleCount[m] = { total: 0, remaining: 0 };
mahalleCount[m].total++;
if (!listedeOlanIds.has(p.id)) {
mahalleCount[m].remaining++;
}
}
});

const mahalleArr = Object.keys(mahalleCount).sort();

container.innerHTML = mahalleArr.length === 0
? '<span class="text-gray-400 dark:text-gray-500 text-base">Bu seÃ§imde mahalle bilgisi bulunamadÄ±.</span>'
: mahalleArr.map(m => {
const count = mahalleCount[m];
const badge = count.remaining > 0
? `<span class="ml-1 px-2 py-0.5 bg-white/30 rounded-full text-xs font-bold">${count.remaining}</span>`
: `<span class="ml-1 px-2 py-0.5 bg-green-400/50 rounded-full text-xs font-bold">âœ“</span>`;
return `<button type="button" onclick="toggleMahalleBtn(this)" data-value="${escapeHtml(m)}" data-selected="true" class="inline-flex items-center gap-1 px-4 py-2 bg-indigo-500 text-white rounded-xl font-medium text-sm hover:bg-indigo-600 transition border-2 border-indigo-500"><i data-lucide="check" class="w-4 h-4"></i>${escapeHtml(m)}${badge}</button>`;
}).join('');
if (typeof lucide !== 'undefined') lucide.createIcons();
};

window.toggleMahalleBtn = function (btn) {
const selected = btn.dataset.selected === 'true';
const value = btn.dataset.value;
btn.dataset.selected = (!selected).toString();

// Kalan hasta sayÄ±sÄ±nÄ± yeniden hesapla
const gun = document.getElementById('liste-gun')?.value;
const konum = document.getElementById('liste-konum')?.value;
let allPatients = pansumanList.filter(p => p.status === 'active' && p.days?.includes(gun));
if (konum !== 'hepsi') allPatients = allPatients.filter(p => p.location === konum);

const listedeOlanIds = new Set();
generatedPansumanLists.forEach(list => list.forEach(p => listedeOlanIds.add(p.id)));

let remaining = 0;
allPatients.forEach(p => {
const m = extractMahalle(p.address);
if (m === value && !listedeOlanIds.has(p.id)) remaining++;
});

const badge = remaining > 0
? `<span class="ml-1 px-2 py-0.5 bg-white/30 rounded-full text-xs font-bold">${remaining}</span>`
: `<span class="ml-1 px-2 py-0.5 bg-green-400/50 rounded-full text-xs font-bold">âœ“</span>`;

if (selected) {
btn.classList.remove('bg-indigo-500', 'text-white', 'border-indigo-500');
btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-300', 'border-gray-300', 'dark:border-gray-600');
btn.innerHTML = `${escapeHtml(value)}<span class="ml-1 px-2 py-0.5 bg-gray-300 dark:bg-gray-600 rounded-full text-xs font-bold">${remaining > 0 ? remaining : 'âœ“'}</span>`;
} else {
btn.classList.add('bg-indigo-500', 'text-white', 'border-indigo-500');
btn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-300', 'border-gray-300', 'dark:border-gray-600');
btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i>${escapeHtml(value)}${badge}`;
}
if (typeof lucide !== 'undefined') lucide.createIcons();
};

window.generateListes = function () {
const gun = document.getElementById('liste-gun')?.value;
const konum = document.getElementById('liste-konum')?.value;
const listeSayi = parseInt(document.getElementById('liste-sayi')?.value) || 1;
const container = document.getElementById('generated-lists');
if (!container) return;

const selectedMahalleler = Array.from(document.querySelectorAll('#liste-mahalleler button[data-selected="true"]')).map(btn => btn.dataset.value);
let patients = pansumanList.filter(p => p.status === 'active' && p.days?.includes(gun));
if (konum !== 'hepsi') patients = patients.filter(p => p.location === konum);
if (selectedMahalleler.length > 0) {
patients = patients.filter(p => { const m = extractMahalle(p.address); return m ? selectedMahalleler.includes(m) : false; });
}

if (patients.length === 0) { container.innerHTML = '<div class="text-center text-gray-400 dark:text-gray-500 p-8 bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700">SeÃ§ili kriterlere uygun hasta bulunamadÄ±.</div>'; return; }

const listsArr = Array.from({ length: listeSayi }, () => []);
patients.forEach((p, i) => listsArr[i % listeSayi].push({ ...p }));
generatedPansumanLists = listsArr;

renderGeneratedLists(gun, konum);
// Mahalle sayÄ±larÄ±nÄ± gÃ¼ncelle (listede olanlarÄ± Ã§Ä±kar)
updateListeMahalleler();
};

function renderGeneratedLists(gun, konum) {
const container = document.getElementById('generated-lists');
if (!container) return;

container.innerHTML = generatedPansumanLists.map((list, i) => `
<div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm" id="generated-list-${i}">
<div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-5 py-3 flex items-center justify-between">
<span class="font-bold text-lg">Liste ${i + 1} <span class="font-normal opacity-80">(${list.length} hasta)</span></span>
<div class="flex gap-2">
<button onclick="printListe(${i})" class="text-sm bg-white/20 px-4 py-2 rounded-xl hover:bg-white/30 transition font-medium flex items-center gap-2"><i data-lucide="printer" class="w-4 h-4"></i>YazdÄ±r</button>
</div>
</div>
<table class="w-full">
<thead class="bg-gray-100 dark:bg-gray-700"><tr>
<th class="px-3 py-3 text-left text-sm font-semibold text-gray-700 dark:text-gray-200 w-10">#</th>
<th class="px-3 py-3 text-left text-sm font-semibold text-gray-700 dark:text-gray-200">Ad Soyad</th>
<th class="px-3 py-3 text-left text-sm font-semibold text-gray-700 dark:text-gray-200">Adres</th>
<th class="px-3 py-3 text-left text-sm font-semibold text-gray-700 dark:text-gray-200">Telefon</th>
<th class="px-3 py-3 text-center text-sm font-semibold text-gray-700 dark:text-gray-200 w-24">Ä°ÅŸlem</th>
</tr></thead>
<tbody class="divide-y divide-gray-200 dark:divide-gray-700" id="liste-tbody-${i}">
${list.map((p, j) => renderEditableListRow(i, j, p)).join('')}
</tbody>
</table>
</div>`).join('');
if (typeof lucide !== 'undefined') lucide.createIcons();
}

function renderEditableListRow(listeIdx, rowIdx, p) {
return `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50" id="liste-row-${listeIdx}-${rowIdx}">
<td class="px-3 py-3 text-gray-500 dark:text-gray-400 font-medium">${rowIdx + 1}</td>
<td class="px-3 py-3 font-semibold text-gray-800 dark:text-white">${escapeHtml(p.patient || '')}</td>
<td class="px-3 py-3 text-gray-600 dark:text-gray-300">${escapeHtml(p.address || '-')}</td>
<td class="px-3 py-3 text-gray-600 dark:text-gray-300">${escapeHtml(p.phone || '-')}</td>
<td class="px-3 py-3 text-center">
<div class="flex items-center justify-center gap-1">
<button onclick="moveListePatient(${listeIdx}, ${rowIdx}, -1)" class="p-1.5 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg text-gray-500 dark:text-gray-400 transition ${rowIdx === 0 ? 'opacity-30 cursor-not-allowed' : ''}" ${rowIdx === 0 ? 'disabled' : ''} title="YukarÄ±"><i data-lucide="chevron-up" class="w-4 h-4"></i></button>
<button onclick="moveListePatient(${listeIdx}, ${rowIdx}, 1)" class="p-1.5 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg text-gray-500 dark:text-gray-400 transition ${rowIdx === generatedPansumanLists[listeIdx].length - 1 ? 'opacity-30 cursor-not-allowed' : ''}" ${rowIdx === generatedPansumanLists[listeIdx].length - 1 ? 'disabled' : ''} title="AÅŸaÄŸÄ±"><i data-lucide="chevron-down" class="w-4 h-4"></i></button>
<button onclick="removeFromListe(${listeIdx}, ${rowIdx})" class="p-1.5 hover:bg-red-100 dark:hover:bg-red-900/50 rounded-lg text-red-500 dark:text-red-400 transition" title="Listeden Ã‡Ä±kar"><i data-lucide="x" class="w-4 h-4"></i></button>
</div>
</td>
</tr>`;
}

window.moveListePatient = function (listeIdx, rowIdx, direction) {
const list = generatedPansumanLists[listeIdx];
const newIdx = rowIdx + direction;
if (newIdx < 0 || newIdx >= list.length) return;
[list[rowIdx], list[newIdx]] = [list[newIdx], list[rowIdx]];
const gun = document.getElementById('liste-gun')?.value;
const konum = document.getElementById('liste-konum')?.value;
renderGeneratedLists(gun, konum);
};

window.removeFromListe = function (listeIdx, rowIdx) {
generatedPansumanLists[listeIdx].splice(rowIdx, 1);
const gun = document.getElementById('liste-gun')?.value;
const konum = document.getElementById('liste-konum')?.value;
renderGeneratedLists(gun, konum);
// Mahalle sayÄ±larÄ±nÄ± gÃ¼ncelle
updateListeMahalleler();
};

window.printListe = function (listeIndex) {
const list = generatedPansumanLists?.[listeIndex]; if (!list) return;
const gun = document.getElementById('liste-gun')?.value;
const konum = document.getElementById('liste-konum')?.value;
const printContent = `<!DOCTYPE html><html><head><title>Pansuman Listesi ${listeIndex + 1}</title><style>body{font-family:Arial,sans-serif;font-size:14px;padding:20px}h1{font-size:20px;margin-bottom:5px}h2{font-size:14px;color:#666;margin-bottom:20px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ddd;padding:10px;text-align:left}th{background-color:#f0f0f0}tr:nth-child(even){background-color:#fafafa}</style></head><body><h1>Pansuman Listesi ${listeIndex + 1}</h1><h2>${PANSUMAN_DAYS_MAP[gun] || gun} - ${konum === 'merkez' ? 'Merkez' : konum === 'koy' ? 'KÃ¶y' : 'TÃ¼mÃ¼'} (${list.length} hasta)</h2><table><thead><tr><th style="width:30px">#</th><th>Ad Soyad</th><th>Adres</th><th>Telefon</th></tr></thead><tbody>${list.map((p, i) => `<tr><td>${i + 1}</td><td>${p.patient || ''}</td><td>${p.address || '-'}</td><td>${p.phone || '-'}</td></tr>`).join('')}</tbody></table></body></html>`;
const printWindow = window.open('', '_blank'); printWindow.document.write(printContent); printWindow.document.close(); printWindow.print();
};

function startPansumanRealtimeListener() {
if (typeof firebase === 'undefined' || !firebase.database) { setTimeout(startPansumanRealtimeListener, 1000); return; }
firebase.database().ref('evde_saglik_ortak_veri/pansuman_list').on('value', (snapshot) => {
const data = snapshot.val();
pansumanList = data ? (Array.isArray(data) ? data : Object.values(data)) : [];
if (!document.getElementById('tab-pansuman')?.classList.contains('hidden') && !pansumanSearchMode) renderPansumanContent();
});
}

// Admin durumuna gÃ¶re form gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ ayarla
function updatePansumanAdminUI() {
const formFields = document.getElementById('pansuman-form-fields');
const adminLock = document.getElementById('pansuman-admin-lock');

if (!formFields || !adminLock) return;

if (isPansumanAdmin()) {
formFields.classList.remove('hidden');
adminLock.classList.add('hidden');
} else {
formFields.classList.add('hidden');
adminLock.classList.remove('hidden');
}
if (typeof lucide !== 'undefined') lucide.createIcons();
}

document.addEventListener('DOMContentLoaded', function () {
setTimeout(() => {
loadPansumanData();
startPansumanRealtimeListener();
updatePansumanAdminUI();
}, 2500);
setTimeout(() => {
const searchInput = document.getElementById('pansuman-search-input');
const clearBtn = document.getElementById('pansuman-search-clear');
if (searchInput) {
searchInput.addEventListener('input', function () {
const query = this.value.trim();
if (query.length > 0) { clearBtn?.classList.remove('hidden'); pansumanSearchMode = true; renderPansumanSearchResults(query); }
else { clearBtn?.classList.add('hidden'); pansumanSearchMode = false; renderPansumanContent(); }
});
}
// KullanÄ±cÄ± deÄŸiÅŸikliÄŸinde UI gÃ¼ncelle
setInterval(updatePansumanAdminUI, 5000);
}, 1000);
});
</script>

<script>
// ============================================
// SONDA, Ä°NR, NG TAKÄ°P SÄ°STEMÄ°
// ============================================

let sondaInrList = [];
let sondaInrCurrentSubtab = 'erkekSonda';
let sondaInrEditingId = null;
let sondaInrSearchTerm = '';

function isSondaInrAdmin() {
if (typeof currentUserRole === 'undefined') return false;
return currentUserRole === 'admin' || currentUserRole === 'Admin';
}

function checkSondaInrAdminAccess(action = 'Bu iÅŸlemi') {
if (!isSondaInrAdmin()) {
showToast(`${action} yapmak iÃ§in admin yetkisi gereklidir!`, 'error');
return false;
}
return true;
}

async function loadSondaInrData() {
if (typeof firebase !== 'undefined' && firebase.database) {
try {
const snapshot = await firebase.database().ref('evde_saglik_ortak_veri/sonda_inr_list').once('value');
const data = snapshot.val();
sondaInrList = data ? (Array.isArray(data) ? data : Object.values(data)) : [];
renderSondaInrContent();
checkSondaInrReminders(); // YÃ¼kleme sonrasÄ± hemen kontrol et
} catch (e) { console.error('Sonda/Ä°NR verileri yÃ¼klenemedi:', e); }
}
}

async function saveSondaInrData() {
if (typeof firebase !== 'undefined' && firebase.database) {
try {
await firebase.database().ref('evde_saglik_ortak_veri/sonda_inr_list').set(sondaInrList);
checkSondaInrReminders(); // KayÄ±t sonrasÄ± hemen kontrol et
}
catch (e) { console.error('Sonda/Ä°NR verileri kaydedilemedi:', e); }
}
}

function getNextWeekday(date) {
const d = new Date(date);
const day = d.getDay();
if (day === 0) d.setDate(d.getDate() + 1);
if (day === 6) d.setDate(d.getDate() + 2);
return d;
}

function calculateNextDate(startDate, catheterType, tabType) {
const start = new Date(startDate);
let nextDate = new Date(start);
if (tabType === 'inr' || tabType === 'ng') {
nextDate.setMonth(nextDate.getMonth() + 1);
} else {
nextDate.setMonth(nextDate.getMonth() + (catheterType === 'silikon' ? 2 : 1));
}
return getNextWeekday(nextDate);
}

window.selectSondaCatheterType = function (value) {
document.getElementById('sondainr-catheter-value').value = value;
document.querySelectorAll('#sondainr-catheter-btns button').forEach(btn => {
btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
btn.classList.remove('bg-orange-500', 'border-orange-500', 'bg-blue-500', 'border-blue-500', 'text-white');
if (btn.dataset.value === value) {
btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'border-gray-200', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-300');
btn.classList.add(value === 'lateks' ? 'bg-orange-500' : 'bg-blue-500', value === 'lateks' ? 'border-orange-500' : 'border-blue-500', 'text-white');
}
});
const dateInput = document.getElementById('sondainr-date');
if (dateInput?.value) {
document.getElementById('sondainr-next-date').value = calculateNextDate(dateInput.value, value, sondaInrCurrentSubtab).toISOString().split('T')[0];
}
};

window.addSondaInrPatient = function () {
if (!checkSondaInrAdminAccess('KayÄ±t ekleme')) return;

const patient = document.getElementById('sondainr-patient').value.trim();
const mahalle = document.getElementById('sondainr-mahalle').value.trim();
const date = document.getElementById('sondainr-date').value;
const nextDate = document.getElementById('sondainr-next-date').value;
const note = document.getElementById('sondainr-note').value.trim();
const catheterType = document.getElementById('sondainr-catheter-value')?.value || 'lateks';
const typeLabels = { erkekSonda: 'Erkek Sonda', kadinSonda: 'KadÄ±n Sonda', inr: 'Ä°NR', ng: 'NG' };

// Validasyon - not hariÃ§ tÃ¼m alanlar zorunlu
if (!patient) { showToast('Hasta adÄ± girin!', 'error'); return; }
if (!mahalle) { showToast('Mahalle girin!', 'error'); return; }
if (!date) { showToast('Tarih seÃ§in!', 'error'); return; }
if (!nextDate) { showToast('Sonraki tarih seÃ§in!', 'error'); return; }

const now = new Date().toISOString();
const currentType = sondaInrEditingId ? sondaInrList.find(x => x.id === sondaInrEditingId)?.type : sondaInrCurrentSubtab;

if (sondaInrEditingId) {
// DÃœZENLEME MODU
const idx = sondaInrList.findIndex(x => x.id === sondaInrEditingId);
if (idx !== -1) {
sondaInrList[idx].patient = patient;
sondaInrList[idx].mahalle = mahalle;
sondaInrList[idx].date = date;
sondaInrList[idx].nextDate = nextDate;
sondaInrList[idx].note = note;
if (sondaInrList[idx].type === 'erkekSonda' || sondaInrList[idx].type === 'kadinSonda') {
sondaInrList[idx].catheterType = catheterType;
}
sondaInrList[idx].updatedAt = now;
sondaInrList[idx].updatedBy = currentUser?.email || 'unknown';

if (typeof addActivityLog === 'function') {
addActivityLog('sondainr', `${typeLabels[sondaInrList[idx].type]} dÃ¼zenlendi`, `${patient} (${mahalle})`);
}
showToast('KayÄ±t gÃ¼ncellendi!', 'success');
}
sondaInrEditingId = null;
document.getElementById('sondainr-form-title').textContent = 'Yeni KayÄ±t Ekle';
document.getElementById('sondainr-add-btn').innerHTML = '<i data-lucide="plus-circle" class="w-5 h-5"></i> KayÄ±t Ekle';
document.getElementById('sondainr-cancel-btn')?.classList.add('hidden');
} else {
// YENÄ° KAYIT MODU
const isSonda = sondaInrCurrentSubtab === 'erkekSonda' || sondaInrCurrentSubtab === 'kadinSonda';
sondaInrList.push({
id: Date.now(),
patient,
mahalle,
date,
nextDate,
catheterType: isSonda ? catheterType : null,
note,
type: sondaInrCurrentSubtab,
status: 'active',
createdAt: now,
createdBy: currentUser?.email || 'unknown'
});

if (typeof addActivityLog === 'function') {
addActivityLog('sondainr', `${typeLabels[sondaInrCurrentSubtab]} eklendi`, `${patient} (${mahalle})`);
}

// Sonda/INR/NG bildirimi gÃ¶nder
if (typeof sendInAppNotification === 'function') {
sendInAppNotification('sondainr', `ğŸ©º Yeni ${typeLabels[sondaInrCurrentSubtab]} KaydÄ±`, `${patient} (${mahalle})`);
}

showToast('KayÄ±t eklendi!', 'success');
}

saveSondaInrData();
clearSondaInrForm();
renderSondaInrContent();
};

function clearSondaInrForm() {
document.getElementById('sondainr-patient').value = '';
document.getElementById('sondainr-mahalle').value = '';
// Tarih alanÄ±nÄ± bugÃ¼nÃ¼n tarihi ile doldur
const today = new Date().toISOString().split('T')[0];
document.getElementById('sondainr-date').value = today;
document.getElementById('sondainr-next-date').value = '';
document.getElementById('sondainr-note').value = '';
selectSondaCatheterType('lateks');
sondaInrEditingId = null;
document.getElementById('sondainr-form-title').textContent = 'Yeni KayÄ±t Ekle';
const addBtn = document.getElementById('sondainr-add-btn');
if (addBtn) addBtn.innerHTML = '<i data-lucide="plus-circle" class="w-5 h-5"></i> KayÄ±t Ekle';
document.getElementById('sondainr-cancel-btn')?.classList.add('hidden');
if (typeof lucide !== 'undefined') lucide.createIcons();
}

window.cancelSondaInrEdit = function () {
clearSondaInrForm();
showToast('DÃ¼zenleme iptal edildi', 'info');
};

window.clearSondaInrSearch = function () {
// Her iki arama kutusunu da temizle (mobil ve masaÃ¼stÃ¼)
document.querySelectorAll('.sondainr-search-input').forEach(input => input.value = '');
document.querySelectorAll('.sondainr-search-clear').forEach(btn => btn.classList.add('hidden'));
sondaInrSearchTerm = '';
renderSondaInrContent();
};

window.handleSondaInrSearch = function (value) {
// Her iki arama kutusunu da senkronize et
document.querySelectorAll('.sondainr-search-input').forEach(input => input.value = value);
document.querySelectorAll('.sondainr-search-clear').forEach(btn => {
if (value.length > 0) btn.classList.remove('hidden');
else btn.classList.add('hidden');
});
sondaInrSearchTerm = value.toLowerCase();
renderSondaInrContent();
};

window.switchSondaInrSubtab = function (subtab) {
sondaInrCurrentSubtab = subtab;
clearSondaInrForm();
sondaInrSearchTerm = '';
// Her iki arama kutusunu da temizle
document.querySelectorAll('.sondainr-search-input').forEach(input => input.value = '');
document.querySelectorAll('.sondainr-search-clear').forEach(btn => btn.classList.add('hidden'));

document.querySelectorAll('.sondainr-subtab-btn').forEach(btn => {
btn.classList.remove('bg-cyan-500', 'text-white', 'border-cyan-500');
btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-200', 'border-transparent');
});
const activeBtn = document.getElementById(`sondainr-subtab-${subtab}`);
if (activeBtn) {
activeBtn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-200', 'border-transparent');
activeBtn.classList.add('bg-cyan-500', 'text-white', 'border-cyan-500');
}

const catheterSection = document.getElementById('sondainr-catheter-type-section');
const dateLabel = document.getElementById('sondainr-date-label');
const formContainer = document.getElementById('sondainr-add-form');

if (subtab === 'gecmis') {
formContainer?.classList.add('hidden');
} else {
formContainer?.classList.remove('hidden');
if (subtab === 'inr') {
catheterSection?.classList.add('hidden');
if (dateLabel) dateLabel.textContent = 'En Son AlÄ±nma Tarihi *';
} else if (subtab === 'ng') {
catheterSection?.classList.add('hidden');
if (dateLabel) dateLabel.textContent = 'DeÄŸiÅŸtirilme Tarihi *';
} else {
catheterSection?.classList.remove('hidden');
if (dateLabel) dateLabel.textContent = 'DeÄŸiÅŸtirilme/TakÄ±lma Tarihi *';
}
}
renderSondaInrContent();
};

function renderSondaInrContent() {
const contentArea = document.getElementById('sondainr-content-area');
if (!contentArea) return;

const typeLabels = { erkekSonda: 'Erkek Sonda', kadinSonda: 'KadÄ±n Sonda', inr: 'Ä°NR', ng: 'NG' };
const isGecmis = sondaInrCurrentSubtab === 'gecmis';

let filteredList = isGecmis
? sondaInrList.filter(p => p.status === 'completed')
: sondaInrList.filter(p => p.type === sondaInrCurrentSubtab && p.status === 'active');

// Arama filtresi
if (sondaInrSearchTerm) {
const term = sondaInrSearchTerm.toLowerCase();
filteredList = filteredList.filter(p =>
(p.patient || '').toLowerCase().includes(term) ||
(p.mahalle || '').toLowerCase().includes(term) ||
(p.note || '').toLowerCase().includes(term)
);
}

filteredList.sort((a, b) => new Date(a.nextDate || a.date) - new Date(b.nextDate || b.date));

if (filteredList.length === 0) {
const emptyText = sondaInrSearchTerm ? 'Arama sonucu bulunamadÄ±' : (isGecmis ? 'GeÃ§miÅŸ kayÄ±t yok' : 'HenÃ¼z kayÄ±t yok');
contentArea.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-400"><i data-lucide="inbox" class="w-16 h-16 mb-4 opacity-50"></i><p class="text-lg font-medium">${emptyText}</p></div>`;
if (typeof lucide !== 'undefined') lucide.createIcons();
return;
}

let html = `<div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm"><table class="w-full"><thead class="bg-gray-100 dark:bg-gray-700"><tr>
<th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 dark:text-gray-200">Hasta</th>
<th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 dark:text-gray-200">Mahalle</th>
${isGecmis ? '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 dark:text-gray-200">TÃ¼r</th>' : ''}
<th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 dark:text-gray-200">${isGecmis ? 'Tarih' : (sondaInrCurrentSubtab === 'inr' ? 'Son AlÄ±nma' : 'DeÄŸiÅŸim')}</th>
<th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 dark:text-gray-200">Sonraki</th>
${!isGecmis && (sondaInrCurrentSubtab === 'erkekSonda' || sondaInrCurrentSubtab === 'kadinSonda') ? '<th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 dark:text-gray-200">Sonda</th>' : ''}
<th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 dark:text-gray-200 w-32">Ä°ÅŸlem</th>
</tr></thead><tbody class="divide-y divide-gray-200 dark:divide-gray-700">`;

filteredList.forEach(p => {
const pIsSonda = p.type === 'erkekSonda' || p.type === 'kadinSonda';
const bgClass = pIsSonda ? (p.catheterType === 'silikon' ? 'bg-blue-50 dark:bg-blue-900/20' : 'bg-orange-50 dark:bg-orange-900/20') : '';
const nextDateObj = new Date(p.nextDate);
const today = new Date(); today.setHours(0, 0, 0, 0);
const isOverdue = nextDateObj < today && p.status !== 'completed';
const isToday = nextDateObj.toDateString() === today.toDateString();
const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
const isTomorrow = nextDateObj.toDateString() === tomorrow.toDateString();
const dayAfterTomorrow = new Date(today); dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);
const isDayAfterTomorrow = nextDateObj.toDateString() === dayAfterTomorrow.toDateString();
const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
const isYesterday = nextDateObj.toDateString() === yesterday.toDateString();
const twoDaysAgo = new Date(today); twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
const isTwoDaysAgo = nextDateObj.toDateString() === twoDaysAgo.toDateString();

let statusBadge = '';
let nextDateBgColor = '';
let nextDateLabel = '';
if (p.status === 'completed') {
statusBadge = '<span class="ml-2 text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">TamamlandÄ±</span>';
} else if (isOverdue) {
statusBadge = '<span class="ml-2 text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full">GecikmiÅŸ</span>';
nextDateBgColor = 'bg-red-100 dark:bg-red-900/50';
} else if (isToday) {
statusBadge = '<span class="ml-2 text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full">BugÃ¼n</span>';
nextDateBgColor = 'bg-yellow-100 dark:bg-yellow-900/50';
nextDateLabel = 'BugÃ¼n';
} else if (isTomorrow) {
nextDateBgColor = 'bg-blue-100 dark:bg-blue-900/50';
nextDateLabel = 'YarÄ±n';
} else if (isDayAfterTomorrow) {
nextDateBgColor = 'bg-purple-100 dark:bg-purple-900/50';
nextDateLabel = '2 GÃ¼n Sonra';
} else if (isYesterday) {
nextDateBgColor = 'bg-orange-100 dark:bg-orange-900/50';
nextDateLabel = 'DÃ¼n';
} else if (isTwoDaysAgo) {
nextDateBgColor = 'bg-pink-100 dark:bg-pink-900/50';
nextDateLabel = '2 GÃ¼n Ã–nce';
}

const formatDateTime = (isoStr) => {
if (!isoStr) return '-';
const d = new Date(isoStr);
return d.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: '2-digit' }) + ' ' + d.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
};
const createdByShort = p.createdBy ? p.createdBy.split('@')[0] : '?';
const updatedByShort = p.updatedBy ? p.updatedBy.split('@')[0] : null;

let infoLine = `<div class="text-[10px] text-gray-400 mt-1">â• ${createdByShort} â€¢ ${formatDateTime(p.createdAt)}`;
if (updatedByShort && p.updatedAt) {
infoLine += ` | âœï¸ ${updatedByShort} â€¢ ${formatDateTime(p.updatedAt)}`;
}
infoLine += `</div>`;

html += `<tr class="${bgClass} hover:bg-gray-50 dark:hover:bg-gray-700/50 transition">
<td class="px-4 py-3">
<div class="font-semibold text-gray-800 dark:text-white">${escapeHtml(p.patient)}${statusBadge}</div>
${p.note ? `<div class="text-xs text-gray-500 mt-1">${escapeHtml(p.note)}</div>` : ''}
${infoLine}
</td>
<td class="px-4 py-3 text-gray-600 dark:text-gray-300">${escapeHtml(p.mahalle || '-')}</td>
${isGecmis ? `<td class="px-4 py-3"><span class="px-2 py-1 rounded-lg text-xs font-bold ${pIsSonda ? (p.catheterType === 'silikon' ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700') : 'bg-gray-100 text-gray-700'}">${typeLabels[p.type] || p.type}${pIsSonda ? ` (${p.catheterType === 'silikon' ? 'Silikon' : 'Lateks'})` : ''}</span></td>` : ''}
<td class="px-4 py-3 text-gray-600 dark:text-gray-300">${p.date ? new Date(p.date).toLocaleDateString('tr-TR') : '-'}</td>
<td class="px-4 py-3 ${nextDateBgColor}">
<div class="font-semibold ${isOverdue ? 'text-red-600' : 'text-gray-800 dark:text-gray-200'}">${p.nextDate ? new Date(p.nextDate).toLocaleDateString('tr-TR') : '-'}</div>
${nextDateLabel ? `<div class="text-xs text-gray-600 dark:text-gray-400 mt-0.5">${nextDateLabel}</div>` : ''}
</td>
${!isGecmis && pIsSonda ? `<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded-lg text-xs font-bold ${p.catheterType === 'silikon' ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700'}">${p.catheterType === 'silikon' ? 'Silikon' : 'Lateks'}</span></td>` : ''}
<td class="px-4 py-3">
<div class="flex items-center justify-center gap-1 flex-wrap">
${p.status === 'active' ? `
<button onclick="completeSondaInr(${p.id})" class="p-2 hover:bg-green-100 rounded-xl text-green-600 transition" title="Tamamla"><i data-lucide="check" class="w-5 h-5"></i></button>
<button onclick="editSondaInr(${p.id})" class="p-2 hover:bg-blue-100 rounded-xl text-blue-600 transition" title="DÃ¼zenle"><i data-lucide="edit-3" class="w-5 h-5"></i></button>
` : `
<button onclick="restoreSondaInr(${p.id})" class="p-2 hover:bg-blue-100 rounded-xl text-blue-600 transition" title="Geri Al"><i data-lucide="undo-2" class="w-5 h-5"></i></button>
`}
<button onclick="deleteSondaInr(${p.id})" class="p-2 hover:bg-red-100 rounded-xl text-red-500 transition" title="Sil"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
</div>
</td>
</tr>`;
});

html += `</tbody></table></div>`;
contentArea.innerHTML = html;
if (typeof lucide !== 'undefined') lucide.createIcons();
}

window.completeSondaInr = function (id) {
if (!checkSondaInrAdminAccess('Tamamlama')) return;
const idx = sondaInrList.findIndex(p => p.id === id);
if (idx === -1) return;
const p = sondaInrList[idx];
const typeLabels = { erkekSonda: 'Erkek Sonda', kadinSonda: 'KadÄ±n Sonda', inr: 'Ä°NR', ng: 'NG' };

p.status = 'completed';
p.completedAt = new Date().toISOString();
p.completedBy = currentUser?.email || 'unknown';

saveSondaInrData();
renderSondaInrContent();

if (typeof addActivityLog === 'function') {
addActivityLog('sondainr', `${typeLabels[p.type]} tamamlandÄ±`, `${p.patient} (${p.mahalle || ''})`);
}
showToast('TamamlandÄ±!', 'success');
};

window.restoreSondaInr = function (id) {
if (!checkSondaInrAdminAccess('Geri alma')) return;
const idx = sondaInrList.findIndex(p => p.id === id);
if (idx === -1) return;
const p = sondaInrList[idx];
const typeLabels = { erkekSonda: 'Erkek Sonda', kadinSonda: 'KadÄ±n Sonda', inr: 'Ä°NR', ng: 'NG' };

p.status = 'active';
p.updatedAt = new Date().toISOString();
p.updatedBy = currentUser?.email || 'unknown';
delete p.completedAt;
delete p.completedBy;

saveSondaInrData();
renderSondaInrContent();

if (typeof addActivityLog === 'function') {
addActivityLog('sondainr', `${typeLabels[p.type]} geri alÄ±ndÄ±`, `${p.patient} (${p.mahalle || ''})`);
}
showToast('Geri alÄ±ndÄ±!', 'success');
};

window.deleteSondaInr = function (id) {
if (!checkSondaInrAdminAccess('Silme')) return;
if (!confirm('Silmek istediÄŸinize emin misiniz?')) return;
const p = sondaInrList.find(x => x.id === id);
const typeLabels = { erkekSonda: 'Erkek Sonda', kadinSonda: 'KadÄ±n Sonda', inr: 'Ä°NR', ng: 'NG' };

sondaInrList = sondaInrList.filter(x => x.id !== id);
saveSondaInrData();
renderSondaInrContent();

if (p && typeof addActivityLog === 'function') {
addActivityLog('sondainr', `${typeLabels[p.type]} silindi`, `${p.patient} (${p.mahalle || ''})`);
}
showToast('Silindi!', 'success');
};

window.editSondaInr = function (id) {
if (!checkSondaInrAdminAccess('DÃ¼zenleme')) return;
const p = sondaInrList.find(x => x.id === id);
if (!p) return;

sondaInrEditingId = id;
document.getElementById('sondainr-patient').value = p.patient || '';
document.getElementById('sondainr-mahalle').value = p.mahalle || '';
document.getElementById('sondainr-date').value = p.date || '';
document.getElementById('sondainr-next-date').value = p.nextDate || '';
document.getElementById('sondainr-note').value = p.note || '';

if (p.catheterType) {
selectSondaCatheterType(p.catheterType);
}

document.getElementById('sondainr-form-title').textContent = 'KayÄ±t DÃ¼zenle';
const addBtn = document.getElementById('sondainr-add-btn');
if (addBtn) addBtn.innerHTML = '<i data-lucide="save" class="w-5 h-5"></i> GÃ¼ncelle';
document.getElementById('sondainr-cancel-btn')?.classList.remove('hidden');
document.getElementById('sondainr-add-form')?.classList.remove('hidden');
document.getElementById('sondainr-patient')?.focus();
document.getElementById('sondainr-add-form')?.scrollIntoView({ behavior: 'smooth', block: 'start' });

if (typeof lucide !== 'undefined') lucide.createIcons();
showToast('DÃ¼zenleme modu aktif', 'info');
};

// TALEPLER'e otomatik ekleme - 1 veya 2 gÃ¼n Ã¶nce
async function checkSondaInrReminders() {
if (typeof window.patientReminders === 'undefined') return;

const today = new Date();
today.setHours(0, 0, 0, 0);

// 3 gÃ¼n sonrasÄ±na kadar kontrol et
const threeDaysLater = new Date(today);
threeDaysLater.setDate(threeDaysLater.getDate() + 3);

const typeLabels = { erkekSonda: 'Erkek Sonda', kadinSonda: 'KadÄ±n Sonda', inr: 'Ä°NR', ng: 'NG' };
let addedCount = 0;

for (const p of sondaInrList) {
if (p.status !== 'active' || !p.nextDate) continue;

const nextDateObj = new Date(p.nextDate);
nextDateObj.setHours(0, 0, 0, 0);

// BugÃ¼n ile 3 gÃ¼n sonrasÄ± arasÄ±nda mÄ± kontrol et (bugÃ¼n dahil)
if (nextDateObj >= today && nextDateObj <= threeDaysLater) {
// Bu kayÄ±t zaten TALEPLER'e eklendi mi kontrol et
const alreadyExists = window.patientReminders.some(r =>
r.sondaInrId === p.id && r.status !== 'completed' && r.status !== 'cancelled'
);

if (!alreadyExists) {
const procName = typeLabels[p.type] || p.type;
let noteText = '';
if (p.catheterType) {
noteText = p.catheterType === 'silikon' ? 'Silikon sonda' : 'Lateks sonda';
}
if (p.mahalle) {
noteText += (noteText ? ' - ' : '') + p.mahalle;
}
if (p.note) {
noteText += (noteText ? ' - ' : '') + p.note;
}

window.patientReminders.push({
id: Date.now() + Math.random(),
name: p.patient,
proc: procName,
date: p.nextDate,
note: noteText,
status: 'pending',
sondaInrId: p.id,
createdAt: new Date().toISOString(),
createdBy: 'Sistem (Otomatik)'
});
addedCount++;
}
}
}

if (addedCount > 0) {
// Tarihe gÃ¶re sÄ±rala (en yakÄ±n tarih en Ã¼stte)
window.patientReminders.sort((a, b) => {
if (a.status === 'completed' || a.status === 'cancelled') return 1;
if (b.status === 'completed' || b.status === 'cancelled') return -1;
return new Date(a.date) - new Date(b.date);
});

if (typeof savePatientReminders === 'function') {
await savePatientReminders();
}
if (typeof renderPatientReminders === 'function') {
renderPatientReminders();
}
}
}

function updateSondaInrAdminUI() {
const formFields = document.getElementById('sondainr-form-fields');
const adminLock = document.getElementById('sondainr-admin-lock');
if (!formFields || !adminLock) return;
if (isSondaInrAdmin()) {
formFields.classList.remove('hidden');
adminLock.classList.add('hidden');
} else {
formFields.classList.add('hidden');
adminLock.classList.remove('hidden');
}
if (typeof lucide !== 'undefined') lucide.createIcons();
}

function startSondaInrRealtimeListener() {
if (typeof firebase === 'undefined' || !firebase.database) {
setTimeout(startSondaInrRealtimeListener, 1000);
return;
}
firebase.database().ref('evde_saglik_ortak_veri/sonda_inr_list').on('value', (snapshot) => {
const data = snapshot.val();
sondaInrList = data ? (Array.isArray(data) ? data : Object.values(data)) : [];
if (!document.getElementById('tab-sondainr')?.classList.contains('hidden')) {
renderSondaInrContent();
}
checkSondaInrReminders(); // Her gÃ¼ncelleme sonrasÄ± kontrol et
});
}

document.addEventListener('DOMContentLoaded', function () {
setTimeout(() => {
loadSondaInrData();
startSondaInrRealtimeListener();
updateSondaInrAdminUI();

// Tarih deÄŸiÅŸince sonraki tarihi hesapla
const dateInput = document.getElementById('sondainr-date');
if (dateInput) {
dateInput.addEventListener('change', function () {
const catheterType = document.getElementById('sondainr-catheter-value')?.value || 'lateks';
document.getElementById('sondainr-next-date').value = calculateNextDate(this.value, catheterType, sondaInrCurrentSubtab).toISOString().split('T')[0];
});
}

// Arama kutularÄ± artÄ±k oninput ile yÃ¶netiliyor (handleSondaInrSearch fonksiyonu)

setInterval(updateSondaInrAdminUI, 5000);
}, 3000);
});
</script>

<script>
// ============================================
// DOÄUM GÃœNÃœ SÄ°STEMÄ°
// ============================================

let birthdayPeople = [];

// KiÅŸi ekleme
window.addBirthdayPerson = async function () {
const name = document.getElementById('birthday-name').value.trim();
const date = document.getElementById('birthday-date').value;
const note = document.getElementById('birthday-note').value.trim();

if (!name || !date) {
showToast('Ad soyad ve doÄŸum tarihi zorunludur!', 'error');
return;
}

const person = {
id: Date.now().toString(),
name: name,
date: date,
note: note
};

try {
await database.ref(`evde_saglik_ortak_veri/birthdays/${person.id}`).set(person);
showToast('KiÅŸi eklendi!', 'success');

// Formu temizle
document.getElementById('birthday-name').value = '';
document.getElementById('birthday-date').value = '';
document.getElementById('birthday-note').value = '';
} catch (error) {
console.error('DoÄŸum gÃ¼nÃ¼ ekleme hatasÄ±:', error);
showToast('KiÅŸi eklenemedi!', 'error');
}
};

// KiÅŸi silme
window.deleteBirthdayPerson = async function (id) {
if (!confirm('Bu kiÅŸiyi silmek istediÄŸinize emin misiniz?')) return;

try {
await database.ref(`evde_saglik_ortak_veri/birthdays/${id}`).remove();
showToast('KiÅŸi silindi', 'success');
} catch (error) {
console.error('Silme hatasÄ±:', error);
showToast('Silinemedi!', 'error');
}
};

// Kalan gÃ¼n hesaplama
function getDaysUntilBirthday(dateStr) {
const today = new Date();
const birthDate = new Date(dateStr);

// Bu yÄ±lki doÄŸum gÃ¼nÃ¼
let nextBirthday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());

// EÄŸer bu yÄ±lki geÃ§tiyse gelecek yÄ±lÄ± al
if (nextBirthday < today) {
nextBirthday = new Date(today.getFullYear() + 1, birthDate.getMonth(), birthDate.getDate());
}

const diffTime = nextBirthday - today;
const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

return diffDays;
}

// Listeyi render et
function renderBirthdayList() {
const tbody = document.getElementById('birthday-list');
const countEl = document.getElementById('birthday-count');
if (!tbody) return;

if (birthdayPeople.length === 0) {
tbody.innerHTML = `
<tr>
<td colspan="5" class="p-8 text-center text-gray-400">
<i data-lucide="cake" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
<p>HenÃ¼z kayÄ±tlÄ± kiÅŸi yok</p>
</td>
</tr>`;
if (countEl) countEl.textContent = '0 kiÅŸi';
lucide.createIcons();
return;
}

// Kalan gÃ¼ne gÃ¶re sÄ±rala
const sorted = [...birthdayPeople].sort((a, b) => getDaysUntilBirthday(a.date) - getDaysUntilBirthday(b.date));

let html = '';
sorted.forEach(person => {
const days = getDaysUntilBirthday(person.date);
const formattedDate = new Date(person.date).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' });

let daysClass = 'text-gray-600';
let daysBadge = '';
if (days === 0) {
daysClass = 'text-pink-600 font-bold';
daysBadge = '<span class="ml-1 animate-pulse">ğŸ‚</span>';
} else if (days <= 7) {
daysClass = 'text-orange-600 font-bold';
} else if (days <= 30) {
daysClass = 'text-yellow-600';
}

html += `
<tr class="hover:bg-pink-50 transition ${days === 0 ? 'bg-pink-100' : ''}">
<td class="p-3 font-medium text-gray-800">${person.name}</td>
<td class="p-3 text-gray-600">${formattedDate}</td>
<td class="p-3 ${daysClass}">${days === 0 ? 'BugÃ¼n!' : days + ' gÃ¼n'}${daysBadge}</td>
<td class="p-3 text-gray-500 text-xs">${person.note || '-'}</td>
<td class="p-3 text-center">
<button onclick="deleteBirthdayPerson('${person.id}')"
class="text-red-500 hover:text-red-700 text-sm" title="Sil">ğŸ—‘ï¸</button>
</td>
</tr>`;
});

tbody.innerHTML = html;
if (countEl) countEl.textContent = `${birthdayPeople.length} kiÅŸi`;
lucide.createIcons();
}

// Firebase'den dinle
function listenForBirthdays() {
if (!currentUser) return;

database.ref('evde_saglik_ortak_veri/birthdays').on('value', (snapshot) => {
const data = snapshot.val() || {};
birthdayPeople = Object.values(data);
renderBirthdayList();
checkTodaysBirthdays();
});
}

// BugÃ¼nkÃ¼ doÄŸum gÃ¼nlerini kontrol et
function checkTodaysBirthdays() {
const today = new Date();
const todayMonth = today.getMonth();
const todayDay = today.getDate();

const todaysBirthdays = birthdayPeople.filter(person => {
const birthDate = new Date(person.date);
return birthDate.getMonth() === todayMonth && birthDate.getDate() === todayDay;
});

if (todaysBirthdays.length > 0) {
// Banner'Ä± gÃ¶ster
const names = todaysBirthdays.map(p => p.name).join(', ');
const notes = todaysBirthdays.map(p => p.note).filter(n => n).join(' | ');

const bannerText = document.getElementById('birthday-banner-text');
const bannerNote = document.getElementById('birthday-banner-note');
const banner = document.getElementById('birthday-banner');

if (bannerText) {
if (todaysBirthdays.length === 1) {
bannerText.textContent = `ğŸ‰ BugÃ¼n ${names}'in doÄŸum gÃ¼nÃ¼!`;
} else {
bannerText.textContent = `ğŸ‰ BugÃ¼n ${names} kiÅŸilerinin doÄŸum gÃ¼nÃ¼!`;
}
}
if (bannerNote && notes) bannerNote.textContent = notes;
if (banner) {
banner.classList.remove('hidden');
}
}
}

// Banner'Ä± kapat
window.closeBirthdayBanner = function () {
const banner = document.getElementById('birthday-banner');
if (banner) banner.classList.add('hidden');
};

// Auth deÄŸiÅŸikliÄŸinde dinleyiciyi baÅŸlat
if (typeof auth !== 'undefined') {
auth.onAuthStateChanged((user) => {
if (user) {
setTimeout(listenForBirthdays, 3000);
}
});
}

</script>

<div id="backup-reminder-modal"
class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[300] hidden items-center justify-center p-4">
<div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md animate-bounce-in">
<div
class="p-6 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-gray-800 dark:to-gray-800 rounded-t-2xl">
<div class="flex items-center gap-4">
<div
class="w-14 h-14 bg-gradient-to-br from-amber-400 to-orange-500 rounded-2xl flex items-center justify-center shadow-lg">
<i data-lucide="database-backup" class="w-7 h-7 text-white"></i>
</div>
<div>
<h3 class="text-xl font-bold text-gray-800 dark:text-white">Yedekleme HatÄ±rlatmasÄ±</h3>
<p class="text-sm text-gray-500 dark:text-gray-400">Verilerinizi gÃ¼vende tutun!</p>
</div>
</div>
</div>
<div class="p-6">
<p class="text-gray-600 dark:text-gray-300 mb-4">
TÃ¼m verilerinizi <strong>Excel dosyasÄ±</strong> olarak yedeklemek ister misiniz?
</p>
<div
class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-xl p-4 mb-4">
<p class="text-sm text-blue-700 dark:text-blue-300 flex items-start gap-2">
<i data-lucide="info" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
<span>Yedekleme; Personel, Doktorlar, Hasta Takip, Pansuman, Sonda/Ä°NR/NG, BÃ¼tÃ§e, NÃ¶bet ve diÄŸer
tÃ¼m verileri iÃ§erir.</span>
</p>
</div>
</div>
<div
class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 rounded-b-2xl flex gap-3">
<button onclick="closeBackupReminder(false)"
class="flex-1 py-3 px-4 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl font-bold hover:bg-gray-300 dark:hover:bg-gray-600 transition flex items-center justify-center gap-2">
<i data-lucide="x" class="w-4 h-4"></i> Åimdi DeÄŸil
</button>
<button onclick="closeBackupReminder(true)"
class="flex-1 py-3 px-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl font-bold hover:from-amber-600 hover:to-orange-600 transition shadow-lg flex items-center justify-center gap-2">
<i data-lucide="download" class="w-4 h-4"></i> Yedekle
</button>
</div>
</div>
</div>

<script>
// ============================================
// YEDEKLEME HATIRLAT SÄ°STEMÄ°
// ============================================
const LS_BACKUP_REMINDER = 'evdeSaglikBackupReminder_V1';

function checkBackupReminder() {
// Sadece admin rolÃ¼ndekiler iÃ§in yedekleme hatÄ±rlatmasÄ± gÃ¶ster
if (typeof currentUserRole === 'undefined' || currentUserRole !== 'admin') return;

const now = new Date();
const currentHour = now.getHours();
const currentMinute = now.getMinutes();
const todayStr = now.toISOString().split('T')[0];

// Saat 08:00 ile 16:00 arasÄ± her saat baÅŸÄ± kontrol et (Â±15 dakika tolerans)
// currentHour 8, 9, 10, 11, 12, 13, 14, 15, 16 olabilir
const isWorkingHour = currentHour >= 8 && currentHour <= 16 && currentMinute <= 15;

if (!isWorkingHour) return;

// BugÃ¼n bu saat iÃ§in hatÄ±rlatma gÃ¶sterildi mi kontrol et
const reminder = JSON.parse(localStorage.getItem(LS_BACKUP_REMINDER) || '{}');
const reminderKey = `${todayStr}_${currentHour}`;

if (reminder[reminderKey]) return; // Zaten gÃ¶sterildi

// HatÄ±rlatmayÄ± gÃ¶ster
showBackupReminder();

// Bu saat iÃ§in iÅŸaretle
reminder[reminderKey] = true;

// Eski kayÄ±tlarÄ± temizle (son 7 gÃ¼n hariÃ§)
const sevenDaysAgo = new Date(now);
sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
const cleanedReminder = {};
Object.keys(reminder).forEach(key => {
const keyDate = key.split('_')[0];
if (new Date(keyDate) >= sevenDaysAgo) {
cleanedReminder[key] = reminder[key];
}
});

localStorage.setItem(LS_BACKUP_REMINDER, JSON.stringify(cleanedReminder));
}

function showBackupReminder() {
const modal = document.getElementById('backup-reminder-modal');
if (modal) {
modal.classList.remove('hidden');
modal.classList.add('flex');
if (typeof lucide !== 'undefined') lucide.createIcons();
}
}

function closeBackupReminder(doBackup) {
const modal = document.getElementById('backup-reminder-modal');
if (modal) {
modal.classList.add('hidden');
modal.classList.remove('flex');
}

if (doBackup) {
// Excel yedekleme fonksiyonunu Ã§aÄŸÄ±r
if (typeof exportData === 'function') {
exportData('xlsx');
showToast('Yedekleme baÅŸlatÄ±ldÄ±!', 'success');
}
}
}

// Sayfa yÃ¼klendiÄŸinde ve her 5 dakikada bir kontrol et
document.addEventListener('DOMContentLoaded', function () {
// Ä°lk kontrol - 5 saniye sonra (sayfa tam yÃ¼klensin)
setTimeout(checkBackupReminder, 5000);

// Her 5 dakikada bir kontrol et
setInterval(checkBackupReminder, 5 * 60 * 1000);
});

</script>

<script>
// Sokak verileri - Firebase'den yÃ¼klenecek, baÅŸlangÄ±Ã§ verisi olarak sabit
let streetData = [];
let streetSearchTerm = '';
let streetMahalleFilter = '';
let selectedStreet = null;
let streetDataLoaded = false;

// VarsayÄ±lan sokak verileri (ilk yÃ¼kleme iÃ§in)
const defaultStreetData = [
// GÃœMÃœSÃ‡ESME
{ oldName: '1.AKAY', newName: '8007', context: 'GÃœMÃœSÃ‡ESME' },
{ oldName: '1. BARBAROS', newName: '8011', context: 'GÃœMÃœSÃ‡ESME' },
{ oldName: '1.Ã‡EVREYOLU', newName: '8066', context: 'GÃœMÃœSÃ‡ESME' },
{ oldName: '14 ATATÃœRK', newName: 'GAZEMUSTAFA KEMAL', context: 'GÃœMÃœSÃ‡ESME' },
{ oldName: '14 ATAY', newName: '8000', context: 'GÃœMÃœSÃ‡ESME' },
{ oldName: '14 CUMHURÄ°YET', newName: '8021/8023', context: 'GÃœMÃœSÃ‡ESME' },
// HASAN BASRÄ° Ã‡ANTAY
{ oldName: '1 Ã‡Ä°Ã‡EK', newName: '10006', context: 'HASAN BASRÄ° Ã‡ANTAY' },
{ oldName: 'GÃœL', newName: '10012', context: 'HASAN BASRÄ° Ã‡ANTAY' },
{ oldName: 'YILDIZ', newName: '10029', context: 'HASAN BASRÄ° Ã‡ANTAY' },
{ oldName: '19 BARBAROS', newName: '10009', context: 'HASAN BASRÄ° Ã‡ANTAY' },
// SÃœTLÃœCE
{ oldName: '1.(ÅOFÃ–R EVLERÄ°)', newName: '13056', context: 'SÃœTLÃœCE' },
{ oldName: '1.BADEMLI', newName: '13010', context: 'SÃœTLÃœCE' },
{ oldName: '35 SÃœTLÃœCE', newName: '13001', context: 'SÃœTLÃœCE' },
// YILDIZ
{ oldName: '1.FÄ°LÄ°Z', newName: '14060', context: 'YILDIZ' },
{ oldName: '1.POYRAZ', newName: '14015', context: 'YILDIZ' },
{ oldName: '39 YILDIZ', newName: '14059', context: 'YILDIZ' },
// BAHÃ‡ELÄ°EVLER
{ oldName: 'ZAMBAK SOKAK', newName: '5002 SOKAK', context: 'BAHÃ‡ELÄ°EVLER' },
{ oldName: 'MENEKÅE SOKAK', newName: '5000 SOKAK', context: 'BAHÃ‡ELÄ°EVLER' },
{ oldName: 'GÃœL SOKAK', newName: '5007 SOKAK', context: 'BAHÃ‡ELÄ°EVLER' },
{ oldName: 'MANOLYA SOKAK', newName: '5003 SOKAK', context: 'BAHÃ‡ELÄ°EVLER' },
// 1.GÃœNDOÄAN
{ oldName: '1.BARBOROS', newName: '2003', context: '1.GÃœNDOÄAN' },
{ oldName: '15 CAMI', newName: '2000', context: '1.GÃœNDOÄAN' },
// 2.GÃœNDOÄAN
{ oldName: '16 KEMER', newName: '3003', context: '2.GÃœNDOÄAN' },
{ oldName: '16 KARTAL', newName: '3091', context: '2.GÃœNDOÄAN' },
// Ã‡AYIRHÄ°SAR
{ oldName: '244.', newName: '6001', context: 'Ã‡AYIRHÄ°SAR' },
{ oldName: '246.', newName: '6002', context: 'Ã‡AYIRHÄ°SAR' },
// DÄ°NKÃ‡Ä°LER
{ oldName: '1. BALLICA', newName: '7063', context: 'DÄ°NKÃ‡Ä°LER' },
{ oldName: '9 HÃœRRÄ°YET', newName: '7090', context: 'DÄ°NKÃ‡Ä°LER' },
// GAZÄ°OSMANPAÅA
{ oldName: '13 101.', newName: '101', context: 'GAZÄ°OSMANPAÅA' },
{ oldName: '13 BARBAROS', newName: '39 BARBAROS', context: 'GAZÄ°OSMANPAÅA' }
];

// Firebase'den sokak verilerini yÃ¼kle
async function loadStreetData() {
try {
const snapshot = await firebase.database().ref('evde_saglik_ortak_veri/street_data').once('value');
const data = snapshot.val();

if (data) {
streetData = Array.isArray(data) ? data : Object.values(data);
} else {
// Ä°lk kez yÃ¼kleniyorsa varsayÄ±lan veriyi kaydet
streetData = [...defaultStreetData];
await saveStreetData();
}

streetDataLoaded = true;
updateStreetCount();
} catch (error) {
console.error('Sokak verileri yÃ¼klenemedi:', error);
streetData = [...defaultStreetData];
streetDataLoaded = true;
}
}

// Firebase'e sokak verilerini kaydet
async function saveStreetData() {
try {
await firebase.database().ref('evde_saglik_ortak_veri/street_data').set(streetData);
} catch (error) {
console.error('Sokak verileri kaydedilemedi:', error);
showToast('Veriler kaydedilemedi!', 'error');
}
}

// Sokak sorgulama sistemi baÅŸlat
window.initStreetSearch = function () {
if (!streetDataLoaded) {
loadStreetData();
}
updateStreetCount();
if (typeof lucide !== 'undefined') lucide.createIcons();
};

// Sokak sayÄ±sÄ±nÄ± gÃ¼ncelle
function updateStreetCount() {
const countEl = document.getElementById('street-count-number');
if (countEl) {
countEl.textContent = streetData.length;
}
}

// Arama fonksiyonu
window.searchStreets = function (query) {
streetSearchTerm = query.toLowerCase().trim();

const clearBtn = document.getElementById('street-search-clear');
if (clearBtn) {
clearBtn.classList.toggle('hidden', query.length === 0);
}

renderStreetResults();
};

// AramayÄ± temizle
window.clearStreetSearch = function () {
document.getElementById('street-search-input').value = '';
streetSearchTerm = '';
document.getElementById('street-search-clear').classList.add('hidden');
renderStreetResults();
};

// Mahalle filtresi
window.filterByMahalle = function (mahalle) {
streetMahalleFilter = mahalle;

// Buton stillerini gÃ¼ncelle
document.querySelectorAll('.mahalle-filter-btn').forEach(btn => {
btn.classList.remove('bg-emerald-600', 'text-white');
btn.classList.add('bg-gray-200', 'text-gray-700');
});

const allBtn = document.getElementById('mahalle-filter-all');
if (mahalle === '') {
allBtn.classList.add('bg-emerald-600', 'text-white');
allBtn.classList.remove('bg-gray-200', 'text-gray-700');
} else {
allBtn.classList.remove('bg-emerald-600', 'text-white');
allBtn.classList.add('bg-gray-200', 'text-gray-700');
// SeÃ§ilen mahalle butonunu bul ve aktif yap
document.querySelectorAll('.mahalle-filter-btn').forEach(btn => {
if (btn.onclick && btn.onclick.toString().includes(mahalle)) {
btn.classList.add('bg-emerald-600', 'text-white');
btn.classList.remove('bg-gray-200', 'text-gray-700');
}
});
}

renderStreetResults();
};

// SonuÃ§larÄ± render et
function renderStreetResults() {
const container = document.getElementById('street-results-container');
const initialMessage = document.getElementById('street-initial-message');
const selectedInfo = document.getElementById('street-selected-info');

// Filtrele
let results = streetData.filter(street => {
const matchSearch = !streetSearchTerm ||
street.oldName.toLowerCase().includes(streetSearchTerm) ||
street.newName.toLowerCase().includes(streetSearchTerm);

const matchMahalle = !streetMahalleFilter || street.context === streetMahalleFilter;

return matchSearch && matchMahalle;
});

// EÄŸer hem arama hem filtre boÅŸsa ve sonuÃ§ yoksa baÅŸlangÄ±Ã§ mesajÄ±nÄ± gÃ¶ster
if (!streetSearchTerm && !streetMahalleFilter) {
container.classList.add('hidden');
container.innerHTML = '';
initialMessage.classList.remove('hidden');
selectedInfo.classList.add('hidden');
return;
}

initialMessage.classList.add('hidden');

if (results.length === 0) {
container.innerHTML = '<p class="p-4 text-center text-red-500 font-medium">SonuÃ§ bulunamadÄ±.</p>';
container.classList.remove('hidden');
return;
}

container.classList.remove('hidden');

let html = '';
results.slice(0, 100).forEach((street, idx) => {
html += `
<div class="p-3 hover:bg-emerald-100 cursor-pointer border-b border-gray-200 last:border-b-0 transition flex justify-between items-center group"
onclick="selectStreet(${idx}, '${street.oldName.replace(/'/g, "\\'")}', '${street.newName.replace(/'/g, "\\'")}', '${street.context}')">
<div>
<div class="text-sm font-bold text-gray-800">${street.newName} <span class="text-emerald-600">(YENÄ°)</span></div>
<div class="text-xs text-gray-500">Eski: ${street.oldName}</div>
<div class="text-xs text-gray-400">${street.context}</div>
</div>
<div class="hidden group-hover:flex gap-1">
<button onclick="event.stopPropagation(); editStreet('${street.oldName.replace(/'/g, "\\'")}', '${street.newName.replace(/'/g, "\\'")}', '${street.context}')"
class="p-1.5 text-orange-500 hover:bg-orange-100 rounded">
<i data-lucide="pencil" class="w-4 h-4"></i>
</button>
</div>
</div>
`;
});

if (results.length > 100) {
html += `<p class="p-3 text-center text-gray-400 text-sm">+${results.length - 100} sonuÃ§ daha var. AramayÄ± daraltÄ±n.</p>`;
}

container.innerHTML = html;
if (typeof lucide !== 'undefined') lucide.createIcons();
}

// Sokak seÃ§
window.selectStreet = function (idx, oldName, newName, context) {
selectedStreet = { oldName, newName, context };

document.getElementById('street-results-container').classList.add('hidden');

document.getElementById('selected-street-new').textContent = newName;
document.getElementById('selected-street-old').textContent = oldName;
document.getElementById('selected-street-mahalle').textContent = `${context} Mahallesi / AltÄ±eylÃ¼l`;

document.getElementById('street-selected-info').classList.remove('hidden');
if (typeof lucide !== 'undefined') lucide.createIcons();
};

// Haritada aÃ§
window.openStreetInMaps = function () {
if (!selectedStreet) {
showToast('Ã–nce bir sokak seÃ§in', 'error');
return;
}

const query = `${selectedStreet.newName}, ${selectedStreet.context}, AltÄ±eylÃ¼l, BalÄ±kesir`;
const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
window.open(url, '_blank');
};

// Sokak ekleme modalÄ±
window.openStreetAddModal = function () {
document.getElementById('street-modal-title').innerHTML = '<i data-lucide="map-pin" class="w-5 h-5"></i> Yeni Sokak Ekle';
document.getElementById('street-edit-id').value = '';
document.getElementById('street-old-name').value = '';
document.getElementById('street-new-name').value = '';
document.getElementById('street-mahalle').value = '';

document.getElementById('street-add-modal').classList.remove('hidden');
document.getElementById('street-add-modal').classList.add('flex');
if (typeof lucide !== 'undefined') lucide.createIcons();
};

window.closeStreetAddModal = function () {
document.getElementById('street-add-modal').classList.add('hidden');
document.getElementById('street-add-modal').classList.remove('flex');
};

// Sokak dÃ¼zenle
window.editStreet = function (oldName, newName, context) {
document.getElementById('street-modal-title').innerHTML = '<i data-lucide="pencil" class="w-5 h-5"></i> Sokak DÃ¼zenle';
document.getElementById('street-edit-id').value = oldName + '|' + newName + '|' + context;
document.getElementById('street-old-name').value = oldName;
document.getElementById('street-new-name').value = newName;
document.getElementById('street-mahalle').value = context;

document.getElementById('street-add-modal').classList.remove('hidden');
document.getElementById('street-add-modal').classList.add('flex');
if (typeof lucide !== 'undefined') lucide.createIcons();
};

// SeÃ§ili sokaÄŸÄ± dÃ¼zenle
window.editSelectedStreet = function () {
if (!selectedStreet) return;
editStreet(selectedStreet.oldName, selectedStreet.newName, selectedStreet.context);
};

// SeÃ§ili sokaÄŸÄ± sil
window.deleteSelectedStreet = function () {
if (!selectedStreet) return;

if (!confirm(`"${selectedStreet.oldName}" â†’ "${selectedStreet.newName}" kaydÄ±nÄ± silmek istediÄŸinize emin misiniz?`)) {
return;
}

const idx = streetData.findIndex(s =>
s.oldName === selectedStreet.oldName &&
s.newName === selectedStreet.newName &&
s.context === selectedStreet.context
);

if (idx !== -1) {
streetData.splice(idx, 1);
saveStreetData();
showToast('Sokak kaydÄ± silindi', 'success');

document.getElementById('street-selected-info').classList.add('hidden');
selectedStreet = null;
updateStreetCount();
renderStreetResults();
}
};

// Sokak kaydet
window.saveStreet = async function () {
const editId = document.getElementById('street-edit-id').value;
const oldName = document.getElementById('street-old-name').value.trim().toUpperCase();
const newName = document.getElementById('street-new-name').value.trim().toUpperCase();
const context = document.getElementById('street-mahalle').value;

if (!oldName || !newName || !context) {
showToast('TÃ¼m alanlarÄ± doldurun', 'error');
return;
}

if (editId) {
// DÃ¼zenleme
const [eOld, eNew, eContext] = editId.split('|');
const idx = streetData.findIndex(s => s.oldName === eOld && s.newName === eNew && s.context === eContext);
if (idx !== -1) {
streetData[idx] = { oldName, newName, context };
}
showToast('Sokak gÃ¼ncellendi', 'success');
} else {
// Yeni ekleme
streetData.push({ oldName, newName, context });
showToast('Sokak eklendi', 'success');
}

await saveStreetData();
closeStreetAddModal();
updateStreetCount();
renderStreetResults();
};

// Excel import - Eski sokak ismi (1. sÃ¼tun), Yeni sokak ismi (2. sÃ¼tun), Mahalle (3. sÃ¼tun)
window.importStreetExcel = async function (input) {
if (!input.files || !input.files[0]) {
showToast('Dosya seÃ§ilmedi', 'error');
return;
}

// Lazy load XLSX kÃ¼tÃ¼phanesi
showToast('Excel kÃ¼tÃ¼phanesi yÃ¼kleniyor...', 'info');
await LazyLoader.loadXLSX();

const file = input.files[0];
const reader = new FileReader();

reader.onload = async function (e) {
try {
const data = new Uint8Array(e.target.result);
const workbook = XLSX.read(data, { type: 'array' });

let importCount = 0;
let duplicateCount = 0;

// TÃ¼m sayfalarÄ± iÅŸle
workbook.SheetNames.forEach(sheetName => {
const worksheet = workbook.Sheets[sheetName];
const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

// Ä°lk satÄ±rÄ± baÅŸlÄ±k olarak atla (eÄŸer metin baÅŸlÄ±klarÄ± varsa)
let startRow = 0;
if (jsonData.length > 0 && jsonData[0].length >= 3) {
const firstCell = String(jsonData[0][0] || '').toLowerCase();
if (firstCell.includes('eski') || firstCell.includes('old') || firstCell.includes('sokak')) {
startRow = 1;
}
}

for (let i = startRow; i < jsonData.length; i++) {
const row = jsonData[i];
if (!row || row.length < 3) continue;

const oldName = String(row[0] || '').trim().toUpperCase();
const newName = String(row[1] || '').trim().toUpperCase();
const context = String(row[2] || '').trim().toUpperCase();

if (!oldName || !newName || !context) continue;

// AynÄ± kayÄ±t var mÄ± kontrol et
const exists = streetData.some(s =>
s.oldName === oldName &&
s.newName === newName &&
s.context === context
);

if (!exists) {
streetData.push({ oldName, newName, context });
importCount++;
} else {
duplicateCount++;
}
}
});

if (importCount > 0) {
await saveStreetData();
updateStreetCount();
renderStreetResults();
}

let msg = `${importCount} sokak kaydÄ± iÃ§e aktarÄ±ldÄ±`;
if (duplicateCount > 0) {
msg += ` (${duplicateCount} adet mÃ¼kerrer kayÄ±t atlandÄ±)`;
}

showToast(msg, importCount > 0 ? 'success' : 'info');

} catch (err) {
console.error('Excel import hatasÄ±:', err);
showToast('Excel dosyasÄ± okunamadÄ±: ' + err.message, 'error');
}

// Input'u temizle (aynÄ± dosyayÄ± tekrar seÃ§ebilmek iÃ§in)
input.value = '';
};

reader.onerror = function () {
showToast('Dosya okuma hatasÄ±', 'error');
input.value = '';
};

reader.readAsArrayBuffer(file);
};

// Excel export
window.exportStreetExcel = async function () {
if (streetData.length === 0) {
showToast('DÄ±ÅŸa aktarÄ±lacak veri yok', 'error');
return;
}

// Lazy load XLSX kÃ¼tÃ¼phanesi
showToast('Excel kÃ¼tÃ¼phanesi yÃ¼kleniyor...', 'info');
await LazyLoader.loadXLSX();

const wb = XLSX.utils.book_new();

// Mahallelere gÃ¶re grupla
const mahalles = [...new Set(streetData.map(s => s.context))].sort();

mahalles.forEach(mahalle => {
const data = streetData.filter(s => s.context === mahalle).map(s => ({
'Eski Ad': s.oldName,
'Yeni Ad': s.newName,
'Mahalle': s.context
}));

if (data.length > 0) {
const ws = XLSX.utils.json_to_sheet(data);
const sheetName = mahalle.substring(0, 31).replace(/[\\/*?:\[\]]/g, '');
XLSX.utils.book_append_sheet(wb, ws, sheetName);
}
});

XLSX.writeFile(wb, `Sokak_Listesi_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.xlsx`);
showToast('Excel indirildi', 'success');
};

// Sayfa yÃ¼klendiÄŸinde verileri yÃ¼kle
document.addEventListener('DOMContentLoaded', function () {
loadStreetData();
});

</script>

</body>

</html>